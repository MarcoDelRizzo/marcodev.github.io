var mO=Object.defineProperty;var gO=(s,t,e)=>t in s?mO(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var a=(s,t,e)=>(gO(s,typeof t!="symbol"?t+"":t,e),e),Uy=(s,t,e)=>{if(!t.has(s))throw TypeError("Cannot "+e)};var ke=(s,t,e)=>(Uy(s,t,"read from private field"),e?e.call(s):t.get(s)),En=(s,t,e)=>{if(t.has(s))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(s):t.set(s,e)},Mn=(s,t,e,i)=>(Uy(s,t,"write to private field"),i?i.call(s,e):t.set(s,e),e);var Bd=(s,t,e)=>(Uy(s,t,"access private method"),e);import{n as _e,V as R,w as Ne,aR as re,br as to,bH as gc,P as Ae,O as _g,i as Xn,M as le,T as _t,U as ys,x as Se,a as bs,h as ti,bk as Ht,k as Xo,bR as VC,bS as yO,bT as WC,a7 as Xe,b as HC,f as xe,bN as Va,aA as z,bC as zr,aL as Ar,bU as Wn,af as Ye,t as Qn,B as Gs,aK as Ir,bm as GC,ae as vg,bn as Vh,bV as bO,bW as _O,bX as vO,bh as xO,bY as qC,aw as r_,av as R0,e as Wh,aH as Hh,d as Cn,bZ as wO,aG as XC,aD as O0,bj as xg,S as wg,b_ as SO,bD as lc,aF as Ia,c as QC,aM as CO,aO as PO,b$ as TO,c0 as RO,aN as Hn,a5 as k0,aE as Gh,c1 as OO,r as $r,ap as dn,am as kO,z as E0,H as Sg,bx as Vo,m as Vr,g as EO,c2 as qh,c3 as Cg,c4 as Pg,c5 as gm,c6 as MO,c7 as AO,W as Qo,D as YC,J as ym,c8 as IO,c9 as a_,ca as M0,C as LO,F as Wa,cb as DO,cc as jx,cd as jO,ce as FO,cf as l_,E as A0,s as Tg,_ as BO,cg as UO,ch as NO,ci as zO,cj as $O,ck as VO,cl as WO,cm as HO,cn as GO,co as qO,cp as XO,cq as QO,cr as YO,cs as KO,ct as ZO,cu as JO,cv as ek,cw as tk,cx as Fx,cy as KC,by as ik,cz as nk,cA as ZC,cB as sk,A as ok,a9 as rk,a8 as ak,aa as lk,$ as ck,a1 as hk,a0 as dk,cC as Bx,ax as c_,cD as JC,l as uk,L as bm,cE as fk,bM as pk,bO as e1,cF as mk,au as gk,cG as yk,cH as bk,cI as _k,bP as vk,cJ as xk,cK as I0,cL as L0,Q as Ny,cM as wk,cN as t1,a$ as Sk,cO as Ck,cP as Pk,aX as Tk,aZ as Rk,cQ as Ok,aV as Ux,al as i1,ai as _m,a6 as kk,cR as Ek,cS as Mk,cT as Ak}from"./three@0.169.15.js";import{_ as it,a as n1,b as s1,c as Ik,S as Lk,d as zy,e as Nx,T as zx}from"./three-mesh-ui.a91f26d8.js";import{a as Xh,F as Dk,T as jk,b as Fk,G as Wr,c as o1,E as D0,R as r1,S as Bk,n as $x,O as a1,d as Uk,H as Nk,V as zk,e as l1,s as c1,z as $k,X as Vk,f as Wk,L as Hk,g as Gk,h as qk,i as Xk,I as Qk,j as Yk,k as Kk,l as j0,m as h1,o as Zk}from"./three-examples.efffc148.js";import{_ as qs,c as F0,g as d1,L as xl,N as Tt,s as Jk,a as eE,b as tE,d as iE}from"./gltf-progressive.126720e3.js";import{M as $y,B as nE,P as sE,R as yr,T as Vx,C as oE,V as rE,a as aE}from"./three-quarks.5328ca18.js";import{EffectAttribute as lE}from"./postprocessing.170e2adf.js";const Vy=new Map;function _s(s=(t=>(t=globalThis.location)==null?void 0:t.hostname)()){if(Vy.has(s))return Vy.get(s);const e=/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|localhost/.test(s);return Vy.set(s,e),e===!0}function cE(){return window.location.hostname.includes("glitch.me")}const Wx=typeof window!==void 0?window.location.search.includes("debugcontext"):!1;var Me;(function(s){s.ContextRegistered="ContextRegistered",s.ContextCreationStart="ContextCreationStart",s.ContextCreated="ContextCreated",s.ContextFirstFrameRendered="ContextFirstFrameRendered",s.ContextDestroying="ContextDestroying",s.ContextDestroyed="ContextDestroyed",s.MissingCamera="MissingCamera",s.ContextClearing="ContextClearing",s.ContextCleared="ContextCleared"})(Me||(Me={}));class Be{static get Current(){return globalThis["NeedleEngine.Context.Current"]}static set Current(t){globalThis["NeedleEngine.Context.Current"]=t}static get All(){return this.Registered}static register(t){this.Registered.indexOf(t)===-1&&(Wx&&console.warn("Registering context"),this.Registered.push(t),this.dispatchCallback(Me.ContextRegistered,t))}static unregister(t){const e=this.Registered.indexOf(t);e!==-1&&(Wx&&console.warn("Unregistering context"),this.Registered.splice(e,1))}static registerCallback(t,e){this._callbacks[t]||(this._callbacks[t]=[]),this._callbacks[t].push(e)}static unregisterCallback(t,e){if(!this._callbacks[t])return;const i=this._callbacks[t].indexOf(e);i!==-1&&this._callbacks[t].splice(i,1)}static dispatchCallback(t,e,i){if(!this._callbacks[t])return!0;const n={event:t,context:e};if(i)for(const r in i)n[r]=i[r];const o=new Array;return this._callbacks[t].forEach(r=>{const l=r(n);l instanceof Promise&&o.push(l)}),Promise.all(o)}static addContextCreatedCallback(t){this.registerCallback(Me.ContextCreated,t)}static addContextDestroyedCallback(t){this.registerCallback(Me.ContextDestroyed,t)}}a(Be,"Registered",[]),a(Be,"_callbacks",{});const hE=()=>s=>s;function $F(s){return hE()(s)}function VF(){return!!k("debug")}class vs{constructor(t,e){a(this,"_factory");a(this,"_cache",[]);a(this,"_maxSize");a(this,"_index",0);this._factory=t,this._maxSize=e}get(){const t=this._index%this._maxSize;return this._index++,this._cache.length<=t&&(this._cache[t]=this._factory()),this._cache[t]}}let Il=!1;const h_=new Array;typeof window<"u"&&setTimeout(()=>{if(Il){const s={},t=new URL(window.location.href),e=new URL(t);e.searchParams.append("console","");const i=e.toString().replace(/=$|=(?=&)/g,"");for(const o of h_){const r=new URL(t);r.searchParams.append(o,""),s[o]=r.toString().replace(/=$|=(?=&)/g,"")}console.log(`üåµ ?help: Debug Options for Needle Engine.
Append any of these parameters to the URL to enable specific debug options.
Example: ${i} will show an onscreen console window.`);const n=Il===!0?"":` (containing "${Il}")`;console.group("Available URL parameters:"+n);for(const o of Object.keys(s).sort())typeof Il=="string"&&!o.toLowerCase().includes(Il.toLowerCase())||(console.groupCollapsed(o),console.log("Reload with this flag enabled:"),console.log(s[o]),console.groupEnd());console.groupEnd()}},100);function Rg(){var s;return new URLSearchParams((s=globalThis.location)==null?void 0:s.search)}function k(s){Il&&!h_.includes(s)&&h_.push(s);const t=Rg();if(t.has(s)){const e=t.get(s);if(e){const i=Number(e);return isNaN(i)?e:i}else return!0}return!1}Il=k("help");function WF(s,t){const e=Rg();e.has(s)?e.set(s,t):e.append(s,t),document.location.search=e.toString()}function vm(s,t,e=!0){const i=Rg();i.has(s)?t===null?i.delete(s):i.set(s,t):t!==null&&i.append(s,t),e?dE(s,i):u1(s,i)}function Hx(s,t,e){s.has(t)?s.set(t,e.toString()):s.append(t,e.toString())}function dE(s,t,e){window.history.pushState(e,s,"?"+t.toString())}function u1(s,t,e){window.history.replaceState(e,s,"?"+t.toString())}function HF(s){for(var t="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=e.length,n=0;n<s;n++)t+=e.charAt(Math.floor(Math.random()*i));return t}function GF(s,t){return Math.floor(Math.random()*(t-s+1))+s}const Gx=["smol","tiny","giant","interesting","smart","bright","dull","extreme","beautiful","pretty","dark","epic","salty","silly","funny","lame","lazy","loud","lucky","mad","mean","mighty","mysterious","nasty","odd","old","powerful","quiet","rapid","scary","shiny","shy","silly","smooth","sour","spicy","stupid","sweet","tasty","terrible","ugly","unusual","vast","wet","wild","witty","wrong","zany","zealous","zippy","zombie","zorro"],qx=["cat","dog","mouse","pig","cow","horse","sheep","chicken","duck","goat","panda","tiger","lion","elephant","monkey","bird","fish","snake","frog","turtle","hamster","penguin","kangaroo","whale","dolphin","crocodile","snail","ant","bee","beetle","butterfly","dragon","eagle","fish","giraffe","lizard","panda","penguin","rabbit","snake","spider","tiger","zebra"];function uE(){const s=Gx[Math.floor(Math.random()*Gx.length)],t=qx[Math.floor(Math.random()*qx.length)];return s+"_"+t}function fE(s){return s=s.replace(/[^a-z0-9√°√©√≠√≥√∫√±√º \.,_-]/gim,""),s.trim()}function af(s,t,e=!0,i=!1){var n;if(t==null)return null;if(t.userData&&t.userData.guid===s)return t;if(t.guid==s)return t;if(i&&(n=t.userData)!=null&&n.components){for(const o of t.userData.components)if(o.guid===s)return o}if(e){if(t.scenes)for(const o in t.scenes){const r=t.scenes[o],l=af(s,r,e,i);if(l)return l}if(t.children)for(const o in t.children){const r=t.children[o],l=af(s,r,e,i);if(l)return l}}}function Og(s,t){if(s!=null&&typeof s=="object"){let e;Array.isArray(s)?e=[]:(e=Object.create(s),Object.assign(e,s));for(const i of Object.keys(s)){const n=s[i];t&&!t(s,i,n)?e[i]=n:(n==null?void 0:n.clone)!==void 0&&typeof n.clone=="function"?e[i]=n.clone():e[i]=Og(n,t)}return e}return s}function Ha(s){return new Promise((t,e)=>{setTimeout(t,s)})}function kg(s,t){if(s<=0)return Promise.resolve();if(t||(t=Be.Current),!t)return Promise.reject("No context");const e=t.time.frameCount+s;return new Promise((i,n)=>{if(!t)return n("No context");const o=()=>{t.time.frameCount>=e&&(t.pre_update_callbacks.splice(t.pre_update_callbacks.indexOf(o),1),i())};t.pre_update_callbacks.push(o)})}const lp=k("debugresolveurl"),pE="rel:";function qF(s,t){return yc(s,t)}function yc(s,t){if(t===void 0)return lp&&console.warn("getPath: uri is undefined, returning uri",t),t;if(t.startsWith("./"))return t;if(t.startsWith("http"))return lp&&console.warn("getPath: uri is absolute, returning uri",t),t;if(s===void 0)return lp&&console.warn("getPath: source is undefined, returning uri",t),t;t.startsWith(pE)&&(t=t.substring(4));const e=s.lastIndexOf("/");if(e>=0){const i=s.substring(0,e+1);for(;i.endsWith("/")&&t.startsWith("/");)t=t.substring(1);const n=i+t;return lp&&console.log("source:",s,`changed uri 
from`,t,`
to `,n,`
basePath: `+i),n}return t}function mE(s){var t;if(s)return s=s.trim(),s=(t=s.split("?")[0])==null?void 0:t.split("#")[0],s}class gE{constructor(t,e){a(this,"writeCallbacks",[]);a(this,"_applied",!1);a(this,"_object");a(this,"_prop");a(this,"_wrapperProp");this._object=t,this._prop=e,this._wrapperProp=Symbol("$"+e),this.apply()}subscribeWrite(t){this.writeCallbacks.push(t)}unsubscribeWrite(t){const e=this.writeCallbacks.indexOf(t);e!==-1&&this.writeCallbacks.splice(e,1)}apply(){if(this._applied||!this._object)return;const t=this._object,e=this._prop;if(t[e]===void 0)return;this._applied=!0,t[this._wrapperProp]!==void 0&&console.warn("Watcher is being applied to an object that already has a wrapper property. This is not (yet) supported");const i=t[e];t[this._wrapperProp]=i,Object.defineProperty(t,e,{get:()=>t[this._wrapperProp],set:r=>{t[this._wrapperProp]=r;for(const l of this.writeCallbacks)l(r,this._prop)}})}revoke(){if(!this._applied||!this._object)return;this._applied=!1;const t=this._object,e=this._prop;Reflect.deleteProperty(t,e);const i=t[this._wrapperProp];t[e]=i,Reflect.deleteProperty(t,this._wrapperProp)}dispose(){this.revoke(),this.writeCallbacks.length=0,this._object=null}}class La{constructor(t,e){a(this,"_watches",[]);if(Array.isArray(e))for(const i of e)this._watches.push(new La(t,i));else this._watches.push(new gE(t,e))}subscribeWrite(t){for(const e of this._watches)e.subscribeWrite(t)}unsubscribeWrite(t){for(const e of this._watches)e.unsubscribeWrite(t)}apply(){for(const t of this._watches)t.apply()}revoke(){for(const t of this._watches)t.revoke()}dispose(){for(const t of this._watches)t.dispose();this._watches.length=0}}const th=Symbol("needle:watches");function B0(s,t){if(!s[th])if(s instanceof _e)s[th]=new La(s,["x","y"]);else if(s instanceof R)s[th]=new La(s,["x","y","z"]);else if(s instanceof Ne||s instanceof re)s[th]=new La(s,["x","y","z","w"]);else return!1;return s[th].subscribeWrite(t),!0}function f1(s,t){if(!s)return;const e=s[th];e&&e.unsubscribeWrite(t)}var Q;(function(s){let t;function e(){if(t!==void 0)return t;const J=window.navigator.userAgent,ye=/Windows|MacOS|Mac OS/.test(J),Fe=/Windows NT/.test(J)&&/Edg/.test(J)&&!/Win64/.test(J);return t=ye&&!Fe&&!E()}s.isDesktop=e;let i;function n(){return i!==void 0?i:typeof window.orientation<"u"||navigator.userAgent.indexOf("IEMobile")!==-1?i=!0:i=/iPhone|iPad|iPod|Android|IEMobile/i.test(navigator.userAgent)}s.isMobileDevice=n;function o(){return l()}s.isIPad=o;let r;function l(){if(r!==void 0)return r;const J=navigator.userAgent.toLowerCase();return r=/iPad/.test(navigator.userAgent)||J.includes("macintosh")&&"ontouchend"in document}s.isiPad=l;let c;function h(){return c!==void 0?c:c=/Android/.test(navigator.userAgent)}s.isAndroidDevice=h;let d;function u(){return d!==void 0?d:d=/WebXRViewer\//i.test(navigator.userAgent)}s.isMozillaXR=u;let f;function p(){return f!==void 0?f:f=/NeedleAppClip\//i.test(navigator.userAgent)}s.isNeedleAppClip=p;let b;function x(){if(b!==void 0)return b;if(E()||l())return b=!1;const J=navigator.userAgent.toLowerCase();return navigator.userAgentData?b=navigator.userAgentData.platform==="macOS":b=J.includes("mac os x")||J.includes("macintosh")}s.isMacOS=x;let v;function S(){return v!==void 0?v:v=l()&&"xr"in navigator&&U()}s.isVisionOS=S;let C;const P=["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"];function E(){return C!==void 0?C:C=P.includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}s.isiOS=E;let D;function M(){return D!==void 0||(D=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)),D}s.isSafari=M;let A;function G(){return A!==void 0?A:A=navigator.userAgent.includes("OculusBrowser")}s.isQuest=G;let V;function U(){return V!==void 0||(V=document.createElement("a").relList.supports("ar")),V}s.supportsQuickLookAR=U;async function $(){try{return(await navigator.permissions.query({name:"microphone"})).state!=="denied"}catch(J){return console.error("Error querying `microphone` permissions.",J),!1}}s.microphonePermissionsGranted=$;let Y;function B(){if(Y!==void 0)return Y;const J=navigator.userAgent.match(/iPhone OS (\d+_\d+)/);if(J&&(Y=J[1].replace("_",".")),!Y){const ye=navigator.userAgent.match(/(?:\(Macintosh;|iPhone;|iPad;).*Version\/(\d+\.\d+)/);ye&&(Y=ye[1])}return Y||(Y=null),Y}s.getiOSVersion=B;let N;function Z(){if(N!==void 0)return N;const J=navigator.userAgent.match(/(?:CriOS|Chrome)\/(\d+\.\d+\.\d+\.\d+)/);return J?N=J[1].replace("_","."):N=null,N}s.getChromeVersion=Z;let ae;function ie(){if(ae!==void 0)return ae;const J=navigator.userAgent.match(/Version\/(\d+\.\d+)/);return J&&M()?ae=J[1]:ae=null,ae}s.getSafariVersion=ie})(Q||(Q={}));function XF(){return Q.isDesktop()}function QF(){return Q.isMobileDevice()}function YF(){return Q.isiPad()}function KF(){return Q.isiPad()}function ZF(){return Q.isAndroidDevice()}function JF(){return Q.isMozillaXR()}function e4(){return Q.isMacOS()}function t4(){return Q.isiOS()}function i4(){return Q.isSafari()}function n4(){return Q.isQuest()}async function s4(){return Q.microphonePermissionsGranted()}const ka=new WeakMap;function p1(s,t,e){if(!ka.get(s)){const n=new MutationObserver(o=>{yE(s,o)});ka.set(s,{observer:n,attributeChangedListeners:new Map}),n.observe(s,{attributes:!0})}const i=ka.get(s).attributeChangedListeners;return i.has(t)||i.set(t,[]),i.get(t).push(e),()=>{m1(s,t,e)}}function m1(s,t,e){if(!ka.get(s))return;const i=ka.get(s).attributeChangedListeners;if(!i.has(t))return;const n=i.get(t),o=n.indexOf(e);if(o!==-1&&(n.splice(o,1),n.length<=0)){i.delete(t);const r=ka.get(s);r==null||r.observer.disconnect(),ka.delete(s)}}function yE(s,t){const e=ka.get(s).attributeChangedListeners;for(const i of t)if(i.type==="attributes"){const n=i.attributeName,o=s.getAttribute(n);if(e.has(n))for(const r of e.get(n))r(o)}}class Xx{constructor(t){a(this,"reason");this.reason=t}}async function g1(s){const t=await Promise.allSettled(s).catch(n=>[new Xx(n.message)]);let e=!1;const i=t.map(n=>"value"in n?n.value:(e=!0,new Xx(n.reason)));return{anyFailed:e,results:i}}const bE=k("debugdebug");let U0=!1;(k("noerrors")||k("nooverlaymessages"))&&(U0=!0);const Wy="needle_engine_global_error_container";var Ti;(function(s){s[s.Log=0]="Log",s[s.Warn=1]="Warn",s[s.Error=2]="Error"})(Ti||(Ti={}));function y1(){return _1}const d_=new Array;function _E(s){d_.push(s)}let Hy=!1;function vE(...s){if(!Hy){Hy=!0;try{for(let t=0;t<d_.length;t++)d_[t](...s)}catch(t){console.error(t)}Hy=!1}}const b1=console.error,xE=function(...s){b1.apply(console,s),CE(s),Vl(Ti.Error,s),SE(...s)};function wE(s){U0=!s,s?console.error=xE:console.error=b1}function o4(s){return wE(s)}let _1=0;function SE(...s){_1+=1,vE(...s)}function CE(s){if(Array.isArray(s))for(let t=0;t<s.length;t++){const e=s[t];typeof e=="string"&&e.startsWith("THREE.PropertyBinding: Trying to update node for track:")&&(s[t]="Some animated objects couldn't be found: see console for details")}}function Vl(s,t,e,i){if(U0)return;const n=Be.Current;let o=(n==null?void 0:n.domElement)??document.querySelector("needle-engine");if(n.isInAR&&(o=n.arOverlayElement),!!o){if(Array.isArray(t)){let r="";for(let l=0;l<t.length;l++){let c=t[l];c instanceof Error&&(c=c.message),typeof c!="object"&&(l>0&&(r+=" "),r+=c)}t=r}!t||t.length<=0||PE(s,o,t)}}const mu=new Map;function PE(s,t,e){if(e==null)return;const i=RE(t);if(i.childElementCount>=20){const l=i.lastElementChild;Qx(l)}e.length>400&&(e=e.substring(0,400)+"...");const n=e;if(mu.has(n))return;const o=OE(s,e);i.prepend(o);const r=()=>{mu.delete(n),Qx(o)};mu.set(n,r),setTimeout(r,1e4)}function r4(){bE&&console.log("Clearing messages");for(const s of mu.values())s==null||s.call(s);mu.clear()}const TE=`

@import url('https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap');

div[data-needle_engine_debug_overlay] {
    font-family: 'Roboto Flex', sans-serif;
    font-weight: 400;
    font-size: 16px;
}

div[data-needle_engine_debug_overlay] strong {
    font-weight: 700;
}

div[data-needle_engine_debug_overlay] a {
    color: white;
    text-decoration: none;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
}

div[data-needle_engine_debug_overlay] a:hover {
    text-decoration: none;
    border: none;
}

div[data-needle_engine_debug_overlay] .log strong {
    color: rgba(200,200,200,.9);
}

div[data-needle_engine_debug_overlay] .warn strong {
    color: rgba(255,255,230, 1);
}

div[data-needle_engine_debug_overlay] .error strong {
    color: rgba(255,100,120, 1);
}
`;function RE(s){var e;globalThis[Wy]||(globalThis[Wy]=new Map);const t=globalThis[Wy];if(t.has(s))return t.get(s);{const i=document.createElement("div");t.set(s,i),i.setAttribute("data-needle_engine_debug_overlay",""),i.classList.add("debug-container"),i.style.cssText=`
            position: absolute;
            top: 0;
            right: 5px;
            padding-top: env(safe-area-inset-top, 0px);
            max-width: 70%;
            max-height: calc(100% - 105px);
            z-index: 100000;
            pointer-events: scroll;
            display: flex;
            align-items: end;
            flex-direction: column;
            color: white;
            overflow: auto;
            word-break: break-word;
        `,Q.isNeedleAppClip()&&(i.style.left="5px",i.style.right="unset");const n=document.querySelector('meta[name="viewport"]');n&&!((e=n.getAttribute("content"))!=null&&e.includes("viewport-fit="))&&n.setAttribute("content",n.getAttribute("content")+",viewport-fit=cover"),s.shadowRoot?s.shadowRoot.appendChild(i):s.appendChild(i);const o=document.createElement("style");return o.innerHTML=TE,i.appendChild(o),i}}const v1=Symbol("logtype"),xm=new Map;function Qx(s){s.remove();const t=s[v1],e=xm.get(t)??[];e.push(s),xm.set(t,e)}function OE(s,t){if(xm.has(s)){const i=xm.get(s);if(i.length>0){const n=i.pop();return n.innerHTML=t,n}}const e=document.createElement("div");switch(e.setAttribute("data-id","__needle_engine_debug_overlay"),e.style.marginRight="5px",e.style.padding=".5em",e.style.backgroundColor="rgba(0,0,0,.9)",e.style.marginTop="5px",e.style.marginBottom="3px",e.style.borderRadius="8px",e.style.pointerEvents="all",e.style.userSelect="text",e.style.maxWidth="250px",e.style.whiteSpace="pre-wrap",e.style["backdrop-filter"]="blur(10px)",e.style["-webkit-backdrop-filter"]="blur(10px)",e.style.backgroundColor="rgba(20,20,20,.8)",e.style.boxShadow="inset 0 0 80px rgba(0,0,0,.2), 0 0 5px rgba(0,0,0,.2)",e.style.border="1px solid rgba(160,160,160,.2)",e[v1]=s,s){case Ti.Log:e.classList.add("log"),e.style.color="rgba(200,200,200,.7)",e.style.backgroundColor="rgba(40,40,40,.7)";break;case Ti.Warn:e.classList.add("warn"),e.style.color="rgb(255, 255, 150)",e.style.backgroundColor="rgba(50,50,20,.8)";break;case Ti.Error:e.classList.add("error"),e.style.color="rgb(255, 50, 50",e.style.backgroundColor="rgba(50,20,20,.8)";break}return e.title="Open the browser console (F12) for more information",e.innerHTML=t,e}class kE{constructor(){a(this,"Rad2Deg",180/Math.PI);a(this,"Deg2Rad",Math.PI/180);a(this,"Epsilon",1e-5)}random(t,e){return Array.isArray(t)?t.length<=0?null:t[Math.floor(Math.random()*t.length)]:t!==void 0&&e!==void 0?Math.random()*(e-t)+t:Math.random()}randomVector3(t,e=0,i=1){t.x=this.random(e,i),t.y=this.random(e,i),t.z=this.random(e,i)}clamp(t,e,i){return t<e?e:t>i?i:t}clamp01(t){return this.clamp(t,0,1)}lerp(t,e,i){return i=i<0?0:i,i=i>1?1:i,t+(e-t)*i}inverseLerp(t,e,i){return(i-t)/(e-t)}remap(t,e,i,n,o){return n+(o-n)*(t-e)/(i-e)}moveTowards(t,e,i){return t+=i,(i<0&&t<e||i>0&&t>e)&&(t=e),t}toDegrees(t){return t*180/Math.PI}toRadians(t){return t*Math.PI/180}tan(t){return Math.tan(t)}gammaToLinear(t){return Math.pow(t,2.2)}linearToGamma(t){return Math.pow(t,1/2.2)}approximately(t,e,i=Number.EPSILON){for(const n of EE){const o=t[n],r=e[n];if(o===void 0||r===void 0)break;if(Math.abs(o-r)>i)return!1}return!0}easeInOutCubic(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}}const EE=["x","y","z","w"],ee=new kE;class Yx{constructor(t){a(this,"y");a(this,"s");a(this,"alpha",0);this.setAlpha(t),this.y=null,this.s=null}setAlpha(t){if(t<=0||t>1)throw new Error;this.alpha=t}filter(t,e){e&&this.setAlpha(e);let i;return this.y?i=this.alpha*t+(1-this.alpha)*this.s:i=t,this.y=t,this.s=i,i}lastValue(){return this.y}reset(t){this.y=t,this.s=t}}class Gy{constructor(t,e=1,i=0,n=1){a(this,"freq");a(this,"minCutOff");a(this,"beta");a(this,"dCutOff");a(this,"x");a(this,"dx");a(this,"lasttime");if(t<=0||e<=0||n<=0)throw new Error;this.freq=t,this.minCutOff=e,this.beta=i,this.dCutOff=n,this.x=new Yx(this.alpha(this.minCutOff)),this.dx=new Yx(this.alpha(this.dCutOff)),this.lasttime=null}alpha(t){const e=1/this.freq;return 1/(1+1/(2*Math.PI*t)/e)}filter(t,e=null){this.lasttime&&e&&(this.freq=1/(e-this.lasttime)),this.lasttime=e;const i=this.x.lastValue(),n=i?(t-i)*this.freq:0,o=this.dx.filter(n,this.alpha(this.dCutOff)),r=this.minCutOff+this.beta*Math.abs(o);return this.x.filter(t,this.alpha(r))}reset(t){t!=null&&this.x.reset(t),this.x.alpha=this.alpha(this.minCutOff),this.dx.alpha=this.alpha(this.dCutOff),this.lasttime=null}}class x1{constructor(t,e=1,i=0,n=1){a(this,"x");a(this,"y");a(this,"z");this.x=new Gy(t,e,i,n),this.y=new Gy(t,e,i,n),this.z=new Gy(t,e,i,n)}filter(t,e,i=null){e.x=this.x.filter(t.x,i),e.y=this.y.filter(t.y,i),e.z=this.z.filter(t.z,i)}reset(t){this.x.reset(t==null?void 0:t.x),this.y.reset(t==null?void 0:t.y),this.z.reset(t==null?void 0:t.z)}}const Yp="needle:cameraController";function ME(s){return s[Yp]}function Kx(s,t,e){e?s[Yp]=t:s[Yp]===t&&(s[Yp]=null)}const u_="needle:autofit";function AE(s){return s[u_]===void 0?!0:s[u_]!==!1}function f_(s,t){s[u_]=t}let Es;const IE={x:0,y:0,width:0,height:0},LE=k("debugfocusrect");function DE(s,t,e,i,n){s instanceof Element&&(LE&&s instanceof HTMLElement&&(s.style.outline="2px dashed rgba(255, 150, 0, .8)"),s=s.getBoundingClientRect()),Es=n.domElement.getBoundingClientRect();const o=IE;o.x=s.x,o.y=s.y,o.width=s.width,o.height=s.height,o.x-=Es.x,o.y-=Es.y;const r=Es.width,l=Es.height,c=i.view,h=t.zoom;let d=(c==null?void 0:c.offsetX)||0,u=(c==null?void 0:c.offsetY)||0,f=Es.width,p=Es.height;f/=h,p/=h,d=f*(h-1)*.5,u=p*(h-1)*.5;const b=o.x+o.width*.5,x=o.y+o.height*.5,v=Es.width*.5,S=Es.height*.5,C=b-v,P=x-S;d-=C/h,u-=P/h,t.offsetX!==void 0&&(d+=t.offsetX*(Es.width*.5)),t.offsetY!==void 0&&(u-=t.offsetY*(Es.height*.5));const E=(c==null?void 0:c.offsetX)||d,D=(c==null?void 0:c.offsetY)||u;d=ee.lerp(E,d,e),u=ee.lerp(D,u,e);const M=(c==null?void 0:c.width)||r,A=(c==null?void 0:c.height)||l;f=ee.lerp(M,f,e),p=ee.lerp(A,p,e),i.setViewOffset(r,l,d,u,f,p),i.updateProjectionMatrix(),t.damping>0&&(t.damping*=1-e,t.damping<.01&&(t.damping=0),t.damping=Math.max(0,t.damping))}function a4(s,t,e){const i=s.length(),n=t.length(),o=ee.lerp(i,n,e);return s.lerp(t,e).normalize().multiplyScalar(o)}const qy=new re,w1=new re().setFromAxisAngle(new R(0,1,0),Math.PI);function l4(s,t){s.lookAt(t),s.quaternion.multiply(w1)}function Eg(s,t,e=!0,i=!1){if(s===t)return;qy.copy(s.quaternion);const n=ve(t),o=ve(s);if(i){if(Yo(s,Qe(t)),e){const r=o.y,l=o.sub(WE(s));l.y=r,s.lookAt(l),s.quaternion.multiply(w1)}Number.isNaN(s.quaternion.x)&&s.quaternion.copy(qy);return}e&&(n.y=o.y),s.lookAt(n),Number.isNaN(s.quaternion.x)&&s.quaternion.copy(qy)}function c4(s,t,e,i=1){if(e){const n=te(0,0,0),o=t.x/window.innerWidth*2-1,r=-(t.y/window.innerHeight)*2+1;n.set(o,r,0),n.unproject(e);const l=e.worldPosition,c=s.worldPosition.distanceTo(l),h=n.sub(l);h.multiplyScalar(i*3.6*c);const d=e.worldPosition.add(h);return s.lookAt(d),d}return null}const jE=new vs(()=>new R,100);function te(s,t,e){const i=jE.get();return i.set(0,0,0),s instanceof R?i.copy(s):Array.isArray(s)?i.set(s[0],s[1],s[2]):s instanceof DOMPointReadOnly?i.set(s.x,s.y,s.z):typeof s=="number"?(i.x=s,i.y=t!==void 0?t:i.x,i.z=e!==void 0?e:i.x):typeof s=="object"&&(i.x=s.x,i.y=s.y,i.z=s.z),i}const FE=new vs(()=>new Se,30);function BE(s){const t=FE.get();return s?t.copy(s):t.set(0,0,0),t}const UE=new vs(()=>new re,100);function Un(s,t,e,i){const n=UE.get();return n.identity(),s instanceof re?n.copy(s):s instanceof DOMPointReadOnly?n.set(s.x,s.y,s.z,s.w):typeof s=="number"&&t!==void 0&&e!==void 0&&i!==void 0?n.set(s,t,e,i):typeof s=="object"&&"x"in s&&"y"in s&&"z"in s&&"w"in s&&n.set(s.x,s.y,s.z,s.w),n}const N0=new vs(()=>new R,100),Zx=Symbol("lastMatrixWorldUpdateKey");function ve(s,t=null,e=!0){const i=t??N0.get();return s?s.parent?(e&&s.updateWorldMatrix(!0,!1),s.matrixWorldNeedsUpdate&&s[Zx]!==Date.now()&&(s[Zx]=Date.now(),s.updateMatrixWorld()),i.setFromMatrixPosition(s.matrixWorld),i):i.copy(s.position):i.set(0,0,0)}function Oi(s,t){if(!s)return s;const e=N0.get();return t!==e&&e.copy(t),s.parent!==null&&s.parent.worldToLocal(e),s.position.set(e.x,e.y,e.z),s}function Qh(s,t,e,i){const n=N0.get();return n.set(t,e,i),Oi(s,n),s}const wm=new vs(()=>new re,100),Zl=new re,Xy=new re;function Qe(s,t=null){if(!s)return wm.get().identity();const e=t??wm.get();return s.parent?(s.getWorldQuaternion(e),e):e.copy(s.quaternion)}function Yo(s,t){if(!s)return;t!==Zl&&Zl.copy(t);const e=Zl,i=s==null?void 0:s.parent;i==null||i.getWorldQuaternion(Xy),Xy.invert();const n=Xy.multiply(e);s.quaternion.set(n.x,n.y,n.z,n.w)}function S1(s,t,e,i,n){Zl.set(t,e,i,n),Yo(s,Zl)}const NE=new vs(()=>new R,100),zE=new R;function Lt(s,t=null){return t||(t=NE.get()),s?s.parent?(s.getWorldScale(t),t):t.copy(s.scale):t.set(0,0,0)}function lf(s,t){if(!s)return;if(!s.parent){s.scale.copy(t);return}const e=zE;s.parent.getWorldScale(e),s.scale.copy(t),s.scale.divide(e)}const $E=new R,Jx=new re;function h4(s){return Qe(s,Jx),$E.set(0,0,1).applyQuaternion(Jx)}const VE=new vs(()=>new R,100),ew=new re;function WE(s,t){return t||(t=VE.get().set(0,0,1)),Qe(s,ew),t.applyQuaternion(ew)}const tw=new Ht,iw=new Ht,HE=new R;function C1(s){const t=wm.get();return s.getWorldQuaternion(t),iw.setFromQuaternion(t),iw}function P1(s,t){const e=wm.get();Yo(s,e.setFromEuler(t))}function z0(s){const t=C1(s),e=HE;return e.set(t.x,t.y,t.z),e.x=ee.toDegrees(e.x),e.y=ee.toDegrees(e.y),e.z=ee.toDegrees(e.z),e}function GE(s,t){Mg(s,t.x,t.y,t.z,!0)}function Mg(s,t,e,i,n=!0){n&&(t=ee.toRadians(t),e=ee.toRadians(e),i=ee.toRadians(i)),tw.set(t,e,i),Zl.setFromEuler(tw),Yo(s,Zl)}function p_(s,t=!0){s&&(t?function e(i){console.groupCollapsed((i.name?i.name:"(no name : "+i.type+")")+" %o",i),i.children.forEach(e),console.groupEnd()}(s):s.traverse(function(e){for(var i="|___",n=e;n.parent!==null;)i="	"+i,n=n.parent;console.log(i+e.name+" <"+e.type+">")}))}function d4(s){let t=(s==null?void 0:s.name)||"";if(!s)return t;let e=s.parent;for(;e;)t=e.name+"/"+t,e=e.parent;return t}function qE(s){if(s){const t=s;return t.blendMode!==void 0&&t.clampWhenFinished!==void 0&&t.enabled!==void 0&&t.fadeIn!==void 0&&t.getClip!==void 0}return!1}const ex=class extends Xo{constructor(){super({vertexShader:ex.vertex,uniforms:{map:new ys(null),flipY:new ys(!0),writeDepth:new ys(!1),depthTexture:new ys(null)},fragmentShader:`
uniform sampler2D map;
uniform bool flipY;
uniform bool writeDepth;
uniform sampler2D depthTexture;

varying vec2 vUv;

void main(){ 
    vec2 uv = vUv;
    if (flipY) uv.y = 1.0 - uv.y;
    gl_FragColor = texture2D(map, uv);

    if (writeDepth) {
        float depth = texture2D(depthTexture, uv).r;
        gl_FragDepth = depth;

        // float linearDepth = (depth - 0.99) * 100.0; // Enhance near 1.0 values
        // gl_FragColor = vec4(linearDepth, linearDepth, linearDepth, 1.0);
    }
}`})}reset(){this.uniforms.map.value=null,this.uniforms.flipY.value=!0,this.uniforms.writeDepth.value=!1,this.uniforms.depthTexture.value=null,this.needsUpdate=!0,this.uniformsNeedUpdate=!0}};let gu=ex;a(gu,"vertex",`
varying vec2 vUv;
void main(){
    vUv = uv;
    gl_Position = vec4(position.xy, 0., 1.0);
}`);const rg=class{static copyTexture(t,e){e||(e=this.blitMaterial),this.blitMaterial.reset();const i=e||this.blitMaterial;i.uniforms.map.value=t,i.needsUpdate=!0,i.uniformsNeedUpdate=!0;const n=i.vertexShader;i.vertexShader=gu.vertex;const o=this.mesh;o.material=i,o.frustumCulled=!1,this.scene.children.length=0,this.scene.add(o),this.renderer.setSize(t.image.width,t.image.height),this.renderer.clear(),this.renderer.render(this.scene,this.perspectiveCam);const r=new _t(this.renderer.domElement);return r.name="Copy",r.needsUpdate=!0,i.vertexShader=n,r}static blit(t,e,i){const{renderer:n=this.renderer,blitMaterial:o=this.blitMaterial,flipY:r=!1,depthTexture:l=null,depthTest:c=!0,depthWrite:h=!0}=i||{};this.blitMaterial.reset(),o.uniforms.map&&(o.uniforms.map.value=t),o.uniforms.flipY&&(o.uniforms.flipY.value=r),l?(o.uniforms.writeDepth=new ys(!0),o.uniforms.depthTexture.value=l):(o.uniforms.writeDepth=new ys(!1),o.uniforms.depthTexture.value=null),o.needsUpdate=!0,o.uniformsNeedUpdate=!0;const d=this.mesh;d.material=o,d.frustumCulled=!1,this.scene.children.length=0,this.scene.add(d);const u=n.getRenderTarget(),f=n.getContext(),p=f.getParameter(f.DEPTH_TEST),b=f.getParameter(f.DEPTH_WRITEMASK),x=f.getParameter(f.DEPTH_FUNC);c?n.getContext().enable(n.getContext().DEPTH_TEST):n.getContext().disable(n.getContext().DEPTH_TEST),n.state.buffers.depth.setMask(h),n.setClearColor(new Se(0,0,0),0),n.pixelRatio!==window.devicePixelRatio&&n.xr.isPresenting===!1&&n.setPixelRatio(window.devicePixelRatio),n.setRenderTarget(e),n.clear(),n.render(this.scene,this.perspectiveCam),n.setRenderTarget(u);const v=n.state.buffers.depth;v.setTest(p),v.setMask(b),v.setFunc(x)}static textureToCanvas(t,e=!1){if(!t)return null;(e===!0||t.isCompressedTexture===!0)&&(t=XE(t));const i=t.image;if(QE(i)){const n=document.createElement("canvas");n.width=i.width,n.height=i.height;const o=n.getContext("2d");return o?(o.drawImage(i,0,0,i.width,i.height,0,0,n.width,n.height),n):(console.error("Failed getting canvas 2d context"),null)}return null}};let Fn=rg;a(Fn,"planeGeometry",new to(2,2,1,1)),a(Fn,"renderer",new gc({antialias:!1,alpha:!0})),a(Fn,"perspectiveCam",new Ae),a(Fn,"orthographicCam",new _g),a(Fn,"scene",new Xn),a(Fn,"blitMaterial",new gu),a(Fn,"mesh",new le(rg.planeGeometry,rg.blitMaterial));function XE(s){return Fn.copyTexture(s)}function u4(s,t=!1){return Fn.textureToCanvas(s,t)}function QE(s){return typeof HTMLImageElement<"u"&&s instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&s instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas||typeof ImageBitmap<"u"&&s instanceof ImageBitmap}function YE(s){const t=s.type;return t==="Mesh"||t==="SkinnedMesh"}function T1(s,t){t?s["needle:rendercustomshadow"]=!0:s["needle:rendercustomshadow"]=!1}function KE(s){if(s){if(s["needle:rendercustomshadow"]===!0)return!0;if(s["needle:rendercustomshadow"]==null)return!0}return!1}function On(s,t=void 0,e=void 0,i=void 0){const n=i||new bs;n.makeEmpty();const o=[];function r(c){let h=!0;if(c.visible&&AE(c)!==!1&&!(c.type==="TransformControlsGizmo"||c.type==="TransformControlsPlane")){if(c instanceof yO&&(h=!1),c instanceof WC&&(h=!1),c instanceof Xh&&(h=!1),c.isGizmo===!0&&(h=!1),c.material instanceof VC&&(h=!1),YE(c)||(h=!1),e&&c.layers.test(e)===!1&&(h=!1),h){if(t&&Array.isArray(t)&&(t!=null&&t.includes(c)))return;if(typeof t=="function"&&t(c)===!0)return}if(c.isUI!==!0){if(h){const d=c.children;c.children=o;const u=c.position,f=c.scale;if(Number.isNaN(u.x)||Number.isNaN(u.y)||Number.isNaN(u.z)){console.warn(`Object "${c.name}" has NaN values in position or scale.... will ignore it`,u,f);return}c.geometry===null&&(c.geometry=void 0),n.expandByObject(c,!0),c.children=d}for(const d of c.children)r(d)}}}let l=!1;Array.isArray(s)||(s=[s]);for(const c of s)c&&(l=!0,c.updateMatrixWorld(),r(c));return l||console.warn("No objects to fit camera to..."),n}function ZE(s,t,e){const i=On([s],e==null?void 0:e.ignore),n=new R;i.getSize(n);const o=new R;i.getCenter(o);const r=new R;t.getSize(r);const l=new R;t.getCenter(l);const c=new R;c.set(r.x/n.x,r.y/n.y,r.z/n.z);const h=Math.min(c.x,c.y,c.z),d=(e==null?void 0:e.scale)!==!1;if(d&&lf(s,Lt(s).multiplyScalar(h)),(e==null?void 0:e.position)!==!1){const u=new R;i.getCenter(u),u.y=i.min.y;const f=new R;t.getCenter(f),f.y=t.min.y;const p=f.clone().sub(u);d&&p.multiplyScalar(h),Oi(s,ve(s).add(p))}return{boundsBefore:i,scale:c}}function JE(s,t){const e=On([s]),i=new R;e.getCenter(i),i.y=e.min.y;const n=t.clone().sub(i),o=ve(s);return Oi(s,o.add(n)),{offset:n,bounds:e}}function R1(s,t,e,i){if(Array.isArray(t)){let r=!0;for(let l=0;l<t.length;l++)R1(s,t[l],l,t)||(r=!1);return r}if(t.type==="MeshStandardMaterial"||t.type==="MeshBasicMaterial")return!1;if(t["material:fbx"]!=null)return!0;const n=new ti;n["material:fbx"]=t;const o=t;return o&&(o.map?n.color.set(1,1,1):n.color.copyLinearToSRGB(o.color),n.emissive.copyLinearToSRGB(o.emissive),n.emissiveIntensity=o.emissiveIntensity,n.opacity=o.opacity,n.displacementScale=o.displacementScale,n.transparent=o.transparent,n.bumpMap=o.bumpMap,n.aoMap=o.aoMap,n.map=o.map,n.displacementMap=o.displacementMap,n.emissiveMap=o.emissiveMap,n.normalMap=o.normalMap,n.envMap=o.envMap,n.alphaMap=o.alphaMap,n.metalness=o.reflectivity,n.vertexColors=o.vertexColors,o.shininess&&(n.roughness=1-Math.sqrt(o.shininess)/10),n.needsUpdate=!0),e===void 0?s.material=n:i[e]=n,!0}let cp=!1;_E((...s)=>{var t;X()&&((t=Be.Current)!=null&&t.isInXR)&&(yu(!0),O1("error",...s))});function yu(s){if(s){if(cp)return;cp=!0,tM()}else{if(!cp)return;cp=!1,iM()}}const bu={log:void 0,warn:void 0,error:void 0};class eM{constructor(){a(this,"familyName","needle-xr");a(this,"root",null);a(this,"context",null);a(this,"defaultFontSize",.06);a(this,"targetObject",new z);a(this,"userForwardViewPoint",new R);a(this,"oneEuroFilter",new x1(90,.8));a(this,"_lastElementRemoveTime",0);a(this,"onBeforeRender",()=>{var e,i;const t=(e=this.context)==null?void 0:e.mainCamera;if(this.context&&t instanceof Ae){const n=this.getRoot();Number.isNaN(n.position.x)&&n.position.set(0,0,0),Number.isNaN(n.quaternion.x)&&n.quaternion.set(0,0,0,1),this.context.scene.add(this.targetObject);const o=((i=this.context.xr)==null?void 0:i.rigScale)??1,r=3.5*o,l=t.worldForward;l.y=0,l.normalize().multiplyScalar(r),this.userForwardViewPoint.copy(t.worldPosition).sub(l),this.targetObject.position.distanceTo(this.userForwardViewPoint)>2*o&&(this.targetObject.position.copy(this.userForwardViewPoint),Eg(this.targetObject,t,!0,!0),this.targetObject.rotateY(Math.PI)),this.oneEuroFilter.filter(this.targetObject.position,n.position,this.context.time.time);const h=this.context.time.deltaTime;if(n.quaternion.slerp(this.targetObject.quaternion,h*5),n.scale.setScalar(o),this.targetObject.removeFromParent(),this.context.scene.add(n),this.context.time.time-this._lastElementRemoveTime>.1){this._lastElementRemoveTime=this.context.time.time;const d=Date.now();for(let u=0;u<this._activeTexts.length;u++){const f=this._activeTexts[u];if(f instanceof it.Text&&d-f._activatedTime>2e4){f.removeFromParent(),this._textBuffer.push(f),this._activeTexts.splice(u,1);break}}}}});a(this,"textOptions",{fontSize:this.defaultFontSize,fontFamily:this.familyName,padding:.03,margin:.005,color:0,backgroundColor:16777215,backgroundOpacity:.4,borderRadius:.03,offset:.025});a(this,"_textBuffer",[]);a(this,"_activeTexts",[]);this.ensureFont()}onEnable(){this.context=Be.Current||Be.All[0],this.context.pre_render_callbacks.push(this.onBeforeRender)}onDisable(){var t,e,i;(e=this.context)==null||e.pre_render_callbacks.splice((t=this.context)==null?void 0:t.pre_render_callbacks.indexOf(this.onBeforeRender),1),(i=this.root)==null||i.removeFromParent()}addLog(t,e){const i=this.getRoot(),n=this.getText();let o=16777215,r=0;switch(t){case"log":o=16777215,r=0;break;case"warn":o=16772761,r=4465152;break;case"error":o=16755370,r=7798784;break}e.length>1e3&&(e=e.substring(0,1e3)+"...");const l=new Date().toISOString().split("T")[1].split(".")[0];n.textContent="["+l+"] "+e,n.visible=!0,n._activatedTime=Date.now(),i.add(n),this._activeTexts.push(n),this.context&&this.context.scene.add(i),n.set({backgroundColor:o,color:r}),it.update()}ensureFont(){let t=it.FontLibrary.getFontFamily(this.familyName);if(!t){t=it.FontLibrary.addFontFamily(this.familyName);const e=t.addVariant("normal","normal","./include/needle/arial-msdf.json","./include/needle/arial.png");e==null||e.addEventListener("ready",()=>{it.update()})}}getText(){const t=this.getRoot();if(this._textBuffer.length>0){const i=this._textBuffer.pop();return i.visible=!0,setTimeout(()=>this.disableDepthTestRecursive(i),100),i}if(t.children.length>20&&this._activeTexts.length>0)return this._activeTexts.shift();const e=new it.Text(this.textOptions);return setTimeout(()=>this.disableDepthTestRecursive(e),500),setTimeout(()=>this.disableDepthTestRecursive(e),1500),e}disableDepthTestRecursive(t,e=0){for(let n=0;n<t.children.length;n++){const o=t.children[n];o instanceof z&&this.disableDepthTestRecursive(o,e+1)}t.renderOrder=10*e,t.layers.set(2);const i=t.material;i&&(i.depthWrite=!1,i.depthTest=!1,i.transparent=!0),e===0&&it.update()}getRoot(){if(this.root)return this.root;const t=this.defaultFontSize,e={boxSizing:"border-box",fontFamily:this.familyName,width:"2.6",fontSize:t,color:0,lineHeight:1,backgroundColor:16777215,backgroundOpacity:0,whiteSpace:"pre-wrap",flexDirection:"column-reverse"};return this.root=new it.Block(e),this.root}}let hn=null;function tM(){hn||(hn=new eM),hn.onEnable();for(const s in bu){bu[s]=console[s];let t=!1;console[s]=function(){var e;if((e=bu[s])==null||e.apply(console,arguments),!t)try{t=!0,O1(s,...arguments)}finally{t=!1}}}}function iM(){hn==null||hn.onDisable();for(const s in bu)console[s]=bu[s]}const Ud=new Map;function O1(s,...t){try{switch(Ud.clear(),s){case"log":hn==null||hn.addLog("log",e());break;case"warn":hn==null||hn.addLog("warn",e());break;case"error":hn==null||hn.addLog("error",e());break}}catch(o){console.error("Error in spatial console",o)}finally{Ud.clear()}function e(){let o="";for(let r=0;r<t.length;r++){const l=t[r];o+=i(l),r<t.length-1&&(o+=", ")}return o}function i(o,r=0){if(typeof o=="string")return'"'+o+'"';if(typeof o=="number"){if(o%1!==0){const c=o.toFixed(5),h=c.indexOf(".");let d=c.length-1;for(;d>h&&c[d]==="0";)d--;return c.substring(0,d+1)}return o.toString()}else if(Array.isArray(o)){let l="[";for(let c=0;c<o.length;c++){const h=o[c];l+=i(h,r+1),c<o.length-1&&(l+=", ")}return l+="]",l}else{if(o===null)return"null";if(o===void 0)return"undefined";if(typeof o=="function")return o.name+"()"}if(o instanceof _e)return`(${i(o.x)}, ${i(o.y)})`;if(o instanceof R)return`(${i(o.x)}, ${i(o.y)}, ${i(o.z)})`;if(o instanceof Ne)return`(${i(o.x)}, ${i(o.y)}, ${i(o.z)}, ${i(o.w)})`;if(o instanceof re)return`(${i(o.x)}, ${i(o.y)}, ${i(o.z)}, ${i(o.w)})`;if(o instanceof Xe||o instanceof _t)return o.name;if(o instanceof HC)return`[${o.elements.join(", ")}]`;if(o instanceof xe)return`[${o.elements.join(", ")}]`;if(o instanceof Va)return o.mask.toString();if(typeof o=="object"){if(Ud.has(o))return"*";let l=`{
`;l+=n(r);const c=Object.keys(o);let h="";for(let d=0;d<c.length;d++){const u=c[d],f=o[u];if(Ud.has(f)){h+="";continue}Ud.set(f,!0),h+=u+":"+i(f,r+1),d<c.length-1&&(h+=", "),h.length>=60&&(h+=`
`,h+=n(r),l+=h,h="")}return l+=h,l+=`
}`,l}return o}function n(o){let r="";for(let l=0;l<o;l++)r+=" ";return r}}const nM=k("nodevlogs");function at(s,t=Ti.Log){Vl(t,s)}function qe(s){at(s,Ti.Warn)}function Ag(s){at(s,Ti.Error)}let m_,Qy;function X(){if(nM)return!1;if(m_!==void 0)return m_;if(Qy!==void 0)return Qy;let s=_s();return s||(s=window.location.hostname.endsWith(".local-credentialless.webcontainer.io")),Qy=s,s}function f4(s){m_=s}let Xi,pr=null,jo=null,Nd=!1,nw=null;const k1="terminal",sM=k("console");sM&&E1();const oM=Symbol("consoleParent");function E1(){if(Xi){Xi.showSwitch();return}dM()}function rM(){Xi&&(Xi.hide(),Xi.hideSwitch())}function aM(){nw||(nw=setInterval(lM,500))}let sw=0;function lM(){const s=y1(),t=s!==sw;sw=s,t&&cM()}function cM(){E1(),jo&&(jo.setAttribute("error","true"),jo.innerText="ü§¨")}function hM(){jo&&(jo.removeAttribute("error"),jo.innerText=k1)}function dM(s=!1){if(Xi!==void 0||Nd)return;Nd=!0;const t=document.createElement("script");t.onload=()=>{if(!globalThis.VConsole){console.warn("üåµ Debug console failed to load."),Nd=!1,Xi=null;return}Nd=!1,aM(),Xi=new VConsole({pluginOrder:["default","needle-console"]});const e=globalThis["needle:codegen_files"];if(e&&e.length>0&&Xi.addPlugin(uM()),Xi.addPlugin(gM()),Xi.addPlugin(yM()),pr=OM(),pr&&(pr[oM]=pr.parentElement,pr.style.position="absolute",pr.style.zIndex=Number.MAX_SAFE_INTEGER.toString()),Xi.setSwitchPosition(20,30),jo=RM(),jo){jo.innerText=k1,jo.addEventListener("click",hM);const i=document.createElement("style"),n=40;i.innerHTML=`
                #__vconsole .vc-switch {
                    border: 1px solid rgba(255, 255, 255, .1);
                    border-radius: 50%;
                    width: ${n}px;
                    height: ${n}px;
                    padding: 0;
                    line-height: ${n}px;
                    font-size: ${n*.4}px;
                    text-align: center;
                    background: #ffffff5c;
                    backdrop-filter: blur(16px);
                    -webkit-backdrop-filter: blur(16px);
                    user-select: none;
                    pointer-events: auto;
                    transition: transform .2s ease-in-out;
                    box-shadow: 0px 7px 0.5rem 0px rgb(0 0 0 / 6%), inset 0px 0px 1.3rem rgba(0,0,0,.05);

                    font-family: 'Material Symbols Outlined';
                    color: black;
                    font-size: 2.3em;
                    font-weight: 100;
                }
                #__vconsole .vc-switch:hover {
                    cursor: pointer;
                    transform: scale(1.1);
                    transition: transform .1s ease-in-out, background .1s linear;
                    background: rgba(245, 245, 245, .8);
                    outline: rgba(0, 0, 0, .05) 1px solid;
                }
                #__vconsole .vc-switch[error] {
                    background: rgba(255,0,0,.2);
                    animation: vconsole-notify 1s ease-in-out;
                    line-height: 35px;
                }
                @keyframes vconsole-notify {
                    from {
                        transform: scale(1, 1);
                    }
                    10% {
                        transform: scale(1.3, 1.3);
                    }
                    70% {
                        transform: scale(1.4, 1.4);
                    }
                    to {
                        transform: scale(1, 1);
                    }
                }
                #__vconsole .vc-panel {
                    font-family: monospace;
                    font-size: 11px;
                }
                #__vconsole .vc-plugin-box.vc-actived {
                    height: 100%;
                }
                #__vconsole .vc-mask {
                    overflow: hidden;
                }
            `,pr==null||pr.prepend(i),s===!0&&y1()<=0&&rM(),console.log("üåµ Debug console has loaded")}},t.onerror=()=>{console.warn("üåµ Debug console failed to load."+(window.crossOriginIsolated?"This page is using cross-origin isolation, so external scripts can't be loaded.":"")),Nd=!1,Xi=null},t.src="https://cdn.jsdelivr.net/npm/vconsole@3.15.1/dist/vconsole.min.js",document.body.appendChild(t)}function uM(){if(!globalThis.VConsole)return;const s=new VConsole.VConsolePlugin("needle-console","üåµ Inspect glTF"),t=()=>document.querySelector("#__vc_plug_"+s._id+" iframe");return s.on("renderTab",function(e){const i=globalThis["needle:codegen_files"];if(!i||i.length===0)return;let n=globalThis["needle:codegen_files"][0];const o=n.indexOf("?");o>-1&&(n=n.substring(0,o));const l=location.protocol+"//"+location.host+location.pathname+"/"+n,c=encodeURIComponent(l);s.fullUrl="https://viewer.needle.tools?inspect&file="+c;var h='<iframe src="" style="width: 100%; height: 99%; border: none;"></iframe>';e(h)}),s.on("show",function(){const e=t();e&&e.src!==s.fullUrl&&(e.src=s.fullUrl)}),s.on("hide",function(){const e=t();e&&(e.src="")}),s.on("addTopBar",function(e){var i=new Array;i.push({name:"Open in new window ‚Üó",onClick:function(n){window.open(s.fullUrl,"_blank"),Xi==null||Xi.hide()}}),i.push({name:"Reload",onClick:function(n){const o=t();o&&(o.src=s.fullUrl)}}),i.push({name:"Fullscreen",onClick:function(n){const o=t();o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen instanceof Function&&o.webkitRequestFullscreen()}}),e(i)}),s}const g_="padding: 10px; font-family: monospace;",ow="margin-bottom: 10px;",wl="margin-bottom: 10px; margin-top: 15px;",fM="width: 100%; border-collapse: collapse; border: 1px solid rgba(0,0,0,0.1); table-layout: fixed;",M1="border: 1px solid rgba(0,0,0,0.1); padding: 5px;",pM=M1,mM=M1+" word-break: break-all;";function Ro(s,t=!1){t&&s.sort((i,n)=>(n.value?1:0)-(i.value?1:0));let e=`<table style='${fM}'>`;e+="<tbody>";for(const i of s){const n=typeof i.value=="boolean"?i.value?"‚úÖ":"‚ùå":i.value;e+=`<tr><td style='${pM}'>${i.label}</td><td style='${mM}'>${n}</td></tr>`}return e+="</tbody></table>",e}function A1(){try{if(document.createElement("canvas").getContext("webgl2"))return"‚úÖ"}catch{}return"‚ùå"}function gM(){if(!globalThis.VConsole)return;const s=new VConsole.VConsolePlugin("device-utilities","üì± Device Info");return s.on("renderTab",function(t){let e=`<div style='${g_}'>`;const i=TM();e+=`<h3 style='${ow}'>Device: ${i}</h3>`,e+=Ro([{label:"üíª Desktop",value:Q.isDesktop()},{label:"üì± Mobile Device",value:Q.isMobileDevice()},{label:"üçé iOS",value:Q.isiOS()},{label:"üì± iPad",value:Q.isiPad()},{label:"ü§ñ Android",value:Q.isAndroidDevice()},{label:"ü¶ä Mozilla XR",value:Q.isMozillaXR()},{label:"üåµ Needle App Clip",value:Q.isNeedleAppClip()},{label:"üçè macOS",value:Q.isMacOS()},{label:"üëì VisionOS",value:Q.isVisionOS()},{label:"üß≠ Safari",value:Q.isSafari()},{label:"üï∂Ô∏è Meta Quest",value:Q.isQuest()},{label:"üîó QuickLook AR Support",value:Q.supportsQuickLookAR()}],!0);const n=[],o=Q.getiOSVersion();o&&n.push({label:"üçé iOS Version",value:o});const r=Q.getChromeVersion();r&&n.push({label:"üåê Chrome Version",value:r});const l=Q.getSafariVersion();l&&n.push({label:"üß≠ Safari Version",value:l}),n.length>0&&(e+=Ro(n,!1)),e+="</div>",e+=`<div style='${g_} margin-top: 20px;'>`,e+=`<h3 style='${ow}'>User Agent Info</h3>`;const c=[{label:"User Agent",value:navigator.userAgent},{label:"Platform",value:navigator.platform},{label:"App Version",value:navigator.appVersion},{label:"User Agent Data",value:navigator.userAgentData?`Platform: ${navigator.userAgentData.platform}, Mobile: ${navigator.userAgentData.mobile}`:"Not supported"},{label:"WebXR",value:"xr"in navigator?"‚úÖ":"‚ùå"},{label:"WebGPU",value:"gpu"in navigator?"‚úÖ":"‚ùå"},{label:"WebGL 2",value:A1()}];e+=Ro(c,!1),e+="</div>",t(e)}),s}function yM(){if(!globalThis.VConsole)return;const s=new VConsole.VConsolePlugin("graphics-info","üé® Graphics Info");return s.on("renderTab",async function(t){let e=`<div style='${g_}'>`;const i=bM();i.length>0&&(e+=`<h3 style='${wl}'>General GPU Info</h3>`,e+=Ro(i,!1));const n=vM();n.length>0&&(e+=`<h3 style='${wl}'>WebGL</h3>`,e+=Ro(n,!1));const o=xM();o.length>0&&(e+=`<h3 style='${wl}'>WebGL 2 Features</h3>`,e+=Ro(o,!1));const r=wM();r.length>0&&(e+=`<h3 style='${wl}'>WebGL Limits</h3>`,e+=Ro(r,!1));const l=SM();l.length>0&&(e+=`<h3 style='${wl}'>Texture Formats</h3>`,e+=Ro(l,!1));const c=await CM();if(c.length>0&&(e+=`<h3 style='${wl}'>WebGPU</h3>`,e+=Ro(c,!1)),Q.isSafari()){const h=PM();h.length>0&&(e+=`<h3 style='${wl}'>Safari GPU Info</h3>`,e+=Ro(h,!1))}e+="</div>",t(e)}),s}function bM(){const s=[],t=window.devicePixelRatio;s.push({label:"Device Pixel Ratio",value:t.toString()}),s.push({label:"Width (px)",value:(window.innerWidth*t).toString()}),s.push({label:"Height (px)",value:(window.innerHeight*t).toString()});const i=Q.isMobileDevice()?150:96,n=screen.width/i,o=screen.height/i,r=n*2.54,l=o*2.54;s.push({label:"Estimated Width (cm)",value:r.toFixed(1)}),s.push({label:"Estimated Height (cm)",value:l.toFixed(1)});const c=I1();if(c){s.push({label:"GPU",value:c.renderer}),s.push({label:"Driver",value:c.vendor}),s.push({label:"ANGLE",value:c.angle||"Not detected"});const h=_M(c.renderer);h&&(h.manufacturer&&s.push({label:"Manufacturer",value:h.manufacturer}),h.cardVersion&&s.push({label:"Card Version",value:h.cardVersion}),h.brand&&s.push({label:"Brand",value:h.brand}),s.push({label:"Integrated",value:h.integrated?"Yes":"No"}),h.layer&&s.push({label:"WebGL Layer",value:h.layer}))}return s}function _M(s){if(!s)return null;const t=(h,d)=>{const u=d.match(h);return u&&u[0]},e=t(/(ANGLE)/g,s)||void 0,i=t(/((NVIDIA|AMD|Intel)[^\d]*[^\s]+)/,s)||s,n=i.split(" ");n.shift();const o=t(/(NVIDIA|AMD|Intel)/g,i)||void 0,r=n.length>0?n.pop():void 0,l=n.length>0?n.join(" "):void 0;return{manufacturer:o,cardVersion:r,brand:l,integrated:o==="Intel",layer:e,card:i}}function vM(){const s=[],t=I1();return t&&(s.push({label:"üìä WebGL Version",value:t.version}),s.push({label:"üéÆ WebGL 2 Available",value:A1()})),s}function xM(){const s=[];try{const e=document.createElement("canvas").getContext("webgl2");if(!e)return s;s.push({label:"Float Color Buffer",value:e.getExtension("EXT_color_buffer_float")?"‚úÖ":"‚ùå"}),s.push({label:"Anisotropic Filtering",value:e.getExtension("EXT_texture_filter_anisotropic")?"‚úÖ":"‚ùå"}),s.push({label:"Float Texture Linear",value:e.getExtension("OES_texture_float_linear")?"‚úÖ":"‚ùå"}),s.push({label:"S3TC Compression",value:e.getExtension("WEBGL_compressed_texture_s3tc")?"‚úÖ":"‚ùå"}),s.push({label:"ETC Compression",value:e.getExtension("WEBGL_compressed_texture_etc")?"‚úÖ":"‚ùå"}),s.push({label:"PVRTC Compression",value:e.getExtension("WEBGL_compressed_texture_pvrtc")?"‚úÖ":"‚ùå"}),s.push({label:"ASTC Compression",value:e.getExtension("WEBGL_compressed_texture_astc")?"‚úÖ":"‚ùå"})}catch{}return s}function wM(){const s=[];try{const t=document.createElement("canvas"),e=t.getContext("webgl2")||t.getContext("webgl");if(!e)return s;const i=e instanceof WebGL2RenderingContext;s.push({label:"üìè Max Texture Size",value:e.getParameter(e.MAX_TEXTURE_SIZE).toString()}),s.push({label:"üé® Max Renderbuffer Size",value:e.getParameter(e.MAX_RENDERBUFFER_SIZE).toString()}),s.push({label:"üîó Max Vertex Attribs",value:e.getParameter(e.MAX_VERTEX_ATTRIBS).toString()}),s.push({label:"üéØ Max Texture Units",value:e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS).toString()}),i&&(s.push({label:"‚ö° Max Samples",value:e.getParameter(e.MAX_SAMPLES).toString()}),s.push({label:"üîÑ Max Uniform Buffer Bindings",value:e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS).toString()}),s.push({label:"üìê Max 3D Texture Size",value:e.getParameter(e.MAX_3D_TEXTURE_SIZE).toString()}))}catch{}return s}function SM(){const s=[];try{document.createElement("canvas").getContext("webgl")&&(s.push({label:"WebGL 1 RGBA",value:"‚úÖ"}),s.push({label:"WebGL 1 RGB",value:"‚úÖ"}));const n=document.createElement("canvas").getContext("webgl2");n&&(s.push({label:"WebGL 2 RGBA32F",value:n.getExtension("EXT_color_buffer_float")?"‚úÖ":"‚ùå"}),s.push({label:"WebGL 2 RGB32F",value:n.getExtension("EXT_color_buffer_float")?"‚úÖ":"‚ùå"}),s.push({label:"WebGL 2 R11F_G11F_B10F",value:"‚úÖ"}),s.push({label:"WebGL 2 RGB565",value:"‚úÖ"}),s.push({label:"WebGL 2 RGB5_A1",value:"‚úÖ"}),s.push({label:"WebGL 2 RGBA4444",value:"‚úÖ"}))}catch{}return s}async function CM(){const s=[];if(!("gpu"in navigator))return s.push({label:"üöÄ WebGPU Support",value:"‚ùå Not supported"}),s;s.push({label:"üöÄ WebGPU Support",value:"‚úÖ Supported"});try{const t=await navigator.gpu.requestAdapter();if(!t)return s.push({label:"üéØ Adapter",value:"No adapter available"}),s;s.push({label:"üéØ Adapter",value:t.name||"Unknown Adapter"});const e=await t.requestDevice();s.push({label:"üîß Device",value:e.label||"WebGPU Device"}),s.push({label:"üìè Max Texture 2D",value:e.limits.maxTextureDimension2D.toString()}),s.push({label:"üìê Max Texture 3D",value:e.limits.maxTextureDimension3D.toString()}),s.push({label:"üìä Max Texture Array Layers",value:e.limits.maxTextureArrayLayers.toString()}),s.push({label:"üíæ Max Buffer Size",value:`${(e.limits.maxBufferSize/1024/1024).toFixed(1)}MB`}),s.push({label:"üîó Max Bind Groups",value:e.limits.maxBindGroups.toString()})}catch(t){s.push({label:"‚ùå Error",value:t.message})}return s}function I1(){try{const s=document.createElement("canvas"),t=s.getContext("webgl2")||s.getContext("webgl");if(!t)return null;const e=t.getExtension("WEBGL_debug_renderer_info"),i=e?t.getParameter(e.UNMASKED_RENDERER_WEBGL):t.getParameter(t.RENDERER),n=e?t.getParameter(e.UNMASKED_VENDOR_WEBGL):t.getParameter(t.VENDOR),o=t.getParameter(t.VERSION);let r;if(i&&i.includes("ANGLE")){const l=i.match(/ANGLE \(([^)]+)\)/);l&&(r=l[1])}return{renderer:i,vendor:n,version:o,angle:r}}catch{return null}}function PM(){const s=[];try{const e=document.createElement("canvas").getContext("webgl");if(e){const i=e.getExtension("WEBGL_debug_renderer_info");if(i){const n=e.getParameter(i.UNMASKED_RENDERER_WEBGL);n&&n.includes("Apple")&&s.push({label:"üçé Apple GPU",value:n})}}}catch{}try{const e=document.createElement("canvas").getContext("webgl");e&&(e.getSupportedExtensions()||[]).includes("WEBGL_compressed_texture_pvrtc")&&s.push({label:"üóúÔ∏è PVRTC Support",value:"‚úÖ"})}catch{}return s}function TM(){return Q.isQuest()?"Meta Quest":Q.isVisionOS()?"Vision Pro":Q.isiOS()?Q.isiPad()?"iPad":"iPhone/iPod":Q.isAndroidDevice()?"Android Device":Q.isMozillaXR()?"Mozilla XR Browser":Q.isNeedleAppClip()?"Needle App Clip":Q.isMacOS()?"Mac":Q.isDesktop()?"Desktop PC":"Unknown Device"}function RM(){const s=document.querySelector("#__vconsole .vc-switch");return s||null}function OM(){const s=document.querySelector("#__vconsole");return s||null}const L1=k("debugdefines");Xa('if(!globalThis[""4.12.4""]) globalThis[""4.12.4""] = "0.0.0";');Xa('if(!globalThis[""Unity 6000.3.5f2, Needle Engine Integration @4.12.4""]) globalThis[""Unity 6000.3.5f2, Needle Engine Integration @4.12.4""] = "unknown";');Xa('if(!globalThis[""Sat Feb 07 2026 22:10:44 GMT-0330 (Newfoundland Standard Time)""]) globalThis[""Sat Feb 07 2026 22:10:44 GMT-0330 (Newfoundland Standard Time)""] = "unknown";');Xa('if(!globalThis[""npk_65581bc2314f0817385db9a1d6364c39e4f75ccb7949edcb741c3dd45a05b961""]) globalThis[""npk_65581bc2314f0817385db9a1d6364c39e4f75ccb7949edcb741c3dd45a05b961""] = "unknown";');Xa('globalThis["__NEEDLE_ENGINE_VERSION__"] = "4.12.4";');Xa('globalThis["__NEEDLE_ENGINE_GENERATOR__"] = "Unity 6000.3.5f2, Needle Engine Integration @4.12.4";');Xa('globalThis["__NEEDLE_PROJECT_BUILD_TIME__"] = "Sat Feb 07 2026 22:10:44 GMT-0330 (Newfoundland Standard Time)";');Xa('globalThis["__NEEDLE_PUBLIC_KEY__"] = "npk_65581bc2314f0817385db9a1d6364c39e4f75ccb7949edcb741c3dd45a05b961";');const Gn="4.12.4",cf="Unity 6000.3.5f2, Needle Engine Integration @4.12.4",Sm="Sat Feb 07 2026 22:10:44 GMT-0330 (Newfoundland Standard Time)";L1&&console.log(`Engine version: ${Gn} (generator: ${cf})
Project built at ${Sm}`);const Eh="npk_65581bc2314f0817385db9a1d6364c39e4f75ccb7949edcb741c3dd45a05b961",Da="needle_isActiveInHierarchy",ih="builtin_components",Kp="needle_editor_guid";function Xa(s){try{(0,eval)(s)}catch(t){L1&&console.error(t)}}let D1,rw=null;function Ko(){return D1}function j1(s){if(s==null){console.warn("Oh no: someone tried registering a non-existend gltf-loader. When you see this log it might mean that needle-engine is being imported multiple times. Please check your project setup.");return}rw!==s&&(rw=s,D1=new s)}function kM(s,t){if(typeof window!==void 0&&window.SPECTOR){console.log(window.SPECTOR);const e=new URLSearchParams(window.location.search);if(e.has("spector")){let o=function(){if(i>s.time.frame)return window.requestAnimationFrame(()=>o());const r=n.captureCanvas(t);r&&r instanceof Promise?r.then(()=>n.displayUI()):n.displayUI()};const i=Number.parseInt(e.get("spector")||"0")||0;console.log("Scheduled Spector capture at frame #"+i);const n=new window.SPECTOR.Spector;n.spyCanvases=!0,o();return}else X()&&console.debug("Spector available: Add '?spector=<frame>' to the URL to enable it and capture a frame.")}}const zn=Symbol("shadowDomOwner"),EM=k("debugpatch");function $0(s,t,e,i){const n=EM===t;if(!e&&!i)return;const o=t+"___needle";MM(s,t,e,i);const r=Object.getOwnPropertyDescriptor(s,t),l=s[t];n&&console.log("Patch",s.constructor.name,t,r,l),r?(n&&console.log("Apply patch with existing descriptor",s.constructor.name,t,r),typeof r.value=="function"&&(s[t]=lw(r.value,s,t))):(n&&console.log("Create patch with new property",s.constructor.name,t,r),Object.defineProperty(s,t,{set:function(c){if(typeof c=="function")this[o]=lw(c,s,t);else{const h=this[o];F1(s,t,this,h,c),this[o]=c,B1(s,t,this,h,c)}},get:function(){const c=this[o];return typeof c=="function"&&c[o]?c[o]:c}}))}function p4(s,t,e){const i=V0(s,t);if(i)for(let n=i.length-1;n>=0;n--){const o=i[n];o.prefix===e&&(o.prefix=null),o.postfix===e&&(o.postfix=null),!o.prefix&&!o.postfix&&i.splice(n,1)}}const aw=Symbol("Needle:Patches:WrappedFunction");function lw(s,t,e){if(s[aw])return s;const i=function(...n){F1(t,e,this,...n);const o=s.apply(this,n);return B1(t,e,this,o,...n),o};return i[aw]=!0,i}const Yy="Needle:Patches";function y_(){return globalThis[Yy]||(globalThis[Yy]=new WeakMap),globalThis[Yy]}function V0(s,t){const e=y_().get(s);return e?e.get(t):null}function MM(s,t,e,i){let n=y_().get(s);n||(n=new Map,y_().set(s,n));let o=n.get(t);o||(o=[],n.set(t,o)),o.push({prefix:e,postfix:i})}function F1(s,t,e,...i){var o;if(!e)return;const n=V0(s,t);if(n)for(const r of n)(o=r.prefix)==null||o.call(e,...i)}function B1(s,t,e,i,...n){var r;if(!e)return;const o=V0(s,t);if(o)for(const l of o)(r=l.postfix)==null||r.call(e,i,...n)}const Yh=[];function W0(s){Yh.indexOf(s)===-1&&Yh.push(s)}function m4(s){const t=Yh.indexOf(s);t!==-1&&Yh.splice(t,1)}const Kh=[];function U1(s){Kh.indexOf(s)===-1&&Kh.push(s)}function g4(s){const t=Kh.indexOf(s);t!==-1&&Kh.splice(t,1)}function AM(s){globalThis.dispatchEvent(new CustomEvent("needle-xrsession-start",{detail:s}));for(let t=0;t<Yh.length;t++)Yh[t](s)}function IM(s){globalThis.dispatchEvent(new CustomEvent("needle-xrsession-end",{detail:s}));for(let t=0;t<Kh.length;t++)Kh[t](s)}const ei={Handedness:Object.freeze({NONE:"none",LEFT:"left",RIGHT:"right"}),ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};async function N1(s){const t=await fetch(s);if(t.ok)return t.json();throw new Error(t.statusText)}async function LM(s){if(!s)throw new Error("No basePath supplied");return await N1(`${s}/profilesList.json`)}async function DM(s,t,e=null,i=!0){if(!s)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No basePath supplied");const n=await LM(t);let o;if(s.profiles.some(c=>{const h=n[c];return h&&(o={profileId:c,profilePath:`${t}/${h.path}`,deprecated:!!h.deprecated}),!!o}),!o){if(!e)throw new Error("No matching profile name found");const c=n[e];if(!c)throw new Error(`No matching profile name found and default profile "${e}" missing.`);o={profileId:e,profilePath:`${t}/${c.path}`,deprecated:!!c.deprecated}}const r=await N1(o.profilePath);let l;if(i){let c;if(s.handedness==="any"?c=r.layouts[Object.keys(r.layouts)[0]]:c=r.layouts[s.handedness],!c)throw new Error(`No matching handedness, ${s.handedness}, in profile ${o.profileId}`);c.assetPath&&(l=o.profilePath.replace("profile.json",c.assetPath))}return{profile:r,assetPath:l}}const jM={xAxis:0,yAxis:0,button:0,state:ei.ComponentState.DEFAULT};function FM(s=0,t=0){let e=s,i=t;if(Math.sqrt(s*s+t*t)>1){const r=Math.atan2(t,s);e=Math.cos(r),i=Math.sin(r)}return{normalizedXAxis:e*.5+.5,normalizedYAxis:i*.5+.5}}class BM{constructor(t){this.componentProperty=t.componentProperty,this.states=t.states,this.valueNodeName=t.valueNodeName,this.valueNodeProperty=t.valueNodeProperty,this.valueNodeProperty===ei.VisualResponseProperty.TRANSFORM&&(this.minNodeName=t.minNodeName,this.maxNodeName=t.maxNodeName),this.value=0,this.updateFromComponent(jM)}updateFromComponent({xAxis:t,yAxis:e,button:i,state:n}){const{normalizedXAxis:o,normalizedYAxis:r}=FM(t,e);switch(this.componentProperty){case ei.ComponentProperty.X_AXIS:this.value=this.states.includes(n)?o:.5;break;case ei.ComponentProperty.Y_AXIS:this.value=this.states.includes(n)?r:.5;break;case ei.ComponentProperty.BUTTON:this.value=this.states.includes(n)?i:0;break;case ei.ComponentProperty.STATE:this.valueNodeProperty===ei.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(n):this.value=this.states.includes(n)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}let UM=class{constructor(t,e){if(!t||!e||!e.visualResponses||!e.gamepadIndices||Object.keys(e.gamepadIndices).length===0)throw new Error("Invalid arguments supplied");this.id=t,this.type=e.type,this.rootNodeName=e.rootNodeName,this.touchPointNodeName=e.touchPointNodeName,this.visualResponses={},Object.keys(e.visualResponses).forEach(i=>{const n=new BM(e.visualResponses[i]);this.visualResponses[i]=n}),this.gamepadIndices=Object.assign({},e.gamepadIndices),this.values={state:ei.ComponentState.DEFAULT,button:this.gamepadIndices.button!==void 0?0:void 0,xAxis:this.gamepadIndices.xAxis!==void 0?0:void 0,yAxis:this.gamepadIndices.yAxis!==void 0?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(t){if(this.values.state=ei.ComponentState.DEFAULT,this.gamepadIndices.button!==void 0&&t.buttons.length>this.gamepadIndices.button){const e=t.buttons[this.gamepadIndices.button];this.values.button=e.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,e.pressed||this.values.button===1?this.values.state=ei.ComponentState.PRESSED:(e.touched||this.values.button>ei.ButtonTouchThreshold)&&(this.values.state=ei.ComponentState.TOUCHED)}this.gamepadIndices.xAxis!==void 0&&t.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=t.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===ei.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>ei.AxisTouchThreshold&&(this.values.state=ei.ComponentState.TOUCHED)),this.gamepadIndices.yAxis!==void 0&&t.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=t.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===ei.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>ei.AxisTouchThreshold&&(this.values.state=ei.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach(e=>{e.updateFromComponent(this.values)})}};class NM{constructor(t,e,i){if(!t)throw new Error("No xrInputSource supplied");if(!e)throw new Error("No profile supplied");this.xrInputSource=t,this.assetUrl=i,this.id=e.profileId,this.layoutDescription=e.layouts[t.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach(n=>{const o=this.layoutDescription.components[n];this.components[n]=new UM(n,o)}),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const t=[];return Object.values(this.components).forEach(e=>{t.push(e.data)}),t}updateFromGamepad(){Object.values(this.components).forEach(t=>{t.updateFromGamepad(this.xrInputSource.gamepad)})}}const Et=k("debuginput");var Ea;(function(s){s.Mouse="mouse",s.Touch="touch",s.Controller="controller",s.Hand="hand"})(Ea||(Ea={}));var cw;(function(s){s.PointerDown="pointerdown",s.PointerUp="pointerup",s.PointerMove="pointermove"})(cw||(cw={}));var hw;(function(s){s.KeyDown="keydown",s.KeyUp="keyup",s.KeyPressed="keypress"})(hw||(hw={}));var Le;(function(s){s.PointerDown="pointerdown",s.PointerUp="pointerup",s.PointerMove="pointermove",s.KeyDown="keydown",s.KeyUp="keyup",s.KeyPressed="keypress"})(Le||(Le={}));class ga extends PointerEvent{constructor(e,i,n){super(e,n);a(this,"clientZ");a(this,"deviceIndex");a(this,"origin");a(this,"source");a(this,"mode");a(this,"_ray");a(this,"space");a(this,"isClick",!1);a(this,"isDoubleClick",!1);a(this,"_used",!1);a(this,"_pointerid");a(this,"_pointerType");a(this,"buttonName");a(this,"_type");a(this,"metadata",{});a(this,"intersections",new Array);a(this,"_immediatePropagationStopped",!1);a(this,"_propagationStopped",!1);this.clientZ=n.clientZ,this._pointerid=n.pointerId,this._pointerType=n.pointerType,this._type=e,this.deviceIndex=n.deviceIndex,this.origin=n.origin,this.source=i,this.mode=n.mode,this._ray=n.ray,this.space=n.device,this.buttonName=n.buttonName}get isSpatial(){return this.mode!="screen"}get ray(){return this._ray||(this._ray=new zr(this.space.worldPosition.clone(),this.space.worldForward.clone())),this._ray}set ray(e){this._ray=e}get hasRay(){return this._ray!==void 0}get used(){return this._used}use(){this._used=!0}get pointerId(){return this._pointerid}get pointerType(){return this._pointerType}get type(){return this._type}get immediatePropagationStopped(){return this._immediatePropagationStopped}get propagationStopped(){return this._immediatePropagationStopped||this._propagationStopped}stopImmediatePropagation(){var e;this._immediatePropagationStopped=!0,super.stopImmediatePropagation(),(e=this.source)==null||e.stopImmediatePropagation()}stopPropagation(){var e;this._propagationStopped=!0,super.stopPropagation(),(e=this.source)==null||e.stopPropagation(),Et&&console.warn("Stop propagation...",this.pointerId,this.pointerType)}}class hp extends KeyboardEvent{constructor(e,i,n){super(e,n);a(this,"source");this.source=i}stopImmediatePropagation(){var e;super.stopImmediatePropagation(),(e=this.source)==null||e.stopImmediatePropagation()}}class b4{constructor(t){a(this,"key");a(this,"keyType");a(this,"source");this.key=t.key,this.keyType=t.type,this.source=t}}var Pn;(function(s){s[s.Early=-100]="Early",s[s.Default=0]="Default",s[s.Late=100]="Late"})(Pn||(Pn={}));class zM{constructor(t){a(this,"_eventListeners",{});a(this,"_doubleClickTimeThreshold",.2);a(this,"_longPressTimeThreshold",1);a(this,"_setCursorTypes",[]);a(this,"context");a(this,"_pointerDown",[!1]);a(this,"_pointerUp",[!1]);a(this,"_pointerClick",[!1]);a(this,"_pointerDoubleClick",[!1]);a(this,"_pointerPressed",[!1]);a(this,"_pointerPositions",[new _e]);a(this,"_pointerPositionsLastFrame",[new _e]);a(this,"_pointerPositionsDelta",[new _e]);a(this,"_pointerPositionsRC",[new _e]);a(this,"_pointerPositionDown",[new R]);a(this,"_pointerDownTime",[]);a(this,"_pointerUpTime",[]);a(this,"_pointerUpTimestamp",[]);a(this,"_pointerIds",[]);a(this,"_pointerTypes",[""]);a(this,"_mouseWheelChanged",[!1]);a(this,"_mouseWheelDeltaY",[0]);a(this,"_pointerEvent",[]);a(this,"_pointerEventsPressed",[]);a(this,"_pointerSpace",[]);a(this,"_pressedStack",new Map);a(this,"_htmlEventSource");a(this,"onLostFocus",()=>{for(const t in this.keysPressed)this.keysPressed[t].pressed=!1});a(this,"_receivedPointerMoveEventsThisFrame",new Array);a(this,"onEndOfFrame",()=>{this._receivedPointerMoveEventsThisFrame.length=0;for(let t=0;t<this._pointerUp.length;t++)this._pointerUp[t]=!1;for(let t=0;t<this._pointerDown.length;t++)this._pointerDown[t]=!1;for(let t=0;t<this._pointerClick.length;t++)this._pointerClick[t]=!1;for(let t=0;t<this._pointerDoubleClick.length;t++)this._pointerDoubleClick[t]=!1;for(const t of this._pointerPositionsDelta)t.set(0,0);for(let t=0;t<this._mouseWheelChanged.length;t++)this._mouseWheelChanged[t]=!1;for(let t=0;t<this._mouseWheelDeltaY.length;t++)this._mouseWheelDeltaY[t]=0});a(this,"onContextMenu",t=>{this.canReceiveInput(t)});a(this,"keysPressed",{});a(this,"onKeyDown",t=>{if(Et&&console.log(`key down ${t.code}, ${this.context.application.hasFocus}`,t),!this.context.application.hasFocus)return;const e=this.keysPressed[t.code];if(e&&e.pressed)return;this.keysPressed[t.code]={pressed:!0,frame:this.context.time.frameCount+1,startFrame:this.context.time.frameCount+1,key:t.key,code:t.code};const i=new hp(Le.KeyDown,t,t);this.onDispatchEvent(i)});a(this,"onKeyPressed",t=>{if(!this.context.application.hasFocus)return;const e=this.keysPressed[t.code];if(!e)return;e.pressed=!0,e.frame=this.context.time.frameCount+1;const i=new hp(Le.KeyPressed,t,t);this.onDispatchEvent(i)});a(this,"onKeyUp",t=>{if(!this.context.application.hasFocus)return;const e=this.keysPressed[t.code];if(!e)return;e.pressed=!1,e.frame=this.context.time.frameCount+1;const i=new hp(Le.KeyUp,t,t);this.onDispatchEvent(i)});a(this,"onWheelWindow",t=>{document.pointerLockElement&&this.onMouseWheel(t)});a(this,"onMouseWheel",t=>{if(this.canReceiveInput(t)===!1)return;this._mouseWheelDeltaY.length<=0&&this._mouseWheelDeltaY.push(0),this._mouseWheelChanged.length<=0&&this._mouseWheelChanged.push(!1),this._mouseWheelChanged[0]=!0;const e=this._mouseWheelDeltaY[0];this._mouseWheelDeltaY[0]=e+t.deltaY});a(this,"onPointerDown",t=>{if(this.context.isInAR||this.canReceiveInput(t)===!1)return;t.target instanceof HTMLElement&&t.target.setPointerCapture(t.pointerId);const e=this.getPointerId(t);Et&&at(`pointer down #${e}, identifier:${t.pointerId}`);const i=this.getAndUpdateSpatialObjectForScreenPosition(e,t.clientX,t.clientY),n=new ga(Le.PointerDown,t,{origin:this,mode:"screen",deviceIndex:0,pointerId:e,button:t.button,clientX:t.clientX,clientY:t.clientY,pointerType:t.pointerType,buttonName:this.getButtonName(t),device:i,pressure:t.pressure});this.onDown(n)});a(this,"onPointerMove",t=>{if(this.context.isInAR||this._receivedPointerMoveEventsThisFrame.includes(t.pointerId))return;this._receivedPointerMoveEventsThisFrame.push(t.pointerId);let e=t.button;t.pointerType==="mouse"&&(e=this.getFirstPressedButtonForPointer(0)??0);const i=this.getPointerId(t,e);e===-1&&(e=i);const n=this.getAndUpdateSpatialObjectForScreenPosition(i,t.clientX,t.clientY),o=new ga(Le.PointerMove,t,{origin:this,mode:"screen",deviceIndex:0,pointerId:i,button:e,clientX:t.clientX,clientY:t.clientY,pointerType:t.pointerType,buttonName:this.getButtonName(t),device:n,pressure:t.pressure});this.onMove(o)});a(this,"onPointerCancel",t=>{this.context.isInAR||(Et&&console.log("Pointer cancel",t),this.onPointerUp(t))});a(this,"onPointerUp",t=>{if(this.context.isInAR)return;t.target instanceof HTMLElement&&t.target.releasePointerCapture(t.pointerId);const e=this.getPointerId(t),i=new ga(Le.PointerUp,t,{origin:this,mode:"screen",deviceIndex:0,pointerId:e,button:t.button,clientX:t.clientX,clientY:t.clientY,pointerType:t.pointerType,buttonName:this.getButtonName(t),device:this.getAndUpdateSpatialObjectForScreenPosition(e,t.clientX,t.clientY),pressure:t.pressure});this.onUp(i),this._pointerIds[e]=-1,Et&&console.log("ID="+e,"PointerId="+t.pointerId,"ALL:",[...this._pointerIds])});a(this,"onTouchStart",t=>{if(this.context.isInAR)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],n=this.getPointerIndex(i.identifier),o=this.getAndUpdateSpatialObjectForScreenPosition(n,i.clientX,i.clientY),r=new ga(Le.PointerDown,t,{origin:this,mode:"screen",deviceIndex:0,pointerId:n,button:0,clientX:i.clientX,clientY:i.clientY,pointerType:"touch",buttonName:"unknown",device:o,pressure:i.force});this.onDown(r)}});a(this,"onTouchMove",t=>{if(this.context.isInAR)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],n=this.getPointerIndex(i.identifier),o=this.getAndUpdateSpatialObjectForScreenPosition(n,i.clientX,i.clientY),r=new ga(Le.PointerMove,t,{origin:this,mode:"screen",deviceIndex:0,pointerId:n,button:0,clientX:i.clientX,clientY:i.clientY,pointerType:"touch",buttonName:"unknown",device:o,pressure:i.force});this.onMove(r)}});a(this,"onTouchEnd",t=>{if(this.context.isInAR)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],n=this.getPointerIndex(i.identifier),o=new ga(Le.PointerUp,t,{origin:this,mode:"screen",deviceIndex:0,pointerId:n,button:0,clientX:i.clientX,clientY:i.clientY,pointerType:"touch",buttonName:"unknown",device:this.getAndUpdateSpatialObjectForScreenPosition(n,i.clientX,i.clientY),pressure:i.force});this.onUp(o),this._pointerIds[n]=-1}});a(this,"tempNearPlaneVector",new R);a(this,"tempFarPlaneVector",new R);a(this,"tempLookMatrix",new xe);this.context=t,this.context.post_render_callbacks.push(this.onEndOfFrame)}addEventListener(t,e,i){if(this._eventListeners[t]||(this._eventListeners[t]=[]),!e||typeof e!="function"){console.error("Invalid call to addEventListener: callback is required and must be a function!");return}i?i={...i}:i={};let n=0;(i==null?void 0:i.queue)!=null&&(n=i.queue);const o=this._eventListeners[t],r=o.find(l=>l.priority===n);r?r.listeners.push({callback:e,options:i}):(o.push({priority:n,listeners:[{callback:e,options:i}]}),o.sort((l,c)=>l.priority-c.priority))}removeEventListener(t,e,i){if(!this._eventListeners[t]||!e)return;const n=this._eventListeners[t];if((i==null?void 0:i.queue)!=null){const o=n.find(l=>l.priority===i.queue);if(!o)return;const r=o.listeners.findIndex(l=>l.callback===e);r>=0&&o.listeners.splice(r,1)}else for(const o of n){const r=o.listeners.findIndex(l=>l.callback===e);r>=0&&o.listeners.splice(r,1)}}dispatchEvent(t){var i,n,o,r;let e=!1;if(t instanceof hp){const l=this._eventListeners[t.type];if(l)for(const c of l)for(let h=0;h<c.listeners.length;h++){const d=c.listeners[h];if((n=(i=d.options)==null?void 0:i.signal)!=null&&n.aborted){c.listeners.splice(h,1),h--;continue}d.options.once&&(c.listeners.splice(h,1),h--),d.callback(t)}}if(t instanceof ga){const l=this._eventListeners[t.type];if(l)for(const c of l){if(e)break;for(let h=0;h<c.listeners.length;h++){const d=c.listeners[h];if((r=(o=d.options)==null?void 0:o.signal)!=null&&r.aborted){c.listeners.splice(h,1),h--;continue}if(t.immediatePropagationStopped){e=!0,Et&&console.log("immediatePropagationStopped",t.type);break}else t.propagationStopped&&(e=!0,Et&&console.log("propagationStopped",t.type));d.options.once&&(c.listeners.splice(h,1),h--),d.callback(t)}}}}get mousePosition(){return this._pointerPositions[0]}get mousePositionRC(){return this._pointerPositionsRC[0]}get mouseDown(){return this._pointerDown[0]}get mouseUp(){return this._pointerUp[0]}get mouseClick(){return this._pointerClick[0]}get mouseDoubleClick(){return this._pointerDoubleClick[0]}get mousePressed(){return this._pointerPressed[0]}get mouseWheelChanged(){return this.getMouseWheelChanged(0)}get click(){return this._pointerClick[0]}get doubleClick(){return this._pointerDoubleClick[0]}getGamepad(t=0){return typeof navigator<"u"&&"getGamepads"in navigator&&navigator.getGamepads()[t]||null}setCursorPointer(){this.setCursor("pointer")}setCursorNormal(){this.unsetCursor("pointer")}setCursor(t){this._setCursorTypes.push(t),this._setCursorTypes.length>10&&this._setCursorTypes.shift(),this.updateCursor()}unsetCursor(t){for(let e=this._setCursorTypes.length-1;e>=0;e--)if(this._setCursorTypes[e]===t){this._setCursorTypes.splice(e,1),this.updateCursor();break}}updateCursor(){var t;((t=this._setCursorTypes)==null?void 0:t.length)==0?this.context.domElement.style.cursor="default":this.context.domElement.style.cursor=this._setCursorTypes[this._setCursorTypes.length-1]}getIsPointerIdInUse(t){for(const e of this._pointerEventsPressed)if(e.pointerId===t&&e.used)return!0;return!1}getPointerPressedCount(){let t=0;for(let e=0;e<this._pointerPressed.length;e++)this._pointerPressed[e]&&t++;return t}getPointerPosition(t){return t>=this._pointerPositions.length?null:this._pointerPositions[t]}getPointerPositionLastFrame(t){return t>=this._pointerPositionsLastFrame.length?null:this._pointerPositionsLastFrame[t]}getPointerPositionDelta(t){return t>=this._pointerPositionsDelta.length?null:this._pointerPositionsDelta[t]}getPointerPositionRC(t){return t>=this._pointerPositionsRC.length?null:this._pointerPositionsRC[t]}getPointerDown(t){return t>=this._pointerDown.length?!1:this._pointerDown[t]}getPointerUp(t){return t>=this._pointerUp.length?!1:this._pointerUp[t]}getPointerPressed(t){return t>=this._pointerPressed.length?!1:this._pointerPressed[t]}getPointerClicked(t){return t>=this._pointerClick.length?!1:this._pointerClick[t]}getPointerDoubleClicked(t){return t>=this._pointerDoubleClick.length?!1:this._pointerDoubleClick[t]}getPointerDownTime(t){return t>=this._pointerDownTime.length?-1:this._pointerDownTime[t]}getPointerUpTime(t){return t>=this._pointerUpTime.length?-1:this._pointerUpTime[t]}getPointerLongPress(t){return t>=this._pointerDownTime.length?!1:this.getPointerPressed(t)&&this.context.time.time-this._pointerDownTime[t]>this._longPressTimeThreshold}getIsMouse(t){return t<0||t>=this._pointerTypes.length?!1:this._pointerTypes[t]===Ea.Mouse}getIsTouch(t){return t<0||t>=this._pointerTypes.length?!1:this._pointerTypes[t]===Ea.Touch}getTouchesPressedCount(){let t=0;for(let e=0;e<this._pointerPressed.length;e++)this._pointerPressed[e]&&this.getIsTouch(e)&&t++;return t}getMouseWheelChanged(t=0){return t>=this._mouseWheelChanged.length?!1:this._mouseWheelChanged[t]}getMouseWheelDeltaY(t=0){return t>=this._mouseWheelDeltaY.length?0:this._mouseWheelDeltaY[t]}getPointerEvent(t){if(!(t>=this._pointerEvent.length))return this._pointerEvent[t]??void 0}*foreachPointerId(t){for(let e=0;e<this._pointerTypes.length;e++)if(this._pointerIsActive(e)){if(t!==void 0){const i=this._pointerTypes[e];if(Array.isArray(t)){let n=!1;for(const o of t)if(i===o){n=!0;break}if(!n)continue}else if(t!==i)continue}yield e}}*foreachTouchId(){for(let t=0;t<this._pointerTypes.length;t++)this._pointerTypes[t]===Ea.Touch&&this._pointerIsActive[t]&&(yield t)}_pointerIsActive(t){return t<0?!1:this._pointerPressed[t]||this._pointerDown[t]||this._pointerUp[t]}onDownButton(t,e){let i=this._pressedStack.get(t);i||(i=[],this._pressedStack.set(t,i)),i.push(e)}onReleaseButton(t,e){const i=this._pressedStack.get(t);if(!i)return;const n=i.indexOf(e);n>=0&&i.splice(n,1)}getFirstPressedButtonForPointer(t){const e=this._pressedStack.get(t);if(e)return e[0]}getLatestPressedButtonForPointer(t){const e=this._pressedStack.get(t);if(e)return e[e.length-1]}getKeyDown(t){if(t!==void 0)return this.isKeyDown(t);for(const e in this.keysPressed){const i=this.keysPressed[e];if(i.startFrame===this.context.time.frameCount)return i.key}return null}getKeyPressed(t){if(t!==void 0)return this.isKeyPressed(t);for(const e in this.keysPressed){const i=this.keysPressed[e];if(i.pressed)return i.key}return null}getKeyUp(t){if(t!==void 0)return this.isKeyUp(t);for(const e in this.keysPressed){const i=this.keysPressed[e];return i.pressed===!1&&i.frame===this.context.time.frameCount}return null}isKeyDown(t){if(!this.context.application.isVisible||!this.context.application.hasFocus)return!1;const e=this.getCodeForCommonKeyName(t);if(e!==null){for(const n of e)if(this.isKeyDown(n))return!0;return!1}const i=this.keysPressed[t];return i?i.startFrame===this.context.time.frameCount&&i.pressed:!1}isKeyUp(t){if(!this.context.application.isVisible||!this.context.application.hasFocus)return!1;const e=this.getCodeForCommonKeyName(t);if(e!==null){for(const n of e)if(this.isKeyUp(n))return!0;return!1}const i=this.keysPressed[t];return i?i.frame===this.context.time.frameCount&&i.pressed===!1:!1}isKeyPressed(t){if(!this.context.application.isVisible||!this.context.application.hasFocus)return!1;const e=this.getCodeForCommonKeyName(t);if(e!==null){for(const n of e)if(this.isKeyPressed(n))return!0;return!1}const i=this.keysPressed[t];return i&&i.pressed||!1}getCodeForCommonKeyName(t){if(t.length===1){if(t>="0"&&t<="9")return["Digit"+t];if(t>="a"&&t<="z")return["Key"+t.toUpperCase()];if(t==" ")return["Space"]}switch(t){case"shift":case"Shift":return["ShiftLeft","ShiftRight"];case"control":case"Control":return["ControlLeft","ControlRight"];case"alt":case"Alt":return["AltLeft","AltRight"]}return null}createInputEvent(t){switch(t.type){case Le.PointerDown:Et&&at("Create Pointer down"),this.onDownButton(t.deviceIndex,t.button),this.onDown(t);break;case Le.PointerMove:Et&&at("Create Pointer move"),this.onMove(t);break;case Le.PointerUp:Et&&at("Create Pointer up"),this.onUp(t),this.onReleaseButton(t.deviceIndex,t.button);break}}convertScreenspaceToRaycastSpace(t){return t.x=(t.x-this.context.domX)/this.context.domWidth*2-1,t.y=-((t.y-this.context.domY)/this.context.domHeight)*2+1,t}bindEvents(){this.unbindEvents(),this._htmlEventSource=this.context.renderer.domElement,window.addEventListener("contextmenu",this.onContextMenu),this._htmlEventSource.addEventListener("pointerdown",this.onPointerDown,{passive:!0}),window.addEventListener("pointermove",this.onPointerMove,{passive:!0,capture:!0}),window.addEventListener("pointerup",this.onPointerUp,{passive:!0}),window.addEventListener("pointercancel",this.onPointerCancel,{passive:!0}),window.addEventListener("touchstart",this.onTouchStart,{passive:!0}),window.addEventListener("touchmove",this.onTouchMove,{passive:!0}),window.addEventListener("touchend",this.onTouchEnd,{passive:!0}),this._htmlEventSource.addEventListener("wheel",this.onMouseWheel,{passive:!0}),window.addEventListener("wheel",this.onWheelWindow,{passive:!0}),window.addEventListener("keydown",this.onKeyDown,!1),window.addEventListener("keypress",this.onKeyPressed,!1),window.addEventListener("keyup",this.onKeyUp,!1),window.addEventListener("blur",this.onLostFocus)}unbindEvents(){var t,e;for(const i in this._eventListeners)this._eventListeners[i].length=0;window.removeEventListener("contextmenu",this.onContextMenu),(t=this._htmlEventSource)==null||t.removeEventListener("pointerdown",this.onPointerDown),window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("pointercancel",this.onPointerCancel),window.removeEventListener("touchstart",this.onTouchStart),window.removeEventListener("touchmove",this.onTouchMove),window.removeEventListener("touchend",this.onTouchEnd),(e=this._htmlEventSource)==null||e.removeEventListener("wheel",this.onMouseWheel,!1),window.removeEventListener("wheel",this.onWheelWindow,!1),window.removeEventListener("keydown",this.onKeyDown,!1),window.removeEventListener("keypress",this.onKeyPressed,!1),window.removeEventListener("keyup",this.onKeyUp,!1),window.removeEventListener("blur",this.onLostFocus)}dispose(){const t=this.context.post_render_callbacks.indexOf(this.onEndOfFrame);t>=0&&this.context.post_render_callbacks.splice(t,1),this.unbindEvents()}canReceiveInput(t){var e;return t.target===((e=this.context.renderer)==null?void 0:e.domElement)||t.target===this.context.domElement||this.context.isInAR||this.context.isInAR&&t.target===document.body&&Q.isMozillaXR()?!0:(Et&&console.warn("CanReceiveInput:False for",t.target),!1)}getPointerId(t,e){return t.pointerType==="mouse"?0+(e??t.button):this.getPointerIndex(t.pointerId)}getButtonName(t){const e=t.button;if(t.pointerType==="mouse")switch(e){case 0:return"left";case 1:return"middle";case 2:return"right"}return"unknown"}getAndUpdateSpatialObjectForScreenPosition(t,e,i){let n=this._pointerSpace[t];n||(n=new z,this._pointerSpace[t]=n),this._pointerSpace[t]=n;const o=this.context.mainCamera;if(o){const r=this.tempNearPlaneVector.set(e,i,-1);this.convertScreenspaceToRaycastSpace(r);const l=this.tempFarPlaneVector.set(r.x,r.y,1);r.unproject(o),l.unproject(o);const c=o.worldUp||te(0,1,0).applyQuaternion(Qe(o));this.tempLookMatrix.lookAt(l,r,c),n.position.set(r.x,r.y,r.z),n.quaternion.setFromRotationMatrix(this.tempLookMatrix)}return n}isInRect(t){if(this.context.isInXR)return!0;const e=this.context.domElement.getBoundingClientRect(),i=t.clientX,n=t.clientY,o=i>=e.x&&i<=e.right&&n>=e.y&&n<=e.bottom;return Et&&!o&&console.log("Not in rect",e,i,n),o}onDown(t){const e=t.pointerId;if(this.getPointerPressed(e)){Et&&console.warn(`Received pointerDown event for pointerId that is already pressed: ${e}/${t.button}`,Et?t:"");return}if(Et&&console.log(t.pointerType,"DOWN",e,t.button),!!this.isInRect(t)){for(this.setPointerState(e,this._pointerPressed,!0),this.setPointerState(e,this._pointerDown,!0),this.setPointerStateT(e,this._pointerEvent,t.source);e>=this._pointerTypes.length;)this._pointerTypes.push(t.pointerType);for(this._pointerTypes[e]=t.pointerType;e>=this._pointerPositionDown.length;)this._pointerPositionDown.push(new R);for(this._pointerPositionDown[e].set(t.clientX,t.clientY,t.clientZ??0);e>=this._pointerPositions.length;)this._pointerPositions.push(new _e);this._pointerPositions[e].set(t.clientX,t.clientY),e>=this._pointerDownTime.length&&this._pointerDownTime.push(0),this._pointerDownTime[e]=this.context.time.realtimeSinceStartup,this.updatePointerPosition(t),this._pointerEventsPressed.push(t),this.onDispatchEvent(t)}}onMove(t){const e=t.pointerId,i=this.getPointerPressed(e);i===!1&&!this.isInRect(t)||t.pointerType===Ea.Touch&&!i||(this.updatePointerPosition(t),this.setPointerStateT(e,this._pointerEvent,t.source),this.onDispatchEvent(t))}onUp(t){const e=t.pointerId;if(!this.getPointerPressed(e)){Et&&console.warn(`Received pointerUp for pointerId that is not pressed: ${e}/${t.button}`,Et?t:"");return}Et&&console.log(t.pointerType,"UP",e),this.setPointerState(e,this._pointerPressed,!1),this.setPointerStateT(e,this._pointerEvent,t.source),this.setPointerState(e,this._pointerUp,!0),this.updatePointerPosition(t);for(let c=this._pointerEventsPressed.length-1;c>=0;c--)if(this._pointerEventsPressed[c].pointerId===e){this._pointerEventsPressed.splice(c,1);break}if(!this._pointerPositionDown[e]){Et&&qe("[Received pointer up event without matching down event for button: "+e),console.warn("Received pointer up event without matching down event for button: "+e);return}const n=this._pointerUpTime[e],o=this._pointerDownTime[e],r=this.context.time.realtimeSinceStartup,l=r-o;if(e>=this._pointerUpTime.length&&this._pointerUpTime.push(-99),this._pointerUpTime[e]=r,l<1){let c=t.clientX-this._pointerPositionDown[e].x,h=t.clientY-this._pointerPositionDown[e].y,d=0;if(t.isSpatial&&t.clientZ!=null&&(d=t.clientZ-this._pointerPositionDown[e].z,c*=200,h*=200,d*=200),Math.abs(c)<5&&Math.abs(h)<5&&Math.abs(d)<5){this.setPointerState(e,this._pointerClick,!0),t.isClick=!0;const u=r-n;Et&&console.log("CLICK",e,c,h,d,u),u<this._doubleClickTimeThreshold&&u>0&&(this.setPointerState(e,this._pointerDoubleClick,!0),t.isDoubleClick=!0)}}this.onDispatchEvent(t)}updatePointerPosition(t){const e=t.pointerId;for(;e>=this._pointerPositions.length;)this._pointerPositions.push(new _e);for(;e>=this._pointerPositionsLastFrame.length;)this._pointerPositionsLastFrame.push(new _e);for(;e>=this._pointerPositionsDelta.length;)this._pointerPositionsDelta.push(new _e);const i=this._pointerPositionsLastFrame[e];i.copy(this._pointerPositions[e]);const n=this._pointerPositionsDelta[e];let o=t.clientX-i.x,r=t.clientY-i.y;if(t.source instanceof MouseEvent||t.source instanceof TouchEvent){const d=t.source;o===0&&d.movementX!==0&&(o=d.movementX||0),r===0&&d.movementY!==0&&(r=d.movementY||0)}n.x+=o,n.y+=r,this._pointerPositions[e].x=t.clientX,this._pointerPositions[e].y=t.clientY;const l=t.clientX,c=t.clientY;for(;e>=this._pointerPositionsRC.length;)this._pointerPositionsRC.push(new _e);const h=this._pointerPositionsRC[e];h.set(l,c),this.convertScreenspaceToRaycastSpace(h)}getPointerIndex(t){let e=-1;for(let i=0;i<this._pointerIds.length;i++){if(this._pointerIds[i]===t)return i;e===-1&&this._pointerIds[i]===-1&&(e=i)}return e!==-1?(this._pointerIds[e]=t,e):(Et&&console.log("PUSH pointerId:",t),this._pointerIds.push(t),this._pointerIds.length-1)}setPointerState(t,e,i){e[t]=i}setPointerStateT(t,e,i){return e[t]=i,i}onDispatchEvent(t){const e=de.Current;try{de.Current=this.context,this.dispatchEvent(t)}finally{de.Current=e}}}const Mh=new xe().makeRotationY(Math.PI),us=new re().setFromAxisAngle(new R(0,1,0),Math.PI),$M=k("debugwebxr");class VM{constructor(){a(this,"priority",-1e5);a(this,"gameObject");if(this.gameObject=new z,this.gameObject.name="Implicit XR Rig",$M){const t=Z0(16733661);t.position.y+=.5,this.gameObject.add(t)}}isXRRig(){return!0}get isActive(){return this.gameObject.visible}}const mr=k("debugwebxr"),dp=k("debugcustomgesture"),WM="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",HM="generic-trigger",GM=new re().setFromEuler(new Ht(Ar.degToRad(0),Ar.degToRad(-90),Ar.degToRad(-90))),qM=new R(.04,-.04,0);class z1{constructor(t,e,i){a(this,"xr");a(this,"inputSource");a(this,"index",0);a(this,"emitEvents",!0);a(this,"_connected",!0);a(this,"_isTracking",!1);a(this,"__gamepad");a(this,"__hand");a(this,"__side");a(this,"_hitTestSource");a(this,"_hasSelectEvent",!1);a(this,"_isMxInk",!1);a(this,"_isMetaQuestTouchController",!1);a(this,"_handJointPoses",new Map);a(this,"_gripMatrix",new xe);a(this,"_gripPosition",new R);a(this,"_gripQuaternion",new re);a(this,"_linearVelocity",new R);a(this,"_rayPositionRaw",new R);a(this,"_rayRotationRaw",new re);a(this,"_rayMatrix",new xe);a(this,"_rayPosition",new R);a(this,"_rayQuaternion",new re);a(this,"_gripWorldPosition",new R);a(this,"_gripWorldQuaternion",new re);a(this,"_rayWorldPosition",new R);a(this,"_rayWorldQuaternion",new re);a(this,"_pinchPosition",new R);a(this,"_ray");a(this,"_hand_wristDotUp");a(this,"_object");a(this,"_gripSpaceObject");a(this,"_raySpaceObject");a(this,"model",null);a(this,"_debugAxesHelper",new Wn(.15));a(this,"_debugGripAxesHelper",new Wn(.07));a(this,"_debugRayAxesHelper",new Wn(.07));a(this,"_hitTestSourcePromise",null);a(this,"onPointerHits",t=>{});a(this,"_needleGamepadButtons",{});a(this,"_buttonMap",new Map);a(this,"_motioncontroller");a(this,"_layout");a(this,"getMotionController");a(this,"emitPointerDownEvent",!0);a(this,"emitPointerUpEvent",!0);a(this,"emitPointerMoveEvent",!0);a(this,"pointerMoveDistanceThreshold",.03);a(this,"pointerMoveAngleThreshold",.05);a(this,"_selectButtonIndex");a(this,"_squeezeButtonIndex");a(this,"onSelectStart",t=>{var n,o,r,l;if(!this.emitPointerDownEvent||this.inputSource!==t.inputSource)return;this.onUpdateFrame(t.frame),this._hasSelectEvent=!0;const e=(n=this._layout)==null?void 0:n.selectComponentId,i=(l=(r=(o=this._layout)==null?void 0:o.components[e])==null?void 0:r.gamepadIndices)==null?void 0:l.button;i!==void 0&&(this._selectButtonIndex=i),!dp&&(mr&&se.DrawDirection(this.rayWorldPosition,te(0,.01,1).applyQuaternion(this.rayWorldQuaternion),16711680,10),this.emitPointerEvent(Le.PointerDown,this._selectButtonIndex||0,"xr-standard-trigger",!0,t))});a(this,"onSelectEnd",t=>{this.emitPointerUpEvent&&(dp||this.inputSource===t.inputSource&&this.emitPointerEvent(Le.PointerUp,this._selectButtonIndex||0,"xr-standard-trigger",!0,t))});a(this,"onSequeezeStart",t=>{var e,i,n;this.emitPointerDownEvent&&this.inputSource===t.inputSource&&(this._squeezeButtonIndex=(n=(i=(e=this._layout)==null?void 0:e.components["xr-standard-squeeze"])==null?void 0:i.gamepadIndices)==null?void 0:n.button,this._squeezeButtonIndex!==void 0&&(mr&&se.DrawDirection(this.rayWorldPosition,te(0,.01,1).applyQuaternion(this.rayWorldQuaternion),255,10),this.emitPointerEvent(Le.PointerDown,this._squeezeButtonIndex||0,"xr-standard-squeeze",!0,t)))});a(this,"onSequeezeEnd",t=>{this.emitPointerUpEvent&&this.inputSource===t.inputSource&&this._squeezeButtonIndex!==void 0&&this.emitPointerEvent(Le.PointerUp,this._squeezeButtonIndex||0,"xr-standard-squeeze",!0,t)});a(this,"states",{});a(this,"_didMoveLastFrame",!1);a(this,"_lastPointerMovePosition",new R);a(this,"_lastPointerMoveQuaternion",new re);a(this,"pointerInit");this.xr=t,this.inputSource=e,this.index=i,this._object=new z,this._object.name=`NeedleXRController_${i}`,mr&&(this._object.add(this._debugAxesHelper),this._gripSpaceObject=new z,this._raySpaceObject=new z,this._gripSpaceObject.name=`NeedleXRController_${i}_gripSpace`,this._raySpaceObject.name=`NeedleXRController_${i}_raySpace`,this._gripSpaceObject.add(this._debugGripAxesHelper),this._raySpaceObject.add(this._debugRayAxesHelper),this.xr.context.scene.add(this._gripSpaceObject),this.xr.context.scene.add(this._raySpaceObject)),this.xr.context.scene.add(this._object),this._ray=new zr,this.pointerInit={origin:this,pointerType:this.hand?"hand":"controller",deviceIndex:this.index,pointerId:-1,mode:this.inputSource.targetRayMode,ray:this._ray,device:this._object,buttonName:"none"},this.initialize(),this.subscribeEvents()}get context(){return this.xr.context}get connected(){return this._connected}get isTracking(){return this._isTracking}get gamepad(){return this.__gamepad??(this.__gamepad=this.inputSource.gamepad)}get isHand(){return this.hand!=null}get hand(){return this.__hand??(this.__hand=this.inputSource.hand)}get handObject(){return this.context.renderer.xr.getHand(this.index)}get profiles(){return this.inputSource.profiles}get layout(){return this._layout}get targetRayMode(){return this.inputSource.targetRayMode}get targetRaySpace(){return this.inputSource.targetRaySpace}get gripSpace(){return this.inputSource.gripSpace}get side(){return this.__side??(this.__side=this.inputSource.handedness)}get isRight(){return this.side==="right"}get isLeft(){return this.side==="left"}get isStylus(){return this._isMxInk}getHitTestSource(){return this._hitTestSource||this._requestHitTestSource(),this._hitTestSource}get hasHitTestSource(){return this._hitTestSource}cancelHitTestSource(){this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=void 0)}get hasSelectEvent(){return this._hasSelectEvent}getHitTest(){return this.xr.getHitTest(this)}getHandJointPose(t,e){var n;if(e=e||this.xr.frame,!this.hand||!(e!=null&&e.getJointPose)||!this.xr.referenceSpace)return null;let i=(n=this._handJointPoses)==null?void 0:n.get(t);return i||(i=e.getJointPose(t,this.xr.referenceSpace),i&&this._handJointPoses.set(t,i),i)}get gripPosition(){return te(this._gripPosition)}get gripQuaternion(){return Un(this._gripQuaternion)}get gripMatrix(){return this._gripMatrix}get gripLinearVelocity(){return te(this._linearVelocity).applyQuaternion(us)}get rayPosition(){return te(this._rayPosition)}get rayQuaternion(){return Un(this._rayQuaternion)}get gripWorldPosition(){return te(this._gripWorldPosition)}get gripWorldQuaternion(){return Un(this._gripWorldQuaternion)}get rayWorldPosition(){return te(this._rayWorldPosition)}updateRayWorldPosition(){var e;const t=(e=this.xr.context.mainCamera)==null?void 0:e.parent;this._rayWorldPosition.copy(this._rayPositionRaw),t&&this._rayWorldPosition.applyMatrix4(t.matrixWorld)}get rayWorldQuaternion(){return Un(this._rayWorldQuaternion)}get pinchPosition(){return te(this._pinchPosition)}updateRayWorldQuaternion(){var i;const t=(i=this.xr.context.mainCamera)==null?void 0:i.parent,e=t?Qe(t):void 0;this._rayWorldQuaternion.copy(this._rayRotationRaw).multiply(us),e&&this._rayWorldQuaternion.premultiply(e)}get ray(){return this._ray.origin.copy(this.rayWorldPosition),this._ray.direction.copy(te(0,0,1).applyQuaternion(this.rayWorldQuaternion)),this._ray}get handWristDotUp(){var e;if(this._hand_wristDotUp!==void 0)return this._hand_wristDotUp;const t=(e=this.handObject)==null?void 0:e.joints.wrist;if(t){const i=te(0,1,0).applyQuaternion(t.quaternion),n=te(0,1,0).dot(i);return this._hand_wristDotUp=n}}get isHandUpsideDown(){return this.handWristDotUp!==void 0?this.handWristDotUp<-.7:!1}get isTeleportGesture(){var t;return this.isHandUpsideDown&&((t=this.getGesture("pinch"))==null?void 0:t.isDown)}get object(){return this._object}async getModelUrl(){var t;return(t=this.getMotionController)==null?void 0:t.then(e=>(e==null?void 0:e.assetUrl)||null)}_requestHitTestSource(){var t;return this._hitTestSourcePromise?this._hitTestSourcePromise:this.xr.mode==="immersive-ar"&&this.inputSource.targetRayMode==="tracked-pointer"&&this.xr.session.requestHitTestSourceForTransientInput?this._hitTestSourcePromise=((t=this.xr.session.requestHitTestSourceForTransientInput({profile:this.inputSource.profiles[0],offsetRay:new XRRay}))==null?void 0:t.then(e=>(this._hitTestSourcePromise=null,this.connected?this._hitTestSource=e:(e.cancel(),null))))??null:null}onUpdate(t){this.onUpdateFrame(t),this.updateInputEvents(),this.onUpdateMove()}onRenderDebug(){var o,r,l;se.DrawSphere(this.rayWorldPosition,.003),se.DrawDirection(this.rayWorldPosition,te(0,0,10).applyQuaternion(this.rayWorldQuaternion));const e=(this.inputSource.gripSpace?this.gripWorldPosition:this.object.worldPosition).sub(this.object.worldForward.multiplyScalar(.1)),i=this.inputSource.profiles.join(`
`);let n=`Controller[${this.index}] (${this.inputSource.targetRayMode}, ${this.side})
C:${this.connected?"x":"-"} T:${this.isTracking?"x":"-"} Hand:${this.inputSource.hand?"x":"-"} Pen: ${this._isMxInk?"x":"-"}`;if(this.inputSource.hand&&(n+=`
Pinch: ${(o=this.getGesture("pinch"))==null?void 0:o.value.toFixed(3)}`),n+=`
`+i,n+=`
`+(this.inputSource.targetRaySpace?"Ray: x":"Ray: -")+(this.inputSource.gripSpace?" Grip: x":" Grip: -")+(this.inputSource.gamepad?` Gamepad: ${this.inputSource.gamepad.mapping}`:" Gamepad: -"),this.inputSource.gamepad){const c=this.inputSource.gamepad;let h="[btns "+c.buttons.length+"]: "+c.buttons.map(d=>d.value.toPrecision(1)).join(",");h+=`
[axes `+c.axes.length+"]: "+c.axes.map(d=>d.toPrecision(1)).join(","),n+=`
`+h}if(this._layout){n+=`
Layout: `;for(const c of Object.keys(this._layout.components||{})){const h=this.getStick(c),d=(r=this._layout.components[c])==null?void 0:r.gamepadIndices,u=d?Object.entries(d).map(f=>f[0][0].toUpperCase()+f[0].slice(1)+"="+f[1]).join(","):"";n+=`
  ${c}: ${(l=this._layout.components[c])==null?void 0:l.type} [${u}] (${h.x.toPrecision(2)},${h.y.toPrecision(2)})`}}se.DrawLabel(e,n,.006)}onUpdateFrame(t){var d,u,f,p,b,x,v,S,C,P,E,D;if(this._handJointPoses.clear(),this._hand_wristDotUp=void 0,!this.xr.referenceSpace||!((d=this.inputSource.gamepad)!=null&&d.connected)){this._isTracking=!1;return}const e=t.getPose(this.inputSource.targetRaySpace,this.xr.referenceSpace);this._isTracking=e!=null;let i=null,n=null,o=null,r=null;if(e){const M=e.transform;this._rayMatrix.fromArray(M.matrix).premultiply(Mh),this._rayMatrix.decompose(this._rayPosition,this._rayQuaternion,te(1,1,1)),o=te(M.position),r=Un(M.orientation),this._rayPositionRaw.copy(o),this._rayRotationRaw.copy(r)}if(this.inputSource.gripSpace){const M=t.getPose(this.inputSource.gripSpace,this.xr.referenceSpace);if(M){const A=M.transform;if(i=te(A.position),n=Un(A.orientation),this._gripMatrix.fromArray(A.matrix).premultiply(Mh),this._gripMatrix.decompose(this._gripPosition,this._gripQuaternion,te(1,1,1)),"linearVelocity"in M&&M.linearVelocity){const G=M.linearVelocity;this._linearVelocity.set(G.x,G.y,G.z)}}}(u=this.xr.context.mainCamera)!=null&&u.parent&&(this._object.parent!==((f=this.xr.context.mainCamera)==null?void 0:f.parent)&&this.xr.context.mainCamera.parent.add(this._object),this._gripSpaceObject!==void 0&&((p=this._gripSpaceObject)==null?void 0:p.parent)!==((b=this.xr.context.mainCamera)==null?void 0:b.parent)&&this.xr.context.mainCamera.parent.add(this._gripSpaceObject),this._raySpaceObject!==void 0&&((x=this._raySpaceObject)==null?void 0:x.parent)!==((v=this.xr.context.mainCamera)==null?void 0:v.parent)&&this.xr.context.mainCamera.parent.add(this._raySpaceObject));const l=this.hand;if(l){let M=!1;const A=l.get("wrist"),G=A&&this.getHandJointPose(A,t);if(G){M=!0;const $=G.transform.position,Y=G.transform.orientation;this._object.position.set($.x,$.y,$.z),this._object.quaternion.set(Y.x,Y.y,Y.z,Y.w).multiply(us)}M||(this._object.position.copy(this._rayPosition),this._object.quaternion.copy(this._rayQuaternion).multiply(us));const V=l.get("middle-finger-metacarpal"),U=V&&this.getHandJointPose(V,t);U&&(this._gripMatrix.fromArray(U.transform.matrix).premultiply(Mh),this._gripMatrix.decompose(this._gripPosition,this._gripQuaternion,te(1,1,1)),i=te().copy(U.transform.position),n=Un().copy(U.transform.orientation),n.multiply(GM),i.add(te(qM).applyQuaternion(n)))}else this.inputSource.gripSpace&&this.targetRayMode==="transient-pointer"&&i&&n?(this._object.position.copy(i),this._object.quaternion.copy(n).multiply(us)):o&&r&&(this._object.position.copy(o),this._object.quaternion.copy(r).multiply(us));mr&&(o&&r&&((S=this._raySpaceObject)==null||S.position.copy(o),(C=this._raySpaceObject)==null||C.quaternion.copy(r).multiply(us)),i&&n&&((P=this._gripSpaceObject)==null||P.position.copy(i),(E=this._gripSpaceObject)==null||E.quaternion.copy(n).multiply(us)));const c=(D=this.xr.context.mainCamera)==null?void 0:D.parent,h=c?Qe(c):void 0;i&&n&&(this._gripWorldPosition.copy(i),c&&this._gripWorldPosition.applyMatrix4(c.matrixWorld),this._gripWorldQuaternion.copy(n),this._gripWorldQuaternion.multiply(us),h&&this._gripWorldQuaternion.premultiply(h)),this.updateRayWorldPosition(),this.updateRayWorldQuaternion()}onDisconnected(){var t,e,i,n,o,r;this._connected=!1,mr&&console.warn("Controller disconnected",this.index);for(const l of this._object.children)this.xr.context.scene.attach(l);(t=this._object)==null||t.removeFromParent(),(e=this._debugAxesHelper)==null||e.removeFromParent(),(i=this._debugGripAxesHelper)==null||i.removeFromParent(),(n=this._debugRayAxesHelper)==null||n.removeFromParent(),(o=this._gripSpaceObject)==null||o.removeFromParent(),(r=this._raySpaceObject)==null||r.removeFromParent(),this.unsubscribeEvents(),this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=void 0)}getButton(t){var i;if(!this._layout)return;switch(t){case"primary-button":if(this.isLeft)t="x-button";else if(this.isRight)t="a-button";else return;break;case"primary":return this.hand?this.getGesture("pinch"):this.toNeedleGamepadButton(0,t);case"xr-standard-trigger":if(this.inputSource.gamepad)return this.toNeedleGamepadButton(0,t);break;case"xr-standard-squeeze":if(this.inputSource.gamepad)return this.toNeedleGamepadButton(1,t);break;case"xr-standard-thumbstick":if(this.inputSource.gamepad)return this.toNeedleGamepadButton(3,t);break}if(this._buttonMap.has(t))return this.toNeedleGamepadButton(this._buttonMap.get(t),t);const e=(i=this._layout)==null?void 0:i.components[t];if(e!=null&&e.gamepadIndices)switch(e.type){case"button":case"squeeze":if(this.inputSource.gamepad){const n=e.gamepadIndices.button;return this._buttonMap.set(t,n),this.toNeedleGamepadButton(n,t)}break;default:console.warn("Unsupported component type",e.type);break}this._buttonMap.set(t,void 0)}getGesture(t){const e=this.states[t];if(!e)return null;this.states[t]=e;const i=this._needleGamepadButtons[t]||new uw(void 0,t);return i.pressed=e.pressed,i.value=e.value,i.isDown=e.isDown,i.isUp=e.isUp,this._needleGamepadButtons[t]=i,i}getPointerId(t){if((t==="primary"||t==="pinch")&&(t=0),typeof t!="number"){const e=this._buttonMap.get(t);if(e===void 0)return;t=e}return this.index*10+t}toNeedleGamepadButton(t,e){var r,l;if(!((r=this.inputSource.gamepad)!=null&&r.buttons))return;const i=(l=this.inputSource.gamepad)==null?void 0:l.buttons[t],n=this.states[t],o=this._needleGamepadButtons[t]||new uw(t,e);return i&&(o.pressed=i.pressed,o.value=i.value,o.touched=i.touched),n&&(o.isDown=n.isDown,o.isUp=n.isUp),this._needleGamepadButtons[t]=o,o}getStick(t){var i,n,o;if(!this._layout)return{x:0,y:0,z:0};if(this.isHand)return{x:0,y:0,z:0};t==="primary"&&this._layout.components["xr-standard-thumbstick"]&&(t="xr-standard-thumbstick");const e=(i=this._layout)==null?void 0:i.components[t];if(e!=null&&e.gamepadIndices)switch(e.type){case"thumbstick":case"touchpad":if(this.inputSource.gamepad){const r=e.gamepadIndices.xAxis,l=e.gamepadIndices.yAxis;let c=this.inputSource.gamepad.axes[r]||0,h=this.inputSource.gamepad.axes[l]||0;c*=-1,h*=-1;const d=e.gamepadIndices.button,u=((o=(n=this.inputSource.gamepad)==null?void 0:n.buttons[d])==null?void 0:o.value)||0;return{x:c,y:h,z:u}}}return{x:0,y:0,z:0}}initialize(){if(this._hasSelectEvent=this.profiles.includes("generic-hand-select")||this.profiles.some(t=>t.startsWith("generic-trigger")),this._isMetaQuestTouchController=this.profiles.includes("meta-quest-touch-plus")||this.profiles.includes("oculus-touch-v3"),this._isMxInk=this.profiles.includes("logitech-mx-ink"),!this._layout){if(this.inputSource.targetRayMode==="transient-pointer")return;const t=DM(this.inputSource,WM,HM);this.getMotionController=t.then(e=>{var o;if(!this.connected)return null;this._motioncontroller=new NM(this.inputSource,e.profile,e.assetPath||"");const n=e.profile.layouts[this.inputSource.handedness];if(this._layout=n,this._layout){if(!((o=this._layout.gamepad)!=null&&o.length)){this._layout.gamepad=[];for(const r in this._layout.components){const l=this._layout.components[r];this._layout.gamepad[l.gamepadIndices.button]=r}}this.profiles.length>=1&&this.profiles[0]==="htc-vive-focus-plus"&&this.inputSource.gamepad&&this.inputSource.gamepad.axes.length===4&&!this._layout.components["xr-standard-thumbstick"]&&(this._layout.components["xr-standard-thumbstick"]={type:"thumbstick",gamepadIndices:{xAxis:2,yAxis:3}})}return this._motioncontroller}).catch(e=>(this.inputSource&&console.warn("Couldn't initialize motion controller profile for ",this.inputSource,e),null))}}subscribeEvents(){this.xr.session.addEventListener("selectstart",this.onSelectStart),this.xr.session.addEventListener("selectend",this.onSelectEnd),this.xr.session.addEventListener("squeezestart",this.onSequeezeStart),this.xr.session.addEventListener("squeezeend",this.onSequeezeEnd)}unsubscribeEvents(){this.xr.session.removeEventListener("selectstart",this.onSelectStart),this.xr.session.removeEventListener("selectend",this.onSelectEnd),this.xr.session.removeEventListener("squeezestart",this.onSequeezeStart),this.xr.session.removeEventListener("squeezeend",this.onSequeezeEnd)}updateInputEvents(){var t,e,i;if((t=this.gamepad)!=null&&t.buttons){for(let n=0;n<this.gamepad.buttons.length;n++){const o=this.gamepad.buttons[n],r=this.states[n]||new dw;let l=null;this._isMxInk&&(n===4||n===5)?(o.value>0&&!r.pressed?(l="pointerdown",r.isDown=!0,r.isUp=!1):o.value===0&&r.pressed?(l="pointerup",r.isDown=!1,r.isUp=!0):r.pressed&&(l="pointermove",r.isDown=!1,r.isUp=!1),r.pressed=o.value>0,r.value=o.value):(o.pressed&&!r.pressed?(l="pointerdown",r.isDown=!0,r.isUp=!1):!o.pressed&&r.pressed?(l="pointerup",r.isDown=!1,r.isUp=!0):(r.isDown=!1,r.isUp=!1),r.pressed=o.pressed,r.value=o.value),this.states[n]=r;const c=n!==this._selectButtonIndex&&n!==this._squeezeButtonIndex;if(l!=null&&c){let h=(e=this._layout)==null?void 0:e.gamepad[n];this._isMxInk&&n===4&&(h="stylus-touch"),this._isMxInk&&n===5&&(h="stylus-tip"),(mr||dp)&&console.log("Emitting pointer event",l,n,h,o.value,this.gamepad,this._layout),this.emitPointerEvent(l,n,h??"none",!1,null,o.value)}}if(this._isMetaQuestTouchController){const n=this.gamepad.buttons.length-1,o=this.states[n];if(o&&o.isDown){const r=this.context.menu;r.spatialMenuIsVisible?r.setSpatialMenuVisible(!1):this.context.menu.setSpatialMenuVisible(!0)}}}if(this.hand){const n=this.handObject;if(n){const o=n.joints["index-finger-tip"],r=n.joints["thumb-tip"];if(o&&r){const l=o.position.distanceTo(r.position);this._pinchPosition.lerpVectors(o.position,r.position,.5);const c=(i=this.xr.context.mainCamera)==null?void 0:i.parent;if(c&&this._pinchPosition.applyMatrix4(c.matrixWorld),l!==0){const u=this.states.pinch||new dw,f=(.02+.01)*1.5;u.value=1-(l-.02)/f;const p=l<.02-.01,b=l>.02+.01;p&&!u.pressed?(dp&&console.log("pinch start",l),u.isDown=!0,u.isUp=!1,u.pressed=!0):b&&u.pressed?(u.isDown=!1,u.isUp=!0,u.pressed=!1):(u.isDown=!1,u.isUp=!1),this.states.pinch=u}}}}}onUpdateMove(){var i,n;if(!this.emitPointerMoveEvent)return;let t=!1;if(this._lastPointerMovePosition.distanceTo(this.gripWorldPosition)>this.pointerMoveDistanceThreshold*this.xr.rigScale&&(t=!0),t||this._lastPointerMoveQuaternion.angleTo(this.gripWorldQuaternion)>this.pointerMoveAngleThreshold&&(t=!0),t){this._didMoveLastFrame=!0,this._lastPointerMovePosition.copy(this.gripWorldPosition),this._lastPointerMoveQuaternion.copy(this.gripWorldQuaternion),mr&&se.DrawLabel(this.rayWorldPosition.add(this.object.worldForward.multiplyScalar(.1)),"move",.01);let o=this.xr.context.input.getFirstPressedButtonForPointer(this.index);o===void 0&&(o=0);const r=(n=(i=this.gamepad)==null?void 0:i.buttons[o])==null?void 0:n.value;this.emitPointerEvent("pointermove",o,"none",!1,null,r)}else this._didMoveLastFrame=!1}emitPointerEvent(t,e,i,n,o=null,r){if(!this.emitEvents){mr&&t!==Le.PointerMove&&console.warn("Pointer events are disabled for this controller",this.index,t,e);return}if(this.xr.mode==="immersive-vr"||this.xr.isPassThrough){this.pointerInit.origin=this,this.pointerInit.pointerId=this.getPointerId(e),this.pointerInit.pointerType=this.hand?"hand":"controller",this.pointerInit.button=e,this.pointerInit.buttonName=i,this.pointerInit.isPrimary=n,this.pointerInit.mode=this.inputSource.targetRayMode,this.pointerInit.ray=this.ray,this.pointerInit.device=this.object,this.pointerInit.pressure=r,this.pointerInit.clientX=this._rayPosition.x/this.xr.rigScale,this.pointerInit.clientY=this._rayPosition.y/this.xr.rigScale,this.pointerInit.clientZ=this._rayPosition.z/this.xr.rigScale;const l=de.Current;de.Current=this.xr.context,mr&&t!=="pointermove"&&console.warn("Pointer event",t,e,i,{...this.pointerInit}),this.xr.context.input.createInputEvent(new ga(t,o,this.pointerInit)),de.Current=l}}}class dw{constructor(){a(this,"isDown",!1);a(this,"isUp",!1);a(this,"pressed",!1);a(this,"value",0)}}class uw{constructor(t,e){a(this,"index");a(this,"name");a(this,"touched",!1);a(this,"pressed",!1);a(this,"value",0);a(this,"isDown",!1);a(this,"isUp",!1);this.index=t,this.name=e}}var Jl;(function(s){s.Visible="application-visible",s.Hidden="application-hidden",s.MuteChanged="application-mutechanged"})(Jl||(Jl={}));let hf=!1;const Wl=[];function bc(){if(hf)return;X()&&console.debug("[Needle Engine] User input registered: Media playback is now allowed."),hf=!0;const s=[...Wl];Wl.length=0,s.forEach(t=>t())}document.addEventListener("mousedown",bc);document.addEventListener("pointerup",bc);document.addEventListener("click",bc);document.addEventListener("dragstart",bc);document.addEventListener("touchend",bc);document.addEventListener("keydown",bc);var zC;typeof window<"u"&&"userActivation"in navigator&&((zC=navigator.userActivation)!=null&&zC.isActive)&&(X()&&console.debug("[Needle Engine] User input already active: Media playback is now allowed."),Wl.length=0,hf=!0);const tx=class extends EventTarget{constructor(e){super();a(this,"_mute",!1);a(this,"context");a(this,"_isVisible",!0);this.context=e,window.addEventListener("visibilitychange",this.onVisiblityChanged.bind(this),!1)}static get userInteractionRegistered(){return hf}static registerWaitForInteraction(e){if(e!==null){if(hf){e();return}Wl.indexOf(e)===-1&&Wl.push(e)}}static unregisterWaitForInteraction(e){const i=Wl.indexOf(e);i!==-1&&Wl.splice(i,1)}get muted(){return this._mute}set muted(e){e!==this._mute&&(this._mute=e,this.dispatchEvent(new Event(Jl.MuteChanged)))}get hasFocus(){return document.hasFocus()}get isVisible(){return this._isVisible}onVisiblityChanged(e){switch(e.target.visibilityState){case"hidden":this._isVisible=!1,this.dispatchEvent(new Event(Jl.Hidden));break;case"visible":this._isVisible=!0,this.dispatchEvent(new Event(Jl.Visible));break}}};let Xs=tx;a(Xs,"registerWaitForAllowAudio",tx.registerWaitForInteraction);const Ah=new Map,ch=new Map;let fw=0;function Yr(s,t,e){if(Ah.has(t)||Ah.set(t,new Array),Ah.get(t).push({method:s,options:{once:!1,...e}}),fw<30){const i=ch.get(t);i&&(i==null?void 0:i.length)>100&&(fw+=1,console.warn(`You have ${i.length} methods registered for Event ${t}.

This might be a performance issue!
Consider unregistering the methods when they are not needed anymore!

To unregister you can call the function returned by your event hook (e.g.const unregister = onStart(...)) 

or by using the once option like onStart(()=>{}, { once:true }).

See https://engine.needle.tools/docs/scripting.html#special-lifecycle-hooks for more information.`))}}function Qa(s,t){const e=ch.get(t);if(e){for(let n=0;n<e.length;n++)if(e[n].method===s){e.splice(n,1);return}}const i=Ah.get(t);if(i){for(let n=0;n<i.length;n++)if(i[n].method===s){i.splice(n,1);return}}}function ho(s,t){t===Me.ContextCreated&&b_.delete(s),$1(s,t)}function $1(s,t){t===ge.Start&&Ah.get(Me.ContextCreated)&&$1(s,Me.ContextCreated);const e=t===ge.Start||t===Me.ContextCreated,i=ch.get(t);i&&i.length>0&&mw(s,i,e);const n=Ah.get(t);if(n&&n.length>0){const o=[...n];n.length=0,mw(s,o,e),o.length>0&&(ch.has(t)||ch.set(t,new Array),ch.get(t).push(...o))}}const up=new Array,pw={context:null};function mw(s,t,e){var n,o;up.length=0;for(let r=0;r<t.length;r++)up.push(t[r]);let i=b_.get(s);for(let r=0;r<up.length;r++){const l=up[r];let c=!0;if(i&&i.has(l)&&(c=!1),c)try{pw.context=s,(n=l.method)==null||n.call(pw,s)}catch(h){console.error("Error in lifecycle method",h)}if((o=l.options)!=null&&o.once){for(let h=0;h<t.length;h++)if(t[h]===l){t.splice(h,1);break}}else e&&(i||(i=new Set,b_.set(s,i)),i.add(l))}}const b_=new WeakMap,Ky=2,Io=4,Pr=4,H0=4,va=new Int32Array(2),gw=new Float32Array(va.buffer),yw=new Float64Array(va.buffer),fp=new Uint16Array(new Uint8Array([1,0]).buffer)[0]===1;class Lr{constructor(t,e){this.low=t|0,this.high=e|0}static create(t,e){return t==0&&e==0?Lr.ZERO:new Lr(t,e)}toFloat64(){return(this.low>>>0)+this.high*4294967296}equals(t){return this.low==t.low&&this.high==t.high}}Lr.ZERO=new Lr(0,0);var __;(function(s){s[s.UTF8_BYTES=1]="UTF8_BYTES",s[s.UTF16_STRING=2]="UTF16_STRING"})(__||(__={}));class df{constructor(t){this.bytes_=t,this.position_=0}static allocate(t){return new df(new Uint8Array(t))}clear(){this.position_=0}bytes(){return this.bytes_}position(){return this.position_}setPosition(t){this.position_=t}capacity(){return this.bytes_.length}readInt8(t){return this.readUint8(t)<<24>>24}readUint8(t){return this.bytes_[t]}readInt16(t){return this.readUint16(t)<<16>>16}readUint16(t){return this.bytes_[t]|this.bytes_[t+1]<<8}readInt32(t){return this.bytes_[t]|this.bytes_[t+1]<<8|this.bytes_[t+2]<<16|this.bytes_[t+3]<<24}readUint32(t){return this.readInt32(t)>>>0}readInt64(t){return new Lr(this.readInt32(t),this.readInt32(t+4))}readUint64(t){return new Lr(this.readUint32(t),this.readUint32(t+4))}readFloat32(t){return va[0]=this.readInt32(t),gw[0]}readFloat64(t){return va[fp?0:1]=this.readInt32(t),va[fp?1:0]=this.readInt32(t+4),yw[0]}writeInt8(t,e){this.bytes_[t]=e}writeUint8(t,e){this.bytes_[t]=e}writeInt16(t,e){this.bytes_[t]=e,this.bytes_[t+1]=e>>8}writeUint16(t,e){this.bytes_[t]=e,this.bytes_[t+1]=e>>8}writeInt32(t,e){this.bytes_[t]=e,this.bytes_[t+1]=e>>8,this.bytes_[t+2]=e>>16,this.bytes_[t+3]=e>>24}writeUint32(t,e){this.bytes_[t]=e,this.bytes_[t+1]=e>>8,this.bytes_[t+2]=e>>16,this.bytes_[t+3]=e>>24}writeInt64(t,e){this.writeInt32(t,e.low),this.writeInt32(t+4,e.high)}writeUint64(t,e){this.writeUint32(t,e.low),this.writeUint32(t+4,e.high)}writeFloat32(t,e){gw[0]=e,this.writeInt32(t,va[0])}writeFloat64(t,e){yw[0]=e,this.writeInt32(t,va[fp?0:1]),this.writeInt32(t+4,va[fp?1:0])}getBufferIdentifier(){if(this.bytes_.length<this.position_+Io+Pr)throw new Error("FlatBuffers: ByteBuffer is too short to contain an identifier.");let t="";for(let e=0;e<Pr;e++)t+=String.fromCharCode(this.readInt8(this.position_+Io+e));return t}__offset(t,e){const i=t-this.readInt32(t);return e<this.readInt16(i)?this.readInt16(i+e):0}__union(t,e){return t.bb_pos=e+this.readInt32(e),t.bb=this,t}__string(t,e){t+=this.readInt32(t);const i=this.readInt32(t);let n="",o=0;if(t+=Io,e===__.UTF8_BYTES)return this.bytes_.subarray(t,t+i);for(;o<i;){let r;const l=this.readUint8(t+o++);if(l<192)r=l;else{const c=this.readUint8(t+o++);if(l<224)r=(l&31)<<6|c&63;else{const h=this.readUint8(t+o++);if(l<240)r=(l&15)<<12|(c&63)<<6|h&63;else{const d=this.readUint8(t+o++);r=(l&7)<<18|(c&63)<<12|(h&63)<<6|d&63}}}r<65536?n+=String.fromCharCode(r):(r-=65536,n+=String.fromCharCode((r>>10)+55296,(r&1024-1)+56320))}return n}__union_with_string(t,e){return typeof t=="string"?this.__string(e):this.__union(t,e)}__indirect(t){return t+this.readInt32(t)}__vector(t){return t+this.readInt32(t)+Io}__vector_len(t){return this.readInt32(t+this.readInt32(t))}__has_identifier(t){if(t.length!=Pr)throw new Error("FlatBuffers: file identifier must be length "+Pr);for(let e=0;e<Pr;e++)if(t.charCodeAt(e)!=this.readInt8(this.position()+Io+e))return!1;return!0}createLong(t,e){return Lr.create(t,e)}createScalarList(t,e){const i=[];for(let n=0;n<e;++n)t(n)!==null&&i.push(t(n));return i}createObjList(t,e){const i=[];for(let n=0;n<e;++n){const o=t(n);o!==null&&i.push(o.unpack())}return i}}class Tf{constructor(t){this.minalign=1,this.vtable=null,this.vtable_in_use=0,this.isNested=!1,this.object_start=0,this.vtables=[],this.vector_num_elems=0,this.force_defaults=!1,this.string_maps=null;let e;t?e=t:e=1024,this.bb=df.allocate(e),this.space=e}clear(){this.bb.clear(),this.space=this.bb.capacity(),this.minalign=1,this.vtable=null,this.vtable_in_use=0,this.isNested=!1,this.object_start=0,this.vtables=[],this.vector_num_elems=0,this.force_defaults=!1,this.string_maps=null}forceDefaults(t){this.force_defaults=t}dataBuffer(){return this.bb}asUint8Array(){return this.bb.bytes().subarray(this.bb.position(),this.bb.position()+this.offset())}prep(t,e){t>this.minalign&&(this.minalign=t);const i=~(this.bb.capacity()-this.space+e)+1&t-1;for(;this.space<i+t+e;){const n=this.bb.capacity();this.bb=Tf.growByteBuffer(this.bb),this.space+=this.bb.capacity()-n}this.pad(i)}pad(t){for(let e=0;e<t;e++)this.bb.writeInt8(--this.space,0)}writeInt8(t){this.bb.writeInt8(this.space-=1,t)}writeInt16(t){this.bb.writeInt16(this.space-=2,t)}writeInt32(t){this.bb.writeInt32(this.space-=4,t)}writeInt64(t){this.bb.writeInt64(this.space-=8,t)}writeFloat32(t){this.bb.writeFloat32(this.space-=4,t)}writeFloat64(t){this.bb.writeFloat64(this.space-=8,t)}addInt8(t){this.prep(1,0),this.writeInt8(t)}addInt16(t){this.prep(2,0),this.writeInt16(t)}addInt32(t){this.prep(4,0),this.writeInt32(t)}addInt64(t){this.prep(8,0),this.writeInt64(t)}addFloat32(t){this.prep(4,0),this.writeFloat32(t)}addFloat64(t){this.prep(8,0),this.writeFloat64(t)}addFieldInt8(t,e,i){(this.force_defaults||e!=i)&&(this.addInt8(e),this.slot(t))}addFieldInt16(t,e,i){(this.force_defaults||e!=i)&&(this.addInt16(e),this.slot(t))}addFieldInt32(t,e,i){(this.force_defaults||e!=i)&&(this.addInt32(e),this.slot(t))}addFieldInt64(t,e,i){(this.force_defaults||!e.equals(i))&&(this.addInt64(e),this.slot(t))}addFieldFloat32(t,e,i){(this.force_defaults||e!=i)&&(this.addFloat32(e),this.slot(t))}addFieldFloat64(t,e,i){(this.force_defaults||e!=i)&&(this.addFloat64(e),this.slot(t))}addFieldOffset(t,e,i){(this.force_defaults||e!=i)&&(this.addOffset(e),this.slot(t))}addFieldStruct(t,e,i){e!=i&&(this.nested(e),this.slot(t))}nested(t){if(t!=this.offset())throw new Error("FlatBuffers: struct must be serialized inline.")}notNested(){if(this.isNested)throw new Error("FlatBuffers: object serialization must not be nested.")}slot(t){this.vtable!==null&&(this.vtable[t]=this.offset())}offset(){return this.bb.capacity()-this.space}static growByteBuffer(t){const e=t.capacity();if(e&3221225472)throw new Error("FlatBuffers: cannot grow buffer beyond 2 gigabytes.");const i=e<<1,n=df.allocate(i);return n.setPosition(i-e),n.bytes().set(t.bytes(),i-e),n}addOffset(t){this.prep(Io,0),this.writeInt32(this.offset()-t+Io)}startObject(t){this.notNested(),this.vtable==null&&(this.vtable=[]),this.vtable_in_use=t;for(let e=0;e<t;e++)this.vtable[e]=0;this.isNested=!0,this.object_start=this.offset()}endObject(){if(this.vtable==null||!this.isNested)throw new Error("FlatBuffers: endObject called without startObject");this.addInt32(0);const t=this.offset();let e=this.vtable_in_use-1;for(;e>=0&&this.vtable[e]==0;e--);const i=e+1;for(;e>=0;e--)this.addInt16(this.vtable[e]!=0?t-this.vtable[e]:0);const n=2;this.addInt16(t-this.object_start);const o=(i+n)*Ky;this.addInt16(o);let r=0;const l=this.space;e:for(e=0;e<this.vtables.length;e++){const c=this.bb.capacity()-this.vtables[e];if(o==this.bb.readInt16(c)){for(let h=Ky;h<o;h+=Ky)if(this.bb.readInt16(l+h)!=this.bb.readInt16(c+h))continue e;r=this.vtables[e];break}}return r?(this.space=this.bb.capacity()-t,this.bb.writeInt32(this.space,r-t)):(this.vtables.push(this.offset()),this.bb.writeInt32(this.bb.capacity()-t,this.offset()-t)),this.isNested=!1,t}finish(t,e,i){const n=i?H0:0;if(e){const o=e;if(this.prep(this.minalign,Io+Pr+n),o.length!=Pr)throw new Error("FlatBuffers: file identifier must be length "+Pr);for(let r=Pr-1;r>=0;r--)this.writeInt8(o.charCodeAt(r))}this.prep(this.minalign,Io+n),this.addOffset(t),n&&this.addInt32(this.bb.capacity()-this.space),this.bb.setPosition(this.space)}finishSizePrefixed(t,e){this.finish(t,e,!0)}requiredField(t,e){const i=this.bb.capacity()-t,n=i-this.bb.readInt32(i);if(!(this.bb.readInt16(n+e)!=0))throw new Error("FlatBuffers: field "+e+" must be set")}startVector(t,e,i){this.notNested(),this.vector_num_elems=e,this.prep(Io,t*e),this.prep(i,t*e)}endVector(){return this.writeInt32(this.vector_num_elems),this.offset()}createSharedString(t){if(!t)return 0;if(this.string_maps||(this.string_maps=new Map),this.string_maps.has(t))return this.string_maps.get(t);const e=this.createString(t);return this.string_maps.set(t,e),e}createString(t){if(!t)return 0;let e;if(t instanceof Uint8Array)e=t;else{e=[];let i=0;for(;i<t.length;){let n;const o=t.charCodeAt(i++);if(o<55296||o>=56320)n=o;else{const r=t.charCodeAt(i++);n=(o<<10)+r+(65536-56623104-56320)}n<128?e.push(n):(n<2048?e.push(n>>6&31|192):(n<65536?e.push(n>>12&15|224):e.push(n>>18&7|240,n>>12&63|128),e.push(n>>6&63|128)),e.push(n&63|128))}}this.addInt8(0),this.startVector(1,e.length,1),this.bb.setPosition(this.space-=e.length);for(let i=0,n=this.space,o=this.bb.bytes();i<e.length;i++)o[n++]=e[i];return this.endVector()}createLong(t,e){return Lr.create(t,e)}createObjectOffset(t){return t===null?0:typeof t=="string"?this.createString(t):t.pack(this)}createObjectOffsetList(t){const e=[];for(let i=0;i<t.length;++i){const n=t[i];if(n!==null)e.push(this.createObjectOffset(n));else throw new Error("FlatBuffers: Argument for createObjectOffsetList cannot contain null.")}return e}createStructOffsetList(t,e){return e(this,t.length),this.createObjectOffsetList(t),this.endVector()}}const V1={};function W1(s,t){V1[s]=t}function XM(s){const t=s.getBufferIdentifier(),e=V1[t];return e(s)}function QM(s){return typeof s.guid=="function"?s.guid():null}function Ig(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var H1={exports:{}};(function(s){var t={};t.useBlobBuilder=function(){try{return new Blob([]),!1}catch{return!0}}(),t.useArrayBufferView=!t.useBlobBuilder&&function(){try{return new Blob([new Uint8Array([])]).size===0}catch{return!0}}(),s.exports.binaryFeatures=t;var e=s.exports.BlobBuilder;typeof window<"u"&&(e=s.exports.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder);function i(){this._pieces=[],this._parts=[]}i.prototype.append=function(n){typeof n=="number"?this._pieces.push(n):(this.flush(),this._parts.push(n))},i.prototype.flush=function(){if(this._pieces.length>0){var n=new Uint8Array(this._pieces);t.useArrayBufferView||(n=n.buffer),this._parts.push(n),this._pieces=[]}},i.prototype.getBuffer=function(){if(this.flush(),t.useBlobBuilder){for(var n=new e,o=0,r=this._parts.length;o<r;o++)n.append(this._parts[o]);return n.getBlob()}else return new Blob(this._parts)},s.exports.BufferBuilder=i})(H1);var G1=H1.exports,YM=G1.BufferBuilder,bw=G1.binaryFeatures,KM={unpack:function(s){var t=new Ai(s);return t.unpack()},pack:function(s){var t=new Ii;t.pack(s);var e=t.getBuffer();return e}},ZM=KM;function Ai(s){this.index=0,this.dataBuffer=s,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}Ai.prototype.unpack=function(){var s=this.unpack_uint8();if(s<128)return s;if((s^224)<32)return(s^224)-32;var t;if((t=s^160)<=15)return this.unpack_raw(t);if((t=s^176)<=15)return this.unpack_string(t);if((t=s^144)<=15)return this.unpack_array(t);if((t=s^128)<=15)return this.unpack_map(t);switch(s){case 192:return null;case 193:return;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:return;case 213:return;case 214:return;case 215:return;case 216:return t=this.unpack_uint16(),this.unpack_string(t);case 217:return t=this.unpack_uint32(),this.unpack_string(t);case 218:return t=this.unpack_uint16(),this.unpack_raw(t);case 219:return t=this.unpack_uint32(),this.unpack_raw(t);case 220:return t=this.unpack_uint16(),this.unpack_array(t);case 221:return t=this.unpack_uint32(),this.unpack_array(t);case 222:return t=this.unpack_uint16(),this.unpack_map(t);case 223:return t=this.unpack_uint32(),this.unpack_map(t)}};Ai.prototype.unpack_uint8=function(){var s=this.dataView[this.index]&255;return this.index++,s};Ai.prototype.unpack_uint16=function(){var s=this.read(2),t=(s[0]&255)*256+(s[1]&255);return this.index+=2,t};Ai.prototype.unpack_uint32=function(){var s=this.read(4),t=((s[0]*256+s[1])*256+s[2])*256+s[3];return this.index+=4,t};Ai.prototype.unpack_uint64=function(){var s=this.read(8),t=((((((s[0]*256+s[1])*256+s[2])*256+s[3])*256+s[4])*256+s[5])*256+s[6])*256+s[7];return this.index+=8,t};Ai.prototype.unpack_int8=function(){var s=this.unpack_uint8();return s<128?s:s-256};Ai.prototype.unpack_int16=function(){var s=this.unpack_uint16();return s<32768?s:s-65536};Ai.prototype.unpack_int32=function(){var s=this.unpack_uint32();return s<Math.pow(2,31)?s:s-Math.pow(2,32)};Ai.prototype.unpack_int64=function(){var s=this.unpack_uint64();return s<Math.pow(2,63)?s:s-Math.pow(2,64)};Ai.prototype.unpack_raw=function(s){if(this.length<this.index+s)throw new Error("BinaryPackFailure: index is out of range "+this.index+" "+s+" "+this.length);var t=this.dataBuffer.slice(this.index,this.index+s);return this.index+=s,t};Ai.prototype.unpack_string=function(s){for(var t=this.read(s),e=0,i="",n,o;e<s;)n=t[e],n<128?(i+=String.fromCharCode(n),e++):(n^192)<32?(o=(n^192)<<6|t[e+1]&63,i+=String.fromCharCode(o),e+=2):(o=(n&15)<<12|(t[e+1]&63)<<6|t[e+2]&63,i+=String.fromCharCode(o),e+=3);return this.index+=s,i};Ai.prototype.unpack_array=function(s){for(var t=new Array(s),e=0;e<s;e++)t[e]=this.unpack();return t};Ai.prototype.unpack_map=function(s){for(var t={},e=0;e<s;e++){var i=this.unpack(),n=this.unpack();t[i]=n}return t};Ai.prototype.unpack_float=function(){var s=this.unpack_uint32(),t=s>>31,e=(s>>23&255)-127,i=s&8388607|8388608;return(t===0?1:-1)*i*Math.pow(2,e-23)};Ai.prototype.unpack_double=function(){var s=this.unpack_uint32(),t=this.unpack_uint32(),e=s>>31,i=(s>>20&2047)-1023,n=s&1048575|1048576,o=n*Math.pow(2,i-20)+t*Math.pow(2,i-52);return(e===0?1:-1)*o};Ai.prototype.read=function(s){var t=this.index;if(t+s<=this.length)return this.dataView.subarray(t,t+s);throw new Error("BinaryPackFailure: read index out of range")};function Ii(){this.bufferBuilder=new YM}Ii.prototype.getBuffer=function(){return this.bufferBuilder.getBuffer()};Ii.prototype.pack=function(s){var t=typeof s;if(t==="string")this.pack_string(s);else if(t==="number")Math.floor(s)===s?this.pack_integer(s):this.pack_double(s);else if(t==="boolean")s===!0?this.bufferBuilder.append(195):s===!1&&this.bufferBuilder.append(194);else if(t==="undefined")this.bufferBuilder.append(192);else if(t==="object")if(s===null)this.bufferBuilder.append(192);else{var e=s.constructor;if(e==Array)this.pack_array(s);else if(e==Blob||e==File||s instanceof Blob||s instanceof File)this.pack_bin(s);else if(e==ArrayBuffer)bw.useArrayBufferView?this.pack_bin(new Uint8Array(s)):this.pack_bin(s);else if("BYTES_PER_ELEMENT"in s)bw.useArrayBufferView?this.pack_bin(new Uint8Array(s.buffer)):this.pack_bin(s.buffer);else if(e==Object||e.toString().startsWith("class"))this.pack_object(s);else if(e==Date)this.pack_string(s.toString());else if(typeof s.toBinaryPack=="function")this.bufferBuilder.append(s.toBinaryPack());else throw new Error('Type "'+e.toString()+'" not yet supported')}else throw new Error('Type "'+t+'" not yet supported');this.bufferBuilder.flush()};Ii.prototype.pack_bin=function(s){var t=s.length||s.byteLength||s.size;if(t<=15)this.pack_uint8(160+t);else if(t<=65535)this.bufferBuilder.append(218),this.pack_uint16(t);else if(t<=4294967295)this.bufferBuilder.append(219),this.pack_uint32(t);else throw new Error("Invalid length");this.bufferBuilder.append(s)};Ii.prototype.pack_string=function(s){var t=eA(s);if(t<=15)this.pack_uint8(176+t);else if(t<=65535)this.bufferBuilder.append(216),this.pack_uint16(t);else if(t<=4294967295)this.bufferBuilder.append(217),this.pack_uint32(t);else throw new Error("Invalid length");this.bufferBuilder.append(s)};Ii.prototype.pack_array=function(s){var t=s.length;if(t<=15)this.pack_uint8(144+t);else if(t<=65535)this.bufferBuilder.append(220),this.pack_uint16(t);else if(t<=4294967295)this.bufferBuilder.append(221),this.pack_uint32(t);else throw new Error("Invalid length");for(var e=0;e<t;e++)this.pack(s[e])};Ii.prototype.pack_integer=function(s){if(s>=-32&&s<=127)this.bufferBuilder.append(s&255);else if(s>=0&&s<=255)this.bufferBuilder.append(204),this.pack_uint8(s);else if(s>=-128&&s<=127)this.bufferBuilder.append(208),this.pack_int8(s);else if(s>=0&&s<=65535)this.bufferBuilder.append(205),this.pack_uint16(s);else if(s>=-32768&&s<=32767)this.bufferBuilder.append(209),this.pack_int16(s);else if(s>=0&&s<=4294967295)this.bufferBuilder.append(206),this.pack_uint32(s);else if(s>=-2147483648&&s<=2147483647)this.bufferBuilder.append(210),this.pack_int32(s);else if(s>=-9223372036854776e3&&s<=9223372036854776e3)this.bufferBuilder.append(211),this.pack_int64(s);else if(s>=0&&s<=18446744073709552e3)this.bufferBuilder.append(207),this.pack_uint64(s);else throw new Error("Invalid integer")};Ii.prototype.pack_double=function(s){var t=0;s<0&&(t=1,s=-s);var e=Math.floor(Math.log(s)/Math.LN2),i=s/Math.pow(2,e)-1,n=Math.floor(i*Math.pow(2,52)),o=Math.pow(2,32),r=t<<31|e+1023<<20|n/o&1048575,l=n%o;this.bufferBuilder.append(203),this.pack_int32(r),this.pack_int32(l)};Ii.prototype.pack_object=function(s){var t=Object.keys(s),e=t.length;if(e<=15)this.pack_uint8(128+e);else if(e<=65535)this.bufferBuilder.append(222),this.pack_uint16(e);else if(e<=4294967295)this.bufferBuilder.append(223),this.pack_uint32(e);else throw new Error("Invalid length");for(var i in s)s.hasOwnProperty(i)&&(this.pack(i),this.pack(s[i]))};Ii.prototype.pack_uint8=function(s){this.bufferBuilder.append(s)};Ii.prototype.pack_uint16=function(s){this.bufferBuilder.append(s>>8),this.bufferBuilder.append(s&255)};Ii.prototype.pack_uint32=function(s){var t=s&4294967295;this.bufferBuilder.append((t&4278190080)>>>24),this.bufferBuilder.append((t&16711680)>>>16),this.bufferBuilder.append((t&65280)>>>8),this.bufferBuilder.append(t&255)};Ii.prototype.pack_uint64=function(s){var t=s/Math.pow(2,32),e=s%Math.pow(2,32);this.bufferBuilder.append((t&4278190080)>>>24),this.bufferBuilder.append((t&16711680)>>>16),this.bufferBuilder.append((t&65280)>>>8),this.bufferBuilder.append(t&255),this.bufferBuilder.append((e&4278190080)>>>24),this.bufferBuilder.append((e&16711680)>>>16),this.bufferBuilder.append((e&65280)>>>8),this.bufferBuilder.append(e&255)};Ii.prototype.pack_int8=function(s){this.bufferBuilder.append(s&255)};Ii.prototype.pack_int16=function(s){this.bufferBuilder.append((s&65280)>>8),this.bufferBuilder.append(s&255)};Ii.prototype.pack_int32=function(s){this.bufferBuilder.append(s>>>24&255),this.bufferBuilder.append((s&16711680)>>>16),this.bufferBuilder.append((s&65280)>>>8),this.bufferBuilder.append(s&255)};Ii.prototype.pack_int64=function(s){var t=Math.floor(s/Math.pow(2,32)),e=s%Math.pow(2,32);this.bufferBuilder.append((t&4278190080)>>>24),this.bufferBuilder.append((t&16711680)>>>16),this.bufferBuilder.append((t&65280)>>>8),this.bufferBuilder.append(t&255),this.bufferBuilder.append((e&4278190080)>>>24),this.bufferBuilder.append((e&16711680)>>>16),this.bufferBuilder.append((e&65280)>>>8),this.bufferBuilder.append(e&255)};function JM(s){var t=s.charCodeAt(0);return t<=2047?"00":t<=65535?"000":t<=2097151?"0000":t<=67108863?"00000":"000000"}function eA(s){return s.length>600?new Blob([s]).size:s.replace(/[^\u0000-\u007F]/g,JM).length}const _w=Ig(ZM);let q1=!0,X1=!0;function ru(s,t,e){const i=s.match(t);return i&&i.length>=e&&parseInt(i[e],10)}function ad(s,t,e){if(!s.RTCPeerConnection)return;const i=s.RTCPeerConnection.prototype,n=i.addEventListener;i.addEventListener=function(r,l){if(r!==t)return n.apply(this,arguments);const c=h=>{const d=e(h);d&&(l.handleEvent?l.handleEvent(d):l(d))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(l,c),n.apply(this,[r,c])};const o=i.removeEventListener;i.removeEventListener=function(r,l){if(r!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(l))return o.apply(this,arguments);const c=this._eventMap[t].get(l);return this._eventMap[t].delete(l),this._eventMap[t].size===0&&delete this._eventMap[t],Object.keys(this._eventMap).length===0&&delete this._eventMap,o.apply(this,[r,c])},Object.defineProperty(i,"on"+t,{get(){return this["_on"+t]},set(r){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),r&&this.addEventListener(t,this["_on"+t]=r)},enumerable:!0,configurable:!0})}function tA(s){return typeof s!="boolean"?new Error("Argument type: "+typeof s+". Please use a boolean."):(q1=s,s?"adapter.js logging disabled":"adapter.js logging enabled")}function iA(s){return typeof s!="boolean"?new Error("Argument type: "+typeof s+". Please use a boolean."):(X1=!s,"adapter.js deprecation warnings "+(s?"disabled":"enabled"))}function G0(){if(typeof window=="object"){if(q1)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function Lg(s,t){X1&&console.warn(s+" is deprecated, please use "+t+" instead.")}function nA(s){const t={browser:null,version:null};if(typeof s>"u"||!s.navigator)return t.browser="Not a browser.",t;const{navigator:e}=s;if(e.mozGetUserMedia)t.browser="firefox",t.version=ru(e.userAgent,/Firefox\/(\d+)\./,1);else if(e.webkitGetUserMedia||s.isSecureContext===!1&&s.webkitRTCPeerConnection&&!s.RTCIceGatherer)t.browser="chrome",t.version=ru(e.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(e.mediaDevices&&e.userAgent.match(/Edge\/(\d+).(\d+)$/))t.browser="edge",t.version=ru(e.userAgent,/Edge\/(\d+).(\d+)$/,2);else if(s.RTCPeerConnection&&e.userAgent.match(/AppleWebKit\/(\d+)\./))t.browser="safari",t.version=ru(e.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=s.RTCRtpTransceiver&&"currentDirection"in s.RTCRtpTransceiver.prototype;else return t.browser="Not a supported browser.",t;return t}function vw(s){return Object.prototype.toString.call(s)==="[object Object]"}function Q1(s){return vw(s)?Object.keys(s).reduce(function(t,e){const i=vw(s[e]),n=i?Q1(s[e]):s[e],o=i&&!Object.keys(n).length;return n===void 0||o?t:Object.assign(t,{[e]:n})},{}):s}function v_(s,t,e){!t||e.has(t.id)||(e.set(t.id,t),Object.keys(t).forEach(i=>{i.endsWith("Id")?v_(s,s.get(t[i]),e):i.endsWith("Ids")&&t[i].forEach(n=>{v_(s,s.get(n),e)})}))}function xw(s,t,e){const i=e?"outbound-rtp":"inbound-rtp",n=new Map;if(t===null)return n;const o=[];return s.forEach(r=>{r.type==="track"&&r.trackIdentifier===t.id&&o.push(r)}),o.forEach(r=>{s.forEach(l=>{l.type===i&&l.trackId===r.id&&v_(s,l,n)})}),n}const ww=G0;function Y1(s,t){var l;const e=s&&s.navigator;if(!e.mediaDevices)return;const i=function(c){if(typeof c!="object"||c.mandatory||c.optional)return c;const h={};return Object.keys(c).forEach(d=>{if(d==="require"||d==="advanced"||d==="mediaSource")return;const u=typeof c[d]=="object"?c[d]:{ideal:c[d]};u.exact!==void 0&&typeof u.exact=="number"&&(u.min=u.max=u.exact);const f=function(p,b){return p?p+b.charAt(0).toUpperCase()+b.slice(1):b==="deviceId"?"sourceId":b};if(u.ideal!==void 0){h.optional=h.optional||[];let p={};typeof u.ideal=="number"?(p[f("min",d)]=u.ideal,h.optional.push(p),p={},p[f("max",d)]=u.ideal,h.optional.push(p)):(p[f("",d)]=u.ideal,h.optional.push(p))}u.exact!==void 0&&typeof u.exact!="number"?(h.mandatory=h.mandatory||{},h.mandatory[f("",d)]=u.exact):["min","max"].forEach(p=>{u[p]!==void 0&&(h.mandatory=h.mandatory||{},h.mandatory[f(p,d)]=u[p])})}),c.advanced&&(h.optional=(h.optional||[]).concat(c.advanced)),h},n=function(c,h){if(t.version>=61)return h(c);if(c=JSON.parse(JSON.stringify(c)),c&&typeof c.audio=="object"){const d=function(u,f,p){f in u&&!(p in u)&&(u[p]=u[f],delete u[f])};c=JSON.parse(JSON.stringify(c)),d(c.audio,"autoGainControl","googAutoGainControl"),d(c.audio,"noiseSuppression","googNoiseSuppression"),c.audio=i(c.audio)}if(c&&typeof c.video=="object"){let d=c.video.facingMode;d=d&&(typeof d=="object"?d:{ideal:d});const u=t.version<66;if(d&&(d.exact==="user"||d.exact==="environment"||d.ideal==="user"||d.ideal==="environment")&&!(e.mediaDevices.getSupportedConstraints&&e.mediaDevices.getSupportedConstraints().facingMode&&!u)){delete c.video.facingMode;let f;if(d.exact==="environment"||d.ideal==="environment"?f=["back","rear"]:(d.exact==="user"||d.ideal==="user")&&(f=["front"]),f)return e.mediaDevices.enumerateDevices().then(p=>{p=p.filter(x=>x.kind==="videoinput");let b=p.find(x=>f.some(v=>x.label.toLowerCase().includes(v)));return!b&&p.length&&f.includes("back")&&(b=p[p.length-1]),b&&(c.video.deviceId=d.exact?{exact:b.deviceId}:{ideal:b.deviceId}),c.video=i(c.video),ww("chrome: "+JSON.stringify(c)),h(c)})}c.video=i(c.video)}return ww("chrome: "+JSON.stringify(c)),h(c)},o=function(c){return t.version>=64?c:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[c.name]||c.name,message:c.message,constraint:c.constraint||c.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},r=function(c,h,d){n(c,u=>{e.webkitGetUserMedia(u,h,f=>{d&&d(o(f))})})};if(e.getUserMedia=r.bind(e),e.mediaDevices.getUserMedia){const c=e.mediaDevices.getUserMedia.bind(e.mediaDevices);(l=Object.getOwnPropertyDescriptor(e.mediaDevices,"getUserMedia"))!=null&&l.writable&&(e.mediaDevices.getUserMedia=function(h){return n(h,d=>c(d).then(u=>{if(d.audio&&!u.getAudioTracks().length||d.video&&!u.getVideoTracks().length)throw u.getTracks().forEach(f=>{f.stop()}),new DOMException("","NotFoundError");return u},u=>Promise.reject(o(u))))})}}function sA(s,t){if(!(s.navigator.mediaDevices&&"getDisplayMedia"in s.navigator.mediaDevices)&&s.navigator.mediaDevices){if(typeof t!="function"){console.error("shimGetDisplayMedia: getSourceId argument is not a function");return}s.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then(n=>{const o=i.video&&i.video.width,r=i.video&&i.video.height,l=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:n,maxFrameRate:l||3}},o&&(i.video.mandatory.maxWidth=o),r&&(i.video.mandatory.maxHeight=r),s.navigator.mediaDevices.getUserMedia(i)})}}}function K1(s){s.MediaStream=s.MediaStream||s.webkitMediaStream}function Z1(s){if(typeof s=="object"&&s.RTCPeerConnection&&!("ontrack"in s.RTCPeerConnection.prototype)){Object.defineProperty(s.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=i=>{i.stream.addEventListener("addtrack",n=>{let o;s.RTCPeerConnection.prototype.getReceivers?o=this.getReceivers().find(l=>l.track&&l.track.id===n.track.id):o={track:n.track};const r=new Event("track");r.track=n.track,r.receiver=o,r.transceiver={receiver:o},r.streams=[i.stream],this.dispatchEvent(r)}),i.stream.getTracks().forEach(n=>{let o;s.RTCPeerConnection.prototype.getReceivers?o=this.getReceivers().find(l=>l.track&&l.track.id===n.id):o={track:n};const r=new Event("track");r.track=n,r.receiver=o,r.transceiver={receiver:o},r.streams=[i.stream],this.dispatchEvent(r)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else ad(s,"track",t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t))}function J1(s){if(typeof s=="object"&&s.RTCPeerConnection&&!("getSenders"in s.RTCPeerConnection.prototype)&&"createDTMFSender"in s.RTCPeerConnection.prototype){const t=function(n,o){return{track:o,get dtmf(){return this._dtmf===void 0&&(o.kind==="audio"?this._dtmf=n.createDTMFSender(o):this._dtmf=null),this._dtmf},_pc:n}};if(!s.RTCPeerConnection.prototype.getSenders){s.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const n=s.RTCPeerConnection.prototype.addTrack;s.RTCPeerConnection.prototype.addTrack=function(l,c){let h=n.apply(this,arguments);return h||(h=t(this,l),this._senders.push(h)),h};const o=s.RTCPeerConnection.prototype.removeTrack;s.RTCPeerConnection.prototype.removeTrack=function(l){o.apply(this,arguments);const c=this._senders.indexOf(l);c!==-1&&this._senders.splice(c,1)}}const e=s.RTCPeerConnection.prototype.addStream;s.RTCPeerConnection.prototype.addStream=function(o){this._senders=this._senders||[],e.apply(this,[o]),o.getTracks().forEach(r=>{this._senders.push(t(this,r))})};const i=s.RTCPeerConnection.prototype.removeStream;s.RTCPeerConnection.prototype.removeStream=function(o){this._senders=this._senders||[],i.apply(this,[o]),o.getTracks().forEach(r=>{const l=this._senders.find(c=>c.track===r);l&&this._senders.splice(this._senders.indexOf(l),1)})}}else if(typeof s=="object"&&s.RTCPeerConnection&&"getSenders"in s.RTCPeerConnection.prototype&&"createDTMFSender"in s.RTCPeerConnection.prototype&&s.RTCRtpSender&&!("dtmf"in s.RTCRtpSender.prototype)){const t=s.RTCPeerConnection.prototype.getSenders;s.RTCPeerConnection.prototype.getSenders=function(){const i=t.apply(this,[]);return i.forEach(n=>n._pc=this),i},Object.defineProperty(s.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function eP(s){if(!s.RTCPeerConnection)return;const t=s.RTCPeerConnection.prototype.getStats;s.RTCPeerConnection.prototype.getStats=function(){const[i,n,o]=arguments;if(arguments.length>0&&typeof i=="function")return t.apply(this,arguments);if(t.length===0&&(arguments.length===0||typeof i!="function"))return t.apply(this,[]);const r=function(c){const h={};return c.result().forEach(u=>{const f={id:u.id,timestamp:u.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[u.type]||u.type};u.names().forEach(p=>{f[p]=u.stat(p)}),h[f.id]=f}),h},l=function(c){return new Map(Object.keys(c).map(h=>[h,c[h]]))};if(arguments.length>=2){const c=function(h){n(l(r(h)))};return t.apply(this,[c,i])}return new Promise((c,h)=>{t.apply(this,[function(d){c(l(r(d)))},h])}).then(n,o)}}function tP(s){if(!(typeof s=="object"&&s.RTCPeerConnection&&s.RTCRtpSender&&s.RTCRtpReceiver))return;if(!("getStats"in s.RTCRtpSender.prototype)){const e=s.RTCPeerConnection.prototype.getSenders;e&&(s.RTCPeerConnection.prototype.getSenders=function(){const o=e.apply(this,[]);return o.forEach(r=>r._pc=this),o});const i=s.RTCPeerConnection.prototype.addTrack;i&&(s.RTCPeerConnection.prototype.addTrack=function(){const o=i.apply(this,arguments);return o._pc=this,o}),s.RTCRtpSender.prototype.getStats=function(){const o=this;return this._pc.getStats().then(r=>xw(r,o.track,!0))}}if(!("getStats"in s.RTCRtpReceiver.prototype)){const e=s.RTCPeerConnection.prototype.getReceivers;e&&(s.RTCPeerConnection.prototype.getReceivers=function(){const n=e.apply(this,[]);return n.forEach(o=>o._pc=this),n}),ad(s,"track",i=>(i.receiver._pc=i.srcElement,i)),s.RTCRtpReceiver.prototype.getStats=function(){const n=this;return this._pc.getStats().then(o=>xw(o,n.track,!1))}}if(!("getStats"in s.RTCRtpSender.prototype&&"getStats"in s.RTCRtpReceiver.prototype))return;const t=s.RTCPeerConnection.prototype.getStats;s.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof s.MediaStreamTrack){const i=arguments[0];let n,o,r;return this.getSenders().forEach(l=>{l.track===i&&(n?r=!0:n=l)}),this.getReceivers().forEach(l=>(l.track===i&&(o?r=!0:o=l),l.track===i)),r||n&&o?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):n?n.getStats():o?o.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function iP(s){s.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(r=>this._shimmedLocalStreams[r][0])};const t=s.RTCPeerConnection.prototype.addTrack;s.RTCPeerConnection.prototype.addTrack=function(r,l){if(!l)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const c=t.apply(this,arguments);return this._shimmedLocalStreams[l.id]?this._shimmedLocalStreams[l.id].indexOf(c)===-1&&this._shimmedLocalStreams[l.id].push(c):this._shimmedLocalStreams[l.id]=[l,c],c};const e=s.RTCPeerConnection.prototype.addStream;s.RTCPeerConnection.prototype.addStream=function(r){this._shimmedLocalStreams=this._shimmedLocalStreams||{},r.getTracks().forEach(h=>{if(this.getSenders().find(u=>u.track===h))throw new DOMException("Track already exists.","InvalidAccessError")});const l=this.getSenders();e.apply(this,arguments);const c=this.getSenders().filter(h=>l.indexOf(h)===-1);this._shimmedLocalStreams[r.id]=[r].concat(c)};const i=s.RTCPeerConnection.prototype.removeStream;s.RTCPeerConnection.prototype.removeStream=function(r){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[r.id],i.apply(this,arguments)};const n=s.RTCPeerConnection.prototype.removeTrack;s.RTCPeerConnection.prototype.removeTrack=function(r){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},r&&Object.keys(this._shimmedLocalStreams).forEach(l=>{const c=this._shimmedLocalStreams[l].indexOf(r);c!==-1&&this._shimmedLocalStreams[l].splice(c,1),this._shimmedLocalStreams[l].length===1&&delete this._shimmedLocalStreams[l]}),n.apply(this,arguments)}}function nP(s,t){if(!s.RTCPeerConnection)return;if(s.RTCPeerConnection.prototype.addTrack&&t.version>=65)return iP(s);const e=s.RTCPeerConnection.prototype.getLocalStreams;s.RTCPeerConnection.prototype.getLocalStreams=function(){const d=e.apply(this);return this._reverseStreams=this._reverseStreams||{},d.map(u=>this._reverseStreams[u.id])};const i=s.RTCPeerConnection.prototype.addStream;s.RTCPeerConnection.prototype.addStream=function(d){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},d.getTracks().forEach(u=>{if(this.getSenders().find(p=>p.track===u))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[d.id]){const u=new s.MediaStream(d.getTracks());this._streams[d.id]=u,this._reverseStreams[u.id]=d,d=u}i.apply(this,[d])};const n=s.RTCPeerConnection.prototype.removeStream;s.RTCPeerConnection.prototype.removeStream=function(d){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},n.apply(this,[this._streams[d.id]||d]),delete this._reverseStreams[this._streams[d.id]?this._streams[d.id].id:d.id],delete this._streams[d.id]},s.RTCPeerConnection.prototype.addTrack=function(d,u){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const f=[].slice.call(arguments,1);if(f.length!==1||!f[0].getTracks().find(x=>x===d))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(x=>x.track===d))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const b=this._streams[u.id];if(b)b.addTrack(d),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const x=new s.MediaStream([d]);this._streams[u.id]=x,this._reverseStreams[x.id]=u,this.addStream(x)}return this.getSenders().find(x=>x.track===d)};function o(h,d){let u=d.sdp;return Object.keys(h._reverseStreams||[]).forEach(f=>{const p=h._reverseStreams[f],b=h._streams[p.id];u=u.replace(new RegExp(b.id,"g"),p.id)}),new RTCSessionDescription({type:d.type,sdp:u})}function r(h,d){let u=d.sdp;return Object.keys(h._reverseStreams||[]).forEach(f=>{const p=h._reverseStreams[f],b=h._streams[p.id];u=u.replace(new RegExp(p.id,"g"),b.id)}),new RTCSessionDescription({type:d.type,sdp:u})}["createOffer","createAnswer"].forEach(function(h){const d=s.RTCPeerConnection.prototype[h],u={[h](){const f=arguments;return arguments.length&&typeof arguments[0]=="function"?d.apply(this,[b=>{const x=o(this,b);f[0].apply(null,[x])},b=>{f[1]&&f[1].apply(null,b)},arguments[2]]):d.apply(this,arguments).then(b=>o(this,b))}};s.RTCPeerConnection.prototype[h]=u[h]});const l=s.RTCPeerConnection.prototype.setLocalDescription;s.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?l.apply(this,arguments):(arguments[0]=r(this,arguments[0]),l.apply(this,arguments))};const c=Object.getOwnPropertyDescriptor(s.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(s.RTCPeerConnection.prototype,"localDescription",{get(){const h=c.get.apply(this);return h.type===""?h:o(this,h)}}),s.RTCPeerConnection.prototype.removeTrack=function(d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!d._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(d._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let f;Object.keys(this._streams).forEach(p=>{this._streams[p].getTracks().find(x=>d.track===x)&&(f=this._streams[p])}),f&&(f.getTracks().length===1?this.removeStream(this._reverseStreams[f.id]):f.removeTrack(d.track),this.dispatchEvent(new Event("negotiationneeded")))}}function x_(s,t){!s.RTCPeerConnection&&s.webkitRTCPeerConnection&&(s.RTCPeerConnection=s.webkitRTCPeerConnection),s.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){const i=s.RTCPeerConnection.prototype[e],n={[e](){return arguments[0]=new(e==="addIceCandidate"?s.RTCIceCandidate:s.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};s.RTCPeerConnection.prototype[e]=n[e]})}function sP(s,t){ad(s,"negotiationneeded",e=>{const i=e.target;if(!((t.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")&&i.signalingState!=="stable"))return e})}const Sw=Object.freeze(Object.defineProperty({__proto__:null,fixNegotiationNeeded:sP,shimAddTrackRemoveTrack:nP,shimAddTrackRemoveTrackWithNative:iP,shimGetDisplayMedia:sA,shimGetSendersWithDtmf:J1,shimGetStats:eP,shimGetUserMedia:Y1,shimMediaStream:K1,shimOnTrack:Z1,shimPeerConnection:x_,shimSenderReceiverGetStats:tP},Symbol.toStringTag,{value:"Module"}));function oA(s,t){let e=!1;return s=JSON.parse(JSON.stringify(s)),s.filter(i=>{if(i&&(i.urls||i.url)){let n=i.urls||i.url;i.url&&!i.urls&&Lg("RTCIceServer.url","RTCIceServer.urls");const o=typeof n=="string";return o&&(n=[n]),n=n.filter(r=>{if(r.indexOf("stun:")===0)return!1;const l=r.startsWith("turn")&&!r.startsWith("turn:[")&&r.includes("transport=udp");return l&&!e?(e=!0,!0):l&&!e}),delete i.url,i.urls=o?n[0]:n,!!n.length}})}var oP={exports:{}};(function(s){var t={};t.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split(`
`).map(function(i){return i.trim()})},t.splitSections=function(e){var i=e.split(`
m=`);return i.map(function(n,o){return(o>0?"m="+n:n).trim()+`\r
`})},t.getDescription=function(e){var i=t.splitSections(e);return i&&i[0]},t.getMediaSections=function(e){var i=t.splitSections(e);return i.shift(),i},t.matchPrefix=function(e,i){return t.splitLines(e).filter(function(n){return n.indexOf(i)===0})},t.parseCandidate=function(e){var i;e.indexOf("a=candidate:")===0?i=e.substring(12).split(" "):i=e.substring(10).split(" ");for(var n={foundation:i[0],component:parseInt(i[1],10),protocol:i[2].toLowerCase(),priority:parseInt(i[3],10),ip:i[4],address:i[4],port:parseInt(i[5],10),type:i[7]},o=8;o<i.length;o+=2)switch(i[o]){case"raddr":n.relatedAddress=i[o+1];break;case"rport":n.relatedPort=parseInt(i[o+1],10);break;case"tcptype":n.tcpType=i[o+1];break;case"ufrag":n.ufrag=i[o+1],n.usernameFragment=i[o+1];break;default:n[i[o]]=i[o+1];break}return n},t.writeCandidate=function(e){var i=[];i.push(e.foundation),i.push(e.component),i.push(e.protocol.toUpperCase()),i.push(e.priority),i.push(e.address||e.ip),i.push(e.port);var n=e.type;return i.push("typ"),i.push(n),n!=="host"&&e.relatedAddress&&e.relatedPort&&(i.push("raddr"),i.push(e.relatedAddress),i.push("rport"),i.push(e.relatedPort)),e.tcpType&&e.protocol.toLowerCase()==="tcp"&&(i.push("tcptype"),i.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(i.push("ufrag"),i.push(e.usernameFragment||e.ufrag)),"candidate:"+i.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){var i=e.substr(9).split(" "),n={payloadType:parseInt(i.shift(),10)};return i=i[0].split("/"),n.name=i[0],n.clockRate=parseInt(i[1],10),n.channels=i.length===3?parseInt(i[2],10):1,n.numChannels=n.channels,n},t.writeRtpMap=function(e){var i=e.payloadType;e.preferredPayloadType!==void 0&&(i=e.preferredPayloadType);var n=e.channels||e.numChannels||1;return"a=rtpmap:"+i+" "+e.name+"/"+e.clockRate+(n!==1?"/"+n:"")+`\r
`},t.parseExtmap=function(e){var i=e.substr(9).split(" ");return{id:parseInt(i[0],10),direction:i[0].indexOf("/")>0?i[0].split("/")[1]:"sendrecv",uri:i[1]}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&e.direction!=="sendrecv"?"/"+e.direction:"")+" "+e.uri+`\r
`},t.parseFmtp=function(e){for(var i={},n,o=e.substr(e.indexOf(" ")+1).split(";"),r=0;r<o.length;r++)n=o[r].trim().split("="),i[n[0].trim()]=n[1];return i},t.writeFmtp=function(e){var i="",n=e.payloadType;if(e.preferredPayloadType!==void 0&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var o=[];Object.keys(e.parameters).forEach(function(r){e.parameters[r]?o.push(r+"="+e.parameters[r]):o.push(r)}),i+="a=fmtp:"+n+" "+o.join(";")+`\r
`}return i},t.parseRtcpFb=function(e){var i=e.substr(e.indexOf(" ")+1).split(" ");return{type:i.shift(),parameter:i.join(" ")}},t.writeRtcpFb=function(e){var i="",n=e.payloadType;return e.preferredPayloadType!==void 0&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(o){i+="a=rtcp-fb:"+n+" "+o.type+(o.parameter&&o.parameter.length?" "+o.parameter:"")+`\r
`}),i},t.parseSsrcMedia=function(e){var i=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,i-7),10)},o=e.indexOf(":",i);return o>-1?(n.attribute=e.substr(i+1,o-i-1),n.value=e.substr(o+1)):n.attribute=e.substr(i+1),n},t.parseSsrcGroup=function(e){var i=e.substr(13).split(" ");return{semantics:i.shift(),ssrcs:i.map(function(n){return parseInt(n,10)})}},t.getMid=function(e){var i=t.matchPrefix(e,"a=mid:")[0];if(i)return i.substr(6)},t.parseFingerprint=function(e){var i=e.substr(14).split(" ");return{algorithm:i[0].toLowerCase(),value:i[1]}},t.getDtlsParameters=function(e,i){var n=t.matchPrefix(e+i,"a=fingerprint:");return{role:"auto",fingerprints:n.map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,i){var n="a=setup:"+i+`\r
`;return e.fingerprints.forEach(function(o){n+="a=fingerprint:"+o.algorithm+" "+o.value+`\r
`}),n},t.parseCryptoLine=function(e){var i=e.substr(9).split(" ");return{tag:parseInt(i[0],10),cryptoSuite:i[1],keyParams:i[2],sessionParams:i.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+(typeof e.keyParams=="object"?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+`\r
`},t.parseCryptoKeyParams=function(e){if(e.indexOf("inline:")!==0)return null;var i=e.substr(7).split("|");return{keyMethod:"inline",keySalt:i[0],lifeTime:i[1],mkiValue:i[2]?i[2].split(":")[0]:void 0,mkiLength:i[2]?i[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,i){var n=t.matchPrefix(e+i,"a=crypto:");return n.map(t.parseCryptoLine)},t.getIceParameters=function(e,i){var n=t.matchPrefix(e+i,"a=ice-ufrag:")[0],o=t.matchPrefix(e+i,"a=ice-pwd:")[0];return n&&o?{usernameFragment:n.substr(12),password:o.substr(10)}:null},t.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+`\r
a=ice-pwd:`+e.password+`\r
`},t.parseRtpParameters=function(e){for(var i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=t.splitLines(e),o=n[0].split(" "),r=3;r<o.length;r++){var l=o[r],c=t.matchPrefix(e,"a=rtpmap:"+l+" ")[0];if(c){var h=t.parseRtpMap(c),d=t.matchPrefix(e,"a=fmtp:"+l+" ");switch(h.parameters=d.length?t.parseFmtp(d[0]):{},h.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+l+" ").map(t.parseRtcpFb),i.codecs.push(h),h.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(h.name.toUpperCase());break}}}return t.matchPrefix(e,"a=extmap:").forEach(function(u){i.headerExtensions.push(t.parseExtmap(u))}),i},t.writeRtpDescription=function(e,i){var n="";n+="m="+e+" ",n+=i.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=i.codecs.map(function(r){return r.preferredPayloadType!==void 0?r.preferredPayloadType:r.payloadType}).join(" ")+`\r
`,n+=`c=IN IP4 0.0.0.0\r
`,n+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,i.codecs.forEach(function(r){n+=t.writeRtpMap(r),n+=t.writeFmtp(r),n+=t.writeRtcpFb(r)});var o=0;return i.codecs.forEach(function(r){r.maxptime>o&&(o=r.maxptime)}),o>0&&(n+="a=maxptime:"+o+`\r
`),n+=`a=rtcp-mux\r
`,i.headerExtensions&&i.headerExtensions.forEach(function(r){n+=t.writeExtmap(r)}),n},t.parseRtpEncodingParameters=function(e){var i=[],n=t.parseRtpParameters(e),o=n.fecMechanisms.indexOf("RED")!==-1,r=n.fecMechanisms.indexOf("ULPFEC")!==-1,l=t.matchPrefix(e,"a=ssrc:").map(function(f){return t.parseSsrcMedia(f)}).filter(function(f){return f.attribute==="cname"}),c=l.length>0&&l[0].ssrc,h,d=t.matchPrefix(e,"a=ssrc-group:FID").map(function(f){var p=f.substr(17).split(" ");return p.map(function(b){return parseInt(b,10)})});d.length>0&&d[0].length>1&&d[0][0]===c&&(h=d[0][1]),n.codecs.forEach(function(f){if(f.name.toUpperCase()==="RTX"&&f.parameters.apt){var p={ssrc:c,codecPayloadType:parseInt(f.parameters.apt,10)};c&&h&&(p.rtx={ssrc:h}),i.push(p),o&&(p=JSON.parse(JSON.stringify(p)),p.fec={ssrc:c,mechanism:r?"red+ulpfec":"red"},i.push(p))}}),i.length===0&&c&&i.push({ssrc:c});var u=t.matchPrefix(e,"b=");return u.length&&(u[0].indexOf("b=TIAS:")===0?u=parseInt(u[0].substr(7),10):u[0].indexOf("b=AS:")===0?u=parseInt(u[0].substr(5),10)*1e3*.95-50*40*8:u=void 0,i.forEach(function(f){f.maxBitrate=u})),i},t.parseRtcpParameters=function(e){var i={},n=t.matchPrefix(e,"a=ssrc:").map(function(l){return t.parseSsrcMedia(l)}).filter(function(l){return l.attribute==="cname"})[0];n&&(i.cname=n.value,i.ssrc=n.ssrc);var o=t.matchPrefix(e,"a=rtcp-rsize");i.reducedSize=o.length>0,i.compound=o.length===0;var r=t.matchPrefix(e,"a=rtcp-mux");return i.mux=r.length>0,i},t.parseMsid=function(e){var i,n=t.matchPrefix(e,"a=msid:");if(n.length===1)return i=n[0].substr(7).split(" "),{stream:i[0],track:i[1]};var o=t.matchPrefix(e,"a=ssrc:").map(function(r){return t.parseSsrcMedia(r)}).filter(function(r){return r.attribute==="msid"});if(o.length>0)return i=o[0].value.split(" "),{stream:i[0],track:i[1]}},t.parseSctpDescription=function(e){var i=t.parseMLine(e),n=t.matchPrefix(e,"a=max-message-size:"),o;n.length>0&&(o=parseInt(n[0].substr(19),10)),isNaN(o)&&(o=65536);var r=t.matchPrefix(e,"a=sctp-port:");if(r.length>0)return{port:parseInt(r[0].substr(12),10),protocol:i.fmt,maxMessageSize:o};var l=t.matchPrefix(e,"a=sctpmap:");if(l.length>0){var c=t.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:o}}},t.writeSctpDescription=function(e,i){var n=[];return e.protocol!=="DTLS/SCTP"?n=["m="+e.kind+" 9 "+e.protocol+" "+i.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+i.port+`\r
`]:n=["m="+e.kind+" 9 "+e.protocol+" "+i.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+i.port+" "+i.protocol+` 65535\r
`],i.maxMessageSize!==void 0&&n.push("a=max-message-size:"+i.maxMessageSize+`\r
`),n.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,i,n){var o,r=i!==void 0?i:2;e?o=e:o=t.generateSessionId();var l=n||"thisisadapterortc";return`v=0\r
o=`+l+" "+o+" "+r+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},t.writeMediaSection=function(e,i,n,o){var r=t.writeRtpDescription(e.kind,i);if(r+=t.writeIceParameters(e.iceGatherer.getLocalParameters()),r+=t.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),n==="offer"?"actpass":"active"),r+="a=mid:"+e.mid+`\r
`,e.direction?r+="a="+e.direction+`\r
`:e.rtpSender&&e.rtpReceiver?r+=`a=sendrecv\r
`:e.rtpSender?r+=`a=sendonly\r
`:e.rtpReceiver?r+=`a=recvonly\r
`:r+=`a=inactive\r
`,e.rtpSender){var l="msid:"+o.id+" "+e.rtpSender.track.id+`\r
`;r+="a="+l,r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+l,e.sendEncodingParameters[0].rtx&&(r+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+l,r+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+`\r
`)}return r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+t.localCName+`\r
`,e.rtpSender&&e.sendEncodingParameters[0].rtx&&(r+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+t.localCName+`\r
`),r},t.getDirection=function(e,i){for(var n=t.splitLines(e),o=0;o<n.length;o++)switch(n[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[o].substr(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(e){var i=t.splitLines(e),n=i[0].split(" ");return n[0].substr(2)},t.isRejected=function(e){return e.split(" ",2)[1]==="0"},t.parseMLine=function(e){var i=t.splitLines(e),n=i[0].substr(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},t.parseOLine=function(e){var i=t.matchPrefix(e,"o=")[0],n=i.substr(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},t.isValidSDP=function(e){if(typeof e!="string"||e.length===0)return!1;for(var i=t.splitLines(e),n=0;n<i.length;n++)if(i[n].length<2||i[n].charAt(1)!=="=")return!1;return!0},s.exports=t})(oP);var rP=oP.exports;const Zp=Ig(rP);var be=rP;function rA(s){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[s.type]||s.type}function Cw(s,t,e,i,n){var o=be.writeRtpDescription(s.kind,t);if(o+=be.writeIceParameters(s.iceGatherer.getLocalParameters()),o+=be.writeDtlsParameters(s.dtlsTransport.getLocalParameters(),e==="offer"?"actpass":n||"active"),o+="a=mid:"+s.mid+`\r
`,s.rtpSender&&s.rtpReceiver?o+=`a=sendrecv\r
`:s.rtpSender?o+=`a=sendonly\r
`:s.rtpReceiver?o+=`a=recvonly\r
`:o+=`a=inactive\r
`,s.rtpSender){var r=s.rtpSender._initialTrackId||s.rtpSender.track.id;s.rtpSender._initialTrackId=r;var l="msid:"+(i?i.id:"-")+" "+r+`\r
`;o+="a="+l,o+="a=ssrc:"+s.sendEncodingParameters[0].ssrc+" "+l,s.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+s.sendEncodingParameters[0].rtx.ssrc+" "+l,o+="a=ssrc-group:FID "+s.sendEncodingParameters[0].ssrc+" "+s.sendEncodingParameters[0].rtx.ssrc+`\r
`)}return o+="a=ssrc:"+s.sendEncodingParameters[0].ssrc+" cname:"+be.localCName+`\r
`,s.rtpSender&&s.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+s.sendEncodingParameters[0].rtx.ssrc+" cname:"+be.localCName+`\r
`),o}function aA(s,t){var e=!1;return s=JSON.parse(JSON.stringify(s)),s.filter(function(i){if(i&&(i.urls||i.url)){var n=i.urls||i.url;i.url&&!i.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var o=typeof n=="string";return o&&(n=[n]),n=n.filter(function(r){var l=r.indexOf("turn:")===0&&r.indexOf("transport=udp")!==-1&&r.indexOf("turn:[")===-1&&!e;return l?(e=!0,!0):r.indexOf("stun:")===0&&t>=14393&&r.indexOf("?transport=udp")===-1}),delete i.url,i.urls=o?n[0]:n,!!n.length}})}function pp(s,t){var e={codecs:[],headerExtensions:[],fecMechanisms:[]},i=function(o,r){o=parseInt(o,10);for(var l=0;l<r.length;l++)if(r[l].payloadType===o||r[l].preferredPayloadType===o)return r[l]},n=function(o,r,l,c){var h=i(o.parameters.apt,l),d=i(r.parameters.apt,c);return h&&d&&h.name.toLowerCase()===d.name.toLowerCase()};return s.codecs.forEach(function(o){for(var r=0;r<t.codecs.length;r++){var l=t.codecs[r];if(o.name.toLowerCase()===l.name.toLowerCase()&&o.clockRate===l.clockRate){if(o.name.toLowerCase()==="rtx"&&o.parameters&&l.parameters.apt&&!n(o,l,s.codecs,t.codecs))continue;l=JSON.parse(JSON.stringify(l)),l.numChannels=Math.min(o.numChannels,l.numChannels),e.codecs.push(l),l.rtcpFeedback=l.rtcpFeedback.filter(function(c){for(var h=0;h<o.rtcpFeedback.length;h++)if(o.rtcpFeedback[h].type===c.type&&o.rtcpFeedback[h].parameter===c.parameter)return!0;return!1});break}}}),s.headerExtensions.forEach(function(o){for(var r=0;r<t.headerExtensions.length;r++){var l=t.headerExtensions[r];if(o.uri===l.uri){e.headerExtensions.push(l);break}}}),e}function Pw(s,t,e){return{offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][s].indexOf(e)!==-1}function Zy(s,t){var e=s.getRemoteCandidates().find(function(i){return t.foundation===i.foundation&&t.ip===i.ip&&t.port===i.port&&t.priority===i.priority&&t.protocol===i.protocol&&t.type===i.type});return e||s.addRemoteCandidate(t),!e}function Bi(s,t){var e=new Error(t);return e.name=s,e.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[s],e}var lA=function(s,t){function e(c,h){h.addTrack(c),h.dispatchEvent(new s.MediaStreamTrackEvent("addtrack",{track:c}))}function i(c,h){h.removeTrack(c),h.dispatchEvent(new s.MediaStreamTrackEvent("removetrack",{track:c}))}function n(c,h,d,u){var f=new Event("track");f.track=h,f.receiver=d,f.transceiver={receiver:d},f.streams=u,s.setTimeout(function(){c._dispatchEvent("track",f)})}var o=function(c){var h=this,d=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(f){h[f]=d[f].bind(d)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",c=JSON.parse(JSON.stringify(c||{})),this.usingBundle=c.bundlePolicy==="max-bundle",c.rtcpMuxPolicy==="negotiate")throw Bi("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(c.rtcpMuxPolicy||(c.rtcpMuxPolicy="require"),c.iceTransportPolicy){case"all":case"relay":break;default:c.iceTransportPolicy="all";break}switch(c.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:c.bundlePolicy="balanced";break}if(c.iceServers=aA(c.iceServers||[],t),this._iceGatherers=[],c.iceCandidatePoolSize)for(var u=c.iceCandidatePoolSize;u>0;u--)this._iceGatherers.push(new s.RTCIceGatherer({iceServers:c.iceServers,gatherPolicy:c.iceTransportPolicy}));else c.iceCandidatePoolSize=0;this._config=c,this.transceivers=[],this._sdpSessionId=be.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(o.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(o.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),o.prototype.onicecandidate=null,o.prototype.onaddstream=null,o.prototype.ontrack=null,o.prototype.onremovestream=null,o.prototype.onsignalingstatechange=null,o.prototype.oniceconnectionstatechange=null,o.prototype.onconnectionstatechange=null,o.prototype.onicegatheringstatechange=null,o.prototype.onnegotiationneeded=null,o.prototype.ondatachannel=null,o.prototype._dispatchEvent=function(c,h){this._isClosed||(this.dispatchEvent(h),typeof this["on"+c]=="function"&&this["on"+c](h))},o.prototype._emitGatheringStateChange=function(){var c=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",c)},o.prototype.getConfiguration=function(){return this._config},o.prototype.getLocalStreams=function(){return this.localStreams},o.prototype.getRemoteStreams=function(){return this.remoteStreams},o.prototype._createTransceiver=function(c,h){var d=this.transceivers.length>0,u={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:c,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&d)u.iceTransport=this.transceivers[0].iceTransport,u.dtlsTransport=this.transceivers[0].dtlsTransport;else{var f=this._createIceAndDtlsTransports();u.iceTransport=f.iceTransport,u.dtlsTransport=f.dtlsTransport}return h||this.transceivers.push(u),u},o.prototype.addTrack=function(c,h){if(this._isClosed)throw Bi("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var d=this.transceivers.find(function(p){return p.track===c});if(d)throw Bi("InvalidAccessError","Track already exists.");for(var u,f=0;f<this.transceivers.length;f++)!this.transceivers[f].track&&this.transceivers[f].kind===c.kind&&(u=this.transceivers[f]);return u||(u=this._createTransceiver(c.kind)),this._maybeFireNegotiationNeeded(),this.localStreams.indexOf(h)===-1&&this.localStreams.push(h),u.track=c,u.stream=h,u.rtpSender=new s.RTCRtpSender(c,u.dtlsTransport),u.rtpSender},o.prototype.addStream=function(c){var h=this;if(t>=15025)c.getTracks().forEach(function(u){h.addTrack(u,c)});else{var d=c.clone();c.getTracks().forEach(function(u,f){var p=d.getTracks()[f];u.addEventListener("enabled",function(b){p.enabled=b.enabled})}),d.getTracks().forEach(function(u){h.addTrack(u,d)})}},o.prototype.removeTrack=function(c){if(this._isClosed)throw Bi("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(c instanceof s.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var h=this.transceivers.find(function(f){return f.rtpSender===c});if(!h)throw Bi("InvalidAccessError","Sender was not created by this connection.");var d=h.stream;h.rtpSender.stop(),h.rtpSender=null,h.track=null,h.stream=null;var u=this.transceivers.map(function(f){return f.stream});u.indexOf(d)===-1&&this.localStreams.indexOf(d)>-1&&this.localStreams.splice(this.localStreams.indexOf(d),1),this._maybeFireNegotiationNeeded()},o.prototype.removeStream=function(c){var h=this;c.getTracks().forEach(function(d){var u=h.getSenders().find(function(f){return f.track===d});u&&h.removeTrack(u)})},o.prototype.getSenders=function(){return this.transceivers.filter(function(c){return!!c.rtpSender}).map(function(c){return c.rtpSender})},o.prototype.getReceivers=function(){return this.transceivers.filter(function(c){return!!c.rtpReceiver}).map(function(c){return c.rtpReceiver})},o.prototype._createIceGatherer=function(c,h){var d=this;if(h&&c>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var u=new s.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(u,"state",{value:"new",writable:!0}),this.transceivers[c].bufferedCandidateEvents=[],this.transceivers[c].bufferCandidates=function(f){var p=!f.candidate||Object.keys(f.candidate).length===0;u.state=p?"completed":"gathering",d.transceivers[c].bufferedCandidateEvents!==null&&d.transceivers[c].bufferedCandidateEvents.push(f)},u.addEventListener("localcandidate",this.transceivers[c].bufferCandidates),u},o.prototype._gather=function(c,h){var d=this,u=this.transceivers[h].iceGatherer;if(!u.onlocalcandidate){var f=this.transceivers[h].bufferedCandidateEvents;this.transceivers[h].bufferedCandidateEvents=null,u.removeEventListener("localcandidate",this.transceivers[h].bufferCandidates),u.onlocalcandidate=function(p){if(!(d.usingBundle&&h>0)){var b=new Event("icecandidate");b.candidate={sdpMid:c,sdpMLineIndex:h};var x=p.candidate,v=!x||Object.keys(x).length===0;if(v)(u.state==="new"||u.state==="gathering")&&(u.state="completed");else{u.state==="new"&&(u.state="gathering"),x.component=1,x.ufrag=u.getLocalParameters().usernameFragment;var S=be.writeCandidate(x);b.candidate=Object.assign(b.candidate,be.parseCandidate(S)),b.candidate.candidate=S,b.candidate.toJSON=function(){return{candidate:b.candidate.candidate,sdpMid:b.candidate.sdpMid,sdpMLineIndex:b.candidate.sdpMLineIndex,usernameFragment:b.candidate.usernameFragment}}}var C=be.getMediaSections(d._localDescription.sdp);v?C[b.candidate.sdpMLineIndex]+=`a=end-of-candidates\r
`:C[b.candidate.sdpMLineIndex]+="a="+b.candidate.candidate+`\r
`,d._localDescription.sdp=be.getDescription(d._localDescription.sdp)+C.join("");var P=d.transceivers.every(function(E){return E.iceGatherer&&E.iceGatherer.state==="completed"});d.iceGatheringState!=="gathering"&&(d.iceGatheringState="gathering",d._emitGatheringStateChange()),v||d._dispatchEvent("icecandidate",b),P&&(d._dispatchEvent("icecandidate",new Event("icecandidate")),d.iceGatheringState="complete",d._emitGatheringStateChange())}},s.setTimeout(function(){f.forEach(function(p){u.onlocalcandidate(p)})},0)}},o.prototype._createIceAndDtlsTransports=function(){var c=this,h=new s.RTCIceTransport(null);h.onicestatechange=function(){c._updateIceConnectionState(),c._updateConnectionState()};var d=new s.RTCDtlsTransport(h);return d.ondtlsstatechange=function(){c._updateConnectionState()},d.onerror=function(){Object.defineProperty(d,"state",{value:"failed",writable:!0}),c._updateConnectionState()},{iceTransport:h,dtlsTransport:d}},o.prototype._disposeIceAndDtlsTransports=function(c){var h=this.transceivers[c].iceGatherer;h&&(delete h.onlocalcandidate,delete this.transceivers[c].iceGatherer);var d=this.transceivers[c].iceTransport;d&&(delete d.onicestatechange,delete this.transceivers[c].iceTransport);var u=this.transceivers[c].dtlsTransport;u&&(delete u.ondtlsstatechange,delete u.onerror,delete this.transceivers[c].dtlsTransport)},o.prototype._transceive=function(c,h,d){var u=pp(c.localCapabilities,c.remoteCapabilities);h&&c.rtpSender&&(u.encodings=c.sendEncodingParameters,u.rtcp={cname:be.localCName,compound:c.rtcpParameters.compound},c.recvEncodingParameters.length&&(u.rtcp.ssrc=c.recvEncodingParameters[0].ssrc),c.rtpSender.send(u)),d&&c.rtpReceiver&&u.codecs.length>0&&(c.kind==="video"&&c.recvEncodingParameters&&t<15019&&c.recvEncodingParameters.forEach(function(f){delete f.rtx}),c.recvEncodingParameters.length?u.encodings=c.recvEncodingParameters:u.encodings=[{}],u.rtcp={compound:c.rtcpParameters.compound},c.rtcpParameters.cname&&(u.rtcp.cname=c.rtcpParameters.cname),c.sendEncodingParameters.length&&(u.rtcp.ssrc=c.sendEncodingParameters[0].ssrc),c.rtpReceiver.receive(u))},o.prototype.setLocalDescription=function(c){var h=this;if(["offer","answer"].indexOf(c.type)===-1)return Promise.reject(Bi("TypeError",'Unsupported type "'+c.type+'"'));if(!Pw("setLocalDescription",c.type,h.signalingState)||h._isClosed)return Promise.reject(Bi("InvalidStateError","Can not set local "+c.type+" in state "+h.signalingState));var d,u;if(c.type==="offer")d=be.splitSections(c.sdp),u=d.shift(),d.forEach(function(p,b){var x=be.parseRtpParameters(p);h.transceivers[b].localCapabilities=x}),h.transceivers.forEach(function(p,b){h._gather(p.mid,b)});else if(c.type==="answer"){d=be.splitSections(h._remoteDescription.sdp),u=d.shift();var f=be.matchPrefix(u,"a=ice-lite").length>0;d.forEach(function(p,b){var x=h.transceivers[b],v=x.iceGatherer,S=x.iceTransport,C=x.dtlsTransport,P=x.localCapabilities,E=x.remoteCapabilities,D=be.isRejected(p)&&be.matchPrefix(p,"a=bundle-only").length===0;if(!D&&!x.rejected){var M=be.getIceParameters(p,u),A=be.getDtlsParameters(p,u);f&&(A.role="server"),(!h.usingBundle||b===0)&&(h._gather(x.mid,b),S.state==="new"&&S.start(v,M,f?"controlling":"controlled"),C.state==="new"&&C.start(A));var G=pp(P,E);h._transceive(x,G.codecs.length>0,!1)}})}return h._localDescription={type:c.type,sdp:c.sdp},c.type==="offer"?h._updateSignalingState("have-local-offer"):h._updateSignalingState("stable"),Promise.resolve()},o.prototype.setRemoteDescription=function(c){var h=this;if(["offer","answer"].indexOf(c.type)===-1)return Promise.reject(Bi("TypeError",'Unsupported type "'+c.type+'"'));if(!Pw("setRemoteDescription",c.type,h.signalingState)||h._isClosed)return Promise.reject(Bi("InvalidStateError","Can not set remote "+c.type+" in state "+h.signalingState));var d={};h.remoteStreams.forEach(function(S){d[S.id]=S});var u=[],f=be.splitSections(c.sdp),p=f.shift(),b=be.matchPrefix(p,"a=ice-lite").length>0,x=be.matchPrefix(p,"a=group:BUNDLE ").length>0;h.usingBundle=x;var v=be.matchPrefix(p,"a=ice-options:")[0];return v?h.canTrickleIceCandidates=v.substr(14).split(" ").indexOf("trickle")>=0:h.canTrickleIceCandidates=!1,f.forEach(function(S,C){var P=be.splitLines(S),E=be.getKind(S),D=be.isRejected(S)&&be.matchPrefix(S,"a=bundle-only").length===0,M=P[0].substr(2).split(" ")[2],A=be.getDirection(S,p),G=be.parseMsid(S),V=be.getMid(S)||be.generateIdentifier();if(D||E==="application"&&(M==="DTLS/SCTP"||M==="UDP/DTLS/SCTP")){h.transceivers[C]={mid:V,kind:E,protocol:M,rejected:!0};return}!D&&h.transceivers[C]&&h.transceivers[C].rejected&&(h.transceivers[C]=h._createTransceiver(E,!0));var U,$,Y,B,N,Z,ae,ie,J,ye=be.parseRtpParameters(S),Fe,Ze;D||(Fe=be.getIceParameters(S,p),Ze=be.getDtlsParameters(S,p),Ze.role="client"),ae=be.parseRtpEncodingParameters(S);var Ot=be.parseRtcpParameters(S),St=be.matchPrefix(S,"a=end-of-candidates",p).length>0,ui=be.matchPrefix(S,"a=candidate:").map(function(Ue){return be.parseCandidate(Ue)}).filter(function(Ue){return Ue.component===1});if((c.type==="offer"||c.type==="answer")&&!D&&x&&C>0&&h.transceivers[C]&&(h._disposeIceAndDtlsTransports(C),h.transceivers[C].iceGatherer=h.transceivers[0].iceGatherer,h.transceivers[C].iceTransport=h.transceivers[0].iceTransport,h.transceivers[C].dtlsTransport=h.transceivers[0].dtlsTransport,h.transceivers[C].rtpSender&&h.transceivers[C].rtpSender.setTransport(h.transceivers[0].dtlsTransport),h.transceivers[C].rtpReceiver&&h.transceivers[C].rtpReceiver.setTransport(h.transceivers[0].dtlsTransport)),c.type==="offer"&&!D){U=h.transceivers[C]||h._createTransceiver(E),U.mid=V,U.iceGatherer||(U.iceGatherer=h._createIceGatherer(C,x)),ui.length&&U.iceTransport.state==="new"&&(St&&(!x||C===0)?U.iceTransport.setRemoteCandidates(ui):ui.forEach(function(Ue){Zy(U.iceTransport,Ue)})),ie=s.RTCRtpReceiver.getCapabilities(E),t<15019&&(ie.codecs=ie.codecs.filter(function(Ue){return Ue.name!=="rtx"})),Z=U.sendEncodingParameters||[{ssrc:(2*C+2)*1001}];var fi=!1;if(A==="sendrecv"||A==="sendonly"){if(fi=!U.rtpReceiver,N=U.rtpReceiver||new s.RTCRtpReceiver(U.dtlsTransport,E),fi){var pi;J=N.track,G&&G.stream==="-"||(G?(d[G.stream]||(d[G.stream]=new s.MediaStream,Object.defineProperty(d[G.stream],"id",{get:function(){return G.stream}})),Object.defineProperty(J,"id",{get:function(){return G.track}}),pi=d[G.stream]):(d.default||(d.default=new s.MediaStream),pi=d.default)),pi&&(e(J,pi),U.associatedRemoteMediaStreams.push(pi)),u.push([J,N,pi])}}else U.rtpReceiver&&U.rtpReceiver.track&&(U.associatedRemoteMediaStreams.forEach(function(Ue){var lo=Ue.getTracks().find(function(na){return na.id===U.rtpReceiver.track.id});lo&&i(lo,Ue)}),U.associatedRemoteMediaStreams=[]);U.localCapabilities=ie,U.remoteCapabilities=ye,U.rtpReceiver=N,U.rtcpParameters=Ot,U.sendEncodingParameters=Z,U.recvEncodingParameters=ae,h._transceive(h.transceivers[C],!1,fi)}else if(c.type==="answer"&&!D){U=h.transceivers[C],$=U.iceGatherer,Y=U.iceTransport,B=U.dtlsTransport,N=U.rtpReceiver,Z=U.sendEncodingParameters,ie=U.localCapabilities,h.transceivers[C].recvEncodingParameters=ae,h.transceivers[C].remoteCapabilities=ye,h.transceivers[C].rtcpParameters=Ot,ui.length&&Y.state==="new"&&((b||St)&&(!x||C===0)?Y.setRemoteCandidates(ui):ui.forEach(function(Ue){Zy(U.iceTransport,Ue)})),(!x||C===0)&&(Y.state==="new"&&Y.start($,Fe,"controlling"),B.state==="new"&&B.start(Ze));var ns=pp(U.localCapabilities,U.remoteCapabilities),Ts=ns.codecs.filter(function(Ue){return Ue.name.toLowerCase()==="rtx"}).length;!Ts&&U.sendEncodingParameters[0].rtx&&delete U.sendEncodingParameters[0].rtx,h._transceive(U,A==="sendrecv"||A==="recvonly",A==="sendrecv"||A==="sendonly"),N&&(A==="sendrecv"||A==="sendonly")?(J=N.track,G?(d[G.stream]||(d[G.stream]=new s.MediaStream),e(J,d[G.stream]),u.push([J,N,d[G.stream]])):(d.default||(d.default=new s.MediaStream),e(J,d.default),u.push([J,N,d.default]))):delete U.rtpReceiver}}),h._dtlsRole===void 0&&(h._dtlsRole=c.type==="offer"?"active":"passive"),h._remoteDescription={type:c.type,sdp:c.sdp},c.type==="offer"?h._updateSignalingState("have-remote-offer"):h._updateSignalingState("stable"),Object.keys(d).forEach(function(S){var C=d[S];if(C.getTracks().length){if(h.remoteStreams.indexOf(C)===-1){h.remoteStreams.push(C);var P=new Event("addstream");P.stream=C,s.setTimeout(function(){h._dispatchEvent("addstream",P)})}u.forEach(function(E){var D=E[0],M=E[1];C.id===E[2].id&&n(h,D,M,[C])})}}),u.forEach(function(S){S[2]||n(h,S[0],S[1],[])}),s.setTimeout(function(){h&&h.transceivers&&h.transceivers.forEach(function(S){S.iceTransport&&S.iceTransport.state==="new"&&S.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),S.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},o.prototype.close=function(){this.transceivers.forEach(function(c){c.iceTransport&&c.iceTransport.stop(),c.dtlsTransport&&c.dtlsTransport.stop(),c.rtpSender&&c.rtpSender.stop(),c.rtpReceiver&&c.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},o.prototype._updateSignalingState=function(c){this.signalingState=c;var h=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",h)},o.prototype._maybeFireNegotiationNeeded=function(){var c=this;this.signalingState!=="stable"||this.needNegotiation===!0||(this.needNegotiation=!0,s.setTimeout(function(){if(c.needNegotiation){c.needNegotiation=!1;var h=new Event("negotiationneeded");c._dispatchEvent("negotiationneeded",h)}},0))},o.prototype._updateIceConnectionState=function(){var c,h={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(u){u.iceTransport&&!u.rejected&&h[u.iceTransport.state]++}),c="new",h.failed>0?c="failed":h.checking>0?c="checking":h.disconnected>0?c="disconnected":h.new>0?c="new":h.connected>0?c="connected":h.completed>0&&(c="completed"),c!==this.iceConnectionState){this.iceConnectionState=c;var d=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",d)}},o.prototype._updateConnectionState=function(){var c,h={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(u){u.iceTransport&&u.dtlsTransport&&!u.rejected&&(h[u.iceTransport.state]++,h[u.dtlsTransport.state]++)}),h.connected+=h.completed,c="new",h.failed>0?c="failed":h.connecting>0?c="connecting":h.disconnected>0?c="disconnected":h.new>0?c="new":h.connected>0&&(c="connected"),c!==this.connectionState){this.connectionState=c;var d=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",d)}},o.prototype.createOffer=function(){var c=this;if(c._isClosed)return Promise.reject(Bi("InvalidStateError","Can not call createOffer after close"));var h=c.transceivers.filter(function(b){return b.kind==="audio"}).length,d=c.transceivers.filter(function(b){return b.kind==="video"}).length,u=arguments[0];if(u){if(u.mandatory||u.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");u.offerToReceiveAudio!==void 0&&(u.offerToReceiveAudio===!0?h=1:u.offerToReceiveAudio===!1?h=0:h=u.offerToReceiveAudio),u.offerToReceiveVideo!==void 0&&(u.offerToReceiveVideo===!0?d=1:u.offerToReceiveVideo===!1?d=0:d=u.offerToReceiveVideo)}for(c.transceivers.forEach(function(b){b.kind==="audio"?(h--,h<0&&(b.wantReceive=!1)):b.kind==="video"&&(d--,d<0&&(b.wantReceive=!1))});h>0||d>0;)h>0&&(c._createTransceiver("audio"),h--),d>0&&(c._createTransceiver("video"),d--);var f=be.writeSessionBoilerplate(c._sdpSessionId,c._sdpSessionVersion++);c.transceivers.forEach(function(b,x){var v=b.track,S=b.kind,C=b.mid||be.generateIdentifier();b.mid=C,b.iceGatherer||(b.iceGatherer=c._createIceGatherer(x,c.usingBundle));var P=s.RTCRtpSender.getCapabilities(S);t<15019&&(P.codecs=P.codecs.filter(function(D){return D.name!=="rtx"})),P.codecs.forEach(function(D){D.name==="H264"&&D.parameters["level-asymmetry-allowed"]===void 0&&(D.parameters["level-asymmetry-allowed"]="1"),b.remoteCapabilities&&b.remoteCapabilities.codecs&&b.remoteCapabilities.codecs.forEach(function(M){D.name.toLowerCase()===M.name.toLowerCase()&&D.clockRate===M.clockRate&&(D.preferredPayloadType=M.payloadType)})}),P.headerExtensions.forEach(function(D){var M=b.remoteCapabilities&&b.remoteCapabilities.headerExtensions||[];M.forEach(function(A){D.uri===A.uri&&(D.id=A.id)})});var E=b.sendEncodingParameters||[{ssrc:(2*x+1)*1001}];v&&t>=15019&&S==="video"&&!E[0].rtx&&(E[0].rtx={ssrc:E[0].ssrc+1}),b.wantReceive&&(b.rtpReceiver=new s.RTCRtpReceiver(b.dtlsTransport,S)),b.localCapabilities=P,b.sendEncodingParameters=E}),c._config.bundlePolicy!=="max-compat"&&(f+="a=group:BUNDLE "+c.transceivers.map(function(b){return b.mid}).join(" ")+`\r
`),f+=`a=ice-options:trickle\r
`,c.transceivers.forEach(function(b,x){f+=Cw(b,b.localCapabilities,"offer",b.stream,c._dtlsRole),f+=`a=rtcp-rsize\r
`,b.iceGatherer&&c.iceGatheringState!=="new"&&(x===0||!c.usingBundle)&&(b.iceGatherer.getLocalCandidates().forEach(function(v){v.component=1,f+="a="+be.writeCandidate(v)+`\r
`}),b.iceGatherer.state==="completed"&&(f+=`a=end-of-candidates\r
`))});var p=new s.RTCSessionDescription({type:"offer",sdp:f});return Promise.resolve(p)},o.prototype.createAnswer=function(){var c=this;if(c._isClosed)return Promise.reject(Bi("InvalidStateError","Can not call createAnswer after close"));if(!(c.signalingState==="have-remote-offer"||c.signalingState==="have-local-pranswer"))return Promise.reject(Bi("InvalidStateError","Can not call createAnswer in signalingState "+c.signalingState));var h=be.writeSessionBoilerplate(c._sdpSessionId,c._sdpSessionVersion++);c.usingBundle&&(h+="a=group:BUNDLE "+c.transceivers.map(function(f){return f.mid}).join(" ")+`\r
`),h+=`a=ice-options:trickle\r
`;var d=be.getMediaSections(c._remoteDescription.sdp).length;c.transceivers.forEach(function(f,p){if(!(p+1>d)){if(f.rejected){f.kind==="application"?f.protocol==="DTLS/SCTP"?h+=`m=application 0 DTLS/SCTP 5000\r
`:h+="m=application 0 "+f.protocol+` webrtc-datachannel\r
`:f.kind==="audio"?h+=`m=audio 0 UDP/TLS/RTP/SAVPF 0\r
a=rtpmap:0 PCMU/8000\r
`:f.kind==="video"&&(h+=`m=video 0 UDP/TLS/RTP/SAVPF 120\r
a=rtpmap:120 VP8/90000\r
`),h+=`c=IN IP4 0.0.0.0\r
a=inactive\r
a=mid:`+f.mid+`\r
`;return}if(f.stream){var b;f.kind==="audio"?b=f.stream.getAudioTracks()[0]:f.kind==="video"&&(b=f.stream.getVideoTracks()[0]),b&&t>=15019&&f.kind==="video"&&!f.sendEncodingParameters[0].rtx&&(f.sendEncodingParameters[0].rtx={ssrc:f.sendEncodingParameters[0].ssrc+1})}var x=pp(f.localCapabilities,f.remoteCapabilities),v=x.codecs.filter(function(S){return S.name.toLowerCase()==="rtx"}).length;!v&&f.sendEncodingParameters[0].rtx&&delete f.sendEncodingParameters[0].rtx,h+=Cw(f,x,"answer",f.stream,c._dtlsRole),f.rtcpParameters&&f.rtcpParameters.reducedSize&&(h+=`a=rtcp-rsize\r
`)}});var u=new s.RTCSessionDescription({type:"answer",sdp:h});return Promise.resolve(u)},o.prototype.addIceCandidate=function(c){var h=this,d;return c&&!(c.sdpMLineIndex!==void 0||c.sdpMid)?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(u,f){if(h._remoteDescription)if(!c||c.candidate==="")for(var p=0;p<h.transceivers.length&&!(!h.transceivers[p].rejected&&(h.transceivers[p].iceTransport.addRemoteCandidate({}),d=be.getMediaSections(h._remoteDescription.sdp),d[p]+=`a=end-of-candidates\r
`,h._remoteDescription.sdp=be.getDescription(h._remoteDescription.sdp)+d.join(""),h.usingBundle));p++);else{var b=c.sdpMLineIndex;if(c.sdpMid){for(var x=0;x<h.transceivers.length;x++)if(h.transceivers[x].mid===c.sdpMid){b=x;break}}var v=h.transceivers[b];if(v){if(v.rejected)return u();var S=Object.keys(c.candidate).length>0?be.parseCandidate(c.candidate):{};if(S.protocol==="tcp"&&(S.port===0||S.port===9)||S.component&&S.component!==1)return u();if((b===0||b>0&&v.iceTransport!==h.transceivers[0].iceTransport)&&!Zy(v.iceTransport,S))return f(Bi("OperationError","Can not add ICE candidate"));var C=c.candidate.trim();C.indexOf("a=")===0&&(C=C.substr(2)),d=be.getMediaSections(h._remoteDescription.sdp),d[b]+="a="+(S.type?C:"end-of-candidates")+`\r
`,h._remoteDescription.sdp=be.getDescription(h._remoteDescription.sdp)+d.join("")}else return f(Bi("OperationError","Can not add ICE candidate"))}else return f(Bi("InvalidStateError","Can not add ICE candidate without a remote description"));u()})},o.prototype.getStats=function(c){if(c&&c instanceof s.MediaStreamTrack){var h=null;if(this.transceivers.forEach(function(u){u.rtpSender&&u.rtpSender.track===c?h=u.rtpSender:u.rtpReceiver&&u.rtpReceiver.track===c&&(h=u.rtpReceiver)}),!h)throw Bi("InvalidAccessError","Invalid selector.");return h.getStats()}var d=[];return this.transceivers.forEach(function(u){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(f){u[f]&&d.push(u[f].getStats())})}),Promise.all(d).then(function(u){var f=new Map;return u.forEach(function(p){p.forEach(function(b){f.set(b.id,b)})}),f})};var r=["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"];r.forEach(function(c){var h=s[c];if(h&&h.prototype&&h.prototype.getStats){var d=h.prototype.getStats;h.prototype.getStats=function(){return d.apply(this).then(function(u){var f=new Map;return Object.keys(u).forEach(function(p){u[p].type=rA(u[p]),f.set(p,u[p])}),f})}}});var l=["createOffer","createAnswer"];return l.forEach(function(c){var h=o.prototype[c];o.prototype[c]=function(){var d=arguments;return typeof d[0]=="function"||typeof d[1]=="function"?h.apply(this,[arguments[2]]).then(function(u){typeof d[0]=="function"&&d[0].apply(null,[u])},function(u){typeof d[1]=="function"&&d[1].apply(null,[u])}):h.apply(this,arguments)}}),l=["setLocalDescription","setRemoteDescription","addIceCandidate"],l.forEach(function(c){var h=o.prototype[c];o.prototype[c]=function(){var d=arguments;return typeof d[1]=="function"||typeof d[2]=="function"?h.apply(this,arguments).then(function(){typeof d[1]=="function"&&d[1].apply(null)},function(u){typeof d[2]=="function"&&d[2].apply(null,[u])}):h.apply(this,arguments)}}),["getStats"].forEach(function(c){var h=o.prototype[c];o.prototype[c]=function(){var d=arguments;return typeof d[1]=="function"?h.apply(this,arguments).then(function(){typeof d[1]=="function"&&d[1].apply(null)}):h.apply(this,arguments)}}),o};const cA=Ig(lA);function aP(s){var n;const t=s&&s.navigator,e=function(o){return{name:{PermissionDeniedError:"NotAllowedError"}[o.name]||o.name,message:o.message,constraint:o.constraint,toString(){return this.name}}},i=t.mediaDevices.getUserMedia.bind(t.mediaDevices);(n=Object.getOwnPropertyDescriptor(t.mediaDevices,"getUserMedia"))!=null&&n.writable&&(t.mediaDevices.getUserMedia=function(o){return i(o).catch(r=>Promise.reject(e(r)))})}function lP(s){"getDisplayMedia"in s.navigator&&s.navigator.mediaDevices&&(s.navigator.mediaDevices&&"getDisplayMedia"in s.navigator.mediaDevices||(s.navigator.mediaDevices.getDisplayMedia=s.navigator.getDisplayMedia.bind(s.navigator)))}function w_(s,t){if(s.RTCIceGatherer&&(s.RTCIceCandidate||(s.RTCIceCandidate=function(n){return n}),s.RTCSessionDescription||(s.RTCSessionDescription=function(n){return n}),t.version<15025)){const i=Object.getOwnPropertyDescriptor(s.MediaStreamTrack.prototype,"enabled");Object.defineProperty(s.MediaStreamTrack.prototype,"enabled",{set(n){i.set.call(this,n);const o=new Event("enabled");o.enabled=n,this.dispatchEvent(o)}})}s.RTCRtpSender&&!("dtmf"in s.RTCRtpSender.prototype)&&Object.defineProperty(s.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=new s.RTCDtmfSender(this):this.track.kind==="video"&&(this._dtmf=null)),this._dtmf}}),s.RTCDtmfSender&&!s.RTCDTMFSender&&(s.RTCDTMFSender=s.RTCDtmfSender);const e=cA(s,t.version);s.RTCPeerConnection=function(n){return n&&n.iceServers&&(n.iceServers=oA(n.iceServers,t.version),G0("ICE servers after filtering:",n.iceServers)),new e(n)},s.RTCPeerConnection.prototype=e.prototype}function cP(s){s.RTCRtpSender&&!("replaceTrack"in s.RTCRtpSender.prototype)&&(s.RTCRtpSender.prototype.replaceTrack=s.RTCRtpSender.prototype.setTrack)}const Tw=Object.freeze(Object.defineProperty({__proto__:null,shimGetDisplayMedia:lP,shimGetUserMedia:aP,shimPeerConnection:w_,shimReplaceTrack:cP},Symbol.toStringTag,{value:"Module"}));function hP(s,t){var n;const e=s&&s.navigator,i=s&&s.MediaStreamTrack;if(e.getUserMedia=function(o,r,l){Lg("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),e.mediaDevices.getUserMedia(o).then(r,l)},!(t.version>55&&"autoGainControl"in e.mediaDevices.getSupportedConstraints())){const o=function(l,c,h){c in l&&!(h in l)&&(l[h]=l[c],delete l[c])},r=e.mediaDevices.getUserMedia.bind(e.mediaDevices);if((n=Object.getOwnPropertyDescriptor(e.mediaDevices,"getUserMedia"))!=null&&n.writable&&(e.mediaDevices.getUserMedia=function(l){return typeof l=="object"&&typeof l.audio=="object"&&(l=JSON.parse(JSON.stringify(l)),o(l.audio,"autoGainControl","mozAutoGainControl"),o(l.audio,"noiseSuppression","mozNoiseSuppression")),r(l)}),i&&i.prototype.getSettings){const l=i.prototype.getSettings;i.prototype.getSettings=function(){const c=l.apply(this,arguments);return o(c,"mozAutoGainControl","autoGainControl"),o(c,"mozNoiseSuppression","noiseSuppression"),c}}if(i&&i.prototype.applyConstraints){const l=i.prototype.applyConstraints;i.prototype.applyConstraints=function(c){return this.kind==="audio"&&typeof c=="object"&&(c=JSON.parse(JSON.stringify(c)),o(c,"autoGainControl","mozAutoGainControl"),o(c,"noiseSuppression","mozNoiseSuppression")),l.apply(this,[c])}}}}function hA(s,t){s.navigator.mediaDevices&&"getDisplayMedia"in s.navigator.mediaDevices||s.navigator.mediaDevices&&(s.navigator.mediaDevices.getDisplayMedia=function(i){if(!(i&&i.video)){const n=new DOMException("getDisplayMedia without video constraints is undefined");return n.name="NotFoundError",n.code=8,Promise.reject(n)}return i.video===!0?i.video={mediaSource:t}:i.video.mediaSource=t,s.navigator.mediaDevices.getUserMedia(i)})}function dP(s){typeof s=="object"&&s.RTCTrackEvent&&"receiver"in s.RTCTrackEvent.prototype&&!("transceiver"in s.RTCTrackEvent.prototype)&&Object.defineProperty(s.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function S_(s,t){if(typeof s!="object"||!(s.RTCPeerConnection||s.mozRTCPeerConnection))return;!s.RTCPeerConnection&&s.mozRTCPeerConnection&&(s.RTCPeerConnection=s.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(n){const o=s.RTCPeerConnection.prototype[n],r={[n](){return arguments[0]=new(n==="addIceCandidate"?s.RTCIceCandidate:s.RTCSessionDescription)(arguments[0]),o.apply(this,arguments)}};s.RTCPeerConnection.prototype[n]=r[n]});const e={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=s.RTCPeerConnection.prototype.getStats;s.RTCPeerConnection.prototype.getStats=function(){const[o,r,l]=arguments;return i.apply(this,[o||null]).then(c=>{if(t.version<53&&!r)try{c.forEach(h=>{h.type=e[h.type]||h.type})}catch(h){if(h.name!=="TypeError")throw h;c.forEach((d,u)=>{c.set(u,Object.assign({},d,{type:e[d.type]||d.type}))})}return c}).then(r,l)}}function uP(s){if(!(typeof s=="object"&&s.RTCPeerConnection&&s.RTCRtpSender)||s.RTCRtpSender&&"getStats"in s.RTCRtpSender.prototype)return;const t=s.RTCPeerConnection.prototype.getSenders;t&&(s.RTCPeerConnection.prototype.getSenders=function(){const n=t.apply(this,[]);return n.forEach(o=>o._pc=this),n});const e=s.RTCPeerConnection.prototype.addTrack;e&&(s.RTCPeerConnection.prototype.addTrack=function(){const n=e.apply(this,arguments);return n._pc=this,n}),s.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function fP(s){if(!(typeof s=="object"&&s.RTCPeerConnection&&s.RTCRtpSender)||s.RTCRtpSender&&"getStats"in s.RTCRtpReceiver.prototype)return;const t=s.RTCPeerConnection.prototype.getReceivers;t&&(s.RTCPeerConnection.prototype.getReceivers=function(){const i=t.apply(this,[]);return i.forEach(n=>n._pc=this),i}),ad(s,"track",e=>(e.receiver._pc=e.srcElement,e)),s.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function pP(s){!s.RTCPeerConnection||"removeStream"in s.RTCPeerConnection.prototype||(s.RTCPeerConnection.prototype.removeStream=function(e){Lg("removeStream","removeTrack"),this.getSenders().forEach(i=>{i.track&&e.getTracks().includes(i.track)&&this.removeTrack(i)})})}function mP(s){s.DataChannel&&!s.RTCDataChannel&&(s.RTCDataChannel=s.DataChannel)}function gP(s){if(!(typeof s=="object"&&s.RTCPeerConnection))return;const t=s.RTCPeerConnection.prototype.addTransceiver;t&&(s.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const i=arguments[1],n=i&&"sendEncodings"in i;n&&i.sendEncodings.forEach(r=>{if("rid"in r&&!/^[a-z0-9]{0,16}$/i.test(r.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in r&&!(parseFloat(r.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in r&&!(parseFloat(r.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const o=t.apply(this,arguments);if(n){const{sender:r}=o,l=r.getParameters();(!("encodings"in l)||l.encodings.length===1&&Object.keys(l.encodings[0]).length===0)&&(l.encodings=i.sendEncodings,r.sendEncodings=i.sendEncodings,this.setParametersPromises.push(r.setParameters(l).then(()=>{delete r.sendEncodings}).catch(()=>{delete r.sendEncodings})))}return o})}function yP(s){if(!(typeof s=="object"&&s.RTCRtpSender))return;const t=s.RTCRtpSender.prototype.getParameters;t&&(s.RTCRtpSender.prototype.getParameters=function(){const i=t.apply(this,arguments);return"encodings"in i||(i.encodings=[].concat(this.sendEncodings||[{}])),i})}function bP(s){if(!(typeof s=="object"&&s.RTCPeerConnection))return;const t=s.RTCPeerConnection.prototype.createOffer;s.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function _P(s){if(!(typeof s=="object"&&s.RTCPeerConnection))return;const t=s.RTCPeerConnection.prototype.createAnswer;s.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}const Rw=Object.freeze(Object.defineProperty({__proto__:null,shimAddTransceiver:gP,shimCreateAnswer:_P,shimCreateOffer:bP,shimGetDisplayMedia:hA,shimGetParameters:yP,shimGetUserMedia:hP,shimOnTrack:dP,shimPeerConnection:S_,shimRTCDataChannel:mP,shimReceiverGetStats:fP,shimRemoveStream:pP,shimSenderGetStats:uP},Symbol.toStringTag,{value:"Module"}));function vP(s){if(!(typeof s!="object"||!s.RTCPeerConnection)){if("getLocalStreams"in s.RTCPeerConnection.prototype||(s.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in s.RTCPeerConnection.prototype)){const t=s.RTCPeerConnection.prototype.addTrack;s.RTCPeerConnection.prototype.addStream=function(i){this._localStreams||(this._localStreams=[]),this._localStreams.includes(i)||this._localStreams.push(i),i.getAudioTracks().forEach(n=>t.call(this,n,i)),i.getVideoTracks().forEach(n=>t.call(this,n,i))},s.RTCPeerConnection.prototype.addTrack=function(i,...n){return n&&n.forEach(o=>{this._localStreams?this._localStreams.includes(o)||this._localStreams.push(o):this._localStreams=[o]}),t.apply(this,arguments)}}"removeStream"in s.RTCPeerConnection.prototype||(s.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const i=this._localStreams.indexOf(e);if(i===-1)return;this._localStreams.splice(i,1);const n=e.getTracks();this.getSenders().forEach(o=>{n.includes(o.track)&&this.removeTrack(o)})})}}function xP(s){if(!(typeof s!="object"||!s.RTCPeerConnection)&&("getRemoteStreams"in s.RTCPeerConnection.prototype||(s.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in s.RTCPeerConnection.prototype))){Object.defineProperty(s.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=i=>{i.streams.forEach(n=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(n))return;this._remoteStreams.push(n);const o=new Event("addstream");o.stream=n,this.dispatchEvent(o)})})}});const t=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(){const i=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(n){n.streams.forEach(o=>{if(i._remoteStreams||(i._remoteStreams=[]),i._remoteStreams.indexOf(o)>=0)return;i._remoteStreams.push(o);const r=new Event("addstream");r.stream=o,i.dispatchEvent(r)})}),t.apply(i,arguments)}}}function wP(s){if(typeof s!="object"||!s.RTCPeerConnection)return;const t=s.RTCPeerConnection.prototype,e=t.createOffer,i=t.createAnswer,n=t.setLocalDescription,o=t.setRemoteDescription,r=t.addIceCandidate;t.createOffer=function(h,d){const u=arguments.length>=2?arguments[2]:arguments[0],f=e.apply(this,[u]);return d?(f.then(h,d),Promise.resolve()):f},t.createAnswer=function(h,d){const u=arguments.length>=2?arguments[2]:arguments[0],f=i.apply(this,[u]);return d?(f.then(h,d),Promise.resolve()):f};let l=function(c,h,d){const u=n.apply(this,[c]);return d?(u.then(h,d),Promise.resolve()):u};t.setLocalDescription=l,l=function(c,h,d){const u=o.apply(this,[c]);return d?(u.then(h,d),Promise.resolve()):u},t.setRemoteDescription=l,l=function(c,h,d){const u=r.apply(this,[c]);return d?(u.then(h,d),Promise.resolve()):u},t.addIceCandidate=l}function SP(s){const t=s&&s.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=n=>i(CP(n))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(i,n,o){t.mediaDevices.getUserMedia(i).then(n,o)}.bind(t))}function CP(s){return s&&s.video!==void 0?Object.assign({},s,{video:Q1(s.video)}):s}function PP(s){if(!s.RTCPeerConnection)return;const t=s.RTCPeerConnection;s.RTCPeerConnection=function(i,n){if(i&&i.iceServers){const o=[];for(let r=0;r<i.iceServers.length;r++){let l=i.iceServers[r];!l.hasOwnProperty("urls")&&l.hasOwnProperty("url")?(Lg("RTCIceServer.url","RTCIceServer.urls"),l=JSON.parse(JSON.stringify(l)),l.urls=l.url,delete l.url,o.push(l)):o.push(i.iceServers[r])}i.iceServers=o}return new t(i,n)},s.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(s.RTCPeerConnection,"generateCertificate",{get(){return t.generateCertificate}})}function TP(s){typeof s=="object"&&s.RTCTrackEvent&&"receiver"in s.RTCTrackEvent.prototype&&!("transceiver"in s.RTCTrackEvent.prototype)&&Object.defineProperty(s.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function RP(s){const t=s.RTCPeerConnection.prototype.createOffer;s.RTCPeerConnection.prototype.createOffer=function(i){if(i){typeof i.offerToReceiveAudio<"u"&&(i.offerToReceiveAudio=!!i.offerToReceiveAudio);const n=this.getTransceivers().find(r=>r.receiver.track.kind==="audio");i.offerToReceiveAudio===!1&&n?n.direction==="sendrecv"?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":n.direction==="recvonly"&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):i.offerToReceiveAudio===!0&&!n&&this.addTransceiver("audio"),typeof i.offerToReceiveVideo<"u"&&(i.offerToReceiveVideo=!!i.offerToReceiveVideo);const o=this.getTransceivers().find(r=>r.receiver.track.kind==="video");i.offerToReceiveVideo===!1&&o?o.direction==="sendrecv"?o.setDirection?o.setDirection("sendonly"):o.direction="sendonly":o.direction==="recvonly"&&(o.setDirection?o.setDirection("inactive"):o.direction="inactive"):i.offerToReceiveVideo===!0&&!o&&this.addTransceiver("video")}return t.apply(this,arguments)}}function OP(s){typeof s!="object"||s.AudioContext||(s.AudioContext=s.webkitAudioContext)}const Ow=Object.freeze(Object.defineProperty({__proto__:null,shimAudioContext:OP,shimCallbacksAPI:wP,shimConstraints:CP,shimCreateOfferLegacy:RP,shimGetUserMedia:SP,shimLocalStreamsAPI:vP,shimRTCIceServerUrls:PP,shimRemoteStreamsAPI:xP,shimTrackEventTransceiver:TP},Symbol.toStringTag,{value:"Module"}));function Jp(s){if(!s.RTCIceCandidate||s.RTCIceCandidate&&"foundation"in s.RTCIceCandidate.prototype)return;const t=s.RTCIceCandidate;s.RTCIceCandidate=function(i){if(typeof i=="object"&&i.candidate&&i.candidate.indexOf("a=")===0&&(i=JSON.parse(JSON.stringify(i)),i.candidate=i.candidate.substr(2)),i.candidate&&i.candidate.length){const n=new t(i),o=Zp.parseCandidate(i.candidate),r=Object.assign(n,o);return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new t(i)},s.RTCIceCandidate.prototype=t.prototype,ad(s,"icecandidate",e=>(e.candidate&&Object.defineProperty(e,"candidate",{value:new s.RTCIceCandidate(e.candidate),writable:"false"}),e))}function au(s,t){if(!s.RTCPeerConnection)return;"sctp"in s.RTCPeerConnection.prototype||Object.defineProperty(s.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const e=function(l){if(!l||!l.sdp)return!1;const c=Zp.splitSections(l.sdp);return c.shift(),c.some(h=>{const d=Zp.parseMLine(h);return d&&d.kind==="application"&&d.protocol.indexOf("SCTP")!==-1})},i=function(l){const c=l.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;const h=parseInt(c[1],10);return h!==h?-1:h},n=function(l){let c=65536;return t.browser==="firefox"&&(t.version<57?l===-1?c=16384:c=2147483637:t.version<60?c=t.version===57?65535:65536:c=2147483637),c},o=function(l,c){let h=65536;t.browser==="firefox"&&t.version===57&&(h=65535);const d=Zp.matchPrefix(l.sdp,"a=max-message-size:");return d.length>0?h=parseInt(d[0].substr(19),10):t.browser==="firefox"&&c!==-1&&(h=2147483637),h},r=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,t.browser==="chrome"&&t.version>=76){const{sdpSemantics:c}=this.getConfiguration();c==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(e(arguments[0])){const c=i(arguments[0]),h=n(c),d=o(arguments[0],c);let u;h===0&&d===0?u=Number.POSITIVE_INFINITY:h===0||d===0?u=Math.max(h,d):u=Math.min(h,d);const f={};Object.defineProperty(f,"maxMessageSize",{get(){return u}}),this._sctp=f}return r.apply(this,arguments)}}function lu(s){if(!(s.RTCPeerConnection&&"createDataChannel"in s.RTCPeerConnection.prototype))return;function t(i,n){const o=i.send;i.send=function(){const l=arguments[0],c=l.length||l.size||l.byteLength;if(i.readyState==="open"&&n.sctp&&c>n.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+n.sctp.maxMessageSize+" bytes)");return o.apply(i,arguments)}}const e=s.RTCPeerConnection.prototype.createDataChannel;s.RTCPeerConnection.prototype.createDataChannel=function(){const n=e.apply(this,arguments);return t(n,this),n},ad(s,"datachannel",i=>(t(i.channel,i.target),i))}function C_(s){if(!s.RTCPeerConnection||"connectionState"in s.RTCPeerConnection.prototype)return;const t=s.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{const i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=n=>{const o=n.target;if(o._lastConnectionState!==o.connectionState){o._lastConnectionState=o.connectionState;const r=new Event("connectionstatechange",n);o.dispatchEvent(r)}return n},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}function P_(s,t){if(!s.RTCPeerConnection||t.browser==="chrome"&&t.version>=71||t.browser==="safari"&&t.version>=605)return;const e=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(n){if(n&&n.sdp&&n.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const o=n.sdp.split(`
`).filter(r=>r.trim()!=="a=extmap-allow-mixed").join(`
`);s.RTCSessionDescription&&n instanceof s.RTCSessionDescription?arguments[0]=new s.RTCSessionDescription({type:n.type,sdp:o}):n.sdp=o}return e.apply(this,arguments)}}function em(s,t){if(!(s.RTCPeerConnection&&s.RTCPeerConnection.prototype))return;const e=s.RTCPeerConnection.prototype.addIceCandidate;!e||e.length===0||(s.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(t.browser==="chrome"&&t.version<78||t.browser==="firefox"&&t.version<68||t.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():e.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}const dA=Object.freeze(Object.defineProperty({__proto__:null,removeExtmapAllowMixed:P_,shimAddIceCandidateNullOrEmpty:em,shimConnectionState:C_,shimMaxMessageSize:au,shimRTCIceCandidate:Jp,shimSendThrowTypeError:lu},Symbol.toStringTag,{value:"Module"}));function uA({window:s}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const e=G0,i=nA(s),n={browserDetails:i,commonShim:dA,extractVersion:ru,disableLog:tA,disableWarnings:iA};switch(i.browser){case"chrome":if(!Sw||!x_||!t.shimChrome)return e("Chrome shim is not included in this adapter release."),n;if(i.version===null)return e("Chrome shim can not determine version, not shimming."),n;e("adapter.js shimming chrome."),n.browserShim=Sw,em(s,i),Y1(s,i),K1(s),x_(s,i),Z1(s),nP(s,i),J1(s),eP(s),tP(s),sP(s,i),Jp(s),C_(s),au(s,i),lu(s),P_(s,i);break;case"firefox":if(!Rw||!S_||!t.shimFirefox)return e("Firefox shim is not included in this adapter release."),n;e("adapter.js shimming firefox."),n.browserShim=Rw,em(s,i),hP(s,i),S_(s,i),dP(s),pP(s),uP(s),fP(s),mP(s),gP(s),yP(s),bP(s),_P(s),Jp(s),C_(s),au(s,i),lu(s);break;case"edge":if(!Tw||!w_||!t.shimEdge)return e("MS edge shim is not included in this adapter release."),n;e("adapter.js shimming edge."),n.browserShim=Tw,aP(s),lP(s),w_(s,i),cP(s),au(s,i),lu(s);break;case"safari":if(!Ow||!t.shimSafari)return e("Safari shim is not included in this adapter release."),n;e("adapter.js shimming safari."),n.browserShim=Ow,em(s,i),PP(s),RP(s),wP(s),vP(s),xP(s),TP(s),SP(s),OP(s),Jp(s),au(s,i),lu(s),P_(s,i);break;default:e("Unsupported browser!");break}return n}const kw=uA({window:typeof window>"u"?void 0:window});function Jo(s,t,e,i){Object.defineProperty(s,t,{get:e,set:i,enumerable:!0,configurable:!0})}var Jy=kw.default||kw,zd=new(function(){function s(){this.isIOS=["iPad","iPhone","iPod"].includes(navigator.platform),this.supportedBrowsers=["firefox","chrome","safari"],this.minFirefoxVersion=59,this.minChromeVersion=72,this.minSafariVersion=605}return s.prototype.isWebRTCSupported=function(){return typeof RTCPeerConnection<"u"},s.prototype.isBrowserSupported=function(){var t=this.getBrowser(),e=this.getVersion(),i=this.supportedBrowsers.includes(t);return i?t==="chrome"?e>=this.minChromeVersion:t==="firefox"?e>=this.minFirefoxVersion:t==="safari"?!this.isIOS&&e>=this.minSafariVersion:!1:!1},s.prototype.getBrowser=function(){return Jy.browserDetails.browser},s.prototype.getVersion=function(){return Jy.browserDetails.version||0},s.prototype.isUnifiedPlanSupported=function(){var t=this.getBrowser(),e=Jy.browserDetails.version||0;if(t==="chrome"&&e<this.minChromeVersion)return!1;if(t==="firefox"&&e>=this.minFirefoxVersion)return!0;if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;var i,n=!1;try{i=new RTCPeerConnection,i.addTransceiver("audio"),n=!0}catch{}finally{i&&i.close()}return n},s.prototype.toString=function(){return`Supports:
    browser:`.concat(this.getBrowser(),`
    version:`).concat(this.getVersion(),`
    isIOS:`).concat(this.isIOS,`
    isWebRTCSupported:`).concat(this.isWebRTCSupported(),`
    isBrowserSupported:`).concat(this.isBrowserSupported(),`
    isUnifiedPlanSupported:`).concat(this.isUnifiedPlanSupported())},s}()),Ew={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:["turn:eu-0.turn.peerjs.com:3478","turn:us-0.turn.peerjs.com:3478"],username:"peerjs",credential:"peerjsp"}],sdpSemantics:"unified-plan"},fA=function(){function s(){this.CLOUD_HOST="0.peerjs.com",this.CLOUD_PORT=443,this.chunkedBrowsers={Chrome:1,chrome:1},this.chunkedMTU=16300,this.defaultConfig=Ew,this.browser=zd.getBrowser(),this.browserVersion=zd.getVersion(),this.supports=function(){var t={browser:zd.isBrowserSupported(),webRTC:zd.isWebRTCSupported(),audioVideo:!1,data:!1,binaryBlob:!1,reliable:!1};if(!t.webRTC)return t;var e;try{e=new RTCPeerConnection(Ew),t.audioVideo=!0;var i=void 0;try{i=e.createDataChannel("_PEERJSTEST",{ordered:!0}),t.data=!0,t.reliable=!!i.ordered;try{i.binaryType="blob",t.binaryBlob=!zd.isIOS}catch{}}catch{}finally{i&&i.close()}}catch{}finally{e&&e.close()}return t}(),this.pack=_w.pack,this.unpack=_w.unpack,this._dataCount=1}return s.prototype.noop=function(){},s.prototype.validateId=function(t){return!t||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.test(t)},s.prototype.chunk=function(t){for(var e=[],i=t.size,n=Math.ceil(i/$e.chunkedMTU),o=0,r=0;r<i;){var l=Math.min(i,r+$e.chunkedMTU),c=t.slice(r,l),h={__peerData:this._dataCount,n:o,data:c,total:n};e.push(h),r=l,o++}return this._dataCount++,e},s.prototype.blobToArrayBuffer=function(t,e){var i=new FileReader;return i.onload=function(n){n.target&&e(n.target.result)},i.readAsArrayBuffer(t),i},s.prototype.binaryStringToArrayBuffer=function(t){for(var e=new Uint8Array(t.length),i=0;i<t.length;i++)e[i]=t.charCodeAt(i)&255;return e.buffer},s.prototype.randomToken=function(){return Math.random().toString(36).slice(2)},s.prototype.isSecure=function(){return location.protocol==="https:"},s}(),$e=new fA,kP={};Jo(kP,"Peer",()=>O_,s=>O_=s);var Rf={},pA=Object.prototype.hasOwnProperty,fn="~";function uf(){}Object.create&&(uf.prototype=Object.create(null),new uf().__proto__||(fn=!1));function mA(s,t,e){this.fn=s,this.context=t,this.once=e||!1}function EP(s,t,e,i,n){if(typeof e!="function")throw new TypeError("The listener must be a function");var o=new mA(e,i||s,n),r=fn?fn+t:t;return s._events[r]?s._events[r].fn?s._events[r]=[s._events[r],o]:s._events[r].push(o):(s._events[r]=o,s._eventsCount++),s}function tm(s,t){--s._eventsCount===0?s._events=new uf:delete s._events[t]}function Ji(){this._events=new uf,this._eventsCount=0}Ji.prototype.eventNames=function(){var t=[],e,i;if(this._eventsCount===0)return t;for(i in e=this._events)pA.call(e,i)&&t.push(fn?i.slice(1):i);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(e)):t};Ji.prototype.listeners=function(t){var e=fn?fn+t:t,i=this._events[e];if(!i)return[];if(i.fn)return[i.fn];for(var n=0,o=i.length,r=new Array(o);n<o;n++)r[n]=i[n].fn;return r};Ji.prototype.listenerCount=function(t){var e=fn?fn+t:t,i=this._events[e];return i?i.fn?1:i.length:0};Ji.prototype.emit=function(t,e,i,n,o,r){var l=fn?fn+t:t;if(!this._events[l])return!1;var c=this._events[l],h=arguments.length,d,u;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),h){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,i),!0;case 4:return c.fn.call(c.context,e,i,n),!0;case 5:return c.fn.call(c.context,e,i,n,o),!0;case 6:return c.fn.call(c.context,e,i,n,o,r),!0}for(u=1,d=new Array(h-1);u<h;u++)d[u-1]=arguments[u];c.fn.apply(c.context,d)}else{var f=c.length,p;for(u=0;u<f;u++)switch(c[u].once&&this.removeListener(t,c[u].fn,void 0,!0),h){case 1:c[u].fn.call(c[u].context);break;case 2:c[u].fn.call(c[u].context,e);break;case 3:c[u].fn.call(c[u].context,e,i);break;case 4:c[u].fn.call(c[u].context,e,i,n);break;default:if(!d)for(p=1,d=new Array(h-1);p<h;p++)d[p-1]=arguments[p];c[u].fn.apply(c[u].context,d)}}return!0};Ji.prototype.on=function(t,e,i){return EP(this,t,e,i,!1)};Ji.prototype.once=function(t,e,i){return EP(this,t,e,i,!0)};Ji.prototype.removeListener=function(t,e,i,n){var o=fn?fn+t:t;if(!this._events[o])return this;if(!e)return tm(this,o),this;var r=this._events[o];if(r.fn)r.fn===e&&(!n||r.once)&&(!i||r.context===i)&&tm(this,o);else{for(var l=0,c=[],h=r.length;l<h;l++)(r[l].fn!==e||n&&!r[l].once||i&&r[l].context!==i)&&c.push(r[l]);c.length?this._events[o]=c.length===1?c[0]:c:tm(this,o)}return this};Ji.prototype.removeAllListeners=function(t){var e;return t?(e=fn?fn+t:t,this._events[e]&&tm(this,e)):(this._events=new uf,this._eventsCount=0),this};Ji.prototype.off=Ji.prototype.removeListener;Ji.prototype.addListener=Ji.prototype.on;Ji.prefixed=fn;Ji.EventEmitter=Ji;Rf=Ji;var he={};Jo(he,"LogLevel",()=>Sn,s=>Sn=s);Jo(he,"default",()=>Mw,s=>Mw=s);var Sl=function(s,t){var e=typeof Symbol=="function"&&s[Symbol.iterator];if(!e)return s;var i=e.call(s),n,o=[],r;try{for(;(t===void 0||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(l){r={error:l}}finally{try{n&&!n.done&&(e=i.return)&&e.call(i)}finally{if(r)throw r.error}}return o},Cl=function(s,t,e){if(e||arguments.length===2)for(var i=0,n=t.length,o;i<n;i++)(o||!(i in t))&&(o||(o=Array.prototype.slice.call(t,0,i)),o[i]=t[i]);return s.concat(o||Array.prototype.slice.call(t))},gA="PeerJS: ",Sn;(function(s){s[s.Disabled=0]="Disabled",s[s.Errors=1]="Errors",s[s.Warnings=2]="Warnings",s[s.All=3]="All"})(Sn||(Sn={}));var yA=function(){function s(){this._logLevel=Sn.Disabled}return Object.defineProperty(s.prototype,"logLevel",{get:function(){return this._logLevel},set:function(t){this._logLevel=t},enumerable:!1,configurable:!0}),s.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logLevel>=Sn.All&&this._print.apply(this,Cl([Sn.All],Sl(t),!1))},s.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logLevel>=Sn.Warnings&&this._print.apply(this,Cl([Sn.Warnings],Sl(t),!1))},s.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logLevel>=Sn.Errors&&this._print.apply(this,Cl([Sn.Errors],Sl(t),!1))},s.prototype.setLogFunction=function(t){this._print=t},s.prototype._print=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var n=Cl([gA],Sl(e),!1);for(var o in n)n[o]instanceof Error&&(n[o]="("+n[o].name+") "+n[o].message);t>=Sn.All?console.log.apply(console,Cl([],Sl(n),!1)):t>=Sn.Warnings?console.warn.apply(console,Cl(["WARNING"],Sl(n),!1)):t>=Sn.Errors&&console.error.apply(console,Cl(["ERROR"],Sl(n),!1))},s}(),Mw=new yA,MP={};Jo(MP,"Socket",()=>Aw,s=>Aw=s);var Vs;(function(s){s.Data="data",s.Media="media"})(Vs||(Vs={}));var At;(function(s){s.BrowserIncompatible="browser-incompatible",s.Disconnected="disconnected",s.InvalidID="invalid-id",s.InvalidKey="invalid-key",s.Network="network",s.PeerUnavailable="peer-unavailable",s.SslUnavailable="ssl-unavailable",s.ServerError="server-error",s.SocketError="socket-error",s.SocketClosed="socket-closed",s.UnavailableID="unavailable-id",s.WebRTC="webrtc"})(At||(At={}));var br;(function(s){s.Binary="binary",s.BinaryUTF8="binary-utf8",s.JSON="json"})(br||(br={}));var Er;(function(s){s.Message="message",s.Disconnected="disconnected",s.Error="error",s.Close="close"})(Er||(Er={}));var wi;(function(s){s.Heartbeat="HEARTBEAT",s.Candidate="CANDIDATE",s.Offer="OFFER",s.Answer="ANSWER",s.Open="OPEN",s.Error="ERROR",s.IdTaken="ID-TAKEN",s.InvalidKey="INVALID-KEY",s.Leave="LEAVE",s.Expire="EXPIRE"})(wi||(wi={}));var q0={};q0=JSON.parse('{"name":"peerjs","version":"1.4.7","keywords":["peerjs","webrtc","p2p","rtc"],"description":"PeerJS client","homepage":"https://peerjs.com","bugs":{"url":"https://github.com/peers/peerjs/issues"},"repository":{"type":"git","url":"https://github.com/peers/peerjs"},"license":"MIT","contributors":["Michelle Bu <michelle@michellebu.com>","afrokick <devbyru@gmail.com>","ericz <really.ez@gmail.com>","Jairo <kidandcat@gmail.com>","Jonas Gloning <34194370+jonasgloning@users.noreply.github.com>","Jairo Caro-Accino Viciana <jairo@galax.be>","Carlos Caballero <carlos.caballero.gonzalez@gmail.com>","hc <hheennrryy@gmail.com>","Muhammad Asif <capripio@gmail.com>","PrashoonB <prashoonbhattacharjee@gmail.com>","Harsh Bardhan Mishra <47351025+HarshCasper@users.noreply.github.com>","akotynski <aleksanderkotbury@gmail.com>","lmb <i@lmb.io>","Jairooo <jairocaro@msn.com>","Moritz St√ºckler <moritz.stueckler@gmail.com>","Simon <crydotsnakegithub@gmail.com>","Denis Lukov <denismassters@gmail.com>","Philipp Hancke <fippo@andyet.net>","Hans Oksendahl <hansoksendahl@gmail.com>","Jess <jessachandler@gmail.com>","khankuan <khankuan@gmail.com>","DUODVK <kurmanov.work@gmail.com>","XiZhao <kwang1imsa@gmail.com>","Matthias Lohr <matthias@lohr.me>","=frank tree <=frnktrb@googlemail.com>","Andre Eckardt <aeckardt@outlook.com>","Chris Cowan <agentme49@gmail.com>","Alex Chuev <alex@chuev.com>","alxnull <alxnull@e.mail.de>","Yemel Jardi <angel.jardi@gmail.com>","Ben Parnell <benjaminparnell.94@gmail.com>","Benny Lichtner <bennlich@gmail.com>","fresheneesz <bitetrudpublic@gmail.com>","bob.barstead@exaptive.com <bob.barstead@exaptive.com>","chandika <chandika@gmail.com>","emersion <contact@emersion.fr>","Christopher Van <cvan@users.noreply.github.com>","eddieherm <edhermoso@gmail.com>","Eduardo Pinho <enet4mikeenet@gmail.com>","Evandro Zanatta <ezanatta@tray.net.br>","Gardner Bickford <gardner@users.noreply.github.com>","Gian Luca <gianluca.cecchi@cynny.com>","PatrickJS <github@gdi2290.com>","jonnyf <github@jonathanfoss.co.uk>","Hizkia Felix <hizkifw@gmail.com>","Hristo Oskov <hristo.oskov@gmail.com>","Isaac Madwed <i.madwed@gmail.com>","Ilya Konanykhin <ilya.konanykhin@gmail.com>","jasonbarry <jasbarry@me.com>","Jonathan Burke <jonathan.burke.1311@googlemail.com>","Josh Hamit <josh.hamit@gmail.com>","Jordan Austin <jrax86@gmail.com>","Joel Wetzell <jwetzell@yahoo.com>","xizhao <kevin.wang@cloudera.com>","Alberto Torres <kungfoobar@gmail.com>","Jonathan Mayol <mayoljonathan@gmail.com>","Jefferson Felix <me@jsfelix.dev>","Rolf Erik Lekang <me@rolflekang.com>","Kevin Mai-Husan Chia <mhchia@users.noreply.github.com>","Pepijn de Vos <pepijndevos@gmail.com>","JooYoung <qkdlql@naver.com>","Tobias Speicher <rootcommander@gmail.com>","Steve Blaurock <sblaurock@gmail.com>","Kyrylo Shegeda <shegeda@ualberta.ca>","Diwank Singh Tomer <singh@diwank.name>","SoÃàren Balko <Soeren.Balko@gmail.com>","Arpit Solanki <solankiarpit1997@gmail.com>","Yuki Ito <yuki@gnnk.net>","Artur Zayats <zag2art@gmail.com>"],"funding":{"type":"opencollective","url":"https://opencollective.com/peer"},"collective":{"type":"opencollective","url":"https://opencollective.com/peer"},"files":["dist/*"],"sideEffects":["lib/global.ts","lib/supports.ts"],"main":"dist/bundler.cjs","module":"dist/bundler.mjs","browser-minified":"dist/peerjs.min.js","browser-unminified":"dist/peerjs.js","types":"dist/types.d.ts","engines":{"node":">= 10"},"targets":{"types":{"source":"lib/exports.ts"},"main":{"source":"lib/exports.ts","sourceMap":{"inlineSources":true}},"module":{"source":"lib/exports.ts","includeNodeModules":["eventemitter3"],"sourceMap":{"inlineSources":true}},"browser-minified":{"context":"browser","outputFormat":"global","optimize":true,"engines":{"browsers":"cover 99%, not dead"},"source":"lib/global.ts"},"browser-unminified":{"context":"browser","outputFormat":"global","optimize":false,"engines":{"browsers":"cover 99%, not dead"},"source":"lib/global.ts"}},"scripts":{"contributors":"git-authors-cli --print=false && prettier --write package.json && git add package.json package-lock.json && git commit -m \\"chore(contributors): update and sort contributors list\\"","check":"tsc --noEmit","watch":"parcel watch","build":"rm -rf dist && parcel build","prepublishOnly":"npm run build","test":"mocha -r ts-node/register -r jsdom-global/register test/**/*.ts","format":"prettier --write .","semantic-release":"semantic-release"},"devDependencies":{"@parcel/config-default":"^2.5.0","@parcel/packager-ts":"^2.5.0","@parcel/transformer-typescript-tsc":"^2.5.0","@parcel/transformer-typescript-types":"^2.5.0","@semantic-release/changelog":"^6.0.1","@semantic-release/git":"^10.0.1","@types/chai":"^4.3.0","@types/mocha":"^9.1.0","@types/node":"^17.0.18","chai":"^4.3.6","git-authors-cli":"^1.0.40","jsdom":"^19.0.0","jsdom-global":"^3.0.2","mocha":"^9.2.0","mock-socket":"8.0.5","parcel":"^2.5.0","parcel-transformer-tsc-sourcemaps":"^1.0.2","prettier":"^2.6.2","semantic-release":"^19.0.2","standard":"^16.0.4","ts-node":"^10.5.0","typescript":"^4.5.5"},"dependencies":{"@swc/helpers":"^0.3.13","eventemitter3":"^4.0.7","peerjs-js-binarypack":"1.0.1","webrtc-adapter":"^7.7.1"}}');var bA=function(){var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");s(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),_A=function(s,t){var e=typeof Symbol=="function"&&s[Symbol.iterator];if(!e)return s;var i=e.call(s),n,o=[],r;try{for(;(t===void 0||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(l){r={error:l}}finally{try{n&&!n.done&&(e=i.return)&&e.call(i)}finally{if(r)throw r.error}}return o},vA=function(s,t,e){if(e||arguments.length===2)for(var i=0,n=t.length,o;i<n;i++)(o||!(i in t))&&(o||(o=Array.prototype.slice.call(t,0,i)),o[i]=t[i]);return s.concat(o||Array.prototype.slice.call(t))},xA=function(s){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&s[t],i=0;if(e)return e.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&i>=s.length&&(s=void 0),{value:s&&s[i++],done:!s}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},Aw=function(s){bA(t,s);function t(e,i,n,o,r,l){l===void 0&&(l=5e3);var c=s.call(this)||this;c.pingInterval=l,c._disconnected=!0,c._messagesQueue=[];var h=e?"wss://":"ws://";return c._baseUrl=h+i+":"+n+o+"peerjs?key="+r,c}return t.prototype.start=function(e,i){var n=this;this._id=e;var o="".concat(this._baseUrl,"&id=").concat(e,"&token=").concat(i);this._socket||!this._disconnected||(this._socket=new WebSocket(o+"&version="+q0.version),this._disconnected=!1,this._socket.onmessage=function(r){var l;try{l=JSON.parse(r.data),he.default.log("Server message received:",l)}catch{he.default.log("Invalid server message",r.data);return}n.emit(Er.Message,l)},this._socket.onclose=function(r){n._disconnected||(he.default.log("Socket closed.",r),n._cleanup(),n._disconnected=!0,n.emit(Er.Disconnected))},this._socket.onopen=function(){n._disconnected||(n._sendQueuedMessages(),he.default.log("Socket open"),n._scheduleHeartbeat())})},t.prototype._scheduleHeartbeat=function(){var e=this;this._wsPingTimer=setTimeout(function(){e._sendHeartbeat()},this.pingInterval)},t.prototype._sendHeartbeat=function(){if(!this._wsOpen()){he.default.log("Cannot send heartbeat, because socket closed");return}var e=JSON.stringify({type:wi.Heartbeat});this._socket.send(e),this._scheduleHeartbeat()},t.prototype._wsOpen=function(){return!!this._socket&&this._socket.readyState===1},t.prototype._sendQueuedMessages=function(){var e,i,n=vA([],_A(this._messagesQueue),!1);this._messagesQueue=[];try{for(var o=xA(n),r=o.next();!r.done;r=o.next()){var l=r.value;this.send(l)}}catch(c){e={error:c}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(e)throw e.error}}},t.prototype.send=function(e){if(!this._disconnected){if(!this._id){this._messagesQueue.push(e);return}if(!e.type){this.emit(Er.Error,"Invalid message");return}if(this._wsOpen()){var i=JSON.stringify(e);this._socket.send(i)}}},t.prototype.close=function(){this._disconnected||(this._cleanup(),this._disconnected=!0)},t.prototype._cleanup=function(){this._socket&&(this._socket.onopen=this._socket.onmessage=this._socket.onclose=null,this._socket.close(),this._socket=void 0),clearTimeout(this._wsPingTimer)},t}(Rf.EventEmitter),T_={};Jo(T_,"MediaConnection",()=>Dw,s=>Dw=s);var X0={};Jo(X0,"Negotiator",()=>Iw,s=>Iw=s);var Cm=function(){return Cm=Object.assign||function(s){for(var t,e=1,i=arguments.length;e<i;e++){t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(s[n]=t[n])}return s},Cm.apply(this,arguments)},mp=function(s,t,e,i){function n(o){return o instanceof e?o:new e(function(r){r(o)})}return new(e||(e=Promise))(function(o,r){function l(d){try{h(i.next(d))}catch(u){r(u)}}function c(d){try{h(i.throw(d))}catch(u){r(u)}}function h(d){d.done?o(d.value):n(d.value).then(l,c)}h((i=i.apply(s,t||[])).next())})},gp=function(s,t){var e={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},i,n,o,r;return r={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(r[Symbol.iterator]=function(){return this}),r;function l(h){return function(d){return c([h,d])}}function c(h){if(i)throw new TypeError("Generator is already executing.");for(;e;)try{if(i=1,n&&(o=h[0]&2?n.return:h[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,h[1])).done)return o;switch(n=0,o&&(h=[h[0]&2,o.value]),h[0]){case 0:case 1:o=h;break;case 4:return e.label++,{value:h[1],done:!1};case 5:e.label++,n=h[1],h=[0];continue;case 7:h=e.ops.pop(),e.trys.pop();continue;default:if(o=e.trys,!(o=o.length>0&&o[o.length-1])&&(h[0]===6||h[0]===2)){e=0;continue}if(h[0]===3&&(!o||h[1]>o[0]&&h[1]<o[3])){e.label=h[1];break}if(h[0]===6&&e.label<o[1]){e.label=o[1],o=h;break}if(o&&e.label<o[2]){e.label=o[2],e.ops.push(h);break}o[2]&&e.ops.pop(),e.trys.pop();continue}h=t.call(s,e)}catch(d){h=[6,d],n=0}finally{i=o=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}},Iw=function(){function s(t){this.connection=t}return s.prototype.startConnection=function(t){var e=this._startPeerConnection();if(this.connection.peerConnection=e,this.connection.type===Vs.Media&&t._stream&&this._addTracksToConnection(t._stream,e),t.originator){if(this.connection.type===Vs.Data){var i=this.connection,n={ordered:!!t.reliable},o=e.createDataChannel(i.label,n);i.initialize(o)}this._makeOffer()}else this.handleSDP("OFFER",t.sdp)},s.prototype._startPeerConnection=function(){he.default.log("Creating RTCPeerConnection.");var t=new RTCPeerConnection(this.connection.provider.options.config);return this._setupListeners(t),t},s.prototype._setupListeners=function(t){var e=this,i=this.connection.peer,n=this.connection.connectionId,o=this.connection.type,r=this.connection.provider;he.default.log("Listening for ICE candidates."),t.onicecandidate=function(l){!l.candidate||!l.candidate.candidate||(he.default.log("Received ICE candidates for ".concat(i,":"),l.candidate),r.socket.send({type:wi.Candidate,payload:{candidate:l.candidate,type:o,connectionId:n},dst:i}))},t.oniceconnectionstatechange=function(){switch(t.iceConnectionState){case"failed":he.default.log("iceConnectionState is failed, closing connections to "+i),e.connection.emit("error",new Error("Negotiation of connection to "+i+" failed.")),e.connection.close();break;case"closed":he.default.log("iceConnectionState is closed, closing connections to "+i),e.connection.emit("error",new Error("Connection to "+i+" closed.")),e.connection.close();break;case"disconnected":he.default.log("iceConnectionState changed to disconnected on the connection with "+i);break;case"completed":t.onicecandidate=$e.noop;break}e.connection.emit("iceStateChanged",t.iceConnectionState)},he.default.log("Listening for data channel"),t.ondatachannel=function(l){he.default.log("Received data channel");var c=l.channel,h=r.getConnection(i,n);h.initialize(c)},he.default.log("Listening for remote stream"),t.ontrack=function(l){he.default.log("Received remote stream");var c=l.streams[0],h=r.getConnection(i,n);if(h.type===Vs.Media){var d=h;e._addStreamToMediaConnection(c,d)}}},s.prototype.cleanup=function(){he.default.log("Cleaning up PeerConnection to "+this.connection.peer);var t=this.connection.peerConnection;if(t){this.connection.peerConnection=null,t.onicecandidate=t.oniceconnectionstatechange=t.ondatachannel=t.ontrack=function(){};var e=t.signalingState!=="closed",i=!1;if(this.connection.type===Vs.Data){var n=this.connection,o=n.dataChannel;o&&(i=!!o.readyState&&o.readyState!=="closed")}(e||i)&&t.close()}},s.prototype._makeOffer=function(){return mp(this,void 0,Promise,function(){var t,e,i,n,o,r,l;return gp(this,function(c){switch(c.label){case 0:t=this.connection.peerConnection,e=this.connection.provider,c.label=1;case 1:return c.trys.push([1,7,,8]),[4,t.createOffer(this.connection.options.constraints)];case 2:i=c.sent(),he.default.log("Created offer."),this.connection.options.sdpTransform&&typeof this.connection.options.sdpTransform=="function"&&(i.sdp=this.connection.options.sdpTransform(i.sdp)||i.sdp),c.label=3;case 3:return c.trys.push([3,5,,6]),[4,t.setLocalDescription(i)];case 4:return c.sent(),he.default.log("Set localDescription:",i,"for:".concat(this.connection.peer)),n={sdp:i,type:this.connection.type,connectionId:this.connection.connectionId,metadata:this.connection.metadata,browser:$e.browser},this.connection.type===Vs.Data&&(o=this.connection,n=Cm(Cm({},n),{label:o.label,reliable:o.reliable,serialization:o.serialization})),e.socket.send({type:wi.Offer,payload:n,dst:this.connection.peer}),[3,6];case 5:return r=c.sent(),r!="OperationError: Failed to set local offer sdp: Called in wrong state: kHaveRemoteOffer"&&(e.emitError(At.WebRTC,r),he.default.log("Failed to setLocalDescription, ",r)),[3,6];case 6:return[3,8];case 7:return l=c.sent(),e.emitError(At.WebRTC,l),he.default.log("Failed to createOffer, ",l),[3,8];case 8:return[2]}})})},s.prototype._makeAnswer=function(){return mp(this,void 0,Promise,function(){var t,e,i,n,o;return gp(this,function(r){switch(r.label){case 0:t=this.connection.peerConnection,e=this.connection.provider,r.label=1;case 1:return r.trys.push([1,7,,8]),[4,t.createAnswer()];case 2:i=r.sent(),he.default.log("Created answer."),this.connection.options.sdpTransform&&typeof this.connection.options.sdpTransform=="function"&&(i.sdp=this.connection.options.sdpTransform(i.sdp)||i.sdp),r.label=3;case 3:return r.trys.push([3,5,,6]),[4,t.setLocalDescription(i)];case 4:return r.sent(),he.default.log("Set localDescription:",i,"for:".concat(this.connection.peer)),e.socket.send({type:wi.Answer,payload:{sdp:i,type:this.connection.type,connectionId:this.connection.connectionId,browser:$e.browser},dst:this.connection.peer}),[3,6];case 5:return n=r.sent(),e.emitError(At.WebRTC,n),he.default.log("Failed to setLocalDescription, ",n),[3,6];case 6:return[3,8];case 7:return o=r.sent(),e.emitError(At.WebRTC,o),he.default.log("Failed to create answer, ",o),[3,8];case 8:return[2]}})})},s.prototype.handleSDP=function(t,e){return mp(this,void 0,Promise,function(){var i,n,o,r;return gp(this,function(l){switch(l.label){case 0:e=new RTCSessionDescription(e),i=this.connection.peerConnection,n=this.connection.provider,he.default.log("Setting remote description",e),o=this,l.label=1;case 1:return l.trys.push([1,5,,6]),[4,i.setRemoteDescription(e)];case 2:return l.sent(),he.default.log("Set remoteDescription:".concat(t," for:").concat(this.connection.peer)),t!=="OFFER"?[3,4]:[4,o._makeAnswer()];case 3:l.sent(),l.label=4;case 4:return[3,6];case 5:return r=l.sent(),n.emitError(At.WebRTC,r),he.default.log("Failed to setRemoteDescription, ",r),[3,6];case 6:return[2]}})})},s.prototype.handleCandidate=function(t){return mp(this,void 0,Promise,function(){var e,i,n,o,r,l;return gp(this,function(c){switch(c.label){case 0:he.default.log("handleCandidate:",t),e=t.candidate,i=t.sdpMLineIndex,n=t.sdpMid,o=this.connection.peerConnection,r=this.connection.provider,c.label=1;case 1:return c.trys.push([1,3,,4]),[4,o.addIceCandidate(new RTCIceCandidate({sdpMid:n,sdpMLineIndex:i,candidate:e}))];case 2:return c.sent(),he.default.log("Added ICE candidate for:".concat(this.connection.peer)),[3,4];case 3:return l=c.sent(),r.emitError(At.WebRTC,l),he.default.log("Failed to handleCandidate, ",l),[3,4];case 4:return[2]}})})},s.prototype._addTracksToConnection=function(t,e){if(he.default.log("add tracks from stream ".concat(t.id," to peer connection")),!e.addTrack)return he.default.error("Your browser does't support RTCPeerConnection#addTrack. Ignored.");t.getTracks().forEach(function(i){e.addTrack(i,t)})},s.prototype._addStreamToMediaConnection=function(t,e){he.default.log("add stream ".concat(t.id," to media connection ").concat(e.connectionId)),e.addStream(t)},s}(),Q0={};Jo(Q0,"BaseConnection",()=>Lw,s=>Lw=s);var wA=function(){var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");s(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),Lw=function(s){wA(t,s);function t(e,i,n){var o=s.call(this)||this;return o.peer=e,o.provider=i,o.options=n,o._open=!1,o.metadata=n.metadata,o}return Object.defineProperty(t.prototype,"open",{get:function(){return this._open},enumerable:!1,configurable:!0}),t}(Rf.EventEmitter),SA=function(){var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");s(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),Pm=function(){return Pm=Object.assign||function(s){for(var t,e=1,i=arguments.length;e<i;e++){t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(s[n]=t[n])}return s},Pm.apply(this,arguments)},CA=function(s){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&s[t],i=0;if(e)return e.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&i>=s.length&&(s=void 0),{value:s&&s[i++],done:!s}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},Dw=function(s){SA(t,s);function t(e,i,n){var o=s.call(this,e,i,n)||this;return o._localStream=o.options._stream,o.connectionId=o.options.connectionId||t.ID_PREFIX+$e.randomToken(),o._negotiator=new X0.Negotiator(o),o._localStream&&o._negotiator.startConnection({_stream:o._localStream,originator:!0}),o}return Object.defineProperty(t.prototype,"type",{get:function(){return Vs.Media},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"localStream",{get:function(){return this._localStream},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"remoteStream",{get:function(){return this._remoteStream},enumerable:!1,configurable:!0}),t.prototype.addStream=function(e){he.default.log("Receiving stream",e),this._remoteStream=e,s.prototype.emit.call(this,"stream",e)},t.prototype.handleMessage=function(e){var i=e.type,n=e.payload;switch(e.type){case wi.Answer:this._negotiator.handleSDP(i,n.sdp),this._open=!0;break;case wi.Candidate:this._negotiator.handleCandidate(n.candidate);break;default:he.default.warn("Unrecognized message type:".concat(i," from peer:").concat(this.peer));break}},t.prototype.answer=function(e,i){var n,o;if(i===void 0&&(i={}),this._localStream){he.default.warn("Local stream already exists on this MediaConnection. Are you answering a call twice?");return}this._localStream=e,i&&i.sdpTransform&&(this.options.sdpTransform=i.sdpTransform),this._negotiator.startConnection(Pm(Pm({},this.options._payload),{_stream:e}));var r=this.provider._getMessages(this.connectionId);try{for(var l=CA(r),c=l.next();!c.done;c=l.next()){var h=c.value;this.handleMessage(h)}}catch(d){n={error:d}}finally{try{c&&!c.done&&(o=l.return)&&o.call(l)}finally{if(n)throw n.error}}this._open=!0},t.prototype.close=function(){this._negotiator&&(this._negotiator.cleanup(),this._negotiator=null),this._localStream=null,this._remoteStream=null,this.provider&&(this.provider._removeConnection(this),this.provider=null),this.options&&this.options._stream&&(this.options._stream=null),this.open&&(this._open=!1,s.prototype.emit.call(this,"close"))},t.ID_PREFIX="mc_",t}(Q0.BaseConnection),R_={};Jo(R_,"DataConnection",()=>Fw,s=>Fw=s);var AP={};Jo(AP,"EncodingQueue",()=>jw,s=>jw=s);var PA=function(){var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");s(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),jw=function(s){PA(t,s);function t(){var e=s.call(this)||this;return e.fileReader=new FileReader,e._queue=[],e._processing=!1,e.fileReader.onload=function(i){e._processing=!1,i.target&&e.emit("done",i.target.result),e.doNextTask()},e.fileReader.onerror=function(i){he.default.error("EncodingQueue error:",i),e._processing=!1,e.destroy(),e.emit("error",i)},e}return Object.defineProperty(t.prototype,"queue",{get:function(){return this._queue},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this.queue.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"processing",{get:function(){return this._processing},enumerable:!1,configurable:!0}),t.prototype.enque=function(e){this.queue.push(e),!this.processing&&this.doNextTask()},t.prototype.destroy=function(){this.fileReader.abort(),this._queue=[]},t.prototype.doNextTask=function(){this.size!==0&&(this.processing||(this._processing=!0,this.fileReader.readAsArrayBuffer(this.queue.shift())))},t}(Rf.EventEmitter),TA=function(){var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");s(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),RA=function(s){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&s[t],i=0;if(e)return e.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&i>=s.length&&(s=void 0),{value:s&&s[i++],done:!s}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},Fw=function(s){TA(t,s);function t(e,i,n){var o=s.call(this,e,i,n)||this;return o.stringify=JSON.stringify,o.parse=JSON.parse,o._buffer=[],o._bufferSize=0,o._buffering=!1,o._chunkedData={},o._encodingQueue=new AP.EncodingQueue,o.connectionId=o.options.connectionId||t.ID_PREFIX+$e.randomToken(),o.label=o.options.label||o.connectionId,o.serialization=o.options.serialization||br.Binary,o.reliable=!!o.options.reliable,o._encodingQueue.on("done",function(r){o._bufferedSend(r)}),o._encodingQueue.on("error",function(){he.default.error("DC#".concat(o.connectionId,": Error occured in encoding from blob to arraybuffer, close DC")),o.close()}),o._negotiator=new X0.Negotiator(o),o._negotiator.startConnection(o.options._payload||{originator:!0}),o}return Object.defineProperty(t.prototype,"type",{get:function(){return Vs.Data},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dataChannel",{get:function(){return this._dc},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bufferSize",{get:function(){return this._bufferSize},enumerable:!1,configurable:!0}),t.prototype.initialize=function(e){this._dc=e,this._configureDataChannel()},t.prototype._configureDataChannel=function(){var e=this;(!$e.supports.binaryBlob||$e.supports.reliable)&&(this.dataChannel.binaryType="arraybuffer"),this.dataChannel.onopen=function(){he.default.log("DC#".concat(e.connectionId," dc connection success")),e._open=!0,e.emit("open")},this.dataChannel.onmessage=function(i){he.default.log("DC#".concat(e.connectionId," dc onmessage:"),i.data),e._handleDataMessage(i)},this.dataChannel.onclose=function(){he.default.log("DC#".concat(e.connectionId," dc closed for:"),e.peer),e.close()}},t.prototype._handleDataMessage=function(e){var i=this,n=e.data,o=n.constructor,r=this.serialization===br.Binary||this.serialization===br.BinaryUTF8,l=n;if(r){if(o===Blob){$e.blobToArrayBuffer(n,function(h){var d=$e.unpack(h);i.emit("data",d)});return}else if(o===ArrayBuffer)l=$e.unpack(n);else if(o===String){var c=$e.binaryStringToArrayBuffer(n);l=$e.unpack(c)}}else this.serialization===br.JSON&&(l=this.parse(n));if(l.__peerData){this._handleChunk(l);return}s.prototype.emit.call(this,"data",l)},t.prototype._handleChunk=function(e){var i=e.__peerData,n=this._chunkedData[i]||{data:[],count:0,total:e.total};if(n.data[e.n]=e.data,n.count++,this._chunkedData[i]=n,n.total===n.count){delete this._chunkedData[i];var o=new Blob(n.data);this._handleDataMessage({data:o})}},t.prototype.close=function(){this._buffer=[],this._bufferSize=0,this._chunkedData={},this._negotiator&&(this._negotiator.cleanup(),this._negotiator=null),this.provider&&(this.provider._removeConnection(this),this.provider=null),this.dataChannel&&(this.dataChannel.onopen=null,this.dataChannel.onmessage=null,this.dataChannel.onclose=null,this._dc=null),this._encodingQueue&&(this._encodingQueue.destroy(),this._encodingQueue.removeAllListeners(),this._encodingQueue=null),this.open&&(this._open=!1,s.prototype.emit.call(this,"close"))},t.prototype.send=function(e,i){if(!this.open){s.prototype.emit.call(this,"error",new Error("Connection is not open. You should listen for the `open` event before sending messages."));return}if(this.serialization===br.JSON)this._bufferedSend(this.stringify(e));else if(this.serialization===br.Binary||this.serialization===br.BinaryUTF8){var n=$e.pack(e);if(!i&&n.size>$e.chunkedMTU){this._sendChunks(n);return}$e.supports.binaryBlob?this._bufferedSend(n):this._encodingQueue.enque(n)}else this._bufferedSend(e)},t.prototype._bufferedSend=function(e){(this._buffering||!this._trySend(e))&&(this._buffer.push(e),this._bufferSize=this._buffer.length)},t.prototype._trySend=function(e){var i=this;if(!this.open)return!1;if(this.dataChannel.bufferedAmount>t.MAX_BUFFERED_AMOUNT)return this._buffering=!0,setTimeout(function(){i._buffering=!1,i._tryBuffer()},50),!1;try{this.dataChannel.send(e)}catch(n){return he.default.error("DC#:".concat(this.connectionId," Error when sending:"),n),this._buffering=!0,this.close(),!1}return!0},t.prototype._tryBuffer=function(){if(this.open&&this._buffer.length!==0){var e=this._buffer[0];this._trySend(e)&&(this._buffer.shift(),this._bufferSize=this._buffer.length,this._tryBuffer())}},t.prototype._sendChunks=function(e){var i,n,o=$e.chunk(e);he.default.log("DC#".concat(this.connectionId," Try to send ").concat(o.length," chunks..."));try{for(var r=RA(o),l=r.next();!l.done;l=r.next()){var c=l.value;this.send(c,!0)}}catch(h){i={error:h}}finally{try{l&&!l.done&&(n=r.return)&&n.call(r)}finally{if(i)throw i.error}}},t.prototype.handleMessage=function(e){var i=e.payload;switch(e.type){case wi.Answer:this._negotiator.handleSDP(e.type,i.sdp);break;case wi.Candidate:this._negotiator.handleCandidate(i.candidate);break;default:he.default.warn("Unrecognized message type:",e.type,"from peer:",this.peer);break}},t.ID_PREFIX="dc_",t.MAX_BUFFERED_AMOUNT=8388608,t}(Q0.BaseConnection),IP={};Jo(IP,"API",()=>Nw,s=>Nw=s);var Bw=function(s,t,e,i){function n(o){return o instanceof e?o:new e(function(r){r(o)})}return new(e||(e=Promise))(function(o,r){function l(d){try{h(i.next(d))}catch(u){r(u)}}function c(d){try{h(i.throw(d))}catch(u){r(u)}}function h(d){d.done?o(d.value):n(d.value).then(l,c)}h((i=i.apply(s,t||[])).next())})},Uw=function(s,t){var e={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},i,n,o,r;return r={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(r[Symbol.iterator]=function(){return this}),r;function l(h){return function(d){return c([h,d])}}function c(h){if(i)throw new TypeError("Generator is already executing.");for(;e;)try{if(i=1,n&&(o=h[0]&2?n.return:h[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,h[1])).done)return o;switch(n=0,o&&(h=[h[0]&2,o.value]),h[0]){case 0:case 1:o=h;break;case 4:return e.label++,{value:h[1],done:!1};case 5:e.label++,n=h[1],h=[0];continue;case 7:h=e.ops.pop(),e.trys.pop();continue;default:if(o=e.trys,!(o=o.length>0&&o[o.length-1])&&(h[0]===6||h[0]===2)){e=0;continue}if(h[0]===3&&(!o||h[1]>o[0]&&h[1]<o[3])){e.label=h[1];break}if(h[0]===6&&e.label<o[1]){e.label=o[1],o=h;break}if(o&&e.label<o[2]){e.label=o[2],e.ops.push(h);break}o[2]&&e.ops.pop(),e.trys.pop();continue}h=t.call(s,e)}catch(d){h=[6,d],n=0}finally{i=o=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}},Nw=function(){function s(t){this._options=t}return s.prototype._buildRequest=function(t){var e=this._options.secure?"https":"http",i=this._options,n=i.host,o=i.port,r=i.path,l=i.key,c=new URL("".concat(e,"://").concat(n,":").concat(o).concat(r).concat(l,"/").concat(t));return c.searchParams.set("ts","".concat(Date.now()).concat(Math.random())),c.searchParams.set("version",q0.version),fetch(c.href,{referrerPolicy:this._options.referrerPolicy})},s.prototype.retrieveId=function(){return Bw(this,void 0,Promise,function(){var t,e,i;return Uw(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this._buildRequest("id")];case 1:if(t=n.sent(),t.status!==200)throw new Error("Error. Status:".concat(t.status));return[2,t.text()];case 2:throw e=n.sent(),he.default.error("Error retrieving ID",e),i="",this._options.path==="/"&&this._options.host!==$e.CLOUD_HOST&&(i=" If you passed in a `path` to your self-hosted PeerServer, you'll also need to pass in that same path when creating a new Peer."),new Error("Could not get an ID from the server."+i);case 3:return[2]}})})},s.prototype.listAllPeers=function(){return Bw(this,void 0,Promise,function(){var t,e,i;return Uw(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this._buildRequest("peers")];case 1:if(t=n.sent(),t.status!==200)throw t.status===401?(e="",this._options.host===$e.CLOUD_HOST?e="It looks like you're using the cloud server. You can email team@peerjs.com to enable peer listing for your API key.":e="You need to enable `allow_discovery` on your self-hosted PeerServer to use this feature.",new Error("It doesn't look like you have permission to list peers IDs. "+e)):new Error("Error. Status:".concat(t.status));return[2,t.json()];case 2:throw i=n.sent(),he.default.error("Error retrieving list peers",i),new Error("Could not get list peers from the server."+i);case 3:return[2]}})})},s}(),OA=function(){var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");s(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),_u=function(){return _u=Object.assign||function(s){for(var t,e=1,i=arguments.length;e<i;e++){t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(s[n]=t[n])}return s},_u.apply(this,arguments)},$d=function(s){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&s[t],i=0;if(e)return e.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&i>=s.length&&(s=void 0),{value:s&&s[i++],done:!s}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},kA=function(s,t){var e=typeof Symbol=="function"&&s[Symbol.iterator];if(!e)return s;var i=e.call(s),n,o=[],r;try{for(;(t===void 0||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(l){r={error:l}}finally{try{n&&!n.done&&(e=i.return)&&e.call(i)}finally{if(r)throw r.error}}return o},O_=function(s){OA(t,s);function t(e,i){var n=s.call(this)||this;n._id=null,n._lastServerId=null,n._destroyed=!1,n._disconnected=!1,n._open=!1,n._connections=new Map,n._lostMessages=new Map;var o;return e&&e.constructor==Object?i=e:e&&(o=e.toString()),i=_u({debug:0,host:$e.CLOUD_HOST,port:$e.CLOUD_PORT,path:"/",key:t.DEFAULT_KEY,token:$e.randomToken(),config:$e.defaultConfig,referrerPolicy:"strict-origin-when-cross-origin"},i),n._options=i,n._options.host==="/"&&(n._options.host=window.location.hostname),n._options.path&&(n._options.path[0]!=="/"&&(n._options.path="/"+n._options.path),n._options.path[n._options.path.length-1]!=="/"&&(n._options.path+="/")),n._options.secure===void 0&&n._options.host!==$e.CLOUD_HOST?n._options.secure=$e.isSecure():n._options.host==$e.CLOUD_HOST&&(n._options.secure=!0),n._options.logFunction&&he.default.setLogFunction(n._options.logFunction),he.default.logLevel=n._options.debug||0,n._api=new IP.API(i),n._socket=n._createServerConnection(),!$e.supports.audioVideo&&!$e.supports.data?(n._delayedAbort(At.BrowserIncompatible,"The current browser does not support WebRTC"),n):o&&!$e.validateId(o)?(n._delayedAbort(At.InvalidID,'ID "'.concat(o,'" is invalid')),n):(o?n._initialize(o):n._api.retrieveId().then(function(r){return n._initialize(r)}).catch(function(r){return n._abort(At.ServerError,r)}),n)}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"options",{get:function(){return this._options},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"open",{get:function(){return this._open},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"socket",{get:function(){return this._socket},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"connections",{get:function(){var e,i,n=Object.create(null);try{for(var o=$d(this._connections),r=o.next();!r.done;r=o.next()){var l=kA(r.value,2),c=l[0],h=l[1];n[c]=h}}catch(d){e={error:d}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(e)throw e.error}}return n},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"destroyed",{get:function(){return this._destroyed},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"disconnected",{get:function(){return this._disconnected},enumerable:!1,configurable:!0}),t.prototype._createServerConnection=function(){var e=this,i=new MP.Socket(this._options.secure,this._options.host,this._options.port,this._options.path,this._options.key,this._options.pingInterval);return i.on(Er.Message,function(n){e._handleMessage(n)}),i.on(Er.Error,function(n){e._abort(At.SocketError,n)}),i.on(Er.Disconnected,function(){e.disconnected||(e.emitError(At.Network,"Lost connection to server."),e.disconnect())}),i.on(Er.Close,function(){e.disconnected||e._abort(At.SocketClosed,"Underlying socket is already closed.")}),i},t.prototype._initialize=function(e){this._id=e,this.socket.start(e,this._options.token)},t.prototype._handleMessage=function(e){var i,n,o=e.type,r=e.payload,l=e.src;switch(o){case wi.Open:this._lastServerId=this.id,this._open=!0,this.emit("open",this.id);break;case wi.Error:this._abort(At.ServerError,r.msg);break;case wi.IdTaken:this._abort(At.UnavailableID,'ID "'.concat(this.id,'" is taken'));break;case wi.InvalidKey:this._abort(At.InvalidKey,'API KEY "'.concat(this._options.key,'" is invalid'));break;case wi.Leave:he.default.log("Received leave message from ".concat(l)),this._cleanupPeer(l),this._connections.delete(l);break;case wi.Expire:this.emitError(At.PeerUnavailable,"Could not connect to peer ".concat(l));break;case wi.Offer:var b=r.connectionId,x=this.getConnection(l,b);if(x&&(x.close(),he.default.warn("Offer received for existing Connection ID:".concat(b))),r.type===Vs.Media){var c=new T_.MediaConnection(l,this,{connectionId:b,_payload:r,metadata:r.metadata});x=c,this._addConnection(l,x),this.emit("call",c)}else if(r.type===Vs.Data){var h=new R_.DataConnection(l,this,{connectionId:b,_payload:r,metadata:r.metadata,label:r.label,serialization:r.serialization,reliable:r.reliable});x=h,this._addConnection(l,x),this.emit("connection",h)}else{he.default.warn("Received malformed connection type:".concat(r.type));return}var d=this._getMessages(b);try{for(var u=$d(d),f=u.next();!f.done;f=u.next()){var p=f.value;x.handleMessage(p)}}catch(v){i={error:v}}finally{try{f&&!f.done&&(n=u.return)&&n.call(u)}finally{if(i)throw i.error}}break;default:if(!r){he.default.warn("You received a malformed message from ".concat(l," of type ").concat(o));return}var b=r.connectionId,x=this.getConnection(l,b);x&&x.peerConnection?x.handleMessage(e):b?this._storeMessage(b,e):he.default.warn("You received an unrecognized message:",e);break}},t.prototype._storeMessage=function(e,i){this._lostMessages.has(e)||this._lostMessages.set(e,[]),this._lostMessages.get(e).push(i)},t.prototype._getMessages=function(e){var i=this._lostMessages.get(e);return i?(this._lostMessages.delete(e),i):[]},t.prototype.connect=function(e,i){if(i===void 0&&(i={}),this.disconnected){he.default.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect, or call reconnect on this peer if you believe its ID to still be available."),this.emitError(At.Disconnected,"Cannot connect to new Peer after disconnecting from server.");return}var n=new R_.DataConnection(e,this,i);return this._addConnection(e,n),n},t.prototype.call=function(e,i,n){if(n===void 0&&(n={}),this.disconnected){he.default.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect."),this.emitError(At.Disconnected,"Cannot connect to new Peer after disconnecting from server.");return}if(!i){he.default.error("To call a peer, you must provide a stream from your browser's `getUserMedia`.");return}var o=new T_.MediaConnection(e,this,_u(_u({},n),{_stream:i}));return this._addConnection(e,o),o},t.prototype._addConnection=function(e,i){he.default.log("add connection ".concat(i.type,":").concat(i.connectionId," to peerId:").concat(e)),this._connections.has(e)||this._connections.set(e,[]),this._connections.get(e).push(i)},t.prototype._removeConnection=function(e){var i=this._connections.get(e.peer);if(i){var n=i.indexOf(e);n!==-1&&i.splice(n,1)}this._lostMessages.delete(e.connectionId)},t.prototype.getConnection=function(e,i){var n,o,r=this._connections.get(e);if(!r)return null;try{for(var l=$d(r),c=l.next();!c.done;c=l.next()){var h=c.value;if(h.connectionId===i)return h}}catch(d){n={error:d}}finally{try{c&&!c.done&&(o=l.return)&&o.call(l)}finally{if(n)throw n.error}}return null},t.prototype._delayedAbort=function(e,i){var n=this;setTimeout(function(){n._abort(e,i)},0)},t.prototype._abort=function(e,i){he.default.error("Aborting!"),this.emitError(e,i),this._lastServerId?this.disconnect():this.destroy()},t.prototype.emitError=function(e,i){he.default.error("Error:",i);var n;typeof i=="string"?n=new Error(i):n=i,n.type=e,this.emit("error",n)},t.prototype.destroy=function(){this.destroyed||(he.default.log("Destroy peer with ID:".concat(this.id)),this.disconnect(),this._cleanup(),this._destroyed=!0,this.emit("close"))},t.prototype._cleanup=function(){var e,i;try{for(var n=$d(this._connections.keys()),o=n.next();!o.done;o=n.next()){var r=o.value;this._cleanupPeer(r),this._connections.delete(r)}}catch(l){e={error:l}}finally{try{o&&!o.done&&(i=n.return)&&i.call(n)}finally{if(e)throw e.error}}this.socket.removeAllListeners()},t.prototype._cleanupPeer=function(e){var i,n,o=this._connections.get(e);if(o)try{for(var r=$d(o),l=r.next();!l.done;l=r.next()){var c=l.value;c.close()}}catch(h){i={error:h}}finally{try{l&&!l.done&&(n=r.return)&&n.call(r)}finally{if(i)throw i.error}}},t.prototype.disconnect=function(){if(!this.disconnected){var e=this.id;he.default.log("Disconnect peer with ID:".concat(e)),this._disconnected=!0,this._open=!1,this.socket.close(),this._lastServerId=e,this._id=null,this.emit("disconnected",e)}},t.prototype.reconnect=function(){if(this.disconnected&&!this.destroyed)he.default.log("Attempting reconnection to server with ID ".concat(this._lastServerId)),this._disconnected=!1,this._initialize(this._lastServerId);else{if(this.destroyed)throw new Error("This peer cannot reconnect to the server. It has already been destroyed.");if(!this.disconnected&&!this.open)he.default.error("In a hurry? We're still trying to make the initial connection!");else throw new Error("Peer ".concat(this.id," cannot reconnect because it is not disconnected from the server!"))}},t.prototype.listAllPeers=function(e){var i=this;e===void 0&&(e=function(n){}),this._api.listAllPeers().then(function(n){return e(n)}).catch(function(n){return i._abort(At.ServerError,n)})},t.DEFAULT_KEY="peerjs",t}(Rf.EventEmitter),k_=kP.Peer;const EA=Object.freeze(Object.defineProperty({__proto__:null,get Peer(){return O_},default:k_,util:$e},Symbol.toStringTag,{value:"Module"}));let Y0;function _4(){return Y0}function v4(s){Y0=s}function MA(s,t){return t||(t={}),t={...Y0,...t},s?new k_(s,t):new k_(t)}async function zw(){const s=await qs(()=>Promise.resolve().then(()=>EA),void 0,import.meta.url);return console.log(s),s.default===void 0?s:s.default}var E_;(function(s){s.ConnectionList="connection-list"})(E_||(E_={}));class AA{constructor(){a(this,"_host");a(this,"_client");a(this,"_clientData");this.onEnable()}get isHost(){return this._host!==void 0}onEnable(){const t="HOST-5980e65c-8438-453e-8b35-f13c736dcd81";this.trySetupHost(t)}async trySetupHost(t){const e=await zw(),i=new e(t);i.on("error",n=>{console.error(n),this._host=void 0,this.trySetupClient(t)}),i.on("open",n=>{this._host=new LA(i)})}async trySetupClient(t){const e=await zw();this._client=new e,this._client.on("error",i=>{console.error("Client error",i)}),this._client.on("open",i=>{console.log("client connected",i),this._clientData=this._client.connect(t,{metadata:{id:i}}),this._clientData.on("open",()=>{console.log("Connected to host")}),this._clientData.on("data",n=>{console.log("<<",n)})})}}class IA{constructor(t){a(this,"_peer");this._peer=t}}class LA extends IA{constructor(e){var i;super(e);a(this,"_connections",[]);console.log("I AM THE HOST"),(i=this._peer)==null||i.on("connection",this.onConnection.bind(this)),this._peer.on("close",()=>{this.broadcast("BYE")}),setInterval(()=>{this.broadcast("HELLO")},2e3)}get isHost(){return!0}onConnection(e){console.log("host connection",e),e.on("open",()=>{this._connections.push(e),this.broadcastConnection(e)})}broadcastConnection(e){const i=this._connections.map(n=>{var o;return(o=n.metadata)==null?void 0:o.id}).filter(n=>n!==void 0);this.broadcast({type:E_.ConnectionList,connections:i})}broadcast(e){if(e!=null){console.log(">>",e);for(const i in this._peer.connections){const n=this._peer.connections[i];if(n)if(Array.isArray(n))for(const o of n)o&&o.send(e);else console.warn(n)}}}}var Ns;(function(s){s[s.OnConnection=0]="OnConnection",s[s.OnRoomJoin=1]="OnRoomJoin",s[s.Queued=2]="Queued",s[s.Immediate=3]="Immediate"})(Ns||(Ns={}));const $w="https://urls.needle.tools/default-networking-backend/index";let vn="wss://networking.needle.tools/socket";const In=!!k("debugnet"),yp=!!(In||k("debugowner")),bp=k("debugnetbin");var M_;(function(s){s.ConnectionInfo="connection-start-info"})(M_||(M_={}));var me;(function(s){s.Join="join-room",s.Leave="leave-room",s.JoinedRoom="joined-room",s.LeftRoom="left-room",s.UserJoinedRoom="user-joined-room",s.UserLeftRoom="user-left-room",s.RoomStateSent="room-state-sent"})(me||(me={}));class x4{constructor(){a(this,"room");a(this,"viewId");a(this,"allowEditing");a(this,"inRoom")}}class w4{constructor(){a(this,"room")}}class S4{constructor(){a(this,"userId")}}var $i;(function(s){s.RequestHasOwner="request-has-owner",s.ResponseHasOwner="response-has-owner",s.RequestIsOwner="request-is-owner",s.ResponseIsOwner="response-is-owner",s.RequestOwnership="request-ownership",s.GainedOwnership="gained-ownership",s.RemoveOwnership="remove-ownership",s.LostOwnership="lost-ownership",s.GainedOwnershipBroadcast="gained-ownership-broadcast",s.LostOwnershipBroadcast="lost-ownership-broadcast"})($i||($i={}));class LP{constructor(t,e){a(this,"guid");a(this,"connection");a(this,"_hasOwnership",!1);a(this,"_isOwned");a(this,"_gainSubscription");a(this,"_lostSubscription");a(this,"_hasOwnerResponse");a(this,"_isWaitingForOwnershipResponseCallback",null);this.connection=t,this.guid=e,this._gainSubscription=this.onGainedOwnership.bind(this),this._lostSubscription=this.onLostOwnership.bind(this),t.beginListen($i.LostOwnership,this._lostSubscription),t.beginListen($i.GainedOwnershipBroadcast,this._gainSubscription),this._hasOwnerResponse=this.onHasOwnerResponse.bind(this),t.beginListen($i.ResponseHasOwner,this._hasOwnerResponse)}get hasOwnership(){return this._hasOwnership}get isOwned(){return this._isOwned}get isConnected(){return this.connection.isConnected}updateIsOwned(){this.connection.send($i.RequestHasOwner,{guid:this.guid})}onHasOwnerResponse(t){t.guid===this.guid&&(this._isOwned=t.value)}requestOwnershipIfNotOwned(){return this._isWaitingForOwnershipResponseCallback!==null?this:(this._isWaitingForOwnershipResponseCallback=this.waitForHasOwnershipRequestResponse.bind(this),this.connection.beginListen($i.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this.connection.send($i.RequestHasOwner,{guid:this.guid}),this)}waitForHasOwnershipRequestResponse(t){t.guid===this.guid&&(this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListen($i.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null),this._isOwned=t.value,t.value||(yp&&console.log("request ownership",this.guid),this.requestOwnership()))}requestOwnershipAsync(){return new Promise((t,e)=>{this.requestOwnership();let i=0;const n=()=>{if(i++>10)return e("Timeout");setTimeout(()=>{this.hasOwnership?t(this):n()},100)};n()})}requestOwnership(){return yp&&console.log("Request ownership",this.guid),this.connection.send($i.RequestOwnership,{guid:this.guid}),this}freeOwnership(){return this.connection.send($i.RemoveOwnership,{guid:this.guid}),this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListen($i.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null),this}destroy(){this.connection.stopListen($i.GainedOwnership,this._gainSubscription),this.connection.stopListen($i.LostOwnership,this._lostSubscription),this.connection.stopListen($i.ResponseHasOwner,this._hasOwnerResponse),this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListen($i.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null)}onGainedOwnership(t){t.guid===this.guid&&(this._isOwned=!0,this.connection.connectionId===t.owner?(yp&&console.log("GAINED OWNERSHIP",this.guid),this._hasOwnership=!0):this._hasOwnership=!1)}onLostOwnership(t){t===this.guid&&(yp&&console.log("LOST OWNERSHIP",this.guid),this._hasOwnership=!1,this._isOwned=!1)}}class DA{constructor(t){a(this,"context");a(this,"_peer",null);a(this,"_usersInRoomCopy",[]);a(this,"_defaultMessagesBuffer",[]);a(this,"_defaultMessagesBufferArray",[]);a(this,"netWebSocketUrlProvider");a(this,"_listeners",{});a(this,"_listenersBinary",{});a(this,"connected",!1);a(this,"channelId");a(this,"_connectionId",null);a(this,"_ws");a(this,"_waitingForSocket",{});a(this,"_isInRoom",!1);a(this,"_currentRoomName",null);a(this,"_currentRoomViewId",null);a(this,"_currentRoomAllowEditing",!0);a(this,"_currentInRoom",[]);a(this,"_state",{});a(this,"_currentDelay",-1);a(this,"_connectingToWebsocketPromise",null);this.context=t}get peer(){return this._peer||(this._peer=new AA),this._peer}tryGetState(t){return t==="invalid"?null:this._state[t]}get connectionId(){return this._connectionId}get isDebugEnabled(){return In}get isConnected(){return this.connected}get currentRoomName(){return this._currentRoomName}get allowEditing(){return this._currentRoomAllowEditing}get currentRoomViewId(){return this._currentRoomViewId}getViewOnlyUrl(){if(this.currentRoomViewId===null)return null;const t=new URL(window.location.href);return t.searchParams.set("view",this.currentRoomViewId),t.href}get isInRoom(){return this._isInRoom}get currentLatency(){return this._currentDelay}get currentServerUrl(){var t;return((t=this._ws)==null?void 0:t.url)??null}sendPing(){this.send("ping",{time:this.context.time.time})}userIsInRoom(t){return this._currentInRoom.indexOf(t)!==-1}usersInRoom(t=null){t||(t=this._usersInRoomCopy),t.length=0;for(const e of this._currentInRoom)t.push(e);return t}joinRoom(t,e=!1){return t?t.length>1024?(console.error('Room name too long, can not join: "'+t+'". Max length is 1024 characters.'),!1):(this.isInRoom&&this.currentRoomName!==t&&console.warn("Needle Engine is already connected to a networking room. Connecting to multiple rooms is not supported"),this.connect(),In&&console.log("join: "+t),this.send(me.Join,{room:t,viewOnly:e},Ns.OnConnection),!0):(console.error('Missing room name, can not join: "'+t+'"'),!1)}leaveRoom(t=null){return t||(t=this.currentRoomName),t?(this.send(me.Leave,{room:t}),!0):(console.error('Missing room name, can not join: "'+t+'"'),!1)}send(t,e=null,i=Ns.Queued){if(e===null&&(e={}),i===Ns.Queued){this._defaultMessagesBuffer.push({key:t,value:e});return}return this.sendWithWebsocket(t,e,i)}sendDeleteRemoteState(t){this.send("delete-state",{guid:t,dontSave:!0}),delete this._state[t]}sendDeleteRemoteStateAll(){this.send("delete-all-state"),this._state={}}sendBinary(t){var e;bp&&console.log("<< send binary",this.context.time.frame,t.length/1024+" KB"),(e=this._ws)==null||e.send(t)}sendBufferedMessagesNow(){var i;if(!this._ws)return;this._defaultMessagesBufferArray.length=0;const t=Object.keys(this._defaultMessagesBuffer).length;for(const n in this._defaultMessagesBuffer){const o=this._defaultMessagesBuffer[n];if(t<=1){this.sendWithWebsocket(o.key,o.value,Ns.Immediate);break}const r=this.toMessage(o.key,o.value);this._defaultMessagesBufferArray.push(r)}if(this._defaultMessagesBuffer.length=0,this._defaultMessagesBufferArray.length>0&&In&&console.log("SEND BUFFERED",this._defaultMessagesBufferArray.length),this._defaultMessagesBufferArray.length<=0)return;const e=JSON.stringify(this._defaultMessagesBufferArray);(i=this._ws)==null||i.send(e)}beginListen(t,e){return this._listeners[t]||(this._listeners[t]=[]),this._listeners[t].push(e),e}stopListening(t,e){return this.stopListen(t,e)}stopListen(t,e){if(!e||!this._listeners[t])return;const i=this._listeners[t].indexOf(e);i>=0&&this._listeners[t].splice(i,1)}beginListenBinary(t,e){return this._listenersBinary[t]||(this._listenersBinary[t]=[]),this._listenersBinary[t].push(e),e}stopListenBinary(t,e){if(!this._listenersBinary[t])return;const i=this._listenersBinary[t].indexOf(e);i>=0&&this._listenersBinary[t].splice(i,1)}registerProvider(t){this.netWebSocketUrlProvider=t}async connect(t){var i;if(this.connected&&t&&t!==vn)return Promise.reject("Can not connect to different server url. Please disconnect first.");if(this.connected)return Promise.resolve(!0);t&&console.debug("Connecting to user provided url "+t);const e=t||((i=this.netWebSocketUrlProvider)==null?void 0:i.getWebsocketUrl());return e?vn=e:cE()&&(vn="wss://"+window.location.host+"/socket"),this.connectWebsocket()}disconnect(){var t;(t=this._ws)==null||t.close(),this._ws=void 0,vn=void 0,this._currentRoomAllowEditing=!0,this._currentRoomName=null,this._currentRoomViewId=null,this._isInRoom=!1,this._currentInRoom.length=0,this._state={},this._currentDelay=-1}connectWebsocket(){return this._connectingToWebsocketPromise?this._connectingToWebsocketPromise:this._connectingToWebsocketPromise=new Promise(async(t,e)=>{var h,d;let i=!1;const n=u=>{i||(i=!0,t(u))};if(vn===void 0&&(console.log("Fetch default backend url: "+$w),vn=await(await fetch($w)).text()),vn===void 0){n(!1);return}console.debug(`Connecting to networking backend on
`+vn);const o=await qs(()=>import("./index.d7be2e3b.js"),[],import.meta.url),r=((h=o.default)==null?void 0:h.WebsocketBuilder)??o.WebsocketBuilder,l=((d=o.default)==null?void 0:d.ExponentialBackoff)??o.ExponentialBackoff,c=new r(vn).withMaxRetries(10).withBackoff(new l(2e3,4)).onOpen(()=>{this._connectingToWebsocketPromise=null,this._ws=c,this.connected=!0,X()||In?console.log(`Connected to networking backend
`+vn):console.debug("Connected to networking backend",vn),n(!0),this.onSendQueued(Ns.OnConnection)}).onClose(u=>{this._connectingToWebsocketPromise=null,this.connected=!1,this._isInRoom=!1,n(!1);let f="Websocket connection closed...";vn!=null&&vn.includes("/socket")||(f+=' Do you perhaps mean to connect to "/socket"?'),console.error(f)}).onError(u=>{console.error("Websocket connection failed..."),n(!1),Tn.sendEvent(this.context,"networking",{event:"connection_error"})}).onRetry(()=>{console.log("Retry connecting to networking websocket")}).build();c.addEventListener(o.WebsocketEvent.message,(u,f)=>{this.onMessage(u,f)})})}onMessage(t,e){const i=e.data;try{if(typeof i!="string"){i.size&&this.handleIncomingBinaryMessage(i);return}const n=JSON.parse(i);if(Array.isArray(n))for(const o of n)this.handleIncomingStringMessage(o);else this.handleIncomingStringMessage(n);return}catch(n){In&&i==="pong"?console.log("<<",i):X()&&console.error("Failed to parse message",n)}}async handleIncomingBinaryMessage(t){bp&&console.log("<< bin",this.context.time.frame);const e=await t.arrayBuffer();var i=new Uint8Array(e);const n=new df(i),o=n.getBufferIdentifier(),r=this._listenersBinary[o],l=XM(n),c=QM(l);if(c&&typeof c=="string"&&(this._state[c]=l),!r)return;const h=l??n;for(const d of r)d(h)}handleIncomingStringMessage(t){var n,o;if(In&&console.log("<<",t.key??t),t.key)switch(t.key){case M_.ConnectionInfo:if(t.data){const c=t.data;c&&(console.assert(c.id!==void 0&&c.id!==null&&c.id.length>0,"server did not send connection id",c.id),console.debug("Your id is: "+c.id,this.context.alias??""),this._connectionId=c.id,Tn.sendEvent(this.context,"networking",{event:"connected"}))}else console.warn("Expected connection id in "+t.key);break;case me.JoinedRoom:if(In&&console.log(t),t){this._isInRoom=!0;const c=t;this._currentRoomName=c.room,this._currentRoomViewId=c.viewId,this._currentRoomAllowEditing=c.allowEditing??!0,this._currentInRoom.length=0,this._currentInRoom.push(...c.inRoom),(bp||X())&&console.debug("Joined Needle Engine Room: "+c.room);const h=new URL(window.location.href);h.searchParams.has("room")&&h.searchParams.delete("room"),h.searchParams.set("view",this._currentRoomViewId),console.debug(`Room view id: ${this._currentRoomViewId}
${h.href}`)}this.onSendQueued(Ns.OnRoomJoin),Tn.sendEvent(this.context,"networking",{event:"joined_room",room:this._currentRoomName});break;case me.LeftRoom:const r=t;r.room===this.currentRoomName&&(this._isInRoom=!1,this._currentRoomName=null,this._currentRoomAllowEditing=!0,this._currentInRoom.length=0,(bp||X())&&console.debug("Left Needle Engine Room: "+r.room)),Tn.sendEvent(this.context,"networking",{event:"left_room",room:r.room});break;case me.UserJoinedRoom:if(t.data){const c=t.data;this._currentInRoom.push(c.userId),In&&console.log(c.userId+" joined","now in room:",this._currentInRoom)}break;case me.UserLeftRoom:if(t.data){const c=t.data,h=this._currentInRoom.indexOf(c.userId);h>=0&&(In&&console.log(c.userId+" left","now in room:",this._currentInRoom),this._currentInRoom.splice(h,1)),c.userId===this.connectionId&&console.log("you left the room")}break;case"all-room-state-deleted":In&&console.log("RECEIVED all-room-state-deleted"),this._state={};break;case"ping":case"pong":const l=(n=t.data)==null?void 0:n.time;l&&(this._currentDelay=this.context.time.time-l),In&&console.log(`Current latency: ${(this._currentDelay*1e3).toFixed()} ms`,"Clients in room: "+((o=this._currentInRoom)==null?void 0:o.length));break}const e=t.data;e&&(this._state[e.guid]=e);let i=this._listeners[t.key];if(i){i=[...i];for(const r of i)try{r(t.data)}catch(l){console.error('Error invoking callback for "'+t.key+'"',l)}}}toMessage(t,e){return{key:t,data:e}}sendWithWebsocket(t,e,i=Ns.OnRoomJoin){if(!this._ws){const o=this._waitingForSocket[i]||[];o.push(()=>this.sendWithWebsocket(t,e,i)),this._waitingForSocket[i]=o;return}const n=JSON.stringify(this.toMessage(t,e));In&&console.log(">>",t),this._ws.send(n)}onSendQueued(t){const e=this._waitingForSocket[t];if(e){for(const i of e)i();e.length=0}}}const vu=k("debugwebxr");class eb{constructor(t,e){a(this,"controllerStates",[]);a(this,"userId");a(this,"context");a(this,"userStateEvtName");a(this,"onReceivedControllerState",t=>{vu&&console.log(`XRSync: Received change for ${this.userId}: ${t.type} ${t.handedness}; tracked=${t.isTracking}`);let e=!1;for(let i=0;i<this.controllerStates.length;i++)if(this.controllerStates[i].index===t.index){this.controllerStates[i]=t,e=!0;break}e||this.controllerStates.push(t)});this.userId=t,this.context=e,this.userStateEvtName="xr-sync-user-state-"+t,this.context.connection.beginListen(this.userStateEvtName,this.onReceivedControllerState)}dispose(){this.context.connection.stopListen(this.userStateEvtName,this.onReceivedControllerState)}update(t){if(this.context.connection.isConnected!=!1){for(let e=this.controllerStates.length-1;e>=0;e--){const i=this.controllerStates[e];let n=!1;for(let o=0;o<t.controllers.length;o++)t.controllers[o].index===i.index&&(n=!0);n||(vu&&console.log(`XRSync: ${i.type} ${i.handedness} removed`,i.index),this.controllerStates.splice(e,1),this.sendControllerRemoved(i))}for(const e of t.controllers)this.updateControllerStates(e)}}onExitXR(t){for(const e of this.controllerStates)this.sendControllerRemoved(e);this.controllerStates.length=0}sendControllerRemoved(t){t.isTracking=!1,t.guid="",this.context.connection.send(this.userStateEvtName,t),this.context.connection.sendDeleteRemoteState(t.guid)}updateControllerStates(t){const e=this.controllerStates.find(i=>i.index===t.index);if(e){let i=!1;i||(i=e.isTracking!=t.isTracking),i&&(e.isTracking=t.isTracking,this.context.connection.send(this.userStateEvtName,e))}else{const i={guid:this.userId+"-"+t.index,isTracking:t.isTracking,handedness:t.side,index:t.index,type:t.hand?"hand":"controller"};this.controllerStates.push(i),this.context.connection.send(this.userStateEvtName,i),vu&&console.log(`XRSync: ${i.type} ${i.handedness} added`,i.index)}}}class jA{constructor(t){a(this,"context");a(this,"onJoinedRoom",()=>{if(this.context.connection.connectionId){this._states.has(this.context.connection.connectionId)||(vu&&console.log("XRSync: Local user joined room",this.context.connection.connectionId),this._states.set(this.context.connection.connectionId,new eb(this.context.connection.connectionId,this.context)));for(const t of this.context.connection.usersInRoom())this._states.has(t)||this._states.set(t,new eb(t,this.context))}});a(this,"onLeftRoom",()=>{if(this.context.connection.connectionId&&!this._states.has(this.context.connection.connectionId)){const t=this._states.get(this.context.connection.connectionId);t==null||t.dispose(),this._states.delete(this.context.connection.connectionId)}});a(this,"onOtherUserJoinedRoom",t=>{const e=t.userId;this._states.has(e)||(vu&&console.log("XRSync: Remote user joined room",e),this._states.set(e,new eb(e,this.context)))});a(this,"onOtherUserLeftRoom",t=>{const e=t.userId;if(!this._states.has(e)){const i=this._states.get(e);i==null||i.dispose(),this._states.delete(e)}});a(this,"_states",new Map);this.context=t,this.context.connection.beginListen(me.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(me.LeftRoom,this.onLeftRoom),this.context.connection.beginListen(me.UserJoinedRoom,this.onOtherUserJoinedRoom),this.context.connection.beginListen(me.UserLeftRoom,this.onOtherUserLeftRoom)}hasState(t){return t?this._states.has(t):!1}isTracking(t,e){if(!t)return;const i=this._states.get(t);if(!i)return;const n=i.controllerStates.find(o=>o.handedness===e);return(n==null?void 0:n.isTracking)||!1}getDeviceType(t,e){if(!t)return;const i=this._states.get(t);if(!i)return;const n=i.controllerStates.find(o=>o.handedness===e);return(n==null?void 0:n.type)||"unknown"}destroy(){this.context.connection.stopListen(me.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(me.LeftRoom,this.onLeftRoom),this.context.connection.stopListen(me.UserJoinedRoom,this.onOtherUserJoinedRoom),this.context.connection.stopListen(me.UserLeftRoom,this.onOtherUserLeftRoom)}onUpdate(t){if(this.context.connection.isConnected&&this.context.connection.connectionId){const e=this._states.get(this.context.connection.connectionId);e==null||e.update(t)}}onExitXR(t){if(this.context.connection.isConnected&&this.context.connection.connectionId){const e=this._states.get(this.context.connection.connectionId);e==null||e.onExitXR(t)}}}class Vw{constructor(){a(this,"_fadeToColorQuad");a(this,"_fadeToColorMaterial");a(this,"_requestedFadeValue",0);a(this,"_transitionPromise",null);a(this,"_transitionResolve",null);this._fadeToColorMaterial=new Ye({color:0,transparent:!0,depthTest:!1,fog:!1,side:Qn}),this._fadeToColorQuad=new le(new to(10,10),this._fadeToColorMaterial)}dispose(){this._fadeToColorQuad.geometry.dispose(),this._fadeToColorMaterial.dispose()}update(t,e){const i=this._fadeToColorQuad,n=this._fadeToColorMaterial;i.parent!==t&&n.opacity>0?t.add(i):n.opacity===0&&i.removeFromParent(),i.layers.set(2),i.material=this._fadeToColorMaterial,i.position.z=-1,i.renderOrder=1/0;const o=this._requestedFadeValue;n.opacity=ee.lerp(n.opacity,o,e/.03),Math.abs(n.opacity-o)<=.01&&this._transitionResolve&&(this._transitionResolve(),this._transitionResolve=null,this._transitionPromise=null,this._requestedFadeValue=0)}remove(){this._fadeToColorQuad.removeFromParent()}fadeTransition(){if(this._transitionPromise)return this._transitionPromise;this._requestedFadeValue=1;const t=new Promise(e=>{this._transitionResolve=e});return this._transitionPromise=t,t}}const FA='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 160 187.74"><defs><linearGradient id="a" x1="89.64" y1="184.81" x2="90.48" y2="21.85" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#62d399"/><stop offset=".51" stop-color="#acd842"/><stop offset=".9" stop-color="#d7db0a"/></linearGradient><linearGradient id="b" x1="69.68" y1="178.9" x2="68.08" y2="16.77" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0ba398"/><stop offset=".5" stop-color="#4ca352"/><stop offset="1" stop-color="#76a30a"/></linearGradient><linearGradient id="c" x1="36.6" y1="152.17" x2="34.7" y2="84.19" gradientUnits="userSpaceOnUse"><stop offset=".19" stop-color="#36a382"/><stop offset=".54" stop-color="#49a459"/><stop offset="1" stop-color="#76a30b"/></linearGradient><linearGradient id="d" x1="15.82" y1="153.24" x2="18" y2="90.86" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#267880"/><stop offset=".51" stop-color="#457a5c"/><stop offset="1" stop-color="#717516"/></linearGradient><linearGradient id="e" x1="135.08" y1="135.43" x2="148.93" y2="63.47" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#b0d939"/><stop offset="1" stop-color="#eadb04"/></linearGradient><linearGradient id="f" x1="-4163.25" y1="2285.12" x2="-4160.81" y2="2215.34" gradientTransform="rotate(20 4088.49 13316.712)" gradientUnits="userSpaceOnUse"><stop offset=".17" stop-color="#74af52"/><stop offset=".48" stop-color="#99be32"/><stop offset="1" stop-color="#c0c40a"/></linearGradient><symbol id="g" viewBox="0 0 160 187.74"><path style="fill:url(#a)" d="M79.32 36.98v150.76L95 174.54l6.59-156.31-22.27 18.75z"/><path style="fill:url(#b)" d="M79.32 36.98 57.05 18.23l6.59 156.31 15.68 13.2V36.98z"/><path style="fill:url(#c)" d="m25.19 104.83 8.63 49.04 12.5-14.95-2.46-56.42-18.67 22.33z"/><path style="fill:url(#d)" d="M25.19 104.83 0 90.24l16.97 53.86 16.85 9.77-8.63-49.04z"/><path style="fill:#9c3" d="M43.86 82.5 18.69 67.98 0 90.24l25.18 14.59L43.86 82.5z"/><path style="fill:url(#e)" d="m134.82 78.69-9.97 56.5 15.58-9.04L160 64.1l-25.18 14.59z"/><path style="fill:url(#f)" d="m134.82 78.69-18.68-22.33-2.86 65 11.57 13.83 9.97-56.5z"/><path style="fill:#ffe113" d="m160 64.1-18.69-22.26-25.17 14.52 18.67 22.33L160 64.1z"/><path style="fill:#f3e600" d="M101.59 18.23 79.32 0 57.05 18.23l22.27 18.75 22.27-18.75z"/></symbol></defs><use width="160" height="187.74" xlink:href="#g"/></svg>',BA=btoa(FA),UA="data:image/svg+xml;base64,"+BA,Zh=UA,NA=`<?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'> <svg clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" version="1.1" viewBox="0 0 1014 282" xml:space="preserve" xmlns="http://www.w3.org/2000/svg"> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m665.95 132.73v44.88l-10.56-8.4c-0.8-0.64-1.2-1.44-1.2-2.4v-32.4c0-6.48-4.12-9.72-12.36-9.72-2.16 0-4.18 0.4-6.06 1.2s-3.54 1.8-4.98 3-2.56 2.5-3.36 3.9-1.2 2.7-1.2 3.9v40.92l-10.68-8.4c-0.72-0.64-1.08-1.44-1.08-2.4v-53.76l10.92 8.52c0.32 0.24 0.56 0.44 0.72 0.6s0.36 0.32 0.6 0.48c0.96-1.2 2.14-2.28 3.54-3.24s2.92-1.76 4.56-2.4 3.34-1.14 5.1-1.5 3.44-0.54 5.04-0.54c1.44 0 2.92 0.04 4.44 0.12s2.84 0.28 3.96 0.6c4.56 1.12 7.8 3.12 9.72 6s2.88 6.56 2.88 11.04z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m732.38 146.05c0 0.88 0.02 1.5 0.06 1.86s-0.02 0.98-0.18 1.86h-7.08c-2.08 0-4.44-0.02-7.08-0.06s-5.36-0.06-8.16-0.06h-22.08c0 2.88 0.56 5.36 1.68 7.44s2.6 3.8 4.44 5.16 3.94 2.36 6.3 3 4.74 0.96 7.14 0.96c3.04 0 5.9-0.76 8.58-2.28s4.94-3.52 6.78-6c0.64 0.56 1.54 1.48 2.7 2.76s2.94 3.2 5.34 5.76c-2.8 3.36-6.22 6.02-10.26 7.98s-8.42 2.94-13.14 2.94-8.92-0.64-12.84-1.92-7.32-3.24-10.2-5.88-5.12-5.98-6.72-10.02-2.4-8.82-2.4-14.34c0-4.96 0.66-9.42 1.98-13.38s3.22-7.32 5.7-10.08 5.44-4.9 8.88-6.42 7.32-2.28 11.64-2.28c5.76 0 10.52 0.88 14.28 2.64s6.72 4.16 8.88 7.2 3.66 6.54 4.5 10.5 1.26 8.18 1.26 12.66zm-29.4-22.8c-2.16 0.16-4.16 0.72-6 1.68s-3.42 2.2-4.74 3.72-2.36 3.28-3.12 5.28-1.14 4.12-1.14 6.36h33.12c0-2-0.22-4.06-0.66-6.18s-1.3-4.02-2.58-5.7-3.1-3.02-5.46-4.02-5.5-1.38-9.42-1.14z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m795.93 146.05c0 0.88 0.02 1.5 0.06 1.86s-0.02 0.98-0.18 1.86h-7.08c-2.08 0-4.44-0.02-7.08-0.06s-5.36-0.06-8.16-0.06h-22.08c0 2.88 0.56 5.36 1.68 7.44s2.6 3.8 4.44 5.16 3.94 2.36 6.3 3 4.74 0.96 7.14 0.96c3.04 0 5.9-0.76 8.58-2.28s4.94-3.52 6.78-6c0.64 0.56 1.54 1.48 2.7 2.76s2.94 3.2 5.34 5.76c-2.8 3.36-6.22 6.02-10.26 7.98s-8.42 2.94-13.14 2.94-8.92-0.64-12.84-1.92-7.32-3.24-10.2-5.88-5.12-5.98-6.72-10.02-2.4-8.82-2.4-14.34c0-4.96 0.66-9.42 1.98-13.38s3.22-7.32 5.7-10.08 5.44-4.9 8.88-6.42 7.32-2.28 11.64-2.28c5.76 0 10.52 0.88 14.28 2.64s6.72 4.16 8.88 7.2 3.66 6.54 4.5 10.5 1.26 8.18 1.26 12.66zm-29.4-22.8c-2.16 0.16-4.16 0.72-6 1.68s-3.42 2.2-4.74 3.72-2.36 3.28-3.12 5.28-1.14 4.12-1.14 6.36h33.12c0-2-0.22-4.06-0.66-6.18s-1.3-4.02-2.58-5.7-3.1-3.02-5.46-4.02-5.5-1.38-9.42-1.14z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m858.57 97.21c0.64 0.48 0.96 1.16 0.96 2.04v74.88c-0.08 1.04-0.12 2.12-0.12 3.24-1.84-1.52-3.56-2.92-5.16-4.2-1.36-1.12-2.66-2.18-3.9-3.18s-2.06-1.66-2.46-1.98c-1.76 2.48-4.26 4.44-7.5 5.88s-7.02 2.16-11.34 2.16c-3.84 0-7.4-0.7-10.68-2.1s-6.14-3.44-8.58-6.12-4.34-5.94-5.7-9.78-2.04-8.16-2.04-12.96c0-4.32 0.78-8.34 2.34-12.06s3.6-6.92 6.12-9.6 5.38-4.78 8.58-6.3 6.48-2.28 9.84-2.28c2.56 0 4.82 0.22 6.78 0.66s3.68 1.06 5.16 1.86 2.78 1.74 3.9 2.82 2.16 2.22 3.12 3.42v-35.04l10.68 8.64zm-27.96 67.92c3.6 0 6.52-0.68 8.76-2.04s3.98-3.06 5.22-5.1 2.1-4.22 2.58-6.54 0.72-4.44 0.72-6.36v-1.2c0-1.12-0.22-2.7-0.66-4.74s-1.28-4.06-2.52-6.06-3-3.7-5.28-5.1-5.22-2.02-8.82-1.86c-3.44 0-6.26 0.74-8.46 2.22s-3.96 3.26-5.28 5.34-2.24 4.2-2.76 6.36-0.78 3.92-0.78 5.28c0 1.84 0.24 3.92 0.72 6.24s1.36 4.48 2.64 6.48 3.04 3.68 5.28 5.04 5.12 2.04 8.64 2.04z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m882.81 97.09c0.64 0.48 0.96 1.12 0.96 1.92l-0.12 41.04v37.08l-10.56-8.4c-0.72-0.64-1.08-1.44-1.08-2.4v-77.88l10.8 8.64z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m950.36 146.05c0 0.88 0.02 1.5 0.06 1.86s-0.02 0.98-0.18 1.86h-7.08c-2.08 0-4.44-0.02-7.08-0.06s-5.36-0.06-8.16-0.06h-22.08c0 2.88 0.56 5.36 1.68 7.44s2.6 3.8 4.44 5.16 3.94 2.36 6.3 3 4.74 0.96 7.14 0.96c3.04 0 5.9-0.76 8.58-2.28s4.94-3.52 6.78-6c0.64 0.56 1.54 1.48 2.7 2.76s2.94 3.2 5.34 5.76c-2.8 3.36-6.22 6.02-10.26 7.98s-8.42 2.94-13.14 2.94-8.92-0.64-12.84-1.92-7.32-3.24-10.2-5.88-5.12-5.98-6.72-10.02-2.4-8.82-2.4-14.34c0-4.96 0.66-9.42 1.98-13.38s3.22-7.32 5.7-10.08 5.44-4.9 8.88-6.42 7.32-2.28 11.64-2.28c5.76 0 10.52 0.88 14.28 2.64s6.72 4.16 8.88 7.2 3.66 6.54 4.5 10.5 1.26 8.18 1.26 12.66zm-29.4-22.8c-2.16 0.16-4.16 0.72-6 1.68s-3.42 2.2-4.74 3.72-2.36 3.28-3.12 5.28-1.14 4.12-1.14 6.36h33.12c0-2-0.22-4.06-0.66-6.18s-1.3-4.02-2.58-5.7-3.1-3.02-5.46-4.02-5.5-1.38-9.42-1.14z" fill-rule="nonzero"/> </g> <g transform="matrix(1.8559 0 0 .7642 45.348 36.475)"> <g transform="translate(2.7114)"> <path d="m3.935 173.02c-0.331 0-0.497-0.402-0.497-1.207v-51.002c0-0.738 0.138-1.107 0.414-1.107h1.781c0.277 0 0.415 0.335 0.415 1.006v5.935c0 0.336 0.027 0.553 0.083 0.654 0.055 0.101 0.151-0.017 0.289-0.352 0.912-1.744 1.754-3.236 2.527-4.477 0.773-1.24 1.554-2.179 2.341-2.816s1.65-0.956 2.588-0.956c1.685 0 3.011 0.922 3.977 2.766 0.967 1.845 1.602 3.84 1.905 5.986 0.056 0.268 0.139 0.369 0.249 0.302s0.221-0.235 0.331-0.503c0.939-1.811 1.802-3.353 2.589-4.628 0.787-1.274 1.581-2.246 2.382-2.917s1.671-1.006 2.61-1.006c2.016 0 3.569 1.392 4.66 4.175 1.09 2.783 1.636 6.421 1.636 10.915v37.925c0 0.871-0.18 1.307-0.539 1.307h-1.739c-0.138 0-0.249-0.1-0.332-0.301-0.083-0.202-0.124-0.503-0.124-0.906v-36.315c0-3.555-0.338-6.321-1.015-8.3-0.676-1.978-1.76-2.967-3.251-2.967-0.884 0-1.726 0.386-2.527 1.157s-1.519 1.727-2.154 2.867-1.201 2.213-1.699 3.219c-0.248 0.469-0.421 0.905-0.517 1.308-0.097 0.402-0.145 0.972-0.145 1.71v37.221c0 0.871-0.166 1.307-0.497 1.307h-1.74c-0.166 0-0.29-0.1-0.373-0.301-0.083-0.202-0.124-0.503-0.124-0.906v-36.315c0-3.555-0.332-6.321-0.994-8.3-0.663-1.978-1.754-2.967-3.273-2.967-1.242 0-2.375 0.704-3.396 2.112-1.022 1.409-2.223 3.555-3.604 6.439v39.031c0 0.805-0.18 1.207-0.539 1.207h-1.698z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m53.642 166.28c-1.077 2.549-2.237 4.477-3.479 5.785-1.243 1.307-2.61 1.961-4.101 1.961-2.154 0-3.853-1.324-5.095-3.973-1.243-2.649-1.864-6.187-1.864-10.613 0-3.488 0.4-6.489 1.201-9.004s1.988-4.51 3.562-5.985c1.574-1.476 3.521-2.414 5.841-2.817l3.686-0.704c0.221-0.067 0.394-0.218 0.518-0.453 0.124-0.234 0.187-0.587 0.187-1.056v-2.917c0-3.89-0.504-6.975-1.512-9.255s-2.354-3.42-4.039-3.42c-1.298 0-2.472 0.72-3.521 2.162s-2.002 3.572-2.858 6.388c-0.083 0.268-0.159 0.453-0.228 0.554-0.069 0.1-0.172 0.083-0.311-0.051l-1.698-1.71c-0.083-0.134-0.138-0.285-0.166-0.453-0.027-0.167 0.014-0.452 0.125-0.855 0.856-3.353 2.009-6.052 3.459-8.098 1.449-2.045 3.224-3.068 5.322-3.068 1.74 0 3.211 0.687 4.412 2.062s2.112 3.37 2.734 5.986c0.621 2.615 0.932 5.7 0.932 9.255v35.712c0 0.536-0.035 0.888-0.104 1.056s-0.2 0.251-0.393 0.251h-1.533c-0.166 0-0.29-0.117-0.373-0.352-0.083-0.234-0.124-0.553-0.124-0.955l-0.083-5.231c-0.055-0.939-0.221-1.006-0.497-0.202zm0.456-19.314c0-1.14-0.194-1.643-0.58-1.509l-3.107 0.603c-1.436 0.202-2.686 0.638-3.749 1.308-1.063 0.671-1.953 1.543-2.671 2.616s-1.257 2.33-1.616 3.772-0.538 3.102-0.538 4.98c0 3.152 0.455 5.616 1.367 7.393 0.911 1.778 2.14 2.666 3.686 2.666 0.939 0 1.85-0.419 2.734-1.257s1.671-1.895 2.361-3.169c0.663-1.408 1.181-2.85 1.553-4.326 0.373-1.475 0.56-2.883 0.56-4.225v-8.852z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m79.034 173.02c-0.166 0-0.297-0.117-0.394-0.352-0.096-0.234-0.145-0.553-0.145-0.955v-4.628c0-0.536-0.041-0.838-0.124-0.905s-0.207 0.1-0.373 0.503c-0.276 0.67-0.69 1.593-1.242 2.766-0.553 1.174-1.271 2.23-2.154 3.169-0.884 0.939-1.961 1.408-3.231 1.408-1.74 0-3.314-0.989-4.722-2.967-1.409-1.979-2.534-4.963-3.376-8.953-0.843-3.991-1.264-8.937-1.264-14.838 0-5.701 0.415-10.68 1.243-14.939s1.988-7.595 3.479-10.009c1.492-2.415 3.204-3.622 5.137-3.622 1.436 0 2.616 0.57 3.541 1.71 0.926 1.14 1.719 2.381 2.382 3.722 0.249 0.47 0.414 0.637 0.497 0.503s0.125-0.536 0.125-1.207v-23.841c0-0.805 0.151-1.208 0.455-1.208h1.864c0.276 0 0.414 0.369 0.414 1.107v72.128c0 0.537-0.041 0.905-0.124 1.107-0.083 0.201-0.235 0.301-0.455 0.301h-1.533zm-0.621-42.049c-0.939-2.213-1.885-3.94-2.838-5.181s-2.009-1.861-3.169-1.861c-1.463 0-2.768 0.889-3.914 2.666s-2.044 4.376-2.693 7.796-0.973 7.578-0.973 12.474c0 5.097 0.338 9.272 1.015 12.524 0.676 3.253 1.567 5.651 2.672 7.193 1.104 1.543 2.305 2.314 3.603 2.314 1.188 0 2.258-0.704 3.211-2.113 0.952-1.408 1.705-3.118 2.257-5.13s0.829-3.957 0.829-5.835v-24.847z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m89.514 149.38c0 3.42 0.345 6.606 1.035 9.557 0.691 2.951 1.609 5.315 2.755 7.092s2.437 2.666 3.873 2.666c1.519 0 2.837-0.738 3.956-2.213 1.118-1.476 2.064-3.655 2.837-6.539 0.083-0.336 0.166-0.52 0.249-0.554 0.083-0.033 0.179 0.017 0.29 0.151l1.408 1.912c0.221 0.268 0.235 0.67 0.041 1.207-0.69 2.548-1.47 4.661-2.34 6.337-0.87 1.677-1.857 2.935-2.962 3.773-1.104 0.838-2.319 1.257-3.645 1.257-2.043 0-3.838-1.14-5.385-3.42-1.546-2.28-2.761-5.482-3.645-9.607-0.884-4.124-1.325-8.836-1.325-14.134 0-5.901 0.455-10.931 1.367-15.089 0.911-4.158 2.14-7.377 3.686-9.658 1.547-2.28 3.3-3.42 5.261-3.42 1.988 0 3.714 1.073 5.178 3.219 1.463 2.146 2.595 5.231 3.396 9.255s1.201 8.886 1.201 14.587c0 0.469-0.02 0.939-0.062 1.408-0.041 0.469-0.214 0.704-0.517 0.704h-16.362c-0.083 0-0.152 0.151-0.207 0.453-0.056 0.302-0.083 0.654-0.083 1.056zm13.752-6.237c0.304 0 0.497-0.1 0.58-0.302 0.083-0.201 0.124-0.57 0.124-1.106 0-3.219-0.283-6.187-0.849-8.903s-1.367-4.896-2.402-6.539c-1.036-1.643-2.272-2.464-3.708-2.464-1.629 0-2.996 0.955-4.101 2.867-1.104 1.911-1.94 4.342-2.506 7.293s-0.849 6.002-0.849 9.154h13.711z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m148.54 119.7c0.165 0 0.283 0.117 0.352 0.352s0.076 0.52 0.02 0.855l-6.254 50.902c-0.028 0.47-0.104 0.788-0.228 0.956s-0.297 0.251-0.518 0.251h-1.615c-0.442 0-0.718-0.402-0.829-1.207l-5.26-40.138c-0.111-0.604-0.201-0.905-0.27-0.905s-0.131 0.301-0.186 0.905l-5.012 40.138c-0.028 0.47-0.097 0.788-0.207 0.956-0.111 0.168-0.277 0.251-0.497 0.251h-1.74c-0.442 0-0.718-0.402-0.829-1.207l-6.503-50.801c-0.055-0.403-0.048-0.721 0.021-0.956s0.2-0.352 0.393-0.352h1.823c0.166 0 0.297 0.067 0.393 0.201 0.097 0.134 0.159 0.403 0.187 0.805l5.302 41.848c0.083 0.671 0.179 0.989 0.29 0.956 0.11-0.034 0.207-0.386 0.29-1.056l5.219-41.949c0.055-0.268 0.124-0.47 0.207-0.604s0.193-0.201 0.331-0.201h1.533c0.138 0 0.262 0.067 0.373 0.201 0.11 0.134 0.179 0.403 0.207 0.805l5.468 41.848c0.083 0.671 0.179 0.989 0.29 0.956 0.11-0.034 0.207-0.386 0.29-1.056l5.053-41.849c0.055-0.335 0.138-0.57 0.249-0.704 0.11-0.134 0.234-0.201 0.373-0.201h1.284z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m156.49 171.51c0 0.604-0.042 1.006-0.125 1.208-0.082 0.201-0.262 0.301-0.538 0.301h-1.533c-0.221 0-0.366-0.083-0.435-0.251s-0.103-0.486-0.103-0.956v-50.902c0-0.805 0.152-1.207 0.456-1.207h1.822c0.304 0 0.456 0.402 0.456 1.207v50.6zm0.165-63.979c0 1.207-0.207 1.811-0.621 1.811h-1.905c-0.221 0-0.366-0.135-0.435-0.403s-0.104-0.67-0.104-1.207v-7.847c0-1.006 0.18-1.509 0.539-1.509h1.988c0.359 0 0.538 0.47 0.538 1.409v7.746z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m168.3 124.83c-0.221 0-0.331 0.269-0.331 0.805v33.801c0 3.42 0.221 5.667 0.663 6.74 0.441 1.073 1.09 1.609 1.946 1.609h3.024c0.138 0 0.242 0.084 0.311 0.252 0.069 0.167 0.103 0.419 0.103 0.754v2.716c0 0.537-0.138 0.906-0.414 1.107-0.248 0.067-0.614 0.134-1.098 0.201-0.483 0.067-0.959 0.118-1.429 0.151-0.469 0.034-0.828 0.05-1.077 0.05-1.712 0-2.934-0.955-3.665-2.867-0.732-1.911-1.098-5.013-1.098-9.305v-35.108c0-0.604-0.124-0.906-0.373-0.906h-3.521c-0.248 0-0.373-0.268-0.373-0.804v-3.521c0-0.537 0.111-0.805 0.332-0.805h3.686c0.166 0 0.263-0.268 0.29-0.805l0.415-16.095c0-0.805 0.124-1.207 0.372-1.207h1.492c0.303 0 0.455 0.436 0.455 1.307v15.995c0 0.537 0.097 0.805 0.29 0.805h5.468c0.221 0 0.331 0.268 0.331 0.805v3.521c0 0.536-0.124 0.804-0.373 0.804h-5.426z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m179.4 173.02c-0.331 0-0.497-0.402-0.497-1.207v-72.329c0-0.738 0.138-1.107 0.414-1.107h1.782c0.276 0 0.414 0.336 0.414 1.006v27.162c0 0.335 0.034 0.536 0.103 0.603s0.159-0.033 0.27-0.302c0.994-1.81 1.898-3.319 2.713-4.526 0.814-1.208 1.629-2.113 2.444-2.717 0.814-0.603 1.691-0.905 2.63-0.905 2.182 0 3.839 1.375 4.971 4.125 1.132 2.749 1.698 6.404 1.698 10.965v37.925c0 0.871-0.166 1.307-0.497 1.307h-1.74c-0.165 0-0.29-0.1-0.373-0.301-0.082-0.202-0.124-0.503-0.124-0.906v-36.315c0-3.555-0.366-6.321-1.097-8.3-0.732-1.978-1.899-2.967-3.501-2.967-0.883 0-1.705 0.318-2.464 0.956-0.76 0.637-1.526 1.576-2.299 2.816-0.773 1.241-1.643 2.834-2.61 4.779v39.031c0 0.805-0.179 1.207-0.538 1.207h-1.699z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> </g> <g transform="matrix(.80638 0 0 .80638 452.53 65.421)" fill-rule="nonzero"> <path d="m79.32 36.98v150.76l15.68-13.2 6.59-156.31-22.27 18.75z" fill="url(#f)"/> <path d="m79.32 36.98-22.27-18.75 6.59 156.31 15.68 13.2v-150.76z" fill="url(#e)"/> <path d="m25.19 104.83 8.63 49.04 12.5-14.95-2.46-56.42-18.67 22.33z" fill="url(#d)"/> <path d="m25.19 104.83-25.19-14.59 16.97 53.86 16.85 9.77-8.63-49.04z" fill="url(#c)"/> <path d="M43.86,82.5L18.69,67.98L0,90.24L25.18,104.83L43.86,82.5Z" fill="#9c3"/> <path d="m134.82 78.69-9.97 56.5 15.58-9.04 19.57-62.05-25.18 14.59z" fill="url(#b)"/> <path d="m134.82 78.69-18.68-22.33-2.86 65 11.57 13.83 9.97-56.5z" fill="url(#a)"/> <path d="m160 64.1-18.69-22.26-25.17 14.52 18.67 22.33 25.19-14.59z" fill="#ffe113"/> <path d="M101.59,18.23L79.32,0L57.05,18.23L79.32,36.98L101.59,18.23Z" fill="#f3e600"/> </g> <defs> <linearGradient id="f" x2="1" gradientTransform="matrix(.84 -162.96 162.96 .84 89.64 184.81)" gradientUnits="userSpaceOnUse"><stop stop-color="#62d399" offset="0"/><stop stop-color="#acd842" offset=".51"/><stop stop-color="#d7db0a" offset=".9"/><stop stop-color="#d7db0a" offset="1"/></linearGradient> <linearGradient id="e" x2="1" gradientTransform="matrix(-1.6,-162.13,162.13,-1.6,69.68,178.9)" gradientUnits="userSpaceOnUse"><stop stop-color="#0ba398" offset="0"/><stop stop-color="#4ca352" offset=".5"/><stop stop-color="#76a30a" offset="1"/></linearGradient> <linearGradient id="d" x2="1" gradientTransform="matrix(-1.9,-67.98,67.98,-1.9,36.6,152.17)" gradientUnits="userSpaceOnUse"><stop stop-color="#36a382" offset="0"/><stop stop-color="#36a382" offset=".19"/><stop stop-color="#49a459" offset=".54"/><stop stop-color="#76a30b" offset="1"/></linearGradient> <linearGradient id="c" x2="1" gradientTransform="matrix(2.18,-62.38,62.38,2.18,15.82,153.24)" gradientUnits="userSpaceOnUse"><stop stop-color="#267880" offset="0"/><stop stop-color="#457a5c" offset=".51"/><stop stop-color="#717516" offset="1"/></linearGradient> <linearGradient id="b" x2="1" gradientTransform="matrix(13.85,-71.96,71.96,13.85,135.08,135.43)" gradientUnits="userSpaceOnUse"><stop stop-color="#b0d939" offset="0"/><stop stop-color="#eadb04" offset="1"/></linearGradient> <linearGradient id="a" x2="1" gradientTransform="matrix(26.159 -64.737 64.737 26.159 107.42 128.14)" gradientUnits="userSpaceOnUse"><stop stop-color="#74af52" offset="0"/><stop stop-color="#74af52" offset=".17"/><stop stop-color="#99be32" offset=".48"/><stop stop-color="#c0c40a" offset="1"/></linearGradient> </defs> </svg>`;btoa(NA);const zA='<svg viewBox="0 0 509 154" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2"><path d="M665.95 132.73v44.88l-10.56-8.4c-.8-.64-1.2-1.44-1.2-2.4v-32.4c0-6.48-4.12-9.72-12.36-9.72-2.16 0-4.18.4-6.06 1.2-1.88.8-3.54 1.8-4.98 3-1.44 1.2-2.56 2.5-3.36 3.9-.8 1.4-1.2 2.7-1.2 3.9v40.92l-10.68-8.4c-.72-.64-1.08-1.44-1.08-2.4v-53.76l10.92 8.52c.32.24.56.44.72.6.16.16.36.32.6.48.96-1.2 2.14-2.28 3.54-3.24 1.4-.96 2.92-1.76 4.56-2.4 1.64-.64 3.34-1.14 5.1-1.5 1.76-.36 3.44-.54 5.04-.54 1.44 0 2.92.04 4.44.12 1.52.08 2.84.28 3.96.6 4.56 1.12 7.8 3.12 9.72 6 1.92 2.88 2.88 6.56 2.88 11.04ZM732.38 146.05c0 .88.02 1.5.06 1.86.04.36-.02.98-.18 1.86h-7.08c-2.08 0-4.44-.02-7.08-.06-2.64-.04-5.36-.06-8.16-.06h-22.08c0 2.88.56 5.36 1.68 7.44 1.12 2.08 2.6 3.8 4.44 5.16 1.84 1.36 3.94 2.36 6.3 3 2.36.64 4.74.96 7.14.96 3.04 0 5.9-.76 8.58-2.28 2.68-1.52 4.94-3.52 6.78-6 .64.56 1.54 1.48 2.7 2.76 1.16 1.28 2.94 3.2 5.34 5.76-2.8 3.36-6.22 6.02-10.26 7.98-4.04 1.96-8.42 2.94-13.14 2.94-4.72 0-8.92-.64-12.84-1.92-3.92-1.28-7.32-3.24-10.2-5.88-2.88-2.64-5.12-5.98-6.72-10.02-1.6-4.04-2.4-8.82-2.4-14.34 0-4.96.66-9.42 1.98-13.38 1.32-3.96 3.22-7.32 5.7-10.08s5.44-4.9 8.88-6.42c3.44-1.52 7.32-2.28 11.64-2.28 5.76 0 10.52.88 14.28 2.64 3.76 1.76 6.72 4.16 8.88 7.2 2.16 3.04 3.66 6.54 4.5 10.5.84 3.96 1.26 8.18 1.26 12.66Zm-29.4-22.8c-2.16.16-4.16.72-6 1.68-1.84.96-3.42 2.2-4.74 3.72-1.32 1.52-2.36 3.28-3.12 5.28-.76 2-1.14 4.12-1.14 6.36h33.12c0-2-.22-4.06-.66-6.18-.44-2.12-1.3-4.02-2.58-5.7-1.28-1.68-3.1-3.02-5.46-4.02-2.36-1-5.5-1.38-9.42-1.14ZM795.93 146.05c0 .88.02 1.5.06 1.86.04.36-.02.98-.18 1.86h-7.08c-2.08 0-4.44-.02-7.08-.06-2.64-.04-5.36-.06-8.16-.06h-22.08c0 2.88.56 5.36 1.68 7.44 1.12 2.08 2.6 3.8 4.44 5.16 1.84 1.36 3.94 2.36 6.3 3 2.36.64 4.74.96 7.14.96 3.04 0 5.9-.76 8.58-2.28 2.68-1.52 4.94-3.52 6.78-6 .64.56 1.54 1.48 2.7 2.76 1.16 1.28 2.94 3.2 5.34 5.76-2.8 3.36-6.22 6.02-10.26 7.98-4.04 1.96-8.42 2.94-13.14 2.94-4.72 0-8.92-.64-12.84-1.92-3.92-1.28-7.32-3.24-10.2-5.88-2.88-2.64-5.12-5.98-6.72-10.02-1.6-4.04-2.4-8.82-2.4-14.34 0-4.96.66-9.42 1.98-13.38 1.32-3.96 3.22-7.32 5.7-10.08s5.44-4.9 8.88-6.42c3.44-1.52 7.32-2.28 11.64-2.28 5.76 0 10.52.88 14.28 2.64 3.76 1.76 6.72 4.16 8.88 7.2 2.16 3.04 3.66 6.54 4.5 10.5.84 3.96 1.26 8.18 1.26 12.66Zm-29.4-22.8c-2.16.16-4.16.72-6 1.68-1.84.96-3.42 2.2-4.74 3.72-1.32 1.52-2.36 3.28-3.12 5.28-.76 2-1.14 4.12-1.14 6.36h33.12c0-2-.22-4.06-.66-6.18-.44-2.12-1.3-4.02-2.58-5.7-1.28-1.68-3.1-3.02-5.46-4.02-2.36-1-5.5-1.38-9.42-1.14ZM858.57 97.21c.64.48.96 1.16.96 2.04v74.88c-.08 1.04-.12 2.12-.12 3.24-1.84-1.52-3.56-2.92-5.16-4.2-1.36-1.12-2.66-2.18-3.9-3.18-1.24-1-2.06-1.66-2.46-1.98-1.76 2.48-4.26 4.44-7.5 5.88-3.24 1.44-7.02 2.16-11.34 2.16-3.84 0-7.4-.7-10.68-2.1-3.28-1.4-6.14-3.44-8.58-6.12-2.44-2.68-4.34-5.94-5.7-9.78-1.36-3.84-2.04-8.16-2.04-12.96 0-4.32.78-8.34 2.34-12.06 1.56-3.72 3.6-6.92 6.12-9.6 2.52-2.68 5.38-4.78 8.58-6.3 3.2-1.52 6.48-2.28 9.84-2.28 2.56 0 4.82.22 6.78.66 1.96.44 3.68 1.06 5.16 1.86s2.78 1.74 3.9 2.82a35.92 35.92 0 0 1 3.12 3.42V88.57l10.68 8.64Zm-27.96 67.92c3.6 0 6.52-.68 8.76-2.04 2.24-1.36 3.98-3.06 5.22-5.1a20.5 20.5 0 0 0 2.58-6.54c.48-2.32.72-4.44.72-6.36v-1.2c0-1.12-.22-2.7-.66-4.74-.44-2.04-1.28-4.06-2.52-6.06s-3-3.7-5.28-5.1c-2.28-1.4-5.22-2.02-8.82-1.86-3.44 0-6.26.74-8.46 2.22-2.2 1.48-3.96 3.26-5.28 5.34-1.32 2.08-2.24 4.2-2.76 6.36-.52 2.16-.78 3.92-.78 5.28 0 1.84.24 3.92.72 6.24.48 2.32 1.36 4.48 2.64 6.48s3.04 3.68 5.28 5.04c2.24 1.36 5.12 2.04 8.64 2.04ZM882.81 97.09c.64.48.96 1.12.96 1.92l-.12 41.04v37.08l-10.56-8.4c-.72-.64-1.08-1.44-1.08-2.4V88.45l10.8 8.64ZM950.36 146.05c0 .88.02 1.5.06 1.86.04.36-.02.98-.18 1.86h-7.08c-2.08 0-4.44-.02-7.08-.06-2.64-.04-5.36-.06-8.16-.06h-22.08c0 2.88.56 5.36 1.68 7.44 1.12 2.08 2.6 3.8 4.44 5.16 1.84 1.36 3.94 2.36 6.3 3 2.36.64 4.74.96 7.14.96 3.04 0 5.9-.76 8.58-2.28 2.68-1.52 4.94-3.52 6.78-6 .64.56 1.54 1.48 2.7 2.76 1.16 1.28 2.94 3.2 5.34 5.76-2.8 3.36-6.22 6.02-10.26 7.98-4.04 1.96-8.42 2.94-13.14 2.94-4.72 0-8.92-.64-12.84-1.92-3.92-1.28-7.32-3.24-10.2-5.88-2.88-2.64-5.12-5.98-6.72-10.02-1.6-4.04-2.4-8.82-2.4-14.34 0-4.96.66-9.42 1.98-13.38 1.32-3.96 3.22-7.32 5.7-10.08s5.44-4.9 8.88-6.42c3.44-1.52 7.32-2.28 11.64-2.28 5.76 0 10.52.88 14.28 2.64 3.76 1.76 6.72 4.16 8.88 7.2 2.16 3.04 3.66 6.54 4.5 10.5.84 3.96 1.26 8.18 1.26 12.66Zm-29.4-22.8c-2.16.16-4.16.72-6 1.68-1.84.96-3.42 2.2-4.74 3.72-1.32 1.52-2.36 3.28-3.12 5.28-.76 2-1.14 4.12-1.14 6.36h33.12c0-2-.22-4.06-.66-6.18-.44-2.12-1.3-4.02-2.58-5.7-1.28-1.68-3.1-3.02-5.46-4.02-2.36-1-5.5-1.38-9.42-1.14Z" style="fill-rule:nonzero" transform="translate(-452.406 -63.709) scale(1.00797)"/><path d="M79.32 36.98v150.76L95 174.54l6.59-156.31-22.27 18.75Z" style="fill:url(#a);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M79.32 36.98 57.05 18.23l6.59 156.31 15.68 13.2V36.98Z" style="fill:url(#b);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m25.19 104.83 8.63 49.04 12.5-14.95-2.46-56.42-18.67 22.33Z" style="fill:url(#c);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M25.19 104.83 0 90.24l16.97 53.86 16.85 9.77-8.63-49.04Z" style="fill:url(#d);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M43.86 82.5 18.69 67.98 0 90.24l25.18 14.59L43.86 82.5Z" style="fill:#9c3;fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m134.82 78.69-9.97 56.5 15.58-9.04L160 64.1l-25.18 14.59Z" style="fill:url(#e);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m134.82 78.69-18.68-22.33-2.86 65 11.57 13.83 9.97-56.5Z" style="fill:url(#f);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m160 64.1-18.69-22.26-25.17 14.52 18.67 22.33L160 64.1Z" style="fill:#ffe113;fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M101.59 18.23 79.32 0 57.05 18.23l22.27 18.75 22.27-18.75Z" style="fill:#f3e600;fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><defs><linearGradient id="a" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(.84 -162.96 162.96 .84 89.64 184.81)"><stop offset="0" style="stop-color:#62d399;stop-opacity:1"/><stop offset=".51" style="stop-color:#acd842;stop-opacity:1"/><stop offset=".9" style="stop-color:#d7db0a;stop-opacity:1"/><stop offset="1" style="stop-color:#d7db0a;stop-opacity:1"/></linearGradient><linearGradient id="b" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-90.565 123.412 54.953) scale(162.14)"><stop offset="0" style="stop-color:#0ba398;stop-opacity:1"/><stop offset=".5" style="stop-color:#4ca352;stop-opacity:1"/><stop offset="1" style="stop-color:#76a30a;stop-opacity:1"/></linearGradient><linearGradient id="c" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="scale(-68) rotate(88.4 .881 -1.396)"><stop offset="0" style="stop-color:#36a382;stop-opacity:1"/><stop offset=".19" style="stop-color:#36a382;stop-opacity:1"/><stop offset=".54" style="stop-color:#49a459;stop-opacity:1"/><stop offset="1" style="stop-color:#76a30b;stop-opacity:1"/></linearGradient><linearGradient id="d" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-88 87.255 68.431) scale(62.42)"><stop offset="0" style="stop-color:#267880;stop-opacity:1"/><stop offset=".51" style="stop-color:#457a5c;stop-opacity:1"/><stop offset="1" style="stop-color:#717516;stop-opacity:1"/></linearGradient><linearGradient id="e" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-79.1 149.53 -14.065) scale(73.28)"><stop offset="0" style="stop-color:#b0d939;stop-opacity:1"/><stop offset="1" style="stop-color:#eadb04;stop-opacity:1"/></linearGradient><linearGradient id="f" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-67.997 148.705 -15.558) scale(69.8226)"><stop offset="0" style="stop-color:#74af52;stop-opacity:1"/><stop offset=".17" style="stop-color:#74af52;stop-opacity:1"/><stop offset=".48" style="stop-color:#99be32;stop-opacity:1"/><stop offset="1" style="stop-color:#c0c40a;stop-opacity:1"/></linearGradient></defs></svg>',$A=btoa(zA),VA="data:image/svg+xml;charset=utf-8;base64,"+$A,Ww=VA;var Ws;(function(s){s[s.Quad=0]="Quad",s[s.Cube=1]="Cube",s[s.Sphere=2]="Sphere",s[s.Cylinder=3]="Cylinder",s[s.RoundedCube=10]="RoundedCube"})(Ws||(Ws={}));var wf,A_;class _c{static createText(t,e){let i=null;const n=(e==null?void 0:e.font)||HA((e==null?void 0:e.familyFamily)||null);n instanceof Dk?i=Bd(this,wf,A_).call(this,t,n,e):i==null&&(i=new Gs);const o=(e==null?void 0:e.color)||16777215,r=new le(i,(e==null?void 0:e.material)??new ti({color:o}));return this.applyDefaultObjectOptions(r,e),n instanceof Promise?n.then(l=>{r.geometry=Bd(this,wf,A_).call(this,t,l,e),e!=null&&e.onGeometry&&e.onGeometry(r)}):e!=null&&e.onGeometry&&e.onGeometry(r),r}static createOccluder(t){const e=new Ye({colorWrite:!1,depthWrite:!0,side:Qn});return this.createPrimitive(t,{material:e})}static createPrimitive(t,e){let i;const n=(e==null?void 0:e.color)||16777215;switch(t){case"Quad":case Ws.Quad:{const o=new to(1,1,1,1),r=(e==null?void 0:e.material)??new ti({color:n});e!=null&&e.texture&&"map"in r&&(r.map=e.texture),i=new le(o,r),i.name="Quad"}break;case"Cube":case Ws.Cube:{const o=new Vh(1,1,1),r=(e==null?void 0:e.material)??new ti({color:n});e!=null&&e.texture&&"map"in r&&(r.map=e.texture),i=new le(o,r),i.name="Cube"}break;case Ws.RoundedCube:case"RoundedCube":{const o=WA(1,1,1,.1,2),r=(e==null?void 0:e.material)??new ti({color:n});e!=null&&e.texture&&"map"in r&&(r.map=e.texture),i=new le(o,r),i.name="RoundedCube"}break;case"Sphere":case Ws.Sphere:{const o=new vg(.5,16,16),r=(e==null?void 0:e.material)??new ti({color:n});e!=null&&e.texture&&"map"in r&&(r.map=e.texture),i=new le(o,r),i.name="Sphere"}break;case"Cylinder":case Ws.Cylinder:{const o=new GC(.5,.5,1,32),r=(e==null?void 0:e.material)??new ti({color:n});e!=null&&e.texture&&"map"in r&&(r.map=e.texture),i=new le(o,r),i.name="Cylinder"}break;case"ShaderBall":i=new Ir,i.name="ShaderBall",GA(i,e);break}return this.applyDefaultObjectOptions(i,e),i}static createSprite(t){const i=new bO({color:16777215});t!=null&&t.texture&&"map"in i&&(i.map=t.texture);const n=new _O(i);return this.applyDefaultObjectOptions(n,t),n}static applyDefaultObjectOptions(t,e){t.receiveShadow=!0,t.castShadow=!0,e!=null&&e.name&&(t.name=e.name),e!=null&&e.position&&(Array.isArray(e.position)?t.position.set(e.position[0],e.position[1],e.position[2]):t.position.set(e.position.x||0,e.position.y||0,e.position.z||0)),e!=null&&e.rotation&&(Array.isArray(e.rotation)?t.rotation.set(e.rotation[0],e.rotation[1],e.rotation[2]):t.rotation.set(e.rotation.x||0,e.rotation.y||0,e.rotation.z||0)),e!=null&&e.scale&&(typeof e.scale=="number"?t.scale.set(e.scale,e.scale,e.scale):Array.isArray(e.scale)?t.scale.set(e.scale[0],e.scale[1],e.scale[2]):t.scale.set(e.scale.x||1,e.scale.y||1,e.scale.z||1)),(e==null?void 0:e.receiveShadow)!=null&&(t.receiveShadow=e.receiveShadow),(e==null?void 0:e.castShadow)!=null&&(t.castShadow=e.castShadow),e!=null&&e.parent&&e.parent.add(t)}}wf=new WeakSet,A_=function(t,e,i){const n=(i==null?void 0:i.depth)||.1;return new jk(t,{font:e,size:1,depth:n,height:n,bevelEnabled:(i==null?void 0:i.bevel)||!1,bevelThickness:.01,bevelOffset:.01,bevelSize:.01})},En(_c,wf);function WA(s,t,e,i,n){const o=new vO,r=1e-5,l=i-r;o.absarc(r,r,r,-Math.PI/2,-Math.PI,!0),o.absarc(r,t-l*2,r,Math.PI,Math.PI/2,!0),o.absarc(s-l*2,t-l*2,r,Math.PI/2,0,!0),o.absarc(s-l*2,r,r,0,-Math.PI/2,!0);const c=new xO(o,{bevelEnabled:!0,bevelSegments:n*2,steps:1,bevelSize:l,bevelThickness:i,curveSegments:n,UVGenerator:{generateTopUV:(h,d)=>{const u=[];for(let f=0;f<d.length;f+=3)u.push(new _e(d[f]/s,d[f+1]/t));return u},generateSideWallUV:(h,d,u,f,p,b)=>{const x=[];return x.push(new _e(d[u]/s,d[u+1]/t)),x.push(new _e(d[f]/s,d[f+1]/t)),x.push(new _e(d[p]/s,d[p+1]/t)),x.push(new _e(d[b]/s,d[b+1]/t)),x}}});return c.scale(1,1,1-i),c.center(),c.index||c.setIndex(Array.from({length:c.attributes.position.count},(h,d)=>d)),c.computeVertexNormals(),c}const _p=new Map;function HA(s){let t="";switch(s){default:case"OpenSans":t="https://cdn.needle.tools/static/fonts/facetype/Open Sans_Regular_ascii.json";break;case"Helvetiker":t="https://raw.githubusercontent.com/mrdoob/three.js/master/examples/fonts/helvetiker_regular.typeface.json";break}if(_p.has(t)){const n=_p.get(t);if(n)return n}const e=new Fk,i=new Promise((n,o)=>{e.load(t,r=>{_p.set(t,r),n(r)},void 0,o)});return _p.set(t,i),i}let tb=!1,ib=null;function GA(s,t){if(ib===null){const e="https://cdn.needle.tools/static/models/shaderball.glb",i=new Wr,n=F0(null);i.setDRACOLoader(n.dracoLoader),i.setKTX2Loader(n.ktx2Loader),tb=!0,ib=i.loadAsync(e).then(o=>{const r=o.scene;return r.position.y-=.5,r}).catch(o=>(console.warn("Failed to load shaderball mesh: "+o.message),Gw())).finally(()=>{tb=!1})}if(tb){const e=Gw();e.name="ShaderBall-Placeholder";const i=e.children[0];(i==null?void 0:i.type)==="Mesh"&&Hw(i,t),s.add(e)}ib.then(e=>{s.children.forEach(o=>{o.name==="ShaderBall-Placeholder"&&s.remove(o)});const i=e.clone(),n=i.children[0];(n==null?void 0:n.type)==="Mesh"&&(n.geometry.attributes.tangent||n.geometry.computeTangents(),Hw(n,t)),s.add(i)})}function Hw(s,t){var i;if((t==null?void 0:t.color)||(t==null?void 0:t.material)||(t==null?void 0:t.texture)){const n=(t==null?void 0:t.material)??((i=s.material)==null?void 0:i.clone())??new ti;t.color&&"color"in n&&n.color instanceof Se&&n.color.set(t.color),t!=null&&t.texture&&"map"in n&&(n.map=t.texture),s.material=n}}function Gw(){return new Ir().add(_c.createPrimitive("Sphere",{material:new Ye({transparent:!0,opacity:.1})}))}const ix=class{constructor(t,e,i){a(this,"_session");a(this,"_mode");a(this,"_init");a(this,"_renderer");a(this,"_camera");a(this,"_scene");a(this,"onEnd",()=>{var t;(t=this._session)==null||t.removeEventListener("end",this.onEnd),this._renderer.setAnimationLoop(null),this._renderer.dispose(),this._scene.clear()});a(this,"_lastTime",0);a(this,"_frames",0);a(this,"onFrame",(t,e)=>{const i=t-this._lastTime;this.update(t,i),this._camera.parent!==this._scene&&this._scene.add(this._camera),this._renderer.render(this._scene,this._camera),this._lastTime=t,this._frames++});a(this,"_roomFlyObjects",[]);a(this,"_logoObject",null);this._mode=t,this._init=e,this._session=i,this._session.addEventListener("end",this.onEnd),this._renderer=new gc({alpha:!0,antialias:!0}),this._renderer.outputColorSpace="srgb",this._renderer.setPixelRatio(Math.min(2,window.devicePixelRatio)),this._renderer.setSize(window.innerWidth,window.innerHeight,!0),Q.isNeedleAppClip()&&window.requestAnimationFrame(()=>{const n=Math.min(2,window.devicePixelRatio),o=Math.floor(window.innerWidth*n),r=Math.floor(window.innerHeight*n);this._renderer.domElement.width=o,this._renderer.domElement.height=r}),this._renderer.setAnimationLoop(this.onFrame),this._renderer.xr.setSession(i),this._renderer.xr.enabled=!0,this._camera=new Ae,this._scene=new Xn,this._scene.fog=new qC(4473924,10,250),this._scene.add(this._camera),this.setupScene()}static get active(){return this._active}static async start(t,e){if(this._active)return console.error("Cannot start a new XR session while one is already active"),null;if(this._requestInFlight)return console.error("Cannot start a new XR session while a request is already in flight"),null;if("xr"in navigator&&navigator.xr){if(!e)return console.error("XRSessionInit must be provided"),null;this._requestInFlight=!0;const i=await navigator.xr.requestSession(t,e).catch(n=>{console.error("Failed to start temporary XR session:",n)});return i?(i.addEventListener("end",()=>{this._active=null}),this._requestInFlight?(this._requestInFlight=!1,this._active=new ix(t,e,i),this._active):(i.end(),null)):(this._requestInFlight=!1,null)}return null}static async handoff(){return this._active?this._active.handoff():null}static async stop(){this._requestInFlight=!1,this._active&&(await this._active.end(),await Ha(100)),this._active=null}get isAR(){return this._mode==="immersive-ar"}get isVR(){return this._mode==="immersive-vr"}end(){return this._session?this._session.end():Promise.resolve()}async handoff(){if(!this._session)throw new Error("Cannot handoff a session that has already ended");const t={session:this._session,mode:this._mode,init:this._init};return await this.onBeforeHandoff(),this.onEnd(),this._session=null,t}get _logoDistance(){return this.isAR?.3:5}get _logoScale(){return this.isAR?.04:1}update(t,e){const i=t*4e-4;for(let r=0;r<this._roomFlyObjects.length;r++){const l=this._roomFlyObjects[r];l.position.y+=Math.sin(i+r*.5)*.005,l.rotateY(.002)}const n=this._logoObject,o=this._renderer.xr.getCamera();if(n){const r=new R;o.getWorldDirection(r);const l=o.position.clone().addScaledVector(r,this._logoDistance),c=this.isAR?.005:1e-5;n.position.lerp(l,this._frames<=2?1:e*c),n.lookAt(this._camera.position)}}async onBeforeHandoff(){await Ha(1e3),this._scene.clear()}setupScene(){this._scene.background=new Se(0);let t=Zh;if(jr()){const d=document.querySelector("needle-engine");if(d){const u=d.getAttribute("logo-src");u!=null&&u.length&&(t=u,X()&&console.debug("[XR] Using custom loading logo from license:",t))}}const e=this._logoObject=new le(new to(1,1,1,1),new Ye({transparent:!0,side:2}));e.scale.multiplyScalar(this._logoScale*window.devicePixelRatio),e.renderOrder=1e3,e.material.opacity=0,this._scene.add(e);const i=document.createElement("canvas"),n=i.getContext("2d"),o=new Image,r=d=>{if(!n)return;e.material.opacity=1;const u=1024;i.width=u,i.height=u,n.imageSmoothingQuality="high";const f=u*.19,p=d?1:o.width/o.height;if(!d){const P=i.height-f*1.5,E=P*p,D=(i.width-E)/2;n.drawImage(o,D,0,E,P)}const b=u*.12,x="Loading...";n.shadowBlur=0,n.fillStyle=this.isAR?"white":"rgba(255,255,255,0.4)",n.font=`${b}px Arial`,n.shadowBlur=u*.02,n.shadowColor="rgba(0,0,0,0.5)",n.shadowOffsetX=0,n.shadowOffsetY=0;const v=n.measureText(x);n.fillText(x,i.width/2-v.width/2,i.height-f/4),n.font=`${b}px Arial`,n.fillText(x,i.width/2-v.width/2,i.height-f/4);const S=new Wh().load(i.toDataURL());S.generateMipmaps=!0,S.colorSpace="srgb",S.anisotropy=4;const C=i.width/i.height;e.scale.x=this._logoScale*C*window.devicePixelRatio,e.scale.y=this._logoScale*window.devicePixelRatio,e.material.map=S,e.material.needsUpdate=!0};o.onload=()=>r(!1),o.onerror=d=>{console.error("Failed to load temporary XR logo:",t,d),o.src=Zh},o.crossOrigin="anonymous",o.src=t;const l=new r_(16777215,1);l.position.set(0,20,0),l.castShadow=!1,this._scene.add(l);const c=new r_(16777215,1);c.position.set(0,-1,0),c.castShadow=!1,this._scene.add(c);const h=new R0(16777215,1,100,1);if(h.position.set(0,2,0),h.castShadow=!1,h.distance=200,this._scene.add(h),this.isAR===!1)for(let u=0;u<100;u++){const f=new ti({color:2236962,metalness:1,roughness:.8}),p=Ws.Sphere,b=_c.createPrimitive(p,{material:f});b.position.x=ee.random(-50,50),b.position.y=ee.random(-2,50),b.position.z=ee.random(-50,50),b.rotation.x=ee.random(0,Math.PI*2),b.rotation.y=ee.random(0,Math.PI*2),b.rotation.z=ee.random(0,Math.PI*2),b.scale.multiplyScalar(.5+Math.random()*10);const x=b.position.distanceTo(this._camera.position)-b.scale.x;x<10&&(b.position.z+=5,b.position.multiplyScalar(1+1/x)),this._roomFlyObjects.push(b),this._scene.add(b)}}};let Ma=ix;a(Ma,"_active",null),a(Ma,"_requestInFlight",!1);var ff;(function(s){const t=[];function e(){t!=null&&t.length||X()&&console.warn("No USDZ exporters found ‚Äì cannot export USDZ for QuickLook.");for(const o of t)o.exportAndOpen();return!0}s.exportAndOpen=e;function i(o){t.push(o)}s.registerExporter=i;function n(o){if(!t)return;const r=t.indexOf(o);r>=0&&t.splice(r,1)}s.unregisterExporter=n})(ff||(ff={}));const kt=k("debugwebxr"),qw=k("stats");let nb=0;function qA(s){let t=null;const e=s;return e.getAROverlayContainer?t=e.getAROverlayContainer():t=s,t}XA();async function XA(){var t,e,i;let s="immersive-vr";try{if(Q.isNeedleAppClip()?s="immersive-ar":await((t=navigator.xr)==null?void 0:t.isSessionSupported("immersive-vr"))||(s="immersive-ar"),!await((e=navigator.xr)==null?void 0:e.isSessionSupported("immersive-ar"))&&s==="immersive-ar")return}catch(n){console.debug("[NeedleXRSession:granted] Error while checking XR support:",n);return}if(k("debugasap")){let n=globalThis["needle:XRSession"];if(n instanceof Promise){delete globalThis["needle:XRSession"],Be.addContextCreatedCallback(async o=>{if(!n)return;yu(!0);const r=await n;if(r){const l=fe.getDefaultSessionInit(s);fe.setSession(s,r,l,o.context)}else console.error("[NeedleXRSession:granted] ASAP session was rejected");n=void 0});return}}if("xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent)){console.warn("WebXRViewer does not support addEventListener");return}(i=navigator.xr)==null||i.addEventListener("sessiongranted",async()=>{const n=sessionStorage.getItem("needle_xr_session_mode"),o=sessionStorage.getItem("needle_xr_session_init")??null,r=o?JSON.parse(o):null;let l=null;if(DP()&&(await Ma.start(n||s,r||fe.getDefaultSessionInit(s)).catch(c=>console.warn("[NeedleXRSession:granted] TemporaryXRContext start failed:",c)),await KA(),l=await Ma.handoff()),l)fe.setSession(l.mode,l.session,l.init,de.Current);else if(n&&o){console.log("[NeedleXRSession:granted] Restore last session");const c=JSON.parse(o);fe.start(n,c).catch(h=>console.warn(h))}else fe.start(s).catch(c=>console.warn("[NeedleXRSession:granted] failed:",c))},{once:!0})}}function QA(s,t){sessionStorage.setItem("needle_xr_session_mode",s),sessionStorage.setItem("needle_xr_session_init",JSON.stringify(t))}function YA(){sessionStorage.removeItem("needle_xr_session_mode"),sessionStorage.removeItem("needle_xr_session_init")}const K0=new Set;Be.registerCallback(Me.ContextCreationStart,async s=>{K0.add(s.context)});Be.registerCallback(Me.ContextCreated,async s=>{var e;K0.delete(s.context);const t=((e=s.context)==null?void 0:e.domElement.getAttribute("autostart"))||null;ZA(t)});function DP(){return K0.size>0}function KA(){return new Promise(s=>{const t=Date.now(),e=setInterval(()=>{(!DP()||Date.now()-t>6e4)&&(clearInterval(e),s())},100)})}Q.isDesktop()&&X()&&window.addEventListener("keydown",s=>{(s.key==="x"||s.key==="Escape")&&fe.active&&fe.stop()});function ZA(s){if(s)switch(s==null?void 0:s.toLowerCase()){case"ar":Xs.registerWaitForInteraction(()=>{fe.start("ar")});break}}const vp=Symbol("initial-fov"),wr=class{constructor(t,e,i,n){a(this,"context");a(this,"session");a(this,"mode");a(this,"controllers",[]);a(this,"_rigScale",1);a(this,"_lastRigScaleUpdate",-1);a(this,"_rigs",[]);a(this,"_viewerHitTestSource",null);a(this,"_defaultRig");a(this,"_xr_scripts");a(this,"_xr_update_scripts",[]);a(this,"_inactive_scripts",[]);a(this,"_controllerAdded");a(this,"_controllerRemoved");a(this,"_originalCameraWorldPosition");a(this,"_originalCameraWorldRotation");a(this,"_originalCameraWorldScale");a(this,"_originalCameraParent");a(this,"_mainCamera",null);a(this,"onRendererSessionSet",()=>{var t;this.running&&(this.context.renderer.xr.enabled=!0,this.context.renderer.xr.updateCamera(this.context.mainCamera),(t=this.context.mainCameraComponent)==null||t.applyClearFlags())});a(this,"onInputSourceAdded",t=>{if(t.targetRayMode==="screen")return;let e=0;for(let n=0;n<this.session.inputSources.length;n++)if(this.session.inputSources[n]===t){e=n;break}if(this.controllers.find(n=>n.inputSource===t)){console.debug("Controller already exists for input source",e);return}else if(this._newControllers.find(n=>n.inputSource===t)){console.debug("Controller already registered for input source",e);return}const i=new z1(this,t,e);this._newControllers.push(i)});a(this,"_ended",!1);a(this,"_newControllers",[]);a(this,"onEnd",t=>{var o,r,l;if(this._ended)return;this._ended=!0,console.debug("XR Session ended"),Tn.sendEvent(de.Current,"xr",{action:"session_end",mode:this.mode,source:"NeedleXRSession.onEnd"}),YA(),this.onAfterRender(),this.revertCustomForward(),this._didStart=!1,this._previousCameraParent=null,this.requestedCameraNearPlane=null,Qa(this.onBefore,ge.LateUpdate);const e=this.context.pre_render_callbacks.indexOf(this.onBeforeRender);e>=0&&this.context.pre_render_callbacks.splice(e,1);const i=this.context.post_render_callbacks.indexOf(this.onAfterRender);i>=0&&this.context.post_render_callbacks.splice(i,1),this.context.xr=null,this.context.renderer.xr.enabled=!1,this.context.pre_update_oneshot_callbacks.push(()=>{var c,h;(c=this.context.mainCameraComponent)==null||c.applyClearFlags(),(h=this.context.mainCameraComponent)==null||h.applyClippingPlane()}),IM({session:this});for(const c of wr._xrEndListeners)c({xr:this});const n=[...this.controllers];for(let c=0;c<n.length;c++)this.disconnectInputSource(n[c].inputSource);this.controllers.length=0,this._newControllers.length=0;for(const c of this._xr_scripts)(o=c==null?void 0:c.onLeaveXR)==null||o.call(c,{xr:this});(r=this.sync)==null||r.onExitXR(this),this.context.mainCamera&&((l=this._originalCameraParent)==null||l.add(this.context.mainCamera),this._originalCameraWorldPosition&&Oi(this.context.mainCamera,this._originalCameraWorldPosition),this._originalCameraWorldRotation&&Yo(this.context.mainCamera,this._originalCameraWorldRotation),this._originalCameraWorldScale&&lf(this.context.mainCamera,this._originalCameraWorldScale),this.context.mainCamera instanceof Ae&&this.context.mainCamera[vp]&&(this.context.mainCamera.fov=this.context.mainCamera[vp],this.context.mainCamera[vp]=0)),this.context.requestSizeUpdate(),this._defaultRig.gameObject.removeFromParent(),yu(!1)});a(this,"_didStart",!1);a(this,"onBefore",t=>{var n,o,r,l,c,h,d,u;const e=t.xrFrame;if(!e)return;this.context.xr=this,this.context.mainCameraComponent&&this.context.mainCameraComponent!==this._mainCamera&&(this._mainCamera=this.context.mainCameraComponent),((n=this.rig)==null?void 0:n.isActive)==!1&&(kt&&console.warn("Latest rig is not active - trying to activate a different rig",this.rig),this.updateActiveXRRig()),this.rig&&((o=this._mainCamera)!=null&&o.gameObject)&&((l=(r=this._mainCamera)==null?void 0:r.gameObject)==null?void 0:l.parent)!==this.rig.gameObject&&this.rig.gameObject.add((c=this._mainCamera)==null?void 0:c.gameObject),this.internalUpdateState(),this.applyCustomForward();const i={xr:this};if(this._didStart){if(this.context.new_scripts_xr.length>0){const f=[...this.context.new_scripts_xr];for(let p=0;p<f.length;p++){const b=this.context.new_scripts_xr[p];if(!b||b.destroyed||((h=b.supportsXR)==null?void 0:h.call(b,this.mode))==!1){this.context.new_scripts_xr.splice(p,1);continue}if(!b.activeAndEnabled){this.context.new_scripts_xr.splice(p,1),this.markInactive(b);continue}if(this.addScript(b)){this.invokeCallback_EnterXR(b);for(const x of this.controllers)this.invokeCallback_ControllerAdded(b,x)}}}}else{if(this._didStart=!0,this.mode==="immersive-vr"){const p=On(this.context.scene.children);if(p){const b=p.getSize(te());if(b.length()>0){const x=this._defaultRig.gameObject;x.position.set(p.min.x+b.x*.5,p.min.y,p.max.z+b.z*.5+1.5);const v=p.getCenter(te());v.y=x.position.y,x.lookAt(v)}}}AM({session:this}),bc();for(const p of wr._xrStartListeners)p(i);const f=[...this._xr_scripts];kt&&console.log("NeedleXRSession start, handle scripts:",f);for(const p of f){if(p.destroyed){this._script_to_remove.push(p);continue}if(!p.activeAndEnabled){this.markInactive(p);continue}this.invokeCallback_EnterXR(p);for(const b of this.controllers)this.invokeCallback_ControllerAdded(p,b)}}this.syncCameraCullingMask();for(const f of this.controllers)f.onUpdate(e);if(this._newControllers.length>0){const f=[...this._newControllers];this._newControllers.length=0;for(const p of f){if(!p.connected){console.warn("New controller is not connected",p);continue}this.controllers.push(p);for(const b of this._xr_scripts){if(b.destroyed){this._script_to_remove.push(b);continue}b.activeAndEnabled!==!1&&this.invokeCallback_ControllerAdded(b,p)}}this.controllers.sort((p,b)=>p.index-b.index)}kt&&this.context.time.frame%30===0&&this.controllers.length<=0&&this.session.inputSources.length>0&&(yu(!0),console.error("XRControllers are not added but inputSources are present"));for(const f of this._xr_update_scripts){if(f.destroyed===!0){this._script_to_remove.push(f);continue}if(f.activeAndEnabled===!1){this.markInactive(f);continue}f.onUpdateXR&&f.onUpdateXR(i)}if(this.handleInactiveScripts(),this._script_to_remove.length>0){const f=[...new Set(this._script_to_remove)];this._script_to_remove.length=0;for(const p of f)!p.destroyed&&this.running&&((d=p.onLeaveXR)==null||d.call(p,i)),this.removeScript(p)}(u=this.sync)==null||u.onUpdate(this),this.onRenderDebug()});a(this,"onBeforeRender",()=>{this.context.mainCamera&&(this.updateFade(this.context.mainCamera),this.requestedCameraNearPlane!==null&&this.context.mainCamera instanceof Ae&&(this.context.mainCamera.near=this.requestedCameraNearPlane,this.requestedCameraNearPlane=null))});a(this,"onAfterRender",()=>{if(this.onUpdateFade_PostRender(),Q.isDesktop()||!this._renderOnceOnDevice){const t=this.context.renderer;if(t.xr.isPresenting&&this.context.mainCamera){this._renderOnceOnDevice=!0;const e=t.xr.enabled,i=t.getRenderTarget(),n=this.context.scene.background;t.xr.enabled=!1,t.setRenderTarget(null),this.isPassThrough&&(this.context.scene.background=null),this.context.composer?this.context.composer.render(this.context.time.deltaTime):t.render(this.context.scene,this.context.mainCamera),t.xr.enabled=e,t.setRenderTarget(i),this.context.scene.background=n}}});a(this,"_script_to_remove",[]);a(this,"_camera");a(this,"_cameraRenderParent",new z().rotateY(Math.PI));a(this,"_previousCameraParent");a(this,"_customforward",!0);a(this,"originalCameraNearPlane");a(this,"requestedCameraNearPlane",null);a(this,"_viewerPose");a(this,"_transformOrientation",new re);a(this,"_transformPosition",new R);a(this,"_transition");var o,r;QA(t,n.init),this.session=e,this.mode=t,this.context=i,(kt||k("console"))&&yu(!0),this._xr_scripts=[...n.scripts],this._xr_update_scripts=this._xr_scripts.filter(l=>typeof l.onUpdateXR=="function"),this._controllerAdded=n.controller_added,this._controllerRemoved=n.controller_removed,Yr(this.onBefore,ge.LateUpdate),this.context.pre_render_callbacks.push(this.onBeforeRender),this.context.post_render_callbacks.push(this.onAfterRender),((o=n.init.optionalFeatures)!=null&&o.includes("hit-test")||(r=n.init.requiredFeatures)!=null&&r.includes("hit-test"))&&e.requestReferenceSpace("viewer").then(l=>{var c,h;return(h=(c=e.requestHitTestSource)==null?void 0:c.call(e,{space:l}))==null?void 0:h.then(d=>this._viewerHitTestSource=d).catch(d=>console.error(d))}).catch(l=>console.error(l)),this.context.mainCamera&&(this._originalCameraWorldPosition=ve(this.context.mainCamera,new R),this._originalCameraWorldRotation=Qe(this.context.mainCamera,new re),this._originalCameraWorldScale=Lt(this.context.mainCamera,new R),this._originalCameraParent=this.context.mainCamera.parent,this.context.mainCamera instanceof Ae&&(this.context.mainCamera[vp]=this.context.mainCamera.fov)),this._defaultRig=new VM,this.context.scene.add(this._defaultRig.gameObject),this.addRig(this._defaultRig);for(let l=0;l<e.inputSources.length;l++){const c=e.inputSources[l];if(!c.handedness){console.warn("Input source in xr session has no handedness - ignoring",l);continue}this.onInputSourceAdded(c)}this.session.addEventListener("end",this.onEnd),this.session.addEventListener("inputsourceschange",l=>{for(const c of l.removed)this.disconnectInputSource(c);for(const c of l.added)this.onInputSourceAdded(c)}),this.context.xr=this,this.context.renderer.xr.setSession(this.session).then(this.onRendererSessionSet),"controllerAutoUpdate"in this.context.renderer.xr?(console.debug("Disabling three.js controllerAutoUpdate"),this.context.renderer.xr.controllerAutoUpdate=!1):kt&&console.warn("controllerAutoUpdate is not available in three.js - cannot disable it"),Q.isNeedleAppClip()&&window.requestAnimationFrame(()=>{const l=this.context.renderer.domElement,c=window.devicePixelRatio||1,h=l.width,d=l.height,u=Math.floor(window.innerWidth*c),f=Math.floor(window.innerHeight*c);(Math.abs(h-u)>2||Math.abs(d-f)>2)&&(l.width=u,l.height=f,console.debug("Applied DPR scaling for Needle AppClip XR session",c,l.width,l.height))})}static getXRSync(t){return this._sync||(this._sync=new jA(t)),this._sync}static get currentSessionRequest(){return this._currentSessionRequestMode}static get active(){return this._activeSession}static get activeMode(){var t;return((t=this._activeSession)==null?void 0:t.mode)??null}static get xrSystem(){return"xr"in navigator?navigator.xr:void 0}static isXRSupported(){return Promise.all([this.isVRSupported(),this.isARSupported()]).then(t=>t.some(e=>e)).catch(()=>!1)}static isVRSupported(){return this.isSessionSupported("immersive-vr")}static isARSupported(){return this.isSessionSupported("immersive-ar")}static isSessionSupported(t){var e;return((e=this.xrSystem)==null?void 0:e.isSessionSupported(t).catch(i=>(kt&&console.error(i),!1)))??Promise.resolve(!1)}static onSessionRequestStart(t){this._sessionRequestStartListeners.push(t)}static offSessionRequestStart(t){const e=this._sessionRequestStartListeners.indexOf(t);e>=0&&this._sessionRequestStartListeners.splice(e,1)}static onSessionRequestEnd(t){this._sessionRequestEndListeners.push(t)}static offSessionRequestEnd(t){const e=this._sessionRequestEndListeners.indexOf(t);e>=0&&this._sessionRequestEndListeners.splice(e,1)}static onXRSessionStart(t){this._xrStartListeners.push(t)}static offXRSessionStart(t){const e=this._xrStartListeners.indexOf(t);e>=0&&this._xrStartListeners.splice(e,1)}static onXRSessionEnd(t){this._xrEndListeners.push(t)}static offXRSessionEnd(t){const e=this._xrEndListeners.indexOf(t);e>=0&&this._xrEndListeners.splice(e,1)}static onControllerAdded(t){this._controllerAddedListeners.push(t)}static offControllerAdded(t){const e=this._controllerAddedListeners.indexOf(t);e>=0&&this._controllerAddedListeners.splice(e,1)}static onControllerRemoved(t){this._controllerRemovedListeners.push(t)}static offControllerRemoved(t){const e=this._controllerRemovedListeners.indexOf(t);e>=0&&this._controllerRemovedListeners.splice(e,1)}static offerSession(t,e,i){return"xr"in navigator&&navigator.xr&&"offerSession"in navigator.xr?(typeof navigator.xr.offerSession=="function"&&(console.log("WebXR offerSession is available - requesting mode: "+t),e=="default"&&(e=this.getDefaultSessionInit(t)),navigator.xr.offerSession(t,{...e}).then(n=>wr.setSession(t,n,e,i)).catch(n=>{console.log("XRSession offer rejected (perhaps because another call to offerSession was made or a call to requestSession was made)")})),!0):!1}static getDefaultSessionInit(t){switch(t){case"immersive-ar":const e=["anchors","local-floor","layers","dom-overlay","hit-test","unbounded"];return Q.isVisionOS()||e.push("hand-tracking"),{optionalFeatures:e};case"immersive-vr":const i=["local-floor","bounded-floor","high-fixed-foveation-level","layers"];return Q.isVisionOS()||i.push("hand-tracking"),{optionalFeatures:i};default:return console.warn("No default session init for mode",t),{}}}static async start(t,e,i){var l,c,h,d;if(e||(e={}),Q.isiOS()){const u=await this.isARSupported().catch(()=>!1);if(Q.isVisionOS()&&!u&&(t==="ar"||t==="immersive-ar")&&(t="quicklook"),t==="quicklook")return Tn.sendEvent(de.Current,"xr",{action:"quicklook_export",source:"NeedleXRSession.start"}),ff.exportAndOpen(),null;if(!u&&(t==="immersive-ar"||t==="ar")){this.invokeSessionRequestStart("immersive-ar",e);const f=new URL("https://appclip.apple.com/id?p=tools.needle.launch-app.Clip");f.searchParams.set("url",location.href);const p=f.toString();Tn.sendEvent(de.Current,"xr",{action:"app_clip_launch",source:"NeedleXRSession.start",url:p});const b=window.top||window;try{console.debug("iOS device detected - opening Needle App Clip for AR experience",{mode:t,init:e,url:f}),b.location.href=p}catch(x){console.warn("Error navigating to AppClip "+p+`
`,x),window!==window.top?window.open(p,"_blank"):window.location.href=p}return setTimeout(()=>{this.invokeSessionRequestEnd("immersive-ar",e||{},null)},3e3),null}}if(t==="quicklook")return console.warn("QuickLook mode is only supported on iOS devices"),null;if(t=="ar"&&(t="immersive-ar"),X()&&k("debugxrpreroom"))return console.warn("Debug: Starting temporary XR session"),await Ma.start(t,e||wr.getDefaultSessionInit(t)),null;if(this._currentSessionRequest)return console.warn("A XRSession is already being requested"),(kt||X())&&qe("A XRSession is already being requested"),this._currentSessionRequest.then(()=>this._activeSession);if(this._activeSession)return console.error("A XRSession is already running"),this._activeSession;if(i||(i=de.Current),i||(i=Be.All[0]),!i)throw new Error("No Needle Engine Context found");switch(t){case"immersive-ar":{if(await((l=this.xrSystem)==null?void 0:l.isSessionSupported("immersive-ar"))!==!0)return console.error(t+" is not supported by this browser."),null;const f=this.getDefaultSessionInit(t),p=qA(i.domElement);p&&!Q.isQuest()&&(f.domOverlay={root:p},f.optionalFeatures.push("dom-overlay")),e={...f,...e}}break;case"immersive-vr":{if(await((c=this.xrSystem)==null?void 0:c.isSessionSupported("immersive-vr"))!==!0)return console.error(t+" is not supported by this browser."),null;e={...this.getDefaultSessionInit(t),...e}}break;default:console.warn("No default session init for mode",t);break}e.optionalFeatures??(e.optionalFeatures=[]),e.requiredFeatures??(e.requiredFeatures=[]),await Ma.stop();const n=t=="immersive-ar"?i.scripts_immersive_ar:i.scripts_immersive_vr;kt?console.log(`%cRequesting ${t} session`,"font-weight:bold;",e,n):console.log(`%cRequesting ${t} session`,"font-weight:bold;");for(const u of n)u.onBeforeXR&&u.activeAndEnabled&&!u.destroyed&&u.onBeforeXR(t,e);this.invokeSessionRequestStart(t,e),kt&&at("Requesting "+t+" session ("+Date.now()+")"),Tn.sendEvent(de.Current,"xr",{action:"session_request",mode:t,features:(e.requiredFeatures??[]).concat(e.optionalFeatures??[]).join(","),source:"NeedleXRSession.start"}),this._currentSessionRequest=(h=navigator==null?void 0:navigator.xr)==null?void 0:h.requestSession(t,e),this._currentSessionRequestMode=t;const o=await((d=this._currentSessionRequest)==null?void 0:d.catch(u=>{console.error(u,"Code: "+(u==null?void 0:u.code)),(u==null?void 0:u.code)===9&&qe("Couldn't start XR session. Make sure you allow the required permissions."),console.log("If the specified XR configuration is not supported (e.g. entering AR doesnt work) - make sure you access the website on a secure connection (HTTPS) and your device has the required permissions (e.g. camera access)"),location.protocol==="http:"&&qe("XR requires a secure connection (HTTPS)")}));return this._currentSessionRequest=void 0,this._currentSessionRequestMode=null,this.invokeSessionRequestEnd(t,e,o),o?this.setSession(t,o,e,i):(console.warn("XR Session request was rejected"),null)}static invokeSessionRequestStart(t,e){for(const i of this._sessionRequestStartListeners)i({mode:t,init:e})}static invokeSessionRequestEnd(t,e,i){for(const n of this._sessionRequestEndListeners)n({mode:t,init:e,newSession:i||null})}static setSession(t,e,i,n){if(this._activeSession)return console.error("A XRSession is already running"),this._activeSession;const o=t=="immersive-ar"?n.scripts_immersive_ar:n.scripts_immersive_vr;return this._activeSession=new wr(t,e,n,{scripts:o,controller_added:this._controllerAddedListeners,controller_removed:this._controllerRemovedListeners,init:i}),e.addEventListener("end",this.onEnd),kt?console.log(`%cStarted ${t} session`,"font-weight:bold;",o):console.log(`%cStarted ${t} session`,"font-weight:bold;"),this._activeSession}static stop(){const t=this._activeSession;t&&(t[this.$_stop_request]===void 0?(kt&&console.log("[NeedleXRSession] Stopping XR Session... (new)"),t[this.$_stop_request]=setTimeout(()=>{t.end()})):kt&&console.warn("[NeedleXRSession] XR Session stop already requested"))}get sync(){return wr._sync}get running(){return!this._ended&&this.session!=null}get interactionMode(){return this.session.interactionMode}get visibilityState(){return this.session.visibilityState}get isVisibleBlurred(){return this.session.visibilityState==="visible-blurred"}get isSystemKeyboardSupported(){return this.session.isSystemKeyboardSupported}get environmentBlendMode(){return this.session.environmentBlendMode}get frame(){return this.context.xrFrame}get leftController(){return this.controllers.find(t=>t.side==="left")}get rightController(){return this.controllers.find(t=>t.side==="right")}getController(t){return typeof t=="number"?this.controllers[t]||null:this.controllers.find(e=>e.side===t)||null}get isPassThrough(){return!!(this.environmentBlendMode!=="opaque"&&this.interactionMode==="world-space"||this.mode==="immersive-ar"&&this.environmentBlendMode!=="opaque"&&this.controllers.some(t=>t.inputSource.targetRayMode==="tracked-pointer")||X()&&Q.isDesktop()&&this.mode==="immersive-ar")}get isAR(){return this.mode==="immersive-ar"}get isVR(){return this.mode==="immersive-vr"}get isScreenBasedAR(){return this.isAR&&!this.isPassThrough}get posePosition(){return this._transformPosition}get poseOrientation(){return this._transformOrientation}get referenceSpace(){return this.context.renderer.xr.getReferenceSpace()}get viewerPose(){return this._viewerPose}get isTrackingImages(){if(this.frame&&"getImageTrackingResults"in this.frame&&typeof this.frame.getImageTrackingResults=="function")try{const t=this.frame.getImageTrackingResults();for(const e of t)if(e.trackingState==="tracked")return!0}catch{return!1}return!1}get rig(){const t=this._rigs[0]??null;return t!=null&&t.gameObject&&td(t.gameObject)||(t==null?void 0:t.isActive)===!1?(this.updateActiveXRRig(),this._rigs[0]??null):t}get rigScale(){return this._rigs[0]?(this._lastRigScaleUpdate!==this.context.time.frame&&(this._lastRigScaleUpdate=this.context.time.frame,this._rigScale=this._rigs[0].gameObject.worldScale.x),this._rigScale):1}addRig(t){this._rigs.indexOf(t)>=0||(t.priority===void 0&&(t.priority=0),this._rigs.push(t),this.updateActiveXRRig())}removeRig(t){const e=this._rigs.indexOf(t);e!==-1&&(this._rigs.splice(e,1),this.updateActiveXRRig())}setRigActive(t){const e=this._rigs.indexOf(t),i=this._rigs[0];this._rigs.splice(e,1),this._rigs.unshift(t),t.priority=(i==null?void 0:i.priority)??0,this.updateActiveXRRig()}getUserOffsetInRig(){var i;const t=(i=this.context.mainCamera)==null?void 0:i.position;if(!t||!this.rig)return te(0,0,0);const e=te(t);return e.x*=-1,e.z*=-1,e.applyQuaternion(Un(this.rig.gameObject.quaternion)),e}updateActiveXRRig(){const t=this._rigs[0]??null;this._defaultRig.gameObject.parent!==this.context.scene&&this.context.scene.add(this._defaultRig.gameObject),this._defaultRig.gameObject.visible=!0,this._rigs.includes(this._defaultRig)||this._rigs.push(this._defaultRig);let e=this._rigs[0];e&&e.priority===void 0&&(e.priority=0);for(let i=1;i<this._rigs.length;i++){const n=this._rigs[i];if(n.isActive){if(td(n.gameObject)){this._rigs.splice(i,1),i--;continue}(!e||e.isActive===!1||n.priority!==void 0&&n.priority>e.priority)&&(e=n)}}if(t!==e){const i=this._rigs.indexOf(e);i>=0&&this._rigs.splice(i,1),this._rigs.unshift(e)}kt&&(t===e?console.log("Updated Active XR Rig:",e,"prev:",t):console.log("Updated Active XRRig:",e," (the same as before)"))}getHitTest(t){if(t)return this.getControllerHitTest(t);if(!this._viewerHitTestSource)return null;const e=this._viewerHitTestSource,i=this.frame.getHitTestResults(e);if(i.length>0){const n=i[0];return this.convertHitTestResult(n)}return null}getControllerHitTest(t){const e=t.getHitTestSource();if(!e)return null;const i=this.frame.getHitTestResultsForTransientInput(e);for(const n of i)if(n.inputSource===t.inputSource)for(const o of n.results)return this.convertHitTestResult(o);return null}convertHitTestResult(t){const e=this.context.renderer.xr.getReferenceSpace(),i=e&&t.getPose(e);if(i){const n=te(i.transform.position),o=Un(i.transform.orientation),r=this.context.mainCamera;if((r==null?void 0:r.parent)!==this._cameraRenderParent&&n.applyMatrix4(Mh),r!=null&&r.parent){n.applyMatrix4(r.parent.matrixWorld),o.multiply(us);const l=Qe(r.parent);l.premultiply(us),o.premultiply(l)}return{hit:t,position:n,quaternion:o}}return null}convertSpace(t){const e=te(t.position);e.applyMatrix4(Mh);const i=Un(t.orientation);return i.premultiply(us),{position:e,quaternion:i}}disconnectInputSource(t){const e=(o,r)=>{if(o.inputSource===t){kt&&console.log("Disconnecting controller",o.index);const l=r.indexOf(o);l>=0&&r.splice(l,1),this.invokeControllerEvent(o,this._controllerRemoved,"removed");const c={xr:this,controller:o,change:"removed"};for(const h of this._xr_scripts)h.onXRControllerRemoved&&h.onXRControllerRemoved(c);o.onDisconnected()}},i=[...this.controllers];for(let o=i.length-1;o>=0;o--){const r=i[o];e(r,this.controllers)}const n=[...this._newControllers];for(let o=n.length-1;o>=0;o--){const r=n[o];e(r,this._newControllers)}}end(){this._ended||this.session.end().catch(t=>console.warn(t))}onRenderDebug(){if(kt)for(const t of this.controllers)t.onRenderDebug();if((kt||qw)&&this.rig&&(nb++,nb>=20)){const t=this.rig.gameObject.worldPosition,e=this.rig.gameObject.worldForward;t.add(e.multiplyScalar(1.5));const i=this.rig.gameObject.worldUp;t.add(i.multiplyScalar(2.5));let n="";if(n+=`${this.context.time.smoothedFps.toFixed(0)} FPS`,n+=`, calls: ${this.context.renderer.info.render.calls}, tris: ${this.context.renderer.info.render.triangles.toLocaleString()}`,kt||qw)for(const o of this.controllers)n+=`
${o.hand?"hand":"ctrl"} ${o.inputSource.handedness}[${o.index}] con:${o.connected} tr:${o.isTracking} hts:${o.hasHitTestSource?"yes":"no"}`;nb=0,se.DrawLabel(t,n,void 0,1/60*20)}}addScript(t){return this._xr_scripts.includes(t)?!1:(kt&&console.log("Register new XRScript",t),this._xr_scripts.push(t),typeof t.onUpdateXR=="function"&&this._xr_update_scripts.push(t),!0)}markInactive(t){if(!(this._inactive_scripts.indexOf(t)>=0)){this.removeScript(t,!1),this._inactive_scripts.push(t);for(const e of this.controllers)this.invokeCallback_ControllerRemoved(t,e);this.invokeCallback_LeaveXR(t)}}handleInactiveScripts(){if(this._inactive_scripts.length>0)for(let t=this._inactive_scripts.length-1;t>=0;t--){const e=this._inactive_scripts[t];if(e.activeAndEnabled){this._inactive_scripts.splice(t,1),this.addScript(e),this.invokeCallback_EnterXR(e);for(const i of this.controllers)this.invokeCallback_ControllerAdded(e,i)}}}removeScript(t,e=!0){kt&&console.log("Remove XRScript",t);const i=this._xr_scripts.indexOf(t);i>=0&&this._xr_scripts.splice(i,1);const n=this._xr_update_scripts.indexOf(t);if(n>=0&&this._xr_update_scripts.splice(n,1),e){const o=this._inactive_scripts.indexOf(t);o>=0&&this._inactive_scripts.splice(o,1)}}invokeCallback_EnterXR(t){t.onEnterXR&&t.onEnterXR({xr:this})}invokeCallback_ControllerAdded(t,e){t.onXRControllerAdded&&t.onXRControllerAdded({xr:this,controller:e,change:"added"})}invokeCallback_ControllerRemoved(t,e){t.onXRControllerRemoved&&t.onXRControllerRemoved({xr:this,controller:e,change:"removed"})}invokeCallback_LeaveXR(t){t.onLeaveXR&&!t.destroyed&&t.onLeaveXR({xr:this})}syncCameraCullingMask(){var i;const t=this.context.xrCamera,e=(i=this.context.mainCameraComponent)==null?void 0:i.cullingMask;if(t&&e!==void 0){for(const n of t.cameras)n.layers.mask=e;t.layers.mask=e}else if(t){for(const n of t.cameras)n.layers.enableAll();t.layers.enableAll()}}invokeControllerEvent(t,e,i){for(let n=e.length-1;n>=0;n--){const o=e[n];if(o)try{o({xr:this,controller:t,change:i})}catch(r){console.error(r)}}}applyCustomForward(){var t;if(this.context.mainCamera&&this._customforward){this._camera=this.context.mainCamera,this._camera.parent!==this._cameraRenderParent&&(this._previousCameraParent=this._camera.parent,(t=this._previousCameraParent)==null||t.add(this._cameraRenderParent)),this._cameraRenderParent.name="XR Camera Render Parent",this._cameraRenderParent.add(this._camera);{let e=.02;const i=.001;if(this.rig){const n=Lt(this.rig.gameObject);e*=n.x}this._camera instanceof Ae&&Math.abs(this._camera.near-e)>i&&(this.isAR?this.originalCameraNearPlane=this._camera.near:this._camera.near=e,kt&&console.debug(`Setting camera near plane to ${e} (was ${this.originalCameraNearPlane}) to account for XR rendering scale`))}}}revertCustomForward(){this._camera&&this._previousCameraParent&&this._previousCameraParent.add(this._camera),this._previousCameraParent=null,this._camera instanceof Ae&&this.originalCameraNearPlane!=null&&(this._camera.near=this.originalCameraNearPlane,this.originalCameraNearPlane=void 0)}internalUpdateState(){const t=this.context.renderer.xr.getReferenceSpace();if(!t){this._viewerPose=void 0;return}if(this._viewerPose=this.frame.getViewerPose(t),this._viewerPose){const e=this._viewerPose.transform;this._transformPosition.set(e.position.x,e.position.y,e.position.z),this._transformOrientation.set(e.orientation.x,e.orientation.y,e.orientation.z,e.orientation.w)}}get transition(){return this._transition||(this._transition=new Vw),this._transition}fadeTransition(){return this._transition||(this._transition=new Vw),this._transition.fadeTransition()}updateFade(t){this._transition&&t instanceof Ae&&this._transition.update(t,this.context.time.deltaTime)}onUpdateFade_PostRender(){var t;(t=this._transition)==null||t.remove()}};let fe=wr;a(fe,"_sync",null),a(fe,"_currentSessionRequestMode",null),a(fe,"_currentSessionRequest"),a(fe,"_activeSession"),a(fe,"_sessionRequestStartListeners",[]),a(fe,"_sessionRequestEndListeners",[]),a(fe,"_xrStartListeners",[]),a(fe,"_xrEndListeners",[]),a(fe,"_controllerAddedListeners",[]),a(fe,"_controllerRemovedListeners",[]),a(fe,"$_stop_request",Symbol()),a(fe,"onEnd",()=>{kt&&console.log("XR Session ended"),wr._activeSession=null});const sb=k("debugwebxr");class JA{static tryFindAvatarObjects(t,e,i){if(i.head&&i.leftHand&&i.rightHand)return;const n=t.name.toLocaleLowerCase();!i.head&&n.includes("head")&&(sb&&console.log("FOUND AVATAR HEAD",t.name),i.head=new we("",e,t)),n.includes("hand")&&(!i.leftHand&&n.includes("left")&&(sb&&console.log("FOUND AVATAR LEFT HAND",t.name),i.leftHand=new we("",e,t)),!i.rightHand&&n.includes("right")&&(sb&&console.log("FOUND AVATAR RIGHT HAND",t.name),i.rightHand=new we("",e,t)));for(let o=0;o<t.children.length;o++){if(i.head&&i.leftHand&&i.rightHand)return;const r=t.children[o];this.tryFindAvatarObjects(r,e,i)}}}class Te extends Se{constructor(e,i,n,o){super();a(this,"alpha",1);typeof e=="number"&&typeof i=="number"&&typeof n=="number"?(this.set(e,i,n),this.alpha=typeof o=="number"?o:1):e!==void 0&&(this.set(e),this.alpha=1)}get isRGBAColor(){return!0}set a(e){this.alpha=e}get a(){return this.alpha}clone(){const e=super.clone();return e.alpha=this.alpha,e}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,"alpha"in e&&typeof e.alpha=="number"?this.alpha=e.alpha:typeof e.a=="number"&&(this.alpha=e.a),this}lerp(e,i){const n=e;return n.alpha!=null&&(this.alpha=ee.lerp(this.alpha,n.alpha,i)),super.lerp(e,i)}lerpColors(e,i,n){const o=e,r=i;return o.alpha!=null&&r.alpha!=null&&(this.alpha=ee.lerp(o.alpha,r.alpha,n)),super.lerpColors(e,i,n)}multiply(e){const i=e;return i.alpha!=null&&(this.alpha=this.alpha*i.alpha),super.multiply(e)}fromArray(e,i=0){return this.alpha=e[i+3],super.fromArray(e,i)}static fromColorRepresentation(e){if(typeof e=="string"){if(e.trim()==="transparent")return new Te(0,0,0,0);if(e.startsWith("#")&&e.length===9){const i=parseInt(e.slice(1,9),16),n=i>>24&255,o=i>>16&255,r=i>>8&255,l=i>>0&255;return new Te(n/255,o/255,r/255,l/255)}else if(e.startsWith("#")){const i=parseInt(e.slice(1),16),n=i>>16&255,o=i>>8&255,r=i>>0&255;return new Te(n/255,o/255,r/255,1)}else if(e.startsWith("rgba")){const i=e.slice(5,-1).split(",").map(Number);return new Te(i[0]/255,i[1]/255,i[2]/255,i[3])}else if(e.startsWith("rgb")){const i=e.slice(4,-1).split(",").map(Number);return new Te(i[0]/255,i[1]/255,i[2]/255,1)}}else if(Array.isArray(e)){if(e.length===4)return new Te(e[0],e[1],e[2],e[3]);if(e.length===3)return new Te(e[0],e[1],e[2],1);console.error("Invalid color array length. Expected 3 or 4, got "+e.length)}return new Te(e)}}const Ui=new R,Xw=new R,Qw=new re,e2=k("debuggizmos"),Ms=8947848,ob=32,ds=class{constructor(){}static isGizmo(t){return t[I_]!==void 0}static setVisible(t){for(const e of ot.timedObjectsBuffer)e.visible=t}static DrawLabel(t,e,i=.05,n=0,o,r,l){var d;if(!ds.enabled)return null;o||(o=Ms);const c=((d=fe.active)==null?void 0:d.rigScale)??1,h=ot.getTextLabel(n,e,i*c,o,r);return l instanceof z&&l.add(h),h.position.x=t.x,h.position.y=t.y,h.position.z=t.z,h}static DrawRay(t,e,i=Ms,n=0,o=!0){if(!ds.enabled)return;const r=ot.getLine(n),l=r.geometry.getAttribute("position");l.setXYZ(0,t.x,t.y,t.z),Ui.set(e.x,e.y,e.z).multiplyScalar(999999999),l.setXYZ(1,t.x+Ui.x,t.y+Ui.y,t.z+Ui.z),l.needsUpdate=!0,r.material.depthTest=o,r.material.depthWrite=!1,r.material.fog=!1,Ds(r.material,i)}static DrawDirection(t,e,i=Ms,n=0,o=!0,r=1){if(!ds.enabled)return;const l=ot.getLine(n),c=l.geometry.getAttribute("position");c.setXYZ(0,t.x,t.y,t.z),e.w!==void 0?(Ui.set(0,0,-r),Qw.set(e.x,e.y,e.z,e.w),Ui.applyQuaternion(Qw)):(Ui.set(e.x,e.y,e.z),Ui.multiplyScalar(r)),c.setXYZ(1,t.x+Ui.x,t.y+Ui.y,t.z+Ui.z),c.needsUpdate=!0,l.material.depthTest=o,l.material.depthWrite=!1,Ds(l.material,i)}static DrawLine(t,e,i=Ms,n=0,o=!0){if(!ds.enabled)return;const r=ot.getLine(n),l=r.geometry.getAttribute("position");l.setXYZ(0,t.x,t.y,t.z),l.setXYZ(1,e.x,e.y,e.z),l.needsUpdate=!0,r.material.depthTest=o,r.material.depthWrite=!1,r.material.fog=!1,Ds(r.material,i)}static DrawCircle(t,e,i,n=Ms,o=0,r=!0){if(!ds.enabled)return;const l=ot.getCircle(o);l.position.set(t.x,t.y,t.z),l.scale.set(i,i,i),l.quaternion.setFromUnitVectors(this._up,Ui.set(e.x,e.y,e.z).normalize()),l.material.depthTest=r,l.material.depthWrite=!1,l.material.fog=!1,Ds(l.material,n)}static DrawWireSphere(t,e,i=Ms,n=0,o=!0){if(!ds.enabled)return;const r=ot.getSphere(e,n,!0);Qh(r,t.x,t.y,t.z),r.material.depthTest=o,r.material.depthWrite=!1,r.material.fog=!1,Ds(r.material,i)}static DrawSphere(t,e,i=Ms,n=0,o=!0){if(!ds.enabled)return;const r=ot.getSphere(e,n,!1);Qh(r,t.x,t.y,t.z),r.material.depthTest=o,r.material.depthWrite=!1,Ds(r.material,i)}static DrawWireBox(t,e,i=Ms,n=0,o=!0,r=void 0){if(!ds.enabled)return;const l=ot.getBox(n);l.position.set(t.x,t.y,t.z),l.scale.set(e.x,e.y,e.z),r?l.quaternion.copy(r):l.quaternion.identity(),l.material.depthTest=o,l.material.wireframe=!0,l.material.depthWrite=!1,l.material.fog=!1,Ds(l.material,i)}static DrawWireBox3(t,e=Ms,i=0,n=!0){if(!ds.enabled)return;const o=ot.getBox(i);o.position.copy(t.getCenter(Ui)),o.scale.copy(t.getSize(Ui)),o.material.depthTest=n,o.material.wireframe=!0,o.material.depthWrite=!1,o.material.fog=!1,Ds(o.material,e)}static DrawArrow(t,e,i=Ms,n=0,o=!0,r=!1){if(!ds.enabled)return;const l=ot.getArrowHead(n);l.position.set(e.x,e.y,e.z),l.quaternion.setFromUnitVectors(this._up.set(0,1,0),Ui.set(e.x,e.y,e.z).sub(Xw.set(t.x,t.y,t.z)).normalize());const h=Ui.set(e.x,e.y,e.z).sub(Xw.set(t.x,t.y,t.z)).length()*.1;l.scale.set(h,h,h),l.material.depthTest=o,l.material.wireframe=r,Ds(l.material,i),this.DrawLine(t,e,i,n,o)}static DrawWireMesh(t){const e=ot.getMesh(t.duration??0);"mesh"in t?(e.geometry=t.mesh.geometry,e.matrixWorld.copy(t.mesh.matrixWorld)):(e.geometry=t.geometry,e.matrixWorld.copy(t.matrix)),e.matrixAutoUpdate=!1,e.matrixWorldAutoUpdate=!1,e.material.depthTest=t.depthTest??!0,e.material.wireframe=!0,Ds(e.material,t.color??Ms)}};let se=ds;a(se,"enabled",!0),a(se,"_up",new R(0,1,0));const t2=new Vh(1,1,1);function Z0(s=null){const t=new Se(s??14540253),e=new wO(t2);return new XC(e,new O0({color:t}))}function Ds(s,t){if(Array.isArray(s)){for(const i of s)Ds(i,t);return}const e=t instanceof Te?t.a:1;s.color.set(t),s.opacity=e,s.transparent=e<1}const I_=Symbol("GizmoCache");class ot{static ensureFont(){let t=it.FontLibrary.getFontFamily(this.familyName);if(!t){t=it.FontLibrary.addFontFamily(this.familyName);const e=t.addVariant("normal","normal","https://uploads.needle.tools/include/font-msdf.json","https://uploads.needle.tools/include/font.png");e==null||e.addEventListener("ready",()=>{it.update()})}}static getTextLabel(t,e,i,n,o){this.ensureFont();let r=this.textLabelCache.pop(),l=1;o&&typeof o=="string"&&(o==null?void 0:o.length)>=8&&o.startsWith("#")?(l=parseInt(o.substring(7),16)/255,o=o.substring(0,7),e2&&console.log(o,l)):typeof o=="object"&&o.a!==void 0&&(l=o.a);const c={boxSizing:"border-box",fontFamily:this.familyName,width:"auto",fontSize:i,color:n,lineHeight:1,backgroundColor:o??void 0,backgroundOpacity:l,textContent:e,borderRadius:.5*i,padding:.8*i,whiteSpace:"pre",offset:.05*i};if(r)r.set(c);else{r=new n1(c);const h=this,d=r;d.setText=function(u){this.set({textContent:u}),h.tmuiNeedsUpdate=!0}}return this.tmuiNeedsUpdate=!0,this.registerTimedObject(de.Current,r,t,this.textLabelCache),r}static getBox(t){let e=this.boxesCache.pop();if(!e){const i=new Vh(1,1,1);e=new le(i)}return this.registerTimedObject(de.Current,e,t,this.boxesCache),e}static getLine(t){let e=this.linesCache.pop();if(!e){e=new Hh;let i=e.geometry.getAttribute("position");i||(i=new Cn(new Float32Array(2*3),3),e.geometry.setAttribute("position",i))}return e.frustumCulled=!1,this.registerTimedObject(de.Current,e,t,this.linesCache),e}static getCircle(t){let e=this.circlesCache.pop();if(!e){e=new Hh;let i=e.geometry.getAttribute("position");if(!i){i=new Cn(new Float32Array(ob*3),3),e.geometry.setAttribute("position",i);const n=te(0,1,0),o=te(0,0,1),r=te(o);r.cross(n).normalize();const l=te(r),c=Math.PI*2/(ob-1);for(let h=0;h<ob+1;h++){const d=c*h;n.copy(l).multiplyScalar(Math.cos(d)*1),r.copy(o).multiplyScalar(Math.sin(d)*1);const u=n.add(r);i.setXYZ(h,u.x,u.y,u.z)}}}return e.frustumCulled=!1,this.registerTimedObject(de.Current,e,t,this.circlesCache),e}static getSphere(t,e,i){let n=this.spheresCache.pop();return n||(n=new le(new vg(1,8,8))),n.scale.set(t,t,t),n.material.wireframe=i,this.registerTimedObject(de.Current,n,e,this.spheresCache),n}static getArrowHead(t){let e=this.arrowHeadsCache.pop();return e||(e=new le(new GC(0,.5,1,8))),this.registerTimedObject(de.Current,e,t,this.arrowHeadsCache),e}static getMesh(t){let e=this.mesh.pop();return e||(e=new le,e.material=new Ye),this.registerTimedObject(de.Current,e,t,this.mesh),e}static registerTimedObject(t,e,i,n){if(!t){console.error("No Needle Engine context available. Did you call a Gizmos function in global scope?");return}const o=this.contextBeforeRenderCallbacks.get(t),r=this.contextPostRenderCallbacks.get(t);if(o){if(t.pre_render_callbacks[t.pre_render_callbacks.length-1]!==o){const l=t.pre_render_callbacks.indexOf(o);l>=0&&t.pre_render_callbacks.splice(l,1),t.pre_render_callbacks.push(o)}}else{const l=()=>{this.onBeforeRender(t,this.timedObjectsBuffer)};this.contextBeforeRenderCallbacks.set(t,l),t.pre_render_callbacks.push(l)}if(r){if(t.post_render_callbacks[t.post_render_callbacks.length-1]!==r){const l=t.post_render_callbacks.indexOf(r);l>=0&&t.post_render_callbacks.splice(l,1),t.post_render_callbacks.push(r)}}else{const l=()=>{this.onPostRender(t,this.timedObjectsBuffer,this.timesBuffer)};this.contextPostRenderCallbacks.set(t,l),t.post_render_callbacks.push(l)}e.traverse(l=>{l.layers.disableAll(),l.layers.enable(2)}),e.renderOrder=999999,e[I_]=n,e.castShadow=!1,e.receiveShadow=!1,e.isGizmo=!0,this.timedObjectsBuffer.push(e),this.timesBuffer.push(de.Current.time.realtimeSinceStartup+i),t.scene.add(e)}static onBeforeRender(t,e){this.tmuiNeedsUpdate&&(this.tmuiNeedsUpdate=!1,it.update());for(let i=0;i<e.length;i++){const n=e[i];if(t.mainCamera&&n instanceof it.MeshUIBaseElement){if(td(n))continue;const o=t.isInVR,r=!1,l=!o;Eg(n,t.mainCamera,r,l)}}}static onPostRender(t,e,i){const n=t.time.realtimeSinceStartup;for(let o=e.length-1;o>=0;o--){const r=e[o];n>=i[o]-1e-6&&(e.splice(o,1),i.splice(o,1),r.removeFromParent(),td(r)!=!0&&r[I_].push(r))}}}a(ot,"familyName","needle-gizmos"),a(ot,"linesCache",[]),a(ot,"circlesCache",[]),a(ot,"spheresCache",[]),a(ot,"boxesCache",[]),a(ot,"arrowHeadsCache",[]),a(ot,"mesh",[]),a(ot,"textLabelCache",[]),a(ot,"timedObjectsBuffer",new Array),a(ot,"timesBuffer",new Array),a(ot,"contextPostRenderCallbacks",new Map),a(ot,"contextBeforeRenderCallbacks",new Map),a(ot,"tmuiNeedsUpdate",!1);const ln=k("debugphysics"),i2=k("debugworker"),Yw=new Va;class Ya{constructor(){a(this,"ray");a(this,"cam");a(this,"screenPoint");a(this,"raycaster");a(this,"results");a(this,"targets");a(this,"recursive",!0);a(this,"minDistance");a(this,"maxDistance");a(this,"lineThreshold");a(this,"layerMask");a(this,"ignore");a(this,"testObject");a(this,"useAcceleratedRaycast");a(this,"allowSlowRaycastFallback",!0)}screenPointFromOffset(t,e){this.screenPoint===void 0&&(this.screenPoint=new _e),this.screenPoint.x=t/window.innerWidth*2-1,this.screenPoint.y=-(e/window.innerHeight)*2+1}setLayer(t){Yw.set(t),this.layerMask=Yw}setMask(t){this.layerMask||(this.layerMask=new Va);const e=this.layerMask;e?e.mask=t:this.layerMask=t}}a(Ya,"AllLayers",4294967295);class jP{constructor(t,e,i){a(this,"distance");a(this,"point");a(this,"object");this.object=t,this.distance=e,this.point=i}}const ag=class{constructor(t){a(this,"context");a(this,"engine");a(this,"raycaster",new xg);a(this,"defaultRaycastOptions",new Ya);a(this,"targetBuffer",new Array(1));a(this,"defaultThresholds",{Mesh:{},Line:{threshold:-1},LOD:{},Points:{threshold:0},Sprite:{}});a(this,"sphereResults",new Array);a(this,"sphereMask",new Va);a(this,"sphere",new wg);a(this,"tempBoundingBox",new bs);this.context=t}static get raycasting(){return this._raycasting>0}raycastPhysicsFast(t,e=void 0,i=1/0,n=!0){var o;return((o=this.context.physics.engine)==null?void 0:o.raycast(t,e,{maxDistance:i,solid:n}))??null}raycastPhysicsFastAndGetNormal(t,e=void 0,i=1/0,n=!0){var o;return((o=this.context.physics.engine)==null?void 0:o.raycastAndGetNormal(t,e,{maxDistance:i,solid:n}))??null}sphereOverlapPhysics(t,e){var i;return((i=this.context.physics.engine)==null?void 0:i.sphereOverlap(t,e))??null}sphereOverlap(t,e,i=!0,n=!1,o=null){if(this.sphereResults.length=0,!this.context.scene)return this.sphereResults;const r=this.sphereMask;r.enableAll(),r.disable(2);for(const l of this.context.scene.children)this.intersectSphere(l,t,e,r,this.sphereResults,i,n,o);return this.sphereResults.sort((l,c)=>l.distance-c.distance)}raycastFromRay(t,e=null){const i=e??this.defaultRaycastOptions;i.ray=t;const n=this.raycast(i);return i===this.defaultRaycastOptions&&(i.ray=void 0),n}raycast(t=null){ln&&performance.mark("raycast.start"),t||(t=this.defaultRaycastOptions);const e=t.screenPoint??this.context.input.mousePositionRC,i=t.raycaster??this.raycaster;if(i.near=t.minDistance??0,i.far=t.maxDistance??1/0,i.params=this.defaultThresholds,t.lineThreshold===void 0&&(t.lineThreshold=-1),i.params.Line={threshold:t.lineThreshold},t.ray)i.ray.copy(t.ray);else{const l=t.cam??this.context.mainCamera;if(!l)return ln&&console.error("Can not perform raycast - no main camera found"),this.defaultRaycastOptions.results&&(this.defaultRaycastOptions.results.length=0),this.defaultRaycastOptions.results??[];const c=this.context.xrCamera;this.context.isInXR&&c instanceof SO&&c.cameras.length>0?i.setFromCamera(e,c.cameras[0]):i.setFromCamera(e,l)}let n=t.targets;n||(n=this.targetBuffer,n.length=1,n[0]=this.context.scene);let o=t.results;this.defaultRaycastOptions.results&&(this.defaultRaycastOptions.results.length=0),o||(this.defaultRaycastOptions.results||(this.defaultRaycastOptions.results=new Array),o=this.defaultRaycastOptions.results),t.layerMask!==void 0?t.layerMask instanceof Va?i.layers.mask=t.layerMask.mask:i.layers.mask=t.layerMask:(i.layers.enableAll(),i.layers.disable(2)),ln&&console.time("raycast"),o.length=0,ag._raycasting++,this.intersect(this.raycaster,n,o,t),o.sort((l,c)=>l.distance-c.distance);const r=t.ignore;return r!==void 0&&r.length>0&&(o=o.filter(l=>!r.includes(l.object))),ag._raycasting--,ln&&(console.timeEnd("raycast"),console.warn("#"+this.context.time.frame+", hits:",o!=null&&o.length?[...o]:"nothing"),performance.mark("raycast.end"),performance.measure("raycast","raycast.start","raycast.end")),o}intersect(t,e,i,n){var o,r,l;for(const c of e){if(!c||c.visible===!1||se.isGizmo(c)||n.lineThreshold!==void 0&&n.lineThreshold<0&&c instanceof Hh)continue;let h=!0;const d=c,u=d.geometry;if(c.raycastAllowed===!1&&(h=!1),h&&n.testObject){const f=(o=n.testObject)==null?void 0:o.call(n,c);if(f===!1)continue;f==="continue in children"&&(h=!1)}else h&&(u&&Kw(u)||(h=!1));if(h){const f=i.length,p=c.raycastPreference||"lod";let b=p!=="bounds";if(n.precise===!1&&(b=!1),u&&(b||(b=((l=(r=u.getAttribute("position"))==null?void 0:r.array)==null?void 0:l.length)<64)),d instanceof Xh&&(b=!1),p==="lod"){const x=d1(c);x&&(d.geometry=x)}if(!b&&s2(d,t,i)||(n.useAcceleratedRaycast!==!1?Tm.runMeshBVHRaycast(t,d,i,this.context,n):t.intersectObject(d,!1,i)),d.geometry=u,ln&&i.length!=f){const x=i[i.length-1];se.DrawWireSphere(x.point,.1,7798784,1,!1),se.DrawWireMesh({mesh:c,depthTest:!1,duration:.2,color:7798784})}}n.recursive!==!1&&this.intersect(t,c.children,i,n)}return i}intersectSphere(t,e,i,n,o,r,l,c){let h=t&&t.isMesh&&t.layers.test(n)&&!se.isGizmo(t);h&&(h=t.visible),h&&(h=!(t instanceof Hh)),h&&(h=!(t instanceof Xh));const d=t,u=d.geometry;if(h&&c){const f=c(t);if(f===!1)return;f==="continue in children"&&(h=!1)}if(u&&Kw(u)||(h=!1),h){if(l){const f=this.sphere;f.center.copy(e),f.radius=i;const p=o.length;if(Tm.runMeshBVHRaycast(this.sphere,d,o,this.context,{}),p!=o.length&&!r)return}else if(u.boundingBox||u.computeBoundingBox(),u.boundingBox){d.matrixWorldNeedsUpdate&&d.updateWorldMatrix(!1,!1);const f=this.tempBoundingBox.copy(u.boundingBox).applyMatrix4(d.matrixWorld),p=this.sphere;if(p.center.copy(e),p.radius=i,p.intersectsBox(f)){const b=ve(t),x=b.distanceTo(p.center),v=new jP(t,x,b);if(o.push(v),!r)return}}}if(t.children)for(const f of t.children){const p=o.length;if(this.intersectSphere(f,e,i,n,o,r,l,c),p!=o.length&&!r)return}}};let xu=ag;a(xu,"_raycasting",0);function Kw(s){return!(s.index&&s.index.array.length<3)}const Pl=new wg,xp=new lc,n2=new HC;function s2(s,t,e){const i=s._computeIntersections;if(!i)return!1;let n=s["_computeIntersections:Needle"];return n||(n=s["_computeIntersections:Needle"]=function(o,r,l){const c=this,h=c.geometry.boundingSphere;if(h){if(c instanceof Xh){xp.setFromNormalAndCoplanarPoint(te(0,1,0),te(0,-c.position.y,0)),xp.applyMatrix4(c.matrixWorld,n2);const u=o.ray.intersectPlane(xp,te());if(u){Pl.copy(h),Pl.applyMatrix4(c.matrixWorld);const p=te(u).sub(o.ray.origin).length(),b=Pl.radius*.5;p<b&&r.push({distance:p,point:u,object:c,normal:xp.normal.clone()})}return}Pl.copy(h),Pl.applyMatrix4(c.matrixWorld);const d=o.ray.intersectSphere(Pl,te());if(d){const u=te(d).sub(o.ray.origin),f=u.length();if(f>Pl.radius){const p=u.clone().normalize();r.push({distance:f,point:d,object:c,normal:p})}}}}),s._computeIntersections=n,t.intersectObject(s,!1,e),s._computeIntersections=i,!0}var Tm;(function(s){let t=0;function e(C,P,E,D,M){var G,V,U,$,Y;if(!P.geometry||!P.geometry.hasAttribute("position"))return!1;const A=P.geometry;if(P!=null&&P.isSkinnedMesh){const B=P,N=B.bvhNeedsUpdate;if(!B.staticGenerator)c(),r&&(B.staticGenerator=new r(P),B.staticGenerator.applyWorldTransforms=!1,B.staticGeometry=B.staticGenerator.generate(),A.boundsTree=l==null?void 0:l.call(B.staticGeometry),B.staticGeometryLastUpdate=performance.now()+Math.random()*200,B.bvhNeedsUpdate=!0);else if(A.boundsTree&&(B.autoUpdateMeshBvhInterval!==void 0&&B.autoUpdateMeshBvhInterval>=0||N===!0)){const Z=performance.now(),ae=Z-B.staticGeometryLastUpdate,ie=B.autoUpdateMeshBvhInterval??100;(N||ae>ie)&&(ln&&console.warn(`Physics: updating skinned mesh bvh for ${P.name} after ${ae.toFixed(2)}ms`),B.bvhNeedsUpdate=!1,B.staticGeometryLastUpdate=Z,(G=B.staticGenerator)==null||G.generate(B.staticGeometry),A.boundsTree.refit())}}else if(!A.boundsTree){d||S();let B=!0;if((D.xr||A[b]===!1||(V=A.getAttribute("position"))!=null&&V.isInterleavedBufferAttribute||A.index&&((U=A.index)!=null&&U.isInterleavedBufferAttribute)||t>10)&&(B=!1),B&&f){if(A[p]===void 0){let N=null;if(v.length>0){const Z=v.shift();Z&&!Z.running&&(N=Z)}if(!N&&x.length<3)try{i2&&console.warn("[GenerateMeshBVHWorker] Creating worker with import.meta.url:",import.meta.url),N=new f,x.push(N)}catch(Z){Z instanceof DOMException&&Z.name==="SecurityError"?(console.warn("Failed to create MeshBVH worker, falling back to main thread generation. This can happen when running from file://, if the browser does not support workers or if the browser is blocking workers for other reasons."),console.debug(Z),t+=10):(console.error("Failed to create MeshBVH worker. Please see below for more details:"),console.log(Z)),t++}if(N!=null&&!N.running){const Z=P.name;ln&&console.log("<<<< worker start",Z,N),A[p]="queued",performance.mark("bvh.create.start");const ae=A.clone();try{N.generate(ae).then(ie=>{A[p]="done",A.boundsTree=ie}).catch(ie=>{A[p]="failed - "+(ie==null?void 0:ie.message),A[b]=!1,ln&&console.error("Failed to generate mesh bvh on worker",ie)}).finally(()=>{ln&&console.log(">>>>> worker done",Z,{hasBoundsTre:A.boundsTree!=null}),v.push(N),ae.dispose(),performance.mark("bvh.create.end"),performance.measure("bvh.create (worker)","bvh.create.start","bvh.create.end")})}catch(ie){console.error("Failed to generate mesh bvh on worker",ie)}}else ln&&console.warn("No worker available")}}else(!u||!B)&&(c(),o&&(performance.mark("bvh.create.start"),A.boundsTree=new o(A),performance.mark("bvh.create.end"),performance.measure("bvh.create","bvh.create.start","bvh.create.end")))}if(C instanceof xg){const B=C,N=P.raycast;if(A.boundsTree)c(),n&&(P.acceleratedRaycast||(P.acceleratedRaycast=n.bind(P),ln&&console.debug(`Physics: bind acceleratedRaycast fn to "${P.name}"`)),P.raycast=P.acceleratedRaycast);else if(ln&&console.warn("No bounds tree found for mesh",P.name,{workerTask:A[p],hasAcceleratedRaycast:n!=null}),M.allowSlowRaycastFallback===!1&&(((Y=($=A.getAttribute("position"))==null?void 0:$.array)==null?void 0:Y.length)??0)>2e3)return ln&&console.warn("Skipping raycast because no bounds tree is available and allowSlowRaycastFallback is false"),!1;const Z=B.firstHitOnly;return B.firstHitOnly=!1,B.intersectObject(P,!1,E),B.firstHitOnly=Z,P.raycast=N,!0}else if(C instanceof wg){const B=A.boundsTree;if(B){const N=C;if(h.copy(P.matrixWorld).invert(),N.applyMatrix4(h),B.intersectsSphere(N)){const ae=ve(P),ie=ae.distanceTo(N.center),J=new jP(P,ie,ae);E.push(J)}}return!0}return!1}s.runMeshBVHRaycast=e;let i=!1,n=null,o=null,r=null,l=null;function c(){i||(i=!0,qs(()=>import("./index.1bfa8200.js"),["./index.1bfa8200.js","./MeshBVH.b54497da.js","./three@0.169.15.js"],import.meta.url).then(C=>{n=C.acceleratedRaycast,o=C.MeshBVH,r=C.StaticGeometryGenerator,l=C.computeBoundsTree}).catch(C=>{(ln||X())&&console.error("Failed to load BVH library...",C.message)}))}const h=new xe;let d=!1,u=!1,f=null;const p=Symbol("Needle:MeshBVH-Worker"),b=Symbol("Needle:MeshBVH-CanUseWorker"),x=[],v=[];function S(){d=!0,u=!0,qs(()=>import("./GenerateMeshBVHWorker.01dad000.js"),["./GenerateMeshBVHWorker.01dad000.js","./three@0.169.15.js","./MeshBVH.b54497da.js"],import.meta.url).then(C=>{f=C.GenerateMeshBVHWorker}).catch(C=>{ln||X()?console.warn("Failed to setup mesh bvh worker"):console.debug("Failed to setup mesh bvh worker",C)}).finally(()=>{u=!1})}})(Tm||(Tm={}));const Zw=Symbol("gltf-loader-internal-usage-tracker"),o2=k("debugusers"),Yu=class{constructor(t){a(this,"parser");a(this,"_getDependency");a(this,"_loadingId");a(this,"_loadedObjects",new Set);this.parser=t,this._getDependency=this.parser.getDependency,this._loadingId=Date.now().toString()}get name(){return"NEEDLE_internal_usage_tracker"}static isLoading(t){return Yu._loadingProcesses>0}beforeRoot(){Yu._loadingProcesses++;const t=this,e=this._getDependency;return this.parser.getDependency=function(i,n){const o=e.call(this,i,n);return o.then(r=>(r&&(t._loadedObjects.add(r),r[Zw]=t._loadingId),r)),o},null}afterRoot(t){Yu._loadingProcesses--,this.parser.getDependency=this._getDependency;for(const e of this._loadedObjects)delete e[Zw],e instanceof z&&(e.parent||e instanceof le&&setTimeout(()=>{o2&&console.warn("> GLTF LOADER: Mesh not used in scene!",e),e.material=null,e.geometry=null},1e3));return null}};let wu=Yu;a(wu,"_loadingProcesses",0);class r2{constructor(){window.addEventListener("unhandledrejection",t=>{var i;if(t.defaultPrevented)return;const e=(i=t==null?void 0:t.reason)==null?void 0:i.path;if(e){const n=e[0];n&&n.tagName==="IMG"&&(console.warn(`Could not load image:
`+n.src),t.preventDefault())}})}}const Dg=k("trackresources");function FP(){return Dg==="dispose"}let vc=!0;Dg===0&&(vc=!1);function C4(s){vc=s}function a2(){return vc}const BP=Symbol("disposable");function l2(s,t){s&&(s[BP]=t,ec&&console.warn("Set disposable",t,s))}const UP=Symbol("disposed");function P4(s){return s[UP]===!0}function ft(s){var t;if(s){if(s[BP]===!1){ec&&console.warn("Object is marked as not disposable",s);return}if(typeof s=="object"&&(s[UP]=!0),s instanceof Xn)ft(s.environment),ft(s.background),ft(s.customDepthMaterial),ft(s.customDistanceMaterial);else if(s instanceof Ia)ft(s.geometry),ft(s.material),ft(s.skeleton),ft(s.bindMatrix),ft(s.bindMatrixInverse),ft(s.customDepthMaterial),ft(s.customDistanceMaterial),s.visible=!1;else if(s instanceof le)ft(s.geometry),ft(s.material),ft(s.customDepthMaterial),ft(s.customDistanceMaterial),s.visible=!1;else if(s instanceof z)s.visible=!1;else if(s instanceof Gs){Wc(s);for(const e of Object.keys(s.attributes)){const i=s.attributes[e];ft(i)}}else if(s instanceof Cn||s instanceof QC)ec&&console.warn("BufferAttribute dispose not supported",s.count);else if(s instanceof Array)for(const e of s)e instanceof Xe&&ft(e);else if(s instanceof Xe){Wc(s);for(const i of Object.keys(s)){const n=s[i];n instanceof _t&&ft(n)}const e=s.uniforms;if(e)for(const i of Object.keys(e)){const n=e[i];n instanceof _t?ft(n):n instanceof ys&&ft(n.value)}}else s instanceof _t?(Wc(s),Wc(s.source),((t=s.source)==null?void 0:t.data)instanceof ImageBitmap&&Wc(s.source.data)):s instanceof CO?(Wc(s.boneTexture),s.boneTexture=null):s instanceof PO||!(s instanceof z)&&ec&&console.warn("Unknown object type",s)}}function Wc(s){s&&((ec||FP()||Dg)&&console.warn("üß® FREE",s),s instanceof ImageBitmap||"dispose"in s&&typeof s.dispose=="function"&&s.dispose())}function T4(s){}const c2=new Set;function NP(s,t,e=null,i){if(i||(i=c2,i.clear()),!s)return i;const n=s[pf];if(n)for(const o of n)i.has(o)||(e==null?void 0:e.call(null,o))!==!1&&(i.add(o),t&&NP(o,!0,e,i));return i}function R4(s){return s[cu]}const ec=k("debugresourceusers")||k("debugmemory"),pf=Symbol("needle-resource-users"),cu=Symbol("needle-resource-users-count");function nn(s,t){$0(s,t,function(e,i){vc&&!xu.raycasting&&(Rm(pf,this,e,!1),Rm(pf,this,i,!0))})}vc&&(nn(le.prototype,"material"),nn(le.prototype,"geometry"),nn(Xe.prototype,"map"),nn(Xe.prototype,"bumpMap"),nn(Xe.prototype,"alphaMap"),nn(Xe.prototype,"normalMap"),nn(Xe.prototype,"displacementMap"),nn(Xe.prototype,"roughnessMap"),nn(Xe.prototype,"metalnessMap"),nn(Xe.prototype,"emissiveMap"),nn(Xe.prototype,"specularMap"),nn(Xe.prototype,"envMap"),nn(Xe.prototype,"lightMap"),nn(Xe.prototype,"aoMap"),nn(Xe.prototype,"gradientMap"));function h2(s){if(vc===!1)return;const t=s[pf];if(t)for(const e of t)Rm(pf,e,s,!1)}vc&&$0(Xe.prototype,"dispose",function(){h2(this)});let L_=0;function Rm(s,t,e,i){if(L_>0)return;if(Array.isArray(e)){for(const o of e)Rm(s,t,o,i);return}if(!e)return;let n=e[s];if(n||(n=new Set),i){if(t&&!n.has(t)){n.add(t);let o=e[cu]||0;o+=1,e[cu]=o,ec&&console.warn(`üü¢ Added user of "${e.type}"`,t,e,o,"users:",n)}}else if(t&&n.has(t)){n.delete(t);let o=e[cu]||0;o>0&&(o-=1,e[cu]=o),ec&&console.warn(`üî¥ Removed user of "${e.type}"`,t,e,o,"users:",n),o<=0&&(wu.isLoading(e)||(Dg&&console.warn(`üî¥ Removed all user of "${e.type}"`,e),FP()&&ft(e)))}e[s]=n}try{$0(gc.prototype,"render",function(){L_++},function(){L_--})}catch(s){console.warn("Could not wrap WebGLRenderer.render",s)}const Jw=k("debugcomponentevents");class jg{static addComponentLifecylceEventListener(t,e){this.eventListeners.has(t)&&this.eventListeners.set(t,[]);let i=this.eventListeners.get(t);i||(i=[]),i.push(e),this.eventListeners.set(t,i),Jw&&console.log("Added event listener for "+t,this.eventListeners)}static removeComponentLifecylceEventListener(t,e){const i=this.eventListeners.get(t);if(!i)return;const n=i.indexOf(e);n<0||i.splice(n,1)}static dispatchComponentLifecycleEvent(t,e){const i=this.eventListeners.get(t);if(Jw&&console.log("Dispatching event "+t,i),!!i)for(const n of i)n(e)}}a(jg,"eventListeners",new Map);const mf=Symbol("NEEDLE_NEED_UPDATE_INSTANCE"),zP=Symbol("isUsingInstancing"),$P=Symbol("instancingRenderer"),hu=Symbol("instancingAutoUpdateBounds");class Qs{static isUsingInstancing(t){return t[zP]===!0}static getRenderer(t){return t[$P]||null}setAutoUpdateBounds(t,e){const i=Qs.getRenderer(t);i&&(i[hu]=e)}static markDirty(t,e=!0){if(t&&(this.isUsingInstancing(t)&&(t[mf]=!0,t.matrixWorldNeedsUpdate=!0),e))for(const i of t.children)Qs.markDirty(i,!0)}}var Om;(function(s){s.experimentalSmartHierarchyUpdate=!1})(Om||(Om={}));function Ih(s,t){try{t?s(t):s()}catch(e){return console.error(e),!1}return!0}const D_=k("debugnewscripts"),d2=k("debughierarchy"),ht=[];function u2(){return ht.length>0}function km(s){if(D_&&console.log("Register new components",s.new_scripts.length,[...s.new_scripts],s.alias?"element: "+s.alias:s.hash,s),s.new_scripts_pre_setup_callbacks.length>0){for(const t of s.new_scripts_pre_setup_callbacks)t&&t();s.new_scripts_pre_setup_callbacks.length=0}if(!(s.new_scripts.length<=0)){ht.length=0,s.new_scripts.length>0&&ht.push(...s.new_scripts),s.new_scripts.length=0;for(let t=0;t<ht.length;t++)try{const e=ht[t];if(e.isComponent!==!0){(X()||D_)&&console.error(`Registered script is not a Needle Engine component. 
The script will be ignored. Please make sure your component extends "Behaviour" imported from "@needle-tools/engine"
`,e),ht.splice(t,1),t--;continue}if(e.destroyed)continue;if(!e.gameObject){console.warn(`Component can not be initialized: no GameObject assigned.
Did you add and remove a component in the same frame?`),ht.splice(t,1),t--;continue}e.context=s,Su(e.gameObject),J0(e,s)}catch(e){console.error(e),Tr(ht[t],s),ht.splice(t,1),t--}for(let t=0;t<ht.length;t++)try{const e=ht[t];if(e.destroyed){Tr(ht[t],s),ht.splice(t,1),t--;continue}if(e.registering)try{e.registering()}catch(i){console.error(i)}e.__internalAwake!==void 0&&(e.gameObject||console.error("Calling awake for a component without a GameObject",e,e.gameObject),Su(e.gameObject),e.activeAndEnabled&&Ih(e.__internalAwake.bind(e)))}catch(e){console.error(e),Tr(ht[t],s),ht.splice(t,1),t--}for(let t=0;t<ht.length;t++)try{const e=ht[t];if(e.destroyed||e.enabled===!1||(Su(e.gameObject),e.activeAndEnabled===!1))continue;e.__internalEnable!==void 0&&(e.enabled=!0,Ih(e.__internalEnable.bind(e)))}catch(e){console.error(e),Tr(ht[t],s),ht.splice(t,1),t--}for(let t=0;t<ht.length;t++)try{const e=ht[t];if(e.destroyed||!e.gameObject)continue;s.new_script_start.push(e)}catch(e){console.error(e),Tr(ht[t],s),ht.splice(t,1),t--}ht.length=0;for(const t of s.new_scripts_post_setup_callbacks)t&&t();s.new_scripts_post_setup_callbacks.length=0}}function f2(s){s&&(s.__internalDisable(!0),Tr(s,s.context))}function VP(s,t){for(let e=0;e<s.new_script_start.length;e++)try{const i=s.new_script_start[e];if(t!==void 0&&i.gameObject!==t||i.destroyed||i.activeAndEnabled===!1)continue;Ih(i.__internalAwake.bind(i)),i.enabled&&(Ih(i.__internalEnable.bind(i)),Ih(i.__internalStart.bind(i)),s.new_script_start.splice(e,1),e--)}catch(i){console.error(i),Tr(s.new_script_start[e],s),s.new_script_start.splice(e,1),e--}}function J0(s,t){t.scripts.indexOf(s)===-1&&(t.scripts.push(s),s.earlyUpdate&&t.scripts_earlyUpdate.push(s),s.update&&t.scripts_update.push(s),s.lateUpdate&&t.scripts_lateUpdate.push(s),s.onBeforeRender&&t.scripts_onBeforeRender.push(s),s.onAfterRender&&t.scripts_onAfterRender.push(s),s.onPausedChanged&&t.scripts_pausedChanged.push(s),rb(s,null)&&t.new_scripts_xr.push(s),rb(s,"immersive-vr")&&t.scripts_immersive_vr.push(s),rb(s,"immersive-ar")&&t.scripts_immersive_ar.push(s))}function Tr(s,t){as(s,t.new_scripts),as(s,t.new_script_start),as(s,t.scripts),as(s,t.scripts_earlyUpdate),as(s,t.scripts_update),as(s,t.scripts_lateUpdate),as(s,t.scripts_onBeforeRender),as(s,t.scripts_onAfterRender),as(s,t.scripts_pausedChanged),as(s,t.new_scripts_xr),as(s,t.scripts_immersive_vr),as(s,t.scripts_immersive_ar),t.stopAllCoroutinesFrom(s)}function as(s,t){const e=t.indexOf(s);e>=0&&t.splice(e,1)}function rb(s,t){var e;if(s){const i=s;if(i.onBeforeXR||i.onEnterXR||i.onUpdateXR||i.onLeaveXR||i.onXRControllerAdded||i.onXRControllerRemoved)return!(t!=null&&((e=i.supportsXR)==null?void 0:e.call(i,t))===!1)}return!1}let j_=!0;function ab(){j_=!0}function im(s,t=!1){if(Om.experimentalSmartHierarchyUpdate){if(!t&&!j_)return;j_=!1}if(s||(s=Be.Current.scene),!s){console.trace("Invalid call - no current context.");return}const e=Mf(s);WP(s,e,!0)||(D_||X()?console.error(`Error updating hierarchy
Do you have circular references in your project? <a target="_blank" href="https://docs.needle.tools/circular-reference"> Click here for more information.`,s):console.error('Failed to update active state in hierarchy of "'+s.name+'"',s),console.warn(" ‚Üë this error might be caused by circular references. Please make sure you don't have files with circular references (e.g. one GLB 1 is loading GLB 2 which is then loading GLB 1 again)."))}function WP(s,t,e,i=0){if(i>1e3)return console.warn("Hierarchy is too deep (> 1000 level) - will abort updating active state"),!1;const n=Mf(s);if(t&&(t=n,t&&s.parent&&i===0)){const c=s.parent;t=c[Da],t===void 0&&(c instanceof Xn||(t=!0))}const r=s[Da]!==t;r&&(s[Da]=t,d2&&console.warn("ACTIVE CHANGE",s.name,n,s.visible,t,"changed?"+r,s),e&&p2(s,c=>{t?c.enabled&&(Ih(c.__internalAwake.bind(c)),c.enabled&&c.__internalEnable()):c.__didAwake&&c.enabled&&(c.__didEnable=!1,c.onDisable())}));let l=!0;if(s.children)for(const c of s.children)WP(c,t,e,i+1)===!1&&(l=!1);return l}function Su(s){let t=!0,e=s,i=!1;for(;e&&e;){if(e.type==="Scene"&&(i=!0),!Mf(e)){t=!1;break}e=e.parent}if(!s){console.error("GO is null");return}s[Da]=t&&i}function p2(s,t){var e;if((e=s.userData)!=null&&e.components)for(const i of s.userData.components)t(i)}const nm=new Map,HP=Symbol("prewarmFlag"),F_=Symbol("waitingForPrewarm"),B_=k("debugprewarm");function m2(s,t){if(!s||s[HP]===!0||s[F_]===!0)return;nm.has(t)||nm.set(t,[]),s[F_]=!0,nm.get(t).push(s),B_&&console.debug("register prewarm",s.name)}let eS=null,tS=null;function g2(s){if(!s)return;const t=nm.get(s);if(!(t!=null&&t.length))return;const e=s.mainCamera;if(e){B_&&console.log("prewarm",t.length,"objects",[...t]);const i=s.renderer;if(i.compile){const n=s.scene;i.compile(n,e),eS??(eS=new TO(64)),tS??(tS=new RO(.001,9999999,eS)),tS.update(i,n);for(const o of t)o[HP]=!0,o[F_]=!1;t.length=0,B_&&console.log("prewarm done")}}}const y2=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function b2(s){return typeof s=="string"&&y2.test(s)}const vi=[];for(let s=0;s<256;++s)vi.push((s+256).toString(16).slice(1));function _2(s,t=0){return vi[s[t+0]]+vi[s[t+1]]+vi[s[t+2]]+vi[s[t+3]]+"-"+vi[s[t+4]]+vi[s[t+5]]+"-"+vi[s[t+6]]+vi[s[t+7]]+"-"+vi[s[t+8]]+vi[s[t+9]]+"-"+vi[s[t+10]]+vi[s[t+11]]+vi[s[t+12]]+vi[s[t+13]]+vi[s[t+14]]+vi[s[t+15]]}function v2(s){if(!b2(s))throw TypeError("Invalid UUID");let t;const e=new Uint8Array(16);return e[0]=(t=parseInt(s.slice(0,8),16))>>>24,e[1]=t>>>16&255,e[2]=t>>>8&255,e[3]=t&255,e[4]=(t=parseInt(s.slice(9,13),16))>>>8,e[5]=t&255,e[6]=(t=parseInt(s.slice(14,18),16))>>>8,e[7]=t&255,e[8]=(t=parseInt(s.slice(19,23),16))>>>8,e[9]=t&255,e[10]=(t=parseInt(s.slice(24,36),16))/1099511627776&255,e[11]=t/4294967296&255,e[12]=t>>>24&255,e[13]=t>>>16&255,e[14]=t>>>8&255,e[15]=t&255,e}function x2(s){s=unescape(encodeURIComponent(s));const t=[];for(let e=0;e<s.length;++e)t.push(s.charCodeAt(e));return t}const w2="6ba7b810-9dad-11d1-80b4-00c04fd430c8",S2="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function C2(s,t,e){function i(n,o,r,l){var c;if(typeof n=="string"&&(n=x2(n)),typeof o=="string"&&(o=v2(o)),((c=o)===null||c===void 0?void 0:c.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let h=new Uint8Array(16+n.length);if(h.set(o),h.set(n,o.length),h=e(h),h[6]=h[6]&15|t,h[8]=h[8]&63|128,r){l=l||0;for(let d=0;d<16;++d)r[l+d]=h[d];return r}return _2(h)}try{i.name=s}catch{}return i.DNS=w2,i.URL=S2,i}function P2(s,t,e,i){switch(s){case 0:return t&e^~t&i;case 1:return t^e^i;case 2:return t&e^t&i^e&i;case 3:return t^e^i}}function lb(s,t){return s<<t|s>>>32-t}function T2(s){const t=[1518500249,1859775393,2400959708,3395469782],e=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof s=="string"){const r=unescape(encodeURIComponent(s));s=[];for(let l=0;l<r.length;++l)s.push(r.charCodeAt(l))}else Array.isArray(s)||(s=Array.prototype.slice.call(s));s.push(128);const i=s.length/4+2,n=Math.ceil(i/16),o=new Array(n);for(let r=0;r<n;++r){const l=new Uint32Array(16);for(let c=0;c<16;++c)l[c]=s[r*64+c*4]<<24|s[r*64+c*4+1]<<16|s[r*64+c*4+2]<<8|s[r*64+c*4+3];o[r]=l}o[n-1][14]=(s.length-1)*8/Math.pow(2,32),o[n-1][14]=Math.floor(o[n-1][14]),o[n-1][15]=(s.length-1)*8&4294967295;for(let r=0;r<n;++r){const l=new Uint32Array(80);for(let p=0;p<16;++p)l[p]=o[r][p];for(let p=16;p<80;++p)l[p]=lb(l[p-3]^l[p-8]^l[p-14]^l[p-16],1);let c=e[0],h=e[1],d=e[2],u=e[3],f=e[4];for(let p=0;p<80;++p){const b=Math.floor(p/20),x=lb(c,5)+P2(b,h,d,u)+f+t[b]+l[p]>>>0;f=u,u=d,d=lb(h,30)>>>0,h=c,c=x}e[0]=e[0]+c>>>0,e[1]=e[1]+h>>>0,e[2]=e[2]+d>>>0,e[3]=e[3]+u>>>0,e[4]=e[4]+f>>>0}return[e[0]>>24&255,e[0]>>16&255,e[0]>>8&255,e[0]&255,e[1]>>24&255,e[1]>>16&255,e[1]>>8&255,e[1]&255,e[2]>>24&255,e[2]>>16&255,e[2]>>8&255,e[2]&255,e[3]>>24&255,e[3]>>16&255,e[3]>>8&255,e[3]&255,e[4]>>24&255,e[4]>>16&255,e[4]>>8&255,e[4]&255]}const R2=C2("v5",80,T2),iS=R2;Be.registerCallback(Me.ContextCreated,s=>{const t=s.context;A2(t),k2(t)});const Em=k("debugcomponents"),nS="eff8ba80-635d-11ec-90d6-0242ac120003";class Ki{constructor(t){a(this,"_originalSeed");a(this,"_seed");typeof t=="string"&&(t=Ki.hash(t)),this._originalSeed=t,this._seed=t}get seed(){return this._seed}set seed(t){this._seed=t}reset(){this._seed=this._originalSeed}generateUUID(t){if(typeof t=="string")return iS(t,nS);const e=this._seed;return this._seed-=1,iS(e.toString(),nS)}initialize(t){typeof t=="string"?this._seed=Ki.hash(t):this._seed=t}static createFromString(t){return new Ki(this.hash(t))}static hash(t){let e=0;for(let i=0;i<t.length;i++)e=t.charCodeAt(i)+((e<<5)-e);return e}}var Jh;(function(s){s.NewInstanceCreated="new-instance-created",s.InstanceDestroyed="instance-destroyed"})(Jh||(Jh={}));class O2{constructor(t){a(this,"guid");a(this,"dontSave");this.guid=t}}function Fg(s,t,e=!0,i){if(!s)return;const n=s;if(xs(s,e),!t){console.warn("Can not send destroy: No networking connection provided",s.guid);return}if(!t.isConnected){X()&&console.debug("Can not send destroy: not connected",s.guid);return}let o=s.guid;if(!o&&n.uuid&&(o=n.uuid),!o){console.warn("Can not send destroy: failed to find guid",s);return}GP(o,t,i)}function GP(s,t,e){const i=new O2(s);(e==null?void 0:e.saveInRoom)===!1&&(i.dontSave=!0),t.send(Jh.InstanceDestroyed,i,Ns.Queued)}function k2(s){s.connection.beginListen(Jh.InstanceDestroyed,t=>{Em&&console.log("[Remote] Destroyed",s.scene,t);const e=oT(t.guid,s.scene);e&&xs(e)})}class O4{constructor(t,e,i){a(this,"filename");a(this,"hash");a(this,"size");this.filename=t,this.hash=e,this.size=i}}class E2{constructor(t,e){a(this,"guid");a(this,"originalGuid");a(this,"seed");a(this,"visible");a(this,"hostData");a(this,"dontSave");a(this,"parent");a(this,"position");a(this,"rotation");a(this,"scale");a(this,"preventCreation");a(this,"deleteStateOnDisconnect");this.originalGuid=t,this.guid=e}}function qP(s,t,e,i){var c,h;const n=s;if(!n.guid)return console.warn("Can not instantiate: No guid",n),null;if(t.context||(t.context=de.Current),!t.context)return console.error("Missing network instantiate options / reference to network connection in sync instantiate"),null;const o=t?{...t}:null,{instance:r,seed:l}=I2(n,t);if(r){const d=r;if(d.guid){Em&&console.log("[Local] new instance","gameobject:",r==null?void 0:r.guid);const u=new E2(n.guid,d.guid);u.seed=l,t.deleteOnDisconnect===!0&&(u.deleteStateOnDisconnect=!0),o&&(o.position&&(Array.isArray(o.position)?u.position={x:o.position[0],y:o.position[1],z:o.position[2]}:u.position={x:o.position.x,y:o.position.y,z:o.position.z}),o.rotation&&(o.rotation instanceof Ht?o.rotation=new re().setFromEuler(o.rotation):o.rotation instanceof Array&&(o.rotation=new re().fromArray(o.rotation)),u.rotation={x:o.rotation.x,y:o.rotation.y,z:o.rotation.z,w:o.rotation.w}),o.scale&&(Array.isArray(o.scale)?u.scale={x:o.scale[0],y:o.scale[1],z:o.scale[2]}:u.scale={x:o.scale.x,y:o.scale.y,z:o.scale.z})),u.position||(u.position={x:d.position.x,y:d.position.y,z:d.position.z}),u.rotation||(u.rotation={x:d.quaternion.x,y:d.quaternion.y,z:d.quaternion.z,w:d.quaternion.w}),u.scale||(u.scale={x:d.scale.x,y:d.scale.y,z:d.scale.z}),u.visible=n.visible,o!=null&&o.parent&&(typeof o.parent=="string"?u.parent=o.parent:u.parent=o.parent.guid),u.hostData=e,i===!1&&(u.dontSave=!0),!((c=t==null?void 0:t.context)==null?void 0:c.connection)&&X()&&console.debug("Object will be instantiated but it will not be synced: not connected",n.guid),t.context.connection.isInRoom&&nh.push(new WeakRef(d)),(h=t==null?void 0:t.context)==null||h.connection.send(Jh.NewInstanceCreated,u)}else console.warn("Missing guid, can not send new instance event",d)}return r}function M2(){return Math.random()*9999999}const nh=new Array;function A2(s){s.connection.beginListen(Jh.NewInstanceCreated,async t=>{const e=await D2(t.originalGuid,s.scene);if(t.preventCreation===!0)return;if(!e){console.warn("could not find object that was instantiated: "+t.guid);return}const i=new er;t.position&&(i.position=new R(t.position.x,t.position.y,t.position.z)),t.rotation&&(i.rotation=new re(t.rotation.x,t.rotation.y,t.rotation.z,t.rotation.w)),t.scale&&(i.scale=new R(t.scale.x,t.scale.y,t.scale.z)),i.parent=t.parent,t.seed&&(i.idProvider=new Ki(t.seed)),i.visible=t.visible,i.context=s,Em&&s.alias&&console.log("[Remote] instantiate in: "+s.alias);const n=cc(e,i);nh.push(new WeakRef(n)),n&&(t.parent==="scene"&&s.scene.add(n),Em&&console.log("[Remote] new instance","gameobject:",n==null?void 0:n.guid,e))}),s.connection.beginListen("left-room",()=>{nh.length>0&&console.debug(`Left networking room, cleaning up ${nh.length} instantiated objects`);for(const t of nh){const e=t.deref();e&&e.destroy()}nh.length=0})}function I2(s,t){const e=M2(),i=t??new er;i.idProvider=new Ki(e);const n=cc(s,i);return{seed:e,instance:n}}const XP={};function L2(s,t){XP[s]=t}async function D2(s,t){const e=XP[s];if(e!=null){const i=await e(s);if(i)return i}return QP(s,t)}function QP(s,t){if(t===null||!s)return null;if(t.guid===s)return t;if(t.children)for(const e of t.children){const i=QP(s,e);if(i)return i}return null}const Of=k("gizmos"),ii=k("debugextension"),cb=k("debugtypes");class j2{constructor(){a(this,"_types",new Map);a(this,"_reverseTypes",new Map);cb&&console.warn("TypeStore: Created",this)}add(t,e){cb&&console.warn("ADD TYPE",t);const i=this._types.get(t);i?cb&&i!==e&&console.warn("Type name exists multiple times in your project and may lead to runtime errors:",t):(this._types.set(t,e),this._reverseTypes.set(e,t))}get(t){return this._types.get(t)||null}getKey(t){return this._reverseTypes.get(t)||null}}const F2=Symbol("BuiltInType"),j=new j2,YP=function(s){j.get(s.name)||j.add(s.name,s)},ev=k("debugresolvedependencies"),B2=["/extensions/","extensions/"],U2=[{prefix:"/nodes/",dependencyName:"node"},{prefix:"/meshes/",dependencyName:"mesh"},{prefix:"/materials/",dependencyName:"material"},{prefix:"/textures/",dependencyName:"texture"},{prefix:"/animations/",dependencyName:"animation"},{prefix:"nodes/",dependencyName:"node"},{prefix:"meshes/",dependencyName:"mesh"},{prefix:"materials/",dependencyName:"material"},{prefix:"textures/",dependencyName:"texture"},{prefix:"animations/",dependencyName:"animation"}];async function tv(s,t){ev&&console.log(s,t);const e=[];U_(U2,s,t,e);const i=await Promise.all(e);return typeof t=="string"&&i.length===1?i[0]:i}function N2(s,t){return!s||!t?!1:s["needle:identifier"]!=null&&t["needle:identifier"]!=null?s["needle:identifier"]===t["needle:identifier"]:!1}function z2(s,t){s["needle:identifier"]=t}function U_(s,t,e,i){if(typeof e=="object"&&e!==void 0&&e!==null)for(const n of Object.keys(e)){const o=e[n];if(typeof o=="string"){const r=sS(t,o);if(r!=null)typeof r.then=="function"?i.push(r.then(l=>e[n]=l)):e[n]=r;else{const l=oS(s,t,o);if(l){i.push(l.then(c=>(e[n]=c,c)));continue}}}else if(Array.isArray(o))for(let r=0;r<o.length;r++){const l=o[r],c=sS(t,l);if(c!=null){typeof c.then=="function"?i.push(c.then(h=>o[r]=h)):o[r]=c;continue}for(const h of s){const d=KP(h.prefix,l);if(d>=0){ev&&console.log(h,d,h.dependencyName),i.push(t.getDependency(h.dependencyName,d).then(u=>o[r]=u));break}}typeof l=="object"&&U_(s,t,l,i)}else typeof o=="object"&&U_(s,t,o,i)}else if(typeof e=="string"){const n=oS(s,t,e);n&&i.push(n)}}function sS(s,t){if(s&&s.plugins&&typeof t=="string"){for(const e of B2)if(t.startsWith(e)){let i=t.substring(e.length);const n=i.indexOf("/");n>=0&&(i=i.substring(0,n));const o=s.plugins[i];if(ii&&console.log(i,o),typeof(o==null?void 0:o.resolve)=="function"){const r=t.substring(e.length+i.length+1);return o.resolve(s,r)}break}}return null}function oS(s,t,e){for(const i of s){const n=KP(i.prefix,e);if(n>=0)return ev&&console.warn("GET DEPENDENCY",i,n,i.dependencyName),t.getDependency(i.dependencyName,n)}return null}function KP(s,t){if(typeof t=="string"&&t.startsWith(s)){const e=t.substring(s.length),i=Number.parseInt(e);if(i>=0)return i}return-1}const hb="NEEDLE_persistent_assets";function $2(s){return(s==null?void 0:s.___persistentAsset)===!0}class V2{constructor(t){a(this,"parser");this.parser=t}get name(){return hb}async afterRoot(t){var n,o;if(!((o=(n=this.parser)==null?void 0:n.json)!=null&&o.extensions))return;const e=this.parser.json.extensions[hb];if(!e)return;ii&&console.log(e);const i=new Array;for(const r of e==null?void 0:e.assets){const l=tv(this.parser,r);l&&i.push(l)}await Promise.all(i)}resolve(t,e){const i=Number.parseInt(e);if(i>=0){ii&&console.log(e);const n=t.json.extensions[hb];if(n){const o=n==null?void 0:n.assets[i];if(o&&typeof o=="object"){o.___persistentAsset=!0;const r=o.__type;r&&j.get(r)}return o}}return null}}const ko=k("debugserializer");class W2{constructor(){a(this,"typeMap",new Map)}register(t,e){if(this.typeMap.has(t)){const i=this.typeMap.get(t);if(i===e)return;ko&&console.warn("Type: "+t+" is already registered",e,i)}ko&&console.log("Register type serializer",e.name,e,t),this.typeMap.set(t,e)}getSerializer(t){if(t)return this.typeMap.get(t)}getSerializerForConstructor(t,e=0){if(e>20)return;if(!t||!t.constructor){ko&&console.log("invalid type");return}const i=t.name,n=this.getSerializer(t);if(n!==void 0)return ko&&console.log("FOUND SERIALIZER",n==null?void 0:n.name,t.name,t.constructor.name,"for type: "+i,n,t,this.typeMap),n;const o=Object.getPrototypeOf(t);if(o&&o!==t){const r=this.getSerializerForConstructor(o,++e);if(r){const l=o.constructor||o.prototype;ko&&console.log("FOUND SERIALIZER(in constructor) "+l.constructor.name,l.name,l,r),this.register(l,r)}return r}ko&&console.warn("No serializer found for "+i,t,t.name,t.constructor.name)}}const Mm=new W2;class Ps{constructor(t,e){a(this,"name");if(this.name=e,Array.isArray(t))for(const i of t)Mm.register(i,this);else Mm.register(t,this)}}class H2{constructor(){a(this,"isDevMode",_s());a(this,"cache",{})}registerDefinedKeys(t,e){if(this.isDevMode&&this.cache[t]===void 0){this.cache[t]=Object.keys(e);const i=e;i.$serializedTypes&&Object.keys(i.$serializedTypes)&&this.cache[t].push(...Object.keys(i.$serializedTypes)),ko&&console.log("registerDefinedKeys for "+t,this.cache[t],e)}}getDefinedKey(t,e){return this.cache[t]===void 0?!1:this.cache[t].includes(e)}}class ZP{constructor(t){a(this,"root");a(this,"gltf");a(this,"gltfId");a(this,"object");a(this,"target");a(this,"nodeId");a(this,"nodeToObject");a(this,"objectToNode");a(this,"context");a(this,"path");a(this,"type");a(this,"serializable");a(this,"implementationInformation");this.root=t}}function G2(s,t){const e=s.$serializedTypes;if(e===void 0)return null;const i={};for(const o in e){const r=s[o];if(r!=null&&typeof r=="object"){const l=Mm.getSerializerForConstructor(r);if(l){i[o]=l.onSerialize(r,t);continue}}i[o]=r}function n(o){const r=j._types;for(const[l,c]of r)if(c===s.constructor)return l;return o.__name||o.constructor.name}return i.name=n(s),typeof s.guid=="string"&&(i.guid=s.guid),i}const sm=[];function JP(s,t){if(!s)return t;typeof s.$serializedTypes=="object"&&(t||(t={}),Object.assign(t,s.$serializedTypes));const e=Object.getPrototypeOf(s);return JP(e,t)}function N_(s,t,e){if(!s)return!1;if(e.target=s,s.onBeforeDeserialize!==void 0){const n=s.onBeforeDeserialize(t,e);if(typeof n=="boolean")return n}const i=JP(s);if(t){if(typeof t.guid=="string"&&(s.guid=t.guid),i)for(const n in i){let l=function(c){const d=c.type;return d?z_(r,d,e,void 0,s[n]):z_(r,c,e,void 0,s[n])};const o=i[n],r=t[n];if(ko&&console.log(n,r,s,o),!(s[n]!==void 0&&r===void 0)&&(e.type=void 0,e.path=n,e.serializable=o,!(s.onBeforeDeserializeMember!==void 0&&s.onBeforeDeserializeMember(n,r,e)===!0))){if(o===null)s[n]=r;else{if(Array.isArray(o))for(let c=0;c<o.length;c++){const h=o[c],d=l(h);if(d!==void 0||c===o.length-1){s[n]=d;break}}else s[n]=l(o);sm.length=0}s.onAfterDeserializeMember!==void 0&&s.onAfterDeserializeMember(n,r,e)}}Q2(s,t)}return X2(s,t,e.implementationInformation),s.onAfterDeserialize!==void 0&&s.onAfterDeserialize(t,e),!0}const q2=k("noerrors");function X2(s,t,e){var o,r;if(q2||!t||!_s()||!s||s.constructor&&s.constructor[F2]===!0)return;const i=(o=s.constructor)==null?void 0:o.name,n=Object.getOwnPropertyNames(t);for(const l of n){if(l==="sourceId")continue;const c=s[l];if(c==null)continue;const h=t[l];if((e==null?void 0:e.getDefinedKey(i,l))===!1){const d=l.charAt(0).toUpperCase()+l.slice(1);e.getDefinedKey(i,d)&&(Vl(Ti.Warn,'<strong>Please rename</strong> "'+d+'" to "'+l+'" in '+i),console.warn('Please use lowercase for field: "'+d+'" in '+i,h,s));continue}if(h!=null){if(typeof h=="object"&&(c===void 0||!c.isObject3D)){if(typeof h.node=="number"||typeof h.guid=="string"){if(h.could_not_resolve)continue;if(!(c!==void 0&&Object.keys(c).length>1)){Vl(Ti.Warn,`<strong>Missing serialization for object reference!</strong>

Please change to: 
@serializable(Object3D)
${l}? : Object3D;

in ${i}.ts
<a href="https://docs.needle.tools/serializable" target="_blank">See documentation</a>`),console.warn(i,l,s[l],s);continue}}else if(!Array.isArray(c)){const d=(r=c.constructor)==null?void 0:r.name;if(d==="Object"&&!c.constructor["did_warn:missing_serializable"]){c.constructor["did_warn:missing_serializable"]=!0;const u='You might be missing a @serializable(Type) decorator for field "'+l+'" in '+i+".ts";console.warn(u+`
${l}:`,h,d),Vl(Ti.Warn,"Dev Warning: Are you missing a type in @serializable? Please check the browser console for details")}}}if(typeof c=="string"&&typeof h=="string"&&(h.endsWith(".gltf")||h.endsWith(".glb"))){Vl(Ti.Warn,`<strong>Missing serialization for object reference!</strong>

Please change to: 
@serializable(AssetReference)
${l}? : AssetReference;

in script ${i}.ts
<a href="https://docs.needle.tools/serializable" target="_blank">documentation</a>`),console.warn(i,l,s[l],s);continue}}}}function Q2(s,t){for(const e of Object.keys(t)){const i=t[e];if(typeof i=="object"&&i!==null&&i!==void 0){const n=s[e];if(!n){ko&&console.log(e,"is undefined on",s);continue}for(const o of Object.keys(i))if(n[o]===void 0&&rS(i[o])&&!rS(n)){const l=Y2(n,o);if(l&&((l==null?void 0:l.writable)===void 0||(l==null?void 0:l.writable)===!1)&&l.set===void 0){ko&&console.warn('Property is not writable "'+o+'"',n,l,i[o],n[o]);continue}n[o]=i[o]}}}}function Y2(s,t){for(;s;){const e=Object.getOwnPropertyDescriptor(s,t);if(e)return e;s=Object.getPrototypeOf(s)}}function rS(s){switch(typeof s){case"number":case"string":case"boolean":return!0}return!1}function z_(s,t,e,i,n){let o=typeof t=="function"&&t.prototype===void 0,r=t;if(o)try{if(r=t==null?void 0:t.call(t,n),o=!1,r==null)return}catch(d){console.error("Error in callback",d,s)}if(e.type=r,!o&&n&&(n instanceof Xe||n instanceof le||n instanceof Gs||n instanceof Hn))return n;if(i||(i={serializer:Mm.getSerializerForConstructor(r)}),n&&typeof n=="object"&&$2(n)){if(n.__concreteInstance)return n.__concreteInstance;const d=n;if(!d.$serializedTypes&&r.prototype.$serializedTypes&&(d.$serializedTypes=r.prototype.$serializedTypes),d.$serializedTypes&&N_(d,s,e),n&&r!==void 0)try{let u=null;i.serializer&&(u=i.serializer.onDeserialize(s,e)),u||(u=new r,ii&&console.log("Create concrete instance for persistent asset",n,"instance:",u),ed(u,n)),n.__concreteInstance=u,n=u}catch(u){console.error("Error creating instance or creating values on instance",u,n,r)}return n}if(Array.isArray(s)){const d=[];for(let u=0;u<s.length;u++){const f=s[u],p=z_(f,t,e,i,f);d.push(p)}return d}const l=i==null?void 0:i.serializer;if(l)return l.onDeserialize(s,e);if(n instanceof _t)return n;let c;if(s&&(s.isMaterial||s.isTexture||s.isObject3D||s instanceof Hn))c=s;else{if(s===void 0)return;if(s===null&&(r===Xe||r===_t||r===le||r===Hn))return null;try{c=new r(...K2(s))}catch(d){console.error("Error creating "+e.path,e.target,d);return}}const h=c;return h.$serializedTypes&&N_(h,s,e),c}function K2(s){if(sm.length=0,typeof s=="object"&&s!==null&&s!==void 0)for(const t of Object.keys(s))sm.push(s[t]);return sm}const $_=Symbol("assigned component properties");function ed(s,t,e,i){var o;if(t==null||s==null)return;s[$_]=!0;const n=((o=s.constructor)==null?void 0:o.name)??"unknown";e==null||e.registerDefinedKeys(n,s);for(const r of Object.keys(t)){const l=Z2(s,r);if(typeof(l==null?void 0:l.value)!="function"&&(!l||l.writable===!0||l.set!==void 0)){const c=t[r],h=s[r];s[r]=c,i!=null&&i.onAssigned&&i.onAssigned(s,r,h,c)}}delete s[$_]}function Z2(s,t){let e;do e=Object.getOwnPropertyDescriptor(s,t);while(!e&&(s=Object.getPrototypeOf(s)));return e}const eT=Symbol("customVisibilityFlag");function Rr(s,t){s.layers[eT]=t}const aS=Symbol("DidPatchLayers");function J2(){const s=Va.prototype;if(s[aS])return;s[aS]=!0;const t=s.test;s.test=function(e){return this[eT]===!1?!1:t.call(this,e)}}J2();Object.defineProperty(Ae.prototype,"fov",{get:function(){return this._fov},set:function(s){const t=s!==this._fov;this._fov=s,t&&this.view!==void 0&&this.updateProjectionMatrix()},configurable:!0});Object.defineProperty(Ae.prototype,"near",{get:function(){return this._near},set:function(s){const t=s!==this._near;this._near=s,t&&this.view!==void 0&&this.updateProjectionMatrix()},configurable:!0});Object.defineProperty(Ae.prototype,"far",{get:function(){return this._far},set:function(s){const t=s!==this._far;this._far=s,t&&this.view!==void 0&&this.updateProjectionMatrix()},configurable:!0});const tT=new Map;function eI(s,t){if(!s)return;if(!t){console.warn("No prototype found",s,s.prototype,s.constructor);return}const e=tT.get(t);e&&e.apply(s)}function tI(s){const t=iI(s.prototype);tT.set(s,t)}function iI(s){return new nI(s)}class nI{constructor(t){a(this,"$symbol");a(this,"extensions");a(this,"descriptors");this.$symbol=Symbol("prototype-extension"),this.extensions=Object.keys(t),this.descriptors=new Array;for(let e=0;e<this.extensions.length;e++){const i=this.extensions[e],n=Object.getOwnPropertyDescriptor(t,i);n&&this.descriptors.push(n)}}apply(t){if(!t[this.$symbol]){t[this.$symbol]=!0;for(let e=0;e<this.extensions.length;e++){const i=this.extensions[e],n=this.descriptors[e];n&&Object.defineProperty(t,i,n)}}}}const sI=k("debuggetcomponent"),lS=()=>sI||globalThis.NEEDLE_DEBUG_GETCOMPONENT===!0;function oI(s){return s==null||s.isObject3D?s:s.object&&s.object.isObject3D?s.object:s}function iT(s,t){if(!s||!s.userData.components)return t;const e=s.userData.components.indexOf(t);return e<0||(jg.dispatchComponentLifecycleEvent("removing-component",t),t.gameObject=null,s.userData.components.splice(e,1)),t}function Bg(s,t,e){const i=ld(s,t);return i||Wo(s,t,e)}const nT=new Ki("addComponentIdProvider");function Lh(s,t,e=!0){s.userData||(s.userData={}),s.userData.components||(s.userData.components=[]),s.userData.components.push(t),t.gameObject=s,(t.guid===void 0||t.guid==="invalid")&&(t.guid=nT.generateUUID()),nv(s),lv(t,t.context);try{e&&t.__internalAwake&&(Su(s),t.activeAndEnabled&&t.__internalAwake()),jg.dispatchComponentLifecycleEvent("component-added",t)}catch(i){console.error(i)}return t}function Wo(s,t,e,i){var n;if(typeof t=="function"){const o=new t;e&&o.__internalNewInstanceCreated(e);let r=!0;return(i==null?void 0:i.callAwake)!=null&&(r=i.callAwake),Lh(s,o,r)}if(t.destroyed)return console.warn("Can not move/add a destroyed component",t),t;if(t.gameObject===s)return t;if(t.gameObject&&((n=t.gameObject.userData)!=null&&n.components)){const o=t.gameObject.userData.components.indexOf(t);t.gameObject.userData.components.splice(o,1)}if(s.userData||(s.userData={}),!s.userData.components)s.userData.components=[];else if(s.userData.components.includes(t))return t;return s.userData.components.push(t),t.gameObject=s,(t.guid===void 0||t.guid==="invalid")&&(t.guid=nT.generateUUID()),e&&t._internalInit(e),lv(t,t.context),t}function rI(s){if(s.gameObject&&s.gameObject.userData.components){const t=s.gameObject.userData.components.indexOf(s);s.gameObject.userData.components.splice(t,1)}s.__internalDisable&&s.__internalDisable(),Tr(s,s.context??de.Current),s.destroy(),s.gameObject=null}let cS=!1;function sT(s,t,e){var i;if(s==null)return null;if(!s.isObject3D)return console.error("Object is not object3D"),null;if(!((i=s==null?void 0:s.userData)!=null&&i.components)||(typeof t=="string"&&(cS||(cS=!0,console.warn(`Accessing components by name is not supported.
Please use the component type instead. This may keep working in local development but it will fail when bundling your application.

You can import other modules your main module to get access to types
or if you use npmdefs you can make types available globally using globalThis:
https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/globalThis`,t))),lS()&&console.log("[onGetComponent] FIND",t),t==null))return null;for(let n=0;n<s.userData.components.length;n++){const o=s.userData.components[n];let r=Object.getPrototypeOf(o);for(;r;){if(r===t.prototype)if(lS()&&console.log("[onGetComponent] MATCH BY PROTOYPE",r),e)e.push(o);else return o;r=Object.getPrototypeOf(r)}}return e||null}function ld(s,t){const e=sT(s,t);return e?Array.isArray(e)?e[0]:e:null}function Ug(s,t,e,i=!0){return e||(e=[]),i&&(e.length=0),sT(s,t,e),e}function Ng(s,t,e=!1){var n;if(e===!1&&s[Da]===!1)return null;const i=ld(s,t);if(e===!1&&((i==null?void 0:i.enabled)===!1||(i==null?void 0:i.activeAndEnabled)===!1))return null;if(i)return i;for(let o=0;o<((n=s==null?void 0:s.children)==null?void 0:n.length);o++){const r=Ng(s.children[o],t,e);if(r)return r}return null}function kf(s,t,e,i=!0){var n;e||(e=[]),i&&(e.length=0),Ug(s,t,e,!1);for(let o=0;o<((n=s==null?void 0:s.children)==null?void 0:n.length);o++)kf(s.children[o],t,e,!1);return e}function Am(s,t,e=!1){if(!s)return null;if(Array.isArray(s)){for(let n=0;n<s.length;n++){const o=oI(s[n]),r=Am(o,t,e);if(r)return r}return null}const i=ld(s,t);return i||(s.parent?Am(s.parent,t,e):null)}function iv(s,t,e,i=!0){return e||(e=[]),i&&(e.length=0),s?(Ug(s,t,e,!1),s.parent?iv(s.parent,t,e,!1):e):e}function Ef(s,t=void 0,e=!0){if(!s)return null;if(!t&&(t=de.Current,!t))return console.error("Can not search object without any needle context or scene!!!"),null;let i=t;if(i.isScene||(i=t==null?void 0:t.scene),!i)return null;const n=Ng(i,s,e);return n||null}function aI(s,t,e=void 0){if(!s)return t??[];if(t||(t=[]),t.length=0,!e&&(e=de.Current,!e))return console.error("Can not search object without any needle context or scene!!!"),t;"scene"in e&&(e=e.scene);const i=e;return i&&kf(i,s,t,!1),t}function nv(s){s&&s.isObject3D===!0&&eI(s,z)}if(Om.experimentalSmartHierarchyUpdate){const s=z.prototype.add;z.prototype.add=function(...i){return ab(),s.apply(this,i)};const t=z.prototype.attach;z.prototype.attach=function(...i){return ab(),t.apply(this,i)};const e=z.prototype.remove;z.prototype.remove=function(...i){return ab(),e.apply(this,i)}}z.prototype.SetActive=function(s){this.visible=s};z.prototype.setActive=function(s){this.visible=s};z.prototype.destroy=function(){xs(this)};z.prototype.addComponent=function(s,t){return Wo(this,s,t)};z.prototype.addNewComponent=function(s,t){return Wo(this,s,t)};z.prototype.removeComponent=function(s){return iT(this,s)};z.prototype.getOrAddComponent=function(s,t){return Bg(this,s,t)};z.prototype.getComponent=function(s){return ld(this,s)};z.prototype.getComponents=function(s,t){return Ug(this,s,t)};z.prototype.getComponentInChildren=function(s,t=!1){return Ng(this,s,t)};z.prototype.getComponentsInChildren=function(s,t){return kf(this,s,t)};z.prototype.getComponentInParent=function(s,t=!1){return Am(this,s,t)};z.prototype.getComponentsInParent=function(s,t){return iv(this,s,t)};Object.getOwnPropertyDescriptor(z.prototype,"activeSelf")||Object.defineProperty(z.prototype,"activeSelf",{get:function(){return Mf(this)},set:function(s){rm(this,s)}});Object.getOwnPropertyDescriptor(z.prototype,"raycastAllowed")||Object.defineProperty(z.prototype,"raycastAllowed",{get:function(){return this.userData&&this.userData.raycastAllowed!==!1},set:function(s){const t=this;t.userData||(t.userData={}),t.userData.raycastAllowed=s}});Object.getOwnPropertyDescriptor(z.prototype,"worldPosition")||Object.defineProperty(z.prototype,"worldPosition",{get:function(){return this instanceof o1?ve(this.object):ve(this)},set:function(s){Oi(this,s)}});Object.getOwnPropertyDescriptor(z.prototype,"worldQuaternion")||Object.defineProperty(z.prototype,"worldQuaternion",{get:function(){return this instanceof o1?Qe(this.object):Qe(this)},set:function(s){Yo(this,s)}});Object.getOwnPropertyDescriptor(z.prototype,"worldRotation")||Object.defineProperty(z.prototype,"worldRotation",{get:function(){return z0(this)},set:function(s){GE(this,s)}});Object.getOwnPropertyDescriptor(z.prototype,"worldScale")||Object.defineProperty(z.prototype,"worldScale",{get:function(){return Lt(this)},set:function(s){lf(this,s)}});const lI=new xe,cI=new R(0,0,0),hI=new R(0,1,0);Object.getOwnPropertyDescriptor(z.prototype,"worldForward")||Object.defineProperty(z.prototype,"worldForward",{get:function(){return te().set(0,0,1).applyQuaternion(Qe(this))},set:function(s){const t=Un().setFromRotationMatrix(lI.lookAt(cI.set(0,0,0),s,hI.set(0,1,0)));this.worldQuaternion=t}});Object.getOwnPropertyDescriptor(z.prototype,"worldRight")||Object.defineProperty(z.prototype,"worldRight",{get:function(){return te().set(1,0,0).applyQuaternion(Qe(this))}});Object.getOwnPropertyDescriptor(z.prototype,"worldUp")||Object.defineProperty(z.prototype,"worldUp",{get:function(){return te().set(0,1,0).applyQuaternion(Qe(this))}});Object.getOwnPropertyDescriptor(z.prototype,"contains")||Object.defineProperty(z.prototype,"contains",{value:function(s){if(!s)return!1;if(this===s)return!0;for(const t of this.children)if(t.contains(s))return!0;return!1}});tI(z);const om=k("debuggetcomponent"),tc=k("debuginstantiate");class er{constructor(){a(this,"idProvider");a(this,"parent");a(this,"keepWorldPosition");a(this,"position");a(this,"rotation");a(this,"scale");a(this,"visible");a(this,"context");a(this,"components")}clone(){var e,i,n;const t=new er;return t.idProvider=this.idProvider,t.parent=this.parent,t.keepWorldPosition=this.keepWorldPosition,t.position=Array.isArray(this.position)?[...this.position]:(e=this.position)==null?void 0:e.clone(),t.rotation=Array.isArray(this.rotation)?[...this.rotation]:(i=this.rotation)==null?void 0:i.clone(),t.scale=Array.isArray(this.scale)?[...this.scale]:(n=this.scale)==null?void 0:n.clone(),t.visible=this.visible,t.context=this.context,t.components=this.components,t}cloneAssign(t){var e,i,n;this.idProvider=t.idProvider,this.parent=t.parent,this.keepWorldPosition=t.keepWorldPosition,this.position=Array.isArray(t.position)?[...t.position]:(e=t.position)==null?void 0:e.clone(),this.rotation=Array.isArray(t.rotation)?[...t.rotation]:(i=t.rotation)==null?void 0:i.clone(),this.scale=Array.isArray(t.scale)?[...t.scale]:(n=t.scale)==null?void 0:n.clone(),this.visible=t.visible,this.context=t.context,this.components=t.components}}function Mf(s){return s.visible}function rm(s,t){return typeof t=="number"&&(t=t>.5),s.visible=t,s.visible}function dI(s){return s[Da]||sv(s)}function uI(s,t){s[zP]=t}function sv(s){return Qs.isUsingInstancing(s)}function oT(s,t){return af(s,t,!0,!0)}const rT=Symbol("isDestroyed");function td(s){return s[rT]}function fI(s,t){s[rT]=t}const V_=Symbol("isDontDestroy");function Vd(s,t=!0){s[V_]=t}const am=[],lm=[];function xs(s,t=!0,e=!1){am.length=0,lm.length=0,W_(s,t,!0);for(const i of am)i.gameObject=null,i.context=null;for(const i of lm)fI(i,!0),e&&ft(i);lm.length=0,am.length=0}function W_(s,t=!0,e=!0){var r;if(s==null)return;const i=s;if(i.isComponent){if(i[V_])return;am.push(i);const l=i.gameObject;i.__internalDisable(),i.__internalDestroy(),i.gameObject=l;return}if(s[V_])return;const n=s;om&&console.log(n),lm.push(n);const o=(r=n.userData)==null?void 0:r.components;if(o!=null&&Array.isArray(o)){let l=o.length;for(let c=0;c<o.length;c++){const h=o[c];W_(h,t,!1),o.length<l&&(l=o.length,c--)}}if(t&&n.children)for(const l of n.children)W_(l,t,!1);e&&n.removeFromParent()}function id(s,t,e=!0){return aT(s,t,e)}function*ov(s,t,e=!1,i=999,n=0){if(s!=null&&s.userData.components&&!(n>i)){for(const o of s.userData.components)t&&(o==null?void 0:o.isComponent)===!0&&o instanceof t?yield o:yield o;if(e===!0)for(const o of s.children)yield*ov(o,t,!0,i,n+1)}}function aT(s,t,e,i=0){var n;if(s){if(s.isObject3D,i>1e3){console.warn("Failed to iterate components: too many levels");return}if((n=s.userData)!=null&&n.components)for(let o=0;o<s.userData.components.length;o++){const r=s.userData.components[o];if((r==null?void 0:r.isComponent)===!0){const l=t(r);if(l!==void 0)return l}}if(e&&s.children){const o=i+1;for(let r=0;r<s.children.length;r++){const l=s.children[r];if(!l)continue;const c=aT(l,t,e,o);if(c!==void 0)return c}}}}function cc(s,t){if("isAssetReference"in s)return s.instantiate(t??void 0);let e=null;t!=null&&(t.x!==void 0?(e=new er,e.position=t):e=t);let i=de.Current;e!=null&&e.context&&(i=e.context),om&&i.alias&&console.log("context",i.alias),e&&!e.idProvider&&(e.idProvider=new Ki(Date.now()));const n=[],o={},r={},l=lT(i,s,e,n,o,r);l&&(gI(l,o),mI(r,o)),om&&(p_(s,!0),p_(l,!0));const c={};if((e==null?void 0:e.components)!==!1){for(const h in n){const d=n[h],u=d.guid;e&&e.idProvider&&(d.guid=e.idProvider.generateUUID(),c[u]=d.guid,om&&console.log(d.name,d.guid)),lv(d,i),d.__internalNewInstanceCreated&&d.__internalNewInstanceCreated()}for(const h in n){const d=n[h];d.resolveGuids&&d.resolveGuids(c),d.enabled!==!1&&(d.enabled=!0)}km(i)}return l}function lT(s,t,e,i,n,o){var d;if(!t||t[zn])return null;const r=t.userData;t.userData={};const l=t.children;t.children=[];const c=t.clone(!1);if(nv(c),t.userData=r,t.children=l,n[t.uuid]={original:t,clone:c},tc&&console.log("ADD",t,c),t.type==="SkinnedMesh"&&(o[t.uuid]={original:t,clone:c}),(e==null?void 0:e.visible)!==void 0&&(c.visible=e.visible),e!=null&&e.idProvider){c.uuid=e.idProvider.generateUUID();const u=c;u&&(u.guid=c.uuid)}t.animations&&t.animations.length>0&&(c.animations=[...t.animations]);const h=t.parent;if(h&&h.add(c),e!=null&&e.position)if(Array.isArray(e.position)){const u=new R;u.fromArray(e.position),c.worldPosition=u}else c.worldPosition=e.position;else c.position.copy(t.position);if(e!=null&&e.rotation){if(e.rotation instanceof re)c.worldQuaternion=e.rotation;else if(e.rotation instanceof Ht)c.worldQuaternion=Un().setFromEuler(e.rotation);else if(Array.isArray(e.rotation)){const u=new Ht;u.fromArray(e.rotation),c.worldQuaternion=Un().setFromEuler(u)}}else c.quaternion.copy(t.quaternion);if(e!=null&&e.scale)if(Array.isArray(e.scale)){const u=new R;u.fromArray(e.scale),e.scale=u}else c.scale.copy(e.scale);else c.scale.copy(t.scale);if(e!=null&&e.parent&&e.parent!=="scene"){let u=null;if(typeof e.parent=="string"?u=af(e.parent,s.scene,!0):u=e.parent,u){const f=e.keepWorldPosition===!0?u.attach:u.add;f?f.call(u,c):console.error("Invalid parent object",u,"received when instantiating:",t)}else console.warn("could not find parent:",e.parent)}for(const[u,f]of Object.entries(t.userData))u!=="components"&&(c.userData[u]=f);if((d=t.userData)!=null&&d.components){const u=t.userData.components,f=[];c.userData.components=f;for(let p=0;p<u.length;p++){const b=u[p],x=new b.constructor;pI(b,x),b[Kp]!==void 0&&(x[Kp]=b[Kp]),f.push(x),x.gameObject=c,i.push(x),n[b.guid]={original:b,clone:x},jg.dispatchComponentLifecycleEvent("component-added",x)}}e&&(e.position=void 0,e.rotation=void 0,e.scale=void 0,e.parent=void 0,e.visible=void 0);for(const u in t.children){const f=t.children[u],p=lT(s,f,e,i,n,o);p&&(n[p.uuid]={original:f,clone:p},c.add(p))}return c}function pI(s,t,e){ed(t,s,void 0,{})}function mI(s,t){for(const e in s){const i=s[e],n=i.original,o=n.skeleton,r=i.clone;if(!o){console.warn("Skinned mesh has no skeleton?",i);continue}const l=o.bones,c=r.skeleton.clone();r.skeleton=c,r.bindMatrix.clone().copy(n.bindMatrix),r.bindMatrixInverse.copy(n.bindMatrixInverse);const h=[];c.bones=h;for(let d=0;d<l.length;d++){const u=l[d],p=t[u.uuid].clone;h.push(p)}}for(const e in s){const i=s[e].clone;i.skeleton.update(),i.bind(i.skeleton,i.bindMatrix),i.updateMatrixWorld(!0)}}function gI(s,t){var e;for(const i in t){const o=t[i].clone;if(o!=null&&o.isObject3D&&((e=o==null?void 0:o.userData)!=null&&e.components))for(let r=0;r<o.userData.components.length;r++){const l=o.userData.components[r],c=Object.entries(l);for(const[h,d]of c)if(Array.isArray(d)){const u=[];l[h]=u;for(let f=0;f<d.length;f++){const p=d[f];if(typeof p!="object"){u.push(p);continue}const b=hS(l,h,p,t);b!==void 0?(tc&&console.log("Found new instance for",h,p,"->",b),u.push(b)):(tc&&console.warn("Could not find new instance for",h,p),u.push(p))}}else if(typeof d=="object"){const u=hS(l,h,d,t);u!==void 0?l[h]=u:tc&&console.warn("Could not find new instance for",h,d)}}}}function hS(s,t,e,i){var n,o;if(e!=null)if(e.isComponent===!0){const r=e.gameObject;if(r){const l=r.uuid,c=(n=i[l])==null?void 0:n.clone;if(!c){tc&&console.log("reference did not change",t,s,e);return}const h=r.userData.components.indexOf(e);if(h>=0&&c.isObject3D)return tc&&console.log(t,l),c.userData.components[h];console.warn("could not find component",t,e)}}else if(e.isObject3D===!0){if(t==="gameObject")return;const r=e;if(r){const l=r.uuid,c=(o=i[l])==null?void 0:o.clone;if(c)return tc&&console.log(t,"old",e,"new",c),c}}else{if(e.isVector4||e.isVector3||e.isVector2||e.isQuaternion||e.isEuler)return e.clone();if(e.isColor===!0)return e.clone();if(e.isEventList===!0)return e.__internalOnInstantiate(i)}}var cT={exports:{}},hT={exports:{}};(function(){var s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t={rotl:function(e,i){return e<<i|e>>>32-i},rotr:function(e,i){return e<<32-i|e>>>i},endian:function(e){if(e.constructor==Number)return t.rotl(e,8)&16711935|t.rotl(e,24)&4278255360;for(var i=0;i<e.length;i++)e[i]=t.endian(e[i]);return e},randomBytes:function(e){for(var i=[];e>0;e--)i.push(Math.floor(Math.random()*256));return i},bytesToWords:function(e){for(var i=[],n=0,o=0;n<e.length;n++,o+=8)i[o>>>5]|=e[n]<<24-o%32;return i},wordsToBytes:function(e){for(var i=[],n=0;n<e.length*32;n+=8)i.push(e[n>>>5]>>>24-n%32&255);return i},bytesToHex:function(e){for(var i=[],n=0;n<e.length;n++)i.push((e[n]>>>4).toString(16)),i.push((e[n]&15).toString(16));return i.join("")},hexToBytes:function(e){for(var i=[],n=0;n<e.length;n+=2)i.push(parseInt(e.substr(n,2),16));return i},bytesToBase64:function(e){for(var i=[],n=0;n<e.length;n+=3)for(var o=e[n]<<16|e[n+1]<<8|e[n+2],r=0;r<4;r++)n*8+r*6<=e.length*8?i.push(s.charAt(o>>>6*(3-r)&63)):i.push("=");return i.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/ig,"");for(var i=[],n=0,o=0;n<e.length;o=++n%4)o!=0&&i.push((s.indexOf(e.charAt(n-1))&Math.pow(2,-2*o+8)-1)<<o*2|s.indexOf(e.charAt(n))>>>6-o*2);return i}};hT.exports=t})();var yI=hT.exports,H_={utf8:{stringToBytes:function(s){return H_.bin.stringToBytes(unescape(encodeURIComponent(s)))},bytesToString:function(s){return decodeURIComponent(escape(H_.bin.bytesToString(s)))}},bin:{stringToBytes:function(s){for(var t=[],e=0;e<s.length;e++)t.push(s.charCodeAt(e)&255);return t},bytesToString:function(s){for(var t=[],e=0;e<s.length;e++)t.push(String.fromCharCode(s[e]));return t.join("")}}},dS=H_;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var bI=function(s){return s!=null&&(dT(s)||_I(s)||!!s._isBuffer)};function dT(s){return!!s.constructor&&typeof s.constructor.isBuffer=="function"&&s.constructor.isBuffer(s)}function _I(s){return typeof s.readFloatLE=="function"&&typeof s.slice=="function"&&dT(s.slice(0,0))}(function(){var s=yI,t=dS.utf8,e=bI,i=dS.bin,n=function(o,r){o.constructor==String?r&&r.encoding==="binary"?o=i.stringToBytes(o):o=t.stringToBytes(o):e(o)?o=Array.prototype.slice.call(o,0):!Array.isArray(o)&&o.constructor!==Uint8Array&&(o=o.toString());for(var l=s.bytesToWords(o),c=o.length*8,h=1732584193,d=-271733879,u=-1732584194,f=271733878,p=0;p<l.length;p++)l[p]=(l[p]<<8|l[p]>>>24)&16711935|(l[p]<<24|l[p]>>>8)&4278255360;l[c>>>5]|=128<<c%32,l[(c+64>>>9<<4)+14]=c;for(var b=n._ff,x=n._gg,v=n._hh,S=n._ii,p=0;p<l.length;p+=16){var C=h,P=d,E=u,D=f;h=b(h,d,u,f,l[p+0],7,-680876936),f=b(f,h,d,u,l[p+1],12,-389564586),u=b(u,f,h,d,l[p+2],17,606105819),d=b(d,u,f,h,l[p+3],22,-1044525330),h=b(h,d,u,f,l[p+4],7,-176418897),f=b(f,h,d,u,l[p+5],12,1200080426),u=b(u,f,h,d,l[p+6],17,-1473231341),d=b(d,u,f,h,l[p+7],22,-45705983),h=b(h,d,u,f,l[p+8],7,1770035416),f=b(f,h,d,u,l[p+9],12,-1958414417),u=b(u,f,h,d,l[p+10],17,-42063),d=b(d,u,f,h,l[p+11],22,-1990404162),h=b(h,d,u,f,l[p+12],7,1804603682),f=b(f,h,d,u,l[p+13],12,-40341101),u=b(u,f,h,d,l[p+14],17,-1502002290),d=b(d,u,f,h,l[p+15],22,1236535329),h=x(h,d,u,f,l[p+1],5,-165796510),f=x(f,h,d,u,l[p+6],9,-1069501632),u=x(u,f,h,d,l[p+11],14,643717713),d=x(d,u,f,h,l[p+0],20,-373897302),h=x(h,d,u,f,l[p+5],5,-701558691),f=x(f,h,d,u,l[p+10],9,38016083),u=x(u,f,h,d,l[p+15],14,-660478335),d=x(d,u,f,h,l[p+4],20,-405537848),h=x(h,d,u,f,l[p+9],5,568446438),f=x(f,h,d,u,l[p+14],9,-1019803690),u=x(u,f,h,d,l[p+3],14,-187363961),d=x(d,u,f,h,l[p+8],20,1163531501),h=x(h,d,u,f,l[p+13],5,-1444681467),f=x(f,h,d,u,l[p+2],9,-51403784),u=x(u,f,h,d,l[p+7],14,1735328473),d=x(d,u,f,h,l[p+12],20,-1926607734),h=v(h,d,u,f,l[p+5],4,-378558),f=v(f,h,d,u,l[p+8],11,-2022574463),u=v(u,f,h,d,l[p+11],16,1839030562),d=v(d,u,f,h,l[p+14],23,-35309556),h=v(h,d,u,f,l[p+1],4,-1530992060),f=v(f,h,d,u,l[p+4],11,1272893353),u=v(u,f,h,d,l[p+7],16,-155497632),d=v(d,u,f,h,l[p+10],23,-1094730640),h=v(h,d,u,f,l[p+13],4,681279174),f=v(f,h,d,u,l[p+0],11,-358537222),u=v(u,f,h,d,l[p+3],16,-722521979),d=v(d,u,f,h,l[p+6],23,76029189),h=v(h,d,u,f,l[p+9],4,-640364487),f=v(f,h,d,u,l[p+12],11,-421815835),u=v(u,f,h,d,l[p+15],16,530742520),d=v(d,u,f,h,l[p+2],23,-995338651),h=S(h,d,u,f,l[p+0],6,-198630844),f=S(f,h,d,u,l[p+7],10,1126891415),u=S(u,f,h,d,l[p+14],15,-1416354905),d=S(d,u,f,h,l[p+5],21,-57434055),h=S(h,d,u,f,l[p+12],6,1700485571),f=S(f,h,d,u,l[p+3],10,-1894986606),u=S(u,f,h,d,l[p+10],15,-1051523),d=S(d,u,f,h,l[p+1],21,-2054922799),h=S(h,d,u,f,l[p+8],6,1873313359),f=S(f,h,d,u,l[p+15],10,-30611744),u=S(u,f,h,d,l[p+6],15,-1560198380),d=S(d,u,f,h,l[p+13],21,1309151649),h=S(h,d,u,f,l[p+4],6,-145523070),f=S(f,h,d,u,l[p+11],10,-1120210379),u=S(u,f,h,d,l[p+2],15,718787259),d=S(d,u,f,h,l[p+9],21,-343485551),h=h+C>>>0,d=d+P>>>0,u=u+E>>>0,f=f+D>>>0}return s.endian([h,d,u,f])};n._ff=function(o,r,l,c,h,d,u){var f=o+(r&l|~r&c)+(h>>>0)+u;return(f<<d|f>>>32-d)+r},n._gg=function(o,r,l,c,h,d,u){var f=o+(r&c|l&~c)+(h>>>0)+u;return(f<<d|f>>>32-d)+r},n._hh=function(o,r,l,c,h,d,u){var f=o+(r^l^c)+(h>>>0)+u;return(f<<d|f>>>32-d)+r},n._ii=function(o,r,l,c,h,d,u){var f=o+(l^(r|~c))+(h>>>0)+u;return(f<<d|f>>>32-d)+r},n._blocksize=16,n._digestsize=16,cT.exports=function(o,r){if(o==null)throw new Error("Illegal argument "+o);var l=s.wordsToBytes(n(o,r));return r&&r.asBytes?l:r&&r.asString?i.bytesToString(l):s.bytesToHex(l)}})();var vI=cT.exports;const uS=Ig(vI);var nd;(function(s){s.baseUrl="https://networking.needle.tools";function i(d){return uS(new Uint8Array(d))}s.hashMD5=i;function n(d){const u=uS(new Uint8Array(d),{encoding:"binary",asBytes:!0});return btoa(String.fromCharCode(...u))}s.hashMD5_Base64=n;function o(d){const u=new Uint8Array(d);return crypto.subtle.digest("SHA-256",u).then(p=>btoa(String.fromCharCode(...new Uint8Array(p))))}s.hashSha256=o;function r(d){const u=d.filesize/1024/1024;return jr()?u<50:u<5}s.canUpload=r;async function l(d,u){var P;const f=s.baseUrl;if(f){if(!d.name)return console.error("Upload: file name is missing"),null}else return console.error("Blob storage base url is not set"),null;let p=null;d instanceof File?p=await d.arrayBuffer():p=d.data;const b=p.byteLength,x=b/1024/1024;if(x>50)return(u==null?void 0:u.silent)!==!0&&qe(`File (${x.toFixed(1)}MB) is too large for uploading (see console for details)`),console.warn(`Your file is too large for uploading (${x.toFixed(1)}MB). Max allowed size is 50MB`),null;if(!jr()&&x>5)return(u==null?void 0:u.silent)!==!0&&qe('File is too large for uploading. Please get a <a href="https://needle.tools/pricing" target="_blank">commercial license</a> to upload files larger than 5MB'),console.warn(`Your file is too large for uploading (${x.toFixed(1)}MB). Max size is 5MB for non-commercial users. Please get a commercial license at https://needle.tools/pricing for larger files (up to 50MB)`),null;if(b<1)return console.warn(`Your file is too small for uploading (${x.toFixed(1)}MB). Min size is 1 byte`),null;const v=n(p),S={filename:d.name,"Content-Md5":v,"Content-Type":d.type||"application/octet-stream",FileSize:b.toString(),"Content-Disposition":`attachment; filename="${d.name}"`,"x-amz-server-side-encryption":"AES256"},C=await fetch(f+"/api/needle/blob",{method:"POST",headers:S,signal:u==null?void 0:u.abort}).then(E=>E.json()).catch(E=>(console.error(E),null));if(C==null)return console.warn("Upload failed..."),null;if("error"in C)return console.error(C.error),null;if("upload"in C&&C.upload){let M=function(A){var V;return(V=u==null?void 0:u.onProgress)==null||V.call(null,{progress01:0,state:"inprogress"}),fetch(A,{method:"PUT",headers:S,body:p,signal:u==null?void 0:u.abort}).then(U=>{var $;return($=u==null?void 0:u.onProgress)==null||$.call(null,{progress01:1,state:"finished"}),U}).catch(U=>U)};console.debug("Uploading file",C.upload);let E=!1,D=null;for(let A=0;A<3;A++)try{if(E)break;if((P=u==null?void 0:u.abort)!=null&&P.aborted)return console.debug("Aborted upload"),null;const G=await M(C.upload);G instanceof Error?(D=G,await Ha(1e3*A)):G.ok&&(console.debug("File uploaded successfully"),E=!0)}catch(G){console.error(G)}if(!E)return console.error((D==null?void 0:D.message)||"Failed to upload file"),null}if("download"in C){const E=f+C.download;return console.debug("File found in blob storage",E),{key:C.key,success:!0,download_url:E}}return null}s.upload=l;function c(d){return`${s.baseUrl}/api/needle/blob/${d}`}s.getBlobUrlForKey=c;async function h(d,u){const f=new k0;f.setResponseType("arraybuffer");const p=await f.loadAsync(d,b=>{u&&u.call(null,b)});return p instanceof ArrayBuffer?new Uint8Array(p):(console.error("Download failed, no arraybuffer returned"),null)}s.download=h})(nd||(nd={}));const aa=k("debugaddressables");class xI{constructor(t){a(this,"_context");a(this,"_assetReferences",{});a(this,"preUpdate",()=>{});this._context=t,this._context.pre_update_callbacks.push(this.preUpdate)}dispose(){const t=this._context.pre_update_callbacks.indexOf(this.preUpdate);t>=0&&this._context.pre_update_callbacks.splice(t,1);for(const e in this._assetReferences){const i=this._assetReferences[e];i==null||i.unload()}this._assetReferences={}}findAssetReference(t){return this._assetReferences[t]||null}registerAssetReference(t){return t.url&&(this._assetReferences[t.url]?console.warn("Asset reference already registered",t):this._assetReferences[t.url]=t),t}unregisterAssetReference(t){t.url&&delete this._assetReferences[t.url]}}const db=Symbol("assetReference"),Ul=class{constructor(...t){a(this,"isAssetReference",!0);a(this,"_rawAsset",null);a(this,"_glbRoot");a(this,"_url");a(this,"_urlName");a(this,"_progressListeners",[]);a(this,"_isLoadingRawBinary",!1);a(this,"_rawBinary");a(this,"_loadingPromise",null);typeof t[0]=="object"?"url"in t[0]?this._url=t[0].url:(this._url="",t[0].asset&&(this.asset=t[0].asset)):(this._url=t[0],t[2]instanceof z&&(this.asset=t[2]));const e=this._url.lastIndexOf("/");if(e>=0){this._urlName=this._url.substring(e+1);const i=this._urlName.lastIndexOf(".");i>=0&&(this._urlName=this._urlName.substring(0,i))}else this._urlName=this._url;L2(this._url,this.onResolvePrefab.bind(this))}static getOrCreateFromUrl(t,e){if(!e&&(e=de.Current,!e))throw new Error('Context is required when sourceId is a string. When you call this method from a component you can call it with "getOrCreate(this, url)" where "this" is the component.');const i=e.addressables,n=i.findAssetReference(t);if(n)return n;const o=new Ul(t,e.hash);return i.registerAssetReference(o),o}static getOrCreate(t,e,i){if(typeof t=="string"){if(!i&&(i=de.Current,!i))throw new Error('Context is required when sourceId is a string. When you call this method from a component you can call it with "getOrCreate(this, url)" where "this" is the component.')}else i=t.context,t=t.sourceId;const n=yc(t,e);aa&&console.log("GetOrCreate Addressable from",t,e,"FinalPath=",n);const o=i.addressables,r=o.findAssetReference(n);if(r)return r;const l=new Ul(n,i.hash);return o.registerAssetReference(l),l}get rawAsset(){return this._rawAsset}get asset(){var t;return this._glbRoot??(((t=this._rawAsset)==null?void 0:t.scene)||null)}set asset(t){t?this._rawAsset={animations:t.animations,scene:t,scenes:[t]}:this._rawAsset=null}get uri(){return this._url}get url(){return this._url}get urlName(){return this._urlName}get hasUrl(){return this._url!==void 0&&(this._url.startsWith("http")||this._url.startsWith("blob:")||this._url.startsWith("www.")||this._url.includes("/"))}async onResolvePrefab(t){return t===this.url&&(this.mustLoad&&await this.loadAssetAsync(),this.asset)?this.asset:null}get mustLoad(){return!this.asset||this.asset.__destroyed===!0||td(this.asset)===!0}isLoaded(){return this._rawBinary||this.asset!==void 0}unload(){this.asset&&(aa&&console.log("Unload",this.asset),"scene"in this.asset&&this.asset.scene&&xs(this.asset.scene,!0,!0),xs(this.asset,!0,!0)),this.asset=null,this._rawBinary=void 0,this._glbRoot=null,this._loadingPromise=null,de.Current&&de.Current.addressables.unregisterAssetReference(this)}async preload(){if(!this.mustLoad||this._isLoadingRawBinary)return null;if(this._rawBinary!==void 0)return this._rawBinary;this._isLoadingRawBinary=!0,aa&&console.log("Preload",this.url);const t=await nd.download(this.url,e=>{this.raiseProgressEvent(e)});return this._rawBinary=(t==null?void 0:t.buffer)??null,this._isLoadingRawBinary=!1,this._rawBinary}async loadAssetAsync(t){if(aa&&console.log("[AssetReference] loadAssetAsync",this.url),!this.mustLoad)return this.asset;if(t&&this._progressListeners.push(t),this._loadingPromise!==null)return this._loadingPromise.then(n=>this.asset);const e=de.Current;if(this._rawBinary){if(!(this._rawBinary instanceof ArrayBuffer))return console.error("[AssetReference] Failed loading ‚Äì Invalid data. Must be of type ArrayBuffer. "+typeof this._rawBinary),null;this._loadingPromise=Ko().parseSync(e,this._rawBinary,this.url,null),this.raiseProgressEvent(new ProgressEvent("progress",{loaded:this._rawBinary.byteLength,total:this._rawBinary.byteLength}))}else aa&&console.log("Load async",this.url),this._loadingPromise=Ko().loadSync(e,this.url,this.url,null,n=>{this.raiseProgressEvent(n)});this._loadingPromise.finally(()=>this._loadingPromise=null);const i=await this._loadingPromise;return this._progressListeners.length=0,this._glbRoot=this.tryGetActualGameObjectRoot(i),i?(i[db]=this,this._glbRoot&&(this._glbRoot[db]=this),this.asset&&(this.asset[db]=this),km(e),i.scene!==void 0&&(this._rawAsset=i),this.asset):null}instantiate(t){return this.onInstantiate(t,!1)}instantiateSynced(t,e=!0){return this.onInstantiate(t,!0,e)}beginListenDownload(t){this._progressListeners.indexOf(t)<0&&this._progressListeners.push(t)}endListenDownload(t){const e=this._progressListeners.indexOf(t);e>=0&&this._progressListeners.splice(e,1)}raiseProgressEvent(t){for(const e of this._progressListeners)e(this,t)}async onInstantiate(t,e=!1,i){const n=de.Current,o=new er;if(t instanceof z?o.parent=t:t&&(Object.assign(o,t),o.cloneAssign(t)),o.parent===void 0&&(o.parent=n.scene),this.mustLoad&&await this.loadAssetAsync(),aa&&console.log("Instantiate",this.url,"parent:",t),this.asset){aa&&console.log("Add to scene",this.asset);let r=Ul.currentlyInstantiating.get(this.url);if(r!==void 0&&r>=1e4)return console.error("Recursive or too many instantiations of "+this.url+" in the same frame ("+r+")"),null;try{if(r===void 0&&(r=0),r+=1,Ul.currentlyInstantiating.set(this.url,r),e){o.context=n;const l=this.asset;l.guid=this.url;const c=qP(l,o,void 0,i);if(c)return c}else{const l=cc(this.asset,o);if(l)return l}}finally{n.post_render_callbacks.push(()=>{r===void 0||r<0?r=0:r-=1,Ul.currentlyInstantiating.set(this.url,r)})}}else aa&&console.warn("Failed to load asset",this.url);return null}tryGetActualGameObjectRoot(t){if(t&&t.scene){const e=t.scene;if(e.isGroup&&e.children.length===1&&e.children[0].name+"glb"===e.name){const i=e.children[0];return i.animations=e.animations,i}else return e}return null}};let we=Ul;a(we,"currentlyInstantiating",new Map);class wI extends Ps{constructor(){super([we],"AssetReferenceSerializer")}onSerialize(t,e){if(t&&t.uri!==void 0&&typeof t.uri=="string")return t.uri}onDeserialize(t,e){if(typeof t=="string")return e.context?e.gltfId?we.getOrCreate(e.gltfId,t,e.context):(console.error("Missing source id"),null):(console.error("Missing context"),null);if(t instanceof z){if(!e.context)return console.error("Missing context"),null;if(!e.gltfId)return console.error("Missing source id"),null;const i=t,n=e.context,o=i.guid??i.uuid,r=n.addressables.findAssetReference(o);if(r)return r;const l=new we(o,void 0,i);return n.addressables.registerAssetReference(l),l}return null}}new wI;const SI=Promise.resolve(null),Ku=class{constructor(t){a(this,"url");a(this,"_bitmap");a(this,"_bitmapObject");a(this,"loader",null);this.url=t}static getOrCreate(t){let e=Ku.imageReferences.get(t);return e||(e=new Ku(t),Ku.imageReferences.set(t,e)),e}dispose(){this._bitmapObject&&this._bitmapObject.close(),this._bitmap=void 0}createHTMLImage(){const t=new Image;return t.src=this.url,t}createTexture(){return this.url?(this.loader||(this.loader=new Wh),this.loader.setCrossOrigin("anonymous"),this.loader.loadAsync(this.url).then(t=>{var e;return t&&!((e=t.name)!=null&&e.length)&&(t.name=this.url.split("/").pop()??this.url),t})):(console.error("Can not load texture without url"),SI)}getBitmap(){return this._bitmap?this._bitmap:(this._bitmap=new Promise((t,e)=>{const i=document.createElement("img");i.addEventListener("load",()=>{this._bitmap=createImageBitmap(i).then(n=>(this._bitmapObject=n,t(n),n))}),i.addEventListener("error",n=>{console.error("Failed to load image:"+this.url,n),t(null)}),i.src=this.url}),this._bitmap)}};let Cu=Ku;a(Cu,"imageReferences",new Map);class CI extends Ps{constructor(){super([Cu],"ImageReferenceSerializer")}onSerialize(t,e){return null}onDeserialize(t,e){if(typeof t=="string"){const i=yc(e.gltfId,t);return Cu.getOrCreate(i)}}}new CI;const Zu=class{constructor(t){a(this,"url");a(this,"res");this.url=t}static getOrCreate(t){let e=Zu.cache.get(t);return e||(e=new Zu(t),Zu.cache.set(t,e)),e}async loadRaw(){return this.res||(this.res=fetch(this.url)),this.res.then(t=>t.blob())}async loadText(){return this.res||(this.res=fetch(this.url)),this.res.then(t=>t.text())}};let Pu=Zu;a(Pu,"cache",new Map);class PI extends Ps{constructor(){super([Pu],"FileReferenceSerializer")}onSerialize(t,e){return null}onDeserialize(t,e){if(typeof t=="string"){const i=yc(e.gltfId,t);return Pu.getOrCreate(i)}}}new PI;class TI{constructor(t){a(this,"context");a(this,"mixers",[]);this.context=t}onDestroy(){this.mixers.forEach(t=>t.stopAllAction()),this.mixers.length=0}registerAnimationMixer(t){if(!t){console.warn("AnimationsRegistry.registerAnimationMixer called with null or undefined mixer");return}this.mixers.includes(t)||this.mixers.push(t)}unregisterAnimationMixer(t){if(!t){console.warn("AnimationsRegistry.unregisterAnimationMixer called with null or undefined mixer");return}const e=this.mixers.indexOf(t);e!==-1&&this.mixers.splice(e,1)}}class Hr{static testIfRootCanAnimate(t,e){const i=t.getRoot();return i&&(i.userData.static||i.matrixAutoUpdate===!1||i.matrixWorldAutoUpdate===!1)?((e===!0||e===void 0&&X())&&console.warn(`AnimationUtils: The root object (${i.name||i.type}) of this AnimationAction has matrixAutoUpdate or matrixWorldAutoUpdate set to false. This may prevent the animation from working correctly. If the object is marked as static, try to change it to dynamic.`,{static:i.userData.static,name:i.userData.name,tag:i.userData.tag,matrixAutoUpdate:i.matrixAutoUpdate,matrixWorldAutoUpdate:i.matrixWorldAutoUpdate}),!1):!0}static tryGetActionsFromMixer(t){const e=t._actions;return e||null}static tryGetAnimationClipsFromObjectHierarchy(t,e){if(e||(e=new Array),t)t.animations&&e.push(...t.animations);else return e;if(t.children)for(const i of t.children)this.tryGetAnimationClipsFromObjectHierarchy(i,e);return e}static autoplayAnimations(t){if(!t||!t.animations)return console.debug("No animations found in file"),null;const e="scene"in t?t.scene:t,i=new Array;for(let o=0;o<t.animations.length;o++){const r=t.animations[o];if(!r.tracks||r.tracks.length<=0){console.warn("Animation has no tracks");continue}for(const l in r.tracks){const c=r.tracks[l],h=Gh.parseTrackName(c.name);let d=Gh.findNode(e,h.nodeName);if(!d){const f=c.__objectName??c.name.substring(0,c.name.indexOf("."));if(d=e.getObjectByProperty("uuid",f),!d)continue}let u=n(d)||n(e);if(!u){const f=j.get("Animation");if(u=e.addComponent(f),!u){console.error("Failed creating Animation component: No 'Animation' component found in TypeStore");break}}i.push(u),u.addClip&&u.addClip(r)}}return i;function n(o){var l;if(!o)return null;const r=(l=o.userData)==null?void 0:l.components;if(r&&r.length>0)for(let c=0;c<r.length;c++){const h=r[c];if(h.isAnimationComponent===!0)return h}return n(o.parent)}}static emptyClip(){return new Hn("empty",0,[])}static createScaleClip(t){const e=(t==null?void 0:t.duration)??.3;let i={x:1,y:1,z:1};(t==null?void 0:t.scale)!==void 0&&(typeof t.scale=="number"?i={x:t.scale,y:t.scale,z:t.scale}:i=t.scale);const n=(t==null?void 0:t.type)??"linear",o=(t==null?void 0:t.scaleFactor)??1.2,r=new Array,l=new Array;switch(n){case"linear":r.push(0,e),l.push(i.x,i.y,i.z,i.x*o,i.y*o,i.z*o);break;case"spring":r.push(0,e*.3,e*.5,e*.7,e*.9,e),l.push(i.x,i.y,i.z,i.x*o,i.y*o,i.z*o,i.x*.9,i.y*.9,i.z*.9,i.x*1.05,i.y*1.05,i.z*1.05,i.x*.98,i.y*.98,i.z*.98,i.x,i.y,i.z);break}const c=new OO(".scale",r,l);return new Hn("scale",r[r.length-1],[c])}}function*uT(s,t=null){const e=t?t.time:de.Current.time,i=e.time;for(;e.time-i<s;)yield}function*k4(s){for(let t=0;t<s;t++)yield}function*RI(s){let t=!0;for(s.then(()=>t=!1),s.catch(()=>t=!1);t;)yield}const fS="NEEDLE_lightmaps",Hc=k("debuglightmapsextension")||k("debuglightmaps");var zs;(function(s){s[s.Lightmap=0]="Lightmap",s[s.Skybox=1]="Skybox",s[s.Reflection=2]="Reflection"})(zs||(zs={}));class OI{constructor(t,e,i){a(this,"parser");a(this,"registry");a(this,"source");this.parser=t,this.registry=e,this.source=i}get name(){return fS}afterRoot(t){const e=this.parser.json.extensions;if(e){const i=e[fS];if(i){const n=i.textures;return n!=null&&n.length?(Hc&&console.log(i),new Promise(async(o,r)=>{const l=[];for(const h of n)if(h.pointer){Hc&&console.log(h);let d=null;if(h.pointer.startsWith("/textures/")||h.pointer.startsWith("textures/"))Hc&&console.log("Load texture from gltf",h.pointer),d=tv(this.parser,h.pointer).then(u=>this.resolveTexture(h,u));else if(typeof h.pointer=="string"){Hc&&console.log("Load texture from path",h.pointer);const u=yc(this.source,h.pointer);let f;u.endsWith(".exr")?f=new D0(this.parser.options.manager):u.endsWith(".hdr")?f=new r1(this.parser.options.manager):f=new Wh(this.parser.options.manager),d=f.loadAsync(u,void 0).then(p=>this.resolveTexture(h,p))}else h.pointer;d&&l.push(d)}const c=await g1(l);c!=null&&c.anyFailed&&(X()||Hc)&&console.error("[NEEDLE_lightmaps]Error during extension loading:",c),o()})):null}}return null}resolveTexture(t,e){const i=e;Hc&&console.log("Light Texture loaded:",i),i!=null&&i.isTexture&&(this.registry?(i.colorSpace=$r,this.registry.registerTexture(this.source,t.type,i,t.index)):console.log(zs[t.type],t.pointer,i))}}const Gc=!!k("debuglightmaps");class kI{constructor(t){a(this,"context");a(this,"map",new Map);this.context=t}clear(){this.map.clear()}registerTexture(t,e,i,n){Gc&&console.log("Registering ",zs[e]+' "'+t+'"',i),this.map.has(t)||this.map.set(t,new Map);const o=this.map.get(t),r=(o==null?void 0:o.get(e))??[];r.length<n&&(r.length=n+1),l2(i,!1),r[n]=i,o==null||o.set(e,r)}tryGetLightmap(t,e=0){return this.tryGet(t,zs.Lightmap,e)}tryGetSkybox(t){return Gc&&console.log("[Get Skybox]",t,this.map),this.tryGet(t,zs.Skybox,0)}tryGetReflection(t){return Gc&&console.log("[Get Reflection]",t,this.map),this.tryGet(t,zs.Reflection,0)}tryGet(t,e,i){if(!t)return Gc&&console.warn("Missing source id"),null;const n=this.map.get(t);if(!n)return Gc&&console.warn(`[Lighting] No ${zs[e]} texture entry for`,t),null;const o=n.get(e);return o===void 0?(Gc&&console.warn(`[Lighting] No ${zs[e]} texture for`,t,"index",i),null):!(o!=null&&o.length)||o.length<=i?null:o[i]}}dn.lights_fragment_maps=dn.lights_fragment_maps.replace("vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );",`
    vec2 lUv = vLightMapUv.xy * lightmapScaleOffset.xy + vec2(lightmapScaleOffset.z, (1. - (lightmapScaleOffset.y + lightmapScaleOffset.w)));
    vec4 lightMapTexel = texture2D( lightMap, lUv);
    // The range of RGBM lightmaps goes from 0 to 34.49 (5^2.2) in linear space, and from 0 to 5 in gamma space.
    lightMapTexel.rgb *= lightMapTexel.a * 8.; // no idea where that "8" comes from... heuristically derived
    lightMapTexel.a = 1.;
    lightMapTexel = conv_sRGBToLinear(lightMapTexel);
    `);dn.lightmap_pars_fragment=`
    #ifdef USE_LIGHTMAP
        uniform sampler2D lightMap;
        uniform float lightMapIntensity;
        uniform vec4 lightmapScaleOffset;
        
        // took from threejs 05fc79cd52b79e8c3e8dec1e7dca72c5c39983a4
        vec4 conv_sRGBToLinear( in vec4 value ) {
            return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
        }
    #endif
    `;dn.lights_fragment_begin=dn.lights_fragment_begin.replace("irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );",`
#if defined(USE_LIGHTMAP)
irradiance += 0.;
#else
irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );
#endif`);kO.lightmap.lightmapScaleOffset={value:new Ne(1,1,0,0)};const ub=k("debugprogressive"),wp=new bs,Sp=new wg;class fT{constructor(t){a(this,"context");a(this,"_lodsManager");a(this,"_settings",{});this.context=t}get manager(){return this._lodsManager}get skinnedMeshAutoUpdateBoundsInterval(){var t;return((t=this._lodsManager)==null?void 0:t.skinnedMeshAutoUpdateBoundsInterval)||this._settings.skinnedMeshAutoUpdateBoundsInterval||0}set skinnedMeshAutoUpdateBoundsInterval(t){this._settings.skinnedMeshAutoUpdateBoundsInterval=t,this.applySettings()}get targetTriangleDensity(){var t;return((t=this._lodsManager)==null?void 0:t.targetTriangleDensity)||this._settings.targetTriangleDensity||2e5}set targetTriangleDensity(t){this._settings.targetTriangleDensity=t,this.applySettings()}applySettings(){if(this._lodsManager)for(const t in this._settings)this._lodsManager[t]=this._settings[t]}setRenderer(t){var e;(e=this._lodsManager)==null||e.disable(),xl.removePlugin(this),xl.addPlugin(this),xl.debugDrawLine=se.DrawLine,this._lodsManager=xl.get(t,{engine:"needle-engine"}),this.applySettings(),this._lodsManager.enable()}disable(){var t;(t=this._lodsManager)==null||t.disable(),xl.removePlugin(this)}onAfterUpdatedLOD(t,e,i,n,o){ub&&this.onRenderDebug(i,n,o)}onRenderDebug(t,e,i){var l,c,h;if(!e.geometry||!Tt.hasLODLevelAvailable(e.geometry)&&!Tt.hasLODLevelAvailable(e.material))return;const n=xl.getObjectLODState(e);if(!n)return;let o=i.mesh_lod;const r=i.mesh_lod!=n.lastLodLevel_Mesh||i.texture_lod!=n.lastLodLevel_Texture;if(ub&&e.geometry.boundingSphere){const d=e.geometry.boundingSphere;Sp.copy(d),Sp.applyMatrix4(e.matrixWorld);const u=Sp.center,f=Sp.radius,p=["#76c43e","#bcc43e","#c4ac3e","#c4673e","#ff3e3e"];if(r)se.DrawWireSphere(u,f,p[o],.1);else{const b=((l=e.geometry.index)==null?void 0:l.count)??0,x=(c=Tt.getMeshLODExtension(e.geometry))==null?void 0:c.lods;o=x?Math.min((x==null?void 0:x.length)-1,o):0;let v="";if(x&&n.lastScreenCoverage>0)for(let P=0;P<x.length;P++){const E=x[P].density,D=P==x.length-1;v+=E.toFixed(0)+">"+(E/n.lastScreenCoverage).toFixed(0)+(D?"":",")}const S=x?(h=x[o])==null?void 0:h.density:-1;let C="LOD "+i.mesh_lod+`
TEX `+i.texture_lod;if(ub=="density"&&(C+=`
`+b+` tris
`+(S/n.lastScreenCoverage).toFixed(0)+` dens
`+(n.lastScreenCoverage*100).toFixed(1)+`% cov
`+(n.lastCentrality*100).toFixed(1)+`% centr
`+(wp.min.x.toFixed(2)+"-"+wp.max.x.toFixed(2)+"x"+wp.min.y.toFixed(2)+"-"+wp.max.y.toFixed(2))+" scr"),n.lastScreenCoverage>.1){const P=t,E=P.worldForward,D=P.worldPosition,A=te(E).multiplyScalar(f*.7).add(u),G=A.distanceTo(D),V=p[Math.min(p.length-1,Math.max(0,o))]+"88",U=this.context.domHeight>0?screen.height/this.context.domHeight:1,$=t.isPerspectiveCamera?Math.tan(t.fov*Math.PI/180/2):1;se.DrawLabel(A,C,G*.012*U*$,void 0,16777215,V)}}}}}a(fT,"GLTF_PROGRESSIVE_LODSMANAGER_TYPE",xl);const EI=k("debugplayerview");var Ho;(function(s){s.Browser="browser",s.Headset="headset",s.Handheld="handheld"})(Ho||(Ho={}));class MI{constructor(t,e){a(this,"userId");a(this,"context");a(this,"viewDevice",Ho.Browser);a(this,"removed",!1);a(this,"_object");this.userId=t,this.context=e}get currentObject(){return this._object}set currentObject(t){this._object=t}get isConnected(){return this.context.connection.userIsInRoom(this.userId)}}class AI{constructor(t){a(this,"context");a(this,"playerViews",new Map);this.context=t}setPlayerView(t,e,i){let n=this.playerViews.get(t);n||(n=new MI(t,this.context),this.playerViews.set(t,n)),n.viewDevice=i,n.currentObject=e,n.removed=!1}getPlayerView(t){if(!t)return;if(!this.context.connection.userIsInRoom(t)){this.playerViews.delete(t);return}return this.playerViews.get(t)}removePlayerView(t,e){const i=this.playerViews.get(t);(i==null?void 0:i.viewDevice)===e&&(EI&&console.log("REMOVE",t),i.removed=!0,this.playerViews.delete(t))}}new k0;const Af=new Uint8Array(4);Af[0]=255;Af[1]=255;Af[2]=255;Af[3]=255;const II=new E0(Af,1,1,Sg);function rv(s,t=1){const e="alpha"in s,i=t*t,n=new Uint8Array(4*i),o=Math.floor(s.r*255),r=Math.floor(s.g*255),l=Math.floor(s.b*255);for(let h=0;h<i;h++){const d=h*4;n[d+0]=o,n[d+1]=r,n[d+2]=l,e?n[d+3]=Math.floor(s.alpha*255):n[d+3]=255}const c=new E0(n,t,t);return c.needsUpdate=!0,c}function LI(s,t,e,i=1,n=3){const r=i*n,l=[s,t,e],c=l.length,h=new Uint8Array(4*c*r),d=new Se;for(let f=0;f<n;f++){const p=Math.floor(f/n*c),b=ee.clamp(p+1,0,c-1),x=l[p],v=l[b],S=f/n*c%1;d.lerpColors(x,v,S);const C=Math.floor(d.r*255),P=Math.floor(d.g*255),E=Math.floor(d.b*255);for(let D=0;D<i;D++){const M=(f*i+D)*4;h[M+0]=C,h[M+1]=P,h[M+2]=E,h[M+3]=255}}const u=new E0(h,i,n);return u.needsUpdate=!0,u}var pS;(function(s){s[s.Vertex=0]="Vertex",s[s.Fragment=1]="Fragment"})(pS||(pS={}));function Im(s,t){const e=s.elements;t||(t=[]),t.length=0;for(let i=0;i<16;i+=4){const n=e[i],o=e[i+1],r=e[i+2],l=e[i+3],c=new Ne(n,o,r,l);t.push(c)}return t}const fb=[],mS=[];function DI(s,t){if(fb.length===0)for(let e=0;e<27;e++)fb.push(0);t||(t=fb);for(let e=0;e<27;e++)mS[e]=t[e];t=mS,s.unity_SHAr={value:new Ne(t[9],t[3],t[6],t[0])},s.unity_SHBr={value:new Ne(t[12],t[15],t[18],t[21])},s.unity_SHAg={value:new Ne(t[10],t[4],t[7],t[1])},s.unity_SHBg={value:new Ne(t[13],t[16],t[19],t[22])},s.unity_SHAb={value:new Ne(t[11],t[5],t[8],t[2])},s.unity_SHBb={value:new Ne(t[14],t[17],t[20],t[23])},s.unity_SHC={value:new Ne(t[24],t[25],t[26],1)}}class jI{constructor(t,e,i){a(this,"vertexShader");a(this,"fragmentShader");a(this,"technique");this.vertexShader=t,this.fragmentShader=e,this.technique=i}}async function FI(s,t){if(!s)return console.error("Can not find technique: no shader data"),null;const e=s.programs[t],i=e.vertexShader,n=e.fragmentShader;if(i!==void 0&&n!==void 0){const o=s.shaders[i],r=s.shaders[n];if(o.uri&&r.uri||o.code&&r.code){if(!o.code&&o.uri&&await gS(o),!r.code&&r.uri&&await gS(r),!o.code||!r.code)return null;const l=s.techniques[t];return new jI(o.code,r.code,l)}}return console.error("Shader technique not found",t),null}async function gS(s){const t=s.uri;if(t)if(t.endsWith(".glsl")){const i=await new k0().loadAsync(t);s.code=i.toString()}else s.code=BI(s.uri)}function BI(s){return decodeURIComponent(Array.prototype.map.call(atob(s),function(t){return"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2)}).join(""))}const As=k("debugenvlight");var Lo;(function(s){s[s.Skybox=0]="Skybox",s[s.Trilight=1]="Trilight",s[s.Flat=3]="Flat",s[s.Custom=4]="Custom"})(Lo||(Lo={}));var gf;(function(s){s[s.Skybox=0]="Skybox",s[s.Custom=1]="Custom"})(gf||(gf={}));class UI{constructor(t){a(this,"context");a(this,"_currentLightSettingsId");a(this,"_sceneLightSettings");a(this,"_timevec4",new Ne);a(this,"__currentReflectionId",null);a(this,"_lighting",{});this.context=t,this.context.pre_update_callbacks.push(this.preUpdate.bind(this))}get currentLightSettingsId(){return this._currentLightSettingsId}preUpdate(){const t=this.context.time;this._timevec4.x=t.time,this._timevec4.y=Math.sin(t.time),this._timevec4.z=Math.cos(t.time),this._timevec4.w=t.deltaTime}get timeVec4(){return this._timevec4}get environmentIntensity(){if(!this._sceneLightSettings||!this._currentLightSettingsId)return 1;const t=this._sceneLightSettings.get(this._currentLightSettingsId);return t?t.ambientIntensity:1}get sceneLightSettings(){var t;return(t=this._sceneLightSettings)==null?void 0:t.values()}enable(t){var i;t instanceof we&&(t=t.url);const e=(i=this._sceneLightSettings)==null?void 0:i.get(t);return e?(As&&console.log("Enable scene light settings",t,e),t!==this._currentLightSettingsId&&this._currentLightSettingsId&&this.disable(this._currentLightSettingsId),this._currentLightSettingsId=t,e.enabled=!0,!0):(As&&console.warn("No light settings found for",t),!1)}disable(t){var i;if(t instanceof we&&(t=t.url),t==null)return!1;const e=(i=this._sceneLightSettings)==null?void 0:i.get(t);return e?(As&&console.log("Disable scene light settings",t,e),e.enabled=!1,!0):!1}enableCurrent(){return this._currentLightSettingsId?(this.enable(this._currentLightSettingsId),this._currentLightSettingsId??null):null}disableCurrent(){if(this._currentLightSettingsId){const t=this._currentLightSettingsId;return this.disable(this._currentLightSettingsId),t}return null}internalRegisterSceneLightSettings(t){const e=t.sourceId;if(!e){console.error("Missing source id for scene light settings, can not register:",t);return}As&&console.log("Register "+(t==null?void 0:t.sourceId)+" lighting",t),this._sceneLightSettings||(this._sceneLightSettings=new Map),this._sceneLightSettings.set(e,t)}internalUnregisterSceneLightSettings(t){const e=t.sourceId;if(!e){console.error("Missing source id for scene light settings, can not unregister:",t);return}As&&console.log("Unregister "+(t==null?void 0:t.sourceId)+" lighting",t),this._sceneLightSettings&&this._sceneLightSettings.delete(e)}internalRegisterReflection(t,e){As&&console.log("Register reflection",t,e);const i=new NI(this.context,e,1);this._lighting[t]=i}internalGetReflection(t){return this._lighting[t]}internalEnableReflection(t){var i;this.__currentReflectionId=t;const e=(i=this._sceneLightSettings)==null?void 0:i.get(t);switch(As&&console.log("Enable reflection",t,e?Lo[e.ambientMode]:"Unknown ambient mode",e),e==null?void 0:e.ambientMode){case Lo.Skybox:case Lo.Custom:const n=this.internalGetReflection(t);if(n&&n.Source){As&&console.log("Setting environment reflection",n);const o=this.context.scene,r=n.Source;return r.mapping=Vo,o.environment=r,o.environmentIntensity=this.environmentIntensity||1,r}else As&&console.warn("Could not find reflection for source",t);break}if((e==null?void 0:e.environmentReflectionSource)===gf.Custom)switch(e==null?void 0:e.ambientMode){case Lo.Trilight:if(e.ambientTrilight){const n=e.ambientTrilight,o=LI(n[0],n[1],n[2],64,64);return o.colorSpace=Vr,o.mapping=Vo,this.context.scene.environment=o,o}else console.error("Missing ambient trilight",e.sourceId);case Lo.Flat:if(e.ambientLight){const n=rv(e.ambientLight,64);return n.colorSpace=Vr,n.mapping=Vo,this.context.scene.environment=n,n}else console.error("Missing ambientlight",e.sourceId)}return null}internalDisableReflection(t){if(t&&t!==this.__currentReflectionId){As&&console.log("Not disabling reflection for",t,"because it is not the current light settings id",this.__currentReflectionId);return}As&&console.log("Disable reflection",t);const e=this.context.scene;e.environment=null}}class NI{constructor(t,e,i=1){a(this,"_source");this._source=e,e.mapping=Vo}get Source(){return this._source}}const yS=k("timescale");let G_=1;typeof yS=="number"&&(G_=yS);class zI{constructor(){a(this,"_time",0);a(this,"_deltaTime",0);a(this,"_deltaTimeUnscaled",0);a(this,"timeScale",1);a(this,"_frame",0);a(this,"clock",new EO);a(this,"_smoothedFps",0);a(this,"_smoothedDeltaTime",0);a(this,"_fpsSamples",[]);a(this,"_fpsSampleIndex",0);typeof G_=="number"&&(this.timeScale=G_)}get time(){return this._time}set time(t){this._time=t}get deltaTime(){return this._deltaTime}set deltaTime(t){this._deltaTime=t}get deltaTimeUnscaled(){return this._deltaTimeUnscaled}get frame(){return this._frame}set frame(t){this._frame=t}get frameCount(){return this.frame}get realtimeSinceStartup(){return this.clock.elapsedTime}get fps(){return 1/this.deltaTime}get smoothedFps(){return this._smoothedFps}get smoothedDeltaTime(){return 1/this._smoothedFps}update(){this.deltaTime=this.clock.getDelta(),this.deltaTime=Math.min(.1,this.deltaTime),this._deltaTimeUnscaled=this.deltaTime,this.deltaTime<=0&&(this.deltaTime=1e-12),this.deltaTime*=this.timeScale,this.frame+=1,this.time+=this.deltaTime,this._fpsSamples.length<60?this._fpsSamples.push(this.deltaTime):this._fpsSamples[this._fpsSampleIndex++%60]=this.deltaTime;let t=0;for(let e=0;e<this._fpsSamples.length;e++)t+=this._fpsSamples[e];this._smoothedDeltaTime=t/this._fpsSamples.length,this._smoothedFps=1/this._smoothedDeltaTime}}let bS=!1;function pT(s){bS||(bS=!0,$I(),VI())}pT();function $I(){const s=`
float startCompression = 0.8;
float desaturation = 0.5;
// Patched tonemapping function
vec3 NeutralToneMapping( vec3 color ) {
    color *= toneMappingExposure;
    
    float d = 1. - startCompression;
    // float peak = dot(color, vec3(0.299, 0.587, 0.114));
    float peak = max(color.r, max(color.g, color.b));
    if (peak < startCompression) return color;
    float newPeak = 1. - d * d / (peak + d - startCompression);
    float invPeak = 1. / peak;
    
    float extraBrightness = dot(color * (1. - startCompression * invPeak), vec3(1, 1, 1));
    
    color *= newPeak * invPeak;
    float g = 1. - 3. / (desaturation * extraBrightness + 3.);
    return mix(color, vec3(1, 1, 1), g);
}
`,t="vec3 NeutralToneMapping( vec3 color ) {",e=`return mix( color, vec3( newPeak ), g );
}`,i=dn.tonemapping_pars_fragment.indexOf(t),n=dn.tonemapping_pars_fragment.indexOf(e,i);if(i>=0&&n>=0){const o=dn.tonemapping_pars_fragment.substring(i,n+e.length);dn.tonemapping_pars_fragment=dn.tonemapping_pars_fragment.replace(o,s)}else X()&&console.error("Couldn't find NeutralToneMapping in ShaderChunk.tonemapping_pars_fragment")}function VI(){const s=`
// 0: Default, 1: Golden, 2: Punchy
#define AGX_LOOK 0        

vec3 userSlope = vec3(1.0);
vec3 userOffset = vec3(0.0);
vec3 userPower = vec3(1.0);
float userSaturation = 1.0;

// Mean error^2: 3.6705141e-06
vec3 _agxDefaultContrastApprox(vec3 x) {
    vec3 x2 = x * x;
    vec3 x4 = x2 * x2;
    
    return  + 15.5     * x4 * x2
            - 40.14    * x4 * x
            + 31.96    * x4
            - 6.868    * x2 * x
            + 0.4298   * x2
            + 0.1191   * x
            - 0.00232;
}

vec3 _agx(vec3 val) {
    const mat3 agx_mat = mat3(
        0.842479062253094, 0.0423282422610123, 0.0423756549057051,
        0.0784335999999992,  0.878468636469772,  0.0784336,
        0.0792237451477643, 0.0791661274605434, 0.879142973793104);
    
    const float min_ev = -12.47393;
    const float max_ev = 4.026069;

    // val = pow(val, vec3(2.2)); 

    // Input transform (inset)
    val = agx_mat * val;
    
    // Log2 space encoding
    val = clamp(log2(val), min_ev, max_ev);
    val = (val - min_ev) / (max_ev - min_ev);
    
    // Apply sigmoid function approximation
    val = _agxDefaultContrastApprox(val);

    return val;
}

vec3 _agxEotf(vec3 val) {
    const mat3 agx_mat_inv = mat3(
        1.19687900512017, -0.0528968517574562, -0.0529716355144438,
        -0.0980208811401368, 1.15190312990417, -0.0980434501171241,
        -0.0990297440797205, -0.0989611768448433, 1.15107367264116);
        
    // Inverse input transform (outset)
    val = agx_mat_inv * val;
    
    // sRGB IEC 61966-2-1 2.2 Exponent Reference EOTF Display
    // NOTE: We're linearizing the output here. Comment/adjust when
    // *not* using a sRGB render target
    val = pow(val, vec3(2.2)); 

    return val;
}

vec3 _agxLook(vec3 val) {
    const vec3 lw = vec3(0.2126, 0.7152, 0.0722);
    float luma = dot(val, lw);
    
    // Default
    vec3 offset = vec3(0.0);
    vec3 slope = vec3(1.0);
    vec3 power = vec3(1.0);
    float sat = 1.0;
    
    #if AGX_LOOK == 1
    // Golden
    slope = vec3(1.0, 0.9, 0.5);
    power = vec3(0.8);
    sat = 0.8;
    #elif AGX_LOOK == 2
    // Punchy
    slope = vec3(1.0);
    power = vec3(1.35, 1.35, 1.35);
    sat = 1.4;
    #endif        
    
    // Needle
    slope = vec3(1.05);
    power = vec3(1.10, 1.10, 1.10);
    sat = 1.15;

    // User
    // slope = userSlope;
    // offset = userOffset;
    // power = userPower;
    // sat = userSaturation;
    
    // ASC CDL
    val = pow(val * slope + offset, power);
    return luma + sat * (val - luma);
}


vec3 AgXToneMapping( vec3 color ) {
    // apply AGX
    color *= toneMappingExposure;
    color = max(color, vec3(0.001)); // Prevent NaN
    color = _agx(color);
    color = _agxLook(color); // Optional
    color = _agxEotf(color);
    return color;
`,t="vec3 AgXToneMapping( vec3 color ) {",e="return color;",i=dn.tonemapping_pars_fragment.indexOf(t),n=dn.tonemapping_pars_fragment.indexOf(e,i);if(i>=0&&n>=0){const o=dn.tonemapping_pars_fragment.substring(i,n+e.length);dn.tonemapping_pars_fragment=dn.tonemapping_pars_fragment.replace(o,s)}else X()&&console.error("Couldn't find AgXToneMapping in ShaderChunk.tonemapping_pars_fragment")}function mT(s){if(typeof s=="string")switch(s=s.toLowerCase(),s){case"none":return gm;case"neutral":return qh;case"aces":return Pg;case"agx":return Cg;case"khronos_neutral":return qh;default:console.warn("[PostProcessing] Unknown tone mapping mode",s);return}}var Tu;(function(s){function t(n){return n==="0"||(n==null?void 0:n.toLowerCase())==="false"}s.isFalsey=t;function e(n,o,r){var c;const l=n.getAttribute(o);return t(l)?null:((c=r==null?void 0:r.onAttribute)==null||c.call(null,l),l)}s.getAttributeValueIfNotFalsey=e;function i(n,o,r){var c,h;const l=n.getAttribute(o);return l===null?null:t(l)?((c=r==null?void 0:r.onAttribute)==null||c.call(null,l,!0),!1):((h=r==null?void 0:r.onAttribute)==null||h.call(null,l,!1),l)}s.getAttributeAndCheckFalsey=i})(Tu||(Tu={}));async function WI(s){var c;if(!globalThis.QRCode){const h="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs@gh-pages/qrcode.min.js";let d=document.head.querySelector(`script[src="${h}"]`);d||(d=document.createElement("script"),d.src=h,document.head.appendChild(d)),await new Promise((u,f)=>{d.addEventListener("load",()=>{u(!0)})})}const t=globalThis.QRCode,e=s.domElement??document.createElement("div"),i=new t(e,{width:s.width??256,height:s.height??256,colorDark:"#000000",colorLight:"#ffffff",correctLevel:s.showLogo?t.CorrectionLevel.H:t.CorrectLevel.M,...s}),n=(i==null?void 0:i._oQRCode.moduleCount)||0,o=(c=i==null?void 0:i._oDrawing)==null?void 0:c._elCanvas;let r=.25;n<40?r=Math.floor(n/4)/n:r=Math.floor(n/6)/n;const l=Math.floor(n/20)/n;try{const h=await HI(o,{showLogo:s.showLogo,logoSize:r,logoPadding:l}).catch(d=>{});h&&(e.innerHTML="",e.append(h))}catch{}if(s.showUrl!==!1&&s.text){const h=e.querySelector(".qr-code-link-label");let d=s.text.replace(/^(https?:\/\/)?(www\.)?/,"").replace(/\/+$/,"").replace(/\?+$/,"");if(d="Scan to visit "+d,h)h.textContent=d;else{const u=document.createElement("div");u.classList.add("qr-code-link-label"),s.text=d,u.textContent=s.text,u.addEventListener("click",f=>{f.stopImmediatePropagation()}),u.style.textAlign="center",u.style.fontSize="0.8em",u.style.marginTop="0.1em",u.style.color="#000000",u.style.fontFamily="'Roboto Flex', sans-serif",u.style.opacity="0.5",u.style.wordBreak="break-all",u.style.wordWrap="break-word",u.style.marginBottom="0.3em",e.style.width="calc(210px + 20px)",e.appendChild(u)}}return e}async function HI(s,t){if(!s)return;const e=8,i=20,n=t.logoPadding||1/32,o="transparent",r=0,l=new Image,c=document.querySelector("needle-engine");c||console.debug("[QR Code] No web component found");const h=jr();let d=null;if(d=Tu.getAttributeAndCheckFalsey(c,"qrcode-logo-src"),h&&t.showLogo!==!0&&d===!1||(d||(d=Tu.getAttributeAndCheckFalsey(c,"logo-src")),h&&t.showLogo!==!0&&d===!1)||(d||(d=Tu.getAttributeAndCheckFalsey(c,"loading-logo-src",{onAttribute:()=>{X()?console.warn("[QR Code] 'loading-logo-src' is deprecated, please use 'logo-src' or 'qrcode-logo-src' instead."):console.debug("[QR Code] 'loading-logo-src' is deprecated.")}})),h&&t.showLogo!==!0&&d===!1)||(d&&!h&&(console.warn("[QR Code] Custom logo is only available with a commercial license. Using default Needle logo. Please get a commercial license at https://needle.tools/pricing."),d=null),d||(d=Zh),!d))return;let u=!1;t.showLogo!==!1&&(l.src=d,u=await new Promise((P,E)=>{l.onload=()=>P(!0),l.onerror=D=>{const M=d!==Zh?"'"+d+"'":null;console.error("[QR Code] Error loading logo image for QR code",M,X()?D:""),P(!1)}}));const f=document.createElement("canvas");f.width=s.width+e,f.height=s.height+e;const p=f.getContext("2d");if(!p)return;p.fillStyle="#ffffff",p.fillRect(0,0,f.width,f.height),p.drawImage(s,e/2,e/2),p.imageSmoothingEnabled=!0,p.imageSmoothingQuality="high",p.mozImageSmoothingEnabled=!0,p.webkitImageSmoothingEnabled=!0,p.globalCompositeOperation="lighten";const b=p.createLinearGradient(0,0,0,f.height);b.addColorStop(0,"rgb(45, 45, 45)"),b.addColorStop(1,"rgb(45, 45, 45)"),p.fillStyle=b,p.fillRect(0,0,f.width,f.height),p.globalCompositeOperation="source-over";let x=Math.min(s.width,s.height)*(t.logoSize||.25),v=x;if(u){const P=l.width/l.height;P>1?v=x/P:x=v*P;const E=n*s.width,D=Math.max(x,v),M=Math.round(D+E),A=Math.round(D+E),G=(f.width-D)/2,V=(f.height-D)/2;p.shadowColor=o,p.shadowBlur=i;const U=r,$=Math.round(G-E/2),Y=Math.round(V-E/2);p.beginPath(),p.moveTo($+U,Y),p.lineTo($+M-U,Y),p.quadraticCurveTo($+M,Y,$+M,Y+U),p.lineTo($+M,Y+A-U),p.quadraticCurveTo($+M,Y+A,$+M-U,Y+A),p.lineTo($+U,Y+A),p.quadraticCurveTo($,Y+A,$,Y+A-U),p.lineTo($,Y+U),p.quadraticCurveTo($,Y,$+U,Y),p.fillStyle="#ffffff",p.closePath(),p.fill(),p.clip(),p.shadowColor="transparent";const B=(f.width-x)/2,N=(f.height-v)/2;p.drawImage(l,B,N,x,v)}const S=f.toDataURL("image/png"),C=document.createElement("img");return C.src=S,C.style.width="100%",C.style.height="auto",C}const q_="Material Symbols Outlined";function Qi(s){const t=document.createElement("span");return t.style.maxWidth="48px",t.style.maxHeight="48px",t.style.overflow="hidden",t.classList.add("material-symbols-outlined","notranslate"),t.setAttribute("translate","no"),t.innerText=s,t.style.visibility="hidden",t.style.userSelect="none",av(q_).then(e=>{e?t.style.visibility="":s==="more_vert"?(t.style.visibility="",t.innerText="More"):t.style.display="none"}),t}function GI(s){var e;return((e=s.classList)==null?void 0:e.contains("material-symbols-outlined"))||!1}const Cp=new Map;async function _S(s){if(await av(q_),Cp.has(s))return Cp.get(s);const t=document.createElement("canvas"),e=48;t.width=e,t.height=e;const i=t.getContext("2d");if(i){i.font=`${e}px '${q_}'`,i.fillStyle="black",i.fillText(s,0,e);const n=t.toDataURL(),o=new _t;return o.name=s+" icon",o.image=new Image,o.image.src=n,o.needsUpdate=!0,Cp.set(s,o),o}return Cp.set(s,null),null}const pb=new Map;async function av(s,t=5,e=0){document.fonts.check(`1em '${s}'`)||await document.fonts.ready;const n=pb.get(s)||document.fonts.load(`1em '${s}'`).then(r=>(r==null?void 0:r.length)>0).finally(()=>{pb.delete(s)});return pb.set(s,n),await n?!0:e<t?new Promise(r=>{setTimeout(()=>{r(av(s,t,e+1))},1e3)}):!1}const lg=class{constructor(){a(this,"_fullscreenButton");a(this,"_muteButton");a(this,"_qrButton");a(this,"_customQRButtonUrl")}static get instance(){return this.getOrCreate()}static getOrCreate(){return this._instance||(this._instance=new lg),this._instance}static create(){return new lg}get fullscreenButton(){return this._fullscreenButton}createFullscreenButton(t){if(this._fullscreenButton)return this._fullscreenButton;if(!document.fullscreenEnabled)return X()&&console.warn("NeedleMenu: Fullscreen button could not be created, device doesn't support the Fullscreen API"),null;const e=document.createElement("button");this._fullscreenButton=e,e.classList.add("fullscreen-button"),e.title="Click to enter fullscreen mode",ja.setElementPriority(e,3);const i=Qi("fullscreen"),n=Qi("fullscreen_exit");return e.appendChild(i),e.onclick=()=>{document.fullscreenElement?document.exitFullscreen():"webkitRequestFullscreen"in t.domElement&&typeof t.domElement.webkitRequestFullscreen=="function"?t.domElement.webkitRequestFullscreen():"requestFullscreen"in t.domElement&&t.domElement.requestFullscreen()},document.addEventListener("fullscreenchange",()=>{document.fullscreenElement?(i.remove(),e.appendChild(n),e.title="Click to enter fullscreen mode"):(n.remove(),e.appendChild(i),e.title="Click to exit fullscreen mode")}),globalThis.addEventListener("needle-xrsession-start",()=>{e.style.display="none"}),globalThis.addEventListener("needle-xrsession-end",()=>{e.style.display=""}),e}get muteButton(){return this._muteButton}createMuteButton(t){if(this._muteButton)return this._muteButton;const e=document.createElement("button");this._muteButton=e,e.classList.add("mute-button"),e.title="Click to mute/unmute";const i=Qi("volume_off"),n=Qi("volume_up");return ja.setElementPriority(e,1),t.application.muted?e.appendChild(i):e.appendChild(n),e.onclick=()=>{t.application.muted?(i.remove(),e.appendChild(n),t.application.muted=!1):(n.remove(),e.appendChild(i),t.application.muted=!0)},e}get qrButton(){return this._qrButton}set qrButtonUrl(t){try{new URL(t),this._customQRButtonUrl=t}catch{console.warn(`[Needle] QR code button URL is not a valid URL '${t}'`)}}get qrButtonUrl(){return this._customQRButtonUrl||window.location.href}createQRCode(t){if(this._qrButton)return this._qrButton;const e=this,i=document.createElement("button");this._qrButton=i,i.innerText="QR Code",i.prepend(Qi("qr_code")),i.title="Scan this QR code with your phone to open this page",this.hideElementDuringXRSession(i),ja.setElementPriority(this._qrButton,20);const n=document.createElement("div");n.style.cssText=`
            position: fixed;
            display: inline-block;
            padding: 0.5rem;
            background-color: white;
            border-radius: 0.4rem;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.2);
        `;const o=document.createElement("div");o.classList.add("qr-code-container"),n.appendChild(o),i.addEventListener("click",()=>{if(n.parentNode)return l();X()&&window.location.href.includes("://localhost")&&qe("To access your website from another device in the same local network you have to use the IP address instead of localhost. The IP address is logged in your development server console when you start the server."),r()});async function r(){var x;await c();const h=document.body.querySelector("needle-engine"),d=((x=t==null?void 0:t.anchorElement)==null?void 0:x.parentElement)||h||document.body;d.appendChild(n);const u=o.getBoundingClientRect(),f=i.getBoundingClientRect();n.style.left=f.left+f.width*.5-u.width*.5+"px";const p=f.top<u.height,b="1.3rem";p?n.style.top=`calc(${f.bottom}px + ${n.style.padding} + 0.0rem)`:n.style.top=`calc(${f.top-u.height}px - ${n.style.padding} - ${b})`,n.style.opacity="0",n.style.pointerEvents="all",n.style.transition="opacity 0.2s ease-in-out",setTimeout(()=>{n.style.opacity="1",window.addEventListener("click",l,{once:!0})}),window.addEventListener("resize",l),window.addEventListener("scroll",l),document.fullscreenElement?document.fullscreenElement.appendChild(n):d.appendChild(n)}function l(){n.style.pointerEvents="none",n.style.transition="opacity 0.2s",n.style.opacity="0",setTimeout(()=>{var h;return(h=n.parentNode)==null?void 0:h.removeChild(n)},500),window.removeEventListener("click",l),window.removeEventListener("resize",l),window.removeEventListener("scroll",l)}async function c(){const d=await WI({text:e.qrButtonUrl,width:200,height:200});o.innerHTML="",o.appendChild(d)}return i.addEventListener("pointerenter",()=>{c()},{once:!0}),i}hideElementDuringXRSession(t){W0(e=>{t["previous-display"]=t.style.display,t.style.display="none"}),U1(e=>{t["previous-display"]!=null&&(t.style.display=t["previous-display"])})}};let Hs=lg;a(Hs,"_instance");function Lm(s,t){const e=(t==null?void 0:t.element)||document.head,i=Array.from(e.querySelectorAll(`link[rel=stylesheet][href*='${s}']`));if(i.length<=0){const n=document.createElement("link");n.href=s,n.rel="stylesheet",e.appendChild(n),i.push(n)}if(t!=null&&t.loadedCallback)for(let n=0;n<i.length;n++)t!=null&&t.loadedCallback&&i[n].addEventListener("load",t.loadedCallback)}function gT(){Lm("https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap")}const X_="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&display=block",Dm="needle-logo-element";class yT extends HTMLElement{constructor(){super();a(this,"_root");a(this,"wrapper");a(this,"logoElement");this._root=this.attachShadow({mode:"closed"});const e=document.createElement("template");e.innerHTML=`<style>
        :host {
            position: relative;
            min-width: fit-content;
            /* height: 100%; can not have height 100% because of align-items: stretch; in the parent */
            display: flex;
        }

        .wrapper {
            position: relative;
            display: grid;
            grid-template-columns: auto auto;
            padding: .1rem;
        }
        .wrapper:hover {
            cursor: pointer;
        }
        img {
            height: 100%;
            align-self: end;
            transition: transform 0.2s;
        }
        img.with-text {
            width: 11.5ch;
            &:hover {
                transform: scale(1.02);
            }
        }
        img.compact {
            width: 1.7em;
            &:hover {
                transform: scale(1.1);
            }
        }
        span {
            font-size: 1rem;
            white-space: nowrap;
        }
        </style>
        <div class="wrapper">
            <img class="logo with-text" src=${Ww} />
        </div>
        `,this._root.appendChild(e.content.cloneNode(!0)),this.wrapper=this._root.querySelector(".wrapper"),this._root.appendChild(this.wrapper),this.logoElement=this._root.querySelector("img.logo"),this.addEventListener("click",()=>{globalThis.open("https://needle.tools","_blank")}),this.wrapper.setAttribute("title","Made with Needle Engine")}static get elementName(){return Dm}static create(){return document.createElement(Dm)}setLogoVisible(e){this.logoElement.style.display=e?"block":"none"}setType(e){e==="full"?(this.logoElement.src=Ww,this.logoElement.classList.remove("with-text"),this.logoElement.classList.remove("compact")):(this.logoElement.src=Zh,this.logoElement.classList.add("with-text"),this.logoElement.classList.add("compact"))}}customElements.get(Dm)||customElements.define(Dm,yT);const mb=k("debugspatialmenu");class qI{constructor(t,e){a(this,"_context");a(this,"needleMenu");a(this,"htmlButtonsMap",new Map);a(this,"enabled",!0);a(this,"userRequestedMenu",!1);a(this,"uiisDirty",!1);a(this,"_showNeedleLogo");a(this,"_wasInXR",!1);a(this,"preRender",()=>{var i;if(!this.enabled){(i=this.menu)==null||i.removeFromParent();return}mb&&Q.isDesktop()&&this.updateMenu();const t=this._context.xr;if(!((t==null?void 0:t.running)&&((t==null?void 0:t.isPassThrough)||(t==null?void 0:t.isVR)))){this._wasInXR&&(this._wasInXR=!1,this.onExitXR());return}this._wasInXR||(this._wasInXR=!0,this.onEnterXR()),this.updateMenu()});a(this,"_menuTarget",new z);a(this,"positionFilter",new x1(90,.5));a(this,"familyName","Needle Spatial Menu");a(this,"menu");a(this,"_poweredByNeedleElement");var n;this._context=t,this._context.pre_render_callbacks.push(this.preRender),this.needleMenu=e;const i=(n=this.needleMenu.shadowRoot)==null?void 0:n.querySelector(".options");i?new MutationObserver(r=>{if(this.enabled&&!(this._context.isInXR==!1&&!mb))for(const l of r)l.type==="childList"&&(l.addedNodes.forEach(c=>{this.createButtonFromHTMLNode(c)}),l.removedNodes.forEach(c=>{const h=c,d=this.htmlButtonsMap.get(h);d&&(this.htmlButtonsMap.delete(h),d.remove(),it.update())}))}).observe(i,{childList:!0}):console.error("Could not find options container in needle menu")}setEnabled(t){var e;this.enabled=t,t||(e=this.menu)==null||e.removeFromParent()}setDisplay(t){return this.enabled?(this.userRequestedMenu=t,!0):!1}onDestroy(){const t=this._context.pre_render_callbacks.indexOf(this.preRender);t>-1&&this._context.pre_render_callbacks.splice(t,1)}markDirty(){this.uiisDirty=!0}showNeedleLogo(t){this._showNeedleLogo=t}onEnterXR(){var e;const t=(e=this.needleMenu.shadowRoot)==null?void 0:e.querySelector(".options");t&&t.childNodes.forEach(i=>{this.createButtonFromHTMLNode(i)})}onExitXR(){var t;(t=this.menu)==null||t.removeFromParent()}createButtonFromHTMLNode(t){const e=this.getMenu(),i=this.htmlButtonsMap.get(t);if(i){i.add();return}if(t instanceof HTMLButtonElement){const n=this.createButton(e,t);this.htmlButtonsMap.set(t,n),n.add()}else t instanceof HTMLSlotElement&&t.assignedNodes().forEach(n=>{this.createButtonFromHTMLNode(n)})}updateMenu(){var o,r;const t=this.getMenu();this.handleNeedleWatermark(),this._context.scene.add(t);const e=this._context.mainCamera,i=this._context.xr,n=(i==null?void 0:i.rigScale)||1;if(e){const l=e.worldPosition,c=e.worldForward.multiplyScalar(-1),h=c.y>.6,d=c.y>.4,u=(t.visible?d:h)||this.userRequestedMenu,f=!t.visible&&u;t.visible=u||Q.isDesktop()&&mb,c.multiplyScalar(3*n),l.add(c),(f||!1)&&(t.position.copy(this._menuTarget.position),t.position.y+=.25,this._menuTarget.position.copy(t.position),this.positionFilter.reset(t.position),t.quaternion.copy(this._menuTarget.quaternion),this.markDirty());const b=this._menuTarget.position.distanceTo(l);(f||b>1.5*n)&&(this.ensureRenderOnTop(this.menu),this._menuTarget.position.copy(l),this._context.scene.add(this._menuTarget),Eg(this._menuTarget,this._context.mainCamera,!0,!0),this._menuTarget.removeFromParent()),this.positionFilter.filter(this._menuTarget.position,t.position,this._context.time.time);const x=5;(o=this.menu)==null||o.quaternion.slerp(this._menuTarget.quaternion,this._context.time.deltaTime*x),(r=this.menu)==null||r.scale.setScalar(n)}this.uiisDirty&&(this.uiisDirty=!1,it.update())}ensureRenderOnTop(t,e=0){t instanceof le&&(t.material.depthTest=!1,t.material.depthWrite=!1),t.renderOrder=1e3+e*2;for(const i of t.children)this.ensureRenderOnTop(i,e+1)}get isVisible(){var t;return(t=this.menu)==null?void 0:t.visible}getMenu(){if(this.menu)return this.menu;this.ensureFont(),this.menu=new it.Block({boxSizing:"border-box",fontFamily:this.familyName,height:"auto",fontSize:.1,color:0,lineHeight:1,backgroundColor:16777215,backgroundOpacity:.55,borderRadius:1,whiteSpace:"pre-wrap",flexDirection:"row",alignItems:"center",padding:new Ne(0,.05,0,.05),borderColor:0,borderOpacity:.05,borderWidth:.005});const t=j.get("ObjectRaycaster");return t&&Lh(this.menu,new t),this.menu}handleNeedleWatermark(){var t;if(!this._poweredByNeedleElement){this._poweredByNeedleElement=new it.Block({width:"auto",height:"auto",fontSize:.05,whiteSpace:"pre-wrap",flexDirection:"row",flexWrap:"wrap",justifyContent:"center",margin:.02,borderRadius:.02,padding:.02,backgroundColor:16777215,backgroundOpacity:1}),this._poweredByNeedleElement["needle:use_eventsystem"]=!0;const e=new vS(this._context,()=>globalThis.open("https://needle.tools","_self"));Lh(this._poweredByNeedleElement,e);const i=new it.Text({textContent:"Powered by",width:"auto",height:"auto"}),n=new it.Text({textContent:"needle",width:"auto",height:"auto",fontSize:.07,margin:new Ne(0,0,0,.02)});this._poweredByNeedleElement.add(i),this._poweredByNeedleElement.add(n),(t=this.menu)==null||t.add(this._poweredByNeedleElement),this.markDirty(),new Wh().load("./include/needle/poweredbyneedle.webp",r=>{var l;if(r){e.allowModifyUI=!1,i.removeFromParent(),n.removeFromParent();const c=r.image.width/r.image.height;(l=this._poweredByNeedleElement)==null||l.set({backgroundImage:r,backgroundOpacity:1,width:.1*c,height:.1}),this.markDirty()}})}if(this.menu){const e=this.menu.children.indexOf(this._poweredByNeedleElement);if(!this._showNeedleLogo&&Dr())e>=0&&(this._poweredByNeedleElement.removeFromParent(),this.markDirty());else{this._poweredByNeedleElement.visible=!0,this.menu.add(this._poweredByNeedleElement);const i=this.menu.children.indexOf(this._poweredByNeedleElement);e!==i&&this.markDirty()}}}ensureFont(){let t=it.FontLibrary.getFontFamily(this.familyName);if(!t){t=it.FontLibrary.addFontFamily(this.familyName);const e=t.addVariant("normal","normal","./include/needle/arial-msdf.json","./include/needle/arial.png");e==null||e.addEventListener("ready",()=>{this.markDirty()})}}createButton(t,e){const i=new it.Block({width:"auto",height:"auto",whiteSpace:"pre-wrap",flexDirection:"row",flexWrap:"wrap",justifyContent:"center",backgroundColor:16777215,backgroundOpacity:0,padding:.02,margin:.01,borderRadius:.02,cursor:"pointer",fontSize:.05}),n=new it.Text({textContent:"",width:"auto",justifyContent:"center",alignItems:"center",backgroundOpacity:0,backgroundColor:16777215,fontFamily:this.familyName,color:0,borderRadius:.02,padding:.01});i.add(n),i["needle:use_eventsystem"]=!0;const o=new vS(this._context,()=>e.click());return Lh(i,o),new XI(this,t,e,i,n)}}class XI{constructor(t,e,i,n,o){a(this,"menu");a(this,"root");a(this,"htmlbutton");a(this,"spatialContainer");a(this,"spatialText");a(this,"spatialIcon");a(this,"_lastText","");a(this,"_lastTexture");this.menu=t,this.root=e,this.htmlbutton=i,this.spatialContainer=n,this.spatialText=o,new MutationObserver(l=>{for(const c of l)c.type==="attributes"?c.attributeName==="style"&&this.updateVisible():c.type==="childList"&&this.updateText()}).observe(i,{attributes:!0,childList:!0}),this.updateText()}add(){this.spatialContainer.parent!=this.root&&(this.root.add(this.spatialContainer),this.menu.markDirty(),this.updateVisible(),this.updateText())}remove(){this.spatialContainer.parent&&(this.spatialContainer.removeFromParent(),this.menu.markDirty())}updateVisible(){const t=this.spatialContainer.visible;this.spatialContainer.visible=this.htmlbutton.style.display!=="none",t!==this.spatialContainer.visible&&this.menu.markDirty()}updateText(){let t="",e="";this.htmlbutton.childNodes.forEach(i=>{i.nodeType===Node.TEXT_NODE?t+=i.textContent:i instanceof HTMLElement&&GI(i)&&i.textContent&&(e=i.textContent)}),this._lastText!==t&&(this._lastText=t,this.spatialText.name=t,this.spatialText.set({textContent:t}),this.menu.markDirty()),t.length<=0?this.spatialText.parent&&(this.spatialText.removeFromParent(),this.menu.markDirty()):this.spatialText.parent||(this.spatialContainer.add(this.spatialText),this.menu.markDirty()),e&&this.createIcon(e)}async createIcon(t){var i;if(!this.spatialIcon){const n=await _S(t);if(n&&!this.spatialIcon){const r=new it.Block({width:.08,height:.08,backgroundColor:16777215,backgroundImage:n,backgroundOpacity:1,margin:new Ne(0,.005,0,0)});this.spatialIcon=r,this.spatialContainer.add(r),this.menu.markDirty()}}if(t!=this._lastTexture){this._lastTexture=t;const n=await _S(t);n&&((i=this.spatialIcon)==null||i.set({backgroundImage:n}),this.menu.markDirty())}const e=this.spatialContainer.children.indexOf(this.spatialIcon);e>0&&(this.spatialContainer.children.splice(e,1),this.spatialContainer.children.unshift(this.spatialIcon),this.menu.markDirty())}}class vS{constructor(t,e){a(this,"isComponent",!0);a(this,"enabled",!0);a(this,"gameObject");a(this,"allowModifyUI",!0);a(this,"context");a(this,"onclick");this.context=t,this.onclick=e}get activeAndEnabled(){return!0}__internalAwake(){}__internalEnable(){}__internalDisable(){}__internalStart(){}onEnable(){}onDisable(){}get element(){return this.gameObject}onPointerEnter(){this.context.input.setCursor("pointer"),this.allowModifyUI&&(this.element.set({backgroundOpacity:1}),it.update())}onPointerExit(){this.context.input.unsetCursor("pointer"),this.allowModifyUI&&(this.element.set({backgroundOpacity:0}),it.update())}onPointerDown(t){t.use()}onPointerUp(t){t.use()}onPointerClick(t){t.use(),this.onclick()}}const Ll="needle-menu",hh=k("debugmenu"),xS=k("debugnoncommercial");let ja=class{constructor(t){a(this,"_context");a(this,"_menu");a(this,"_spatialMenu");a(this,"onPostMessage",t=>{if(t.origin===globalThis.location.origin&&typeof t.data=="object"){const e=t.data,i=e.type;if(i==="needle:menu"){const n=e.button;if(n){if(!n.label)return console.error("NeedleMenu: buttoninfo.label is required");if(!n.onclick)return console.error("NeedleMenu: buttoninfo.onclick is required");const o=document.createElement("button");if(o.textContent=n.label,n.icon){const r=Qi(n.icon);o.prepend(r)}n.priority&&o.setAttribute("priority",n.priority.toString()),o.onclick=()=>{if(n.onclick){const r=n.onclick.startsWith("http")||n.onclick.startsWith("www."),l=n.target||"_blank";r?globalThis.open(n.onclick,l):console.error("NeedleMenu: onclick is not a valid link",n.onclick)}},Tn.sendEvent(this._context,"needle-menu",{action:"button_added_via_postmessage"}),this._menu.appendChild(o)}else hh&&console.error("NeedleMenu: unknown postMessage event",e)}else hh&&console.warn("NeedleMenu: unknown postMessage type",i,e)}});a(this,"onStartXR",t=>{t.session.isScreenBasedAR&&(this._menu.previousParent=this._menu.parentNode,this._context.arOverlayElement.appendChild(this._menu),t.session.session.addEventListener("end",this.onExitXR),this._menu.closeFoldout())});a(this,"onExitXR",()=>{this._menu.previousParent&&(this._menu.previousParent.appendChild(this._menu),delete this._menu.previousParent)});a(this,"_muteButton");a(this,"_fullscreenButton");this._menu=jm.getOrCreate(t.domElement,t),this._context=t,this._spatialMenu=new qI(t,this._menu),window.addEventListener("message",this.onPostMessage),W0(this.onStartXR)}static setElementPriority(t,e){t.setAttribute("priority",String(e))}static getElementPriority(t){const e=t.getAttribute("priority");if(e){const i=Number.parseFloat(e);if(!Number.isNaN(i))return i}}onDestroy(){window.removeEventListener("message",this.onPostMessage),this._menu.remove(),this._spatialMenu.onDestroy()}setPosition(t){this._menu.setPosition(t)}setVisible(t){this._menu.setVisible(t)}showNeedleLogo(t){var e;this._menu.showNeedleLogo(t),(e=this._spatialMenu)==null||e.showNeedleLogo(t)}get logoIsVisible(){return this._menu.logoIsVisible}showSpatialMenu(t){this._spatialMenu.setEnabled(t)}setSpatialMenuVisible(t){this._spatialMenu.setDisplay(t)}get spatialMenuIsVisible(){return this._spatialMenu.isVisible}showQRCodeButton(t){if(t==="desktop-only"&&(t=!Q.isMobileDevice()),t){const e=Hs.getOrCreate().createQRCode();return e.style.display="",this._menu.appendChild(e),e}else{const e=Hs.getOrCreate().qrButton;return e&&(e.style.display="none"),e??null}}showAudioPlaybackOption(t){var e;if(!t){(e=this._muteButton)==null||e.remove();return}this._muteButton=Hs.getOrCreate().createMuteButton(this._context),this._menu.appendChild(this._muteButton)}showFullscreenOption(t){var e;if(!t){(e=this._fullscreenButton)==null||e.remove();return}this._fullscreenButton=Hs.getOrCreate().createFullscreenButton(this._context),this._fullscreenButton&&this._menu.appendChild(this._fullscreenButton)}appendChild(t){return this._menu.appendChild(t)}};var Sf;const nx=class extends HTMLElement{constructor(){var u,f,p,b,x,v,S;super();a(this,"_domElement",null);a(this,"_context",null);a(this,"_sizeChangeInterval");En(this,Sf,e=>{if(!e.defaultPrevented&&e.target==this._domElement&&e instanceof PointerEvent&&e.button===0&&this.root.classList.contains("open")){const i=this.foldout.getBoundingClientRect(),n=e;n.clientX>i.left&&n.clientX<i.right&&n.clientY>i.top&&n.clientY<i.bottom||this.root.classList.toggle("open",!1)}});a(this,"_userRequestedLogoVisible");a(this,"_userRequestedMenuVisible");a(this,"root");a(this,"wrapper");a(this,"options");a(this,"optionsCompactMode");a(this,"logoContainer");a(this,"compactMenuButton");a(this,"foldout");a(this,"trackedElements",new WeakSet);a(this,"_isHandlingChange",!1);a(this,"_pauseMutationObserverOptionsContainer",!1);a(this,"_didSort",new Map);a(this,"_lastAvailableWidthChange",0);a(this,"_timeoutHandleSize",0);a(this,"_timeoutHandleCompactItems",0);a(this,"handleSizeChange",(e,i)=>{if(!this._domElement)return;const n=this._domElement.clientWidth;if(n<100){clearTimeout(this._timeoutHandleSize),this.root.classList.add("compact"),this.foldout.classList.add("floating-panel-style");return}const o=10*2,r=n-o;if(!i&&Math.abs(r-this._lastAvailableWidthChange)<1)return;this._lastAvailableWidthChange=r,clearTimeout(this._timeoutHandleSize),this._timeoutHandleSize=setTimeout(()=>{const d=h();d<0?(this.root.classList.add("compact"),this.foldout.classList.add("floating-panel-style")):d>0&&(this.root.classList.remove("compact"),this.foldout.classList.remove("floating-panel-style"),h()<0&&(this.root.classList.add("compact"),this.foldout.classList.add("floating-panel-style"))),this._pauseMutationObserverOptionsContainer=!0,this.updateCompactFoldoutItem(),window.requestAnimationFrame(()=>this._pauseMutationObserverOptionsContainer=!1)},150);const l=()=>{let d=0;return d+=this.options.getBoundingClientRect().width,d+=this.optionsCompactMode.getBoundingClientRect().width,d+=10*this.options.childElementCount,d+=this.logoContainer.style.display!="none"?this.logoContainer.getBoundingClientRect().width:0,d};let c=-1;const h=()=>{const d=r-l();return hh&&d!==c&&(c=d,at(`Menu space left: ${d.toFixed(0)}px`)),d}});const e=document.createElement("template");e.innerHTML=`<style>

        /** Styling attributes that ensure the nested menu z-index does not cause it to overlay elements outside of <needle-engine> */
        :host {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 0;
            top: 0;
            pointer-events: none;
        }

        /** we put base styles in a layer to allow overrides more easily (e.g. the button.mode requested animation should override the base styles) */
        @layer base {

            #root {
                position: absolute;
                width: auto;
                max-width: 95%;
                left: 50%;
                transform: translateX(-50%);
                top: min(20px, 10vh);
                padding: 0.3rem;
                display: flex;
                visibility: visible;
                flex-direction: row-reverse; /* if we overflow this should be right aligned so the logo is always visible */
                pointer-events: all;
                z-index: 1000;
            }

            /** hide the menu if it's empty **/
            #root.has-no-options.logo-hidden {
                display: none; 
            }

            /** using a div here because then we can change the class for placement **/
            #root.bottom {
                top: auto;
                bottom: min(30px, 10vh);
            }
            #root.top {
                top: calc(.7rem + env(safe-area-inset-top));
            }
            
            .wrapper {
                position: relative;
                display: flex;
                flex-direction: row;
                justify-content: center;
                align-items: stretch;
                gap: 0px;
                padding: 0 0rem;
            }

            .wrapper > *, .options > button, .options > select, ::slotted(*) {
                position: relative;
                border: none;
                border-radius: 0;
                outline: 1px solid rgba(0,0,0,0);
                display: flex;
                justify-content: center;
                align-items: center;
                max-height: 2.3rem;
                max-width: 100%;

                /** basic font settings for all entries **/
                font-size: 1rem;
                font-family: 'Roboto Flex', sans-serif;
                font-optical-sizing: auto;
                font-weight: 400;
                font-variation-settings: "wdth" 100;
                color: rgb(20,20,20);
            }

            .options > select[multiple]:hover {
                max-height: 300px;
            }

            .floating-panel-style {
                background: rgba(255, 255, 255, .4);
                outline: rgb(0 0 0 / 5%) 1px solid;
                border: 1px solid rgba(255, 255, 255, .1);
                box-shadow: 0px 7px 0.5rem 0px rgb(0 0 0 / 6%), inset 0px 0px 1.3rem rgba(0,0,0,.05);
                border-radius: 1.5rem;
                /** 
                 * to make nested background filter work 
                 * https://stackoverflow.com/questions/60997948/backdrop-filter-not-working-for-nested-elements-in-chrome 
                 **/
                &::before {
                    content: '';
                    position: absolute;
                    width: 100%;
                    height: 100%;
                    top: 0;
                    left: 0;
                    z-index: -1;
                    border-radius: 1.5rem;
                    -webkit-backdrop-filter: blur(8px);
                    backdrop-filter: blur(8px);
                }
            }

            a {
                color: inherit;
                text-decoration: none;
            }

            .options {
                display: flex;
                flex-direction: row;
                align-items: center;
            }

            .options > *, ::slotted(*) {
                max-height: 2.25rem;
                padding: .4rem .5rem;
            }
        
            :host .options > *, ::slotted(*) {
                background: transparent;
                border: none;
                white-space: nowrap;
                transition: all 0.1s linear .02s;
                border-radius: 1.5rem;
                user-select: none;
            }
            :host .options > *:hover, ::slotted(*:hover) {
                cursor: pointer;
                color: black;
                background: rgba(245, 245, 245, .8);
                box-shadow: inset 0 0 1rem rgba(0,0,30,.2);
                outline: rgba(0,0,0,.1) 1px solid;
            }
            :host .options > *:active, ::slotted(*:active) {
                background: rgba(255, 255, 255, .8);
                box-shadow: inset 0px 1px 1px rgba(255,255,255,.5), inset 0 0 2rem rgba(0,0,30,.2), inset 0px 2px 4px rgba(0,0,20,.5);
                transition: all 0.05s linear;
            }
            :host .options > *:focus, ::slotted(*:focus) {
                outline: rgba(255,255,255,.5) 1px solid;
            }
            :host .options > *:focus-visible, ::slotted(*:focus-visible) {
                outline: rgba(0,0,0,.5) 1px solid;
            }

            :host .options > *:disabled, ::slotted(*:disabled) {
                background: rgba(0,0,0,.05);
                color: rgba(60,60,60,.7);
                pointer-events: none;
            }
        }

        button, ::slotted(button) {
            gap: 0.3rem;
        }

        /** XR button animation **/
        
        :host button.this-mode-is-requested {
            background: repeating-linear-gradient(to right, #fff 0%, #fff 40%, #aaffff 55%, #fff 80%);
            background-size: 200% auto;
            background-position: 0 100%;
            animation: AnimationName .7s ease infinite forwards;
        }
        :host button.other-mode-is-requested {
            opacity: .5;
        }
        
        @keyframes AnimationName {
            0% { 
                background-position: 0% 0 
            }
            100% { 
                background-position: -200% 0
            }
        }




        .logo {
            cursor: pointer;
            padding-left: 0.5em;
            padding-bottom: .02em;
            margin-right: 0.6em;
        }
        .logo-hidden {
            .logo {
                display: none;
            }
        }
        :host .has-options .logo {
            border-left: 1px solid rgba(40,40,40,.4);
            margin-left: 0.3em;
            margin-right: 0.6em;
        }

        .logo > span {
            white-space: nowrap;
        }



        /** COMPACT */

        /** Hide the menu button normally **/
        .compact-menu-button { display: none; }

        /** Hide the compact only options when not in compact mode */
        .options.compact-only { display: none; }

        /** And show it when we're in compact mode **/
        .compact .compact-menu-button {
            position: relative;
            display: block;
            background: none;
            border: none;
            border-radius: 2rem;

            margin: 0;
            padding: 0 .3rem;
            padding-top: .2rem;

            z-index: 100;

            color: #000;

            &:hover {
                background: rgba(255,255,255,.2);
                cursor: pointer;
            }
            &:focus {
                outline: 1px solid rgba(255,255,255,.5);
            }
            &:focus-visible {
                outline: 1px solid rgba(0,0,0,.5);
            }
            & .expanded-click-area {
                position: absolute;
                left: 0;
                right: 0;
                top: 10%;
                bottom: 10%;
                transform: scale(1.8);
            }
        }  
        .has-no-options .compact-menu-button {
            display: none;
        }
        .open .compact-menu-button {
            background: rgba(255,255,255,.2);
        }
        .logo-visible .compact-menu-button { 
            margin-left: .2rem;
        }
        
        /** Open and hide menu **/
        .compact .foldout { 
            display: none;
        }
        .open .options, .open .foldout {
            display: flex;
            justify-content: center;
        }
        .compact .wrapper {
            padding: 0;
        }
        .compact .wrapper, .compact .options {
            height: auto;
            max-height: initial;
            flex-direction: row;
            gap: .12rem;
        }
        .compact .options { 
            flex-wrap: wrap;
            gap: .3rem;
        }
        .compact .top .options {
            height: auto;
            flex-direction: row;
        }
        .compact .bottom .wrapper {
            height: auto;
            flex-direction: column;
        }

        .compact .foldout {
            max-height: min(100ch, calc(100vh - 100px));
            overflow: auto;
            overflow-x: hidden;
            align-items: center;

            position: fixed;
            bottom: calc(100% + 5px);
            z-index: 100;
            width: auto;
            max-width: 90vw;
            left: 50%;
            transform: translateX(-50%);
            padding: .2rem 1em;

        }
        .compact.logo-hidden .foldout {
            /** for when there's no logo we want to center the foldout **/
            min-width: 24ch;
        }
        
        .compact.top .foldout {
            top: calc(100% + 5px);
            bottom: auto;
        }

        ::-webkit-scrollbar {
            max-width: 7px;
            background: rgba(100,100,100,.2);
            border-radius: .2rem;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, .3);
            border-radius: .2rem;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgb(150,150,150);
        }

        .compact .options > *, .compact .options > ::slotted(*) {
            font-size: 1.2em;
            padding: .6em .5em;
            width: 100%;
        }
        .compact.has-options {
            padding-left: 1em;
        }
        .compact.has-options .logo {
            border: none;
            padding-left: 0;
            margin-bottom: .02em;
        }
        .compact .options.compact-only {
            display: initial;
            & > * {
                min-height: 1em;
                padding: .4em .4em;
            }
        }
        .compact .options {
            /** e.g. if we have a very wide menu item like a select with long option names we don't want to overflow **/
            max-width: 100%;

            & > button, & > select {
                display: flex;
                flex-basis: 100%;
                min-height: 3rem;
            }
            & > button.row2 {
                //border: 1px solid red !important;
                display: flex;
                flex: 1;
                flex-basis: 30%;
            }
        }

        /** If there's really not enough space then just hide all options **/
        @media (max-width: 100px) or (max-height: 100px){
            .foldout {
                display: none !important;
            }
            .compact-menu-button {
                display: none !important;
            }
        }

        </style>
        
        <div id="root" class="logo-hidden floating-panel-style bottom">
            <div class="wrapper">
                <div class="options compact-only" part="options">
                </div>
                <div class="foldout">
                    <div class="options main-container" part="options">
                        <slot></slot>
                    </div>
                    <div class="options" part="options">
                        <slot name="end"></slot>
                    </div>
                </div>
                <div style="user-select:none;" class="logo">
                    <span class="madewith notranslate" style="display:none;">powered by</span>
                </div>
            </div>
            <button class="compact-menu-button">
                <div class="expanded-click-area"></div>
            </button>
        </div>
        `;const i=this.attachShadow({mode:"open"});gT(),Lm(X_,{loadedCallback:()=>{this.handleSizeChange()}}),Lm(X_,{element:i});const n=e.content.cloneNode(!0);i==null||i.appendChild(n),this.root=i.querySelector("#root"),this.wrapper=(u=this.root)==null?void 0:u.querySelector(".wrapper"),this.options=(f=this.root)==null?void 0:f.querySelector(".options.main-container"),this.optionsCompactMode=(p=this.root)==null?void 0:p.querySelector(".options.compact-only"),this.logoContainer=(b=this.root)==null?void 0:b.querySelector(".logo"),this.compactMenuButton=(x=this.root)==null?void 0:x.querySelector(".compact-menu-button"),this.compactMenuButton.append(Qi("more_vert")),this.foldout=(v=this.root)==null?void 0:v.querySelector(".foldout"),(S=this.root)==null||S.appendChild(this.wrapper),this.wrapper.classList.add("wrapper");const o=yT.create();o.setType("compact"),o.style.minHeight="1rem",this.logoContainer.append(o),this.logoContainer.addEventListener("click",()=>{globalThis.open("https://needle.tools","_blank")});try{window.requestAnimationFrame(()=>nL(C=>{if(C==!0&&jr()&&!xS){let P=this._userRequestedLogoVisible;P===void 0&&(P=!1),this.___onSetLogoVisible(P)}else this.___onSetLogoVisible(!0)}))}catch(C){console.error("[Needle Menu] License check failed.",C)}this.compactMenuButton.addEventListener("click",C=>{C.preventDefault(),this.root.classList.toggle("open")});let r=this._context;setTimeout(()=>r=this._context);let l=0;const c=(C,P)=>{var E,D,M;hh&&console.log("Set menu visible",P),r!=null&&r.isInAR&&r.arOverlayElement?C!=r.arOverlayElement&&r.arOverlayElement.appendChild(this):this.parentNode!=((E=this._domElement)==null?void 0:E.shadowRoot)&&((M=(D=this._domElement)==null?void 0:D.shadowRoot)==null||M.appendChild(this)),this.style.display=P?"flex":"none",this.style.visibility="visible",this.style.opacity="1"};let h=!1;new MutationObserver(C=>{var P;if(!h)try{h=!0,this.onChangeDetected(C);const E=this==null?void 0:this.parentNode;if((this.style.display!="flex"||this.style.visibility!="visible"||this.style.opacity!="1"||E!=((P=this._domElement)==null?void 0:P.shadowRoot))&&!jr()){const D=l++;_s()&&this._userRequestedMenuVisible===!1?(D===0&&c(E,this._userRequestedMenuVisible),D===1&&console.warn("Needle Menu Warning: You need a PRO license to hide the Needle Engine menu ‚Üí The menu will be visible in your deployed website if you don't have a PRO license. See https://needle.tools/pricing for details.")):D===0?c(E,!0):setTimeout(()=>c(E,!0),5)}}finally{h=!1}}).observe(this.root,{childList:!0,subtree:!0,attributes:!0}),hh&&this.___insertDebugOptions()}static create(){return document.createElement(Ll,{is:Ll})}static getOrCreate(e,i){let n=e.querySelector(Ll);return!n&&e.shadowRoot&&(n=e.shadowRoot.querySelector(Ll)),n||(n=window.document.body.querySelector(Ll)),n||(n=nx.create(),e.shadowRoot?e.shadowRoot.appendChild(n):e.appendChild(n)),n._domElement=e,n._context=i,n}connectedCallback(){window.addEventListener("resize",this.handleSizeChange),this.handleMenuVisible(),this._sizeChangeInterval=setInterval(()=>this.handleSizeChange(void 0,!1),5e3),setTimeout(()=>{var e,i;(e=this._domElement)==null||e.addEventListener("resize",this.handleSizeChange),(i=this._domElement)==null||i.addEventListener("click",ke(this,Sf))},1)}disconnectedCallback(){var e,i;window.removeEventListener("resize",this.handleSizeChange),clearInterval(this._sizeChangeInterval),(e=this._domElement)==null||e.removeEventListener("resize",this.handleSizeChange),(i=this._context)==null||i.domElement.removeEventListener("click",ke(this,Sf))}showNeedleLogo(e){this._userRequestedLogoVisible=e,!(!e&&(!jr()||xS)&&(console.warn("[Needle Engine] You need a PRO license to hide the Needle Engine logo in production."),!_s()))&&this.___onSetLogoVisible(e)}get logoIsVisible(){return!this.root.classList.contains("logo-hidden")}___onSetLogoVisible(e){this.logoContainer.style.display="",this.logoContainer.style.opacity="1",this.logoContainer.style.visibility="visible",e?(this.root.classList.remove("logo-hidden"),this.root.classList.add("logo-visible")):(this.root.classList.remove("logo-visible"),this.root.classList.add("logo-hidden"))}setPosition(e){if(e!=="top"&&e!=="bottom")return console.error("NeedleMenu.setPosition: invalid position",e);this.root.classList.remove("top","bottom"),this.root.classList.add(e)}setVisible(e){this._userRequestedMenuVisible=e,this.style.display=e?"flex":"none"}closeFoldout(){this.root.classList.remove("open")}trackElement(e){this.trackedElements.has(e)||(this.trackedElements.add(e),e.addEventListener("click",i=>{Tn.sendEvent(this._context,"needle-menu",{action:"button_clicked",element:i.target instanceof Node?i.target.nodeName:e.nodeName,label:e.textContent,title:e instanceof HTMLElement?e.title:void 0,pointerid:i instanceof PointerEvent?i.pointerId:void 0})}))}append(...e){for(const i of e)if(typeof i=="string"){const n=document.createTextNode(i);this.trackElement(n),this.options.appendChild(n)}else this.trackElement(i),this.options.appendChild(i)}appendChild(e){var n;if(!(e instanceof Node)){const o=document.createElement("button");if(o.textContent=e.label,o.onclick=e.onClick,o.setAttribute("priority",((n=e.priority)==null?void 0:n.toString())??"0"),e.title&&(o.title=e.title),e.icon){const r=Qi(e.icon);e.iconSide==="right"?o.appendChild(r):o.prepend(r)}e.class&&o.classList.add(e.class),e=o}return this.trackElement(e),this.options.appendChild(e)}prepend(...e){for(const i of e)if(typeof i=="string"){const n=document.createTextNode(i);this.trackElement(n),this.options.prepend(n)}else this.trackElement(i),this.options.prepend(i)}onChangeDetected(e){if(!this._isHandlingChange){this._isHandlingChange=!0;try{this.handleMenuVisible();for(const i of e)i.target==this.options&&(this._pauseMutationObserverOptionsContainer||this.onOptionsChildrenChanged(i))}finally{this._isHandlingChange=!1}}}onOptionsChildrenChanged(e){if(this.root.classList.toggle("has-options",this.hasAnyVisibleOptions),this.root.classList.toggle("has-no-options",!this.hasAnyVisibleOptions),this.handleSizeChange(void 0,!0),e.type==="childList"&&e.addedNodes.length>0){const i=Array.from(this.options.children);i.sort((o,r)=>{const l=parseInt(o.getAttribute("priority")||"0"),c=parseInt(r.getAttribute("priority")||"0");return l-c});let n=!1;for(let o=0;o<i.length;o++){const r=this.options.children[o],l=i[o];if(r!==l){n=!0;break}}if(n)for(const o of i)this.options.appendChild(o)}}handleMenuVisible(){hh&&console.log("Update VisibleState: Any Content?",this.hasAnyContent),this.hasAnyContent?this.root.style.display="":this.root.style.display="none",this.root.classList.toggle("has-options",this.hasAnyVisibleOptions),this.root.classList.toggle("has-no-options",!this.hasAnyVisibleOptions)}get hasAnyContent(){return!!(this.logoContainer.style.display!="none"||this.hasAnyVisibleOptions)}get hasAnyVisibleOptions(){for(let e=0;e<this.options.children.length;e++){const i=this.options.children[e];if(i.tagName==="SLOT"){const o=i.assignedNodes();for(const r of o)if(r instanceof HTMLElement&&r.style.display!="none")return!0}else if(i.style.display!="none")return!0}return!1}updateCompactFoldoutItem(){if(this.root.classList.contains("compact")){let e=null,i=-1e7;const n=o=>{if(o instanceof HTMLElement){const r=ja.getElementPriority(o);if(r!==void 0&&r>=i){const l=window.getComputedStyle(o);if(l.display==="none"||l.visibility==="hidden"||l.opacity==="0")return;e=o,i=r}}};for(let o=0;o<this.options.children.length;o++)n(this.options.children.item(o));for(let o=0;o<this.optionsCompactMode.children.length;o++)n(this.optionsCompactMode.children.item(o));if(e&&!this.optionsCompactMode.contains(e)){this.optionsCompactMode.childNodes.forEach(r=>{this.options.appendChild(r)});const o=e;this.optionsCompactMode.appendChild(o)}else e||this.optionsCompactMode.childNodes.forEach(o=>{this.options.appendChild(o)})}else this.optionsCompactMode.childNodes.forEach(e=>{this.options.appendChild(e)})}___insertDebugOptions(){window.addEventListener("keydown",n=>{n.key==="p"&&this.setPosition(this.root.classList.contains("top")?"bottom":"top")});const e=document.createElement("button");e.textContent="Hide Buttons",e.onclick=()=>{const n=new Array(this.options.children.length);for(let o=0;o<this.options.children.length;o++)n[o]=this.options.children[o];for(const o of n)this.options.removeChild(o);setTimeout(()=>{for(const o of n)this.options.appendChild(o)},1e3)},this.appendChild(e);const i=document.createElement("button");i.textContent="Toggle Logo",i.addEventListener("click",()=>{this.logoContainer.style.display=this.logoContainer.style.display==="none"?"":"none"}),this.appendChild(i)}};let jm=nx;Sf=new WeakMap;customElements.get(Ll)||customElements.define(Ll,jm);const Ut=k("debugcontext"),QI=k("stats"),YI=k("debugactive"),KI=k("debugframerate"),ZI=k("debugcoroutine"),M4={};class A4{constructor(){a(this,"name");a(this,"alias");a(this,"hash");a(this,"runInBackground");a(this,"domElement");a(this,"renderer");a(this,"camera");a(this,"scene")}}var ge;(function(s){s[s.Start=-1]="Start",s[s.EarlyUpdate=0]="EarlyUpdate",s[s.Update=1]="Update",s[s.LateUpdate=2]="LateUpdate",s[s.OnBeforeRender=3]="OnBeforeRender",s[s.OnAfterRender=4]="OnAfterRender",s[s.PrePhysicsStep=9]="PrePhysicsStep",s[s.PostPhysicsStep=10]="PostPhysicsStep",s[s.Undefined=-1]="Undefined"})(ge||(ge={}));function lv(s,t){if(!s)return;if(!s.isComponent){(X()||Ut)&&console.error(`Registered script is not a Needle Engine component. 
The script will be ignored. Please make sure your component extends "Behaviour" imported from "@needle-tools/engine"
`,s);return}t||(t=de.Current,Ut&&console.warn("> Registering component without context"));const e=t==null?void 0:t.new_scripts;e.includes(s)||e.push(s)}const et=class{constructor(t){a(this,"name");a(this,"alias");a(this,"isManagedExternally",!1);a(this,"isPaused",!1);a(this,"runInBackground",!1);a(this,"targetFrameRate");a(this,"physicsSteps",1);a(this,"hash");a(this,"domElement");a(this,"_resolutionScaleFactor",1);a(this,"_boundingClientRectFrame",-1);a(this,"_boundingClientRect",null);a(this,"_domX");a(this,"_domY");a(this,"xr",null);a(this,"_xrFrame",null);a(this,"_currentFrameEvent",ge.Undefined);a(this,"scene");a(this,"renderer");a(this,"composer",null);a(this,"scripts",[]);a(this,"scripts_pausedChanged",[]);a(this,"scripts_earlyUpdate",[]);a(this,"scripts_update",[]);a(this,"scripts_lateUpdate",[]);a(this,"scripts_onBeforeRender",[]);a(this,"scripts_onAfterRender",[]);a(this,"scripts_WithCorroutines",[]);a(this,"scripts_immersive_vr",[]);a(this,"scripts_immersive_ar",[]);a(this,"coroutines",{});a(this,"post_setup_callbacks",[]);a(this,"pre_update_callbacks",[]);a(this,"pre_render_callbacks",[]);a(this,"post_render_callbacks",[]);a(this,"pre_update_oneshot_callbacks",[]);a(this,"new_scripts",[]);a(this,"new_script_start",[]);a(this,"new_scripts_pre_setup_callbacks",[]);a(this,"new_scripts_post_setup_callbacks",[]);a(this,"new_scripts_xr",[]);a(this,"mainCameraComponent");a(this,"_mainCamera",null);a(this,"_fallbackCamera",null);a(this,"application");a(this,"animations");a(this,"time");a(this,"input");a(this,"physics");a(this,"connection");a(this,"assets");a(this,"mainLight",null);a(this,"sceneLighting");a(this,"addressables");a(this,"lightmaps");a(this,"players");a(this,"lodsManager");a(this,"menu");a(this,"_needsUpdateSize",!1);a(this,"_isCreated",!1);a(this,"_isCreating",!1);a(this,"_isVisible",!1);a(this,"_stats",QI?new Bk:null);a(this,"_intersectionObserver",null);a(this,"_disposeCallbacks",[]);a(this,"maxRenderResolution");a(this,"_devicePixelRatio","auto");a(this,"_originalCreationArgs");a(this,"onUnhandledRejection",t=>{this.onError(t.reason)});a(this,"_cameraStack",[]);a(this,"_onBeforeRenderListeners",new Map);a(this,"_onAfterRenderListeners",new Map);a(this,"_requireDepthTexture",!1);a(this,"_requireColorTexture",!1);a(this,"_renderTarget");a(this,"_isRendering",!1);a(this,"_needsVisibleUpdate",!0);a(this,"_lastStyleComputedResult");a(this,"_createId",0);a(this,"rootSceneSourceIdentifiers",[]);a(this,"_renderlooperrors",0);a(this,"focusRectSettings",{damping:0,zoom:1,offsetX:0,offsetY:0});a(this,"_focusRect",null);a(this,"_lastTimestamp",0);a(this,"_accumulatedTime",0);a(this,"_dispatchReadyAfterFrame",!1);a(this,"_tempClearColor",new Se);a(this,"_tempClearColor2",new Se);a(this,"_contextRestoreTries",0);a(this,"_wasPaused",!1);this.name=(t==null?void 0:t.name)||"",this.alias=t==null?void 0:t.alias,this.domElement=(t==null?void 0:t.domElement)||document.body,this.hash=t==null?void 0:t.hash,t!=null&&t.renderer&&(this.renderer=t.renderer,this.isManagedExternally=!0),(t==null?void 0:t.runInBackground)!==void 0&&(this.runInBackground=t.runInBackground),t!=null&&t.scene?this.scene=t.scene:this.scene=new Xn,t!=null&&t.camera&&(this._mainCamera=t.camera),this.application=new Xs(this),this.time=new zI,this.input=new zM(this),this.physics=new xu(this),this.connection=new DA(this),this.assets=new r2,this.sceneLighting=new UI(this),this.addressables=new xI(this),this.lightmaps=new kI(this),this.players=new AI(this),this.menu=new ja(this),this.lodsManager=new fT(this),this.animations=new TI(this);const e=()=>this._needsUpdateSize=!0;window.addEventListener("resize",e),this._disposeCallbacks.push(()=>window.removeEventListener("resize",e));const i=new ResizeObserver(n=>this._needsUpdateSize=!0);i.observe(this.domElement),this._disposeCallbacks.push(()=>i.disconnect()),this._intersectionObserver=new IntersectionObserver(n=>{this._isVisible=n[0].isIntersecting}),this._disposeCallbacks.push(()=>{var n;return(n=this._intersectionObserver)==null?void 0:n.disconnect()}),Be.register(this)}static get DefaultTargetFrameRate(){return et._defaultTargetFramerate.value}static set DefaultTargetFrameRate(t){et._defaultTargetFramerate.value=t}static get DefaultWebGLRendererParameters(){return et._defaultWebglRendererParameters}get version(){return Gn}static get Current(){return Be.Current}static set Current(t){Be.Current=t}static get All(){return Be.All}appendHTMLElement(t){return this.domElement.shadowRoot?this.domElement.shadowRoot.appendChild(t):this.domElement.appendChild(t)}get resolutionScaleFactor(){return this._resolutionScaleFactor}set resolutionScaleFactor(t){if(t!==this._resolutionScaleFactor&&typeof t=="number"){if(t<=0){console.error("Invalid resolution scale factor",t);return}this._resolutionScaleFactor=t,this.updateSize()}}calculateBoundingClientRect(){if(this.xr){this._domX=0,this._domY=0;return}this._boundingClientRectFrame!==this.time.frame&&(this._boundingClientRectFrame=this.time.frame,this._boundingClientRect=this.domElement.getBoundingClientRect(),this._domX=this._boundingClientRect.x,this._domY=this._boundingClientRect.y)}get domWidth(){return this.isInAR?window.innerWidth:this.domElement.clientWidth}get domHeight(){return this.isInAR?window.innerHeight:this.domElement.clientHeight}get domX(){return this.calculateBoundingClientRect(),this._domX}get domY(){return this.calculateBoundingClientRect(),this._domY}get isInXR(){var t,e;return((e=(t=this.renderer)==null?void 0:t.xr)==null?void 0:e.isPresenting)||!1}get xrSessionMode(){var t;return(t=this.xr)==null?void 0:t.mode}get isInVR(){return this.xrSessionMode==="immersive-vr"}get isInAR(){return this.xrSessionMode==="immersive-ar"}get isInPassThrough(){return this.xr?this.xr.isPassThrough:!1}get xrSession(){var t,e;return(e=(t=this.renderer)==null?void 0:t.xr)==null?void 0:e.getSession()}get xrFrame(){return this._xrFrame}get xrCamera(){var t,e;return this.renderer.xr.isPresenting?(e=(t=this.renderer)==null?void 0:t.xr)==null?void 0:e.getCamera():void 0}get arOverlayElement(){const t=this.domElement;return typeof t.getAROverlayContainer=="function"?t.getAROverlayContainer():this.domElement}get currentFrameEvent(){return this._currentFrameEvent}get mainCamera(){if(this._mainCamera)return this._mainCamera;if(this.mainCameraComponent){const t=this.mainCameraComponent;return t.threeCamera||t.buildCamera(),t.threeCamera}return this._fallbackCamera||(this._fallbackCamera=new Ae(75,this.domWidth/this.domHeight,.1,1e3)),this._fallbackCamera}set mainCamera(t){this._mainCamera=t}get rendererData(){return this.sceneLighting}get isCreated(){return this._isCreated}get rootSourceId(){return this.rootSceneSourceIdentifiers[0]||void 0}createNewRenderer(t){var e,i,n;if((e=this.renderer)==null||e.dispose(),t={...et.DefaultWebGLRendererParameters,...t},!t.canvas){const o=(n=(i=this.domElement)==null?void 0:i.shadowRoot)==null?void 0:n.querySelector("canvas");o&&(t.canvas=o,Ut&&console.log("Using canvas from shadow root",o))}return Ut&&console.log("Using Renderer Parameters:",t,this.domElement),this.renderer=new gc(t),this.renderer.debug.checkShaderErrors=X()||k("checkshadererrors")===!0,this.renderer.toneMappingExposure=1,this.renderer.toneMapping=gm,this.renderer.setClearColor(new Se("lightgrey"),0),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=MO,this.renderer.setSize(this.domWidth,this.domHeight),this.renderer.outputColorSpace=Vr,this.renderer.nodes={library:new AO,modelViewMatrix:null,modelNormalViewMatrix:null},this.lodsManager.setRenderer(this.renderer),this.input.bindEvents(),kM(this,this.renderer.domElement),this.renderer}internalOnUpdateVisible(){var t,e;(t=this._intersectionObserver)==null||t.disconnect(),(e=this._intersectionObserver)==null||e.observe(this.domElement)}requestSizeUpdate(){this._needsUpdateSize=!0}get devicePixelRatio(){return this._devicePixelRatio}set devicePixelRatio(t){t!==this._devicePixelRatio&&(this._devicePixelRatio=t,this._needsUpdateSize=!0)}updateSize(t=!1){var e,i,n;if(t||!this.isManagedExternally&&((e=this.renderer.xr)==null?void 0:e.isPresenting)===!1){this._needsUpdateSize=!1;const o=this.resolutionScaleFactor;let r=this.domWidth*o,l=this.domHeight*o;this.maxRenderResolution&&(this.maxRenderResolution.x=Math.max(1,this.maxRenderResolution.x),r=Math.min(this.maxRenderResolution.x,r),this.maxRenderResolution.y=Math.max(1,this.maxRenderResolution.y),l=Math.min(this.maxRenderResolution.y,l));const c=this.mainCamera;this.updateAspect(c),this.renderer.setSize(r,l,!0),this.renderer.domElement.style.width="100%",this.renderer.domElement.style.height="100%";const h=typeof this.devicePixelRatio=="number"?this.devicePixelRatio:this.devicePixelRatio==="auto"?Math.min(2,window.devicePixelRatio):void 0;h!==void 0&&this.renderer.setPixelRatio(h),this.composer&&((i=this.composer.setSize)==null||i.call(this.composer,r,l),h!==void 0&&"setPixelRatio"in this.composer&&typeof this.composer.setPixelRatio=="function"&&((n=this.composer.setPixelRatio)==null||n.call(this.composer,window.devicePixelRatio)))}}updateAspect(t,e,i){if(!t)return;e===void 0&&(e=this.domWidth),i===void 0&&(i=this.domHeight);const n=e/i;if(t.isPerspectiveCamera){const o=t,r=o.aspect;o.aspect=n,r!==o.aspect&&t.updateProjectionMatrix()}else if(t.isOrthographicCamera){const o=t,r=o.top-o.bottom,c=r*n/2,h=r/2;(o.left!=-c||o.top!=h)&&(o.left=-c,o.right=c,o.top=h,o.bottom=-h,t.updateProjectionMatrix())}}recreate(){this.clear(),this.create(this._originalCreationArgs)}async onCreate(t){return this.create(t)}async create(t){try{this._isCreating=!0,t!==this._originalCreationArgs&&(this._originalCreationArgs=Og(t)),window.addEventListener("unhandledrejection",this.onUnhandledRejection);const e=await this.internalOnCreate(t);return this._isCreated=e,e}finally{window.removeEventListener("unhandledrejection",this.onUnhandledRejection),this._isCreating=!1}}onError(t){this.domElement.dispatchEvent(new CustomEvent("error",{detail:t}))}clear(){var t,e,i,n;Be.dispatchCallback(Me.ContextClearing,this),ho(this,Me.ContextClearing),xs(this.scene,!0,!0),this.scene=new Xn,(t=this.addressables)==null||t.dispose(),(e=this.lightmaps)==null||e.clear(),(n=(i=this.physics)==null?void 0:i.engine)==null||n.clearCaches(),this.lodsManager.disable(),this._onBeforeRenderListeners.clear(),this._onAfterRenderListeners.clear(),this.isManagedExternally||this.renderer&&(this.renderer.renderLists.dispose(),this.renderer.state.reset(),this.renderer.resetState()),Be.dispatchCallback(Me.ContextCleared,this)}dispose(){this.internalOnDestroy()}onDestroy(){this.internalOnDestroy()}internalOnDestroy(){var t,e;et.Current=this,Be.dispatchCallback(Me.ContextDestroying,this),ho(this,Me.ContextDestroying),this.clear(),(t=this.renderer)==null||t.setAnimationLoop(null),this.renderer&&(this.renderer.setClearAlpha(0),this.renderer.clear(),this.isManagedExternally||(Ut&&console.log("Disposing renderer"),this.renderer.dispose())),this.scene=null,this.renderer=null,this.input.dispose(),this.menu.onDestroy(),this.animations.onDestroy();for(const i of this._disposeCallbacks)try{i()}catch(n){console.error("Error in on dispose callback:",n,i)}(e=this.domElement)!=null&&e.parentElement&&this.domElement.parentElement.removeChild(this.domElement),this._isCreated=!1,Be.dispatchCallback(Me.ContextDestroyed,this),ho(this,Me.ContextDestroyed),Be.unregister(this),et.Current===this&&(et.Current=null)}registerCoroutineUpdate(t,e,i){return typeof(e==null?void 0:e.next)!="function"?(console.error("Registered invalid coroutine function from "+t.name+`
Coroutine functions must be generators: "*myCoroutine() {...}"
Start a coroutine from a component by calling "this.startCoroutine(myCoroutine())"`),e):(this.coroutines[i]||(this.coroutines[i]=[]),this.coroutines[i].push({comp:t,main:e}),e)}unregisterCoroutineUpdate(t,e){if(!this.coroutines[e])return;const i=this.coroutines[e].findIndex(n=>n.main===t);i>=0&&this.coroutines[e].splice(i,1)}stopAllCoroutinesFrom(t){for(const e in this.coroutines){const i=this.coroutines[e];for(let n=i.length-1;n>=0;n--)i[n].comp===t&&i.splice(n,1)}}setCurrentCamera(t){var n;if(!t)return;if(t.threeCamera||t.buildCamera(),!t.threeCamera){console.warn("Camera component is missing camera",t);return}const e=this._cameraStack.indexOf(t);e>=0&&this._cameraStack.splice(e,1),this._cameraStack.push(t),this.mainCameraComponent=t;const i=t.threeCamera;i.isPerspectiveCamera&&this.updateAspect(i),(n=this.mainCameraComponent)==null||n.applyClearFlagsIfIsActiveCamera()}removeCamera(t){if(!t)return;const e=this._cameraStack.indexOf(t);if(e>=0&&this._cameraStack.splice(e,1),this.mainCameraComponent===t&&(this.mainCameraComponent=void 0,this._cameraStack.length>0)){const i=this._cameraStack[this._cameraStack.length-1];this.setCurrentCamera(i)}}addBeforeRenderListener(t,e){if(!this._onBeforeRenderListeners.has(t.uuid)){const i=[];this._onBeforeRenderListeners.set(t.uuid,i),t.onBeforeRender=this._createRenderCallbackWrapper(i)}this._onBeforeRenderListeners.get(t.uuid).push(e)}removeBeforeRenderListener(t,e){if(this._onBeforeRenderListeners.has(t.uuid)){const i=this._onBeforeRenderListeners.get(t.uuid),n=i.indexOf(e);n>=0&&i.splice(n,1)}}addAfterRenderListener(t,e){var i;if(!this._onAfterRenderListeners.has(t.uuid)){const n=[];this._onAfterRenderListeners.set(t.uuid,n),t.onAfterRender=this._createRenderCallbackWrapper(n)}(i=this._onAfterRenderListeners.get(t.uuid))==null||i.push(e)}removeAfterRenderListener(t,e){if(this._onAfterRenderListeners.has(t.uuid)){const i=this._onAfterRenderListeners.get(t.uuid),n=i.indexOf(e);n>=0&&i.splice(n,1)}}_createRenderCallbackWrapper(t){return(e,i,n,o,r,l)=>{for(let c=0;c<t.length;c++){const h=t[c];h(e,i,n,o,r,l)}}}get isRendering(){return this._isRendering}setRequireDepth(t){this._requireDepthTexture=t}setRequireColor(t){this._requireColorTexture=t}get depthTexture(){var t;return((t=this._renderTarget)==null?void 0:t.depthTexture)||null}get opaqueColorTexture(){var t;return((t=this._renderTarget)==null?void 0:t.texture)||null}get isVisibleToUser(){if(this.isInXR)return!0;if(!this._isVisible)return!1;if(!this._needsVisibleUpdate&&this._lastStyleComputedResult!==void 0)return this._lastStyleComputedResult;this._needsVisibleUpdate=!1;const t=getComputedStyle(this.domElement);return this._lastStyleComputedResult=t.visibility!=="hidden"&&t.display!=="none"&&t.opacity!=="0",this._lastStyleComputedResult}async internalOnCreate(t){var d,u,f,p,b,x,v;const e=++this._createId;Ut&&console.log("Creating context",this.name,t);const i=globalThis["needle:dependencies:ready"];i instanceof Promise&&(Ut&&console.log("Waiting for dependencies to be ready"),await i.catch(S=>{if(Ut||X()){if(Ag("Needle Engine dependencies failed to load. Please check the console for more details"),S instanceof ReferenceError){let C="YourComponentName";const P=S.message.indexOf("'");if(P>0){const E=S.message.indexOf("'",P+1);if(E>0){const D=S.message.substring(P+1,E);D.length>3&&(C=D)}}console.error(`Needle Engine dependencies failed to load:

# Make sure you don't have circular imports in your scripts!

Possible solutions: 
‚Üí Replace @serializable(${C}) in your script with @serializable(Behaviour)
‚Üí If you only need type information try importing the type only, e.g: import { type ${C} }

---`,S);return}console.error("Needle Engine dependencies failed to load",S)}}).then(()=>{Ut&&console.log("Needle Engine dependencies are ready")})),this.clear();const n=this.renderer,o=!n||n.isDisposed===!0;this.isManagedExternally===!1&&o?this.createNewRenderer():this.lodsManager.setRenderer(this.renderer),(d=this.renderer)==null||d.setAnimationLoop(null),et.Current=this,await Be.dispatchCallback(Me.ContextCreationStart,this);let r=!0,l;try{et.Current=this,t?l=await this.internalLoadInitialContent(e,t):l=[]}catch(S){console.error(S),r=!1}if(!r)return this.onError("Failed to load initial content"),!1;if(e!==this._createId||(u=t==null?void 0:t.abortSignal)!=null&&u.aborted)return!1;if(this.internalOnUpdateVisible(),!this.renderer)return Ut&&console.warn("Context has no renderer (perhaps it was disconnected?",this.domElement.isConnected),!1;!this.isManagedExternally&&!this.domElement.shadowRoot&&this.domElement.prepend(this.renderer.domElement),et.Current=this,et.Current=this;for(let S=0;S<this.new_scripts.length;S++){const C=this.new_scripts[S];if(C.gameObject!==void 0&&C.gameObject!==null){C.gameObject.userData===void 0&&(C.gameObject.userData={}),C.gameObject.userData.components===void 0&&(C.gameObject.userData.components=[]);const P=C.gameObject.userData.components;P.includes(C)||P.push(C)}}if(this.post_setup_callbacks)for(let S=0;S<this.post_setup_callbacks.length;S++)et.Current=this,await this.post_setup_callbacks[S](this);if(!this._mainCamera){et.Current=this;let S=null;id(this.scene,C=>{const P=C;if(P!=null&&P.isCamera){if(Su(P.gameObject),!P.activeAndEnabled)return;if(P.tag==="MainCamera")return S=P,!0;S=P}}),S?this.setCurrentCamera(S):!Be.dispatchCallback(Me.MissingCamera,this,{files:l})&&!this.mainCamera&&!this.isManagedExternally&&console.warn("Missing camera in main scene",this)}this.input.bindEvents(),et.Current=this,km(this),this.physics.engine&&((f=this.physics.engine)==null||f.step(0),(p=this.physics.engine)==null||p.postStep()),!this.isManagedExternally&&this.composer&&this.mainCamera,this._needsUpdateSize=!0,this._stats&&(this._stats.showPanel(0),this._stats.dom.style.position="absolute",(b=this.domElement.shadowRoot)==null||b.appendChild(this._stats.dom)),Ut&&p_(this.scene,!0),this.targetFrameRate===void 0?(Ut&&console.warn("No target framerate set, using default",et.DefaultTargetFrameRate),this.targetFrameRate=et._defaultTargetFramerate):Ut&&console.log("Target framerate set to",this.targetFrameRate),this._dispatchReadyAfterFrame=!0;const c=Be.dispatchCallback(Me.ContextCreated,this,{files:l});if(c){const S=this.domElement;"internalSetLoadingMessage"in S&&typeof S.internalSetLoadingMessage=="function"&&(S==null||S.internalSetLoadingMessage("finish loading")),await c}if((x=t==null?void 0:t.abortSignal)!=null&&x.aborted)return!1;const h=this.rootSourceId;return h&&this.sceneLighting.enable(h),ho(this,Me.ContextCreated),Ut&&console.log("Context Created...",this.renderer,this.renderer.domElement),this._isCreating=!1,!this.isManagedExternally&&!((v=t==null?void 0:t.abortSignal)!=null&&v.aborted)&&this.restartRenderLoop(),!0}async internalLoadInitialContent(t,e){var c,h,d,u;this.rootSceneSourceIdentifiers.length=0;const i=new Array;if(e.files.length===0)return i;const n=[...e.files];this.rootSceneSourceIdentifiers.push(...n);const o={name:"",progress:null,index:0,count:n.length},r=Ko(),l=0;for(let f=0;f<n.length;f++){if((c=e.abortSignal)!=null&&c.aborted){Ut&&console.log("Aborting loading because of abort signal");break}if(t!==this._createId){Ut&&console.log("Aborting loading because create id changed",t,this._createId);break}const p=n[f];(h=e==null?void 0:e.onLoadingStart)==null||h.call(this,f,p),Ut&&console.log("Context Load "+p);const b=await r.loadSync(this,p,p,l,x=>{var v,S;(v=e.abortSignal)!=null&&v.aborted||(o.name=p,o.progress=x,o.index=f,o.count=n.length,(S=e.onLoadingProgress)==null||S.call(this,o))});(d=e==null?void 0:e.onLoadingFinished)==null||d.call(this,f,p,b??null),b?i.push({src:p,file:b}):console.warn("Could not load file: "+p)}if(t!==this._createId||(u=e.abortSignal)!=null&&u.aborted){Ut&&console.log("Aborting loading because create id changed or abort signal was set",t,this._createId);for(const f of i)if(f&&f.file)for(const p of f.file.scenes)xs(p,!0,!0)}else{let f=!1;for(const p of i)p&&p.file&&(p.file.scene?(f=!0,this.scene.add(p.file.scene)):console.warn("No scene found in loaded file"));if(!f){for(const p of i)if(p&&p.file&&"parser"in p.file){let b=0;if(!Array.isArray(p.file.parser.json.materials))continue;for(let x=0;x<p.file.parser.json.materials.length;x++){const v=await p.file.parser.getDependency("material",x),S=new z;S.position.x=x*1.1,S.position.y=b,this.scene.add(S),_c.createPrimitive("ShaderBall",{parent:S,material:v})}b+=1}}}return i}restartRenderLoop(){return this.renderer?this._isCreating?(console.warn("Can not start render loop while creating context"),!1):(this.renderer.setAnimationLoop((t,e)=>{this.isManagedExternally||this.update(t,e)}),!0):(console.error("Can not start render loop without renderer"),!1)}update(t,e){if(e===void 0&&(e=null),X()||Ut||u2())try{this.internalStep(t,e),this._renderlooperrors=0}catch(i){this._renderlooperrors+=1,(X()||Ut)&&(i instanceof Error||i instanceof TypeError)&&at("Caught unhandled exception during render-loop - see console for details.",Ti.Error),console.error("Frame #"+this.time.frame+`
`,i),this._renderlooperrors>=3&&(console.warn("Stopping render loop due to error"),this.renderer.setAnimationLoop(null),Tn.sendError(et.Current,"renderloop",i instanceof Error?i:new Error(String(i)))),this.domElement.dispatchEvent(new CustomEvent("error",{detail:i}))}else this.internalStep(t,e)}updatePhysics(t){this.internalUpdatePhysics(t)}setCameraFocusRect(t,e){const i=this._focusRect;if(this._focusRect=t,e&&Object.assign(this.focusRectSettings,e),(e==null?void 0:e.damping)===void 0&&i){let n=i;i instanceof HTMLElement&&(n=i.getBoundingClientRect()),n&&"top"in n&&n.bottom>=-100&&n.right>=-100&&n.top<=window.innerHeight+100&&n.left<=window.innerWidth+100&&(this.focusRectSettings.damping=.2)}}get focusRect(){return this._focusRect}get focusRectSize(){const t=this._focusRect;if(t&&(t instanceof DOMRect||"width"in t&&"height"in t&&"x"in t&&"y"in t))return{x:t.x,y:t.y,width:t.width,height:t.height};if(t instanceof HTMLElement){const e=t.getBoundingClientRect();return{x:e.x,y:e.y,width:e.width,height:e.height}}return null}internalStep(t,e){this.internalOnBeforeRender(t,e)!==!1&&(this.internalOnRender(),this.internalOnAfterRender())}internalOnBeforeRender(t,e){var n;this.renderer.info.autoReset=!!e,this.renderer.info.autoReset===!1&&this.renderer.info.reset(),this._needsVisibleUpdate=!0;const i=e!==null&&this._xrFrame===null;if(this._xrFrame=e,i&&this.domElement.dispatchEvent(new CustomEvent("xr-session-started",{detail:{context:this,session:this.xrSession,frame:e}})),this._currentFrameEvent=ge.Undefined,this.isManagedExternally===!1&&this.isInXR===!1&&this.targetFrameRate!==void 0){this._lastTimestamp===0&&(this._lastTimestamp=t),this._accumulatedTime+=(t-this._lastTimestamp)/1e3,this._lastTimestamp=t;let o=this.targetFrameRate;if(typeof o=="object"&&(o=o.value),this._accumulatedTime<1/(o+1))return!1;this._accumulatedTime=0}if((n=this._stats)==null||n.begin(),et.Current=this,this.onHandlePaused())return!1;for(et.Current=this,this.time.update(),KI&&console.log("FPS",this.time.smoothedFps.toFixed(0)),km(this),im(this.scene),VP(this),ho(this,ge.Start);this._cameraStack.length>0&&(!this.mainCameraComponent||this.mainCameraComponent.destroyed);){this._cameraStack.splice(this._cameraStack.length-1,1);const o=this._cameraStack[this._cameraStack.length-1];this.setCurrentCamera(o)}if(this.pre_update_oneshot_callbacks){for(const o in this.pre_update_oneshot_callbacks)this.pre_update_oneshot_callbacks[o]();this.pre_update_oneshot_callbacks.length=0}if(this.pre_update_callbacks)for(const o in this.pre_update_callbacks)this.pre_update_callbacks[o]();this._currentFrameEvent=ge.EarlyUpdate;for(let o=0;o<this.scripts_earlyUpdate.length;o++){const r=this.scripts_earlyUpdate[o];r.activeAndEnabled&&r.earlyUpdate!==void 0&&(et.Current=this,r.earlyUpdate())}this.executeCoroutines(ge.EarlyUpdate),ho(this,ge.EarlyUpdate),this._currentFrameEvent=ge.Update;for(let o=0;o<this.scripts_update.length;o++){const r=this.scripts_update[o];r.activeAndEnabled&&r.update!==void 0&&(et.Current=this,r.update())}this.executeCoroutines(ge.Update),ho(this,ge.Update),this._currentFrameEvent=ge.LateUpdate;for(let o=0;o<this.scripts_lateUpdate.length;o++){const r=this.scripts_lateUpdate[o];r.activeAndEnabled&&r.lateUpdate!==void 0&&(et.Current=this,r.lateUpdate())}if(this.executeCoroutines(ge.LateUpdate),ho(this,ge.LateUpdate),this.physicsSteps===void 0&&(this.physicsSteps=1),this.physics.engine&&this.physicsSteps>0&&this.internalUpdatePhysics(this.physicsSteps),this.isVisibleToUser||this.runInBackground){this._currentFrameEvent=ge.OnBeforeRender;for(let o=0;o<this.scripts_onBeforeRender.length;o++){const r=this.scripts_onBeforeRender[o];r.activeAndEnabled&&r.onBeforeRender!==void 0&&(et.Current=this,r.onBeforeRender(e))}if(this.executeCoroutines(ge.OnBeforeRender),ho(this,ge.OnBeforeRender),this._needsUpdateSize&&this.updateSize(),this.pre_render_callbacks)for(const o in this.pre_render_callbacks)this.pre_render_callbacks[o](e);if(this._focusRect&&this.mainCamera instanceof Ae){const o=this.focusRectSettings,r=o.damping>0?this.time.deltaTime/o.damping:1;DE(this._focusRect,this.focusRectSettings,r,this.mainCamera,this.renderer)}}return!0}internalUpdatePhysics(t){if(!this.physics.engine)return!1;const e=t,i=this.time.deltaTime/e;for(let n=0;n<e;n++)this._currentFrameEvent=ge.PrePhysicsStep,this.executeCoroutines(ge.PrePhysicsStep),this.physics.engine.step(i),this._currentFrameEvent=ge.PostPhysicsStep,this.executeCoroutines(ge.PostPhysicsStep);return this.physics.engine.postStep(),!0}internalOnRender(){this.isManagedExternally||(g2(this),this._currentFrameEvent=ge.Undefined,$x.camera=this.mainCamera,$x.update(),this.renderNow(),this._currentFrameEvent=ge.OnAfterRender)}internalOnAfterRender(){if(this.isVisibleToUser||this.runInBackground){for(let t=0;t<this.scripts_onAfterRender.length;t++){const e=this.scripts_onAfterRender[t];e.activeAndEnabled&&e.onAfterRender!==void 0&&(et.Current=this,e.onAfterRender())}if(this.executeCoroutines(ge.OnAfterRender),ho(this,ge.OnAfterRender),this.post_render_callbacks)for(const t in this.post_render_callbacks)this.post_render_callbacks[t]()}if(this._currentFrameEvent=-1,this.connection.sendBufferedMessagesNow(),this._stats){this._stats.end();const t=this.time.fps<20?50:150;this.time.frameCount%t===0&&console.log(this.renderer.info.render.calls+" DrawCalls",`
Render:`,{...this.renderer.info.render},`
Memory:`,{...this.renderer.info.memory},`
Target Framerate: `+this.targetFrameRate)}this._dispatchReadyAfterFrame&&(this._dispatchReadyAfterFrame=!1,this.domElement.dispatchEvent(new CustomEvent("ready")),Be.dispatchCallback(Me.ContextFirstFrameRendered,this))}renderNow(t){var e;if(!t&&(t=this.mainCamera,!t))return!1;if(this.handleRendererContextLost(),this._isRendering=!0,this.renderRequiredTextures(),this.renderer.toneMapping!==gm&&pT(),this.composer&&!this.isInXR){t&&"setMainCamera"in this.composer&&((e=this.composer.passes[0])==null?void 0:e.mainCamera)!=t&&this.composer.setMainCamera(t);const i=this.renderer.getClearColor(this._tempClearColor),n=this.renderer.getClearAlpha();this._tempClearColor2.copy(i),this.renderer.setClearColor(i.convertSRGBToLinear(),this.renderer.getClearAlpha()),this.composer.render(this.time.deltaTime),this.renderer.setClearColor(this._tempClearColor2,n)}else t&&(this.isInXR&&Q.isMacOS()&&this.renderer.clearDepth(),this.renderer.render(this.scene,t));return this._isRendering=!1,!0}handleRendererContextLost(){this.time.frame%10&&this.renderer.getContext().isContextLost()&&this._contextRestoreTries++<100&&(console.warn("Attempting to recover WebGL context..."),this.renderer.forceContextRestore())}onHandlePaused(){const t=this.evaluatePaused();if(this._wasPaused!==t){YI&&console.log("Paused?",t,"context:"+this.alias);for(let e=0;e<this.scripts_pausedChanged.length;e++){const i=this.scripts_pausedChanged[e];i.activeAndEnabled&&i.onPausedChanged!==void 0&&(et.Current=this,i.onPausedChanged(t,this._wasPaused))}}return this._wasPaused=t,t}evaluatePaused(){return this.isInXR?!1:this.isPaused?!0:this.runInBackground?!1:!this.isVisibleToUser}renderRequiredTextures(){if(!this.mainCamera||!this._requireDepthTexture&&!this._requireColorTexture)return;if(!this._renderTarget){if(this._renderTarget=new Qo(this.domWidth,this.domHeight),this._requireDepthTexture){const i=new YC(this.domWidth,this.domHeight);this._renderTarget.depthTexture=i}this._requireColorTexture&&(this._renderTarget.texture=new _t,this._renderTarget.texture.generateMipmaps=!1,this._renderTarget.texture.minFilter=ym,this._renderTarget.texture.magFilter=ym,this._renderTarget.texture.format=Sg)}const t=this._renderTarget;t.texture&&(t.texture.colorSpace=this.renderer.outputColorSpace);const e=this.renderer.getRenderTarget();this.renderer.setRenderTarget(t),this.renderer.render(this.scene,this.mainCamera),this.renderer.setRenderTarget(e)}executeCoroutines(t){var i;if(this.coroutines[t]){const n=this.coroutines[t];for(let o=0;o<n.length;o++)try{const r=n[o];if(!r.comp||r.comp.destroyed||!r.main||r.comp.enabled===!1){ZI&&console.log("Removing coroutine",r.comp,r.comp.enabled),n.splice(o,1),--o;continue}const c=r.chained;if(c&&c.length>0){const f=c[c.length-1].next();if(f.done&&c.pop(),e(f)&&(r.chained||(r.chained=[]),r.chained.push(f.value)),!f.done)continue}const h=r.main.next();if(h.done===!0){n.splice(o,1),--o;continue}const d=h.value;if(e(d)){if(d.next().done)continue;r.chained||(r.chained=[]),r.chained.push(d)}else if(d instanceof Promise){const u=d;r.chained||(r.chained=[]);const f=RI(u);(i=r.chained)==null||i.push(f);continue}}catch(r){console.error(r)}}function e(n){return!!(n&&n.next&&n.return)}}};let de=et;a(de,"_defaultTargetFramerate",{value:90,toString(){return this.value}}),a(de,"_defaultWebglRendererParameters",{antialias:!0,alpha:!1,powerPreference:Q.isiOS()||Q.isMacOS()?"default":"high-performance",stencil:!0});function cv(s,t){return Yr(s,Me.ContextCreated,t),()=>Qa(s,Me.ContextCreated)}function JI(s,t){return Yr(s,Me.ContextClearing,t),()=>Qa(s,Me.ContextClearing)}function eL(s,t){return Yr(s,Me.ContextDestroying,t),()=>Qa(s,Me.ContextDestroying)}function zg(s,t){return Yr(s,ge.Start,t),()=>Qa(s,ge.Start)}function bT(s,t){return Yr(s,ge.Update,t),()=>Qa(s,ge.Update)}function tL(s,t){return Yr(s,ge.OnBeforeRender,t),()=>Qa(s,ge.OnBeforeRender)}function iL(s,t){return Yr(s,ge.OnAfterRender,t),()=>Qa(s,ge.OnAfterRender)}const Si=k("debuglicense"),_T=[];let Ys="basic";Si&&console.log("License Type: "+Ys);function Dr(){switch(Ys){case"pro":case"enterprise":return!0}return!1}function $g(){switch(Ys){case"indie":return!0}return!1}function hv(){switch(Ys){case"edu":return!0}return!1}function jr(){return Dr()||$g()||hv()}function nL(s){if(Dr()||$g()||hv())return s(!0);_T.push(s)}function Pp(s){for(const t of _T)try{t(s)}catch{}}var Tn;(function(s){window.addEventListener("error",l=>{o(de.Current,"unhandled_error",l)}),window.addEventListener("unhandledrejection",l=>{var c,h;o(de.Current,"unhandled_promise_rejection",{message:(c=l.reason)==null?void 0:c.message,stack:(h=l.reason)==null?void 0:h.stack,timestamp:Date.now()})}),cv(l=>t(l),{once:!0});function t(l){if(!e(l)){Si&&console.debug("Telemetry is disabled via no-telemetry attribute");return}return r({site_id:"dabb8317376f",type:"pageview",pathname:window.location.pathname,hostname:window.location.hostname,page_title:document.title,referrer:document.referrer,user_agent:navigator.userAgent,querystring:window.location.search,language:navigator.language,screenWidth:window.screen.width,screenHeight:window.screen.height,event_name:"page_view"}).then(c=>{var h,d;if(c instanceof Response&&c.ok&&_s()){const f=(((h=l.domElement)==null?void 0:h.getAttribute("src"))||"")+Gn+cf+Sm+Eh;window.sessionStorage.getItem("session_key")!==f&&(window.sessionStorage.setItem("session_key",f),n(l,"info",{src:((d=l.domElement)==null?void 0:d.getAttribute("src"))||"",version:Gn,generator:cf,build_time:Sm,public_key:Eh}))}})}function e(l){let c=l==null?void 0:l.domElement;if(c||(c=document.querySelector("needle-engine")),!c&&!l)return!1;const h=c==null?void 0:c.getAttribute("no-telemetry");return(h===""||h==="true"||h==="1")&&(Ys==="pro"||Ys==="enterprise")?(Si&&console.debug("Telemetry is disabled via no-telemetry attribute"),!1):!0}s.isAllowed=e;const i="dabb8317376f";async function n(l,c,h){if(!e(l)){Si&&console.debug("Telemetry is disabled");return}const d={site_id:i,type:"custom_event",pathname:window.location.pathname,event_name:c,properties:h?JSON.stringify(h):void 0};return r(d)}s.sendEvent=n;async function o(l,c,h){var u;if(!e(l)){Si&&console.debug("Telemetry is disabled");return}h instanceof ErrorEvent?h={message:h.message,stack:(u=h.error)==null?void 0:u.stack,filename:h.filename,lineno:h.lineno,colno:h.colno,timestamp:h.timeStamp||Date.now()}:h instanceof Error&&(h={message:h.message,stack:h.stack,timestamp:Date.now()});const d={site_id:i,type:"error",event_name:c||"error",properties:JSON.stringify({error_name:c,message:h.message,stack:h.stack,filename:h.filename,lineno:h.lineno,colno:h.colno,timestamp:h.timestamp})};return r(d)}s.sendError=o;function r(l){try{return fetch("https://needle.tools/api/v1/rum/t",{method:"POST",body:JSON.stringify(l),headers:{"Content-Type":"application/json"},keepalive:!0,mode:"cors",priority:"low"}).catch(h=>{Si&&console.error("Failed to send telemetry",h)})}catch(c){Si&&console.error(c)}return Promise.resolve()}})(Tn||(Tn={}));Be.registerCallback(Me.ContextRegistered,s=>{rL(s.context),oL(s.context),setTimeout(()=>lL(s.context),2e3)});let Dh,Q_=!1,du="";async function sL(){if(Dh)return Dh;if(Ys==="basic")try{const s="https://needle.tools/api/v1/needle-engine/check?location="+encodeURIComponent(window.location.href)+"&version="+Gn+"&generator="+encodeURIComponent(cf),t=await fetch(s,{method:"GET"}).catch(e=>{Si&&console.error("License check failed",e)});(t==null?void 0:t.status)===200?(Q_=!1,Si&&console.log("License check succeeded"),Ys="pro",Pp(!0)):(t==null?void 0:t.status)===403?(Pp(!1),Q_=!0,du=await t.text()):(Pp(!1),Si&&console.log("License check failed with status "+(t==null?void 0:t.status)))}catch(s){Pp(!1),Si&&console.error("License check failed",s)}else Si&&console.log('Runtime license check is skipped because license is already applied as "'+Ys+'"')}Dh=sL();async function oL(s){function t(){const n=document.createElement("div");n.className="needle-forbidden",n.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: all;
        zIndex: 2147483647;
        line-height: 1.5;
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        `;const o=n.style.cssText,r=document.createElement("div");n.appendChild(r),r.style.cssText=`
        position: absolute;
        left: 0;
        right: 0;
        top:0;
        bottom: 0;
        padding: 10%;
        color: white;
        font-size: 20px;
        font-family: sans-serif;
        text-align: center;
        pointer-events: all;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: rgba(0,0,0,.3);
        text-shadow: 0 0 2px black;
        `;const l=r.style.cssText,c=(du==null?void 0:du.length)>1?du:"This web application has been paused.<br/>You might be in violation of the Needle Engine terms of use.<br/>Please contact the Needle support if you think this is a mistake.";return r.innerHTML=c,setInterval(()=>{r.innerHTML!==c&&(r.innerHTML=c),r.parentNode!==n&&n.appendChild(r),n.style.cssText!==o&&(n.style.cssText=o),r.style.cssText!==l&&(r.style.cssText=l)},500),n}let e=t();const i=e.style.cssText;setInterval(()=>{var n;Q_===!0&&(e.style.cssText!==i&&(e=t()),s.domElement.shadowRoot?e.parentNode!==s.domElement.shadowRoot&&((n=s.domElement.shadowRoot)==null||n.appendChild(e)):e.parentNode!=document.body&&document.body.appendChild(e))},500)}async function rL(s){try{if(!Dr()&&!$g())return gb(s)}catch(t){return Si&&console.log("License check failed",t),gb(s)}Si&&gb(s)}async function gb(s){let t=!1;s.domElement.addEventListener("ready",()=>t=!0),await(Dh==null?void 0:Dh.catch(()=>{})),!(Dr()||$g())&&(jr()===!1&&aL(),t?Y_(s):s.domElement.addEventListener("ready",()=>{Y_(s)}))}function Y_(s){var r;const t=`
        position: relative;
        display: block;
        background-size: 20px;
        background-position: 10px 5px;
        background-repeat:no-repeat;
        background-image:url('${vT}');
        background-max-size: 40px;
        padding: 10px;
        padding-left: 30px;
    `;if(Ys==="edu")console.log("%c This project is supported by Needle for Education ‚Äì https://needle.tools",t);else return;const e=document.createElement("div");e.className="needle-non-commercial-use",e.innerHTML="Made with Needle for Education",(r=s.domElement.shadowRoot)==null||r.appendChild(e);let i=`
        position: absolute;
        font-family: system-ui, Avenir, Helvetica, Arial, sans-serif;
        font-size: 12px;
        color: rgb(100, 100, 100);
        /*mix-blend-mode: difference;*/
        background-color: transparent;
        z-index: 10000;

        cursor: pointer;
        user-select: none;
        opacity: 0;

        bottom: 6px;
        right: 12px;
        transform: translateY(0px);
        transition: all .5s ease-in-out 1s;
    `;e.style.cssText=i,e.addEventListener("click",()=>{window.open("https://needle.tools","_blank")});let n=e.style.cssText;setTimeout(()=>{i=i.replace("opacity: 0","opacity: 1"),i=i.replace("transform: translateY(10px)","transform: translateY(0)"),e.style.cssText=i,n=e.style.cssText},100);const o=setInterval(()=>{const l=s.domElement.shadowRoot||s.domElement;e.parentNode!==l&&l.appendChild(e),n!=e.style.cssText&&(e.style.cssText=i,n=e.style.cssText)},1e3);hv()&&setTimeout(()=>{clearInterval(o),e==null||e.remove();const c=5;setTimeout(()=>{s.domElement.parentNode&&Y_(s)},1e3*60*c)},2e4)}const vT="data:image/webp;base64,UklGRrABAABXRUJQVlA4WAoAAAAQAAAAHwAAHwAAQUxQSKEAAAARN6CmbSM4WR7vdARON11EBDq3fLiNbVtVzpMCPlKAEzsx0Y/x+Ovuv4dn0EFE/ydAvz6YggXzgh5sVgXM/zOC/4sii7qgGvB5N7hmuQYwkvazWAu1JPW41FXSHq6pnaQWvqYH18Fc0j1hO/BFTtIeSBlJi5w6qIIO7IOrwhFsB2Yxukif0FTRLpXswHR8MxbslKe9VZsn/Ub5C7YFOpqSTABWUDgg6AAAAFAGAJ0BKiAAIAA+7VyoTqmkpCI3+qgBMB2JbACdMt69DwMIQBLhkTO6XwY00UEDK6cNIDnuNibPf0EgAP7Y1myuiQHLDsF/0h5unrGh6WAbv7aegg2ZMd3uRKfT/3SJztcaujYfTvMXspfCTmYcoO6a+vhC3ss4M8uM58t4siiu59I4aOl59e9Sr6xoxYlHf2v+NnBNpJYeJf8jABQAId/PXuBkLEFkiCucgSGEcfhvajql/j3reCGl0M5/9gQWy7ayNPs+wlvIxFnNfSlfuND4CZOCyxOHhRqOmHN4ULHo3tCSrUNvgAA=";let wS=0;async function aL(s){var o;const t=Date.now();if(t-wS<2e3)return;wS=t;const e=`
        position: relative;
        display: block;
        font-size: 18px;
        background-size: 20px;
        background-position: 10px 5px;
        background-repeat:no-repeat;
        background-image:url('${vT}');
        background-max-size: 40px;
        margin-bottom: 5px;
        margin-top: .3em;
        margin-bottom: .5em;
        padding: .2em;
        padding-left: 25px;
        border-radius: .5em;
        border: 2px solid rgba(160,160,160,.3);
    `,n=`Needle Engine ‚Äî No license active, commercial use is not allowed. Visit https://needle.tools/pricing for more information and licensing options! v${Gn}`;(o=de.Current)!=null&&o.xr?console.log(n):console.log("%c "+n,e)}async function lL(s){var t;if(!window.crossOriginIsolated){if(!Tn.isAllowed(s)){Si&&console.debug("Telemetry is disabled via no-telemetry attribute");return}try{const e="https://needle.tools/api/v1/needle-engine/ping";if(e){const i=window.location.href.split("?")[0],o={license:Ys,url:i,hostname:window.location.hostname,pathname:window.location.pathname,version:Gn,generator:cf,build_time:Sm,public_key:Eh},r=(t=navigator.sendBeacon)==null?void 0:t.call(navigator,e,JSON.stringify(o));Si&&console.debug("Sent beacon: "+r)}}catch(e){Si&&console.log("Failed to send non-commercial usage message to analytics backend",e)}}}const cL=k("debugdecoders");let yb=null;function xT(){if(!yb){const s=F0(null);yb={dracoLoader:s.dracoLoader,ktx2Loader:s.ktx2Loader,meshoptDecoder:s.meshoptDecoder}}return yb}function SS(s){s!==void 0&&typeof s=="string"&&Jk(s)}function CS(s){if(s!==void 0&&typeof s=="string"&&s!=="js"){const t=xT();cL&&console.log("Setting draco decoder type to",s),t.dracoLoader.setDecoderConfig({type:s})}}function PS(s){s!==void 0&&typeof s=="string"&&eE(s)}function dv(s,t){const e=xT();return t.renderer?e.ktx2Loader.detectSupport(t.renderer):console.warn("No renderer provided to detect ktx2 support - loading KTX2 textures will probably fail"),tE(s),s.dracoLoader||s.setDRACOLoader(e.dracoLoader),s.ktx2Loader||s.setKTX2Loader(e.ktx2Loader),s.meshoptDecoder||s.setMeshoptDecoder(e.meshoptDecoder),iE(s,{progressive:!0}),s}const Nt=function(s){return g(s)},g=function(s){if(s===void 0&&(s=null),!Array.isArray(s))s=TS(s);else for(let t=0;t<s.length;t++){const e=s[t];s[t]=TS(e)}return function(t,e){if(!t){const n=typeof e=="string"?e:e.name;console.warn(`@serializable without a target at '${n}'.`);return}typeof e!="string"&&(e=e.name),Object.getOwnPropertyDescriptor(t,"$serializedTypes")||(t.$serializedTypes={});const i=t.$serializedTypes=t.$serializedTypes||{};i[e]=s}};function TS(s){var t,e;switch((e=(t=s==null?void 0:s.prototype)==null?void 0:t.constructor)==null?void 0:e.name){case"Number":case"String":case"Boolean":return null}return s}const Fa=k("debughotreload");let yf=!1;const Ru=new Map;function I4(){return yf}function RS(){return globalThis.NEEDLE_HOT_RELOAD_ENABLED===!0}function hL(s){var i;if(yf){Fa&&console.warn("[Needle Engine] Hot reloading is in progress, not registering instance",s);return}Fa&&console.log("[Needle Engine] Registering hot reload instance",s);const e=s.constructor.name;Ru.has(e)?(i=Ru.get(e))==null||i.push(s):Ru.set(e,[s])}function dL(s){if(yf){Fa&&console.warn("[Needle Engine] Hot reloading is in progress, not unregistering instance",s);return}Fa&&console.log("[Needle Engine] Unregistering hot reload instance",s);const e=s.constructor.name,i=Ru.get(e);if(!i)return;const n=i.indexOf(s);n!==-1&&i.splice(n,1)}let OS=!1;function uL(){if(Fa||OS)return;OS=!0;const s=console.error;console.error=(...t)=>{if(t.length){const e=t[0];if(typeof e=="string"&&e.includes("[hmr] Failed to reload ")){console.log("[Needle Engine] Hot reloading failed"),window.location.reload();return}}s.apply(console,t)}}function L4(s){Fa&&console.log("[HMR] Apply changes",s,Object.keys(s)),uL();for(const t of Object.keys(s))try{yf=!0;const e=j.get(t);if(!e){Fa&&console.log("[HMR] Type not found: "+t);continue}const i=s[t],n=Ru.get(i.name);let o="[Needle Engine] Updating type: "+t;const r=(n==null?void 0:n.length)??-1;r>0?o+=" x"+r:o+=" (No instances registered)",console.log(o);const l=Object.getOwnPropertyNames(e.prototype),c=Object.getOwnPropertyDescriptors(i.prototype);for(const h in c)c[h].writable&&(e.prototype[h]=s[t].prototype[h]);for(const h of l)c[h]||delete e.prototype[h];if(n){const h=new i,d=Object.getOwnPropertyDescriptors(h);for(const u of n){const f=u,p=f.isComponent===!0,b=p?f.activeAndEnabled:!0,x=p?f.context:void 0;try{if(p&&x&&Tr(f,x),p&&b&&(f.enabled=!1),u.onBeforeHotReloadFields&&u.onBeforeHotReloadFields()===!1)continue;for(const v in d)if(d[v].writable){if(u[v]===void 0)u[v]=h[v];else if(typeof u[v]=="function"&&!u[v].prototype){const C=u[v],P=C.name,E="bound ";if(P===E)continue;const D=C.name.substring(E.length),M=i.prototype[D];M&&(u[v]=M.bind(u))}}u.onAfterHotReloadFields&&u.onAfterHotReloadFields()}finally{p&&x&&J0(f,x),p&&b&&(f.enabled=!0)}}}}catch(e){if(Fa)console.error(e);else return!1}finally{yf=!1,Vl(Ti.Log,"Script changes applied (HMR)")}return!0}class I extends z{constructor(){super(...arguments);a(this,"guid")}static isDestroyed(e){return td(e)}static setActive(e,i,n=!0){e&&(rm(e,i),im(e),i&&n&&VP(de.Current,e))}static isActiveSelf(e){return Mf(e)}static isActiveInHierarchy(e){return dI(e)}static markAsInstancedRendered(e,i){uI(e,i)}static isUsingInstancing(e){return sv(e)}static foreachComponent(e,i,n=!0){return id(e,i,n)}static instantiateSynced(e,i){return e?qP(e,i):null}static instantiate(e,i=null){return"isAssetReference"in e,cc(e,i)}static destroySynced(e,i,n=!0){if(!e)return;const o=e;i=i??de.Current,Fg(o,i.connection,n)}static destroy(e,i=!0){return xs(e,i)}static add(e,i,n){if(!(!e||!i)){if(e===i){console.warn("Can not add object to self",e);return}n||(n=de.Current),i.add(e),rm(e,!0),im(e),n?I.foreachComponent(e,o=>{J0(o,n),!o.__internalDidAwakeAndStart&&n.new_script_start.includes(o)===!1&&n.new_script_start.push(o)},!0):console.warn("Missing context")}}static remove(e){var i;e&&((i=e.parent)==null||i.remove(e),rm(e,!1),im(e),I.foreachComponent(e,n=>{f2(n)},!0))}static invokeOnChildren(e,i,...n){this.invoke(e,i,!0,n)}static invoke(e,i,n=!1,...o){e&&this.foreachComponent(e,r=>{const l=r[i];l&&typeof l=="function"&&(l==null||l.call(r,...o))},n)}static addNewComponent(e,i,n,o=!0){return Wo(e,i,n,{callAwake:o})}static addComponent(e,i,n,o){return Wo(e,i,n,o)}static moveComponent(e,i){return Wo(e,i)}static removeComponent(e){return iT(e.gameObject,e),e}static getOrAddComponent(e,i){return Bg(e,i)}static getComponent(e,i){return e===null?null:ld(e,i)}static getComponents(e,i,n=null){return e===null?n??[]:Ug(e,i,n)}static findByGuid(e,i){return oT(e,i)}static findObjectOfType(e,i,n=!0){return Ef(e,i??de.Current,n)}static findObjectsOfType(e,i){const n=[];return aI(e,n,i),n}static getComponentInChildren(e,i,n=!1){return Ng(e,i,n)}static getComponentsInChildren(e,i,n=null){return kf(e,i,n??void 0)}static getComponentInParent(e,i){return Am(e,i)}static getComponentsInParent(e,i,n=null){return iv(e,i,n)}static getAllComponents(e){var o;const i=(o=e.userData)==null?void 0:o.components;return i?[...i]:[]}static*iterateComponents(e){var n;const i=(n=e==null?void 0:e.userData)==null?void 0:n.components;if(i&&Array.isArray(i))for(let o=0;o<i.length;o++)yield i[o]}}const fL=Symbol("component-name"),Ju=class{constructor(t){a(this,"__context");a(this,"__name");a(this,"gameObject");a(this,"guid","invalid");a(this,"sourceId");a(this,"__didAwake",!1);a(this,"__didStart",!1);a(this,"__didEnable",!1);a(this,"__isEnabled");a(this,"__destroyed",!1);a(this,"_eventListeners",new Map);this.__didAwake=!1,this.__didStart=!1,this.__didEnable=!1,this.__isEnabled=void 0,this.__destroyed=!1,this._internalInit(t),RS()&&hL(this)}get isComponent(){return!0}get[fL](){return j.getKey(this.constructor)||void 0}get context(){return this.__context??de.Current}set context(t){this.__context=t}get scene(){return this.context.scene}get layer(){var t,e;return(e=(t=this.gameObject)==null?void 0:t.userData)==null?void 0:e.layer}get name(){var t,e;return(t=this.gameObject)!=null&&t.name?this.gameObject.name:(e=this.gameObject)==null?void 0:e.userData.name}set name(t){this.gameObject?(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.name=t,this.__name=t):this.__name=t}get tag(){var t;return(t=this.gameObject)==null?void 0:t.userData.tag}set tag(t){this.gameObject&&(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.tag=t)}get static(){var t;return(t=this.gameObject)==null?void 0:t.userData.static}set static(t){this.gameObject&&(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.static=t)}get activeAndEnabled(){return!(this.destroyed||this.__isEnabled===!1||!this.__isActiveInHierarchy)}get __isActive(){return this.gameObject.visible}get __isActiveInHierarchy(){if(!this.gameObject)return!1;const t=this.gameObject[Da];return t===void 0?!0:t}set __isActiveInHierarchy(t){this.gameObject&&(this.gameObject[Da]=t)}awake(){}onEnable(){}onDisable(){}onDestroy(){this.__destroyed=!0}startCoroutine(t,e=ge.Update){return this.context.registerCoroutineUpdate(this,t,e)}stopCoroutine(t,e=ge.Update){this.context.unregisterCoroutineUpdate(t,e)}get destroyed(){return this.__destroyed}destroy(){this.__destroyed||this.__internalDestroy()}get __internalDidAwakeAndStart(){return this.__didAwake&&this.__didStart}__internalNewInstanceCreated(t){return this.__didAwake=!1,this.__didStart=!1,this.__didEnable=!1,this.__isEnabled=void 0,this.__destroyed=!1,this._internalInit(t),this}_internalInit(t){if(typeof t=="object")for(const e of Object.keys(t)){const i=t[e];typeof i!="function"&&(this[e]=i)}}__internalAwake(){this.__didAwake||(this.__didAwake=!0,this.awake())}__internalStart(){this.__didStart||(this.__didStart=!0,this.start&&this.start())}__internalEnable(t){return this.__destroyed?(X()&&console.warn("[Needle Engine Dev] Trying to enable destroyed component"),!1):this.__didAwake?this.__didEnable?(t!==!0&&(this.__isEnabled=!0),!1):(this.__didEnable=!0,this.__isEnabled=!0,this.onEnable(),!0):!1}__internalDisable(t){if(this.__didAwake){if(!this.__didEnable){t!==!0&&(this.__isEnabled=!1);return}this.__didEnable=!1,this.__isEnabled=!1,this.onDisable()}}__internalDestroy(){var t;this.__destroyed||(this.__destroyed=!0,this.__didAwake&&((t=this.onDestroy)==null||t.call(this),this.dispatchEvent(new CustomEvent("destroyed",{detail:this}))),rI(this),RS()&&dL(this))}get enabled(){return typeof this.__isEnabled=="boolean"?this.__isEnabled:!0}set enabled(t){if(this.__destroyed){X()&&console.warn(`[Needle Engine Dev] Trying to ${t?"enable":"disable"} destroyed component`);return}if(typeof t=="number"&&(t>=.5?t=!0:t=!1),!this.__didAwake){this.__isEnabled=t;return}t?this.__internalEnable():this.__internalDisable()}get worldPosition(){return ve(this.gameObject)}set worldPosition(t){Oi(this.gameObject,t)}setWorldPosition(t,e,i){Qh(this.gameObject,t,e,i)}get worldQuaternion(){return Qe(this.gameObject)}set worldQuaternion(t){Yo(this.gameObject,t)}setWorldQuaternion(t,e,i,n){S1(this.gameObject,t,e,i,n)}get worldEuler(){return C1(this.gameObject)}set worldEuler(t){P1(this.gameObject,t)}get worldRotation(){return this.gameObject.worldRotation}set worldRotation(t){this.setWorldRotation(t.x,t.y,t.z,!0)}setWorldRotation(t,e,i,n=!0){Mg(this.gameObject,t,e,i,n)}get forward(){return Ju._forward.set(0,0,-1).applyQuaternion(this.worldQuaternion)}get right(){return Ju._right.set(1,0,0).applyQuaternion(this.worldQuaternion)}get up(){return Ju._up.set(0,1,0).applyQuaternion(this.worldQuaternion)}addEventListener(t,e){this._eventListeners[t]=this._eventListeners[t]||[],this._eventListeners[t].push(e)}removeEventListener(t,e){if(!this._eventListeners[t])return;const i=this._eventListeners[t].indexOf(e);i>=0&&this._eventListeners[t].splice(i,1)}dispatchEvent(t){if(!t||!this._eventListeners[t.type])return!1;const e=this._eventListeners[t.type];for(let i=0;i<e.length;i++)e[i](t);return!1}};let W=Ju;a(W,"_forward",new R),a(W,"_right",new R),a(W,"_up",new R);const pL=Object.freeze(Object.defineProperty({__proto__:null,Behaviour:W,Component:W,GameObject:I},Symbol.toStringTag,{value:"Module"}));var wT=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Vg extends W{constructor(){super(...arguments);a(this,"from");a(this,"to");a(this,"width",0);a(this,"centered",!0);a(this,"_centerPos")}awake(){this._centerPos=new R}update(){if(!this.from||!this.to)return;const e=ve(this.from).clone(),i=ve(this.to).clone(),n=e.distanceTo(i);this._centerPos.copy(e),this._centerPos.add(i),this._centerPos.multiplyScalar(.5),Oi(this.gameObject,this.centered?this._centerPos:e),this.gameObject.lookAt(ve(this.to).clone()),this.gameObject.scale.set(this.width,this.width,n)}}wT([g(I)],Vg.prototype,"from",void 0);wT([g(I)],Vg.prototype,"to",void 0);var xc=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const la=k("debuganimation");let ST=class{constructor(){a(this,"x");a(this,"y")}};class pn extends W{constructor(){super(...arguments);a(this,"playAutomatically",!0);a(this,"randomStartTime",!1);a(this,"minMaxSpeed");a(this,"minMaxOffsetNormalized");a(this,"loop",!0);a(this,"clampWhenFinished",!1);a(this,"_tempAnimationClipBeforeGameObjectExisted",null);a(this,"_tempAnimationsArray");a(this,"mixer");a(this,"_actions");a(this,"_handles")}get isAnimationComponent(){return!0}addClip(e){this.animations||(this.animations=[]),this.animations.includes(e)||this.animations.push(e)}get time(){if(this.actions){for(const e of this.actions)if(e.isRunning())return e.time}return 0}set time(e){if(this.actions)for(const i of this.actions)i.time=e}get duration(){if(this.actions){for(const e of this.actions)if(e.isRunning())return e.getClip().duration}return 0}get clip(){var e;return(e=this.animations)!=null&&e.length?this.animations[0]:null}set clip(e){if(!this.__didAwake){la&&console.warn("Assign clip during serialization",e),this._tempAnimationClipBeforeGameObjectExisted=e;return}e&&(this.gameObject.animations||(this.gameObject.animations=[]),!this.animations.includes(e)&&(this.animations.length>0?this.animations.splice(0,0,e):this.animations.push(e)))}set clips(e){this.animations=e}set animations(e){e==null||!Array.isArray(e)||(this.gameObject?this.gameObject.animations=e:this._tempAnimationsArray=e)}get animations(){var e;return((e=this.gameObject)==null?void 0:e.animations)||this._tempAnimationsArray||[]}get actions(){return this._actions}set actions(e){this._actions=e}awake(){this.mixer=void 0,la&&console.log("Animation Awake",this.name,this),this._tempAnimationsArray&&(this.animations=this._tempAnimationsArray,this._tempAnimationsArray=void 0),this._tempAnimationClipBeforeGameObjectExisted&&(this.clip=this._tempAnimationClipBeforeGameObjectExisted,this._tempAnimationClipBeforeGameObjectExisted=null),this.actions=[],this._handles=[]}onEnable(){var e;if(this.playAutomatically&&((e=this.animations)==null?void 0:e.length)>0){const i=Math.floor(Math.random()*this.animations.length),n=this.animations[i];this.play(i,{exclusive:!0,fadeDuration:0,startTime:this.randomStartTime?Math.random()*n.duration:0,loop:this.loop,clampWhenFinished:this.clampWhenFinished})}}update(){this.mixer&&(this.mixer.update(this.context.time.deltaTime),this._handles.forEach(e=>e.update()))}onDisable(){this.mixer&&this.mixer.stopAllAction()}onDestroy(){this.context.animations.unregisterAnimationMixer(this.mixer)}getAction(e){var i;return((i=this.actions)==null?void 0:i.find(n=>n.getClip().name===e))||null}get isPlaying(){if(this.actions){for(let e=0;e<this.actions.length;e++)if(this.actions[e].isRunning())return!0}return!1}stopAll(e){if(this.actions)for(const i of this.actions)e!=null&&e.fadeDuration?i.fadeOut(e.fadeDuration):i.stop()}stop(e,i){if(e===void 0){this.stopAll();return}else if(typeof e=="number"){if(e>=this.animations.length){la&&console.log("No animation at index",e);return}e=this.animations[e]}else typeof e=="string"&&(e=this.animations.find(o=>o.name===e));if(!e){console.error("Could not find clip",e);return}const n=this.actions.find(o=>o.getClip()===e);if(!n){console.error("Could not find action",e);return}i!=null&&i.fadeDuration?n.fadeOut(i.fadeDuration):n.stop()}pause(e,i=!1){if(e===void 0){for(const o of this.actions)o.paused=!i;return}else if(typeof e=="number"){if(e>=this.animations.length){la&&console.log("No animation at index",e);return}e=this.animations[e]}else typeof e=="string"&&(e=this.animations.find(o=>o.name===e));if(!e){console.error("Could not find clip",e);return}const n=this.actions.find(o=>o.getClip()===e);if(!n){console.error("Could not find action",e);return}n.paused=!i}resume(){for(const e of this.actions)e.paused=!1}play(e=0,i){if(la&&console.log("PLAY",e),this.ensureMixer(),!this.mixer){la&&console.warn("Missing mixer",this);return}e===void 0&&(e=0);let n=e;if(typeof e=="number"){if(e>=this.animations.length){la&&console.log("No animation at index",e);return}n=this.animations[e]}else typeof e=="string"&&(n=this.animations.find(r=>r.name===e));if(!n){console.error("Could not find clip",e);return}i||(i={});for(const r of this.actions)if(r.getClip()===n)return this.internalOnPlay(r,i);if(!n.tracks){console.warn("Clip is no AnimationClip",n);return}const o=this.mixer.clipAction(n);return this.actions.push(o),this.internalOnPlay(o,i)}internalOnPlay(e,i){var n=this.actions.find(l=>l===e);if(n===e&&n.isRunning()&&n.time<n.getClip().duration){const l=this.tryFindHandle(e);if(n.paused&&(n.paused=!1),l)return l.waitForFinish()}if(i.loop===void 0&&(i.loop=this.loop),i.clampWhenFinished===void 0&&(i.clampWhenFinished=this.clampWhenFinished),i.minMaxOffsetNormalized===void 0&&this.randomStartTime&&(i.minMaxOffsetNormalized=this.minMaxOffsetNormalized),i.minMaxSpeed===void 0&&(i.minMaxSpeed=this.minMaxSpeed),(i==null?void 0:i.exclusive)??!0)for(const l of this.actions)l!=n&&(i.fadeDuration?l.fadeOut(i.fadeDuration):l.stop());if(i!=null&&i.fadeDuration&&e.fadeIn(i.fadeDuration),e.enabled=!0,(i==null?void 0:i.startTime)!=null)e.time=i.startTime;else if(i!=null&&i.minMaxOffsetNormalized&&i.minMaxOffsetNormalized.x!=0&&i.minMaxOffsetNormalized.y!=0){const l=e.getClip();e.time=ee.lerp(i.minMaxOffsetNormalized.x,i.minMaxOffsetNormalized.y,Math.random())*l.duration}else e.time>=e.getClip().duration&&(e.time=0);i!=null&&i.minMaxSpeed?e.timeScale=ee.lerp(i.minMaxSpeed.x,i.minMaxSpeed.y,Math.random()):e.timeScale=(i==null?void 0:i.speed)??1,(i==null?void 0:i.loop)!=null?e.loop=i.loop?IO:a_:e.loop=a_,i!=null&&i.clampWhenFinished&&(e.clampWhenFinished=!0),e.paused=!1,e.play(),window.requestAnimationFrame(()=>Hr.testIfRootCanAnimate(e)),la&&console.log("PLAY",e.getClip().name,e);const r=new mL(e,this.mixer,i,l=>{this._handles.splice(this._handles.indexOf(r),1)});return this._handles.push(r),r.waitForFinish()}tryFindHandle(e){for(const i of this._handles)if(i.action===e)return i}ensureMixer(){if(!this.mixer){const e="animationMixer";this.gameObject[e]&&(this.mixer=this.gameObject[e]),(!this.mixer||!this.mixer.clipAction)&&(this.mixer=new M0(this.gameObject),this.gameObject[e]=this.mixer)}this.context.animations.registerAnimationMixer(this.mixer)}}xc([g()],pn.prototype,"playAutomatically",void 0);xc([g()],pn.prototype,"randomStartTime",void 0);xc([g(ST)],pn.prototype,"minMaxSpeed",void 0);xc([g(ST)],pn.prototype,"minMaxOffsetNormalized",void 0);xc([g()],pn.prototype,"loop",void 0);xc([g()],pn.prototype,"clampWhenFinished",void 0);xc([g(Hn)],pn.prototype,"clips",null);class mL{constructor(t,e,i,n){a(this,"mixer");a(this,"action");a(this,"promise",null);a(this,"_options");a(this,"_resolveCallback",null);a(this,"_resolvedOrRejectedCallback");a(this,"onFinished",t=>{t.action===this.action&&this.onResolve()});this.action=t,this.mixer=e,this._resolvedOrRejectedCallback=n,this._options=i}waitForFinish(){return this.promise?this.promise:(this.promise=new Promise(t=>{this._resolveCallback=t}),this.mixer.addEventListener("finished",this.onFinished),this.promise)}update(){this._options&&this._options.endTime!==void 0&&this.action.time>this._options.endTime&&(this._options.loop===!0?this.action.time=this._options.startTime??0:(this.action.time=this._options.endTime,this.action.timeScale=0,this.onResolve()))}onResolve(){var t,e;this.dispose(),(t=this._resolvedOrRejectedCallback)==null||t.call(this,this),(e=this._resolveCallback)==null||e.call(this,this.action)}dispose(){this.mixer.removeEventListener("finished",this.onFinished)}}const cm=Symbol("objectIsAnimatedData");function kS(s,t,e){if(!s)return;if(s[cm]===void 0){if(!e)return;s[cm]=new Set}const i=s[cm];e?i.add(t):i.has(t)&&i.delete(t)}function gL(s){if(!s)return!1;const t=s[cm];return t!==void 0&&t.size>0}class j4{constructor(){a(this,"_context")}get context(){return this._context??de.Current}get isStateMachineBehaviour(){return!0}}class Tp{constructor(t,e,i,n){a(this,"name");a(this,"nameHash");a(this,"normalizedTime");a(this,"length");a(this,"speed");a(this,"action");a(this,"hasTransitions");var o;this.name=t.name,this.nameHash=t.hash,this.normalizedTime=e,this.length=i,this.speed=n,this.action=t.motion.action||null,this.hasTransitions=((o=t.transitions)==null?void 0:o.length)>0||!1}}function yL(s,t){return{name:"Empty",isLooping:!1,guid:(t==null?void 0:t.generateUUID())??Ar.generateUUID(),index:-1,clip:new Hn(s,0,[])}}var xa;(function(s){s[s.If=1]="If",s[s.IfNot=2]="IfNot",s[s.Greater=3]="Greater",s[s.Less=4]="Less",s[s.Equals=6]="Equals",s[s.NotEqual=7]="NotEqual"})(xa||(xa={}));var K_;(function(s){s[s.Float=1]="Float",s[s.Int=3]="Int",s[s.Bool=4]="Bool",s[s.Trigger=9]="Trigger"})(K_||(K_={}));const Vt=k("debuganimatorcontroller"),Rp=k("debugrootmotion");class Ks{constructor(t){a(this,"_speed",1);a(this,"normalizedStartOffset",0);a(this,"animator");a(this,"model");a(this,"_mixer");a(this,"_activeState");a(this,"_activeStates",[]);a(this,"_heldActions",[]);a(this,"rootMotionHandler");this.model=t,Vt&&console.log(this)}static createFromClips(t,e={looping:!1,autoTransition:!0,transitionDuration:0}){const i=[];for(let r=0;r<t.length;r++){const l=t[r],c=[];if(e.autoTransition!==!1){const d=e.transitionDuration??0,u=d/l.duration;let f=r;(e.autoTransition===void 0||e.autoTransition===!0)&&(f=(r+1)%t.length),c.push({exitTime:1-u,offset:0,duration:d,hasExitTime:!0,destinationState:f,conditions:[]})}const h={name:l.name,hash:r,motion:{name:l.name,clip:l,isLooping:(e==null?void 0:e.looping)??!1},transitions:c,behaviours:[]};i.push(h)}const n={name:"AnimatorController",guid:new Ki(Date.now()).generateUUID(),parameters:[],layers:[{name:"Base Layer",stateMachine:{defaultState:0,states:i}}]};return new Ks(n)}play(t,e=-1,i=Number.NEGATIVE_INFINITY,n=0){if(e<0)e=0;else if(e>=this.model.layers.length){console.warn("invalid layer");return}const r=this.model.layers[e].stateMachine;for(const l of r.states)if(l.name===t||l.hash===t){Vt&&console.log("transition to ",l),this.transitionTo(l,n,i);return}console.warn("Could not find "+t+" to play")}reset(){this.setStartTransition()}setBool(t,e){var n,o;const i=typeof t=="string"?"name":"hash";return(o=(n=this.model)==null?void 0:n.parameters)==null?void 0:o.filter(r=>r[i]===t).forEach(r=>r.value=e)}getBool(t){var i,n,o;const e=typeof t=="string"?"name":"hash";return((o=(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.find(r=>r[e]===t))==null?void 0:o.value)??!1}setFloat(t,e){var o,r;const i=typeof t=="string"?"name":"hash",n=(r=(o=this.model)==null?void 0:o.parameters)==null?void 0:r.filter(l=>l[i]===t);return n.forEach(l=>l.value=e),(n==null?void 0:n.length)>0}getFloat(t){var i,n,o;const e=typeof t=="string"?"name":"hash";return((o=(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.find(r=>r[e]===t))==null?void 0:o.value)??0}setInteger(t,e){var n,o;const i=typeof t=="string"?"name":"hash";return(o=(n=this.model)==null?void 0:n.parameters)==null?void 0:o.filter(r=>r[i]===t).forEach(r=>r.value=e)}getInteger(t){var i,n,o;const e=typeof t=="string"?"name":"hash";return((o=(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.find(r=>r[e]===t))==null?void 0:o.value)??0}setTrigger(t){var i,n;Vt&&console.log("SET TRIGGER",t);const e=typeof t=="string"?"name":"hash";return(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.filter(o=>o[e]===t).forEach(o=>o.value=!0)}resetTrigger(t){var i,n;const e=typeof t=="string"?"name":"hash";return(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.filter(o=>o[e]===t).forEach(o=>o.value=!1)}getTrigger(t){var i,n,o;const e=typeof t=="string"?"name":"hash";return((o=(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.find(r=>r[e]===t))==null?void 0:o.value)??!1}isInTransition(){return this._activeStates.length>1}setSpeed(t){this._speed=t}FindState(t){return this.findState(t)}findState(t){if(!t)return null;if(Array.isArray(this.model.layers)){for(const e of this.model.layers)for(const i of e.stateMachine.states)if(i.name===t||i.hash==t)return i}return null}getCurrentStateInfo(){if(!this._activeState)return null;const t=this._activeState.motion.action;if(!t)return null;const e=this._activeState.motion.clip.duration,i=e<=0?0:Math.abs(t.time/e);return new Tp(this._activeState,i,e,this._speed)}get currentAction(){if(!this._activeState)return null;const t=this._activeState.motion.action;return t||null}get context(){var t;return(t=this.animator)==null?void 0:t.context}get mixer(){return this._mixer}dispose(){var t;if(this._mixer.stopAllAction(),this.animator){this._mixer.uncacheRoot(this.animator.gameObject);for(const e of this._activeStates)e.motion.clip&&this.mixer.uncacheAction(e.motion.clip,this.animator.gameObject)}(t=this.context)==null||t.animations.unregisterAnimationMixer(this._mixer)}bind(t){var e,i;t?this.animator!==t&&(this._mixer&&(this._mixer.stopAllAction(),(e=this.context)==null||e.animations.unregisterAnimationMixer(this._mixer)),this.animator=t,this._mixer=new M0(this.animator.gameObject),(i=this.context)==null||i.animations.registerAnimationMixer(this._mixer),this.createActions(this.animator)):console.error("AnimatorController.bind: animator is null")}clone(){if(typeof this.model=="string")return console.warn("AnimatorController has not been resolved, can not create model from string",this.model),null;Vt&&console.warn("AnimatorController clone()",this.model);const t=Og(this.model,(i,n,o)=>o==null?!0:!(o.type==="Object3D"||o.isObject3D===!0||qE(o)||o.tracks!==void 0||o instanceof Ks));return console.assert(t!==this.model),new Ks(t)}update(t){var i,n;if(!this.animator)return;this.evaluateTransitions(),this.updateActiveStates(t);const e=this.animator.context.time.deltaTime;this.animator.applyRootMotion&&((i=this.rootMotionHandler)==null||i.onBeforeUpdate(t)),this._mixer.update(e),this.animator.applyRootMotion&&((n=this.rootMotionHandler)==null||n.onAfterUpdate(t))}get activeState(){return this._activeState}updateActiveStates(t){for(let e=0;e<this._activeStates.length;e++){const i=this._activeStates[e],n=i.motion;if(!n.action)this._activeStates.splice(e,1),e--;else{const o=n.action;o.weight=t,o.getEffectiveWeight()<=0&&!o.isRunning()&&(Vt&&console.debug("REMOVE",i.name,o.getEffectiveWeight(),o.isRunning(),o.isScheduled()),this._activeStates.splice(e,1),e--)}}}setStartTransition(){var t;this.model.layers.length>1&&(Vt||X())&&console.warn("Multiple layers are not supported yet "+((t=this.animator)==null?void 0:t.name));for(const e of this.model.layers){const i=e.stateMachine;i.defaultState===void 0&&(Vt&&console.warn("AnimatorController default state is undefined, will assign state 0 as default",e),i.defaultState=0);const n=i.states[i.defaultState];this.transitionTo(n,0,this.normalizedStartOffset);break}}evaluateTransitions(){var o;let t=!1;if(!this._activeState){if(this.setStartTransition(),!this._activeState)return;t=!0}const e=this._activeState,i=e.motion.action;for(const r of e.transitions){if(!r.hasExitTime&&r.conditions.length<=0)continue;let l=!0;for(const c of r.conditions)if(!this.evaluateCondition(c)){l=!1;break}if(l)if(i){const c=e.motion.clip.duration,h=c<=0?1:Math.abs(i.time/c);let d=r.exitTime;i.timeScale<0&&(d=1-d);let u=!1;if(r.hasExitTime?i.timeScale>0?u=h>=r.exitTime:i.timeScale<0&&(u=1-h>=r.exitTime):u=!0,u){for(const f of r.conditions){const p=this.model.parameters.find(b=>b.name===f.parameter);(p==null?void 0:p.type)===K_.Trigger&&p.value&&(p.value=!1)}if(i.clampWhenFinished=!0,Vt){const f=this.getState(r.destinationState,0);console.log(`Transition to ${r.destinationState} / ${f==null?void 0:f.name}`,r,`
Timescale: `+i.timeScale,`
Normalized time: `+h.toFixed(3),`
Exit Time: `+d,r.hasExitTime)}this.transitionTo(r.destinationState,r.duration,r.offset);return}}else{this.transitionTo(r.destinationState,r.duration,r.offset);return}}i&&this.setTimescale(i,e);let n=!1;if(e.motion.isLooping&&i&&(i.time>=i.getClip().duration?(n=!0,i.reset(),i.time=0,i.play()):i.time<=0&&i.timeScale<0&&(n=!0,i.reset(),i.time=i.getClip().duration,i.play())),!n&&e&&!t&&i&&this.animator&&e.behaviours){const r=i==null?void 0:i.getClip().duration,l=i.time/r,c=new Tp(this._activeState,l,r,this._speed);for(const h of e.behaviours)h.instance&&((o=h.instance.onStateUpdate)==null||o.call(h.instance,this.animator,c,0))}}setTimescale(t,e){let i=e.speed??1;e.speedParameter&&(i*=this.getFloat(e.speedParameter)),i!==void 0&&(t.timeScale=i*this._speed)}getState(t,e){return typeof t=="number"&&(t==-1&&(t=this.model.layers[e].stateMachine.defaultState,t===void 0&&(Vt&&console.warn("AnimatorController default state is undefined: ",this.model,"Layer: "+e),t=0)),t=this.model.layers[e].stateMachine.states[t]),t}releaseHeldActions(t){for(const e of this._heldActions)e.fadeOut(t);this._heldActions.length=0}transitionTo(t,e,i){var d,u,f,p,b,x,v,S;if(!this.animator)return;const n=0;if(t=this.getState(t,n),!(t!=null&&t.motion)||!t.motion.clip||!(t.motion.clip instanceof Hn))return;const o=this._activeState===t;if(o){const C=t.motion;if(!C.action_loopback&&C.clip){const P=this.rootMotionHandler?this.animator.gameObject.matrix.clone():null;this._mixer.uncacheAction(C.clip,this.animator.gameObject),P&&P.decompose(this.animator.gameObject.position,this.animator.gameObject.quaternion,this.animator.gameObject.scale),C.action_loopback=this.createAction(C.clip)}}if((d=this._activeState)!=null&&d.behaviours&&this._activeState.motion.action){const C=(u=this._activeState)==null?void 0:u.motion.clip.duration,P=this._activeState.motion.action.time/C,E=new Tp(this._activeState,P,C,this._speed);for(const D of this._activeState.behaviours)(p=(f=D.instance)==null?void 0:f.onStateExit)==null||p.call(D.instance,this.animator,E,n)}const r=(b=this._activeState)==null?void 0:b.motion.action;o&&(t.motion.action=t.motion.action_loopback,t.motion.action_loopback=r);const l=this._activeState;this._activeState=t;const c=(x=t.motion)==null?void 0:x.action,h=t.motion.clip;if((h==null?void 0:h.duration)<=0&&h.tracks.length<=0?r&&this._heldActions.push(r):r&&(r.fadeOut(e),this.releaseHeldActions(e)),c){if(i=Math.max(0,Math.min(1,i)),t.cycleOffsetParameter){let P=this.getFloat(t.cycleOffsetParameter);typeof P=="number"?(P<0&&(P+=1),i+=P,i%=1):Vt&&console.warn("AnimatorController cycle offset parameter is not a number",t.cycleOffsetParameter)}else typeof t.cycleOffset=="number"&&(i+=t.cycleOffset,i%=1);c.isRunning()&&c.stop(),c.reset(),c.enabled=!0,this.setTimescale(c,t);const C=t.motion.clip.duration;if(c.time=o?0:i*C,c.timeScale<0&&(c.time=C-c.time),c.clampWhenFinished=!0,c.setLoop(a_,0),e>0?c.fadeIn(e):c.weight=1,c.play(),window.requestAnimationFrame(()=>Hr.testIfRootCanAnimate(c)),this.rootMotionHandler&&this.rootMotionHandler.onStart(c),this._activeStates.includes(t)||this._activeStates.push(t),this._activeState.behaviours){const P=new Tp(t,i,C,this._speed);for(const E of this._activeState.behaviours)(S=(v=E.instance)==null?void 0:v.onStateEnter)==null||S.call(E.instance,this.animator,P,n)}}else Vt&&(t.__warned_no_motion||(t.__warned_no_motion=!0,console.warn("No action",t.motion,this)));Vt&&console.log("TRANSITION FROM "+(l==null?void 0:l.name)+" TO "+t.name,e,r,c,c==null?void 0:c.getEffectiveTimeScale(),c==null?void 0:c.getEffectiveWeight(),c==null?void 0:c.isRunning(),c==null?void 0:c.isScheduled(),c==null?void 0:c.paused)}createAction(t){var i,n;if(this._mixer.existingAction(t)&&this._mixer.uncacheAction(t,(i=this.animator)==null?void 0:i.gameObject),(n=this.animator)!=null&&n.applyRootMotion){this.rootMotionHandler||(this.rootMotionHandler=new bL(this));const o=this.animator.gameObject;return this.rootMotionHandler.createClip(this._mixer,o,t)}else return this._mixer.clipAction(t)}evaluateCondition(t){const e=this.model.parameters.find(i=>i.name===t.parameter);if(!e)return!1;switch(t.mode){case xa.If:return e.value===!0;case xa.IfNot:return e.value===!1;case xa.Greater:return e.value>t.threshold;case xa.Less:return e.value<t.threshold;case xa.Equals:return e.value===t.threshold;case xa.NotEqual:return e.value!==t.threshold}return!1}createActions(t){var e,i,n,o;Vt&&console.log("AnimatorController createActions",this.model);for(const r of this.model.layers){const l=r.stateMachine;for(let c=0;c<l.states.length;c++){const h=l.states[c];h.transitions||(h.transitions=[]);for(const d of h.transitions)d.conditions||(d.conditions=[]);if(h.motion||(Vt&&console.warn("No motion",h),h.motion=yL(h.name)),this.animator&&h.motion.clips){const d=(e=h.motion.clips)==null?void 0:e.find(u=>{var f,p;return u.node.name===((p=(f=this.animator)==null?void 0:f.gameObject)==null?void 0:p.name)});d?h.motion.clip=d.clip:(Vt||X())&&console.warn('Could not find clip for animator "'+((n=(i=this.animator)==null?void 0:i.gameObject)==null?void 0:n.name)+'"',h.motion.clips.map(u=>u.node.name))}if(!h.motion.clip){Vt&&console.warn("No clip assigned to state",h);const d=new Hn(void 0,void 0,[]);h.motion.clip=d}if((o=h.motion)!=null&&o.clip){const d=h.motion.clip;if(d instanceof Hn){const u=this.createAction(d);h.motion.action=u}else(Vt||X())&&console.warn("No valid animationclip assigned",h)}if(h.behaviours&&Array.isArray(h.behaviours))for(const d of h.behaviours){if(!(d!=null&&d.typeName))continue;const u=j.get(d.typeName);if(u){const f=new u;f.isStateMachineBehaviour&&(f._context=this.context??void 0,ed(f,d.properties),d.instance=f),Vt&&console.log("Created animator controller behaviour",h.name,d.typeName,d.properties,f)}else(Vt||X())&&console.warn("Could not find AnimatorBehaviour type: "+d.typeName)}}}}*enumerateActions(){if(this.model.layers)for(const t of this.model.layers){const e=t.stateMachine;for(let i=0;i<e.states.length;i++){const n=e.states[i];n!=null&&n.motion&&(n.motion.action&&(yield n.motion.action),n.motion.action_loopback&&(yield n.motion.action_loopback))}}}}class ES{constructor(t,e){a(this,"track");a(this,"createdInterpolant");a(this,"originalEvaluate");a(this,"customEvaluate");this.track=t;const i=t,n=i.createInterpolant.bind(t);i.createInterpolant=()=>(i.createInterpolant=n,this.createdInterpolant=n(),this.originalEvaluate=this.createdInterpolant.evaluate.bind(this.createdInterpolant),this.customEvaluate=o=>{if(!this.originalEvaluate)return;const r=this.originalEvaluate(o);return e(o,r)},this.createdInterpolant.evaluate=this.customEvaluate,this.createdInterpolant)}dispose(){this.createdInterpolant&&this.originalEvaluate&&(this.createdInterpolant.evaluate=this.originalEvaluate),this.track=void 0,this.createdInterpolant=null,this.originalEvaluate=void 0,this.customEvaluate=void 0}}const Wt=class{constructor(t,e,i,n,o){a(this,"_action");a(this,"root");a(this,"clip");a(this,"positionWrapper",null);a(this,"rotationWrapper",null);a(this,"context");a(this,"positionChange",new R);a(this,"rotationChange",new re);a(this,"_prevTime",0);if(this.context=t,this.root=e,this.clip=i,Wt.firstKeyframeRotation[this.cacheId]||(Wt.firstKeyframeRotation[this.cacheId]=new re),o){const r=o.values;Wt.firstKeyframeRotation[this.cacheId].set(r[0],r[1],r[2],r[3])}Wt.spaceRotation[this.cacheId]||(Wt.spaceRotation[this.cacheId]=new re),Wt.effectiveSpaceRotation[this.cacheId]||(Wt.effectiveSpaceRotation[this.cacheId]=new re),Wt.clipOffsetRotation[this.cacheId]=new re,o&&Wt.clipOffsetRotation[this.cacheId].set(o.values[0],o.values[1],o.values[2],o.values[3]).invert(),this.handlePosition(i,n),this.handleRotation(i,o)}set action(t){this._action=t}get action(){return this._action}get cacheId(){return this.root.uuid}onStart(t){if(t.getClip()!==this.clip)return;Wt.lastObjRotation[this.cacheId]||(Wt.lastObjRotation[this.cacheId]=this.root.quaternion.clone());const e=Wt.lastObjRotation[this.cacheId];if(Wt.spaceRotation[this.cacheId].copy(e),Rp){const i=new Ht().setFromQuaternion(e);console.log("START",this.clip.name,ee.toDegrees(i.y),this.root.position.z)}}getClipRotationOffset(){return Wt.clipOffsetRotation[this.cacheId]}handlePosition(t,e){if(e){const i=this.root;Rp&&i.add(new Wn),Wt.lastObjPosition[this.cacheId]||(Wt.lastObjPosition[this.cacheId]=this.root.position.clone());const n=new R,o=new R;this.positionWrapper=new ES(e,(r,l)=>{const c=this.action.getEffectiveWeight();return Rp&&i.position.length()>8&&i.position.set(0,i.position.y,0),r>this._prevTime&&(n.set(l[0],l[1],l[2]),n.sub(o),n.multiplyScalar(c),n.applyQuaternion(this.getClipRotationOffset()),n.applyQuaternion(i.quaternion),this.positionChange.copy(n)),o.fromArray(l),this._prevTime=r,l[0]=0,l[1]=0,l[2]=0,l})}}handleRotation(t,e){if(e){if(Rp){const r=e.values,l=new Ht().setFromQuaternion(new re(r[0],r[1],r[2],r[3]));console.log(t.name,e.name,"FIRST ROTATION IN TRACK",ee.toDegrees(l.y));const c=e.values.length-4,h=new re().set(r[c],r[c+1],r[c+2],r[c+3]),d=new Ht().setFromQuaternion(h);console.log(t.name,e.name,"LAST ROTATION IN TRACK",ee.toDegrees(d.y))}let i=0;const n=new re,o=new re;this.rotationWrapper=new ES(e,(r,l)=>(r>i&&(o.set(l[0],l[1],l[2],l[3]),n.invert(),o.multiply(n),this.rotationChange.copy(o)),n.fromArray(l),i=r,l[0]=0,l[1]=0,l[2]=0,l[3]=1,l))}}onBeforeUpdate(t){this.positionChange.set(0,0,0),this.rotationChange.set(0,0,0,1)}onAfterUpdate(t){return!this.action||(t*=this.action.getEffectiveWeight(),t<=0)?!1:(this.positionChange.multiplyScalar(t),this.rotationChange.slerp(Wt.identityQuaternion,1-t),!0)}};let go=Wt;a(go,"lastObjPosition",{}),a(go,"lastObjRotation",{}),a(go,"firstKeyframeRotation",{}),a(go,"spaceRotation",{}),a(go,"effectiveSpaceRotation",{}),a(go,"clipOffsetRotation",{}),a(go,"identityQuaternion",new re);class bL{constructor(t){a(this,"controller");a(this,"handler",[]);a(this,"root");a(this,"basePosition",new R);a(this,"baseQuaternion",new re);a(this,"baseRotation",new Ht);a(this,"summedPosition",new R);a(this,"summedRotation",new re);this.controller=t}createClip(t,e,i){this.root=e,e&&"name"in e&&e.name;const n=this.findRootTrack(i,".position"),o=this.findRootTrack(i,".quaternion"),r=new go(this.controller.context,e,i,n,o);this.handler.push(r);const l=t.clipAction(i);return r.action=l,l}onStart(t){for(const e of this.handler)e.onStart(t)}onBeforeUpdate(t){this.basePosition.copy(this.root.position),this.baseQuaternion.copy(this.root.quaternion);for(const e of this.handler)e.onBeforeUpdate(t)}onAfterUpdate(t){if(!(t<=0)){this.root.position.copy(this.basePosition),this.root.quaternion.copy(this.baseQuaternion),this.summedPosition.set(0,0,0),this.summedRotation.set(0,0,0,1);for(const e of this.handler)e.onAfterUpdate(t)&&(this.summedPosition.add(e.positionChange),this.summedRotation.multiply(e.rotationChange));this.root.position.add(this.summedPosition),this.root.quaternion.multiply(this.summedRotation)}}findRootTrack(t,e){const i=t.tracks;if(!i)return null;for(const n of i)if(n.name.endsWith(e))return n;return null}}class _L extends Ps{onSerialize(t,e){}onDeserialize(t,e){if(e.type===Ks&&(t==null?void 0:t.__type)==="AnimatorController")return new Ks(t)}}new _L(Ks);var Wg=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const ls=k("debuganimator");class Ei extends W{constructor(){super(...arguments);a(this,"applyRootMotion",!1);a(this,"hasRootMotion",!1);a(this,"keepAnimatorControllerStateOnDisable",!1);a(this,"_parametersAreDirty",!1);a(this,"_isDirty",!1);a(this,"_speed",1);a(this,"_normalizedStartOffset",0);a(this,"_animatorController",null);a(this,"_initializeWithRuntimeAnimatorController")}get isAnimationComponent(){return!0}set runtimeAnimatorController(e){var i;this._animatorController&&this._animatorController.model===e||(e?e instanceof Ks?(e.animator&&e.animator!==this&&(console.warn("AnimatorController can not be bound to multiple animators",(i=e.model)==null?void 0:i.name),e.model||console.error("AnimatorController has no model"),e=new Ks(e.model)),this._animatorController=e,this._animatorController.bind(this)):(ls&&console.log("Assign animator controller",e,this),this._animatorController=new Ks(e),this.__didAwake&&this._animatorController.bind(this)):this._animatorController=null)}get runtimeAnimatorController(){return this._animatorController}getCurrentStateInfo(){var e;return(e=this.runtimeAnimatorController)==null?void 0:e.getCurrentStateInfo()}get currentAction(){var e;return((e=this.runtimeAnimatorController)==null?void 0:e.currentAction)||null}get parametersAreDirty(){return this._parametersAreDirty}get isDirty(){return this._isDirty}Play(e,i=-1,n=Number.NEGATIVE_INFINITY,o=0){this.play(e,i,n,o)}play(e,i=-1,n=Number.NEGATIVE_INFINITY,o=0){var r;(r=this.runtimeAnimatorController)==null||r.play(e,i,n,o),this._isDirty=!0}Reset(){this.reset()}reset(){var e;(e=this._animatorController)==null||e.reset(),this._isDirty=!0}SetBool(e,i){this.setBool(e,i)}setBool(e,i){var n,o;ls&&console.log("setBool",e,i),((n=this.runtimeAnimatorController)==null?void 0:n.getBool(e))!==i&&(this._parametersAreDirty=!0),(o=this.runtimeAnimatorController)==null||o.setBool(e,i)}GetBool(e){return this.getBool(e)}getBool(e){var n;const i=((n=this.runtimeAnimatorController)==null?void 0:n.getBool(e))??!1;return ls&&console.log("getBool",e,i),i}toggleBool(e){this.setBool(e,!this.getBool(e))}SetFloat(e,i){this.setFloat(e,i)}setFloat(e,i){var n,o;((n=this.runtimeAnimatorController)==null?void 0:n.getFloat(e))!==i&&(this._parametersAreDirty=!0),ls&&console.log("setFloat",e,i),(o=this.runtimeAnimatorController)==null||o.setFloat(e,i)}GetFloat(e){return this.getFloat(e)}getFloat(e){var n;const i=((n=this.runtimeAnimatorController)==null?void 0:n.getFloat(e))??-1;return ls&&console.log("getFloat",e,i),i}SetInteger(e,i){this.setInteger(e,i)}setInteger(e,i){var n,o;((n=this.runtimeAnimatorController)==null?void 0:n.getInteger(e))!==i&&(this._parametersAreDirty=!0),ls&&console.log("setInteger",e,i),(o=this.runtimeAnimatorController)==null||o.setInteger(e,i)}GetInteger(e){return this.getInteger(e)}getInteger(e){var n;const i=((n=this.runtimeAnimatorController)==null?void 0:n.getInteger(e))??-1;return ls&&console.log("getInteger",e,i),i}SetTrigger(e){this.setTrigger(e)}setTrigger(e){var i;this._parametersAreDirty=!0,ls&&console.log("setTrigger",e),(i=this.runtimeAnimatorController)==null||i.setTrigger(e)}ResetTrigger(e){this.resetTrigger(e)}resetTrigger(e){var i;this._parametersAreDirty=!0,ls&&console.log("resetTrigger",e),(i=this.runtimeAnimatorController)==null||i.resetTrigger(e)}GetTrigger(e){this.getTrigger(e)}getTrigger(e){var n;const i=(n=this.runtimeAnimatorController)==null?void 0:n.getTrigger(e);return ls&&console.log("getTrigger",e,i),i}IsInTransition(){return this.isInTransition()}isInTransition(){var e;return((e=this.runtimeAnimatorController)==null?void 0:e.isInTransition())??!1}SetSpeed(e){return this.setSpeed(e)}setSpeed(e){var i;e!==this._speed&&(ls&&console.log("setSpeed",e),this._speed=e,((i=this._animatorController)==null?void 0:i.animator)==this&&this._animatorController.setSpeed(e))}set minMaxSpeed(e){var i;this._speed=ee.lerp(e.x,e.y,Math.random()),((i=this._animatorController)==null?void 0:i.animator)==this&&this._animatorController.setSpeed(this._speed)}set minMaxOffsetNormalized(e){var i;this._normalizedStartOffset=ee.lerp(e.x,e.y,Math.random()),((i=this.runtimeAnimatorController)==null?void 0:i.animator)==this&&(this.runtimeAnimatorController.normalizedStartOffset=this._normalizedStartOffset)}awake(){ls&&console.log("ANIMATOR",this.name,this),this.gameObject&&this.initializeRuntimeAnimatorController()}initializeRuntimeAnimatorController(e=!1){const i=e||this.runtimeAnimatorController!==this._initializeWithRuntimeAnimatorController;if(this.runtimeAnimatorController&&i){const n=this.runtimeAnimatorController.clone();this._initializeWithRuntimeAnimatorController=n,n?(console.assert(this.runtimeAnimatorController!==n),this.runtimeAnimatorController=n,console.assert(this.runtimeAnimatorController===n),this.runtimeAnimatorController.bind(this),this.runtimeAnimatorController.setSpeed(this._speed),this.runtimeAnimatorController.normalizedStartOffset=this._normalizedStartOffset):console.warn("Could not clone animator controller",this.runtimeAnimatorController)}}onDisable(){var e;this.keepAnimatorControllerStateOnDisable||(e=this._animatorController)==null||e.reset()}onBeforeRender(){this._isDirty=!1,this._parametersAreDirty=!1,!gL(this.gameObject)&&this._animatorController&&this._animatorController.update(1)}}Wg([g()],Ei.prototype,"applyRootMotion",void 0);Wg([g()],Ei.prototype,"hasRootMotion",void 0);Wg([g()],Ei.prototype,"keepAnimatorControllerStateOnDisable",void 0);Wg([g()],Ei.prototype,"runtimeAnimatorController",null);const MS=Symbol("previous-visibility"),wh=class extends Qo{render(t,e,i){if("addPass"in i)this._unsupported_effectcomposer_warning||(console.warn("RenderTexture.render() does not yet support EffectComposer"),this._unsupported_effectcomposer_warning=!0);else if(i instanceof gc){this.onBeforeRender();const o=i.getRenderTarget(),r=i.xr.enabled;i.xr.enabled=!1,i.setRenderTarget(this),i.clear(!0,!0,!0),i.render(t,e),i.setRenderTarget(o),i.xr.enabled=r,this.onAfterRender()}}onBeforeRender(){wh._userSet.clear();const t=NP(this.texture,!0,null,wh._userSet);for(const e of t)e instanceof le&&(e[MS]=e.visible,e.visible=!1)}onAfterRender(){for(const t of wh._userSet)t instanceof le&&(t.visible=t[MS]);wh._userSet.clear()}};let ic=wh;a(ic,"_userSet",new Set);var If=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Op=k("debuggroundprojection");class Kr extends W{constructor(){super(...arguments);a(this,"applyOnAwake",!1);a(this,"autoFit",!0);a(this,"_radius",50);a(this,"_height",3);a(this,"_arblending",0);a(this,"_lastBackground");a(this,"_lastRadius");a(this,"_lastHeight");a(this,"_projection");a(this,"_watcher");a(this,"_needsTextureUpdate",!1);a(this,"_blurrynessShader",null);a(this,"_lastBlurriness",-1)}set radius(e){this._radius=e,this._projection&&this.updateProjection()}get radius(){return this._radius}set height(e){this._height=e,this._projection&&this.updateProjection()}get height(){return this._height}set arBlending(e){this._arblending=e,this._needsTextureUpdate=!0}get arBlending(){return this._arblending}awake(){this.applyOnAwake&&this.updateAndCreate()}onEnable(){this.context.time.frameCount>0&&this.applyOnAwake&&this.updateAndCreate(),this._watcher||(this._watcher=new La(this.context.scene,"background"),this._watcher.subscribeWrite(e=>{Op&&console.log("Background changed",this.context.scene.background),this._needsTextureUpdate=!0}))}onDisable(){var e,i;(e=this._watcher)==null||e.revoke(),(i=this._projection)==null||i.removeFromParent()}onEnterXR(){this.activeAndEnabled&&(this._needsTextureUpdate=!0,this.updateProjection())}async onLeaveXR(){this.activeAndEnabled&&(await kg(1),this.updateProjection())}onBeforeRender(){this._projection&&this.scene.backgroundRotation&&this._projection.rotation.copy(this.scene.backgroundRotation),this.context.scene.backgroundBlurriness!==void 0&&this._lastBlurriness!=this.context.scene.backgroundBlurriness&&this.context.scene.backgroundBlurriness>.001?this.updateProjection():this._needsTextureUpdate&&this.context.scene.background instanceof _t&&this.updateBlurriness(this.context.scene.background,this.context.scene.backgroundBlurriness)}updateAndCreate(){var e;this.updateProjection(),(e=this._watcher)==null||e.apply()}updateProjection(){var r,l,c,h,d,u;if(!this.context.scene.background){(r=this._projection)==null||r.removeFromParent();return}const e=this.context.scene.background;if(!(e instanceof _t)){(l=this._projection)==null||l.removeFromParent();return}if(((c=this.context.xr)!=null&&c.isPassThrough||(h=this.context.xr)!=null&&h.isAR)&&this.arBlending===0){(d=this._projection)==null||d.removeFromParent();return}if(!this.gameObject||this.destroyed)return;let i=!0;const n=0,o=e!==this._lastBackground||this._height!==this._lastHeight||this._radius!==this._lastRadius;if(!this._projection||o){Op&&console.log("Create/Update Ground Projection",e.name),(u=this._projection)==null||u.removeFromParent();try{this._projection=new Xh(e,this._height,this._radius,64)}catch(f){console.error("Error creating three GroundProjection",f);return}this._projection.position.y=this._height-n,this._projection.name="GroundProjection",T1(this._projection,!1)}else i=!1;if(this._projection.parent||this.gameObject.add(this._projection),this.autoFit&&i){this._projection.updateWorldMatrix(!0,!0);const f=On(this.context.scene.children,[this._projection]),p=f.min.y;if(p<1/0){const b=te();b.x=f.min.x+(f.max.x-f.min.x)*.5;const x=Lt(this.gameObject).x;b.y=p+this._height*x-n,b.z=f.min.z+(f.max.z-f.min.z)*.5,Oi(this._projection,b)}Op&&se.DrawWireBox3(f,65280,5)}this.context.scene.backgroundBlurriness>.001&&this._needsTextureUpdate&&this.updateBlurriness(e,this.context.scene.backgroundBlurriness),this._lastBackground=e,this._lastHeight=this._height,this._lastRadius=this._radius,this._needsTextureUpdate=!1}updateBlurriness(e,i){var o;if(this._projection){if(!e)return}else return;this._needsTextureUpdate=!1,Op&&console.log("Update Blurriness",i),this._blurrynessShader??(this._blurrynessShader=new Xo({name:"GroundProjectionBlurriness",uniforms:{map:{value:e},blurriness:{value:i},blending:{value:0},alphaFactor:{value:1}},vertexShader:vL,fragmentShader:xL})),this._blurrynessShader.depthWrite=!1,this._blurrynessShader.uniforms.map.value=e,this._blurrynessShader.uniforms.blurriness.value=i,this._lastBlurriness=i,e.needsUpdate=!0;const n=this._projection.material.transparent;this._projection.material.transparent=(((o=this.context.xr)==null?void 0:o.isAR)===!0&&this.arBlending>1e-6)??!1,this._projection.material.transparent?this._blurrynessShader.uniforms.blending.value=this.arBlending:this._blurrynessShader.uniforms.blending.value=0,this.context.isInPassThrough?this._blurrynessShader.uniforms.alphaFactor.value=.95:this._blurrynessShader.uniforms.alphaFactor.value=1,n!==this._projection.material.transparent&&(this._projection.material.needsUpdate=!0),this._projection.material.map=Fn.copyTexture(e,this._blurrynessShader),this._projection.material.depthTest=!0,this._projection.material.depthWrite=!1}}If([g()],Kr.prototype,"applyOnAwake",void 0);If([g()],Kr.prototype,"autoFit",void 0);If([g()],Kr.prototype,"radius",null);If([g()],Kr.prototype,"height",null);If([g()],Kr.prototype,"arBlending",null);const vL=`
  varying vec2 vUv;

  void main() {
    vUv = uv;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
  }
`,xL=`
  uniform sampler2D map;
  uniform float blurriness;
  uniform float alphaFactor;
  uniform float blending;
  varying vec2 vUv;

  const float PI = 3.14159265359;

  // Gaussian function
  float gaussian(float x, float sigma) {
    return exp(-(x * x) / (2.0 * sigma * sigma)) / (sqrt(2.0 * PI) * sigma);
  }

  // Custom smoothstep function for desired falloff
  float customSmoothstep(float edge0, float edge1, float x) {
    float t = clamp((x - edge0) / (edge1 - edge0), 0.0, 1.0);
    return t * t * (3.0 - 2.0 * t);
  }

  void main() {
    vec2 center = vec2(0.0, 0.0);
    vec2 pos = vUv;
    pos.x = 0.0; // Only consider vertical distance
    float distance = length(pos - center);
    
    // Calculate blur amount based on custom falloff
    float blurAmount = customSmoothstep(0.5, 1.0, distance * 2.0);
    blurAmount = clamp(blurAmount, 0.0, 1.0); // Ensure blur amount is within valid range

    // Gaussian blur
    vec2 pixelSize = 1.0 / vec2(textureSize(map, 0));
    vec4 color = vec4(0.0);
    float totalWeight = 0.0;
    int blurSize = int(60.0 * min(1.0, blurriness) * blurAmount); // Adjust blur size based on distance and blurriness
    float lodLevel = log2(float(blurSize)) * 0.5; // Compute LOD level

    for (int x = -blurSize; x <= blurSize; x++) {
        for (int y = -blurSize; y <= blurSize; y++) {
            vec2 offset = vec2(float(x), float(y)) * pixelSize * blurAmount;
            float weight = gaussian(length(vec2(float(x), float(y))), 1000.0 * blurAmount); // Use a fixed sigma value
            color += textureLod(map, vUv + offset, lodLevel) * weight;
            totalWeight += weight;
        }
    }

    color = totalWeight > 0.0 ? color / totalWeight : texture2D(map, vUv);

    gl_FragColor = color;

    float brightness = dot(gl_FragColor.rgb, vec3(0.299, 0.587, 0.114));
    float stepFactor = blending - brightness * .1;
    gl_FragColor.a = pow(1.0 - blending * customSmoothstep(0.35 * stepFactor, 0.45 * stepFactor, distance), 5.);
    gl_FragColor.a *= alphaFactor;
    // gl_FragColor.rgb = vec3(1.0);

    // #include <tonemapping_fragment>
    // #include <colorspace_fragment>
    
    // Uncomment to visualize blur amount
    // gl_FragColor = vec4(blurAmount, 0.0, 0.0, 1.0);
  }
`;function wL(s){if(fe.active)return console.warn("[OrbitControls] Can not fit camera while XR session is active"),null;const t=de.Current;if(!t)return console.warn("[OrbitControls] No context found"),null;const e=(s==null?void 0:s.camera)||t.mainCamera;if(!e)return console.warn("No camera or controls found to fit camera to objects..."),null;s||(s={}),s.autoApply=s.autoApply!==!1,s.minZoom||(s.minZoom=0),s.maxZoom||(s.maxZoom=1/0);const{centerCamera:i,cameraNearFar:n="auto",fitOffset:o=1.1,fov:r=e instanceof Ae?e==null?void 0:e.fov:-1}=s,l=new R,c=new R,h=e instanceof Ae?e.aspect:1,d=s.objects||t.scene,u=On(d,void 0,e==null?void 0:e.layers),f=u.clone();u.getCenter(c);const p=new R;if(u.getSize(p),e instanceof Ae&&e.updateProjectionMatrix(),e.updateMatrixWorld(),u.applyMatrix4(e.matrixWorldInverse),u.getSize(l),u.setFromCenterAndSize(c,l),Number.isNaN(l.x)||Number.isNaN(l.y)||Number.isNaN(l.z))return console.warn("Camera fit size resultet in NaN",e,u),null;if(l.length()<=1e-10)return console.warn("Camera fit size is zero",u),null;const b=r,x=2*Math.atan(Math.tan(b*Math.PI/360/2)*h)/Math.PI*360,v=l.y/(2*Math.atan(Math.PI*b/360)),S=l.x/(2*Math.atan(Math.PI*x/360)),C=o*Math.max(v,S)+l.z/2;s.maxZoom=C*10,s.minZoom=C*.01,s.debug===!0&&console.log("Fit camera to objects",{fitHeightDistance:v,fitWidthDistance:S,distance:C,verticalFov:b,horizontalFov:x});const P=.05,E=c.clone();if(E.y-=l.y*P,s.targetOffset&&(s.targetOffset.x!==void 0&&(E.x+=s.targetOffset.x),s.targetOffset.y!==void 0&&(E.y+=s.targetOffset.y),s.targetOffset.z!==void 0&&(E.z+=s.targetOffset.z)),s.relativeTargetOffset&&(s.relativeTargetOffset.x!==void 0&&(E.x+=s.relativeTargetOffset.x*l.x),s.relativeTargetOffset.y!==void 0&&(E.y+=s.relativeTargetOffset.y*l.y),s.relativeTargetOffset.z!==void 0&&(E.z+=s.relativeTargetOffset.z*l.z)),n==null||n=="auto"){const A=Ef(Kr),G=A?A.radius:0,V=Math.max(p.x,p.y,p.z,G);e instanceof Ae&&(e.near=C/100,e.far=V+C*10,e.updateProjectionMatrix()),A&&(s.maxZoom=Math.max(Math.min(s.maxZoom,G*.5),C))}s.currentZoom!==void 0&&(s.currentZoom<s.minZoom&&(s.minZoom=s.currentZoom*.9),s.currentZoom>s.maxZoom&&(s.maxZoom=s.currentZoom*1.1));const D=c.clone();s.fitDirection?D.sub(new R().copy(s.fitDirection).multiplyScalar(1e6)):D.sub(e.worldPosition),i==="y"&&(D.y=0),D.normalize(),D.multiplyScalar(C),i==="y"&&(D.y+=-P*4*C);let M=c.clone().sub(D);return s.cameraOffset&&(s.cameraOffset.x!==void 0&&(M.x+=s.cameraOffset.x),s.cameraOffset.y!==void 0&&(M.y+=s.cameraOffset.y),s.cameraOffset.z!==void 0&&(M.z+=s.cameraOffset.z)),s.relativeCameraOffset&&(s.relativeCameraOffset.x!==void 0&&(M.x+=s.relativeCameraOffset.x*l.x),s.relativeCameraOffset.y!==void 0&&(M.y+=s.relativeCameraOffset.y*l.y),s.relativeCameraOffset.z!==void 0&&(M.z+=s.relativeCameraOffset.z*l.z)),e.parent&&(M=e.parent.worldToLocal(M)),s.debug&&(se.DrawWireBox3(u,16777011,10),se.DrawWireBox3(f,65280,10)),s.autoApply&&(e.position.copy(M),e.lookAt(E),r>0&&e instanceof Ae&&(e.fov=r,e.updateProjectionMatrix())),{camera:e,position:M,lookAt:E,fov:s.fov}}var uv=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class cd extends W{constructor(){super(...arguments);a(this,"constraintActive",!0);a(this,"locked",!1);a(this,"sources",[])}setConstraintPosition(e){const i=this.sources[0];i&&(i.worldPosition=e)}}uv([g()],cd.prototype,"constraintActive",void 0);uv([g()],cd.prototype,"locked",void 0);uv([g(z)],cd.prototype,"sources",void 0);let nc=class{constructor(){a(this,"bb",null);a(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}x(){return this.bb.readFloat32(this.bb_pos)}y(){return this.bb.readFloat32(this.bb_pos+4)}z(){return this.bb.readFloat32(this.bb_pos+8)}static sizeOf(){return 12}static createVec3(t,e,i,n){return t.prep(4,12),t.writeFloat32(n),t.writeFloat32(i),t.writeFloat32(e),t.offset()}};class CT{constructor(){a(this,"bb",null);a(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}position(t){return(t||new nc).__init(this.bb_pos,this.bb)}rotation(t){return(t||new nc).__init(this.bb_pos+12,this.bb)}scale(t){return(t||new nc).__init(this.bb_pos+24,this.bb)}static sizeOf(){return 36}static createTransform(t,e,i,n,o,r,l,c,h,d){return t.prep(4,36),t.prep(4,12),t.writeFloat32(d),t.writeFloat32(h),t.writeFloat32(c),t.prep(4,12),t.writeFloat32(l),t.writeFloat32(r),t.writeFloat32(o),t.prep(4,12),t.writeFloat32(n),t.writeFloat32(i),t.writeFloat32(e),t.offset()}}class Or{constructor(){a(this,"bb",null);a(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}static getRootAsSyncedTransformModel(t,e){return(e||new Or).__init(t.readInt32(t.position())+t.position(),t)}static getSizePrefixedRootAsSyncedTransformModel(t,e){return t.setPosition(t.position()+H0),(e||new Or).__init(t.readInt32(t.position())+t.position(),t)}guid(t){const e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__string(this.bb_pos+e,t):null}fast(){const t=this.bb.__offset(this.bb_pos,6);return t?!!this.bb.readInt8(this.bb_pos+t):!1}transform(t){const e=this.bb.__offset(this.bb_pos,8);return e?(t||new CT).__init(this.bb_pos+e,this.bb):null}dontSave(){const t=this.bb.__offset(this.bb_pos,10);return t?!!this.bb.readInt8(this.bb_pos+t):!1}static startSyncedTransformModel(t){t.startObject(4)}static addGuid(t,e){t.addFieldOffset(0,e,0)}static addFast(t,e){t.addFieldInt8(1,+e,0)}static addTransform(t,e){t.addFieldStruct(2,e,0)}static addDontSave(t,e){t.addFieldInt8(3,+e,0)}static endSyncedTransformModel(t){return t.endObject()}static finishSyncedTransformModelBuffer(t,e){t.finish(e)}static finishSizePrefixedSyncedTransformModelBuffer(t,e){t.finish(e,void 0,!0)}}var q;(function(s){(function(t){t.MAYBEMODULE=null;const e=[];function i(){return t.MODULE?Promise.resolve(t.MODULE):new Promise(o=>{e.push(o)})}t.ready=i;async function n(){if(t.MODULE)return t.MODULE;const o=await qs(()=>import("./rapier3d.7bf9deb5.js"),[],import.meta.url);return t.MODULE=o,t.MAYBEMODULE=o,e.forEach(r=>r(o)),e.length=0,o}t.load=n})(s.RAPIER_PHYSICS||(s.RAPIER_PHYSICS={})),function(t){t.MAYBEMODULE=null;const e=[];function i(){return t.MODULE?Promise.resolve(t.MODULE):new Promise(o=>{e.push(o)})}t.ready=i;async function n(){if(t.MODULE)return t.MODULE;const o=await qs(()=>import("./postprocessing.170e2adf.js"),["./postprocessing.170e2adf.js","./three@0.169.15.js"],import.meta.url);return t.MODULE=o,t.MAYBEMODULE=o,e.forEach(r=>r(o)),e.length=0,o}t.load=n}(s.POSTPROCESSING||(s.POSTPROCESSING={})),function(t){t.MAYBEMODULE=null;const e=[];function i(){return t.MODULE?Promise.resolve(t.MODULE):new Promise(o=>{e.push(o)})}t.ready=i;async function n(){if(t.MODULE)return t.MODULE;const o=await qs(()=>import("./postprocessing.ao.16e71e12.js"),["./postprocessing.ao.16e71e12.js","./three@0.169.15.js","./three-examples.efffc148.js","./postprocessing.170e2adf.js"],import.meta.url);return t.MODULE=o,t.MAYBEMODULE=o,e.forEach(r=>r(o)),e.length=0,o}t.load=n}(s.POSTPROCESSING_AO||(s.POSTPROCESSING_AO={}))})(q||(q={}));var Qt;(function(s){s[s.Average=0]="Average",s[s.Multiply=1]="Multiply",s[s.Minimum=2]="Minimum",s[s.Maximum=3]="Maximum"})(Qt||(Qt={}));var Fm;(function(s){s[s.Discrete=0]="Discrete",s[s.Continuous=1]="Continuous"})(Fm||(Fm={}));var Mt;(function(s){s[s.None=0]="None",s[s.FreezePositionX=2]="FreezePositionX",s[s.FreezePositionY=4]="FreezePositionY",s[s.FreezePositionZ=8]="FreezePositionZ",s[s.FreezePosition=14]="FreezePosition",s[s.FreezeRotationX=16]="FreezeRotationX",s[s.FreezeRotationY=32]="FreezeRotationY",s[s.FreezeRotationZ=64]="FreezeRotationZ",s[s.FreezeRotation=112]="FreezeRotation",s[s.FreezeAll=126]="FreezeAll"})(Mt||(Mt={}));var dh;(function(s){s[s.None=0]="None",s[s.X=2]="X",s[s.Y=4]="Y",s[s.Z=8]="Z",s[s.All=-1]="All"})(dh||(dh={}));const en=function(s,t){return function(e,i,n){SL(e,i,n,s,t)}};function SL(s,t,e,i,n){if(!n&&!i&&!s.onValidate)return;if(e!==void 0){console.error("Invalid usage of validate decorator. Only fields can be validated.",s,t,e),at("Invalid usage of validate decorator. Only fields can be validated. Property: "+t,Ti.Error);return}let o="";if(typeof t=="string"?o=t:o=t.name,s.__internalAwake){const r=Symbol(o),l=s.__internalAwake;s.__internalAwake=function(){var c;if(!this.onValidate){X()&&console.warn('Usage of @validate decorate detected but there is no onValidate method in your class: "'+((c=s.constructor)==null?void 0:c.name)+'"');return}if(this[r]===void 0){this[r]=this[o];const h=this[o];if(h instanceof _e||h instanceof R||h instanceof Ne||h instanceof re){const d=this[o];B0(d,()=>{this.onValidate(o)})}Object.defineProperty(this,o,{set:function(d){var u;if(this[$_]===!0)this[r]=d;else{i==null||i.call(this,d);const f=this[r];this[r]=d,(u=this.onValidate)==null||u.call(this,o,f)}},get:function(){return n==null||n.call(this),this[r]}})}l.call(this)}}}const B4=function(s){return function(t,e,i){let n="";typeof e=="string"?n=e:n=e.name;const o=s.prototype,r=Object.getOwnPropertyDescriptor(o,n);if(!(r!=null&&r.value)){console.warn("Can not apply prefix: type does not have method named",e,s);return}const l=r.value,c=t[n];Object.defineProperty(o,n,{value:function(...h){const d=c==null?void 0:c.call(this,...h);if(d instanceof Promise){d.then(u=>{if(u!==!1)return l.call(this,...h)});return}if(d!==!1)return l.call(this,...h)}})}};var Yn=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class CL{constructor(t,e){a(this,"positionChanged",!1);a(this,"rotationChanged",!1);a(this,"position");a(this,"quaternion");a(this,"_positionKeys",["x","y","z"]);a(this,"_quaternionKeys",["_x","_y","_z","_w"]);a(this,"mute",!1);a(this,"context");a(this,"obj");a(this,"_positionWatch");a(this,"_rotationWatch");this.context=e,this.obj=t}get isDirty(){return this.positionChanged||this.rotationChanged}reset(t=!1){if(this.positionChanged=!1,this.rotationChanged=!1,this.mute=!1,t){if(this.position)for(const e of this._positionKeys)delete this.position[e];if(this.quaternion)for(const e of this._quaternionKeys)delete this.quaternion[e]}}syncValues(){for(const t of this._positionKeys)this.position[t]=this.obj.position[t];for(const t of this._quaternionKeys)this.quaternion[t]=this.obj.quaternion[t]}applyValues(){if(this.positionChanged&&this.position)for(const t of this._positionKeys){const e=this.position[t];e!==void 0&&(this.obj.position[t]=e)}if(this.rotationChanged&&this.quaternion)for(const t of this._quaternionKeys){const e=this.quaternion[t];e!==void 0&&(this.obj.quaternion[t]=e)}}start(t,e){this.reset(),t&&(this._positionWatch||(this._positionWatch=new La(this.obj.position,["x","y","z"])),this._positionWatch.apply(),this.position={},this._positionWatch.subscribeWrite((o,r)=>{var c;if((c=this.context.physics.engine)!=null&&c.isUpdating||this.mute)return;const l=this.position[r];Math.abs(l-o)<1e-5||(this.position[r]=o,this.positionChanged=!0)})),e&&(this._rotationWatch||(this._rotationWatch=new La(this.obj.quaternion,["_x","_y","_z","_w"])),this._rotationWatch.apply(),this.quaternion={},this._rotationWatch.subscribeWrite((o,r)=>{var c;if((c=this.context.physics.engine)!=null&&c.isUpdating||this.mute)return;const l=this.quaternion[r];Math.abs(l-o)<1e-5||(this.quaternion[r]=o,this.rotationChanged=!0)}));const i=this.obj.matrixWorld.multiplyMatrices.bind(this.obj.matrixWorld),n=new xe;this.obj.matrixWorld.multiplyMatrices=(o,r)=>{var l;return(l=this.context.physics.engine)!=null&&l.isUpdating||this.mute||n.equals(o)||(this.positionChanged=!0,this.rotationChanged=!0,n.copy(o)),i(o,r)}}stop(){var t,e;(t=this._positionWatch)==null||t.revoke(),(e=this._rotationWatch)==null||e.revoke()}}const ef=class extends W{constructor(){super(...arguments);a(this,"autoMass",!0);a(this,"_mass",0);a(this,"useGravity",!0);a(this,"centerOfMass",new R(0,0,0));a(this,"constraints",Mt.None);a(this,"isKinematic",!1);a(this,"drag",0);a(this,"angularDrag",1);a(this,"detectCollisions",!0);a(this,"sleepThreshold",.01);a(this,"collisionDetectionMode",Fm.Discrete);a(this,"_gravityScale",1);a(this,"dominanceGroup",0);a(this,"_propertiesChanged",!1);a(this,"_currentVelocity",new R);a(this,"_smoothedVelocity",new R);a(this,"_smoothedVelocityGetter",new R);a(this,"_lastPosition",new R);a(this,"_watch")}get isRigidbody(){return!0}set mass(e){e!==this._mass&&(this._mass=e,this._propertiesChanged=!0,this.__didAwake&&(this.autoMass=!1))}get mass(){var e,i;return this.autoMass?((i=(e=this.context.physics.engine)==null?void 0:e.getBody(this))==null?void 0:i.mass())??-1:this._mass}get lockPositionX(){return(this.constraints&Mt.FreezePositionX)!==0}get lockPositionY(){return(this.constraints&Mt.FreezePositionY)!==0}get lockPositionZ(){return(this.constraints&Mt.FreezePositionZ)!==0}get lockRotationX(){return(this.constraints&Mt.FreezeRotationX)!==0}get lockRotationY(){return(this.constraints&Mt.FreezeRotationY)!==0}get lockRotationZ(){return(this.constraints&Mt.FreezeRotationZ)!==0}set lockPositionX(e){e?this.constraints|=Mt.FreezePositionX:this.constraints&=~Mt.FreezePositionX}set lockPositionY(e){e?this.constraints|=Mt.FreezePositionY:this.constraints&=~Mt.FreezePositionY}set lockPositionZ(e){e?this.constraints|=Mt.FreezePositionZ:this.constraints&=~Mt.FreezePositionZ}set lockRotationX(e){e?this.constraints|=Mt.FreezeRotationX:this.constraints&=~Mt.FreezeRotationX}set lockRotationY(e){e?this.constraints|=Mt.FreezeRotationY:this.constraints&=~Mt.FreezeRotationY}set lockRotationZ(e){e?this.constraints|=Mt.FreezeRotationZ:this.constraints&=~Mt.FreezeRotationZ}set gravityScale(e){this._gravityScale=e}get gravityScale(){return this._gravityScale}awake(){this._watch=void 0,this._propertiesChanged=!1}onEnable(){this._watch||(this._watch=new CL(this.gameObject,this.context)),this._watch.start(!0,!0),this.startCoroutine(this.beforePhysics(),ge.LateUpdate),X()&&(globalThis.true?q.RAPIER_PHYSICS.ready().then(async()=>{var e;await kg(3),(e=this.context.physics.engine)!=null&&e.getBody(this)||console.warn(`Rigidbody could not be created. Ensure "${this.name}" has a Collider component.`)}):console.warn("Rigidbody could not be created: Rapier physics are explicitly disabled."))}onDisable(){var e,i;(e=this._watch)==null||e.stop(),(i=this.context.physics.engine)==null||i.removeBody(this)}onDestroy(){var e;(e=this.context.physics.engine)==null||e.removeBody(this)}onValidate(){this._propertiesChanged=!0}*beforePhysics(){var e,i,n,o;for(;;)this._propertiesChanged&&(this._propertiesChanged=!1,(e=this.context.physics.engine)==null||e.updateProperties(this)),(i=this._watch)!=null&&i.isDirty?(this._watch.mute=!0,this._watch.applyValues(),(n=this.context.physics.engine)==null||n.updateBody(this,this._watch.positionChanged,this._watch.rotationChanged),this._watch.reset()):(o=this._watch)==null||o.syncValues(),this.captureVelocity(),yield}teleport(e,i=!0){var n;(n=this._watch)==null||n.reset(!0),i?this.gameObject.position.set(e.x,e.y,e.z):this.setWorldPosition(e.x,e.y,e.z),this.resetForcesAndTorques(),this.resetVelocities()}resetForces(e=!0){var i;(i=this.context.physics.engine)==null||i.resetForces(this,e)}resetTorques(e=!0){var i;(i=this.context.physics.engine)==null||i.resetTorques(this,e)}resetVelocities(){this.setVelocity(0,0,0),this.setAngularVelocity(0,0,0)}resetForcesAndTorques(){this.resetForces(),this.resetTorques()}wakeUp(){var e;(e=this.context.physics.engine)==null||e.wakeup(this)}get isSleeping(){var e;return(e=this.context.physics.engine)==null?void 0:e.isSleeping(this)}updateProperties(){var e;return this._propertiesChanged=!1,(e=this.context.physics.engine)==null?void 0:e.updateProperties(this)}applyForce(e,i,n=!0){var o;this._propertiesChanged&&this.updateProperties(),(o=this.context.physics.engine)==null||o.addForce(this,e,n)}applyImpulse(e,i=!0){var n;this._propertiesChanged&&this.updateProperties(),(n=this.context.physics.engine)==null||n.applyImpulse(this,e,i)}setForce(e,i,n,o=!0){var r,l,c;(r=this.context.physics.engine)==null||r.resetForces(this,o),typeof e=="number"?(i??(i=0),n??(n=0),(l=this.context.physics.engine)==null||l.addForce(this,{x:e,y:i,z:n},o)):(c=this.context.physics.engine)==null||c.addForce(this,e,o)}getVelocity(){var i;const e=(i=this.context.physics.engine)==null?void 0:i.getLinearVelocity(this);return e?(this._currentVelocity.x=e.x,this._currentVelocity.y=e.y,this._currentVelocity.z=e.z,this._currentVelocity):this._currentVelocity.set(0,0,0)}setVelocity(e,i,n,o=!0){var r,l;if(e instanceof R){const c=e;(r=this.context.physics.engine)==null||r.setLinearVelocity(this,c,o);return}i===void 0||n===void 0||(l=this.context.physics.engine)==null||l.setLinearVelocity(this,{x:e,y:i,z:n},o)}getAngularVelocity(){var i;const e=(i=this.context.physics.engine)==null?void 0:i.getAngularVelocity(this);return e?(this._currentVelocity.x=e.x,this._currentVelocity.y=e.y,this._currentVelocity.z=e.z,this._currentVelocity):this._currentVelocity.set(0,0,0)}setAngularVelocity(e,i,n,o=!0){var r,l;if(typeof e=="object"){const c=e;(r=this.context.physics.engine)==null||r.setAngularVelocity(this,c,o);return}if(i===void 0||n===void 0||typeof i=="boolean"){console.warn("setAngularVelocity expects either a Vec3 or 3 numbers");return}(l=this.context.physics.engine)==null||l.setAngularVelocity(this,{x:e,y:i,z:n},o)}setTorque(e,i,n){typeof e=="number"?this.setAngularVelocity(e,i,n):this.setAngularVelocity(e)}get smoothedVelocity(){return this._smoothedVelocityGetter.copy(this._smoothedVelocity),this._smoothedVelocityGetter.multiplyScalar(1/this.context.time.deltaTime)}setBodyFromGameObject(e=null){}captureVelocity(){const e=this.gameObject.matrixWorld;ef.tempPosition.setFromMatrixPosition(e);const i=ef.tempPosition.sub(this._lastPosition);this._lastPosition.copy(ef.tempPosition),this._smoothedVelocity.lerp(i,this.context.time.deltaTime/.1)}};let De=ef;a(De,"tempPosition",new R);Yn([en()],De.prototype,"autoMass",void 0);Yn([g()],De.prototype,"mass",null);Yn([en(),g()],De.prototype,"useGravity",void 0);Yn([g(R)],De.prototype,"centerOfMass",void 0);Yn([en(),g()],De.prototype,"constraints",void 0);Yn([en(),g()],De.prototype,"isKinematic",void 0);Yn([en(),g()],De.prototype,"drag",void 0);Yn([en(),g()],De.prototype,"angularDrag",void 0);Yn([en(),g()],De.prototype,"detectCollisions",void 0);Yn([en(),g()],De.prototype,"sleepThreshold",void 0);Yn([en(),g()],De.prototype,"collisionDetectionMode",void 0);Yn([en()],De.prototype,"_gravityScale",void 0);Yn([en()],De.prototype,"dominanceGroup",void 0);new R;new R;const ya=k("debugsync"),bf="STRS";W1(bf,Or.getRootAsSyncedTransformModel);const uo=new Tf;function PT(s,t,e=!0){uo.clear();const i=uo.createString(s);Or.startSyncedTransformModel(uo),Or.addGuid(uo,i),Or.addFast(uo,e);const n=t.worldPosition,o=t.worldEuler,r=t.gameObject.scale;Or.addTransform(uo,CT.createTransform(uo,n.x,n.y,n.z,o.x,o.y,o.z,r.x,r.y,r.z));const l=Or.endSyncedTransformModel(uo);return uo.finish(l,bf),uo.asUint8Array()}let Z_=0,Ou=0;bT(s=>{var i;const e=((i=s.connection.currentServerUrl)==null?void 0:i.includes("glitch"))?10:40;Ou=Math.floor(Z_/e),Z_=0,ya&&Ou>0&&console.log("Sync Transform Fast Interval",Ou)});class Zo extends W{constructor(){super(...arguments);a(this,"overridePhysics",!0);a(this,"interpolatePosition",!0);a(this,"interpolateRotation",!0);a(this,"fastMode",!1);a(this,"syncDestroy",!1);a(this,"_model",null);a(this,"_needsUpdate",!0);a(this,"rb",null);a(this,"_wasKinematic",!1);a(this,"_receivedDataBefore",!1);a(this,"_targetPosition");a(this,"_targetRotation");a(this,"_receivedFastUpdate",!1);a(this,"_shouldRequestOwnership",!1);a(this,"joinedRoomCallback",null);a(this,"receivedDataCallback",null);a(this,"tempEuler",new Ht);a(this,"receivedUpdate",!1);a(this,"lastPosition");a(this,"lastRotation");a(this,"lastScale")}requestOwnership(){ya&&console.log("Request ownership"),this._model?this._model.requestOwnership():(this._shouldRequestOwnership=!0,this._needsUpdate=!0)}freeOwnership(){var e;(e=this._model)==null||e.freeOwnership()}hasOwnership(){var e;return((e=this._model)==null?void 0:e.hasOwnership)??void 0}isOwned(){var e;return(e=this._model)==null?void 0:e.isOwned}awake(){ya&&console.log("new instance",this.guid,this),this._receivedDataBefore=!1,this._targetPosition=new R,this._targetRotation=new re,this.lastPosition=new R,this.lastRotation=new re,this.lastScale=new R,this.rb=I.getComponentInChildren(this.gameObject,De),this.rb&&(this._wasKinematic=this.rb.isKinematic),this.receivedUpdate=!0,this._model=new LP(this.context.connection,this.guid),this.context.connection.isConnected&&this.tryGetLastState(),this.joinedRoomCallback=this.tryGetLastState.bind(this),this.context.connection.beginListen(me.JoinedRoom,this.joinedRoomCallback),this.receivedDataCallback=this.onReceivedData.bind(this),this.context.connection.beginListenBinary(bf,this.receivedDataCallback)}onDestroy(){this.syncDestroy&&GP(this.guid,this.context.connection),this._model=null,this.context.connection.stopListen(me.JoinedRoom,this.joinedRoomCallback),this.context.connection.stopListenBinary(bf,this.receivedDataCallback)}tryGetLastState(){const e=this.context.connection.tryGetState(this.guid);e&&this.onReceivedData(e)}onReceivedData(e){var i;if(!this.destroyed&&typeof e.guid=="function"&&e.guid()===this.guid){ya&&console.log("new data",this.context.connection.connectionId,this.context.time.frameCount,this.guid,e),this.receivedUpdate=!0,this._receivedFastUpdate=e.fast();const n=e.transform();if(n){Qs.markDirty(this.gameObject,!0);const o=n.position();o&&(this.interpolatePosition&&((i=this._targetPosition)==null||i.set(o.x(),o.y(),o.z())),(!this.interpolatePosition||!this._receivedDataBefore)&&this.setWorldPosition(o.x(),o.y(),o.z()));const r=n.rotation();r&&(this.tempEuler.set(r.x(),r.y(),r.z()),this.interpolateRotation&&this._targetRotation.setFromEuler(this.tempEuler),(!this.interpolateRotation||!this._receivedDataBefore)&&P1(this.gameObject,this.tempEuler));const l=n.scale();l&&this.gameObject.scale.set(l.x(),l.y(),l.z())}this._receivedDataBefore=!0}}onEnable(){this.lastPosition.copy(this.worldPosition),this.lastRotation.copy(this.worldQuaternion),this.lastScale.copy(this.gameObject.scale),this._needsUpdate=!0,this._model&&this._model.updateIsOwned()}onDisable(){this._model&&this._model.freeOwnership()}onBeforeRender(){if(!this.activeAndEnabled||!this.context.connection.isConnected)return;if(!this.context.connection.isInRoom||!this._model){ya&&console.log("no model or room",this.name,this.guid,this.context.connection.isInRoom);return}this._shouldRequestOwnership&&(this._shouldRequestOwnership=!1,this._model.requestOwnership());const e=this.worldPosition,i=this.worldQuaternion,n=this.gameObject.scale;if(this._model.isOwned&&!this.receivedUpdate){const l=this._model.hasOwnership||this.fastMode?1e-4:.001;(e.distanceTo(this.lastPosition)>l||i.angleTo(this.lastRotation)>l||n.distanceTo(this.lastScale)>l)&&(this._model.hasOwnership?this._needsUpdate=!0:(ya&&console.log(this.guid,"reset because not owned but",this.gameObject.name,this.lastPosition),this.worldPosition=this.lastPosition,e.copy(this.lastPosition),this.worldQuaternion=this.lastRotation,i.copy(this.lastRotation),this.gameObject.scale.copy(this.lastScale),Qs.markDirty(this.gameObject,!0),this._needsUpdate=!1))}if(this._model&&!this._model.hasOwnership&&this._model.isOwned&&this._receivedDataBefore){const l=this._receivedFastUpdate||this.fastMode?.5:.3;let c=!1;if(this.interpolatePosition&&this._targetPosition){const h=this.worldPosition;h.lerp(this._targetPosition,l),this.worldPosition=h,c=!0}if(this.interpolateRotation&&this._targetRotation){const h=this.worldQuaternion;h.slerp(this._targetRotation,l),this.worldQuaternion=h,c=!0}c&&Qs.markDirty(this.gameObject,!0)}if(this.receivedUpdate=!1,this.lastPosition.copy(e),this.lastRotation.copy(i),this.lastScale.copy(n),!this._model||!this._model||this._model.hasOwnership===void 0||!this._model.hasOwnership)return;this.rb&&this.overridePhysics&&this._wasKinematic!==void 0&&(ya&&console.log("reset kinematic",this.rb.name,this._wasKinematic),this.rb.isKinematic=this._wasKinematic);const o=10,r=this.rb||this.fastMode;if(this._needsUpdate&&(this.context.time.frameCount%o===0||r)){if(Z_++,r&&Ou>0&&this.context.time.frameCount%Ou!==0)return;ya&&console.debug("[SyncedTransform] Send update",this.context.connection.connectionId,this.guid,this.gameObject.name,this.gameObject.guid),this._needsUpdate=!1;const l=PT(this.guid,this,!!r);this.context.connection.sendBinary(l)}}}class Hg{constructor(t,e){a(this,"event");a(this,"button");a(this,"buttonName");a(this,"_used",!1);a(this,"_propagationStopped",!1);a(this,"z__pointer_ctured",!1);a(this,"z__pointer_cture_rleased",!1);a(this,"inputSource");a(this,"object");a(this,"point");a(this,"normal");a(this,"face");a(this,"distance");a(this,"instanceId");a(this,"intersection");a(this,"isDown");a(this,"isUp");a(this,"isPressed");a(this,"isClick");a(this,"isDoubleClick");a(this,"input");this.event=e,this.input=t,this.button=e.button}get deviceIndex(){return this.event.deviceIndex}get pointerId(){return this.event.pointerId}get pressure(){return this.event.pressure}get used(){return this._used}use(){this._used||(this._used=!0,this.event.use())}get propagationStopped(){return this._propagationStopped}stopPropagation(){this._propagationStopped=!0,this.event.stopImmediatePropagation()}stopImmediatePropagation(){this._propagationStopped=!0,this.event.stopImmediatePropagation()}setPointerCapture(){this.z__pointer_ctured=!0}releasePointerCapture(){this.z__pointer_cture_rleased=!0}get mode(){return this.event.mode}clone(){const t=new Hg(this.input,this.event);return Object.assign(t,this),t}Use(){this.use()}StopPropagation(){this.event.stopImmediatePropagation()}}function J_(s,t){return I.foreachComponent(s,i=>{if(!i.enabled)return;const n=i;if(t)switch(t){case"pointerdown":if(n.onPointerDown)return!0;break;case"pointerup":if(n.onPointerUp||n.onPointerClick)return!0;break;case"pointermove":if(n.onPointerEnter||n.onPointerExit||n.onPointerMove)return!0;break}else if(n.onPointerDown||n.onPointerUp||n.onPointerEnter||n.onPointerExit||n.onPointerClick)return!0},!1)===!0}const gr=new Array;class Pa{constructor(t,e,i,n){a(this,"enabled",!0);a(this,"target");a(this,"methodName");a(this,"arguments");this.target=t,this.methodName=e||null,this.arguments=i,n!=null&&(this.enabled=n)}get canClone(){return this.target instanceof Object}invoke(...t){if(this.enabled!==!1){if(typeof this.target=="function")this.arguments?(gr.length=0,t!==void 0&&t.length>0&&gr.push(...t),gr.push(...this.arguments),this.target(...this.arguments),gr.length=0):this.target(...t);else if(this.methodName!=null){const e=this.target[this.methodName];typeof e=="function"?this.arguments?(gr.length=0,t!==void 0&&t.length>0&&gr.push(...t),gr.push(...this.arguments),e.call(this.target,...gr),gr.length=0):e.call(this.target,...t):this.arguments?t!==void 0&&t.length>0?this.target[this.methodName]=t[0]:this.target[this.methodName]=this.arguments[0]:this.target[this.methodName]=t[0]}}}}const PL=s=>/^[A-Z]*$/.test(s);class fv extends Event{constructor(){super(...arguments);a(this,"args")}}class je{constructor(t){a(this,"isEventList",!0);a(this,"target");a(this,"key");a(this,"_isInvoking",!1);a(this,"methods",[]);a(this,"_methodsCopy",[]);if(this.methods=[],Array.isArray(t))for(const e of t)e instanceof Pa?this.methods.push(e):typeof e=="function"&&this.methods.push(new Pa(e));else typeof t=="function"&&this.methods.push(new Pa(t))}__internalOnInstantiate(t){var n;const e=new Array;for(let o=0;o<this.methods.length;o++){const r=this.methods[o];if(!(r.target instanceof Function)){const l=r.target;let c=l==null?void 0:l.uuid;if(l&&(c=l.guid),c){const h=t[c];if(h){const d=(n=r.arguments)==null?void 0:n.map(u=>u instanceof Object&&u.uuid?t[u.uuid]:u!=null&&u.isComponent?t[u.guid]:u);e.push(new Pa(h.clone,r.methodName,d,r.enabled))}else X()&&console.warn("Could not find target for event listener")}}}return new je(e)}setEventTarget(t,e){if(this.key=t,this.target=e,this.key!==void 0){let i="",n=!1;for(const o of this.key)n&&PL(o)&&(i+="-"),n=!0,i+=o.toLowerCase();this.key=i}}get listenerCount(){var t;return((t=this.methods)==null?void 0:t.length)??0}get isInvoking(){return this._isInvoking}static from(...t){return new je(t)}invoke(...t){var e;if(this._isInvoking)return console.warn("Circular event invocation detected. Please check your event listeners for circular references.",this),!1;if(((e=this.methods)==null?void 0:e.length)<=0)return!1;this._isInvoking=!0;try{this._methodsCopy.length=0,this._methodsCopy.push(...this.methods);for(const i of this._methodsCopy)i.invoke(...t);if(typeof this.target=="object"&&typeof this.key=="string"){const i=this.target.dispatchEvent;if(typeof i=="function"){const n=new fv(this.key);n.args=t,i.call(this.target,n)}}}finally{this._isInvoking=!1,this._methodsCopy.length=0}return!0}addEventListener(t){return this.methods.push(new Pa(t)),t}removeEventListener(t){if(t)for(let e=this.methods.length-1;e>=0;e--)this.methods[e].target===t&&(this.methods[e].enabled=!1,this.methods.splice(e,1))}removeAllEventListeners(){this.methods.length=0}}class TL extends Ps{constructor(){super([Se,Te],"ColorSerializer")}onDeserialize(t){if(t!=null)return t.a!==void 0?new Te(t.r,t.g,t.b,t.a):t.alpha!==void 0?new Te(t.r,t.g,t.b,t.alpha):new Se(t.r,t.g,t.b)}onSerialize(t){if(t!=null)return t.a!==void 0?{r:t.r,g:t.g,b:t.b,a:t.a}:{r:t.r,g:t.g,b:t.b}}}const U4=new TL;class RL extends Ps{constructor(){super([Ht],"EulerSerializer")}onDeserialize(t,e){if(t!=null){if(t.order)return new Ht(t.x,t.y,t.z,t.order);if(t.x!=null)return new Ht(t.x,t.y,t.z)}}onSerialize(t,e){return{x:t.x,y:t.y,z:t.z,order:t.order}}}const N4=new RL;class OL extends Ps{constructor(){super(z,"ObjectSerializer")}onSerialize(t,e){if(e.objectToNode!==void 0&&t.uuid){const i=e.objectToNode[t.uuid];return ii&&console.log(i,t.name,t.uuid),{node:i}}}onDeserialize(t,e){var i,n,o;if(typeof t=="string"){if(t.endsWith(".glb")||t.endsWith(".gltf")){if(e.serializable instanceof Array&&e.serializable.includes(we))return;X()&&qe("Detected wrong usage of @serializable with Object3D or GameObject. Instead you should use AssetReference here! Please see the console for details.");const r=(n=(i=e.target)==null?void 0:i.constructor)==null?void 0:n.name;console.warn(`Wrong usage of @serializable detected in your script "${r}"

It looks like you used @serializable(Object3D) or @serializable(GameObject) for a prefab or scene reference which is exported to a separate glTF file.

To fix this please change your code to:

@serializable(AssetReference)
${e.path}! : AssetReference;
\0`)}return}if(t){if(t.node!==void 0&&e.nodeToObject){const r=e.nodeToObject[t.node];return ii&&console.log("Deserialized object reference?",t,r,e==null?void 0:e.nodeToObject),r||console.warn("Did not find node: "+t.node,e.nodeToObject,e.object),r}else if(t.guid){if(!e.context){console.error("Missing context");return}let r;const l=(o=e.gltf)==null?void 0:o.scene;return l&&(r=I.findByGuid(t.guid,l)),r||(r=I.findByGuid(t.guid,e.context.scene)),r?(r&&r.isComponent===!0&&(ii&&console.warn("Deserialized object reference is a component"),r=r.gameObject),ii&&console.log("Deserialized object reference?",t,r,e==null?void 0:e.nodeToObject)):((X()||ii)&&console.warn("Could not resolve object reference",e.path,t,e.target,e.context.scene),t.could_not_resolve=!0),r}}}}const kL=new OL;class EL extends Ps{constructor(){super([W,W],"ComponentSerializer")}onSerialize(t,e){if(t!=null&&t.guid)return{guid:t.guid}}onDeserialize(t,e){var i;if(t!=null&&t.guid){if(t.___persistentAsset){ii&&console.log("Skipping component deserialization because it's a persistent asset",t);return}const n=e.path;ii&&console.log(t.guid,e.root,e.object,e.target);let o=this.findObjectForGuid(t.guid,e.root);if(o||e.context&&(o=this.findObjectForGuid(t.guid,(i=e.context)==null?void 0:i.scene),o))return o;(X()||ii)&&console.warn('Could not resolve component reference: "'+n+'" using guid '+t.guid,e.target),t.could_not_resolve=!0;return}}findObjectForGuid(t,e){if(e.guid===t)return e;const i=I.foreachComponent(e,n=>{if(n.guid===t)return n},!1);if(i!==void 0)return i;for(let n=0;n<e.children.length;n++){const o=e.children[n],r=this.findObjectForGuid(t,o);if(r)return r}}}const bb=new EL;class ML extends Ps{constructor(){super([je])}onSerialize(t,e){console.log("TODO: SERIALIZE EVENT")}onDeserialize(t,e){var i,n,o,r;if(typeof t=="function")return new je([new Pa(t,null,[],!0)]);if(t&&t.type==="EventList"){ii&&console.log("DESERIALIZE EVENT",t);const l=new Array;if(t.calls&&Array.isArray(t.calls))for(const d of t.calls){let p=function(b){if(typeof b=="object"){let x=kL.onDeserialize(b,e);if(x||(x=bb.onDeserialize(b,e)),x)return x}return b};ii&&console.log(d);let u=bb.findObjectForGuid(d.target,e.root);!u&&((i=e.context)!=null&&i.scene)&&(u=bb.findObjectForGuid(d.target,(n=e.context)==null?void 0:n.scene));const f=((o=d.method)==null?void 0:o.length)>0;if(u&&f){const b=()=>{const v=d.method[0].toUpperCase()+d.method.slice(1);if(typeof u[v]=="function"){console.warn(`EventList method:
Could not find method ${d.method} on object ${u.name}. Please rename ${d.method} to ${v}?
`,u[v],`
 in script: `,u),qe("EventList methods must start with lowercase letter, see console for details");return}else console.warn(`EventList method:
Could not find method ${d.method} on object ${u.name}`,u,typeof u[d.method])};if(typeof u[d.method]!="function"){let v=!1,S=u;for(;S;){const C=Object.getOwnPropertyDescriptor(S,d.method);if(C&&(C.writable===!0||C.set)){v=!0;break}S=Object.getPrototypeOf(S)}!v&&(X()||ii)&&b()}}if(u){let b=d.argument;if(b!==void 0?b=p(b):d.arguments!==void 0&&(b=d.arguments.map(p)),u[d.method]===void 0)console.warn(`EventList method not found: "${d.method}" on ${u==null?void 0:u.name}`);else{b!==void 0&&!Array.isArray(b)&&(b=[b]);const v=new Pa(u,d.method,b,d.enabled);l.push(v)}}else X()&&console.warn(`[Dev] EventList: Could not find event listener in scene (${(r=e.object)==null?void 0:r.name})`,d)}const c=new je(l);ii&&console.log(c);const h=e.target;return h!==void 0&&e.path!==void 0&&c.setEventTarget(e.path,h),c}}}const z4=new ML,Bm=new WeakMap,AL=_t.prototype.clone;_t.prototype.clone=function(){const s=AL.call(this);return Bm.has(s)||Bm.set(s,this),s};class IL extends Ps{constructor(){super([ic,Qo])}onSerialize(t,e){}onDeserialize(t,e){if(t instanceof _t&&e.type===ic){let i=t;Bm.has(i)&&(i=Bm.get(i)),i.isRenderTargetTexture=!0,i.flipY=!0,i.offset.y=1,i.repeat.y=-1,i.needsUpdate=!0,i.mipmaps=[],i instanceof LO&&(i.isCompressedTexture=!1,i.format=Sg);const n=new ic(i.image.width,i.image.height,{colorSpace:$r});return n.texture=i,n}}}new IL;class LL extends Ps{constructor(){super([URL])}onSerialize(t,e){return null}onDeserialize(t,e){if(typeof t=="string"&&t.length>0)return yc(e.gltfId,t)}}new LL;var DL=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class sd extends W{awake(){Rn.createIfNoneExists(this.context)}onEnable(){var t;(t=Rn.get(this.context))==null||t.register(this)}onDisable(){var t;(t=Rn.get(this.context))==null||t.unregister(this)}}class ws extends sd{constructor(){super(...arguments);a(this,"targets",null);a(this,"raycastHits",[]);a(this,"ignoreSkinnedMeshes",!1)}start(){this.targets=[this.gameObject]}performRaycast(e=null){if(!this.targets)return null;e??(e=new Ya),e.targets=this.targets,e.results=this.raycastHits,e.useAcceleratedRaycast=!0;const i=e.testObject;this.ignoreSkinnedMeshes&&(e.testObject=o=>o instanceof Ia?"continue in children":i?i(o):!0);const n=this.context.physics.raycast(e);return e.testObject=i,n}}DL([g()],ws.prototype,"ignoreSkinnedMeshes",void 0);class pv extends ws{constructor(){super(),this.ignoreSkinnedMeshes=!0}}const sx=class extends sd{performRaycast(t){if(!fe.active||!sx.allow||!(t!=null&&t.ray))return null;const e=t.ray.origin,i=.015;return this.context.physics.sphereOverlap(e,i,!1,!0)}};let sc=sx;a(sc,"allow",!0);class TT{static getObject(t){const e=t[zn];return e&&(e.isComponent===!0?t=e.gameObject:t=e),t}static isInteractable(t,e){if(e&&(e.canvasGroup=void 0,e.graphic=void 0),t==null||!t.visible||(t=this.getObject(t),!t.visible))return!1;const i=this.tryFindCanvasGroup(t);if((i==null?void 0:i.isCanvasGroup)===!0&&(e&&(e.canvasGroup=i),i.blocksRaycasts===!1||i.interactable===!1))return!1;const n=id(t,o=>{if(o.isGraphic===!0)return o},!1);return e&&(n==null?void 0:n.isGraphic)===!0&&(e.graphic=n),!((n==null?void 0:n.raycastTarget)===!1||(n==null?void 0:n.layer)===2)}static tryFindCanvasGroup(t){if(!t)return null;const e=id(t,i=>{if(i.activeAndEnabled){const n=i;if(n.blocksRaycasts!==void 0&&n.interactable!==void 0)return n}},!1);return e!==void 0?e:this.tryFindCanvasGroup(t.parent)}}function mv(s){const t=s[zn];return t||(s.parent?mv(s.parent):null)}function jL(s){return s.isUI===!0||typeof s[zn]=="object"}function Um(s,t){if(!s)return;const e=s.material;if((e==null?void 0:e.isMaterial)===!0){const i=s.parent;i&&i.isText,e.side=t.doubleSided??!0?Qn:Wa,e.shadowSide=t.doubleSided?Qn:Wa,s.castShadow=t.castShadows?t.castShadows:!1,s.receiveShadow=t.receiveShadows?t.receiveShadows:!1}for(const i of s.children)Um(i,t)}function sh(s,t,e){s[t]===void 0&&console.warn("Field",t,"is undefined on",s);const i=Proxy.revocable(s[t],{set(r,l,c,h){const d=r[l],u=Reflect.set(r,l,c,h);return e(c,d),u}}),n=i.revoke,o=s[t];return i.revoke=()=>{s[t]=o,n()},s[t]=i.proxy,i}const AS=Symbol("Scheduled action");function FL(s,t,e=ge.OnBeforeRender){let i=s[AS];i||(i=s[AS]={});const n=t.name;i[e]||(i[e]={});const o=i[e];if(o[n])return;function*l(){t==null||t.call(s),o[n]=null}const c=s.startCoroutine(l(),e);o[n]=c}const ba=k("debugeventsystem");var od;(function(s){s.BeforeHandleInput="BeforeHandleInput",s.AfterHandleInput="AfterHandleInput"})(od||(od={}));cv(s=>{Rn.createIfNoneExists(s)});class Rn extends W{constructor(){super(...arguments);a(this,"raycaster",[]);a(this,"pressedByID",new Map);a(this,"hoveredByID",new Map);a(this,"onPointerEvent",e=>{if(e===void 0||e.propagationStopped||e.defaultPrevented||e.used)return;const i=new Hg(this.context.input,e);this._currentPointerEventName=e.type,i.inputSource=this.context.input,i.isClick=e.isClick,i.isDoubleClick=e.isDoubleClick,i.isDown=e.type==Le.PointerDown,i.isUp=e.type==Le.PointerUp,i.isPressed=this.context.input.getPointerPressed(e.pointerId);const n=new Ya;e.hasRay?n.ray=e.ray:n.screenPoint=this.context.input.getPointerPositionRC(e.pointerId),n.allowSlowRaycastFallback=e.isClick||e.isDoubleClick;const o=this.performRaycast(n);if(ba&&(i.isDown?console.log("DOWN",{id:i.pointerId,hits:o.length}):i.isUp&&console.log("UP",{id:i.pointerId,hits:o.length}),i.isClick&&console.log("CLICK",{id:i.pointerId,hits:o.length})),o){for(const l of o)l.event=e,e.intersections.push(l);e.origin.onPointerHits&&e.origin.onPointerHits({sender:this,event:e,hits:o})}ba&&i.isClick&&at("EventSystem: "+i.pointerId+" - "+this.context.time.frame+" - Up:"+i.isUp+", Down:"+i.isDown);const r={sender:this,args:i,hasActiveUI:this.currentActiveMeshUIComponents.length>0};this.dispatchEvent(new CustomEvent(od.BeforeHandleInput,{detail:r})),this.handleIntersections(o,i),this.dispatchEvent(new CustomEvent(od.AfterHandleInput,{detail:r}))});a(this,"_sortedHits",[]);a(this,"_testObjectsCache",new Map);a(this,"_currentlyActiveRaycaster",null);a(this,"_currentPointerEventName",null);a(this,"shouldRaycastObject",e=>{var r;const i=e&&"getComponent"in e?e.getComponent(sd):null;if(i&&i!=this._currentlyActiveRaycaster)return!1;let n=null;if(jL(e)&&(n=(r=e[zn])==null?void 0:r.gameObject),this._testObjectsCache.has(e)||n&&this._testObjectsCache.has(n))return this._testObjectsCache.get(e)===!1?"continue in children":!0;{let l=J_(e,this._currentPointerEventName);if(!l&&n&&(l=J_(n,this._currentPointerEventName)),l){this._testObjectsCache.set(e,!0);for(const c of e.children)this.shouldRaycastObject_AddToYesCache(c);return!0}return this._testObjectsCache.set(e,!1),"continue in children"}});a(this,"_sortingBuffer",[]);a(this,"_noDepthTestingResults",[]);a(this,"out",{});a(this,"_capturedPointer",{});a(this,"pointerEnterSymbol",Symbol("pointerEnter"));a(this,"pointerExitSymbol",Symbol("pointerExit"));a(this,"currentActiveMeshUIComponents",[])}static ensureUpdateMeshUI(e,i,n=!1){Ta.update(e,i,n)}static markUIDirty(e){Ta.markDirty()}static createIfNoneExists(e){e.scene.getComponent(Rn)||e.scene.addComponent(Rn)}static get(e){return this.createIfNoneExists(e),e.scene.getComponent(Rn)}static get instance(){return this.get(de.Current)}register(e){var i;e&&this.raycaster&&!this.raycaster.includes(e)&&((i=this.raycaster)==null||i.push(e))}unregister(e){var n,o;const i=(n=this.raycaster)==null?void 0:n.indexOf(e);i!==void 0&&i!==-1&&((o=this.raycaster)==null||o.splice(i,1))}get hasActiveUI(){return this.currentActiveMeshUIComponents.length>0}get isHoveringObjects(){return this.hoveredByID.size>0}awake(){this.gameObject!==this.context.scene&&(console.debug(`[Needle Engine] EventSystem is only allowed on the scene root. Disabling EventSystem on '${this.gameObject.name}'`),this.enabled=!1)}start(){this.context.scene.getComponent(sd)||this.context.scene.addComponent(ws)}onEnable(){this.context.input.addEventListener(Le.PointerDown,this.onPointerEvent),this.context.input.addEventListener(Le.PointerUp,this.onPointerEvent),this.context.input.addEventListener(Le.PointerMove,this.onPointerEvent)}onDisable(){this.context.input.removeEventListener(Le.PointerDown,this.onPointerEvent),this.context.input.removeEventListener(Le.PointerUp,this.onPointerEvent),this.context.input.removeEventListener(Le.PointerMove,this.onPointerEvent)}onBeforeRender(){this.resetMeshUIStates()}shouldRaycastObject_AddToYesCache(e){this._testObjectsCache.set(e,!0);for(const i of e.children)this.shouldRaycastObject_AddToYesCache(i)}performRaycast(e){if(!this.raycaster)return null;this._testObjectsCache.clear(),this._sortedHits.length=0,e.testObject=this.shouldRaycastObject;for(const i of this.raycaster){if(!i.activeAndEnabled)continue;this._currentlyActiveRaycaster=i;const n=i.performRaycast(e);this._currentlyActiveRaycaster=null,n&&n.length>0&&this._sortedHits.push(...n)}return this._sortedHits.sort((i,n)=>i.distance-n.distance),this._sortedHits}assignHitInformation(e,i){i?(e.intersection=i,e.point=i.point,e.normal=i.normal,e.face=i.face,e.distance=i.distance,e.instanceId=i.instanceId):(e.intersection=void 0,e.point=void 0,e.normal=void 0,e.face=void 0,e.distance=void 0,e.instanceId=void 0)}handleIntersections(e,i){var o;if(e!=null&&e.length){e=this.sortCandidates(e);for(const r of e){if(i.event.immediatePropagationStopped)return!1;if(this.assignHitInformation(i,r),this.handleEventOnObject(r.object,i))return!0}}this.assignHitInformation(i,e==null?void 0:e[0]),this.invokePointerCapture(i);const n=this.hoveredByID.get(i.pointerId);return n&&this.propagatePointerExit(n.obj,n.data,null),this.hoveredByID.delete(i.pointerId),i.isUp&&((o=this.pressedByID.get(i.pointerId))==null||o.handlers.forEach(r=>this.invokeOnPointerUp(i,r)),this.pressedByID.delete(i.pointerId)),!1}sortCandidates(e){this._sortingBuffer.length=0,this._noDepthTestingResults.length=0;for(let i=0;i<e.length;i++){const n=e[i],o=n.object;if(o.material&&o.material.depthTest===!1){this._noDepthTestingResults.push(n);continue}this._sortingBuffer.push(n)}for(const i of this._sortingBuffer)this._noDepthTestingResults.push(i);return this._noDepthTestingResults}handleEventOnObject(e,i){if(!this.testIsVisible(e))return i.isClick&&ba&&console.log("not allowed",e),!1;if(i.pointerId===void 0)return ba&&console.error("Event without pointer can't be handled",i),!1;i.object=e;const n=e.parent,o=i.isClick??!1;let r=null;if(n&&n.isUI){const u=(i.isPressed||i.isClick)??!1;if(n[zn]){const f=n[zn].gameObject;if(f){if(!TT.isInteractable(f,this.out))return!1;r=this.out.canvasGroup??null,this.handleMeshUIIntersection(e,u),e=f}}}o&&ba&&console.log(this.context.time.frame,e);const l=this.hoveredByID.get(i.pointerId),c=l==null?void 0:l.obj;c!==e&&c&&this.propagatePointerExit(c,l.data,e);const d=this.hoveredByID.get(i.pointerId);if(d?(d.obj=e,d.data=i):this.hoveredByID.set(i.pointerId,{obj:e,data:i}),i.isDown){const u=this.pressedByID.get(i.pointerId);u?(u.obj=e,u.data=i):this.pressedByID.set(i.pointerId,{obj:e,data:i,handlers:new Set})}return(r===null||r.interactable)&&this.handleMainInteraction(e,i,c??null),!0}propagate(e,i){for(;e;)I.foreachComponent(e,n=>{i(n)},!1),e=e.parent}handleMainInteraction(e,i,n){const o=this.pressedByID.get(i.pointerId),r=n!==e;let l=!0;switch(i.event.pointerType){case"mouse":case"touch":const c=this.context.input.getPointerPositionLastFrame(i.pointerId),h=this.context.input.getPointerPosition(i.pointerId);l=c&&!ee.approximately(c,h);break}this.propagate(e,c=>{var d;const h=c;h.interactable!==!1&&(!h.activeAndEnabled||!h.enabled||(h.onPointerEnter&&r&&this.handlePointerEnter(h,i),i.isDown&&h.onPointerDown&&(h.onPointerDown(i),o==null||o.handlers.add(h),this.handlePointerCapture(i,h)),h.onPointerMove&&(l&&h.onPointerMove(i),this.handlePointerCapture(i,h)),i.isUp&&(h.onPointerUp&&(this.invokeOnPointerUp(i,h),o==null||o.handlers.delete(h)),h.onPointerExit&&((d=i.event)==null?void 0:d.pointerType)===Ea.Touch&&(this.handlePointerExit(h,i),this.hoveredByID.delete(i.pointerId))),i.isClick&&h.onPointerClick&&h.onPointerClick(i)))}),i.isUp&&(o==null||o.handlers.forEach(c=>{this.invokeOnPointerUp(i,c)}),this.pressedByID.delete(i.pointerId))}propagatePointerExit(e,i,n){this.propagate(e,o=>{if(!o.gameObject||o.destroyed)return;const r=o;if(r.onPointerExit||r.onPointerEnter){if(n&&this.isChild(n,o.gameObject))return;this.handlePointerExit(r,i)}})}invokeOnPointerUp(e,i){var n;(n=i.onPointerUp)==null||n.call(i,e),this.releasePointerCapture(e,i)}handlePointerEnter(e,i){e.onPointerEnter&&this.updatePointerState(e,i.pointerId,this.pointerEnterSymbol,!0)&&e.onPointerEnter(i),this.updatePointerState(e,i.pointerId,this.pointerExitSymbol,!1)}handlePointerExit(e,i){e.onPointerExit&&this.updatePointerState(e,i.pointerId,this.pointerExitSymbol,!0)&&e.onPointerExit(i),this.updatePointerState(e,i.pointerId,this.pointerEnterSymbol,!1)}updatePointerState(e,i,n,o){let r=e[n];if(o)return r&&r.includes(i)?!1:(r=r||[],r.push(i),e[n]=r,!0);{if(!r||!r.includes(i))return!1;const l=r.indexOf(i);return l!==-1&&r.splice(l,1),!0}}handlePointerCapture(e,i){if(e.z__pointer_ctured){e.z__pointer_ctured=!1;const n=e.pointerId;if(i.onPointerMove){const o=this._capturedPointer[n]||[];o.push(i),this._capturedPointer[n]=o}else X()&&!i.z__warned_no_pointermove&&(i.z__warned_no_pointermove=!0,console.warn("PointerCapture was requested but the component doesn't implement onPointerMove. It will not receive any pointer events"))}else e.z__pointer_cture_rleased&&(e.z__pointer_cture_rleased=!1,this.releasePointerCapture(e,i))}releasePointerCapture(e,i){const n=e.pointerId;if(this._capturedPointer[n]){const o=this._capturedPointer[n].indexOf(i);o!==-1&&(this._capturedPointer[n].splice(o,1),ba&&console.log("released pointer capture",n,i,this._capturedPointer))}}invokePointerCapture(e){var i;if(e.event.type===Le.PointerMove){const n=e.pointerId,o=this._capturedPointer[n];if(o){ba&&console.log("Captured",n,o);for(let r=0;r<o.length;r++){const l=o[r];if(l.destroyed){o.splice(r,1),r--;continue}(i=l.onPointerMove)==null||i.call(l,e)}}}}isChild(e,i){return!e||!i?!1:e===i?!0:e.parent?this.isChild(e.parent,i):!1}handleMeshUiObjectWithoutShadowDom(e,i){return!e||!e.isUI?!0:this.handleMeshUIIntersection(e,i)}handleMeshUIIntersection(e,i){const n=Ta.updateState(e,i);return n&&this.currentActiveMeshUIComponents.push(n),n!==null}resetMeshUIStates(){if(this.context.input.getPointerPressedCount()>0&&Ta.resetLastSelected(),!(!this.currentActiveMeshUIComponents||this.currentActiveMeshUIComponents.length<=0)){for(let e=0;e<this.currentActiveMeshUIComponents.length;e++){const i=this.currentActiveMeshUIComponents[e];Ta.resetState(i)}this.currentActiveMeshUIComponents.length=0}}testIsVisible(e){return e?I.isActiveSelf(e)?this.testIsVisible(e.parent):!1:!0}}class Ta{static markDirty(){this.needsUpdate=!0}static update(t,e,i=!1){if(i){t.update();return}const n=e.time.frameCount;for(const o of this.lastUpdateFrame)if(o.context===e){if(n===o.frame)return;o.frame=n;let r=this.needsUpdate||n<1;o.nextUpdate<=n&&(r=!0),r&&(ba&&console.log("Update threemeshui"),this.needsUpdate=!1,o.nextUpdate=n+60,t.update());return}this.lastUpdateFrame=[{context:e,frame:n,nextUpdate:n+60}],t.update(),this.needsUpdate=!1}static updateState(t,e){let i=null;if(t&&(i=this.findBlockOrTextInParent(t),i&&i!==this.lastSelected)){if(i.interactable===!1)return null;this.needsUpdate=!0}return i}static resetLastSelected(){const t=this.lastSelected;t&&(this.lastSelected=null,this.resetState(t))}static resetState(t){t&&(this.needsUpdate=!0)}static findBlockOrTextInParent(t){return t?t.isBlock||t.isText?t:this.findBlockOrTextInParent(t.parent):null}}a(Ta,"lastSelected",null),a(Ta,"lastUpdateFrame",[]),a(Ta,"needsUpdate",!1);var ct=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Ni=k("debugorbit"),_b=k("freecam"),BL=k("debugcamerafit"),kp=k("smoothcam"),UL={LEFT:"",UP:"",RIGHT:"",BOTTOM:""};let vb;var e0;(function(s){s.CameraTargetReached="target-reached"})(e0||(e0={}));class Nm extends CustomEvent{constructor(t,e){super(e0.CameraTargetReached,{detail:{controls:t,type:e}})}}class He extends W{constructor(){super(...arguments);a(this,"autoTarget",!0);a(this,"autoFit",!1);a(this,"enableRotate",!0);a(this,"autoRotate",!1);a(this,"autoRotateSpeed",1);a(this,"minAzimuthAngle",1/0);a(this,"maxAzimuthAngle",1/0);a(this,"minPolarAngle",0);a(this,"maxPolarAngle",Math.PI);a(this,"enableKeys",!1);a(this,"enableDamping",!0);a(this,"dampingFactor",.1);a(this,"enableZoom",!0);a(this,"minZoom",0);a(this,"maxZoom",1/0);a(this,"zoomSpeed",1);a(this,"zoomToCursor",!1);a(this,"enablePan",!0);a(this,"lookAtConstraint",null);a(this,"lookAtConstraint01",1);a(this,"allowInterrupt",!0);a(this,"middleClickToFocus",!0);a(this,"doubleClickToFocus",!0);a(this,"clickBackgroundToFitScene",2);a(this,"_targetElement",null);a(this,"debugLog",!1);a(this,"_lookTargetLerpDuration",1);a(this,"targetBounds",null);a(this,"_controls",null);a(this,"_cameraObject",null);a(this,"_lookTargetLerpActive",!1);a(this,"_lookTargetStartPosition",new R);a(this,"_lookTargetEndPosition",new R);a(this,"_lookTargetLerp01",0);a(this,"_cameraLerpActive",!1);a(this,"_cameraStartPosition",new R);a(this,"_cameraEndPosition",new R);a(this,"_cameraLerp01",0);a(this,"_cameraLerpDuration",0);a(this,"_fovLerpActive",!1);a(this,"_fovLerpStartValue",0);a(this,"_fovLerpEndValue",0);a(this,"_fovLerp01",0);a(this,"_fovLerpDuration",0);a(this,"_inputs",0);a(this,"_enableTime",0);a(this,"_startedListeningToKeyEvents",!1);a(this,"_eventSystem");a(this,"_afterHandleInputFn");a(this,"_camera",null);a(this,"_syncedTransform");a(this,"_didSetTarget",0);a(this,"_activePointerEvents");a(this,"_lastTimeClickOnBackground",-1);a(this,"_clickOnBackgroundCount",0);a(this,"_onPointerDown",e=>{this._activePointerEvents.push(e)});a(this,"_onPointerDownLate",e=>{e.used&&this._controls&&(this._controls.enabled=!1)});a(this,"_onPointerUp",e=>{for(let i=this._activePointerEvents.length-1;i>=0;i--){const n=this._activePointerEvents[i];if(n.pointerId===e.pointerId&&n.button===e.button){this._activePointerEvents.splice(i,1);break}}if(this.clickBackgroundToFitScene>0&&e.isClick&&e.button===0){if(e.hasRay||e.intersections.push(...this.context.physics.raycast()),e.intersections.length<=0){const i=this.context.time.time-this._lastTimeClickOnBackground;this._lastTimeClickOnBackground=this.context.time.time,this.clickBackgroundToFitScene<=1||i<this.clickBackgroundToFitScene*.15?(this._clickOnBackgroundCount+=1,this._clickOnBackgroundCount>=this.clickBackgroundToFitScene-1&&(this.autoRotate=!1,this.fitCamera({objects:this.context.scene,immediate:!1}))):this._clickOnBackgroundCount=0}Ni&&console.log(this.clickBackgroundToFitScene,e.intersections.length,this._clickOnBackgroundCount)}});a(this,"_onPointerUpLate",e=>{this.doubleClickToFocus&&e.isDoubleClick&&!e.used&&this.setTargetFromRaycast()});a(this,"_orbitStartAngle",0);a(this,"_zoomStartDistance",0);a(this,"onControlsChangeStarted",()=>{Ni&&console.debug("OrbitControls: Change started"),this._controls&&(this._orbitStartAngle=this._controls.getAzimuthalAngle()+this._controls.getPolarAngle(),this._zoomStartDistance=this._controls.getDistance()),this._syncedTransform&&this._syncedTransform.requestOwnership()});a(this,"onControlsChangeEnded",()=>{if(Ni&&console.debug("OrbitControls: Change ended",{autoTarget:this.autoTarget}),this._controls&&this.autoTarget){const i=this._controls.getAzimuthalAngle()+this._controls.getPolarAngle()-this._orbitStartAngle;Math.abs(i)<.01?(Ni&&console.debug("OrbitControls: Update target",{deltaAngle:i}),this.updateTargetNow({allowSlowRaycastFallback:!1})):Ni&&console.debug("OrbitControls: No target update",{deltaAngle:i})}});a(this,"_shouldDisable",!1);a(this,"__onPreRender",()=>{const e=this.context.pre_render_callbacks.indexOf(this.__onPreRender);e>=0&&this.context.pre_render_callbacks.splice(e,1),this.autoFit&&(this.autoFit=!1,this.fitCamera({centerCamera:"y",immediate:!0,objects:this.scene.children}))});a(this,"_haveAttachedKeyboardEvents",!1)}get isCameraController(){return!0}get controls(){return this._controls}get controllerObject(){return this._cameraObject}onStartInteraction(e){var i;(i=this.controls)==null||i.addEventListener("start",e)}get targetElement(){var e;return((e=this._controls)==null?void 0:e.domElement)??this._targetElement}set targetElement(e){this._targetElement=e,this._controls&&this._controls.domElement!==e&&(this._controls.disconnect(),this._controls.domElement=e,this._controls.connect())}get targetLerpSpeed(){return 5}set targetLerpSpeed(e){this.targetLerpDuration=1/e}get targetLerpDuration(){return this._lookTargetLerpDuration}set targetLerpDuration(e){this._lookTargetLerpDuration=e}rotateLeft(e){var i;(i=this._controls)==null||i._rotateLeft(e)}rotateUp(e){var i;(i=this._controls)==null||i._rotateUp(e)}pan(e,i){var n;(n=this._controls)==null||n._pan(e,i)}zoomIn(e){var i,n;e>0?(i=this._controls)==null||i._dollyIn(1-e):e<0&&((n=this._controls)==null||n._dollyOut(1+e))}awake(){Ni&&console.debug("OrbitControls",this),this._didSetTarget=0,this._startedListeningToKeyEvents=!1,this.context.domElement.cameraControls===!1&&(this.enabled=!1)}start(){this._eventSystem=Rn.get(this.context)??void 0,this._eventSystem&&(this._afterHandleInputFn=this.afterHandleInput.bind(this),this._eventSystem.addEventListener(od.AfterHandleInput,this._afterHandleInputFn))}onDestroy(){var e,i;(e=this._controls)==null||e.dispose(),(i=this._eventSystem)==null||i.removeEventListener(od.AfterHandleInput,this._afterHandleInputFn)}onEnable(){this._didSetTarget=0,this._enableTime=this.context.time.time;const e=I.getComponent(this.gameObject,ze);this._camera=e;let i=e==null?void 0:e.threeCamera;if(!i&&this.gameObject instanceof Ae&&(i=this.gameObject),i&&Kx(i,this,!0),!this._controls&&i instanceof z){this._cameraObject=i;const n=this.targetElement??this.context.renderer.domElement,o=i==null?void 0:i.quaternion.clone();this._controls=new a1(i,n),i==null||i.quaternion.copy(o),vb===void 0&&(vb={...this._controls.keys});const r=ve(i),l=this.gameObject.worldForward,c=2.5,h=r.clone().sub(l.multiplyScalar(c));this._controls.target.copy(h)}if(this._controls)if(_b&&(this.enablePan=!0,this.enableZoom=!0,this.middleClickToFocus=!0,Q.isMobileDevice()&&(this.doubleClickToFocus=!0)),this._controls.addEventListener("start",this.onControlsChangeStarted),this._controls.addEventListener("endMovement",this.onControlsChangeEnded),!this._startedListeningToKeyEvents&&this.enableKeys)this._startedListeningToKeyEvents=!0,this._controls.listenToKeyEvents(this.context.domElement);else try{this._controls.stopListenToKeyEvents()}catch{}this._syncedTransform=I.getComponent(this.gameObject,Zo)??void 0,this.context.pre_render_callbacks.push(this.__onPreRender),this._activePointerEvents=[],this.context.input.addEventListener("pointerdown",this._onPointerDown,{queue:Pn.Early}),this.context.input.addEventListener("pointerdown",this._onPointerDownLate,{queue:Pn.Late}),this.context.input.addEventListener("pointerup",this._onPointerUp,{queue:Pn.Early}),this.context.input.addEventListener("pointerup",this._onPointerUpLate,{queue:Pn.Late})}onDisable(){var e;if((e=this._camera)!=null&&e.threeCamera&&Kx(this._camera.threeCamera,this,!1),this._controls){this._controls.enabled=!1,this._controls.autoRotate=!1,this._controls.removeEventListener("start",this.onControlsChangeStarted),this._controls.removeEventListener("endMovement",this.onControlsChangeEnded);try{this._controls.stopListenToKeyEvents()}catch{}this._startedListeningToKeyEvents=!1}this._activePointerEvents.length=0,this.context.input.removeEventListener("pointerdown",this._onPointerDown),this.context.input.removeEventListener("pointerdown",this._onPointerDownLate),this.context.input.removeEventListener("pointerup",this._onPointerUp),this.context.input.removeEventListener("pointerup",this._onPointerUpLate)}updateTargetNow(e){var r,l,c;const i=new zr((r=this._cameraObject)==null?void 0:r.worldPosition,(l=this._cameraObject)==null?void 0:l.worldForward.multiplyScalar(-1)),n=this.context.physics.raycastFromRay(i,e),o=n.length>0?n[0]:void 0;o&&o.distance>this.minZoom&&o.distance<this.maxZoom?(Ni&&se.DrawWireSphere(o.point,.1,16711680,2),(c=this._controls)==null||c.target.copy(n[0].point)):Ni&&console.log("OrbitControls: No hit found when updating target",{hits:[...n]})}afterHandleInput(e){e.detail.args.pointerId===0&&(e.detail.args.isDown?this._controls&&this._eventSystem&&(this._shouldDisable=this._eventSystem.hasActiveUI):(!e.detail.args.isPressed||e.detail.args.isUp)&&(this._shouldDisable=!1))}onPausedChanged(e){this._controls&&e&&(this._controls.enabled=!1)}onBeforeRender(){var i,n,o,r,l;if(!this._controls)return;if(this._cameraObject!==this.context.mainCamera){this._controls.enabled=!1;return}if(this._controls.enabled=!0,(this.context.input.getPointerDown(1)||this.context.input.getPointerDown(2)||this.context.input.mouseWheelChanged||this.context.input.getPointerPressed(0)&&((i=this.context.input.getPointerPositionDelta(0))!=null&&i.length())||0>.1)&&(this._inputs+=1),this._inputs>0&&this.allowInterrupt&&(this.enableRotate&&(this.autoRotate=!1),this._cameraLerpActive=!1,this._lookTargetLerpActive=!1),this._inputs=0,this.autoTarget&&this._didSetTarget++===0){const c=I.getComponent(this.gameObject,ze);if(c&&!this.setLookTargetFromConstraint()){this.debugLog&&console.log("NO TARGET");const h=ve(c.threeCamera),d=Math.max(.01,h.length()),u=new R(0,0,-d).applyMatrix4(c.threeCamera.matrixWorld);Ni&&se.DrawLine(h,u,5592575,10),this.setLookTargetPosition(u,!0)}if(!this.setLookTargetFromConstraint()){const h=new Ya;h.screenPoint=new _e(0,0),h.lineThreshold=.1;const d=this.context.physics.raycast(h);d.length>0&&this.setLookTargetPosition(d[0].point,!0),BL&&console.log("OrbitControls hits",...d)}}if(this.middleClickToFocus&&this.context.input.getPointerClicked(1)&&this.setTargetFromRaycast(),this._lookTargetLerpActive||this._cameraLerpActive||this._fovLerpActive){if(this._cameraLerpActive&&this._cameraObject)if(this._cameraLerp01+=this.context.time.deltaTime/this._cameraLerpDuration,this._cameraLerp01>=1)this._cameraObject.position.copy(this._cameraEndPosition),this._cameraLerpActive=!1,this.dispatchEvent(new Nm(this,"camera"));else{const c=ee.easeInOutCubic(this._cameraLerp01);this._cameraObject.position.lerpVectors(this._cameraStartPosition,this._cameraEndPosition,c)}if(this._lookTargetLerpActive)if(this._lookTargetLerp01+=this.context.time.deltaTime/this._lookTargetLerpDuration,this._lookTargetLerp01>=1)this.lerpLookTarget(this._lookTargetEndPosition,this._lookTargetEndPosition,1),this._lookTargetLerpActive=!1,this.dispatchEvent(new Nm(this,"lookat"));else{const c=ee.easeInOutCubic(this._lookTargetLerp01);this.lerpLookTarget(this._lookTargetStartPosition,this._lookTargetEndPosition,c)}if(this._fovLerpActive&&this._cameraObject){const c=this._cameraObject;if(this._fovLerp01+=this.context.time.deltaTime/this._fovLerpDuration,this._fovLerp01>=1)c.fov=this._fovLerpEndValue,this._fovLerpActive=!1;else{const h=ee.easeInOutCubic(this._fovLerp01);c.fov=ee.lerp(this._fovLerpStartValue,this._fovLerpEndValue,h)}c.updateProjectionMatrix()}}if(this.targetBounds){const c=this._controls.target,h=this.targetBounds.worldPosition,d=te(this.targetBounds.worldScale).multiplyScalar(.5),u=te(h).sub(d),f=te(h).add(d),p=te(this._controls.target).clamp(u,f),b=.1;c.lerp(p,this.context.time.deltaTime/b),this._lookTargetLerpActive&&this._lookTargetEndPosition.lerp(p,this.context.time.deltaTime/(b*5)),Ni&&se.DrawWireBox(h,d.multiplyScalar(2),16755200)}if(this._controls){this.debugLog&&(this._controls.domElement=this.context.renderer.domElement);const c=1/(((n=this.context.focusRectSettings)==null?void 0:n.zoom)||1);if(this._controls.enabled=!this._shouldDisable&&this._camera===this.context.mainCameraComponent&&!this.context.isInXR&&!this._activePointerEvents.some(h=>h.used),this._controls.keys=this.enableKeys?vb:UL,this._controls.autoRotate=this.autoRotate,this._controls.autoRotateSpeed=this.autoRotateSpeed,this._controls.enableZoom=this.enableZoom,this._controls.zoomSpeed=this.zoomSpeed,this._controls.zoomToCursor=this.zoomToCursor,this._controls.enableDamping=this.enableDamping,this._controls.dampingFactor=this.dampingFactor,this._controls.enablePan=this.enablePan,this._controls.panSpeed=c,this._controls.enableRotate=this.enableRotate,this._controls.minAzimuthAngle=this.minAzimuthAngle,this._controls.maxAzimuthAngle=this.maxAzimuthAngle,this._controls.minPolarAngle=this.minPolarAngle,this._controls.maxPolarAngle=this.maxPolarAngle,_b||(((r=(o=this._camera)==null?void 0:o.threeCamera)==null?void 0:r.type)==="PerspectiveCamera"?(this._controls.minDistance=this.minZoom,this._controls.maxDistance=this.maxZoom,this._controls.minZoom=0,this._controls.maxZoom=1/0):(this._controls.minDistance=0,this._controls.maxDistance=1/0,this._controls.minZoom=this.minZoom,this._controls.maxZoom=this.maxZoom)),typeof kp=="number"||kp===!0){this._controls.enableDamping=!0;const h=typeof kp=="number"?kp:.99;this._controls.dampingFactor=Math.max(.001,1-Math.min(1,h))}this.allowInterrupt||(this._lookTargetLerpActive&&(this._controls.enablePan=!1),this._cameraLerpActive&&(this._controls.enableRotate=!1,this._controls.autoRotate=!1),(this._lookTargetLerpActive||this._cameraLerpActive)&&(this._controls.enableZoom=!1)),this.context.isInXR||(!_b&&((l=this.lookAtConstraint)!=null&&l.locked)&&!this._lookTargetLerpActive&&this.setLookTargetFromConstraint(0,this.lookAtConstraint01),this._controls.update(this.context.time.deltaTime),Ni&&se.DrawWireSphere(this._controls.target,.1,65280))}}setCameraAndLookTarget(e,i=!1){if(!e)return(X()||Ni)&&console.warn("[OrbitControls] setCameraAndLookTarget target is null"),!1;if(!(e instanceof z)&&!(e instanceof ze))return(X()||Ni)&&console.warn("[OrbitControls] setCameraAndLookTarget target is not an Object3D or Camera"),!1;e instanceof ze&&(e=e.gameObject);const n=e.worldPosition,o=e.worldForward;e instanceof DO&&(Ni&&console.debug("[OrbitControls] setCameraAndLookTarget flip forward direction for camera"),o.multiplyScalar(-1));const r=new zr(n,o);return Ni&&se.DrawRay(r.origin,r.direction,16711680,10),this.setTargetFromRaycast(r,i)||this.setLookTargetPosition(r.at(2,te()),i),this.setCameraTargetPosition(n,i),!0}setCameraTargetPosition(e,i=!1){var n;e&&(e instanceof z&&(e=ve(e)),this._cameraEndPosition||(this._cameraEndPosition=new R),this._cameraEndPosition.copy(e),i===!0?(this._cameraLerpActive=!1,this._cameraObject&&this._cameraObject.position.copy(this._cameraEndPosition)):this._cameraObject&&(this._cameraLerpActive=!0,this._cameraLerp01=0,this._cameraStartPosition.copy((n=this._cameraObject)==null?void 0:n.position),typeof i=="number"?this._cameraLerpDuration=i:this._cameraLerpDuration=this.targetLerpDuration))}get cameraLerpActive(){return this._cameraLerpActive}stopCameraLerp(){this._cameraLerpActive=!1}setFieldOfView(e,i=!1){var o;if(!this._controls||typeof e!="number")return;const n=(o=this._camera)==null?void 0:o.threeCamera;n&&(i===!0?n.fov=e:(this._fovLerpActive=!0,this._fovLerp01=0,this._fovLerpStartValue=n.fov,this._fovLerpEndValue=e,typeof i=="number"?this._fovLerpDuration=i:this._fovLerpDuration=this.targetLerpDuration))}setLookTargetPosition(e=null,i=!1){this._controls&&e&&(e instanceof z&&(e=ve(e)),this._lookTargetEndPosition.copy(e),this._didSetTarget++,Ni&&(console.warn("OrbitControls: setLookTargetPosition",e,i),se.DrawWireSphere(this._lookTargetEndPosition,.2,16711680,2)),i===!0?this.lerpLookTarget(this._lookTargetEndPosition,this._lookTargetEndPosition,1):(this._lookTargetLerpActive=!0,this._lookTargetLerp01=0,this._lookTargetStartPosition.copy(this._controls.target),typeof i=="number"?this._lookTargetLerpDuration=i:this._lookTargetLerpDuration=this.targetLerpDuration))}get lookTargetLerpActive(){return this._lookTargetLerpActive}stopLookTargetLerp(){this._lookTargetLerpActive=!1}setLookTargetFromConstraint(e=0,i=1){var o,r;if(!this._controls||((o=this.lookAtConstraint)==null?void 0:o.enabled)===!1)return!1;const n=(r=this.lookAtConstraint)==null?void 0:r.sources;if(n&&n.length>0){const l=n[e];if(l)return l.getWorldPosition(this._lookTargetEndPosition),this.lerpLookTarget(this._controls.target,this._lookTargetEndPosition,i),!0}return!1}lerpLookTarget(e,i,n){this._controls&&(n>=1?this._controls.target.copy(i):this._controls.target.lerpVectors(e,i,n),this.lookAtConstraint&&this.lookAtConstraint.setConstraintPosition(this._controls.target))}setTargetFromRaycast(e,i=!1){if(!this.controls)return!1;const n=e?this.context.physics.raycastFromRay(e):this.context.physics.raycast();for(const o of n)if(o.distance>0&&I.isActiveInHierarchy(o.object)){const r=mv(o.object);if(r){const l=r.canvas;if(l!=null&&l.screenspace)break}return this.setLookTargetPosition(o.point,i),!0}return!1}fitCamera(e,i){var r;let n;if(Array.isArray(e)||e&&"type"in e?n=e:e&&typeof e=="object"&&!(e instanceof z)&&!Array.isArray(e)&&(i=e,n=i.objects),n&&!Array.isArray(n)&&(n=[n]),(!Array.isArray(n)||n&&n.length<=0)&&(n=this.context.scene.children),!Array.isArray(n)||n.length<=0){console.warn("No objects to fit camera to...");return}const o=wL({objects:[...n],...i,autoApply:!1,context:this.context,camera:this._cameraObject,currentZoom:((r=this._controls)==null?void 0:r.getDistance())||void 0,minZoom:this.minZoom,maxZoom:this.maxZoom});o&&(this.setLookTargetPosition(o.lookAt,(i==null?void 0:i.immediate)||!1),this.setCameraTargetPosition(o.position,(i==null?void 0:i.immediate)||!1),this.setFieldOfView(i==null?void 0:i.fov,(i==null?void 0:i.immediate)||!1),this.onBeforeRender())}}ct([g()],He.prototype,"autoTarget",void 0);ct([g()],He.prototype,"autoFit",void 0);ct([g()],He.prototype,"enableRotate",void 0);ct([g()],He.prototype,"autoRotate",void 0);ct([g()],He.prototype,"autoRotateSpeed",void 0);ct([g()],He.prototype,"minAzimuthAngle",void 0);ct([g()],He.prototype,"maxAzimuthAngle",void 0);ct([g()],He.prototype,"minPolarAngle",void 0);ct([g()],He.prototype,"maxPolarAngle",void 0);ct([g()],He.prototype,"enableKeys",void 0);ct([g()],He.prototype,"enableDamping",void 0);ct([g()],He.prototype,"dampingFactor",void 0);ct([g()],He.prototype,"enableZoom",void 0);ct([g()],He.prototype,"minZoom",void 0);ct([g()],He.prototype,"maxZoom",void 0);ct([g()],He.prototype,"zoomSpeed",void 0);ct([g()],He.prototype,"enablePan",void 0);ct([g(cd)],He.prototype,"lookAtConstraint",void 0);ct([g()],He.prototype,"lookAtConstraint01",void 0);ct([g()],He.prototype,"allowInterrupt",void 0);ct([g()],He.prototype,"middleClickToFocus",void 0);ct([g()],He.prototype,"doubleClickToFocus",void 0);ct([g()],He.prototype,"clickBackgroundToFitScene",void 0);ct([g()],He.prototype,"targetLerpDuration",null);ct([g(z)],He.prototype,"targetBounds",void 0);var mn=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},Gi;(function(s){s[s.None=0]="None",s[s.Skybox=1]="Skybox",s[s.SolidColor=2]="SolidColor",s[s.Uninitialized=4]="Uninitialized"})(Gi||(Gi={}));const _a=k("debugcam"),IS=k("debugscreenpointtoray"),Sh=class extends W{constructor(){super(...arguments);a(this,"_nearClipPlane",.1);a(this,"_farClipPlane",1e3);a(this,"orthographic",!1);a(this,"orthographicSize",5);a(this,"ARBackgroundAlpha",0);a(this,"_cullingMask",4294967295);a(this,"_backgroundBlurriness");a(this,"_backgroundIntensity");a(this,"_backgroundRotation");a(this,"_environmentIntensity");a(this,"_targetTexture",null);a(this,"_backgroundColor");a(this,"_fov");a(this,"_cam",null);a(this,"_clearFlags",Gi.SolidColor);a(this,"_skybox");a(this,"_frustum");a(this,"_projScreenMatrix",new xe)}get isCamera(){return!0}get aspect(){return this._cam instanceof Ae?this._cam.aspect:this.context.domWidth/this.context.domHeight}set aspect(e){this._cam instanceof Ae&&this._cam.aspect!==e&&(this._cam.aspect=e,this._cam.updateProjectionMatrix())}get fieldOfView(){return this._cam instanceof Ae?this._cam.fov:this._fov}set fieldOfView(e){const i=this.fieldOfView!=e;if(this._fov=e,i&&this._cam&&this._cam instanceof Ae){if(this._fov===void 0){console.warn("Can not set undefined fov on PerspectiveCamera");return}this._cam.fov=this._fov,this._cam.updateProjectionMatrix()}}get nearClipPlane(){return this._nearClipPlane}set nearClipPlane(e){const i=this._nearClipPlane!=e;this._nearClipPlane=e,this._cam&&(i||this._cam.near!=e)&&(this._cam.near=e,this._cam.updateProjectionMatrix())}get farClipPlane(){return this._farClipPlane}set farClipPlane(e){const i=this._farClipPlane!=e;this._farClipPlane=e,this._cam&&(i||this._cam.far!=e)&&(this._cam.far=e,this._cam.updateProjectionMatrix())}applyClippingPlane(){this._cam&&(this._cam.near=this._nearClipPlane,this._cam.far=this._farClipPlane,this._cam.updateProjectionMatrix())}get clearFlags(){return this._clearFlags}set clearFlags(e){if(typeof e=="string")switch(e){case"skybox":e=Gi.Skybox;break;case"solidcolor":e=Gi.SolidColor;break;default:e=Gi.None;break}e!==this._clearFlags&&(this._clearFlags=e,this.applyClearFlagsIfIsActiveCamera())}set cullingMask(e){this._cullingMask=e,this._cam&&(this._cam.layers.mask=e)}get cullingMask(){return this._cam?this._cam.layers.mask:this._cullingMask}set cullingLayer(e){this.cullingMask=(1<<e|0)>>>0}set backgroundBlurriness(e){e!==this._backgroundBlurriness&&(e===void 0?this._backgroundBlurriness=void 0:this._backgroundBlurriness=Math.min(Math.max(e,0),1),this.applyClearFlagsIfIsActiveCamera())}get backgroundBlurriness(){return this._backgroundBlurriness}set backgroundIntensity(e){e!==this._backgroundIntensity&&(e===void 0?this._backgroundIntensity=void 0:this._backgroundIntensity=Math.min(Math.max(e,0),10),this.applyClearFlagsIfIsActiveCamera())}get backgroundIntensity(){return this._backgroundIntensity}set backgroundRotation(e){e!==this._backgroundRotation&&(e===void 0?this._backgroundRotation=void 0:this._backgroundRotation=e,this.applyClearFlagsIfIsActiveCamera())}get backgroundRotation(){return this._backgroundRotation}set environmentIntensity(e){this._environmentIntensity=e}get environmentIntensity(){return this._environmentIntensity}get backgroundColor(){return this._backgroundColor??null}set backgroundColor(e){e&&(this._backgroundColor||(this._backgroundColor=new Te(1,1,1,1)),this._backgroundColor.copy(e),(!("alpha"in e)||e.alpha===void 0)&&(this._backgroundColor.alpha=1),this.applyClearFlagsIfIsActiveCamera())}set targetTexture(e){this._targetTexture=e}get targetTexture(){return this._targetTexture}get cam(){return this.threeCamera}get threeCamera(){return this.activeAndEnabled&&this.buildCamera(),this._cam}screenPointToRay(e,i,n){const o=this.threeCamera,r=Sh._origin;r.set(e,i,-1),this.context.input.convertScreenspaceToRaycastSpace(r),IS&&console.log("screenPointToRay",e.toFixed(2),i.toFixed(2),"now:",r.x.toFixed(2),r.y.toFixed(2),"isInXR:"+this.context.isInXR),r.z=-1,r.unproject(o);const l=Sh._direction.set(r.x,r.y,r.z),c=ve(o);return l.sub(c),l.normalize(),n?(n.set(c,l),n):new zr(c.clone(),l.clone())}getFrustum(){return this._frustum||(this._frustum=new jx,this.updateFrustum()),this._frustum}updateFrustum(){this._frustum||(this._frustum=new jx),this._frustum.setFromProjectionMatrix(this.getProjectionScreenMatrix(this._projScreenMatrix,!0),this.context.renderer.coordinateSystem)}getProjectionScreenMatrix(e,i){return i&&this._projScreenMatrix.multiplyMatrices(this.threeCamera.projectionMatrix,this.threeCamera.matrixWorldInverse),e===this._projScreenMatrix?e:e.copy(this._projScreenMatrix)}awake(){IS&&window.addEventListener("pointerdown",e=>{const i=e.clientX,n=e.clientY;console.log("touch",i.toFixed(2),n.toFixed(2));const o=this.screenPointToRay(i,n),r="#"+Math.floor(Math.random()*16777215).toString(16);se.DrawRay(o.origin,o.direction,r,10)})}onEnable(){_a&&console.log(`Camera enabled: "${this.name}". ClearFlags=${Gi[this._clearFlags]}`,this),this.buildCamera(),(this.tag=="MainCamera"||!this.context.mainCameraComponent)&&(this.context.setCurrentCamera(this),zL(this)),this.applyClearFlagsIfIsActiveCamera({applySkybox:!0})}onDisable(){this.context.removeCamera(this)}onLeaveXR(e){this.fieldOfView=this._fov}onBeforeRender(){if(this._cam&&(this._frustum&&this.updateFrustum(),this._clearFlags===Gi.SolidColor&&this.applyClearFlagsIfIsActiveCamera(),this._targetTexture)){this.context.isManagedExternally&&(this._warnedAboutExternalRenderer||(this._warnedAboutExternalRenderer=!0,console.warn("Rendering with external renderer is not supported yet. This may not work or throw errors. Please remove the the target texture from your camera: "+this.name,this.targetTexture))),this.context.composer;const e=this.context.renderer;if(e){const i=this.context.mainCameraComponent;this.applyClearFlags(),this._targetTexture.render(this.context.scene,this._cam,e),i==null||i.applyClearFlags()}}}buildCamera(){if(this._cam)return;const e=this.gameObject.isCamera;let i=null;if(e?(i=this.gameObject,i==null||i.layers.enableAll(),i instanceof Ae&&(this._fov=i.fov)):i=this.gameObject.children[0],i&&i.isCamera)i instanceof Ae&&(this._fov&&(i.fov=this._fov),i.near=this._nearClipPlane,i.far=this._farClipPlane,i.updateProjectionMatrix());else if(!this.orthographic)i=new Ae(this.fieldOfView,window.innerWidth/window.innerHeight,this._nearClipPlane,this._farClipPlane),this.fieldOfView&&(i.fov=this.fieldOfView),this.gameObject.add(i);else{const n=this.orthographicSize*100;i=new _g(window.innerWidth/-n,window.innerWidth/n,window.innerHeight/n,window.innerHeight/-n,this._nearClipPlane,this._farClipPlane),this.gameObject.add(i)}this._cam=i,this._cam.layers.mask=this._cullingMask,this.tag=="MainCamera"&&this.context.setCurrentCamera(this)}applyClearFlagsIfIsActiveCamera(e){this.context.mainCameraComponent===this&&this.applyClearFlags(e)}applyClearFlags(e){var n;if(!this._cam){_a&&console.log("Camera does not exist (apply clear flags)");return}if(this.fieldOfView=this.fieldOfView,_a){const o=`[Camera] Apply ClearFlags: ${Gi[this._clearFlags]} - "${this.name}"`;console.debug(o)}const i=this.context.domElement.getAttribute("background-image")||this.context.domElement.getAttribute("background-color");switch(this._clearFlags){case Gi.None:return;case Gi.Skybox:if(Sh.backgroundShouldBeTransparent(this.context)&&(!this.ARBackgroundAlpha||this.ARBackgroundAlpha<.001)){this.context.scene.background=null,this.context.renderer.setClearColor(0,0);return}(!this.scene.background||!this._skybox||(e==null?void 0:e.applySkybox)===!0)&&this.applySceneSkybox(),this._backgroundBlurriness!==void 0&&!this.context.domElement.getAttribute("background-blurriness")?this.context.scene.backgroundBlurriness=this._backgroundBlurriness:_a&&console.warn(`Camera "${this.name}" has no background blurriness`),this._backgroundIntensity!==void 0&&!this.context.domElement.getAttribute("background-intensity")&&(this.context.scene.backgroundIntensity=this._backgroundIntensity),this._backgroundRotation!==void 0&&!this.context.domElement.getAttribute("background-rotation")?this.context.scene.backgroundRotation=this._backgroundRotation:_a&&console.warn(`Camera "${this.name}" has no background intensity`);break;case Gi.SolidColor:if(this._backgroundColor&&!i){let o=this._backgroundColor.alpha;Sh.backgroundShouldBeTransparent(this.context)&&(o=this.ARBackgroundAlpha??0),this.context.scene.background=null,(n=this.context.xr)!=null&&n.isVR?this.context.renderer.setClearColor(BE(this._backgroundColor).convertLinearToSRGB()):this.context.renderer.setClearColor(this._backgroundColor,o)}else this._backgroundColor||_a&&console.warn(`[Camera] has no background color "${this.name}" `);break;case Gi.Uninitialized:i||(this.context.scene.background=null,this.context.renderer.setClearColor(0,0));break}}applySceneSkybox(){this._skybox||(this._skybox=new NL(this)),this._skybox.apply()}static backgroundShouldBeTransparent(e){var r,l,c,h;const i=(r=e.renderer.xr)==null?void 0:r.getSession();if(!i)return!1;if(typeof i._transparent=="boolean")return i._transparent;const n=i.environmentBlendMode;_a&&at("Environment blend mode: "+n+" on "+navigator.userAgent);let o=n==="additive"||n==="alpha-blend";if(e.isInAR&&n==="opaque"){if((l=navigator.userAgent)!=null&&l.includes("OculusBrowser"))o=!0;else if((c=navigator.userAgent)!=null&&c.includes("Mozilla")&&((h=navigator.userAgent)!=null&&h.includes("Mobile WebXRViewer/v2")))o=!0;else if(Q.isNeedleAppClip())return!0}return i._transparent=o,o}};let ze=Sh;a(ze,"_origin",new R),a(ze,"_direction",new R);mn([g()],ze.prototype,"aspect",null);mn([g()],ze.prototype,"fieldOfView",null);mn([g()],ze.prototype,"nearClipPlane",null);mn([g()],ze.prototype,"farClipPlane",null);mn([g()],ze.prototype,"clearFlags",null);mn([g()],ze.prototype,"orthographic",void 0);mn([g()],ze.prototype,"orthographicSize",void 0);mn([g()],ze.prototype,"ARBackgroundAlpha",void 0);mn([g()],ze.prototype,"cullingMask",null);mn([g()],ze.prototype,"backgroundBlurriness",null);mn([g()],ze.prototype,"backgroundIntensity",null);mn([g(Ht)],ze.prototype,"backgroundRotation",null);mn([g()],ze.prototype,"environmentIntensity",null);mn([g(Te)],ze.prototype,"backgroundColor",null);mn([g(ic)],ze.prototype,"targetTexture",null);class NL{constructor(t){a(this,"_camera");a(this,"_skybox");this._camera=t}get context(){var t;return(t=this._camera)==null?void 0:t.context}apply(){var t;if(this._skybox=this.context.lightmaps.tryGetSkybox(this._camera.sourceId),!this._skybox)this._did_log_failed_to_find_skybox||(this._did_log_failed_to_find_skybox=!0,console.warn(`Camera "${this._camera.name}" has no skybox texture. ${this._camera.sourceId}`));else if(this.context.scene.background!==this._skybox){const e=this.context.domElement.getAttribute("background-image")||this.context.domElement.getAttribute("background-color");_a&&console.debug(`[Camera] Apply Skybox ${(t=this._skybox)==null?void 0:t.name} ${e} - "${this._camera.name}"`),e!=null&&e.length||(this._skybox.mapping=Vo,this.context.scene.background=this._skybox)}}}function zL(s){k("freecam")&&s.context.mainCameraComponent===s&&I.getOrAddComponent(s.gameObject,He)}class Aa extends W{constructor(){super(...arguments);a(this,"_listener",null);a(this,"onInteraction",()=>{this.destroyed||this.listener==null||this.addListenerIfItExists()})}get listener(){return this._listener==null&&(this._listener=new jO),this._listener}onEnable(){Xs.registerWaitForInteraction(this.onInteraction),this.addListenerIfItExists()}onDisable(){Xs.unregisterWaitForInteraction(this.onInteraction),this.removeListenerIfItExists()}addListenerIfItExists(){const e=this._listener;if(!e||e!=null&&e.parent)return;const i=this.context.mainCameraComponent||I.getComponentInParent(this.gameObject,ze);i!=null&&i.threeCamera?i.threeCamera.add(e):this.gameObject.add(e),e.filter?(e.gain.connect(e.filter),e.filter.connect(e.context.destination)):e.gain.connect(e.context.destination)}removeListenerIfItExists(){const e=this._listener;e&&(e.removeFromParent(),e.filter&&e.filter.disconnect(),e.gain&&e.gain.disconnect())}}var io=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const gi=k("debugaudio");var ku;(function(s){s[s.Logarithmic=0]="Logarithmic",s[s.Linear=1]="Linear",s[s.Custom=2]="Custom"})(ku||(ku={}));class We extends W{constructor(){super(...arguments);a(this,"clip","");a(this,"playOnAwake",!1);a(this,"preload",!0);a(this,"playInBackground",!0);a(this,"_spatialBlend",0);a(this,"_minDistance",1);a(this,"_maxDistance",100);a(this,"_volume",1);a(this,"rollOffMode",0);a(this,"_loop",!1);a(this,"sound",null);a(this,"helper",null);a(this,"wasPlaying",!1);a(this,"audioLoader",null);a(this,"shouldPlay",!1);a(this,"_lastClipStartedLoading",null);a(this,"_audioElement",null);a(this,"onVisibilityChanged",()=>{switch(document.visibilityState){case"hidden":(this.playInBackground===!1||Q.isMobileDevice())&&(this.wasPlaying=this.isPlaying,this.isPlaying&&this.pause());break;case"visible":gi&&console.log("visible",this.enabled,this.playOnAwake,!this.isPlaying,We.userInteractionRegistered,this.wasPlaying),this.enabled&&this.playOnAwake&&!this.isPlaying&&We.userInteractionRegistered&&this.wasPlaying&&this.play();break}});a(this,"onApplicationMuteChanged",()=>{var e,i;this.context.application.muted?(e=this.sound)==null||e.setVolume(0):(i=this.sound)==null||i.setVolume(this.volume)});a(this,"createAudio",e=>{if(this.destroyed){gi&&console.warn("AudioSource destroyed, not creating audio",this.name);return}gi&&console.log("AudioBuffer finished loading",e);const i=this.Sound;if(!i){gi&&console.warn("Failed getting sound?",this.name);return}i.isPlaying&&i.stop(),e&&i.setBuffer(e),i.loop=this._loop,this.context.application.muted?i.setVolume(0):i.setVolume(this.volume),i.autoplay=this.shouldPlay&&We.userInteractionRegistered,this.applySpatialDistanceSettings(),i.isPlaying&&i.stop(),We.registerWaitForAllowAudio(this.__onAllowAudioCallback)});a(this,"__onAllowAudioCallback",()=>{this.shouldPlay&&this.play()});a(this,"_lastContextTime",0);a(this,"_hasEnded",!0);a(this,"_needUpdateSpatialDistanceSettings",!1)}static get userInteractionRegistered(){return Xs.userInteractionRegistered}static registerWaitForAllowAudio(e){Xs.registerWaitForInteraction(e)}get isPlaying(){var e;return((e=this.sound)==null?void 0:e.isPlaying)??!1}get duration(){var e,i;return(i=(e=this.sound)==null?void 0:e.buffer)==null?void 0:i.duration}get time01(){var i;const e=this.duration;return e&&this.sound?((i=this.sound)==null?void 0:i.context.currentTime)/e:0}set time01(e){const i=this.duration;i&&this.sound&&(this.time=e*i)}get time(){var e,i;return(e=this.sound)!=null&&e.source?((i=this.sound.source)==null?void 0:i.context.currentTime)-this._lastContextTime+this.sound.offset:0}set time(e){if(this.sound){if(e===this.sound.offset)return;const i=this.isPlaying;this.stop(),this.sound.offset=e,i&&this.play()}}get loop(){return this.sound&&(this._loop=this.sound.getLoop()),this._loop}set loop(e){this._loop=e,this.sound&&this.sound.setLoop(e)}get spatialBlend(){return this._spatialBlend}set spatialBlend(e){e!==this._spatialBlend&&(this._spatialBlend=e,this._needUpdateSpatialDistanceSettings=!0)}get minDistance(){return this._minDistance}set minDistance(e){this._minDistance!==e&&(this._minDistance=e,this._needUpdateSpatialDistanceSettings=!0)}get maxDistance(){return this._maxDistance}set maxDistance(e){this._maxDistance!==e&&(this._maxDistance=e,this._needUpdateSpatialDistanceSettings=!0)}get volume(){return this._volume}set volume(e){this._volume=e,this.sound&&!this.context.application.muted&&(gi&&console.log(this.name,"audio set volume",e),this.sound.setVolume(e))}set pitch(e){this.sound&&this.sound.setPlaybackRate(e)}get pitch(){return this.sound?this.sound.getPlaybackRate():1}get Sound(){var e;if(!this.sound&&We.userInteractionRegistered){let i=this.gameObject.getComponent(Aa)??this.context.mainCamera.getComponent(Aa)??Ef(Aa,this.context,!1);!i&&this.context.mainCamera&&(i=this.context.mainCamera.addComponent(Aa)),i!=null&&i.listener?(this.sound=new FO(i.listener),(e=this.gameObject)==null||e.add(this.sound)):gi&&console.warn("No audio listener found in scene - can not play audio")}return this.sound}get ShouldPlay(){return this.shouldPlay}get audioContext(){var e;return(e=this.sound)==null?void 0:e.context}awake(){gi&&console.log("[AudioSource]",this),this.audioLoader=new l_,this.playOnAwake&&(this.shouldPlay=!0),this.preload&&typeof this.clip=="string"&&this.audioLoader.load(this.clip,this.createAudio,()=>{},console.error)}onEnable(){this.sound&&this.gameObject.add(this.sound),We.userInteractionRegistered?this.playOnAwake&&this.context.application.isVisible&&this.play():We.registerWaitForAllowAudio(()=>{this.enabled&&!this.destroyed&&this.shouldPlay&&this.onNewClip(this.clip)}),globalThis.addEventListener("visibilitychange",this.onVisibilityChanged),this.context.application.addEventListener(Jl.MuteChanged,this.onApplicationMuteChanged)}onDisable(){globalThis.removeEventListener("visibilitychange",this.onVisibilityChanged),this.context.application.removeEventListener(Jl.MuteChanged,this.onApplicationMuteChanged),this.pause()}applySpatialDistanceSettings(){const e=this.sound;if(!e)return;this._needUpdateSpatialDistanceSettings=!1;const i=ee.lerp(10*this._maxDistance/Math.max(1e-4,this.spatialBlend),this._minDistance,this.spatialBlend);switch(gi&&console.log(this.name,this._minDistance,this._maxDistance,this.spatialBlend,"Ref distance="+i),e.setRefDistance(i),e.setMaxDistance(Math.max(.01,this._maxDistance)),this.rollOffMode){case ku.Logarithmic:e.setDistanceModel("exponential");break;case ku.Linear:e.setDistanceModel("linear");break;case ku.Custom:console.warn("Custom rolloff for AudioSource is not supported: "+this.name);break}this.spatialBlend>0?gi&&!this.helper&&(this.helper=new Uk(e,e.getRefDistance()),e.add(this.helper)):this.helper&&this.helper.parent&&this.helper.removeFromParent()}async onNewClip(e){if(e&&(this.clip=e),typeof e=="string")if(gi&&console.log(e),e.endsWith(".mp3")||e.endsWith(".wav")){if(this.audioLoader||(this.audioLoader=new l_),this.shouldPlay=!0,this._lastClipStartedLoading===e){gi&&console.log("Is currently loading:",this._lastClipStartedLoading,this);return}this._lastClipStartedLoading=e,gi&&console.log("load audio",e);const i=await this.audioLoader.loadAsync(e).catch(console.error);if(this.destroyed)return;this._lastClipStartedLoading===e&&(this._lastClipStartedLoading=null),i&&this.createAudio(i)}else console.warn("Unsupported audio clip type",e);else this.shouldPlay=!0,this.createAudio()}play(e=void 0){var n,o,r;!e&&this.clip&&(e=this.clip),e!==void 0&&typeof e!="string"&&!(e instanceof MediaStream)&&(X()&&console.warn("Called play on AudioSource with unknown argument type:",e+`
Using the assigned clip instead:`,this.clip),e=this.clip);let i=!this.sound||e&&e!==this.clip;if(typeof e=="string"&&!this.audioLoader&&(i=!0),(e instanceof MediaStream||typeof e=="string")&&(this.clip=e),i){this.shouldPlay=!0,this.onNewClip(e);return}if(this.shouldPlay=!0,this._hasEnded=!1,gi&&console.log("play",(n=this.sound)==null?void 0:n.getVolume(),this.sound),this.sound&&!this.sound.isPlaying){const l=this.context.application.muted;l&&this.sound.setVolume(0),(o=this.gameObject)==null||o.add(this.sound),this.clip instanceof MediaStream?(this.sound.setMediaStreamSource(this.clip),this._audioElement||(this._audioElement=document.createElement("audio"),this._audioElement.style.display="none"),this._audioElement.parentNode||(r=this.context.domElement.shadowRoot)==null||r.append(this._audioElement),this._audioElement.srcObject=this.clip,this._audioElement.autoplay=!1):(this._audioElement&&this._audioElement.remove(),this.sound.play(l?.1:0))}}pause(){var e,i;gi&&console.log("Pause",this),this._hasEnded=!0,this.shouldPlay=!1,this.sound&&this.sound.isPlaying&&this.sound.source&&(this._lastContextTime=(e=this.sound)==null?void 0:e.context.currentTime,this.sound.pause()),(i=this._audioElement)==null||i.remove()}stop(){var e,i;gi&&console.log("Pause",this),this._hasEnded=!0,this.shouldPlay=!1,this.sound&&this.sound.source&&(this._lastContextTime=(e=this.sound)==null?void 0:e.context.currentTime,gi&&console.log(this._lastContextTime),this.sound.stop()),(i=this._audioElement)==null||i.remove()}update(){this.helper&&(this.isPlaying&&this.helper.update(),this.helper.visible=this.isPlaying),this._needUpdateSpatialDistanceSettings&&this.applySpatialDistanceSettings(),this.sound&&!this.sound.isPlaying&&this.shouldPlay&&!this._hasEnded&&(this._hasEnded=!0,gi&&console.log("Audio clip ended",this.clip),this.dispatchEvent(new CustomEvent("ended",{detail:this})))}}io([g(URL)],We.prototype,"clip",void 0);io([g()],We.prototype,"playOnAwake",void 0);io([g()],We.prototype,"preload",void 0);io([g()],We.prototype,"playInBackground",void 0);io([g()],We.prototype,"loop",null);io([g()],We.prototype,"spatialBlend",null);io([g()],We.prototype,"minDistance",null);io([g()],We.prototype,"maxDistance",null);io([g()],We.prototype,"volume",null);io([g()],We.prototype,"pitch",null);io([g()],We.prototype,"rollOffMode",void 0);const $L=k("debugavatar"),Fs=class extends W{constructor(){super(...arguments);a(this,"connectionId");a(this,"avatar")}static getAvatar(e){return e>=0&&e<Fs.instances.length?Fs.instances[e]:null}static onAvatarMarkerCreated(e){return Fs._onNewAvatarMarkerAdded.push(e),e}static onAvatarMarkerDestroyed(e){return Fs._onAvatarMarkerDestroyed.push(e),e}awake(){Fs.instances.push(this),$L&&console.log(this);for(const e of Fs._onNewAvatarMarkerAdded)e({avatarMarker:this,gameObject:this.gameObject})}onDestroy(){Fs.instances.splice(Fs.instances.indexOf(this),1);for(const e of Fs._onAvatarMarkerDestroyed)e({avatarMarker:this,gameObject:this.gameObject})}isLocalAvatar(){return this.connectionId===this.context.connection.connectionId}};let ni=Fs;a(ni,"instances",[]),a(ni,"_onNewAvatarMarkerAdded",[]),a(ni,"_onAvatarMarkerDestroyed",[]);class Ba{static Add(t,e,i=null){if(e){for(const n of this.Pois)if(n.obj===e)return;this.Pois.push({obj:e,avatar:i}),this.LastChangeTime=t.time.time}}static Remove(t,e){var i;if(e){for(const n of this.Pois)if(n.obj===e){this.Pois.splice(this.Pois.indexOf(n),1),this.LastChangeTime=(t==null?void 0:t.time.time)??((i=de.Current)==null?void 0:i.time.time);return}}}}a(Ba,"Pois",[]),a(Ba,"LastChangeTime",0);var zm;(function(s){s.TargetChanged="avatar-look-target-changed"})(zm||(zm={}));class VL{constructor(){a(this,"guid");a(this,"position",new R)}}class $m extends W{constructor(){super(...arguments);a(this,"target",null);a(this,"avatar",null);a(this,"_model",null);a(this,"_targetModel",new VL);a(this,"_currentTargetObject",null);a(this,"_lastUpdateTime",0);a(this,"_lookDuration",0);a(this,"_lastPoiChangedTime",0)}set controlledTarget(e){this.target=e;const i=j.get("MoveRandom");if(i&&this.target){const n=I.getComponent(this.target,i);n&&n.destroy()}}awake(){if(this.avatar=I.getComponentInParent(this.gameObject,ni),this.avatar){const e=I.getComponentInParent(this.gameObject,ni);this._model=new LP(this.context.connection,this.guid),e!=null&&e.isLocalAvatar&&this._model.requestOwnership()}this.context.connection.beginListen(zm.TargetChanged,e=>{var i;this.target&&e&&e.guid===((i=this.avatar)==null?void 0:i.guid)&&Oi(this.target,e.position)})}update(){var i;if((!this.context.connection.isConnected||(i=this._model)!=null&&i.hasOwnership)&&(Ba.LastChangeTime!==this._lastPoiChangedTime&&(this._lastPoiChangedTime=Ba.LastChangeTime,this._lookDuration=0),this.selectTarget(),this._currentTargetObject&&this.context.time.frameCount%10===0&&this.target)){const n=ve(this._currentTargetObject);Oi(this.target,n),this.context.connection.isConnected&&this.avatar&&(this.context.connection.send(zm.TargetChanged,this._targetModel),this._targetModel.guid=this.avatar.guid,this._targetModel.position.copy(n))}}selectTarget(){if(this.context.time.time-this._lastUpdateTime>this._lookDuration){this._lastUpdateTime=this.context.time.time,this._lookDuration=Math.random()*.5+.2;const i=Ba.Pois;if(i.length>0){const n=i[Math.floor(Math.random()*i.length)];if(n&&n.obj){if(n.avatar&&n.avatar===this.avatar)return;this._currentTargetObject=n.obj}}}}}function WL(s){const t=s;return!!(t.parser&&t.parser.json)}var Vm;(function(s){s[s.None=0]="None",s[s.DontExport=1]="DontExport"})(Vm||(Vm={}));function HL(s){return s&&s.isComponent}const $4=Symbol("object"),xb=new vs(()=>new R,20);class GL{constructor(t,e,i,n,o,r){a(this,"_point");a(this,"_normal");a(this,"_tangentVelocity");a(this,"distance");a(this,"impulse");a(this,"friction");this._point=t,this.distance=e,this._normal=i,this.impulse=n,this.friction=o,this._tangentVelocity=r}get point(){return xb.get().set(this._point.x,this._point.y,this._point.z)}get normal(){return xb.get().set(this._normal.x,this._normal.y,this._normal.z)}get tangentVelocity(){return xb.get().set(this._tangentVelocity.x,this._tangentVelocity.y,this._tangentVelocity.z)}}class qL{constructor(t,e,i){a(this,"contacts");a(this,"me");a(this,"_collider");a(this,"_gameObject");this.me=t,this._collider=e,this._gameObject=e.gameObject,this.contacts=i}get collider(){return this._collider}get gameObject(){return this._gameObject}get rigidBody(){var t;return(t=this.collider)==null?void 0:t.attachedRigidbody}}class XL{constructor(t,e){a(this,"object");a(this,"collider");this.object=t,this.collider=e}}const yt=k("debugnetworkingstreams");var Pt;(function(s){s.Connected="peer-user-connected",s.StreamReceived="receive-stream",s.StreamEnded="call-ended",s.Disconnected="peer-user-disconnected",s.UserJoined="user-joined"})(Pt||(Pt={}));class RT{constructor(t,e){a(this,"type",Pt.StreamEnded);a(this,"userId");a(this,"direction");this.userId=t,this.direction=e}}class QL{constructor(t,e,i){a(this,"type",Pt.StreamReceived);a(this,"userId");a(this,"stream");a(this,"target");this.userId=t,this.stream=e,this.target=i}}class YL{constructor(t,e){a(this,"guid");a(this,"peerId");a(this,"dontSave",!0);this.guid=t.id,this.peerId=e}}var kr;(function(s){s.Incoming="incoming",s.Outgoing="outgoing"})(kr||(kr={}));class KL extends A0{constructor(e,i,n,o=null){super();a(this,"peerId");a(this,"userId");a(this,"direction");a(this,"call");a(this,"_stream",null);a(this,"_isDisposed",!1);this.peerId=i.peer,this.userId=e,this.call=i,this.direction=n,this._stream=o,i.on("stream",r=>{if(yt&&console.log("Receive stream",`
Audio:`,r.getAudioTracks(),`
Video:`,r.getVideoTracks()),this._stream=r,n===kr.Incoming){const l=new QL(e,r,this);this.dispatchEvent(l)}}),i.on("close",()=>{this.dispatchEvent(new RT(e,n))})}get stream(){return this._stream}close(){this._isDisposed||(this._isDisposed=!0,this.call.close(),Mr(this._stream))}get isOpen(){var e;return((e=this.call.peerConnection)==null?void 0:e.connectionState)==="connected"}get isOpening(){var e;return((e=this.call.peerConnection)==null?void 0:e.connectionState)==="connecting"}get isClosed(){return!this.isOpen||this._isDisposed}}function LS(s){return s=s.replace("a=fmtp:111 minptime=10;useinbandfec=1","a=fmtp:111 ptime=5;useinbandfec=1;stereo=1;maxplaybackrate=48000;maxaveragebitrat=128000;sprop-stereo=1"),s}const Ch=class extends A0{constructor(e,i){var o;super();a(this,"updateCalls",()=>{var e;for(let i=this._incomingCalls.length-1;i>=0;i--){const n=this._incomingCalls[i];n.isClosed&&!n.isOpening&&this._incomingCalls.splice(i,1)}for(let i=this._outgoingCalls.length-1;i>=0;i--){const n=this._outgoingCalls[i];let o=!1;n.isClosed&&!n.isOpening&&((e=n.stream)!=null&&e.active?yt&&console.warn("!!! Stream is still active, don't remove call",n.userId,"Your id: "+this.context.connection.connectionId):(yt&&console.warn("!!! Remove closed call",n.userId),o=!0)),this.context.connection.userIsInRoom(n.userId)===!1&&(yt&&console.warn("!!! User is not in room anymore, remove call",n.userId),o=!0),o&&(n.close(),this._outgoingCalls.splice(i,1))}});a(this,"id");a(this,"context");a(this,"_incomingCalls",[]);a(this,"_outgoingCalls",[]);a(this,"_peer");a(this,"_enabled",!1);a(this,"_enabledPeer",!1);a(this,"onConnectRoomFn",this.onConnectRoom.bind(this));a(this,"onPeerConnect",e=>{if(yt&&console.log("PEER opened as",e),e===null){console.error("Peer connection failed",e);return}this.context.connection.send(Pt.Connected,new YL(this,e))});a(this,"onPeerClose",()=>{yt&&console.log("PEER closed"),this.updateCalls()});a(this,"onPeerDisconnected",()=>{yt&&console.log("PEER disconnected"),this.updateCalls()});a(this,"onPeerError",e=>{yt&&console.error("PEER error",e)});a(this,"onPeerReceivingCall",e=>{e.answer(void 0,{sdpTransform:i=>LS(i)}),this.registerCall(e,kr.Incoming,null)});this.context=e,this.id=i,this.setupPeer();const n=(o=Object.getOwnPropertyDescriptor(navigator,"getUserMedia"))==null?void 0:o.writable;try{n?navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia:yt&&console.warn("[PeerJs] getUserMedia is not writable")}catch(r){yt&&console.error("[PeerJs] Error setting getUserMedia",r)}}static getOrCreate(e,i){if(Ch.instances.has(i))return Ch.instances.get(i);const n=new Ch(e,i);return Ch.instances.set(i,n),n}getMyPeerId(){if(this.context.connection.connectionId)return this.getPeerIdFromUserId(this.context.connection.connectionId)}getPeerIdFromUserId(e){return this.id+"-"+e}getUserIdFromPeerId(e){return e.substring(this.id.length+1)}makeCall(e,i){var r;if(!(i!=null&&i.id)){yt?console.warn("Can not make a call: mediastream has no id or is undefined"):console.debug("Can not make a call: mediastream has no id or is undefined");return}const n={metadata:{userId:this.context.connection.connectionId,streamId:i.id},sdpTransform:l=>LS(l)},o=(r=this._peer)==null?void 0:r.call(e,i,n);if(o){const l=this.registerCall(o,kr.Outgoing,i);return yt&&console.warn(`üìû CALL ${e}`,`
Outgoing:`,this._outgoingCalls,`
Incoming:`,this._incomingCalls),l}else yt&&console.error("Failed to make call",e,i,this._peer)}closeAll(){for(const e of this._incomingCalls)e.close();for(const e of this._outgoingCalls)e.close();this.updateCalls()}get peer(){return this._peer}get incomingCalls(){return this._incomingCalls}enable(){this._enabled||(this._enabled=!0,this.context.connection.beginListen(me.JoinedRoom,this.onConnectRoomFn),this.subscribePeerEvents())}disable(){this._enabled&&(this._enabled=!1,this.context.connection.stopListen(me.JoinedRoom,this.onConnectRoomFn),this.unsubscribePeerEvents())}onConnectRoom(){this.setupPeer()}setupPeer(){if(this.context.connection.connectionId&&!this._enabledPeer){if(this._enabledPeer=!0,!this._peer){const e=this.getMyPeerId();e?this._peer=MA(e):console.error("Failed to setup peerjs because we dont have a connection id",this.context.connection.connectionId)}this._enabled&&this.subscribePeerEvents()}}subscribePeerEvents(){this._peer&&(this._peer.on("open",this.onPeerConnect),this._peer.on("close",this.onPeerClose),this._peer.on("call",this.onPeerReceivingCall),this._peer.on("disconnected",this.onPeerDisconnected),this._peer.on("error",this.onPeerError))}unsubscribePeerEvents(){this._peer&&(this._peer.off("open",this.onPeerConnect),this._peer.off("close",this.onPeerClose),this._peer.off("call",this.onPeerReceivingCall),this._peer.off("disconnected",this.onPeerDisconnected),this._peer.off("error",this.onPeerError))}registerCall(e,i,n){const o=e.metadata;(!o||!o.userId)&&console.error("Missing call metadata",e);const r=o.userId;i===kr.Incoming&&yt?console.warn("‚Üê Receive call from",e.metadata,e.connectionId):yt&&console.warn("‚Üí Make call to",e.metadata);const l=i===kr.Incoming?this._incomingCalls:this._outgoingCalls,c=new KL(r,e,i,n);return l.push(c),e.on("error",h=>{console.error("Call error",h)}),e.on("close",()=>{yt&&console.log("Call ended",e.metadata);const h=l.indexOf(c);h!==-1&&l.splice(h,1),c.close(),this.dispatchEvent(new RT(r,i))}),c.addEventListener(Pt.StreamEnded,h=>{this.dispatchEvent(h)}),i===kr.Incoming&&(c.addEventListener(Pt.StreamReceived,h=>{this.dispatchEvent(h)}),e.on("stream",()=>{yt&&console.log("Received stream for call",e.metadata);let h=0;const d=setInterval(()=>{const u=h===0;!c.isOpen&&u&&(yt&&console.warn("Close call because stream is not active",e.metadata),h+=1,clearInterval(d),c.close())},2e3)})),c}};let jh=Ch;a(jh,"instances",new Map);class Gg extends A0{constructor(e,i){super();a(this,"context");a(this,"peer");a(this,"_sendingStreams",new Map);a(this,"debug",!1);a(this,"_enabled",!1);a(this,"_tickIntervalId");a(this,"tick",()=>{this.updateSendingCalls()});a(this,"onJoinedRoom",e=>{this._sendingStreams.size>0&&(this.debug&&console.warn(`${e!=null&&e.userId?`User ${e.userId}`:"You"} joined room`,e,this._sendingStreams.size),this.updateSendingCalls())});a(this,"onLeftRoom",e=>{this.debug&&console.warn(`${(e==null?void 0:e.userId)||"You"} left room`,e),this.stopCallsToUsersThatAreNotInTheRoomAnymore(),this.peer.closeAll()});a(this,"onCallStreamReceived",e=>{this.debug&&console.log("Call with "+e.userId+" started"),this.dispatchEvent({type:Pt.StreamReceived,target:this,stream:e.stream,userId:e.userId}),this.debug&&this.debugLogCurrentState()});a(this,"onCallEnded",e=>{this.debug&&console.log("Call with "+e.userId+" ended"),this.dispatchEvent(e),this.debug&&this.debugLogCurrentState()});a(this,"onUserConnected",e=>{if(this.peer.id===e.guid){this.debug&&console.log("PEER USER CONNECTED",e.guid,e,this._sendingStreams.size);const i=this._sendingStreams.keys().next().value;this.peer.makeCall(e.peerId,i)}else yt&&console.log("Unknown user connected",e.guid,e.peerId)});a(this,"onUserLeft",e=>{this.debug&&console.log("User left room: "+e.userId),this.stopCallsToUsersThatAreNotInTheRoomAnymore()});if(HL(e)){const n=e;e=n.context,i=jh.getOrCreate(n.context,n.guid)}else typeof i=="string"&&(i=jh.getOrCreate(e,i));if(e){if(!(e instanceof de))throw new Error("Failed to create NetworkedStreams because context is not an instance of Context")}else throw new Error("Failed to create NetworkedStreams because context is undefined");if(!i)throw new Error("Failed to create NetworkedStreams because peer is undefined");this.context=e,this.peer=i,yt&&(this.debug=!0)}static create(e,i){const n=jh.getOrCreate(e.context,i||e.context.connection.connectionId||e.guid);return new Gg(e.context,n)}startSendingStream(e){this._sendingStreams.has(e)?console.warn("Received start sending stream with stream that is already being sent"):(this._sendingStreams.set(e,[]),this.updateSendingCalls())}stopSendingStream(e){if(e){const i=this._sendingStreams.get(e);if(i){for(const n of i)n.close();i.length=0}this._sendingStreams.delete(e),i&&this.debug&&this.debugLogCurrentState()}this.updateSendingCalls()}get enabled(){return this._enabled}enable(){this._enabled||(this._enabled=!0,this.peer.enable(),this.peer.addEventListener(Pt.StreamReceived,this.onCallStreamReceived),this.peer.addEventListener(Pt.StreamEnded,this.onCallEnded),this.context.connection.beginListen(Pt.Connected,this.onUserConnected),this.context.connection.beginListen(me.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(me.UserJoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(me.UserLeftRoom,this.onUserLeft),this.context.connection.beginListen(me.LeftRoom,this.onLeftRoom),this._tickIntervalId=setInterval(this.tick,5e3))}disable(){this._enabled&&(this._enabled=!1,this.peer.disable(),this.peer.removeEventListener(Pt.StreamReceived,this.onCallStreamReceived),this.peer.removeEventListener(Pt.StreamEnded,this.onCallEnded),this.context.connection.stopListen(Pt.Connected,this.onUserConnected),this.context.connection.stopListen(me.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(me.UserJoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(me.UserLeftRoom,this.onUserLeft),this.context.connection.stopListen(me.LeftRoom,this.onLeftRoom),this._tickIntervalId!=null&&(clearInterval(this._tickIntervalId),this._tickIntervalId=void 0))}updateSendingCalls(){const e=this.context.connection.connectionId;for(const i of this._sendingStreams.keys()){const n=this._sendingStreams.get(i)||[];for(const o of this.context.connection.usersInRoom()){if(o===e)continue;const r=this.peer.getPeerIdFromUserId(o);if(n.find(c=>{var h;return c.peerId===r&&c.direction===kr.Outgoing&&!c.isClosed&&((h=c.stream)==null?void 0:h.active)}))yt&&console.debug("Already have a call with user "+o+" / peer "+r);else{const c=this.peer.makeCall(r,i);c&&n.push(c)}}this._sendingStreams.set(i,n)}this.stopCallsToUsersThatAreNotInTheRoomAnymore()}stopCallsToUsersThatAreNotInTheRoomAnymore(){for(const e of this._sendingStreams.keys()){const i=this._sendingStreams.get(e);if(i)for(let n=i.length-1;n>=0;n--){const o=i[n];this.context.connection.userIsInRoom(o.userId)?yt&&(this.context.connection.connectionId===o.userId?console.warn(`You are still in the room [${n}] ${o.userId}`):console.log(`User is still in room [${n}] ${o.userId}`)):(yt&&console.log(`Remove call ${[n]} to user that is not in room anymore ${o.userId}`),o.close(),i.splice(n,1))}}this.peer.updateCalls(),this.debug&&this.debugLogCurrentState()}debugLogCurrentState(){console.warn(`You (${this.context.connection.connectionId}) are currently sending ${this._sendingStreams.size} and receiving ${this.peer.incomingCalls.length} calls (${this.peer.incomingCalls.map(e=>e.userId).join(", ")})`,this.peer.incomingCalls)}}function Mr(s){if(s&&s instanceof MediaStream)for(const t of s.getTracks())t.stop()}var gv=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const ZL="noVoip",JL=k("debugvoip");class wc extends W{constructor(){super(...arguments);a(this,"autoConnect",!0);a(this,"runInBackground",!0);a(this,"createMenuButton",!0);a(this,"debug",!1);a(this,"_net");a(this,"_menubutton");a(this,"_allowSending",!0);a(this,"_outputStream",null);a(this,"onJoinedRoom",async()=>{this.debug&&console.log("VOIP: Joined room"),await Ha(300),this.autoConnect&&!this.isSending&&this._allowSending&&this.connect()});a(this,"onLeftRoom",()=>{this.debug&&console.log("VOIP: Left room"),this.disconnect();for(const e of this._incomingStreams.values())Mr(e.srcObject);this._incomingStreams.clear()});a(this,"_incomingStreams",new Map);a(this,"onReceiveStream",e=>{const i=e.target.userId,n=e.stream;let o=this._incomingStreams.get(i);o||(o=new Audio,this._incomingStreams.set(i,o)),o.srcObject=n,o.setAttribute("autoplay","true"),Xs.registerWaitForInteraction(()=>{o==null||o.play().catch(r=>{console.error("VOIP: Failed to play audio",r)})})});a(this,"onStreamEnded",e=>{const i=this._incomingStreams.get(e.userId);Mr(i==null?void 0:i.srcObject),this._incomingStreams.delete(e.userId)});a(this,"onEnabledChanged",()=>{for(const e of this._incomingStreams){const i=e[1];i.muted=!this.enabled}});a(this,"onVisibilityChanged",()=>{if(this.runInBackground)return;const i=!(document.visibilityState==="visible");this.setMuted(i);for(const n of this._incomingStreams){const o=n[1];o.muted=i}})}awake(){JL&&(this.debug=!0),this.debug&&(console.log("VOIP debugging: press 'v' to toggle mute or 'c' to toggle connect/disconnect"),window.addEventListener("keydown",async e=>{switch(e.key.toLowerCase()){case"v":console.log("MUTE?",!this.isMuted),this.setMuted(!this.isMuted);break;case"c":this.isSending?this.disconnect():this.connect();break}}),window.addEventListener("blur",()=>{console.log("VOIP: MUTE ON BLUR"),this.setMuted(!0)}),window.addEventListener("focus",()=>{console.log("VOIP: UNMUTE ON FOCUS"),this.setMuted(!1)}))}onEnable(){this._net||(this._net=Gg.create(this)),this.debug&&(this._net.debug=!0),this._net.addEventListener(Pt.StreamReceived,this.onReceiveStream),this._net.addEventListener(Pt.StreamEnded,this.onStreamEnded),this._net.enable(),this.autoConnect&&this.context.connection.isConnected&&this.connect(),this.context.connection.beginListen(me.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(me.LeftRoom,this.onLeftRoom),this.onEnabledChanged(),this.updateButton(),window.addEventListener("visibilitychange",this.onVisibilityChanged)}onDisable(){var e;this._net&&(this._net.stopSendingStream(this._outputStream),this._net.removeEventListener(Pt.StreamReceived,this.onReceiveStream),this._net.removeEventListener(Pt.StreamEnded,this.onStreamEnded),(e=this._net)==null||e.disable()),this.context.connection.stopListen(me.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(me.LeftRoom,this.onLeftRoom),this.onEnabledChanged(),this.updateButton(),window.removeEventListener("visibilitychange",this.onVisibilityChanged)}onDestroy(){var e;(e=this._menubutton)==null||e.remove(),this._menubutton=void 0}get isSending(){return this._outputStream!=null&&this._outputStream.active}async connect(e){var i,n;if(!this._net)return console.error("Cannot connect to voice chat - NetworkedStreams not initialized. Make sure the component is enabled before calling this method."),!1;if(this.context.connection.isConnected){if(!await Q.microphonePermissionsGranted())return console.error("Cannot connect to voice chat - microphone permissions not granted"),this.updateButton(),!1}else return console.error("Cannot connect to voice chat - not connected to server"),this.updateButton(),!1;return this._allowSending=!0,(i=this._net)==null||i.stopSendingStream(this._outputStream),Mr(this._outputStream),this._outputStream=await this.getAudioStream(e),this._outputStream?(this.debug&&console.log("VOIP: Got audio stream"),(n=this._net)==null||n.startSendingStream(this._outputStream),this.updateButton(),!0):(this.updateButton(),await Q.microphonePermissionsGranted()?console.error("VOIP: Could not get audio stream - please make sure to connect an audio device and grant microphone permissions"):Ag("Microphone permissions not granted: Please grant microphone permissions to use voice chat"),(this.debug||X())&&console.log("VOIP: Failed to get audio stream"),!1)}disconnect(e){var i;e!=null&&e.remember&&(this._allowSending=!1),(i=this._net)==null||i.stopSendingStream(this._outputStream),Mr(this._outputStream),this._outputStream=null,this.updateButton()}setMuted(e){var n;const i=(n=this._outputStream)==null?void 0:n.getAudioTracks();if(i)for(const o of i)o.enabled=!e}get isMuted(){var i;if(this._outputStream===null)return!1;const e=(i=this._outputStream)==null?void 0:i.getAudioTracks();if(e){for(const n of e)if(!n.enabled)return!0}return!1}async updateButton(){var e;if(this.createMenuButton){if(this._menubutton||(this._menubutton=document.createElement("button"),this._menubutton.addEventListener("click",()=>{this.isSending?this.disconnect({remember:!0}):this.connect(),Q.microphonePermissionsGranted().then(i=>{i||qe("<strong>Microphone permissions not granted</strong>. Please allow your browser to use the microphone to be able to talk. Click on the button on the left side of your browser's address bar to allow microphone permissions.")})})),this._menubutton){this.context.menu.appendChild(this._menubutton),this.activeAndEnabled?this._menubutton.style.display="":this._menubutton.style.display="none",this._menubutton.title=this.isSending?"Click to disable your microphone":"Click to enable your microphone";let i=(this.isSending,""),n=this.isSending?"mic":"mic_off";await Q.microphonePermissionsGranted()||(i="No Permission",n="mic_off",this._menubutton.title="Microphone permissions not granted. Please allow your browser to use the microphone to be able to talk. This can usually be done in the addressbar of the webpage."),this._menubutton.innerText=i,this._menubutton.prepend(Qi(n)),this.context.connection.isConnected==!1?this._menubutton.setAttribute("disabled",""):this._menubutton.removeAttribute("disabled")}}else this.activeAndEnabled||(e=this._menubutton)==null||e.remove()}getFrequency(e){return this.unsupported_getfrequency||(this.unsupported_getfrequency=!0,X()&&qe("VOIP: getFrequency is currently not supported"),console.warn("VOIP: getFrequency is currently not supported")),null}async getAudioStream(e){if(!navigator.mediaDevices.getUserMedia)return console.error("No getDisplayMedia support"),null;const i=async o=>await navigator.mediaDevices.getUserMedia({audio:o??!0,video:!1}).catch(r=>(console.warn("VOIP failed getting audio stream",r),null)),n=await i(e);if(!n)return null;if(Q.isiOS()&&(e==null?void 0:e.deviceId)===void 0){const r=(await navigator.mediaDevices.enumerateDevices()).find(l=>(l.kind==="audioinput"||l.kind==="audiooutput")&&!l.label.includes("iPhone"));if(r){const l=Object.assign({},e);return l.deviceId=r.deviceId,await i(l)}}return n}}gv([g()],wc.prototype,"autoConnect",void 0);gv([g()],wc.prototype,"runInBackground",void 0);gv([g()],wc.prototype,"createMenuButton",void 0);var OT=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const eD=k("debugmouth");class qg extends W{constructor(){super(...arguments);a(this,"idle",[]);a(this,"talking",[]);a(this,"marker",null);a(this,"voip",null);a(this,"lastMouthChangeTime",0);a(this,"mouthChangeLength",0)}awake(){setTimeout(()=>{this.voip=I.findObjectOfType(wc,this.context),this.marker||(this.marker=I.getComponentInParent(this.gameObject,ni))},3e3)}update(){var n;if(!this.voip||this.context.time.frameCount%10!==0)return;let e=((n=this.marker)==null?void 0:n.connectionId)??null;if(!e){eD&&(e=null);return}const i=this.voip.getFrequency(e)??0;this.updateLips(i)}updateLips(e){if(this.context.time.time-this.lastMouthChangeTime>this.mouthChangeLength){if(this.mouthChangeLength=.05+Math.random()*.1,this.talking&&this.talking.length>0&&e>30){this.lastMouthChangeTime=this.context.time.time;const i=Math.floor(Math.random()*this.talking.length);this.setMouthShapeActive(this.talking,i)}else if(this.idle.length>0&&this.context.time.time-this.lastMouthChangeTime>.5){this.lastMouthChangeTime=this.context.time.time;const i=Math.floor(Math.random()*this.idle.length);this.setMouthShapeActive(this.idle,i)}}}setMouthShapeActive(e,i){if(e){e!=this.idle?this.idle.map(n=>n.visible=!1):this.talking.map(n=>n.visible=!1);for(let n=0;n<e.length;n++){const o=e[n];o&&(o.visible=n===i)}}}}OT([g(z)],qg.prototype,"idle",void 0);OT([g(z)],qg.prototype,"talking",void 0);class kT extends W{constructor(){super(...arguments);a(this,"voip",null);a(this,"marker",null);a(this,"_startPosition",null)}awake(){this.voip=I.findObjectOfType(wc,this.context),this.marker=I.getComponentInParent(this.gameObject,ni)}update(){if(!this.voip||!this.marker||this.context.time.frameCount%10!==0)return;const e=this.marker.connectionId,i=this.voip.getFrequency(e);if(i==null)return;this._startPosition||(this._startPosition=this.gameObject.position.clone());const n=i/100;this.gameObject.position.y=this._startPosition.y+n*.07}}var tD=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const oh=k("debugxrflags"),ET=k("disablexrflags");ET&&console.warn("XRFlags are disabled");var ms;(function(s){s[s.Never=0]="Never",s[s.Browser=1]="Browser",s[s.AR=2]="AR",s[s.VR=4]="VR",s[s.FirstPerson=8]="FirstPerson",s[s.ThirdPerson=16]="ThirdPerson",s[s.All=4294967295]="All"})(ms||(ms={}));const ox=class{constructor(){a(this,"Mask",ms.Browser|ms.ThirdPerson)}Has(t){return(this.Mask&t)!==0}Set(t){oh&&console.warn("Set XR flag state to",t),this.Mask=t,Ci.Apply()}Enable(t){this.Mask|=t,Ci.Apply()}Disable(t){this.Mask&=~t,Ci.Apply()}Toggle(t){this.Mask^=t,Ci.Apply()}EnableAll(){this.Mask=-1,Ci.Apply()}DisableAll(){this.Mask=0,Ci.Apply()}};let un=ox;a(un,"Global",new ox);const Co=class extends W{constructor(){super(...arguments);a(this,"visibleIn")}static Apply(){for(const e of this.registry)e.UpdateVisible(un.Global)}awake(){Co.registry.push(this)}onEnable(){Co.firstApply?this.UpdateVisible(un.Global):(Co.firstApply=!0,Co.Apply())}onDestroy(){const e=Co.registry.indexOf(this);e>=0&&Co.registry.splice(e,1)}get isOn(){return this.gameObject.visible}UpdateVisible(e=null){if(ET)return;let i;const n=e;if(n&&typeof n=="number"&&(console.assert(typeof n=="number","XRFlag.UpdateVisible: state must be a number",n),oh&&console.log(n),Co.buffer.Mask=n,e=Co.buffer),e instanceof un?(oh&&console.warn(this.name,"use passed in mask",e.Mask,this.visibleIn),i=e.Has(this.visibleIn)):(oh&&console.log(this.name,"use global mask"),un.Global.Has(this.visibleIn)),i!==void 0)if(i)oh&&console.log(this.name,"is visible",this.gameObject.uuid),I.setActive(this.gameObject,!0);else{if(oh&&console.log(this.name,"is not visible",this.gameObject.uuid),!this.gameObject.visible)return;this.gameObject.visible=!1}}};let Ci=Co;a(Ci,"registry",[]),a(Ci,"firstApply"),a(Ci,"buffer",new un);tD([g()],Ci.prototype,"visibleIn",void 0);var Xg=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class hd extends W{constructor(){super(...arguments);a(this,"eyes",[]);a(this,"lastBlinkTime",0);a(this,"blinkLength",0);a(this,"eyesOpen",!0);a(this,"state",null)}awake(){this.state=I.getComponentInParent(this.gameObject,Ci)}update(){if(!this.gameObject||!this.gameObject.visible||!this.eyes||!Array.isArray(this.eyes)||this.eyes.length===0)return;if(this.context.time.time-this.lastBlinkTime>this.blinkLength){if(this.lastBlinkTime=this.context.time.time,this.state&&!this.state.isOn||!this.activeAndEnabled)return;if(this.eyesOpen=!this.eyesOpen,this.blinkLength=Math.random(),this.eyesOpen?(this.blinkLength*=3,this.blinkLength+=.5,Math.random()<.1&&(this.blinkLength=.1+Math.random()*.2)):(this.blinkLength*=Math.random()*.2,this.blinkLength+=.1),Math.random()<.1&&(this.blinkLength*=3),this.blinkLength=Math.max(.2,this.blinkLength),this.blinkLength=Math.min(3,this.blinkLength),this.eyes)for(const i of this.eyes)i&&(i.visible=this.eyesOpen)}}}Xg([g(z)],hd.prototype,"eyes",void 0);Xg([g()],hd.prototype,"lastBlinkTime",void 0);Xg([g()],hd.prototype,"blinkLength",void 0);Xg([g()],hd.prototype,"eyesOpen",void 0);var yv=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const rx=class extends W{constructor(){super(...arguments);a(this,"head",null);a(this,"eyes",null);a(this,"target",null);a(this,"brain",null);a(this,"vec",new R);a(this,"currentTargetPoint",new R)}awake(){this.brain||(this.brain=I.getComponentInParent(this.gameObject,$m)),this.brain||(this.brain=I.addComponent(this.gameObject,$m)),this.brain&&this.target&&(this.brain.controlledTarget=this.target)}update(){const e=this.target;if(e&&this.head){const i=this.eyes;if(i){const n=ve(e);this.currentTargetPoint.lerp(n,this.context.time.deltaTime/.1);const o=ve(this.head),r=this.vec.copy(this.currentTargetPoint).sub(o).normalize();if(r.length()<.1)return;const l=rx.forward;if(l.set(0,0,1),l.applyQuaternion(Qe(this.head)),l.dot(r)>.45)for(let h=0;h<i.length;h++)i[h].lookAt(this.currentTargetPoint)}}}};let Ua=rx;a(Ua,"forward",new R(0,0,1));yv([g(z)],Ua.prototype,"head",void 0);yv([g(z)],Ua.prototype,"eyes",void 0);yv([g(z)],Ua.prototype,"target",void 0);var bv=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Lf extends W{constructor(){super(...arguments);a(this,"length",1);a(this,"depthTest",!0);a(this,"isGizmo",!1);a(this,"_axes",null)}onEnable(){if(this.isGizmo&&!Of)return;this._axes||(this._axes=new Wn(this.length)),this._axes.layers.disableAll(),this._axes.layers.set(this.layer),this.gameObject.add(this._axes);const e=this._axes.material;e&&e.depthTest!==void 0&&(e.depthTest=this.depthTest)}onDisable(){this._axes&&this.gameObject.remove(this._axes)}}bv([g()],Lf.prototype,"length",void 0);bv([g()],Lf.prototype,"depthTest",void 0);bv([g()],Lf.prototype,"isGizmo",void 0);class MT extends W{constructor(){super(...arguments);a(this,"from");a(this,"to");a(this,"hint");a(this,"desiredDistance",1)}onEnable(){}update(){if(!this.from||!this.to||!this.hint)return;const e=ve(this.to).clone(),i=ve(this.from).clone(),n=e.distanceTo(i),o=e.clone();o.sub(i);const r=i.clone();r.add(e),r.multiplyScalar(.5);const l=ve(this.hint).clone();l.sub(r);const c=new R;c.crossVectors(l,o),c.crossVectors(o,c),c.normalize();const h=n*.5,d=Math.max(this.desiredDistance,h),u=Math.sqrt(d*d-h*h),f=c.clone();f.multiplyScalar(u),f.add(r),Oi(this.gameObject,f);const p=r.clone();p.sub(c),this.gameObject.lookAt(p)}}const iD=k("gizmos"),nD=k("debugboxhelper"),Bs=class extends W{constructor(){super(...arguments);a(this,"box",null);a(this,"_lastMatrixUpdateFrame",-1);a(this,"_helper",null);a(this,"_color",null)}isInBox(e){var n;if(!e)return;if(this.box||(this.box=new bs),On([e],void 0,void 0,Bs.testBox),Bs.testBox.isEmpty()){const o=ve(e,Bs._position);Bs.testBox.setFromCenterAndSize(o,Bs._emptyObjectSize)}this.updateBox();const i=(n=this.box)==null?void 0:n.intersectsBox(Bs.testBox);return i&&nD&&se.DrawWireBox3(Bs.testBox,16711680,5),i}intersects(e){return e?this.updateBox(!1).intersectsBox(e):!1}updateBox(e=!1){if(this.box||(this.box=new bs),e||this.context.time.frameCount!=this._lastMatrixUpdateFrame){const i=this._lastMatrixUpdateFrame<0;this._lastMatrixUpdateFrame=this.context.time.frameCount;const n=i,o=ve(this.gameObject,Bs._position,n),r=Lt(this.gameObject,Bs._size);this.box.setFromCenterAndSize(o,r)}return this.box}awake(){this._helper=null,this._color=null,this.box=null}showHelper(e=null,i=!1){var n;if(!(!iD&&!i)){if(this._helper){e&&((n=this._color)==null||n.set(e)),this.gameObject.add(this._helper);return}this._helper=Z0(e),this.gameObject.add(this._helper)}}};let Nn=Bs;a(Nn,"testBox",new bs),a(Nn,"_position",new R),a(Nn,"_size",new R(.01,.01,.01)),a(Nn,"_emptyObjectSize",new R(.01,.01,.01));var kn=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class no extends W{constructor(){super(...arguments);a(this,"attachedRigidbody",null);a(this,"isTrigger",!1);a(this,"sharedMaterial");a(this,"membership",[0]);a(this,"filter");a(this,"updateProperties",()=>{var e;(e=this.context.physics.engine)==null||e.updateProperties(this)})}get isCollider(){return!0}awake(){super.awake(),this.attachedRigidbody||(this.attachedRigidbody=this.gameObject.getComponentInParent(De))}start(){this.attachedRigidbody||(this.attachedRigidbody=this.gameObject.getComponentInParent(De))}onEnable(){this.attachedRigidbody||(this.attachedRigidbody=this.gameObject.getComponentInParent(De))}onDisable(){var e;(e=this.context.physics.engine)==null||e.removeBody(this)}get body(){var e;return(e=this.context.physics.engine)==null?void 0:e.getBody(this)}updatePhysicsMaterial(){var e;(e=this.context.physics.engine)==null||e.updatePhysicsMaterial(this)}}kn([g(De)],no.prototype,"attachedRigidbody",void 0);kn([g()],no.prototype,"isTrigger",void 0);kn([g()],no.prototype,"sharedMaterial",void 0);kn([g()],no.prototype,"membership",void 0);kn([g()],no.prototype,"filter",void 0);class Df extends no{constructor(){super(...arguments);a(this,"radius",.5);a(this,"center",new R(0,0,0))}onEnable(){var e;super.onEnable(),(e=this.context.physics.engine)==null||e.addSphereCollider(this),B0(this.gameObject.scale,this.updateProperties)}onDisable(){super.onDisable(),f1(this.gameObject.scale,this.updateProperties)}onValidate(){this.updateProperties()}}kn([en(),g()],Df.prototype,"radius",void 0);kn([g(R)],Df.prototype,"center",void 0);class Sc extends no{constructor(){super(...arguments);a(this,"size",new R(1,1,1));a(this,"center",new R(0,0,0))}static add(e,i){const n=Wo(e,Sc);return n.autoFit(),(i==null?void 0:i.rigidbody)===!0&&Wo(e,De,{isKinematic:!1}),n}onEnable(){var e;super.onEnable(),(e=this.context.physics.engine)==null||e.addBoxCollider(this,this.size),B0(this.gameObject.scale,this.updateProperties)}onDisable(){super.onDisable(),f1(this.gameObject.scale,this.updateProperties)}onValidate(){this.updateProperties()}autoFit(e){const i=this.gameObject,n=i.position.clone(),o=i.quaternion.clone(),r=i.scale.clone(),l=i.parent;i.position.set(0,0,0),i.quaternion.set(0,0,0,1),i.scale.set(1,1,1),i.parent=null,i.updateMatrix();const c=On([i]);i.position.copy(n),i.quaternion.copy(o),i.scale.copy(r),i.parent=l,(e==null?void 0:e.debug)===!0&&se.DrawWireBox3(c,16768256,20),this.size=c.getSize(new R)||new R(1,1,1),this.center=c.getCenter(new R)||new R(0,0,0),this.size.length()<=0&&this.size.set(.01,.01,.01)}}kn([en(),g(R)],Sc.prototype,"size",void 0);kn([g(R)],Sc.prototype,"center",void 0);class Cc extends no{constructor(){super(...arguments);a(this,"sharedMesh");a(this,"convex",!1)}onEnable(){var i,n,o;if(super.onEnable(),!this.context.physics.engine)return;(i=this.sharedMesh)!=null&&i.isMesh||(this.gameObject instanceof le||this.gameObject instanceof Ir)&&(this.sharedMesh=this.gameObject);const e=0;if((n=this.sharedMesh)!=null&&n.isMesh)this.context.physics.engine.addMeshCollider(this,this.sharedMesh,this.convex),Tt.assignMeshLOD(this.sharedMesh,e).then(r=>{r&&this.activeAndEnabled&&this.context.physics.engine&&this.sharedMesh&&(this.context.physics.engine.removeBody(this),this.sharedMesh.geometry=r,this.context.physics.engine.addMeshCollider(this,this.sharedMesh,this.convex))});else{const r=this.sharedMesh;if(r!=null&&r.isGroup){console.warn(`MeshCollider mesh is a group "${((o=this.sharedMesh)==null?void 0:o.name)||this.gameObject.name}", adding all children as colliders. This is currently not fully supported (colliders can not be removed from world again)`,this);const l=new Array;for(const c in r.children){const h=r.children[c];h.isMesh&&(this.context.physics.engine.addMeshCollider(this,h,this.convex),l.push(Tt.assignMeshLOD(h,e)))}Promise.all(l).then(c=>{var d,u;if(c.some(f=>f)==!1)return;(d=this.context.physics.engine)==null||d.removeBody(this);const h=new le;for(const f of c)f&&this.activeAndEnabled&&(h.geometry=f,(u=this.context.physics.engine)==null||u.addMeshCollider(this,h,this.convex))})}else(X()||k("showcolliders"))&&console.warn(`[MeshCollider] A MeshCollider mesh is assigned to an unknown object on "${this.gameObject.name}", but it's neither a Mesh nor a Group. Please double check that you attached the collider component to the right object and report a bug otherwise!`,this)}}}kn([g(le)],Cc.prototype,"sharedMesh",void 0);kn([g()],Cc.prototype,"convex",void 0);class Ga extends no{constructor(){super(...arguments);a(this,"center",new R(0,0,0));a(this,"radius",.5);a(this,"height",2)}onEnable(){var e;super.onEnable(),(e=this.context.physics.engine)==null||e.addCapsuleCollider(this,this.height,this.radius)}}kn([g(R)],Ga.prototype,"center",void 0);kn([g()],Ga.prototype,"radius",void 0);kn([g()],Ga.prototype,"height",void 0);var Zr=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const DS=k("debugcharactercontroller");class dd extends W{constructor(){super(...arguments);a(this,"center",new R(0,0,0));a(this,"radius",.5);a(this,"height",2);a(this,"_rigidbody",null);a(this,"_activeGroundCollisions");a(this,"_contactVelocity",new R)}get rigidbody(){return this._rigidbody?this._rigidbody:(this._rigidbody=this.gameObject.getComponent(De),this._rigidbody||(this._rigidbody=this.gameObject.addComponent(De)),this.rigidbody)}awake(){this._activeGroundCollisions=new Set}onEnable(){const e=this.rigidbody;let i=this.gameObject.getComponent(Ga);i||(i=this.gameObject.addComponent(Ga)),i.center.copy(this.center),i.radius=this.radius,i.height=this.height;const n=new R(0,0,1),o=new R(1,0,0),r=new R(0,1,0),l=this.gameObject.getWorldDirection(new R);l.y=0;const c=o.dot(l)<0?-1:1,h=n.angleTo(l)*c;this.gameObject.setRotationFromAxisAngle(r,h),e.lockRotationX=!0,e.lockRotationY=!0,e.lockRotationZ=!0}move(e){this.gameObject.position.add(e)}onCollisionEnter(e){(e.contacts.length==0||e.contacts.some(i=>i.normal.y>.2))&&(this._activeGroundCollisions.add(e),DS&&console.log(`Collision(${this._activeGroundCollisions.size}): ${e.contacts.map(i=>i.normal.y.toFixed(2)).join(", ")} - ${this.isGrounded}`))}onCollisionExit(e){this._activeGroundCollisions.delete(e),DS&&console.log(`Collision(${this._activeGroundCollisions.size}) - ${this.isGrounded}`)}get isGrounded(){return this._activeGroundCollisions.size>0}get contactVelocity(){var e;this._contactVelocity.set(0,0,0);for(const i of this._activeGroundCollisions){const n=(e=this.context.physics.engine)==null?void 0:e.getLinearVelocity(i.collider);n&&(this._contactVelocity.x+=n.x,this._contactVelocity.y+=n.y,this._contactVelocity.z+=n.z)}return this._contactVelocity}}Zr([g(R)],dd.prototype,"center",void 0);Zr([g()],dd.prototype,"radius",void 0);Zr([g()],dd.prototype,"height",void 0);class Ka extends W{constructor(){super(...arguments);a(this,"controller");a(this,"movementSpeed",2);a(this,"rotationSpeed",2);a(this,"jumpForce",1);a(this,"doubleJumpForce",2);a(this,"animator");a(this,"lookForward",!0);a(this,"lookInput",new _e(0,0));a(this,"moveInput",new _e(0,0));a(this,"jumpInput",!1);a(this,"_currentSpeed",new R(0,0,0));a(this,"_currentAngularSpeed",new R(0,0,0));a(this,"_temp",new R(0,0,0));a(this,"_jumpCount",0);a(this,"_currentRotation");a(this,"_raycastOptions",new Ya)}awake(){this._currentRotation=new re}update(){const e=this.context.input;e.isKeyPressed("KeyW")?this.moveInput.y+=1:e.isKeyPressed("KeyS")&&(this.moveInput.y-=1),e.isKeyPressed("KeyD")?this.lookInput.x+=1:e.isKeyPressed("KeyA")&&(this.lookInput.x-=1),this.jumpInput||(this.jumpInput=e.isKeyDown("Space"))}move(e){this.moveInput.add(e)}look(e){this.lookInput.add(e)}jump(){this.jumpInput=!0}onBeforeRender(){this.handleInput(this.moveInput,this.lookInput,this.jumpInput),this.lookInput.set(0,0),this.moveInput.set(0,0),this.jumpInput=!1}handleInput(e,i,n){var o,r,l,c,h,d,u,f,p,b,x;if((o=this.controller)!=null&&o.isGrounded&&(this._jumpCount=0,this.doubleJumpForce>0&&((r=this.animator)==null||r.setBool("doubleJump",!1))),this._currentSpeed.z+=e.y*this.movementSpeed*this.context.time.deltaTime,(l=this.animator)==null||l.setBool("running",e.length()>.01),(h=this.animator)==null||h.setBool("jumping",((c=this.controller)==null?void 0:c.isGrounded)===!0&&n),this._temp.copy(this._currentSpeed),this._temp.applyQuaternion(this.gameObject.quaternion),this.controller?this.controller.move(this._temp):this.gameObject.position.add(this._temp),this._currentAngularSpeed.y+=ee.toRadians(-i.x*this.rotationSpeed)*this.context.time.deltaTime,this.lookForward&&Math.abs(this._currentAngularSpeed.y)<.01){const v=this.context.mainCameraComponent.forward;v.y=0,v.normalize(),this._currentRotation.setFromUnitVectors(new R(0,0,1),v),this.gameObject.quaternion.slerp(this._currentRotation,this.context.time.deltaTime*10)}if(this.gameObject.rotateY(this._currentAngularSpeed.y),this._currentSpeed.multiplyScalar(1-this.context.time.deltaTime*10),this._currentAngularSpeed.y*=1-this.context.time.deltaTime*10,this.controller&&n&&this.jumpForce>0){let v=(d=this.controller)==null?void 0:d.isGrounded;if(this.doubleJumpForce>0&&!((u=this.controller)!=null&&u.isGrounded)&&this._jumpCount===1&&(v=!0,(f=this.animator)==null||f.setBool("doubleJump",!0)),v){this._jumpCount+=1;const S=this.controller.rigidbody,C=this._jumpCount===2?this.doubleJumpForce:this.jumpForce;S.applyImpulse(new R(0,1,0).multiplyScalar(C))}}if(this.controller){const v=(p=this.controller)==null?void 0:p.rigidbody.getVelocity().y;if(v<-1){this._raycastOptions.ray||(this._raycastOptions.ray=new zr),this._raycastOptions.ray.origin.copy(ve(this.gameObject)),this._raycastOptions.ray.direction.set(0,-1,0);const S=this.layer;this.gameObject.layers.disableAll(),this.gameObject.layers.set(2);const C=this.context.physics.raycast(this._raycastOptions);this.gameObject.layers.set(S),(C.length&&C[0].distance>2||v<-10)&&((b=this.animator)==null||b.setBool("falling",!0))}else(x=this.animator)==null||x.setBool("falling",!1)}}}Zr([g(dd)],Ka.prototype,"controller",void 0);Zr([g()],Ka.prototype,"movementSpeed",void 0);Zr([g()],Ka.prototype,"rotationSpeed",void 0);Zr([g()],Ka.prototype,"jumpForce",void 0);Zr([g()],Ka.prototype,"doubleJumpForce",void 0);Zr([g(Ei)],Ka.prototype,"animator",void 0);var ud=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Wd=k("debugcontactshadows");zg(s=>{const t=s.domElement.getAttribute("contactshadows")||s.domElement.getAttribute("contact-shadows");if(t!=null&&t!="0"&&t!="false"){console.debug("Auto-creating ContactShadows because of `contactshadows` attribute");const e=qn.auto(s),i=parseFloat(t);isNaN(i)||(e.opacity=i,e.darkness=i)}});const Ph=class extends W{constructor(){super(...arguments);a(this,"autoFit",!1);a(this,"darkness",.5);a(this,"opacity",.5);a(this,"blur",4);a(this,"occludeBelowGround",!1);a(this,"backfaceShadows",!0);a(this,"minSize");a(this,"manualUpdate",!1);a(this,"_needsUpdate",!1);a(this,"shadowsRoot",new z);a(this,"shadowCamera");a(this,"shadowGroup",new Ir);a(this,"renderTarget");a(this,"renderTargetBlur");a(this,"plane");a(this,"occluderMesh");a(this,"blurPlane");a(this,"depthMaterial");a(this,"horizontalBlurMaterial");a(this,"verticalBlurMaterial");a(this,"textureSize",512)}static auto(e,i){if(e||(e=de.Current),!e)throw new Error("No context provided and no current context set.");let n=this._instances.get(e);if(!n||n.destroyed){const o=new z;n=Wo(o,Ph,{autoFit:!1,occludeBelowGround:!1}),this._instances.set(e,n)}return e.scene.add(n.gameObject),n.fitShadows(i),n}set needsUpdate(e){this._needsUpdate=e}get needsUpdate(){return this._needsUpdate}fitShadows(e={}){Wd&&console.warn("Fitting shadows to scene"),f_(this.shadowsRoot,!1);const i=e.object||this.context.scene,n=On(i,[this.shadowsRoot]),o=Math.max(1,this.blur/32),r=n.max.x-n.min.x,l=n.max.z-n.min.z;n.expandByVector(new R(o*r,0,o*l)),Wd&&se.DrawWireBox3(n,16776960,60),this.gameObject.parent&&n.applyMatrix4(this.gameObject.parent.matrixWorld.clone().invert());const c=n.min,h=Math.max(1e-5,(n.max.y-c.y)*.002);n.max.y+=h,this.shadowsRoot.position.set((c.x+n.max.x)/2,c.y-h,(c.z+n.max.z)/2),this.shadowsRoot.scale.set(n.max.x-c.x,n.max.y-c.y,n.max.z-c.z),e.positionOffset&&(e.positionOffset.x!==void 0&&(this.shadowsRoot.position.x+=e.positionOffset.x),e.positionOffset.y!==void 0&&(this.shadowsRoot.position.y+=e.positionOffset.y),e.positionOffset.z!==void 0&&(this.shadowsRoot.position.z+=e.positionOffset.z)),e.scaleFactor&&(e.scaleFactor.x!==void 0&&(this.shadowsRoot.scale.x*=e.scaleFactor.x),e.scaleFactor.y!==void 0&&(this.shadowsRoot.scale.y*=e.scaleFactor.y),e.scaleFactor.z!==void 0&&(this.shadowsRoot.scale.z*=e.scaleFactor.z)),this.applyMinSize(),this.shadowsRoot.matrixWorldNeedsUpdate=!0,Wd&&console.log("Fitted shadows to scene",this.shadowsRoot.scale.clone())}awake(){Ph._instances.set(this.context,this),this.shadowsRoot.hideFlags=Vm.DontExport,f_(this.shadowsRoot,!1)}start(){Wd&&console.log("Create ContactShadows on "+this.gameObject.name,this),this.gameObject.add(this.shadowsRoot),this.shadowsRoot.add(this.shadowGroup),this.renderTarget=new Qo(this.textureSize,this.textureSize),this.renderTarget.texture.generateMipmaps=!1,this.renderTargetBlur=new Qo(this.textureSize,this.textureSize),this.renderTargetBlur.texture.generateMipmaps=!1;const e=new to(1,1).rotateX(Math.PI/2);this.gameObject instanceof le&&(console.warn("ContactShadows can not be added to a Mesh. Please add it to a Group or an empty Object"),Rr(this.gameObject,!1));const i=new Ye({map:this.renderTarget.texture,opacity:this.opacity,color:0,transparent:!0,depthWrite:!1,side:Wa});this.plane=new le(e,i),this.plane.scale.y=-1,this.plane.layers.set(2),this.shadowsRoot.add(this.plane),this.plane&&(this.plane.renderOrder=1),this.occluderMesh=new le(this.plane.geometry,new Ye({depthWrite:!0,stencilWrite:!0,colorWrite:!1,side:Tg})).translateY(-1e-4),this.occluderMesh.renderOrder=-100,this.occluderMesh.layers.set(2),this.shadowsRoot.add(this.occluderMesh),this.blurPlane=new le(e),this.blurPlane.visible=!1,this.shadowGroup.add(this.blurPlane);const n=0,o=1;this.shadowCamera=new _g(-1/2,1/2,1/2,-1/2,n,o),this.shadowCamera.layers.enableAll(),this.shadowCamera.rotation.x=Math.PI/2,this.shadowGroup.add(this.shadowCamera),this.depthMaterial=new BO,this.depthMaterial.userData.darkness={value:this.darkness},this.depthMaterial.blending=UO,this.depthMaterial.blendEquation=NO,this.depthMaterial.onBeforeCompile=r=>{this.depthMaterial&&(r.uniforms.darkness=this.depthMaterial.userData.darkness,r.fragmentShader=`
                uniform float darkness;
                ${r.fragmentShader.replace("gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );","gl_FragColor = vec4( vec3( 1.0 ), ( 1.0 - fragCoordZ ) * darkness * opacity * (gl_FrontFacing ? 1.0 : 0.66) );")}
            `)},this.depthMaterial.depthTest=!1,this.depthMaterial.depthWrite=!1,this.horizontalBlurMaterial=new Xo(Nk),this.horizontalBlurMaterial.depthTest=!1,this.verticalBlurMaterial=new Xo(zk),this.verticalBlurMaterial.depthTest=!1,this.shadowGroup.visible=!1,this.autoFit?this.fitShadows():this.applyMinSize()}onEnable(){this._needsUpdate=!0}onDestroy(){var i,n,o,r,l,c,h,d;Ph._instances.get(this.context)===this&&Ph._instances.delete(this.context),(i=this.renderTarget)==null||i.dispose(),(n=this.renderTargetBlur)==null||n.dispose(),(o=this.depthMaterial)==null||o.dispose(),(r=this.horizontalBlurMaterial)==null||r.dispose(),(l=this.verticalBlurMaterial)==null||l.dispose(),(c=this.blurPlane)==null||c.geometry.dispose(),(h=this.plane)==null||h.geometry.dispose(),(d=this.occluderMesh)==null||d.geometry.dispose()}onBeforeRender(e){if(this.manualUpdate&&!this._needsUpdate)return;if(this._needsUpdate=!1,!this.renderTarget||!this.renderTargetBlur||!this.depthMaterial||!this.shadowCamera||!this.blurPlane||!this.shadowGroup||!this.plane||!this.horizontalBlurMaterial||!this.verticalBlurMaterial){Wd&&console.error("ContactShadows: not initialized yet");return}const i=this.context.scene,n=this.context.renderer,o=n.getRenderTarget();this.shadowGroup.visible=!0,this.occluderMesh&&(this.occluderMesh.visible=!1);const r=this.plane.visible;this.plane.visible=!1,this.gameObject instanceof le&&Rr(this.gameObject,!1);const l=i.background;i.background=null,i.overrideMaterial=this.depthMaterial,this.backfaceShadows?this.depthMaterial.side=Qn:this.depthMaterial.side=Wa;const c=n.getClearAlpha();n.setClearAlpha(0);const h=n.xr.enabled;n.xr.enabled=!1;const d=this.context.scene.matrixWorldAutoUpdate;this.context.scene.matrixWorldAutoUpdate=!1;const u=n.renderLists.get(i,0),f=u.transparent;jS.length=0,u.transparent=jS,wb.length=0;for(const b of u.opaque){if(!b.object.visible)continue;const x=b.material;let v=b.material.colorWrite==!1||x.wireframe===!0||KE(b.object)===!1;!v&&b.material.isLineMaterial&&(v=!0),!v&&b.material.isPointsMaterial&&(v=!0),v&&(wb.push(b.object),b.object["needle:visible"]=b.object.visible,b.object.visible=!1)}n.setRenderTarget(this.renderTarget),n.clear(),n.render(i,this.shadowCamera),u.transparent=f;for(const b of wb)b["needle:visible"]!=null&&(b.visible=b["needle:visible"]);i.overrideMaterial=null;const p=Math.max(this.blur,.05);this.blurShadow(p*2),this.blurShadow(p*.5),this.shadowGroup.visible=!1,this.occluderMesh&&(this.occluderMesh.visible=this.occludeBelowGround),this.plane.visible=r,n.setRenderTarget(o),n.setClearAlpha(c),i.background=l,n.xr.enabled=h,this.context.scene.matrixWorldAutoUpdate=d}blurShadow(e){if(!this.blurPlane||!this.shadowCamera||!this.renderTarget||!this.renderTargetBlur||!this.horizontalBlurMaterial||!this.verticalBlurMaterial)return;this.blurPlane.visible=!0;const i=this.shadowsRoot.worldScale,n=(i.x+i.z)/2,o=i.z/n,r=i.x/n;this.blurPlane.material=this.horizontalBlurMaterial,this.blurPlane.material.uniforms.tDiffuse.value=this.renderTarget.texture,this.horizontalBlurMaterial.uniforms.h.value=e*1/this.textureSize*o;const l=this.context.renderer,c=l.getRenderTarget();l.setRenderTarget(this.renderTargetBlur),l.render(this.blurPlane,this.shadowCamera),this.blurPlane.material=this.verticalBlurMaterial,this.blurPlane.material.uniforms.tDiffuse.value=this.renderTargetBlur.texture,this.verticalBlurMaterial.uniforms.v.value=e*1/this.textureSize*r,l.setRenderTarget(this.renderTarget),l.render(this.blurPlane,this.shadowCamera),this.blurPlane.visible=!1,l.setRenderTarget(c)}applyMinSize(){this.minSize&&this.shadowsRoot.scale.set(Math.max(this.minSize.x||0,this.shadowsRoot.scale.x),Math.max(this.minSize.y||0,this.shadowsRoot.scale.y),Math.max(this.minSize.z||0,this.shadowsRoot.scale.z))}};let qn=Ph;a(qn,"_instances",new Map);ud([g()],qn.prototype,"autoFit",void 0);ud([g()],qn.prototype,"darkness",void 0);ud([g()],qn.prototype,"opacity",void 0);ud([g()],qn.prototype,"blur",void 0);ud([g()],qn.prototype,"occludeBelowGround",void 0);ud([g()],qn.prototype,"backfaceShadows",void 0);const jS=[],wb=new Array,sD=k("logstats");class AT extends W{onEnable(){console.log(this),sD&&this.startCoroutine(this.run(),ge.OnAfterRender)}*run(){for(;this.enabled;){const t=this.context.renderer.info;console.log(t.memory,t.render,t.programs),yield}}}class Qg extends W{constructor(){super(...arguments);a(this,"isUsed",!0);a(this,"usedBy",null)}}class IT extends W{}const FS=k("debugdeletable"),tf=class extends Nn{onEnable(){tf._instances.push(this)}onDisable(){const t=tf._instances.indexOf(this);t>=0&&tf._instances.splice(t,1)}};let Fh=tf;a(Fh,"_instances",[]);class LT extends W{update(){for(const t of Fh._instances){const e=this.gameObject;if(t.isInBox(e)===!0){const n=I.getComponentInParent(this.gameObject,Qg);if(n)FS&&console.warn("DeleteBox: Not deleting object with usage marker",this.guid,n);else{if(FS)try{if(t.box){const o=t.box,r=Nn.testBox;se.DrawWireBox3(o,16711680,5),se.DrawWireBox3(r,255,5),console.log("DeleteBox: Destroying",this.gameObject,{deleteBoxArea:o,deletedObjectArea:r})}else console.log("DeleteBox: Destroying",this.gameObject)}catch{}Fg(this.gameObject,this.context.connection)}}}}}var oD=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},Wm;(function(s){s[s.Never=0]="Never",s[s.Desktop=1]="Desktop",s[s.Mobile=2]="Mobile"})(Wm||(Wm={}));class _v extends W{constructor(){super(...arguments);a(this,"visibleOn")}onEnable(){this.apply()}apply(){this.test()||I.setActive(this.gameObject,!1)}test(){return this.visibleOn<0?!0:Q.isMobileDevice()?(this.visibleOn&Wm.Mobile)!==0:(this.visibleOn&Wm.Desktop)!==0}}oD([g()],_v.prototype,"visibleOn",void 0);var Pc=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Fo=k("debugdrag"),Sb=[];var qi;(function(s){s[s.XZPlane=0]="XZPlane",s[s.Attached=1]="Attached",s[s.HitNormal=2]="HitNormal",s[s.DynamicViewAngle=3]="DynamicViewAngle",s[s.SnapToSurfaces=4]="SnapToSurfaces",s[s.None=5]="None"})(qi||(qi={}));const jn=class extends W{constructor(){super(...arguments);a(this,"dragMode",qi.DynamicViewAngle);a(this,"snapGridResolution",0);a(this,"keepRotation",!0);a(this,"xrDragMode",qi.Attached);a(this,"xrKeepRotation",!1);a(this,"xrDistanceDragFactor",1);a(this,"showGizmo",!1);a(this,"_rigidbody",null);a(this,"_targetObject",null);a(this,"_dragHelper",null);a(this,"_draggingRigidbodies",[]);a(this,"_potentialDragStartEvt",null);a(this,"_dragHandlers",new Map);a(this,"_totalMovement",new R);a(this,"_marker",null);a(this,"_isDragging",!1);a(this,"_didDrag",!1)}static get HasAnySelected(){return this._active>0}static get CurrentlySelected(){Sb.length=0;for(const e of this._instances)e._isDragging&&Sb.push(e);return Sb}get draggedObject(){return this._targetObject}setTargetObject(e){var n,o;this._targetObject=e;for(const r of this._dragHandlers.values())r.setTargetObject(e);const i="_rigidbody-was-kinematic";((n=this._rigidbody)==null?void 0:n[i])===!1&&(this._rigidbody.isKinematic=!1,this._rigidbody[i]=void 0),this._rigidbody=null,e&&(this._rigidbody=I.getComponentInChildren(e,De),((o=this._rigidbody)==null?void 0:o.isKinematic)===!1&&(this._rigidbody.isKinematic=!0,this._rigidbody[i]=!1))}awake(){this._potentialDragStartEvt=null,this._dragHandlers=new Map,this._totalMovement=new R,this._marker=null,this._isDragging=!1,this._didDrag=!1,this._dragHelper=null,this._draggingRigidbodies=[]}start(){this.gameObject.getComponentInParent(ws)||this.gameObject.addComponent(ws)}onEnable(){jn._instances.push(this)}onDisable(){jn._instances=jn._instances.filter(e=>e!==this)}allowEdit(e=null){return this.context.connection.allowEditing}onPointerEnter(e){if(!this.allowEdit(this.gameObject)||e.mode!=="screen"||(e.event.mode==="tracked-pointer"||e.event.mode==="transient-pointer"?this.xrDragMode:this.dragMode)===qi.None)return;const o=I.getComponentInParent(e.object,jn);!o||o!==this||(jn.lastHovered=e.object,this.context.domElement.style.cursor="pointer")}onPointerMove(e){(this._isDragging||this._potentialDragStartEvt!==null)&&e.use()}onPointerExit(e){this.allowEdit(this.gameObject)&&e.mode==="screen"&&jn.lastHovered===e.object&&(this.context.domElement.style.cursor="auto")}onPointerDown(e){if(!(!this.allowEdit(this.gameObject)||e.used||(e.mode==="tracked-pointer"||e.mode==="transient-pointer"?this.xrDragMode:this.dragMode)===qi.None)&&(jn.lastHovered=e.object,e.button===0)){this._dragHandlers.size===0&&(this._didDrag=!1,this._totalMovement.set(0,0,0),this._potentialDragStartEvt=e),this._targetObject||this.setTargetObject(this.gameObject),jn._active+=1;const o=new Cb(this,this._targetObject);if(this._dragHandlers.set(e.event.space,o),o.onDragStart(e),this._dragHandlers.size===2){const r=this._dragHandlers.values(),l=r.next().value,c=r.next().value;if(l instanceof Cb&&c instanceof Cb){const h=new rD(this,this._targetObject,l,c);this._dragHandlers.set(this.gameObject,h),h.onDragStart(e)}else console.error("Attempting to construct a MultiTouchDragHandler with invalid DragPointerHandlers. This is likely a bug.",{a:l,b:c})}e.use()}}onPointerUp(e){if(Fo&&se.DrawLabel(e.point??this.gameObject.worldPosition,"POINTERUP:"+e.pointerId+", "+e.button,.03,3),!this.allowEdit(this.gameObject)||e.button!==0)return;this._potentialDragStartEvt=null;const i=this._dragHandlers.get(e.event.space),n=this._dragHandlers.get(this.gameObject);n&&(n.handlerA===i||n.handlerB===i)&&(this._dragHandlers.delete(this.gameObject),n.onDragEnd(e)),i&&(jn._active>0&&(jn._active-=1),this.setTargetObject(null),i.onDragEnd&&i.onDragEnd(e),this._dragHandlers.delete(e.event.space),this._dragHandlers.size===0&&this.onLastDragEnd(e),e.use())}update(){for(const e of this._dragHandlers.values())e.collectMovementInfo&&e.collectMovementInfo(),e.getTotalMovement&&this._totalMovement.add(e.getTotalMovement());if(this._potentialDragStartEvt){if(!this._didDrag)if(this._totalMovement.length()>3e-4)this._didDrag=!0;else return;const e=this._potentialDragStartEvt;this._potentialDragStartEvt=null,this.onFirstDragStart(e)}for(const e of this._dragHandlers.values())e.onDragUpdate&&e.onDragUpdate(this._dragHandlers.size);this._dragHelper&&this._dragHelper.hasSelected&&this.onAnyDragUpdate()}onFirstDragStart(e){if(!e||!e.object)return;const i=I.getComponentInParent(e.object,jn);if(!i||i!==this&&i._isDragging)return;const n=this._targetObject||this.gameObject;if(!n)return;this._isDragging=!0;const o=I.getComponentInChildren(n,Zo);Fo&&console.log("DRAG START",o,n),o&&(o.fastMode=!0,o==null||o.requestOwnership()),this._marker=I.addComponent(n,Qg),this._draggingRigidbodies.length=0;const r=I.getComponentsInChildren(n,De);r&&this._draggingRigidbodies.push(...r)}onAnyDragUpdate(){if(!this._dragHelper)return;this._dragHelper.showGizmo=this.showGizmo,this._dragHelper.onUpdate(this.context);for(const i of this._draggingRigidbodies)i.wakeUp(),i.resetVelocities(),i.resetForcesAndTorques();const e=this._targetObject||this.gameObject;Qs.markDirty(e)}onLastDragEnd(e){if(!this||!this._isDragging)return;this._isDragging=!1;for(const n of this._draggingRigidbodies)n.setVelocity(n.smoothedVelocity.multiplyScalar(this.context.time.deltaTime));if(this._draggingRigidbodies.length=0,this._targetObject=null,e!=null&&e.object){const n=I.getComponentInChildren(e.object,Zo);n&&(n.fastMode=!1)}if(this._marker&&this._marker.destroy(),!this._dragHelper)return;const i=this._dragHelper.selected;Fo&&console.log("DRAG END",i,i==null?void 0:i.visible),this._dragHelper.setSelected(null,this.context)}};let si=jn;a(si,"_active",0),a(si,"_instances",[]),a(si,"lastHovered");Pc([g()],si.prototype,"dragMode",void 0);Pc([g()],si.prototype,"snapGridResolution",void 0);Pc([g()],si.prototype,"keepRotation",void 0);Pc([g()],si.prototype,"xrDragMode",void 0);Pc([g()],si.prototype,"xrKeepRotation",void 0);Pc([g()],si.prototype,"xrDistanceDragFactor",void 0);Pc([g()],si.prototype,"showGizmo",void 0);class rD{constructor(t,e,i,n){a(this,"handlerA");a(this,"handlerB");a(this,"context");a(this,"settings");a(this,"gameObject");a(this,"_handlerAAttachmentPoint",new R);a(this,"_handlerBAttachmentPoint",new R);a(this,"_followObject");a(this,"_manipulatorObject");a(this,"_deviceMode");a(this,"_followObjectStartWorldQuaternion",new re);a(this,"_manipulatorPosOffset",new R);a(this,"_manipulatorRotOffset",new re);a(this,"_manipulatorScaleOffset",new R);a(this,"_tempVec1",new R);a(this,"_tempVec2",new R);a(this,"_tempVec3",new R);a(this,"tempLookMatrix",new xe);a(this,"_initialScale",new R);a(this,"_initialDistance",0);var r,l;this.context=t.context,this.settings=t,this.gameObject=e,this.handlerA=i,this.handlerB=n,this._followObject=new z,this._manipulatorObject=new z,this.context.scene.add(this._manipulatorObject);const o=(l=(r=fe.active)==null?void 0:r.rig)==null?void 0:l.gameObject;if(!this.handlerA||!this.handlerB||!this.handlerA.hitPointInLocalSpace||!this.handlerB.hitPointInLocalSpace){console.error("Invalid: MultiTouchDragHandler needs two valid DragPointerHandlers with hitPointInLocalSpace set.");return}if(this._tempVec1.copy(this.handlerA.hitPointInLocalSpace),this._tempVec2.copy(this.handlerB.hitPointInLocalSpace),this.gameObject.localToWorld(this._tempVec1),this.gameObject.localToWorld(this._tempVec2),o&&(o.worldToLocal(this._tempVec1),o.worldToLocal(this._tempVec2)),this._initialDistance=this._tempVec1.distanceTo(this._tempVec2),this._initialDistance<.02?(Fo&&console.log("Finding alternative drag attachment points since initial distance is too low: "+this._initialDistance.toFixed(2)),this.handlerA.followObject.parent.getWorldPosition(this._tempVec1),this.handlerB.followObject.parent.getWorldPosition(this._tempVec2),this._handlerAAttachmentPoint.copy(this._tempVec1),this._handlerBAttachmentPoint.copy(this._tempVec2),this.gameObject.worldToLocal(this._handlerAAttachmentPoint),this.gameObject.worldToLocal(this._handlerBAttachmentPoint),this._initialDistance=this._tempVec1.distanceTo(this._tempVec2),this._initialDistance<.001&&(console.warn("Not supported right now ‚Äì controller drag points for multitouch are too close!"),this._initialDistance=1)):(this._handlerAAttachmentPoint.copy(this.handlerA.hitPointInLocalSpace),this._handlerBAttachmentPoint.copy(this.handlerB.hitPointInLocalSpace)),this._tempVec3.lerpVectors(this._tempVec1,this._tempVec2,.5),this._initialScale.copy(e.scale),Fo){this._followObject.add(new Wn(2)),this._manipulatorObject.add(new Wn(5));const c=h=>`${h.x.toFixed(2)}, ${h.y.toFixed(2)}, ${h.z.toFixed(2)}`;se.DrawLine(this._tempVec1,this._tempVec2,65535,0,!1),se.DrawLabel(this._tempVec3,"A:B "+this._initialDistance.toFixed(2)+`
`+c(this._tempVec1)+`
`+c(this._tempVec2),.03,5)}}onDragStart(t){this.gameObject.add(this._followObject),this._followObject.matrixAutoUpdate=!1,this._followObject.matrix.identity(),this._deviceMode=t.mode,this._followObjectStartWorldQuaternion.copy(this._followObject.worldQuaternion),this.alignManipulator(),this._manipulatorObject.attach(this._followObject),this._manipulatorPosOffset.copy(this._followObject.position),this._manipulatorRotOffset.copy(this._followObject.quaternion),this._manipulatorScaleOffset.copy(this._followObject.scale)}onDragEnd(t){if(!this.handlerA||!this.handlerB){console.error("onDragEnd called on MultiTouchDragHandler without valid handlers. This is likely a bug.");return}this.handlerA.recenter(),this.handlerB.recenter(),this._manipulatorObject.removeFromParent(),this._followObject.removeFromParent(),this._manipulatorObject.destroy(),this._followObject.destroy()}alignManipulator(){if(!this.handlerA||!this.handlerB){console.error("alignManipulator called on MultiTouchDragHandler without valid handlers. This is likely a bug.",this);return}if(!this.handlerA.followObject||!this.handlerB.followObject){console.error("alignManipulator called on MultiTouchDragHandler without valid follow objects. This is likely a bug.",this.handlerA,this.handlerB);return}this._tempVec1.copy(this._handlerAAttachmentPoint),this._tempVec2.copy(this._handlerBAttachmentPoint),this.handlerA.followObject.localToWorld(this._tempVec1),this.handlerB.followObject.localToWorld(this._tempVec2),this._tempVec3.lerpVectors(this._tempVec1,this._tempVec2,.5),this._manipulatorObject.position.copy(this._tempVec3);const t=this.context.mainCamera;this.tempLookMatrix.lookAt(this._tempVec3,this._tempVec2,t.worldUp),this._manipulatorObject.quaternion.setFromRotationMatrix(this.tempLookMatrix);const e=this._tempVec1.distanceTo(this._tempVec2);this._manipulatorObject.scale.copy(this._initialScale).multiplyScalar(e/this._initialDistance),this._manipulatorObject.updateMatrix(),this._manipulatorObject.updateMatrixWorld(!0),Fo&&(se.DrawLabel(this._tempVec3.clone().add(new R(0,.2,0)),"A:B "+e.toFixed(2),.03),se.DrawLine(this._tempVec1,this._tempVec2,65280,0,!1))}onDragUpdate(){this.alignManipulator();const t=30,e=1;this._followObject.position.copy(this._manipulatorPosOffset),this._followObject.quaternion.copy(this._manipulatorRotOffset),this._followObject.scale.copy(this._manipulatorScaleOffset);const i=this.gameObject,n=this._followObject;if(!i){console.error("MultiTouchDragHandler has no dragged object. This is likely a bug.");return}n.updateMatrix(),n.updateMatrixWorld(!0);const r=this._deviceMode==="tracked-pointer"||this._deviceMode==="transient-pointer"?this.settings.xrKeepRotation:this.settings.keepRotation;if(this.settings.snapGridResolution>0){const u=this._followObject.worldPosition,f=this.settings.snapGridResolution;u.x=Math.round(u.x/f)*f,u.y=Math.round(u.y/f)*f,u.z=Math.round(u.z/f)*f,this._followObject.worldPosition=u,this._followObject.updateMatrix()}r&&(this._followObject.worldQuaternion=this._followObjectStartWorldQuaternion,this._followObject.updateMatrix());const l=ee.clamp01(this.context.time.deltaTime*t*e),c=i.worldPosition;c.lerp(n.worldPosition,l),i.worldPosition=c;const h=i.worldQuaternion;h.slerp(n.worldQuaternion,l),i.worldQuaternion=h;const d=i.worldScale;d.lerp(n.worldScale,l),i.worldScale=d}setTargetObject(t){this.gameObject=t}}class Cb{constructor(t,e){a(this,"context");a(this,"gameObject");a(this,"settings");a(this,"_lastRig");a(this,"_followObject");a(this,"_totalMovement",new R);a(this,"_totalMovementAlongRayDirection",0);a(this,"_grabStartDistance",0);a(this,"_deviceMode");a(this,"_followObjectStartPosition",new R);a(this,"_followObjectStartQuaternion",new re);a(this,"_followObjectStartWorldQuaternion",new re);a(this,"_lastDragPosRigSpace");a(this,"_tempVec",new R);a(this,"_tempMat",new xe);a(this,"_hitPointInLocalSpace",new R);a(this,"_hitNormalInLocalSpace",new R);a(this,"_bottomCenter",new R);a(this,"_backCenter",new R);a(this,"_backBottomCenter",new R);a(this,"_bounds",new bs);a(this,"_dragPlane",new lc(new R(0,1,0)));a(this,"_draggedOverObject",null);a(this,"_draggedOverObjectLastSetUp",null);a(this,"_draggedOverObjectLastNormal",new R);a(this,"_draggedOverObjectDuration",0);a(this,"_hasLastSurfaceHitPoint",!1);a(this,"_lastSurfaceHitPoint",new R);this.settings=t,this.context=t.context,this.gameObject=e,this._followObject=new z}getTotalMovement(){return this._totalMovement}get followObject(){return this._followObject}get hitPointInLocalSpace(){return this._hitPointInLocalSpace}setTargetObject(t){this.gameObject=t}recenter(){var o,r;if(!this._followObject.parent){console.warn("Error: space follow object doesn't have parent but recenter() is called. This is likely a bug");return}if(!this.gameObject){console.warn("Error: space follow object doesn't have a gameObject");return}const t=this._followObject.parent;this.gameObject.add(this._followObject),this._followObject.matrixAutoUpdate=!1,this._followObject.position.set(0,0,0),this._followObject.quaternion.set(0,0,0,1),this._followObject.scale.set(1,1,1),this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0),t.attach(this._followObject),this._followObjectStartPosition.copy(this._followObject.position),this._followObjectStartQuaternion.copy(this._followObject.quaternion),this._followObjectStartWorldQuaternion.copy(this._followObject.worldQuaternion),this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0);const e=this._hitPointInLocalSpace.clone();this.gameObject.localToWorld(e),this._grabStartDistance=e.distanceTo(t.worldPosition);const i=(r=(o=fe.active)==null?void 0:o.rig)==null?void 0:r.gameObject,n=(i==null?void 0:i.worldScale.x)||1;this._grabStartDistance/=n,this._totalMovementAlongRayDirection=0,this._lastDragPosRigSpace=void 0,Fo&&(se.DrawLine(e,t.worldPosition,65280,.5,!1),se.DrawLabel(t.worldPosition.add(new R(0,.1,0)),this._grabStartDistance.toFixed(2),.03,.5))}onDragStart(t){if(!this.gameObject){console.warn("Error: space follow object doesn't have a gameObject");return}if(t.event.space.add(this._followObject),this._lastDragPosRigSpace=void 0,t.point&&t.normal)this._hitPointInLocalSpace.copy(t.point),this.gameObject.worldToLocal(this._hitPointInLocalSpace),this._hitNormalInLocalSpace.copy(t.normal);else if(t){const x=t.event.space,v=x.worldPosition;this.gameObject.worldToLocal(v),this._hitPointInLocalSpace.copy(v);const S=x.worldUp;this._tempMat.copy(this.gameObject.matrixWorld).invert(),S.transformDirection(this._tempMat),this._hitNormalInLocalSpace.copy(S)}this.recenter(),this._totalMovement.set(0,0,0),this._deviceMode=t.mode;const i=this._followObject.parent.worldForward,o=this._deviceMode==="tracked-pointer"||this._deviceMode==="transient-pointer"?this.settings.xrDragMode:this.settings.dragMode,r=this._hitPointInLocalSpace.clone();switch(this.gameObject.localToWorld(r),o){case qi.XZPlane:const x=new R(0,1,0);this.gameObject.parent&&x.transformDirection(this.gameObject.parent.matrixWorld.clone().invert()),this._dragPlane.setFromNormalAndCoplanarPoint(x,r);break;case qi.HitNormal:const v=this._hitNormalInLocalSpace.clone();v.transformDirection(this.gameObject.matrixWorld),this._dragPlane.setFromNormalAndCoplanarPoint(v,r);break;case qi.Attached:this._dragPlane.setFromNormalAndCoplanarPoint(i,r);break;case qi.DynamicViewAngle:this.setPlaneViewAligned(r,!0);break;case qi.SnapToSurfaces:this.setPlaneViewAligned(r,!1);break;case qi.None:break}const l=this.gameObject.parent,c=this.gameObject.position.clone(),h=this.gameObject.quaternion.clone(),d=this.gameObject.scale.clone(),u=this.gameObject.matrixWorld.clone();l&&l.remove(this.gameObject),this.gameObject.position.set(0,0,0),this.gameObject.quaternion.set(0,0,0,1),this.gameObject.scale.set(1,1,1);const f=On([this.gameObject]);f.expandByPoint(this.gameObject.worldPosition);const p=new R;f.getCenter(p);const b=new R;f.getSize(b),this._bottomCenter.copy(p.clone().add(new R(0,-b.y/2,0))),this._backCenter.copy(p.clone().add(new R(0,0,b.z/2))),this._backBottomCenter.copy(p.clone().add(new R(0,-b.y/2,b.z/2))),this._bounds.copy(f),l&&l.add(this.gameObject),this.gameObject.position.copy(c),this.gameObject.quaternion.copy(h),this.gameObject.scale.copy(d),this.gameObject.matrixWorld.copy(u),this._draggedOverObject=null,this._draggedOverObjectLastSetUp=null,this._draggedOverObjectLastNormal.set(0,1,0),this._draggedOverObjectDuration=0}collectMovementInfo(){var o,r;if(!this._followObject.parent)return;const t=this._followObject.parent;this._followObject.updateMatrix();const e=t.worldPosition,i=(r=(o=fe.active)==null?void 0:o.rig)==null?void 0:r.gameObject;i&&i.worldToLocal(e),(this._lastDragPosRigSpace===void 0||i!=this._lastRig)&&(this._lastDragPosRigSpace=e.clone(),this._lastRig=i),this._tempVec.copy(e).sub(this._lastDragPosRigSpace);const n=t.worldForward;if(i&&(this._tempMat.copy(i.matrixWorld).invert(),n.transformDirection(this._tempMat)),this._totalMovementAlongRayDirection+=n.dot(this._tempVec),this._tempVec.x=Math.abs(this._tempVec.x),this._tempVec.y=Math.abs(this._tempVec.y),this._tempVec.z=Math.abs(this._tempVec.z),this._totalMovement.add(this._tempVec),this._lastDragPosRigSpace.copy(e),Fo){let l=e;i&&(l=l.clone(),l.transformDirection(i.matrixWorld)),se.DrawRay(l,n,255)}}onDragUpdate(t){if(t>1)return;const e=this.gameObject;if(!e||!this._followObject){console.warn("Warning: DragPointerHandler doesn't have a dragged object. This is likely a bug.");return}const i=this._followObject.parent;if(!i){console.warn("Warning: DragPointerHandler doesn't have a drag source. This is likely a bug.");return}this._followObject.updateMatrix();const n=i.worldPosition,o=i.worldForward,r=this._deviceMode==="tracked-pointer"||this._deviceMode==="transient-pointer",l=r?this.settings.xrKeepRotation:this.settings.keepRotation,c=r?this.settings.xrDragMode:this.settings.dragMode;if(c===qi.None)return;const h=10;l&&(this._followObject.worldQuaternion=this._followObjectStartWorldQuaternion),this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0);let d=1,u=2;if(r&&this._grabStartDistance>.5){const C=1+this._totalMovementAlongRayDirection*(2*this.settings.xrDistanceDragFactor);d=Math.max(0,C),d=d*d*d}else this._grabStartDistance<=.5&&(u=3);this._followObject.position.copy(this._followObjectStartPosition),l||this._followObject.quaternion.copy(this._followObjectStartQuaternion),this._followObject.position.multiplyScalar(d),this._followObject.updateMatrix();const f=this._hasLastSurfaceHitPoint;this._hasLastSurfaceHitPoint=!1;const p=new zr(n,o);if(c==qi.SnapToSurfaces){const C=this.context.physics.raycastFromRay(p,{testObject:P=>P!==this.followObject&&P!==i&&P!==e});if(C.length>0){const P=C[0];if(this._draggedOverObject===P.object?this._draggedOverObjectDuration+=this.context.time.deltaTime:(this._draggedOverObject=P.object,this._draggedOverObjectDuration=0),P.face){this._hasLastSurfaceHitPoint=!0,this._lastSurfaceHitPoint.copy(P.point);const E=.15,D=this._draggedOverObjectDuration>=E,M=.001,A=this._totalMovement.length()>=M,G=te(P.normal||P.face.normal).applyQuaternion(P.object.worldQuaternion);if((D||A)&&(this._draggedOverObjectLastSetUp!==this._draggedOverObject||this._draggedOverObjectLastNormal.dot(G)<.999999||this.context.time.frame%60===0)){this._draggedOverObjectLastSetUp=this._draggedOverObject,this._draggedOverObjectLastNormal.copy(P.face.normal);const V=te(),U=te();this._bounds.getCenter(V),this._bounds.getSize(U),V.sub(U.multiplyScalar(.5).multiply(G)),this._hitPointInLocalSpace.copy(V),this._hitNormalInLocalSpace.copy(P.face.normal),this._bounds.getCenter(V),this._bounds.getSize(U),V.add(U.multiplyScalar(.5).multiply(P.face.normal));const $=te(this._hitPointInLocalSpace).add(V);this._followObject.localToWorld($);const Y=P.point;this._dragPlane.setFromNormalAndCoplanarPoint(G,Y)}else if(!(D||A))return}}else f&&this.gameObject&&this.setPlaneViewAligned(this.gameObject.worldPosition,!1)}if(c!==qi.Attached&&p.intersectPlane(this._dragPlane,this._tempVec)){this._followObject.worldPosition=this._tempVec,this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0);const C=te(this._hitPointInLocalSpace);this._followObject.localToWorld(C),Fo&&se.DrawLine(C,this._tempVec,65535,0,!1),this._followObject.worldPosition=this._tempVec.multiplyScalar(2).sub(C),this._followObject.updateMatrix(),this._followObject.updateMatrix()}if(this.settings.snapGridResolution>0){const C=this._followObject.worldPosition,P=this.settings.snapGridResolution;C.x=Math.round(C.x/P)*P,C.y=Math.round(C.y/P)*P,C.z=Math.round(C.z/P)*P,this._followObject.worldPosition=C,this._followObject.updateMatrix()}l&&(this._followObject.worldQuaternion=this._followObjectStartWorldQuaternion,this._followObject.updateMatrix());const b=ee.clamp01(this.context.time.deltaTime*h*u),x=ee.clamp01(this.context.time.deltaTime*h*.5*u),v=e.worldPosition;v.lerp(this._followObject.worldPosition,b),e.worldPosition=v;const S=e.worldQuaternion;if(S.slerp(this._followObject.worldQuaternion,x),e.worldQuaternion=S,Fo){const C=this._hitPointInLocalSpace.clone();e.localToWorld(C),se.DrawSphere(C,.02,16711680);const P=this._hitNormalInLocalSpace.clone();P.applyQuaternion(S),se.DrawRay(C,P,16711680),se.DrawLabel(v.add(new R(0,.25,0)),`Distance: ${this._totalMovement.length().toFixed(2)}

                Along Ray: ${this._totalMovementAlongRayDirection.toFixed(2)}

                Session: ${!!fe.active}

                Device: ${this._deviceMode}

                `,.03);const E=this._bottomCenter.clone(),D=this._backCenter.clone(),M=this._backBottomCenter.clone();e.localToWorld(E),e.localToWorld(D),e.localToWorld(M),se.DrawSphere(E,.01,65280,0,!1),se.DrawSphere(D,.01,255,0,!1),se.DrawSphere(M,.01,16711935,0,!1),se.DrawLine(E,M,65535,0,!1),se.DrawLine(M,D,65535,0,!1)}}onDragEnd(t){console.assert(this._followObject.parent===t.event.space,"Drag end: _followObject is not parented to the space object"),this._followObject.removeFromParent(),this._followObject.destroy(),this._lastDragPosRigSpace=void 0}setPlaneViewAligned(t,e){if(!this._followObject.parent)return!1;const i=this._followObject.parent.worldForward,n=te(0,1,0),o=i,r=n.angleTo(o),l=.5;return e&&(r>Math.PI/2+l||r<Math.PI/2-l)?this._dragPlane.setFromNormalAndCoplanarPoint(n,t):this._dragPlane.setFromNormalAndCoplanarPoint(i,t),!0}}const ax=class{constructor(t){a(this,"showGizmo",!0);a(this,"useViewAngle",!0);a(this,"_selected",null);a(this,"_context",null);a(this,"_camera");a(this,"_cameraPlane",new lc);a(this,"_hasGroundPlane",!1);a(this,"_groundPlane",new lc);a(this,"_groundOffset",new R);a(this,"_groundOffsetFactor",0);a(this,"_groundDistance",0);a(this,"_groundPlanePoint",new R);a(this,"_raycaster",new xg);a(this,"_cameraPlaneOffset",new R);a(this,"_intersection",new R);a(this,"_worldPosition",new R);a(this,"_inverseMatrix",new xe);a(this,"_rbs",[]);a(this,"_groundLine");a(this,"_groundMarker");a(this,"_groundOffsetVector",new R(0,1,0));a(this,"_requireUpdateGroundPlane",!0);a(this,"_didDragOnGroundPlaneLastFrame",!1);this._camera=t;const e=new Hh(ax.geometry),i=e.material;i.color=new Se(.4,.4,.4),e.layers.set(2),e.name="line",e.scale.y=1,this._groundLine=e;const n=new vg(.5,22,22),o=new Ye({color:i.color}),r=new le(n,o);r.visible=!1,r.layers.set(2),this._groundMarker=r}get hasSelected(){return this._selected!==null&&this._selected!==void 0}get selected(){return this._selected}setSelected(t,e){if(this._selected&&e)for(const i of this._rbs)i.wakeUp(),i.setVelocity(0,0,0);if(this._selected&&Ba.Remove(e,this._selected),this._selected=t,this._context=e,this._rbs.length=0,t?(e.scene.add(this._groundLine),e.scene.add(this._groundMarker)):(this._groundLine.removeFromParent(),this._groundMarker.removeFromParent()),this._selected){if(!e){console.error("DragHelper: no context");return}Ba.Add(e,this._selected,null),this._groundOffsetFactor=0,this._hasGroundPlane=!0,this._groundOffset.set(0,0,0),this._requireUpdateGroundPlane=!0,this.onUpdateScreenSpacePlane()}}onUpdate(t){this._selected}onUpdateWorldPosition(t,e,i){if(this._selected){if(i){const n=ve(this._selected);n.y=t.y,t=n}if(Oi(this._selected,t),Oi(this._groundLine,t),this._hasGroundPlane?this._groundLine.scale.y=this._groundDistance:this._groundLine.scale.y=1e3,this._groundLine.visible=this.showGizmo,this._groundMarker.visible=e!==null&&this.showGizmo,e){const n=ve(this._camera).distanceTo(e)*.01;this._groundMarker.scale.set(n,n,n),Oi(this._groundMarker,e)}}}onUpdateScreenSpacePlane(){if(!this._selected||!this._context)return;const t=this._context.input.getPointerPositionRC(0);t&&(this._raycaster.setFromCamera(t,this._camera),this._cameraPlane.setFromNormalAndCoplanarPoint(this._camera.getWorldDirection(this._cameraPlane.normal),this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld)),this._raycaster.ray.intersectPlane(this._cameraPlane,this._intersection)&&this._selected.parent&&(this._inverseMatrix.copy(this._selected.parent.matrixWorld).invert(),this._cameraPlaneOffset.copy(this._intersection).sub(this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld))))}onUpdateGroundPlane(){if(!this._selected||!this._context)return;const t=ve(this._selected),e=new zr(te(0,.1,0).add(t),te(0,-1,0)),i=new Ya;i.testObject=o=>o!==this._selected;const n=this._context.physics.raycastFromRay(e,i);for(let o=0;o<n.length;o++){const r=n[o];if(!r.face||this.contains(this._selected,r.object))continue;const l=te(0,1,0);this._groundPlane.setFromNormalAndCoplanarPoint(l,r.point);break}this._hasGroundPlane=!0,this._groundPlane.setFromNormalAndCoplanarPoint(e.direction.multiplyScalar(-1),e.origin),this._raycaster.ray.intersectPlane(this._groundPlane,this._intersection),this._groundDistance=this._intersection.distanceTo(t),this._groundOffset.copy(this._intersection).sub(t)}contains(t,e){if(t===e)return!0;if(t.children){for(const i of t.children)if(this.contains(i,e))return!0}return!1}};let Pb=ax;a(Pb,"geometry",new Gs().setFromPoints([new R(0,0,0),new R(0,-1,0)]));var BS;(function(s){s.File_Spawned="file-spawned"})(BS||(BS={}));class V4{constructor(t,e,i,n,o,r,l,c,h){a(this,"guid");a(this,"file_name");a(this,"file_hash");a(this,"file_size");a(this,"position");a(this,"scale");a(this,"seed");a(this,"sender");a(this,"downloadUrl");a(this,"parentGuid");a(this,"boundsSize");this.seed=e,this.guid=i,this.file_name=n,this.file_hash=o,this.file_size=r,this.position=l,this.scale=c,this.sender=t,this.downloadUrl=h}}var Dl;(function(s){const t=new Map;function e(n){var u;t.has(n.guid)&&i(n.guid);const o=new z;t.set(n.guid,o);const r=new z;r.position.y=-.5,o.add(r);const l=new le(new Vh(1,1,1,1,1,1),new Ye({color:14540253,wireframe:!0,transparent:!0,opacity:.3}));l.position.y=.5,r.add(l);const c=new z;r.add(c);const h=new le(new Vh(1,1,1,1,1,1),new Ye({color:12307660,transparent:!0,opacity:.4}));h.position.y=.5,c.scale.y=.01,c.add(h);const d=new le(new to(1,1,1,1),new Ye({color:34,transparent:!0,opacity:.05,depthTest:!1}));return d.rotateX(-Math.PI/2),d.position.y=.51,h.add(d),n.parent.add(o),o.rotateY(Math.PI/2),n.position&&((u=o.position)==null||u.copy(n.position)),n.size&&(o.worldScale=new R().copy(n.size)),o.position.y=o.scale.y/2,{object:o,onProgress:f=>{c instanceof z&&c.scale.set(1,f,1)}}}s.addPreview=e;function i(n){const o=t.get(n);o&&(t.delete(n),o.removeFromParent())}s.removePreview=i})(Dl||(Dl={}));const uh=[],hm=[];var US;(function(s){function t(i,n){const o={name:n==null?void 0:n.name,priority:(n==null?void 0:n.priority)??0,callback:i};return uh.push(o),uh.sort((r,l)=>r.priority===l.priority?0:r.priority>l.priority?-1:1),()=>{const r=uh.indexOf(o);r>=0&&uh.splice(r,1)}}s.onCreateCustomModelLoader=t;function e(i){return hm.push(i),()=>{const n=hm.indexOf(i);n>=0&&hm.splice(n,1)}}s.onDetermineModelMimetype=e})(US||(US={}));const Eu=k("debugfileformat");function aD(s){switch((s.split(".").pop()||s).toUpperCase()){case"GLTF":return"model/gltf+json";case"VRM":return"model/vrm";case"GLB":return"model/gltf-binary";case"FBX":return"model/fbx";case"USD":return"model/vnd.usd+zip";case"USDA":return"model/vnd.usda+zip";case"USDZ":return"model/vnd.usdz+zip";case"OBJ":return"model/obj";default:return null}}async function lD(s,t){var o;const{useExtension:e=!0}=t;if(e){const r=s,l=new URL(r,globalThis.location.href);let c=null;const h=l.searchParams.get("filetype");switch(h&&(c=h.toUpperCase()),c!=null&&c.length||(c=(o=l.pathname.split(".").pop())==null?void 0:o.toUpperCase()),Eu&&console.warn(`[Needle Engine] Try to use file extension to determine type: '${c}'`),c){case"GLTF":return"model/gltf+json";case"VRM":return"model/vrm";case"GLB":return"model/gltf-binary";case"FBX":return"model/fbx";case"USD":return"model/vnd.usd+zip";case"USDA":return"model/vnd.usda+zip";case"USDZ":return"model/vnd.usdz+zip";case"OBJ":return"model/obj"}}const i=s;if(!s.startsWith("blob:")){const r=new URL(s,globalThis.location.href);r.searchParams.append("range","true"),s=r.toString()}const n=await fetch(s,{method:"GET",headers:{range:"bytes=0-32"}}).catch(r=>null);if(n!=null&&n.ok){const r=await n.arrayBuffer(),l=cD(i,r,n);return Eu&&console.log("[Needle Engine] Determined file type from header: "+l),l}return"unknown"}function cD(s,t,e){if(t.byteLength<4)return"unknown";const i=new Uint8Array(t);Eu&&console.warn(`[Needle Engine] Trying to determine file type from binary data
`,'"'+new TextDecoder().decode(t)+`"
`,i);const n=new TextDecoder().decode(t).replace(/\s/g,"");if(n[0]==="{"&&n[1]==='"')return console.debug("GLTF detected"),"model/gltf+json";if(i[0]==103&&i[1]==108&&i[2]==84&&i[3]==70&&(i[4]==10||i[4]===2))return console.debug("GLTF .bin detected"),"model/gltf+json";if(i[0]==103&&i[1]==108&&i[2]==84&&i[3]==70&&i[4]==98)return console.debug("GLB detected"),"model/gltf-binary";if(i[0]==80&&i[1]==75&&i[2]==3&&i[3]==4)return console.debug("USDZ detected"),"model/vnd.usdz+zip";if(i[0]==80&&i[1]==88&&i[2]==82&&i[3]==45&&i[4]==85&&i[5]==83&&i[6]==68&&i[7]==67)return console.debug("Binary USD detected"),"model/vnd.usd";if(i[0]==35&&i[1]==117&&i[2]==115&&i[3]==100&&i[4]==97)return console.debug("ASCII USD detected"),"model/vnd.usda";if(i[0]==75&&i[1]==97&&i[2]==121&&i[3]==100&&i[4]==97&&i[5]==114&&i[6]==97&&i[7]==32)return console.debug("Binary FBX detected"),"model/fbx";if(i[0]==59&&i[1]==32&&i[2]==70&&i[3]==66&&i[4]==88&&i[5]==32)return console.debug("ASCII FBX detected"),"model/fbx";if(i[0]==35&&i[1]==32&&i[2]==66&&i[3]==108&&i[4]==101&&i[5]==110&&i[6]==100&&i[7]==101&&i[8]==114&&i[9]==32)return console.debug("OBJ detected"),"model/obj";if(i[0]==35&&i[1]==32&&i[2]==65&&i[3]==108&&i[4]==105&&i[5]==97&&i[6]==115&&i[7]==32&&i[8]==79&&i[9]==66&&i[10]==74)return console.debug("OBJ detected"),"model/obj";if(e.headers.has("content-type")){const o=e.headers.get("content-type");if(o!=null&&o.startsWith("image/"))return console.debug("Image detected, not a model file"),"unsupported";switch(console.debug("Content-Type: "+o),o){case"model/gltf+json":case"model/gltf-binary":case"model/vrm":case"model/vnd.usdz+zip":case"model/vnd.usd+zip":case"model/vnd.usd":case"model/vnd.usda+zip":case"model/vnd.usda":case"model/vnd.usdc":case"model/fbx":case"model/vnd.autodesk.fbx":case"model/obj":return o}}if(i[0]==118&&i[1]==32||i[0]==102&&i[1]==32)return console.debug("OBJ detected (the file has no header and starts with vertex or face)"),"obj";if(i[0]==35&&i[1]==32&&i[2]==70&&i[3]==105&&i[4]==108&&i[5]==101&&i[6]==32&&i[7]==101&&i[8]==120&&i[9]==112&&i[10]==111&&i[11]==114&&i[12]==116&&i[13]==101&&i[14]==100&&i[15]==32&&i[16]==98&&i[17]==121&&i[18]==32&&i[19]==90&&i[20]==66&&i[21]==114&&i[22]==117&&i[23]==115&&i[24]==104)return console.debug("OBJ detected (exported by ZBrush)"),"obj";if(i[0]==109&&i[1]==116&&i[2]==108&&i[3]==108&&i[4]==105&&i[5]==98)return console.debug("OBJ detected (mtllib)"),"obj";for(const o of hm){const r=o({url:s,response:e,contentType:e.headers.get("content-type"),bytes:i});if(r)return Eu&&console.debug(`Mimetype callback returned: ${r}`),r}if(X()||Eu){const o=new TextDecoder().decode(t.slice(0,Math.min(t.byteLength,32)));console.warn(`Could not determine file type.

Consider registering a custom loader via the 'onCreateCustomModelLoader' callback: 'NeedleEngineModelLoader.onCreateCustomModelLoader(args => { })'

Content-Type: "${e.headers.get("content-type")}
"Text: "${o}"
Binary:`,i)}else console.debug("Could not determine file type from binary data");return"unknown"}const Tb=k("debugstencil");function hD(s,t){return(s&1<<t.layer)!=0}const dD=Symbol("stencils"),Nl=class{constructor(t,e){a(this,"parser");a(this,"source");this.parser=t,this.source=e}get name(){return"NEEDLE_render_objects"}static applyStencil(t){if(!t)return;const e=t.sourceId;if(Tb&&console.log(e,Nl.stencils),!e)return;const i=Nl.stencils[e];if(i)for(let n=i.length-1;n>=0;n--){const o=i[n];if(hD(o.layer,t)){Tb&&console.log(o),setTimeout(()=>{_s()&&sv(t.gameObject)&&(qe("Stencil not supported on instanced objects"),console.warn("Stencil not supported on instanced objects",t))},500);for(let r=0;r<t.sharedMaterials.length;r++){let l=t.sharedMaterials[r];l&&(l=l.clone(),l[dD]=!0,l.stencilWrite=!0,l.stencilWriteMask=255,l.stencilFuncMask=255,l.stencilRef=o.value,l.stencilFunc=o.compareFunc,l.stencilZPass=o.passOp,l.stencilFail=o.failOp,l.stencilZFail=o.zFailOp,t.sharedMaterials[r]=l)}t.gameObject.renderOrder=o.event*1e3+o.index*50;break}}}afterRoot(t){const e=this.parser.json.extensions;if(e){const i=e[fD];if(i){Tb&&console.log(i);const n=i.stencil;if(n&&Array.isArray(n))for(const o of n){const r={...o};r.compareFunc=uD(r.compareFunc),r.passOp=Rb(r.passOp),r.failOp=Rb(r.failOp),r.zFailOp=Rb(r.zFailOp),Nl.stencils[this.source]||(Nl.stencils[this.source]=[]),Nl.stencils[this.source].push(r)}}}return null}};let Mu=Nl;a(Mu,"stencils",{});var yo;(function(s){s[s.Keep=0]="Keep",s[s.Zero=1]="Zero",s[s.Replace=2]="Replace",s[s.IncrementSaturate=3]="IncrementSaturate",s[s.DecrementSaturate=4]="DecrementSaturate",s[s.Invert=5]="Invert",s[s.IncrementWrap=6]="IncrementWrap",s[s.DecrementWrap=7]="DecrementWrap"})(yo||(yo={}));var bo;(function(s){s[s.Disabled=0]="Disabled",s[s.Never=1]="Never",s[s.Less=2]="Less",s[s.Equal=3]="Equal",s[s.LessEqual=4]="LessEqual",s[s.Greater=5]="Greater",s[s.NotEqual=6]="NotEqual",s[s.GreaterEqual=7]="GreaterEqual",s[s.Always=8]="Always"})(bo||(bo={}));function Rb(s){switch(s){case yo.Keep:return XO;case yo.Zero:return qO;case yo.Replace:return GO;case yo.IncrementSaturate:return HO;case yo.DecrementSaturate:return WO;case yo.IncrementWrap:return VO;case yo.DecrementWrap:return $O;case yo.Invert:return zO}return 0}function uD(s){switch(s){case bo.Never:return Fx;case bo.Less:return tk;case bo.Equal:return ek;case bo.LessEqual:return JO;case bo.Greater:return ZO;case bo.NotEqual:return KO;case bo.GreaterEqual:return YO;case bo.Always:return QO}return Fx}const fD="NEEDLE_render_objects";var DT=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const qc=k("debugreflectionprobe"),NS=k("noreflectionprobe"),Ob=Symbol("reflectionProbeKey"),zS=Symbol("original material"),Po=class extends W{constructor(){var e;super();a(this,"_texture");a(this,"center");a(this,"size");a(this,"_boxHelper");Po._probes.has(this.context)||Po._probes.set(this.context,[]),(e=Po._probes.get(this.context))==null||e.push(this)}static isUsingReflectionProbe(e){var i;return!!(e[Ob]||(i=e[zS])!=null&&i[Ob])}static get(e,i,n,o){if(!e||e.isObject3D!==!0||NS)return null;const r=Po._probes.get(i);if(r){for(const l of r)if(l.__didAwake||l.__internalAwake(),l.activeAndEnabled){if(o){if(l.gameObject===o)return l}else if(l.isInBox(e))return qc&&console.log("Found reflection probe",e.name,l.name),l}}return qc&&console.debug("Did not find reflection probe",e.name,n,e),null}set texture(e){this._texture!==e&&(this._texture=e,qc&&console.debug("[ReflectionProbe] Set reflection probe texture "+((e==null?void 0:e.name)||"(removed)")),e&&(e instanceof KC||e.mapping!==Vo&&(e.mapping=Vo),e.colorSpace=$r,e.needsUpdate=!0))}get texture(){return this._texture}isInBox(e){var i;return(i=this._boxHelper)==null?void 0:i.isInBox(e)}awake(){this._boxHelper=this.gameObject.addComponent(Nn),this._boxHelper.updateBox(!0),qc&&this._boxHelper.showHelper(5592320,!0),this._texture&&(this._texture.mapping=Vo,this._texture.colorSpace=$r,this._texture.needsUpdate=!0)}start(){this._texture||console.warn(`[ReflectionProbe] Missing texture. Please assign a custom cubemap texture. To use reflection probes assign them to your renderer's "anchor" property.`)}onDestroy(){const e=Po._probes.get(this.context);if(e){const i=e.indexOf(this);i>=0&&e.splice(i,1)}}onSet(e){var n;if(NS||!this.enabled||((n=e.sharedMaterials)==null?void 0:n.length)<=0||!this.texture)return;let i=Po._rendererMaterialsCache.get(e);i||(i=[],Po._rendererMaterialsCache.set(e,i));for(let o=0;o<e.sharedMaterials.length;o++){const r=e.sharedMaterials[o];if(!r||r.envMap===void 0||r instanceof Ye)continue;let l=i[o];const c=r===(l==null?void 0:l.copy),h=!l||l.material.uuid!==r.uuid||l.copy.version!==r.version;if(!c&&h){if(qc){let f="";l?l.material!==r?f="reference changed; cached instance?: "+c:l.copy.version!==r.version&&(f="version changed"):f="not cached",console.warn("Cloning material",r.name,r.version,"Reason:",f,`
`,r.uuid,`
`,l==null?void 0:l.copy.uuid,`
`,e.name)}const u=r.clone();u.version=r.version,l?(l.copy=u,l.material=r):(l={material:r,copy:u},i.push(l)),u[Ob]=this,u[zS]=r,qc&&console.log("Set reflection",e.name,e.guid)}l&&l.copy&&(l.copy.onBeforeCompile=r.onBeforeCompile);const d=l==null?void 0:l.copy;"envMap"in d&&(d.envMap=this.texture,d.needsUpdate=!0),e.sharedMaterials[o]=d}}onUnset(e){const i=Po._rendererMaterialsCache.get(e);if(i)for(let n=0;n<i.length;n++){const o=i[n];e.sharedMaterials[n]=o.material}}};let Bo=Po;a(Bo,"_probes",new Map),a(Bo,"_rendererMaterialsCache",new Map);DT([g(R)],Bo.prototype,"center",void 0);DT([g(R)],Bo.prototype,"size",void 0);const kb=k("debugexr");class pD{constructor(t){a(this,"parser");this.parser=t,kb&&console.log(t)}get name(){return"EXT_texture_exr"}loadTexture(t){const e=this.name,i=this.parser,o=i.json.textures[t];if(kb&&console.log("EXT_texture_exr.loadTexture",t,o),!o.extensions||!o.extensions[e])return null;const r=o.extensions[e],l=new D0(i.options.manager);return kb&&console.log("EXT_texture_exr.loadTexture",r),i.loadTextureImage(t,r.source,l)}}typeof window<"u"&&window.addEventListener("unhandledrejection",s=>{});const fo=ii,Ep="$___Export_Components",mD="NEEDLE_components";var LF;class gD{constructor(){a(this,LF)}}LF=ih;class yD{constructor(t,e,i){a(this,"node");a(this,"nodeIndex");a(this,"nodeDef");this.node=t,this.nodeIndex=e,this.nodeDef=i}}class jT{constructor(){a(this,"exportContext");a(this,"objectToNodeMap",{});a(this,"context");a(this,"writer");a(this,"parser");a(this,"nodeToObjectMap",{});a(this,"gltf",null)}get name(){return mD}registerExport(t){t.register(e=>{if("serializeUserData"in e){const i=e.serializeUserData.bind(e);this.writer=e,e.serializeUserData=(n,o)=>{try{this.serializeUserData(n,o)&&(e.extensionsUsed[this.name]=!0),i(n,o)}finally{this.afterSerializeUserData(n,o)}}}return this})}beforeParse(){this.exportContext={},this.objectToNodeMap={}}serializeUserData(t,e){var n;const i=(n=t.userData)==null?void 0:n.components;return!i||i.length<=0?!1:(delete t.userData.components,t[Ep]=i,!0)}afterSerializeUserData(t,e){if(t.type==="Scene"&&fo&&console.log("DONE",JSON.stringify(e)),t[Ep]===void 0)return;const i=t[Ep];delete t[Ep],i!==null&&(t.userData.components=i)}writeNode(t,e){const i=this.writer.json.nodes.length;fo&&console.log(t.name,i,t.uuid);const n=new yD(t,i,e);this.exportContext[i]=n,this.objectToNodeMap[t.uuid]=i}afterParse(t){var e;fo&&console.log("AFTER",t);for(const i in this.exportContext){const n=this.exportContext[i],o=n.node,r=n.nodeDef,l=n.nodeIndex,c=(e=o.userData)==null?void 0:e.components;if(!c||c.length<=0)continue;const h=new gD;r.extensions=r.extensions||{},r.extensions[this.name]=h,this.context.object=o,this.context.nodeId=l,this.context.objectToNode=this.objectToNodeMap;const d=[];for(const u of c){this.context.target=u;const f=Ko().writeBuiltinComponentData(u,this.context);f!==null&&d.push(f)}d.length>0&&(h[ih]=d,fo&&console.log("DID WRITE",o,"nodeIndex",l,d))}}beforeRoot(){return fo&&console.log("BEGIN LOAD"),this.nodeToObjectMap={},null}async afterRoot(t){this.gltf=t;const e=t.parser,i=e==null?void 0:e.extensions;if(!i)return;const n=i[this.name];fo&&console.log("After root",t,this.parser,i);const o=[];if(n===!0){const r=e.json.nodes;if(r){for(let l=0;l<r.length;l++){const c=await e.getDependency("node",l);this.nodeToObjectMap[l]=c}for(let l=0;l<r.length;l++){const c=r[l],h=l,d=c.extensions;if(!d)continue;const u=d[this.name];if(!u)continue;fo&&console.log("NODE",c);const f=this.nodeToObjectMap[h];if(!f){console.error("Could not find object for node index: "+h,c,e);continue}nv(f),o.push(this.createComponents(t,c,f,u))}}}await Promise.all(o);for(const r of e.associations.keys()){const l=e.associations.get(r);if((l==null?void 0:l.materials)!=null){const c="/materials/"+l.materials;z2(r,c)}}}async createComponents(t,e,i,n){var r;if(!n)return;const o=n[ih];if(o){const l=new Array;fo&&console.log(i.name,o);for(const c in o){const h=o[c];if(fo&&console.log("Serialized data",JSON.parse(JSON.stringify(h))),((h==null?void 0:h.name)==="MeshRenderer"||(h==null?void 0:h.name)==="SkinnedMeshRenderer")&&!h.sharedMaterials){let d=!1;if("mesh"in e){const u=e.mesh;if(typeof u=="number"&&t.parser){const f=(r=t.parser.json.meshes)==null?void 0:r[u];f!=null&&f.primitives&&(h.sharedMaterials=f.primitives.map(p=>"/materials/"+(p.material??0)),d=!0)}}!d&&(fo||X())&&console.warn(`[NEEDLE_components] Component '${h.name}' on object '${i.name}' is not added to a mesh or failed to retrieve materials from glTF.`)}h&&this.parser&&l.push(tv(this.parser,h).catch(d=>console.error(`Error while resolving references (see console for details)
`,d,i,h))),i.userData=i.userData||{},i.userData[ih]=i.userData[ih]||[],i.userData[ih].push(h)}await Promise.all(l).catch(c=>{console.error("Error while loading components",c)})}}}const $S="NEEDLE_gameobject_data";class bD{constructor(t){a(this,"parser");this.parser=t}get name(){return $S}afterRoot(t){var i;const e=[];for(let n=0;n<((i=this.parser.json.nodes)==null?void 0:i.length);n++){const o=this.parser.json.nodes[n];if(o&&o.extensions){const r=o.extensions[$S];if(r){const l=this.findAndApplyExtensionData(n,r);e.push(l)}}}return Promise.all(e).then(()=>null)}async findAndApplyExtensionData(t,e){const i=await this.parser.getDependency("node",t);i&&this.applyExtensionData(i,e)}applyExtensionData(t,e){e.layers===void 0&&(e.layers=0),t.userData.layer=e.layers,t.layers.disableAll(),t.layers.set(e.layers),t.userData.tag=e.tag??"none",t.hideFlags=0,t.userData.static=e.static??!1,t.visible=e.activeSelf??!0,t.guid=e.guid}}const VS="NEEDLE_lighting_settings",rh=k("debugenvlight");class _D{constructor(t,e,i){a(this,"parser");a(this,"sourceId");a(this,"context");this.parser=t,this.sourceId=e,this.context=i}get name(){return VS}afterRoot(t){const e=this.parser.json.extensions;if(e){const i=e[VS];if(i){rh&&console.log('Loaded "'+this.name+'", src: "'+this.sourceId+'"',i);let n;if(t.scene.children.length===1){const o=t.scene.children[0];n=I.addComponent(o,t0,{},{callAwake:!1})}else{const o=new z;o.name="LightSettings "+this.sourceId,t.scene.add(o),n=I.addComponent(o,t0,{},{callAwake:!1})}n.sourceId=this.sourceId,n.ambientIntensity=i.ambientIntensity,n.ambientLight=new Se().fromArray(i.ambientLight),Array.isArray(i.ambientTrilight)&&(n.ambientTrilight=i.ambientTrilight.map(o=>new Se().fromArray(o))),n.ambientMode=i.ambientMode,n.environmentReflectionSource=i.environmentReflectionSource}}return null}}Be.registerCallback(Me.ContextCreated,s=>{const t=s.context,e=I.findObjectOfType(t0,t);e!=null&&e.sourceId&&(e.enabled=!0)});class t0 extends W{constructor(){super(...arguments);a(this,"ambientMode",Lo.Skybox);a(this,"ambientLight");a(this,"ambientTrilight");a(this,"ambientIntensity",1);a(this,"environmentReflectionSource",gf.Skybox);a(this,"_hasReflection",!1);a(this,"_ambientLightObj");a(this,"_hemisphereLightObj")}awake(){var i;if(this.sourceId){const n=this.environmentReflectionSource===gf.Skybox?zs.Skybox:zs.Reflection,o=this.context.lightmaps.tryGet(this.sourceId,n,0);this._hasReflection=o!=null,o&&this.context.sceneLighting.internalRegisterReflection(this.sourceId,o)}this.enabled=!1,this.context.sceneLighting.internalRegisterSceneLightSettings(this),rh&&window.addEventListener("keydown",n=>{if(!this.destroyed)switch(n.key){case"l":this.enabled=!this.enabled;break}});const e=(i=this.gameObject.userData)==null?void 0:i.components;if(e){const n=e.indexOf(this);e.splice(n,1),e.push(this)}}onDestroy(){this.context.sceneLighting.internalUnregisterSceneLightSettings(this)}calculateIntensityFactor(e){const i=Math.max(e.r,e.g,e.b);return 2.2*ee.lerp(0,1.33,i)}onEnable(){if(rh&&console.warn("üí°üü° >>> Enable lighting",this.sourceId,this.enabled,this),this.ambientMode==Lo.Flat){if(this.ambientLight&&!this._ambientLightObj){const e=this.calculateIntensityFactor(this.ambientLight);this._ambientLightObj=new ik(this.ambientLight,this.ambientIntensity*e),rh&&console.log("Created ambient light",this.sourceId,this._ambientLightObj,this.ambientIntensity,e)}this._ambientLightObj&&this.gameObject.add(this._ambientLightObj)}else if(this.ambientMode===Lo.Trilight){if(this.ambientTrilight){const e=this.ambientTrilight[0],i=this.ambientTrilight[this.ambientTrilight.length-1],n=this.calculateIntensityFactor(i);this._hemisphereLightObj=new nk(i,e,this.ambientIntensity*n),this.gameObject.add(this._hemisphereLightObj),rh&&console.log("Created hemisphere ambient light",this.sourceId,this._hemisphereLightObj,this.ambientIntensity,n)}}else this._ambientLightObj&&this._ambientLightObj.removeFromParent(),this._hemisphereLightObj&&this._hemisphereLightObj.removeFromParent();this.sourceId&&(this.context.domElement.getAttribute("environment-image")||this.context.sceneLighting.internalEnableReflection(this.sourceId))}onDisable(){rh&&console.warn("üí°‚ö´ <<< Disable lighting:",this.sourceId,this),this._ambientLightObj&&this._ambientLightObj.removeFromParent(),this._hemisphereLightObj&&this._hemisphereLightObj.removeFromParent(),this.sourceId&&this.context.sceneLighting.internalDisableReflection(this.sourceId)}}var WS;(function(s){s[s.Fragment=35632]="Fragment",s[s.Vertex=35633]="Vertex"})(WS||(WS={}));var i0;(function(s){s[s.INT=5124]="INT",s[s.FLOAT=5126]="FLOAT",s[s.FLOAT_VEC2=35664]="FLOAT_VEC2",s[s.FLOAT_VEC3=35665]="FLOAT_VEC3",s[s.FLOAT_VEC4=35666]="FLOAT_VEC4",s[s.INT_VEC2=35667]="INT_VEC2",s[s.INT_VEC3=35668]="INT_VEC3",s[s.INT_VEC4=35669]="INT_VEC4",s[s.BOOL=35670]="BOOL",s[s.BOOL_VEC2=35671]="BOOL_VEC2",s[s.BOOL_VEC3=35672]="BOOL_VEC3",s[s.BOOL_VEC4=35673]="BOOL_VEC4",s[s.FLOAT_MAT2=35674]="FLOAT_MAT2",s[s.FLOAT_MAT3=35675]="FLOAT_MAT3",s[s.FLOAT_MAT4=35676]="FLOAT_MAT4",s[s.SAMPLER_2D=35678]="SAMPLER_2D",s[s.SAMPLER_3D=35680]="SAMPLER_3D",s[s.SAMPLER_CUBE=35681]="SAMPLER_CUBE",s[s.UNKNOWN=0]="UNKNOWN"})(i0||(i0={}));const _o=k("debugcustomshader"),Xc="NEEDLE_techniques_webgl";var HS;(function(s){s[s.INT=5124]="INT",s[s.FLOAT=5126]="FLOAT",s[s.FLOAT_VEC2=35664]="FLOAT_VEC2",s[s.FLOAT_VEC3=35665]="FLOAT_VEC3",s[s.FLOAT_VEC4=35666]="FLOAT_VEC4",s[s.INT_VEC2=35667]="INT_VEC2",s[s.INT_VEC3=35668]="INT_VEC3",s[s.INT_VEC4=35669]="INT_VEC4",s[s.BOOL=35670]="BOOL",s[s.BOOL_VEC2=35671]="BOOL_VEC2",s[s.BOOL_VEC3=35672]="BOOL_VEC3",s[s.BOOL_VEC4=35673]="BOOL_VEC4",s[s.FLOAT_MAT2=35674]="FLOAT_MAT2",s[s.FLOAT_MAT3=35675]="FLOAT_MAT3",s[s.FLOAT_MAT4=35676]="FLOAT_MAT4",s[s.SAMPLER_2D=35678]="SAMPLER_2D",s[s.SAMPLER_3D=35680]="SAMPLER_3D",s[s.SAMPLER_CUBE=35681]="SAMPLER_CUBE",s[s.UNKNOWN=0]="UNKNOWN"})(HS||(HS={}));class vD{constructor(){a(this,"objectToWorldMatrix",new xe);a(this,"worldToObjectMatrix",new xe);a(this,"objectToWorld",new Array);a(this,"worldToObject",new Array)}updateFrom(t){this.objectToWorldMatrix.copy(t.matrixWorld),Im(this.objectToWorldMatrix,this.objectToWorld),this.worldToObjectMatrix.copy(t.matrixWorld).invert(),Im(this.worldToObjectMatrix,this.worldToObject)}}var Au;(function(s){s[s.Off=0]="Off",s[s.Front=1]="Front",s[s.Back=2]="Back"})(Au||(Au={}));var _r;(function(s){s[s.Never=1]="Never",s[s.Less=2]="Less",s[s.Equal=3]="Equal",s[s.LEqual=4]="LEqual",s[s.Greater=5]="Greater",s[s.NotEqual=6]="NotEqual",s[s.GEqual=7]="GEqual",s[s.Always=8]="Always"})(_r||(_r={}));const dt=class extends ZC{constructor(e,...i){super(...i);a(this,"identifier");a(this,"onBeforeRenderSceneCallback",this.onBeforeRenderScene.bind(this));a(this,"_sphericalHarmonicsName","unity_SpecCube0");a(this,"_objToWorldName","hlslcc_mtx4x4unity_ObjectToWorld");a(this,"_worldToObjectName","hlslcc_mtx4x4unity_WorldToObject");a(this,"_viewProjectionName","hlslcc_mtx4x4unity_MatrixVP");a(this,"_viewMatrixName","hlslcc_mtx4x4unity_MatrixV");a(this,"_rendererData",new vD);this.identifier=e,_o&&console.log(this),this.type="NEEDLE_CUSTOM_SHADER",this.uniforms[this._objToWorldName]||(this.uniforms[this._objToWorldName]={value:[]}),this.uniforms[this._worldToObjectName]||(this.uniforms[this._worldToObjectName]={value:[]}),this.uniforms[this._viewProjectionName]||(this.uniforms[this._viewProjectionName]={value:[]}),this.uniforms[this._sphericalHarmonicsName],(this.depthTextureUniform||this.opaqueTextureUniform)&&de.Current.pre_render_callbacks.push(this.onBeforeRenderSceneCallback)}clone(){const e=super.clone();return FT(e),e}dispose(){super.dispose();const e=de.Current.pre_render_callbacks.indexOf(this.onBeforeRenderSceneCallback);e>=0&&de.Current.pre_render_callbacks.splice(e,1)}get depthTextureUniform(){if(this.uniforms)return this.uniforms._CameraDepthTexture}get opaqueTextureUniform(){if(this.uniforms)return this.uniforms._CameraOpaqueTexture}onBeforeRenderScene(){this.opaqueTextureUniform&&de.Current.setRequireColor(!0),this.depthTextureUniform&&de.Current.setRequireDepth(!0)}onBeforeRender(e,i,n,o,r,l){o.attributes.tangent||o.computeTangents(),this.onUpdateUniforms(n,r)}onUpdateUniforms(e,i){const n=de.Current;if(e&&(dt.viewProjection&&this.uniforms[this._viewProjectionName]&&(dt.viewProjection.copy(e.projectionMatrix).multiply(e.matrixWorldInverse),Im(dt.viewProjection,dt._viewProjectionValues)),dt.viewMatrix&&this.uniforms[this._viewMatrixName]&&(dt.viewMatrix.copy(e.matrixWorldInverse),Im(dt.viewMatrix,dt._viewMatrixValues)),this.uniforms[dt._worldSpaceCameraPosName]&&dt._worldSpaceCameraPos.setFromMatrixPosition(e.matrixWorld)),this.uniforms._TimeParameters&&(this.uniforms._TimeParameters.value=n.sceneLighting.timeVec4),this.uniforms._Time){const c=this.uniforms._Time.value;c.x=n.sceneLighting.timeVec4.x/20,c.y=n.sceneLighting.timeVec4.x,c.z=n.sceneLighting.timeVec4.x*2,c.w=n.sceneLighting.timeVec4.x*3}if(this.uniforms._SinTime){const c=this.uniforms._SinTime.value;c.x=Math.sin(n.sceneLighting.timeVec4.x/8),c.y=Math.sin(n.sceneLighting.timeVec4.x/4),c.z=Math.sin(n.sceneLighting.timeVec4.x/2),c.w=Math.sin(n.sceneLighting.timeVec4.x)}if(this.uniforms._CosTime){const c=this.uniforms._CosTime.value;c.x=Math.cos(n.sceneLighting.timeVec4.x/8),c.y=Math.cos(n.sceneLighting.timeVec4.x/4),c.z=Math.cos(n.sceneLighting.timeVec4.x/2),c.w=Math.cos(n.sceneLighting.timeVec4.x)}if(this.uniforms.unity_DeltaTime){const c=this.uniforms.unity_DeltaTime.value;c.x=n.time.deltaTime,c.y=1/n.time.deltaTime,c.z=n.time.smoothedDeltaTime,c.w=1/n.time.smoothedDeltaTime}const o=n.mainLight;if(o){const c=ve(o.gameObject,dt._mainLightPosition);this.uniforms._MainLightPosition={value:c.normalize()},dt._mainLightColor.set(o.color.r,o.color.g,o.color.b,0),this.uniforms._MainLightColor={value:dt._mainLightColor};const h=o.intensity;dt._lightData.z=h,this.uniforms.unity_LightData={value:dt._lightData}}if(e&&(dt.viewProjection&&this.uniforms[this._viewProjectionName]&&(this.uniforms[this._viewProjectionName].value=dt._viewProjectionValues),dt.viewMatrix&&this.uniforms[this._viewMatrixName]&&(this.uniforms[this._viewMatrixName].value=dt._viewMatrixValues),this.uniforms[dt._worldSpaceCameraPosName]&&(this.uniforms[dt._worldSpaceCameraPosName]={value:dt._worldSpaceCameraPos}),n.mainCameraComponent)){if(this.uniforms._ProjectionParams){const c=this.uniforms._ProjectionParams.value;c.x=1,c.y=n.mainCameraComponent.nearClipPlane,c.z=n.mainCameraComponent.farClipPlane,c.w=1/c.z,this.uniforms._ProjectionParams.value=c}if(this.uniforms._ZBufferParams){const c=this.uniforms._ZBufferParams.value,h=n.mainCameraComponent;c.x=1-h.farClipPlane/h.nearClipPlane,c.y=h.farClipPlane/h.nearClipPlane,c.z=c.x/h.farClipPlane,c.w=c.y/h.farClipPlane,this.uniforms._ZBufferParams.value=c}if(this.uniforms._ScreenParams){const c=this.uniforms._ScreenParams.value;c.x=n.domWidth,c.y=n.domHeight,c.z=1+1/c.x,c.w=1+1/c.y,this.uniforms._ScreenParams.value=c}if(this.uniforms._ScaledScreenParams){const c=this.uniforms._ScaledScreenParams.value;c.x=n.domWidth,c.y=n.domHeight,c.z=1+1/c.x,c.w=1+1/c.y,this.uniforms._ScaledScreenParams.value=c}}const r=this.depthTextureUniform;r&&(r.value=n.depthTexture);const l=this.opaqueTextureUniform;if(l&&(l.value=n.opaqueColorTexture),i){const c=this._rendererData;c.updateFrom(i),this.uniforms[this._worldToObjectName].value=c.worldToObject,this.uniforms[this._objToWorldName].value=c.objectToWorld}this.uniformsNeedUpdate=!0}};let cs=dt;a(cs,"viewProjection",new xe),a(cs,"_viewProjectionValues",[]),a(cs,"viewMatrix",new xe),a(cs,"_viewMatrixValues",[]),a(cs,"_worldSpaceCameraPosName","_WorldSpaceCameraPos"),a(cs,"_worldSpaceCameraPos",new R),a(cs,"_mainLightColor",new Ne),a(cs,"_mainLightPosition",new R),a(cs,"_lightData",new Ne);class xD{constructor(t,e){a(this,"parser");a(this,"identifier");this.parser=t,this.identifier=e}get name(){return Xc}loadMaterial(t){const e=this.parser.json.materials[t];if(!e)return _o&&console.log(t,this.parser.json.materials),null;if(!e.extensions||!e.extensions[Xc])return _o&&console.log(`Material ${t} does not use NEEDLE_techniques_webgl`),null;_o&&console.log(`Material ${t} uses NEEDLE_techniques_webgl`,e);const i=e.extensions[Xc].technique;if(i<0)return console.debug(`Material ${t} does not have a valid technique index`),null;const n=this.parser.json.extensions[Xc];if(!n)return _o?console.error("Missing shader data",this.parser.json.extensions):console.debug("Missing custom shader data in parser.json.extensions"),null;_o&&console.log(n);const o=n.techniques[i];return o?new Promise(async(r,l)=>{var S,C,P;const c=await FI(n,o.program),h=c==null?void 0:c.fragmentShader,d=c==null?void 0:c.vertexShader;if(!h||!d)return l();_o&&console.log("loadMaterial",e,c);const u={},f=o.uniforms;(d.includes("_Time")||h.includes("_Time"))&&(u._Time={value:new Ne(0,0,0,0)}),(d.includes("_SinTime")||h.includes("_SinTime"))&&(u._SinTime={value:new Ne(0,0,0,0)}),(d.includes("_CosTime")||h.includes("_CosTime"))&&(u._CosTime={value:new Ne(0,0,0,0)}),(d.includes("unity_DeltaTime")||h.includes("unity_DeltaTime"))&&(u.unity_DeltaTime={value:new Ne(0,0,0,0)});for(const E in f){const D=E;switch(D){case"_TimeParameters":const M=new Ne;u[D]={value:M};break;case"hlslcc_mtx4x4unity_MatrixV":case"hlslcc_mtx4x4unity_MatrixVP":u[D]={value:[]};break;case"_MainLightPosition":case"_MainLightColor":case"_WorldSpaceCameraPos":u[D]={value:[0,0,0,1]};break;case"unity_OrthoParams":break;case"unity_SpecCube0":u[D]={value:null};break;default:case"_ScreenParams":case"_ZBufferParams":case"_ProjectionParams":u[D]={value:[0,0,0,0]};break;case"_CameraOpaqueTexture":case"_CameraDepthTexture":u[D]={value:null};break}}let p=!1;if(e.extensions&&e.extensions[Xc]){const E=e.extensions[Xc];if(E.technique===i){_o&&console.log(e.name,"Material Properties",E);for(const D in E.values){const M=E.values[D];if(typeof M=="string"){if(M.startsWith("/textures/")){const A=M.substring(10),G=Number.parseInt(A);if(G>=0){const V=await this.parser.getDependency("texture",G);V instanceof _t&&(V.colorSpace=$r,V.needsUpdate=!0),u[D]={value:V};continue}}switch(D){case"alphaMode":M==="BLEND"&&(p=!0);continue}}if(Array.isArray(M)&&M.length===4){u[D]={value:new Ne(M[0],M[1],M[2],M[3])};continue}u[D]={value:M}}}}const b=new cs(this.identifier,{name:e.name??"",uniforms:u,vertexShader:d,fragmentShader:h,lights:!1});switch(b.glslVersion=sk,b.vertexShader=b.vertexShader.replace("#version 300 es",""),b.fragmentShader=b.fragmentShader.replace("#version 300 es",""),(S=u._Cull)==null?void 0:S.value){case Au.Off:b.side=Qn;break;case Au.Front:b.side=Tg;break;case Au.Back:b.side=Wa;break;default:b.side=Wa;break}switch((C=u._ZTest)==null?void 0:C.value){case _r.Equal:b.depthTest=!0,b.depthFunc=dk;break;case _r.NotEqual:b.depthTest=!0,b.depthFunc=hk;break;case _r.Less:b.depthTest=!0,b.depthFunc=ck;break;case _r.LEqual:b.depthTest=!0,b.depthFunc=lk;break;case _r.Greater:b.depthTest=!0,b.depthFunc=ak;break;case _r.GEqual:b.depthTest=!0,b.depthFunc=rk;break;case _r.Always:b.depthTest=!1,b.depthFunc=ok;break}b.transparent=p,p&&(b.depthWrite=!1),DI(u),b.onUpdateUniforms();for(const E in f){const D=E,M=f[E].type;if(((P=u[D])==null?void 0:P.value)===void 0)switch(M){case i0.SAMPLER_2D:u[D]={value:II},console.warn("Missing/unassigned texture, fallback to white: "+D);break;default:D==="unity_OrthoParams"||console.warn("TODO: EXPECTED UNIFORM / fallback NOT SET: "+D,f[E]);break}}_o&&console.log(b.uuid,u),FT(b),r(b)}):null}}function FT(s){if(s.uniforms){_o&&console.log("Uniforms:",s.uniforms);for(const e in s.uniforms)switch(t(e,e),e){case"_Color":t("color",e);break}}function t(e,i){Object.getOwnPropertyDescriptor(s,e)||Object.defineProperty(s,e,{get:()=>s.uniforms[i].value,set:n=>{s.uniforms[i].value=n,s.needsUpdate=!0}})}}const wD=k("debugextensions");let Hm;const SD=qs(()=>import("./index.9efe6760.js"),["./index.9efe6760.js","./three@0.169.15.js"],import.meta.url).then(async s=>(Hm=s.GLTFAnimationPointerExtension,Hm)).catch(s=>{console.warn("Failed to import GLTFLoaderAnimationPointer. Please use @needle-tools/three-animationpointer for full KHR_animation support",s)}),hc=new Array;function W4(s){hc.includes(s)||hc.push(s)}function H4(s){const t=hc.indexOf(s);t>=0&&hc.splice(t,1)}function BT(s){if(s instanceof Wr){const t=new jT;return s.register(e=>(t.parser=e,t)),t}return null}class CD{resolvePath(t){return t.includes("/extensions/builtin_components/")?t.replace("/extensions/builtin_components/","/userData/components/"):t.includes("extensions/builtin_components/")?t.replace("extensions/builtin_components/","/userData/components/"):t}}async function n0(s,t,e,i){const n=e.indexOf("?");n>=0&&(e=e.substring(0,n)),i||(i=e),(i.startsWith("blob:")||i.startsWith("data:"))&&console.debug("[GLTFLoader] Suspicious sourceId detected"),s.register(o=>new bD(o)),s.register(o=>new V2(o)),s.register(o=>new OI(o,t.lightmaps,i)),s.register(o=>new _D(o,i,t)),s.register(o=>new xD(o,i)),s.register(o=>new Mu(o,i)),s.register(o=>new Tt(o)),s.register(o=>new pD(o)),a2()&&s.register(o=>new wu(o)),await SD.catch(o=>{}),s.register(o=>{if(Hm){const r=new Hm(o);return r.setAnimationPointerResolver.bind(r)(new CD),r}else return(wD||X())&&console.error("Missing KHR_animation_pointer extension..."),{name:"KHR_animation_pointer_NOT_AVAILABLE"}});for(const o of hc)o.onImport&&o.onImport(s,e,t)}function UT(s,t){for(const e of hc)e.onExport&&e.onExport(s,t)}function PD(s,t,e){for(const i of hc)i.onLoaded&&i.onLoaded(s,t,e)}const Vi=k("debuginstancing"),cg=class{constructor(){a(this,"objs",[])}setup(t,e,i,n,o,r=0){t.applySettings(e);const l=this.tryCreateOrAddInstance(e,i,o);if(l){n===null&&(n=[]),n.push(l);const c=l.object.material;Array.isArray(c)?c.forEach(u=>Tt.assignTextureLOD(u,0)):Tt.assignTextureLOD(c,0);const h=l.object,d=h.geometry;Tt.assignMeshLOD(h,0).then(u=>{u&&d!=u&&l.setGeometry(u)})}else if(r<=0&&e.type!=="Mesh"){const c=r+1;for(const h of e.children)n=this.setup(t,h,i,n,o,c)}return r===0&&o.useMatrixWorldAutoUpdate&&n&&n.length>=0&&this.autoUpdateInstanceMatrix(e),n}tryCreateOrAddInstance(t,e,i){if(t.type==="Mesh"){const n=i.foundMeshes;if(i.foundMeshes+=1,!i.rend.enableInstancing)return null;if(i.rend.enableInstancing!==!0){if(n>=i.rend.enableInstancing.length)return Vi&&console.error("Something is wrong with instance setup",t,i.rend.enableInstancing,n),null;if(!i.rend.enableInstancing[n])return null}const o=t,r=o.material;for(const u of this.objs){if(!u.canAdd(o.geometry,r))continue;return u.addInstance(o)}let l=cg.getStartInstanceCount(t);(!l||l<0)&&(l=4);let c=t.name;c!=null&&c.length||(c=uE());const h=new NT(c,o.geometry,r,l,e);return this.objs.push(h),h.addInstance(o)}return null}autoUpdateInstanceMatrix(t){const e=t.matrixWorld.multiplyMatrices.bind(t.matrixWorld),i=t.matrixWorld.clone(),n=(o,r)=>{const l=e(o,r);return(t[mf]||i.equals(l)===!1)&&(i.copy(l),t[mf]=!0),l};t.matrixWorld.multiplyMatrices=n}};let Hl=cg;a(Hl,"instance",new cg),a(Hl,"getStartInstanceCount",t=>4);const nf=class{constructor(t,e){a(this,"object");a(this,"renderer");a(this,"__instanceIndex",-1);a(this,"__reservedVertexRange",0);a(this,"__reservedIndexRange",0);a(this,"__geometryIndex",-1);a(this,"meshInformation");this.__instanceIndex=-1,this.object=t,this.renderer=e,t[$P]=e,this.meshInformation=jl(t.geometry),nf.all.push(this)}get name(){return this.object.name}get isActive(){return this.__instanceIndex>=0}get vertexCount(){return this.object.geometry.attributes.position.count}get maxVertexCount(){return Math.max(this.meshInformation.vertexCount,this.vertexCount)}get reservedVertexCount(){return this.__reservedVertexRange}get indexCount(){return this.object.geometry.index?this.object.geometry.index.count:0}get maxIndexCount(){return Math.max(this.meshInformation.indexCount,this.indexCount)}get reservedIndexCount(){return this.__reservedIndexRange}updateMeshInformation(){const t=jl(this.object.geometry),e=this.meshInformation.vertexCount,i=this.meshInformation.indexCount;return Object.assign(this.meshInformation,t),e!==this.meshInformation.vertexCount||i!==this.meshInformation.indexCount}updateInstanceMatrix(t=!1,e=!0){this.__instanceIndex<0||(e&&this.object.updateWorldMatrix(!0,t),this.renderer.updateInstance(this.object.matrixWorld,this.__instanceIndex))}setMatrix(t){this.__instanceIndex<0||this.renderer.updateInstance(t,this.__instanceIndex)}setGeometry(t){if(this.__geometryIndex<0)return!1;const e=this;if(this.vertexCount>this.__reservedVertexRange)return i(`Instancing: Can not update geometry (${this.name}), reserved vertex range is too small: ${this.__reservedVertexRange.toLocaleString()} < ${this.vertexCount.toLocaleString()} vertices for ${this.name}`);if(this.indexCount>this.__reservedIndexRange)return i(`Instancing: Can not update geometry (${this.name}), reserved index range is too small: ${this.__reservedIndexRange.toLocaleString()} < ${this.indexCount.toLocaleString()} indices for ${this.name}`);return this.renderer.updateGeometry(t,this.__geometryIndex);function i(n){return e.updateMeshInformation()&&(e.renderer.remove(e,!0),e.renderer.add(e))?!0:((X()||Vi)&&console.error(n),!1)}}add(){this.__instanceIndex>=0||(this.renderer.add(this),I.markAsInstancedRendered(this.object,!0))}remove(t){if(!(this.__instanceIndex<0)&&(this.renderer.remove(this,t),I.markAsInstancedRendered(this.object,!1),t)){const e=nf.all.indexOf(this);e>=0&&nf.all.splice(e,1)}}};let Iu=nf;a(Iu,"all",[]);class NT{constructor(t,e,i,n,o){a(this,"allowResize",!0);a(this,"name","");a(this,"geometry");a(this,"material");a(this,"_context");a(this,"_batchedMesh");a(this,"_handles",[]);a(this,"_geometryIds",new WeakMap);a(this,"_maxInstanceCount");a(this,"_currentInstanceCount",0);a(this,"_currentVertexCount",0);a(this,"_currentIndexCount",0);a(this,"_maxVertexCount");a(this,"_maxIndexCount");a(this,"_needUpdateBounds",!1);a(this,"_debugMaterial",null);a(this,"onBeforeRender",()=>{this._batchedMesh.layers.enableAll(),this._needUpdateBounds&&this._batchedMesh[hu]===!0&&(Vi==="verbose"&&console.log("Update instancing bounds",this.name,this._batchedMesh.matrixWorldNeedsUpdate),this.updateBounds())});a(this,"onAfterRender",()=>{this._batchedMesh.layers.disableAll()});a(this,"_growId",0);this.name=t,this.geometry=e,this.material=i,this._context=o,this._maxInstanceCount=Math.max(2,n),Vi&&(this._debugMaterial=GS());const r=this.tryEstimateVertexCountSize(this._maxInstanceCount,[e],n);this._maxVertexCount=r.vertexCount,this._maxIndexCount=r.indexCount,this._batchedMesh=new Bx(this._maxInstanceCount,this._maxVertexCount,this._maxIndexCount,this._debugMaterial??this.material),this._batchedMesh.name=this.getBatchedMeshName(),this._batchedMesh[hu]=!0,this._batchedMesh.visible=!0,this._context.scene.add(this._batchedMesh),i instanceof ZC&&(i.defines.USE_INSTANCING=!0,i.needsUpdate=!0),o.pre_render_callbacks.push(this.onBeforeRender),o.post_render_callbacks.push(this.onAfterRender),Vi&&console.log(`Instanced renderer (${this.name}) created with ${this._maxInstanceCount} instances, ${this._maxVertexCount} max vertices and ${this._maxIndexCount} max indices for "${t}"`)}get batchedMesh(){return this._batchedMesh}get visible(){return this._batchedMesh.visible}set visible(t){this._batchedMesh.visible=t}get castShadow(){return this._batchedMesh.castShadow}set castShadow(t){this._batchedMesh.castShadow=t}set receiveShadow(t){this._batchedMesh.receiveShadow=t}get count(){return this._currentInstanceCount}updateBounds(t=!0,e=!0){if(this._needUpdateBounds=!1,t&&this._batchedMesh.computeBoundingBox(),e&&this._batchedMesh.computeBoundingSphere(),Vi&&this._batchedMesh.boundingSphere){const i=this._batchedMesh.boundingSphere;se.DrawWireSphere(i.center,i.radius,65280)}}canAdd(t,e){return this._maxVertexCount>1e7||e!==this.material||!this.validateGeometry(t)?!1:!!(!this.mustGrow(t)||this.allowResize)}getBatchedMeshName(){return this.name?`${this.name} (BatchedMesh)`:"BatchedMesh"}dispose(){Vi&&console.warn("Dispose instanced renderer",this.name),this._context.scene.remove(this._batchedMesh),this._batchedMesh.dispose(),this._batchedMesh=null,this._handles=[]}addInstance(t){const e=new Iu(t,this);t.castShadow===!0&&this._batchedMesh.castShadow===!1&&(this._batchedMesh.castShadow=!0),t.receiveShadow===!0&&this._batchedMesh.receiveShadow===!1&&(this._batchedMesh.receiveShadow=!0);try{this.add(e)}catch(i){if(console.error(`Failed adding mesh to instancing (object name: "${t.name}", instances: ${this._currentInstanceCount.toLocaleString()}/${this._maxInstanceCount.toLocaleString()}, vertices: ${this._currentVertexCount.toLocaleString()}/${this._maxVertexCount.toLocaleString()}, indices: ${this._currentIndexCount.toLocaleString()}/${this._maxIndexCount.toLocaleString()})
`,i),X()){Ag("Failed instancing mesh. See the browser console for details.");debugger}return null}return e}add(t){const e=t.object.geometry;if(!e||!e.attributes)return console.error("Cannot add object to instancing without geometry",t.name),!1;if(this._currentInstanceCount+1>this._maxInstanceCount||this.mustGrow(e))if(this.allowResize)this.grow(e);else return console.error("Cannot add instance, max count reached",this.name,this.count,this._maxInstanceCount),!1;return t.object.updateWorldMatrix(!0,!0),this.addGeometry(t),this._handles[t.__instanceIndex]=t,this._currentInstanceCount+=1,this.markNeedsUpdate(),this._currentInstanceCount>0&&(this._batchedMesh.visible=!0),!0}remove(t,e){t&&(t.__instanceIndex<0||this._handles[t.__instanceIndex]!=t||this._currentInstanceCount<=0||(this.removeGeometry(t,e),this._handles[t.__instanceIndex]=null,t.__instanceIndex=-1,this._currentInstanceCount>0&&(this._currentInstanceCount-=1),this._currentInstanceCount<=0&&(this._batchedMesh.visible=!1),this.markNeedsUpdate()))}updateInstance(t,e){this._batchedMesh.setMatrixAt(e,t),this.markNeedsUpdate()}updateGeometry(t,e){return this.validateGeometry(t)?(this.mustGrow()&&this.grow(t),Vi&&console.debug("[Instancing] UPDATE GEOMETRY at "+e,this._batchedMesh._geometryCount,t.name,jl(t),t.attributes.position.count,t.index?t.index.count:0),this._batchedMesh.setGeometryAt(e,t),this._geometryIds.set(t,e),this.markNeedsUpdate(),!0):!1}validateGeometry(t){const e=this.geometry;for(const i in e.attributes)if(i!=="batchId"&&!t.hasAttribute(i))return X()&&console.warn(`BatchedMesh: Added geometry missing "${i}". All geometries must have consistent attributes.`),!1;return!0}markNeedsUpdate(){Vi==="verbose"&&console.warn("Marking instanced mesh dirty",this.name),this._needUpdateBounds=!0}mustGrow(t){if(this.count>=this._maxInstanceCount)return!0;if(!t||!t.attributes||this._geometryIds.has(t))return!1;const i=jl(t),n=i.vertexCount,o=i.indexCount;return this._currentVertexCount+n>this._maxVertexCount||this._currentIndexCount+o>this._maxIndexCount}grow(t){var f,p;const e=++this._growId,i=2,o=this.count>=this._maxInstanceCount?Math.ceil(this._maxInstanceCount*i):this._maxInstanceCount,r=this.tryEstimateVertexCountSize(o,[t]),l=1.25,c=Math.max(this._maxVertexCount,Math.ceil(r.vertexCount*l)),h=Math.max(this._maxIndexCount,Math.ceil(r.indexCount*l));if(Vi){const b=jl(t);console.warn(`[Instancing] Growing Buffer
Mesh: "${this.name}${(f=t.name)!=null&&f.length?"/"+t.name:""}" (${b.vertexCount.toLocaleString()} vertices, ${b.indexCount.toLocaleString()} indices)
Max count ${this._maxInstanceCount.toLocaleString()} ‚Üí ${o.toLocaleString()}
Max vertex count ${this._maxVertexCount.toLocaleString()} -> ${c.toLocaleString()}
Max index count ${this._maxIndexCount.toLocaleString()} -> ${h.toLocaleString()}`),this._debugMaterial=GS()}else X()&&console.debug(`[Instancing] Growing Buffer
Mesh: "${this.name}${(p=t.name)!=null&&p.length?"/"+t.name:""}"
Max count ${this._maxInstanceCount} ‚Üí ${o}
Max vertex count ${this._maxVertexCount.toLocaleString()} -> ${c.toLocaleString()}
Max index count ${this._maxIndexCount.toLocaleString()} -> ${h.toLocaleString()}`);this._maxVertexCount=c,this._maxIndexCount=h;const d=new Bx(o,this._maxVertexCount,this._maxIndexCount,this._debugMaterial??this.material);d.name=this.getBatchedMeshName(),d.layers=this._batchedMesh.layers,d.castShadow=this._batchedMesh.castShadow,d.receiveShadow=this._batchedMesh.receiveShadow,d.visible=this._batchedMesh.visible,d[hu]=this._batchedMesh[hu],d.matrixAutoUpdate=this._batchedMesh.matrixAutoUpdate,d.matrixWorldNeedsUpdate=this._batchedMesh.matrixWorldNeedsUpdate,d.matrixAutoUpdate=this._batchedMesh.matrixAutoUpdate,d.matrixWorld.copy(this._batchedMesh.matrixWorld),d.matrix.copy(this._batchedMesh.matrix),this._batchedMesh.dispose(),this._batchedMesh.removeFromParent(),this._geometryIds=new WeakMap,this._batchedMesh=d,this._maxInstanceCount=o;const u=[...this._handles];this._handles=[];for(const b of u){if(e!==this._growId){Vi&&console.warn("[Instancing] Aborting grow since another grow happened in the meantime");return}b&&b.__instanceIndex>=0&&(this.addGeometry(b),this._handles[b.__instanceIndex]=b)}this._context.scene.add(d)}tryEstimateVertexCountSize(t,e,i=1){const n=new Map;for(const f of this._handles)if(f&&f.__instanceIndex>=0&&f.object.geometry){if(n.has(f.object.geometry)){const p=n.get(f.object.geometry);p.count+=1}else{const b={count:1,...jl(f.object.geometry)};n.set(f.object.geometry,b)}if(e&&(e==null?void 0:e.length)>0){const p=e.indexOf(f.object.geometry);p!==-1&&e.splice(p,1)}}let o=0,r=0,l=0;for(const[f,p]of n)l+=1,o+=p.vertexCount,r+=p.indexCount;let h=Math.ceil(o/Math.max(1,l))*l,u=Math.ceil(r/Math.max(1,l))*l;if(e)for(const f of e){const p=jl(f);p!=null&&(h+=p.vertexCount*i,u+=p.indexCount*i)}return Vi&&console.log(`[Instancing] Estimated size for new buffer ${this.name}
Geometries: ${l} (New: ${(e==null?void 0:e.length)||0})
Instances: ${t}
Estimated Vertices: ${h.toLocaleString()}
Estimated Indices: ${u.toLocaleString()}`),{vertexCount:h,indexCount:u}}addGeometry(t){const i=t.object.geometry;if(!i)return;let n=this._geometryIds.get(i);n==null?(Vi&&console.warn(`[Instancing] > ADD NEW GEOMETRY "${t.name} (${i.name}; ${i.uuid})"
Current Instances: ${this._currentInstanceCount}
Max Vertices: ${t.maxVertexCount.toLocaleString()}
Max Indices: ${t.maxIndexCount.toLocaleString()}
Max Triangles: ${(t.maxIndexCount/3).toLocaleString()}`),n=this._batchedMesh.addGeometry(i,t.maxVertexCount,t.maxIndexCount),this._geometryIds.set(i,n),this._currentVertexCount+=t.maxVertexCount,this._currentIndexCount+=t.maxIndexCount):Vi==="verbose"&&console.log(`[Instancing] > ADD INSTANCE "${t.name}"
GEOMETRY_ID=${n}
${this._currentInstanceCount} instances`);const o=this._batchedMesh.addInstance(n);t.__geometryIndex=n,t.__instanceIndex=o,t.__reservedVertexRange=t.maxVertexCount,t.__reservedIndexRange=t.maxIndexCount,this._batchedMesh.setMatrixAt(o,t.object.matrixWorld),Vi&&console.debug(`[Instancing] > ADDED INSTANCE "${t.name}"
GEOMETRY_ID=${n}
${this._currentInstanceCount} instances
Index: ${t.__instanceIndex}
Vertices: ${this._currentVertexCount.toLocaleString()}/${this._maxVertexCount.toLocaleString()},
Indices: ${this._currentIndexCount.toLocaleString()}/${this._maxIndexCount.toLocaleString()}`)}removeGeometry(t,e){if(t.__instanceIndex<0){console.warn("Cannot remove geometry, instance index is invalid",t.name);return}Vi&&console.debug(`[Instancing] < REMOVE INSTANCE "${t.name}" at [${t.__instanceIndex}]
GEOMETRY_ID=${t.__geometryIndex}
${this._currentInstanceCount} instances
Index: ${t.__instanceIndex}`),this._batchedMesh.deleteInstance(t.__instanceIndex)}}a(NT,"nullMatrix",new xe);function jl(s){var n,o;if(!s)return X()&&console.error("Cannot get mesh information from null geometry"),{vertexCount:0,indexCount:0};let t=((o=(n=s.attributes)==null?void 0:n.position)==null?void 0:o.count)||0,e=s.index?s.index.count:0;const i=Tt.getMeshLODExtension(s);if(i){const r=i.lods[0];let l=r.vertexCount,c=r.indexCount;const h=Math.min(200,Math.ceil(l*.05));l+=h,c+=20,t=Math.max(t,l),e=Math.max(e,c)}return t=Math.ceil(t),e=Math.ceil(e),{vertexCount:t,indexCount:e}}function GS(){const s=new ti({color:new Se(Math.random(),Math.random(),Math.random())});return s.emissive=s.color,s.emissiveIntensity=.3,k("wireframe")&&(s.wireframe=!0),s}const Qc=k("debuglightmaps");let Eb=0;const Mb=Symbol("lightmap-material-version");class zT{constructor(t){a(this,"lightmapIndex",-1);a(this,"lightmapScaleOffset",new Ne(1,1,0,0));a(this,"renderer");a(this,"clonedMaterials",new Array);a(this,"lightmapTexture",null);a(this,"lightmapScaleOffsetUniform",{value:new Ne(1,1,0,0)});a(this,"lightmapUniform",{value:null});a(this,"onBeforeCompile",(t,e)=>{Qc==="verbose"&&console.log(`Lightmaps, before compile
`,t),this.lightmapScaleOffsetUniform.value=this.lightmapScaleOffset,this.lightmapUniform.value=this.lightmapTexture,t.uniforms.lightmapScaleOffset=this.lightmapScaleOffsetUniform});this.renderer=t}get lightmap(){return this.lightmapTexture}set lightmap(t){t!==this.lightmapTexture&&(this.lightmapTexture=t,this.applyLightmap(),this.lightmapTexture&&Tt.assignTextureLOD(this.lightmapTexture,0).then(e=>{e!=null&&e.isTexture&&(this.lightmapTexture=e)}))}get context(){return this.renderer.context}get gameObject(){return this.renderer.gameObject}init(t,e,i){console.assert(this.gameObject!==void 0&&this.gameObject!==null,"Missing gameobject",this),this.lightmapIndex=t,!(this.lightmapIndex<0)&&(this.lightmapScaleOffset=e,this.lightmapTexture=i,Tt.assignTextureLOD(i,0).then(n=>{n!=null&&n.isTexture&&(this.lightmapTexture=n)}),Qc=="show"?(console.log("Lightmap:",this.gameObject.name,t,`
ScaleOffset:`,e,`
Texture:`,i),this.setLightmapDebugMaterial()):Qc&&console.log("Use debuglightmaps=show to render lightmaps only in the scene."),this.applyLightmap())}updateLightmapUniforms(t){const e=t.uniforms;e&&e.lightmap&&(this.lightmapScaleOffsetUniform.value=this.lightmapScaleOffset,e.lightmapScaleOffset=this.lightmapScaleOffsetUniform)}applyLightmap(){if(this.gameObject.type==="Object3D"){Qc&&console.warn("Can not add lightmap. Is this object missing a renderer?",this.gameObject.name);return}const t=this.gameObject;this.ensureLightmapUvs(t);for(let e=0;e<this.renderer.sharedMaterials.length;e++){const i=this.renderer.sharedMaterials[e];if(!i)continue;const n=this.ensureLightmapMaterial(i,e);i!==n&&(this.renderer.sharedMaterials[e]=n)}if(this.lightmapIndex>=0&&this.lightmapTexture){this.lightmapTexture.channel=1;for(const e of this.renderer.sharedMaterials)e&&this.assignLightmapTexture(e)}}ensureLightmapUvs(t){if(t instanceof le)t.geometry.getAttribute("uv1")||t.geometry.setAttribute("uv1",t.geometry.getAttribute("uv"));else if(t instanceof Ir)for(const e of t.children)this.ensureLightmapUvs(e)}ensureLightmapMaterial(t,e){var i;if(t.userData||(t.userData={}),this.clonedMaterials[e]!==t){Qc&&(++Eb,Eb++<1e3?console.warn(`Cloning material for lightmap ${this.renderer.name}: '${t.name}'`):Eb===1e3&&console.warn("Further material cloning for lightmaps suppressed to avoid flooding the console."));const n=t.clone();(i=n.name)!=null&&i.includes("(lightmap)")||(n.name=t.name+" (lightmap)"),t=n,t.onBeforeCompile=this.onBeforeCompile,this.clonedMaterials[e]=t}return t}assignLightmapTexture(t){!t||t instanceof c_&&t.transmission>0||!(t.lightMap!==this.lightmapTexture||t[Mb]!==t.version)||(Qc&&console.log(`Assigning lightmap texture ${this.renderer.name}: '${t.name}' (${t.version} ${t[Mb]})`),t.lightMap=this.lightmapTexture,t.needsUpdate=!0,t[Mb]=t.version)}setLightmapDebugMaterial(){this.gameObject.material=new Xo({vertexShader:`
                varying vec2 vUv1;
                void main()
                {
                    vUv1 = uv1;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
                }
                `,fragmentShader:`
                uniform sampler2D lightMap;
                uniform float lightMapIntensity;
                uniform vec4 lightmapScaleOffset;
                varying vec2 vUv1;

                // took from threejs 05fc79cd52b79e8c3e8dec1e7dca72c5c39983a4
                vec4 conv_sRGBToLinear( in vec4 value ) {
                    return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
                }

                void main() {
                    vec2 lUv = vUv1.xy * lightmapScaleOffset.xy + vec2(lightmapScaleOffset.z, (1. - (lightmapScaleOffset.y + lightmapScaleOffset.w)));
                    
                    vec4 lightMapTexel = texture2D( lightMap, lUv);
                    gl_FragColor = lightMapTexel;
                    gl_FragColor.a = 1.;
                }
                `,defines:{USE_LIGHTMAP:""}})}}var Jr=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const ah=k("debugrenderer"),qS=k("debugskinnedmesh"),XS=k("noinstancing"),TD=k("wireframe");var fh;(function(s){s[s.Off=0]="Off",s[s.BlendProbes=1]="BlendProbes",s[s.BlendProbesAndSkybox=2]="BlendProbesAndSkybox",s[s.Simple=3]="Simple"})(fh||(fh={}));class RD{constructor(){a(this,"path",null);a(this,"asset",null);a(this,"default")}}var QS;(function(s){s[s.Both=0]="Both",s[s.Back=1]="Back",s[s.Front=2]="Front"})(QS||(QS={}));class OD{constructor(t,e){a(this,"_renderer");a(this,"_targets",[]);a(this,"_indexMapMaxIndex");a(this,"_indexMap");a(this,"_changed",!1);this._renderer=t;const i=this.setMaterial.bind(this),n=this.getMaterial.bind(this),o=t.gameObject;if(this._targets=[],o)switch(o.type){case"Group":this._targets=[...o.children];break;case"SkinnedMesh":case"Mesh":this._targets.push(o);break}let r=!1,l,c=0;for(let h=0;h<this._targets.length;h++){const d=this._targets[h];if(!d)continue;const u=d.material;if(u){u.shadowSide=u.side;for(let f=0;f<e.length;f++){const p=e[f];if(!p){r=!0;continue}if(u.name===p.name){l===void 0&&(l=new Map),l.set(f,h),c=Math.max(c,f);break}}}}if(r){this._indexMapMaxIndex=c,this._indexMap=l;const h=`Renderer ${t.name} was initialized with missing materials - this may lead to unexpected behaviour when trying to access sharedMaterials by index.`;console.warn(h),_s()&&qe("Found renderer with missing materials: please check the console for details.")}return new Proxy(this,{get(h,d){if(typeof d=="string"){const u=parseInt(d);if(!isNaN(u))return n(u)}return h[d]},set(h,d,u){return typeof d=="string"&&i(u,Number.parseInt(d)),Reflect.set(h,d,u)?(u instanceof Xe&&(h.changed=!0),!0):!1}})}get changed(){return this._changed}set changed(t){t===!0&&ah&&console.warn("SharedMaterials have changed: "+this._renderer.name),this._changed=t}is(t){return this._renderer===t}get length(){return this._indexMapMaxIndex!==void 0?this._indexMapMaxIndex+1:this._targets.length}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.getMaterial(t)}resolveIndex(t){const e=this._indexMap;return e&&e.has(t)?e.get(t):t}setMaterial(t,e){if(e=this.resolveIndex(e),e<0||e>=this._targets.length)return;const i=this._targets[e];!i||i.material===void 0||(i.material=t,this.changed=!0)}getMaterial(t){if(t=this.resolveIndex(t),t<0)return null;const e=this._targets;if(t>=e.length)return null;const i=e[t];return i?i.material:null}}class tt extends W{constructor(){super(...arguments);a(this,"receiveShadows",!1);a(this,"shadowCastingMode",Gm.Off);a(this,"lightmapIndex",-1);a(this,"lightmapScaleOffset",new Ne(1,1,0,0));a(this,"enableInstancing");a(this,"renderOrder");a(this,"allowOcclusionWhenDynamic",!0);a(this,"probeAnchor");a(this,"reflectionProbeUsage",fh.Off);a(this,"_lightmaps");a(this,"_sharedMeshes",[]);a(this,"_sharedMaterials");a(this,"_originalMaterials");a(this,"_probeAnchorLastFrame");a(this,"_lightmapTextureOverride");a(this,"allowProgressiveLoading",!0);a(this,"_firstFrame",-1);a(this,"_isInstancingEnabled",!1);a(this,"_handles");a(this,"_handlesTempArray",[]);a(this,"onBeforeRenderThree",(e,i,n,o,r,l)=>{if(r.envMapIntensity!==void 0){const c=this.hasLightmap?Math.PI:1,h=this.context.scene.environmentIntensity;r.envMapIntensity=Math.max(0,h*this.context.sceneLighting.environmentIntensity/c)}if(this._lightmaps)for(const c of this._lightmaps)c.updateLightmapUniforms(r),c.applyLightmap()});a(this,"_reflectionProbe",null)}static setInstanced(e,i){const n=Bg(e,tt);return n.setInstancingEnabled(i),n}static isInstanced(e){const i=ld(e,tt);return i?i.isInstancingActive:Qs.isUsingInstancing(e)}static setVisible(e,i){Rr(e,i)}get sharedMesh(){if(this.gameObject.type==="Mesh")return this.gameObject;if(this.gameObject.type==="SkinnesMesh")return this.gameObject;if(this.gameObject.type==="Group")return this.gameObject.children[0]}get sharedMeshes(){if(this.destroyed||!this.gameObject)return this._sharedMeshes;if(this._sharedMeshes.length=0,this.gameObject.type==="Group")for(const e of this.gameObject.children)(e.type==="Mesh"||e.type==="SkinnedMesh")&&this._sharedMeshes.push(e);else(this.gameObject.type==="Mesh"||this.gameObject.type==="SkinnedMesh")&&this._sharedMeshes.push(this.gameObject);return this._sharedMeshes}get sharedMaterial(){var e;return(e=this.sharedMaterials)==null?void 0:e[0]}set sharedMaterial(e){this.sharedMaterials[0]!==e&&(this.sharedMaterials[0]=e,this.applyLightmapping())}get material(){var e;return(e=this.sharedMaterials)==null?void 0:e[0]}set material(e){this.sharedMaterial=e}set sharedMaterials(e){if(!this._originalMaterials)this._originalMaterials=e;else if(e){let i=!1;for(let n=0;n<this._sharedMaterials.length;n++){const o=n<e.length?e[n]:null;o&&o instanceof Xe?this.sharedMaterials[n]=o:i||(i=!0,console.warn("Can not assign null as material: "+this.name,o))}}}get sharedMaterials(){if(this._originalMaterials===void 0)if(this.__didAwake)this._originalMaterials=[];else return null;return(!this._sharedMaterials||!this._sharedMaterials.is(this))&&(this._originalMaterials||(this._originalMaterials=[]),this._sharedMaterials=new OD(this,this._originalMaterials)),this._sharedMaterials}static get shouldSuppressInstancing(){return XS}get lightmap(){var e;return(e=this._lightmaps)!=null&&e.length?this._lightmaps[0].lightmap:null}set lightmap(e){var i;if(this._lightmapTextureOverride=e,e===void 0&&(e=this.context.lightmaps.tryGetLightmap(this.sourceId,this.lightmapIndex)),(i=this._lightmaps)!=null&&i.length)for(const n of this._lightmaps)n.lightmap=e}get hasLightmap(){const e=this.lightmap;return e!=null}registering(){this.enabled||this.setVisibility(!1)}awake(){if(this._firstFrame=this.context.time.frame,ah&&console.log("Renderer ",this.name,this),this.clearInstancingState(),this.probeAnchor&&ah&&this.probeAnchor.add(new Wn(.2)),this._reflectionProbe=null,this.isMultiMaterialObject(this.gameObject)){for(const e of this.gameObject.children)this.context.addBeforeRenderListener(e,this.onBeforeRenderThree),e.layers.mask=this.gameObject.layers.mask;if(this.renderOrder!==void 0){let e=0;for(let i=0;i<this.gameObject.children.length;i++){const n=this.gameObject.children[i];if(!(!this.isMeshOrSkinnedMesh(n)||I.getComponent(n,tt))){if(this.renderOrder.length<=e){console.warn("Incorrect renderOrder element count",this,this.renderOrder.length+" but expected "+this.gameObject.children.length,"Index: "+e,"ChildElement:",n);continue}n.renderOrder=this.renderOrder[e],e+=1}}}}else this.isMeshOrSkinnedMesh(this.gameObject)?(this.context.addBeforeRenderListener(this.gameObject,this.onBeforeRenderThree),this.renderOrder!==void 0&&this.renderOrder.length>0&&(this.gameObject.renderOrder=this.renderOrder[0])):this.context.addBeforeRenderListener(this.gameObject,this.onBeforeRenderThree);if(this._lightmaps=void 0,this.applyLightmapping(),TD)for(let e=0;e<this.sharedMaterials.length;e++){const i=this.sharedMaterials[e];i&&(i.wireframe=!0)}}applyLightmapping(){if(this.lightmapIndex>=0&&!this._lightmaps){const e=this._lightmapTextureOverride!==void 0?this._lightmapTextureOverride:this.context.lightmaps.tryGetLightmap(this.sourceId,this.lightmapIndex);if(e){this._lightmaps||(this._lightmaps=[]);const i=new zT(this);i.init(this.lightmapIndex,this.lightmapScaleOffset,e),this._lightmaps.push(i)}else ah&&console.warn(`[Renderer] No lightmaps found ${this.name} (${this.sourceId}, ${this.lightmapIndex})`)}}get isInstancingActive(){return this._handles!=null&&this._handles.length>0&&this._isInstancingEnabled}get instances(){if(!this._handles||this._handles.length<=0)return null;if(this._handlesTempArray.length=0,this._handles)for(const e of this._handles)this._handlesTempArray.push(e);return this._handlesTempArray}setInstancingEnabled(e){if(this._isInstancingEnabled===e)return e&&(this._handles===void 0||this._handles!=null&&this._handles.length>0);if(this._isInstancingEnabled=e,e){if(this.enableInstancing===void 0&&(this.enableInstancing=!0),this._handles===void 0){if(this._handles=Hl.instance.setup(this,this.gameObject,this.context,null,{rend:this,foundMeshes:0,useMatrixWorldAutoUpdate:this.useInstanceMatrixWorldAutoUpdate()}),this._handles)return I.markAsInstancedRendered(this.gameObject,!0),!0}else if(this._handles!==null){for(const i of this._handles)i.updateInstanceMatrix(!0),i.add();return I.markAsInstancedRendered(this.gameObject,!0),!0}}else{if(this._handles)for(const i of this._handles)i.remove(this.destroyed);return!0}return!1}clearInstancingState(){this._isInstancingEnabled=!1,this._handles=void 0}useInstanceMatrixWorldAutoUpdate(){return!0}start(){if(this.enableInstancing&&!XS&&(this.setInstancingEnabled(!0),Qs.markDirty(this.gameObject)),this.gameObject.frustumCulled=this.allowOcclusionWhenDynamic,this.isMultiMaterialObject(this.gameObject))for(let e=0;e<this.gameObject.children.length;e++){const i=this.gameObject.children[e];i.frustumCulled=this.allowOcclusionWhenDynamic}}onEnable(){this.sharedMeshes,this.setVisibility(!0),this._isInstancingEnabled||this.enableInstancing==!0||Array.isArray(this.enableInstancing)&&this.enableInstancing.some(i=>i)?this.__internalDidAwakeAndStart&&this.setInstancingEnabled(!0):this.enabled&&this.applyStencil(),this.updateReflectionProbe()}onDisable(){this.setVisibility(!1),this._handles&&this._handles.length>0&&this.setInstancingEnabled(!1)}onDestroy(){if(this._handles=null,this.isMultiMaterialObject(this.gameObject))for(const e of this.gameObject.children)this.context.removeBeforeRenderListener(e,this.onBeforeRenderThree);else this.context.removeBeforeRenderListener(this.gameObject,this.onBeforeRenderThree)}onBeforeRender(){var e,i,n,o,r;if(this.gameObject){if(this._probeAnchorLastFrame!==this.probeAnchor&&((e=this._reflectionProbe)==null||e.onUnset(this),this.updateReflectionProbe()),ah==this.name&&this.gameObject instanceof le){this.gameObject.geometry.computeBoundingSphere();const l=te(this.gameObject.geometry.boundingSphere.center).applyMatrix4(this.gameObject.matrixWorld);se.DrawWireSphere(l,this.gameObject.geometry.boundingSphere.radius,56831)}if(this.isMultiMaterialObject(this.gameObject)&&((i=this.gameObject.children)==null?void 0:i.length)>0)for(const l of this.gameObject.children)this.applySettings(l);else this.applySettings(this.gameObject);if((n=this.sharedMaterials)!=null&&n.changed&&(this.sharedMaterials.changed=!1,this.applyLightmapping()),(o=this._handles)!=null&&o.length&&this.gameObject[mf]===!0){this.gameObject[mf]=!1;for(let c=this._handles.length-1;c>=0;c--)this._handles[c].updateInstanceMatrix();this.gameObject.matrixWorldNeedsUpdate=!1}if(this._handles&&this._handles.length<=0&&I.markAsInstancedRendered(this.gameObject,!1),this._isInstancingEnabled&&this._handles)for(let l=0;l<this._handles.length;l++){const c=this._handles[l];Rr(c.object,!1)}if(this.reflectionProbeUsage!==fh.Off&&this._reflectionProbe&&((r=this._lightmaps)!=null&&r.length||this._reflectionProbe.onSet(this)),this._sharedMaterials)for(const l of this._sharedMaterials)l&&"envMap"in l&&"envMapIntensity"in l&&!Bo.isUsingReflectionProbe(l)&&(l.envMap=this.context.scene.environment,l.envMapRotation=this.context.scene.environmentRotation);else ah&&console.warn("[Renderer] sharedMaterials not initialized yet: "+this.name)}}onAfterRender(){if(this._isInstancingEnabled&&this._handles)for(let e=0;e<this._handles.length;e++){const i=this._handles[e];Rr(i.object,!0)}this.reflectionProbeUsage!==fh.Off&&this._reflectionProbe&&this._reflectionProbe.onUnset(this),this.static&&this.gameObject.matrixAutoUpdate&&(this.gameObject.matrixAutoUpdate=!1)}applyStencil(){Mu.applyStencil(this)}applySettings(e){e.receiveShadow=this.receiveShadows,this.shadowCastingMode==Gm.On?e.castShadow=!0:e.castShadow=!1}updateReflectionProbe(){this._reflectionProbe=null,this.reflectionProbeUsage!==fh.Off&&(this.startCoroutine(this._updateReflectionProbe(),ge.LateUpdate),this._probeAnchorLastFrame=this.probeAnchor)}*_updateReflectionProbe(){const e=this.probeAnchor||this.gameObject,i=!!this.probeAnchor;this._reflectionProbe=Bo.get(e,this.context,i,this.probeAnchor)}setVisibility(e){if(!this.isMultiMaterialObject(this.gameObject))Rr(this.gameObject,e);else for(const i of this.gameObject.children)this.isMeshOrSkinnedMesh(i)&&Rr(i,e)}isMultiMaterialObject(e){return e.type==="Group"}isMeshOrSkinnedMesh(e){return e.type==="Mesh"||e.type==="SkinnedMesh"}}Jr([g()],tt.prototype,"receiveShadows",void 0);Jr([g()],tt.prototype,"shadowCastingMode",void 0);Jr([g()],tt.prototype,"lightmapIndex",void 0);Jr([g(Ne)],tt.prototype,"lightmapScaleOffset",void 0);Jr([g()],tt.prototype,"enableInstancing",void 0);Jr([g()],tt.prototype,"renderOrder",void 0);Jr([g()],tt.prototype,"allowOcclusionWhenDynamic",void 0);Jr([g(z)],tt.prototype,"probeAnchor",void 0);Jr([g()],tt.prototype,"reflectionProbeUsage",void 0);class Yg extends tt{}class $T extends Yg{constructor(){super(...arguments);a(this,"_needUpdateBoundingSphere",!1)}awake(){var e;super.awake(),qS&&console.log('SkinnedMeshRenderer for "'+this.name+'"',this),this.allowOcclusionWhenDynamic=!1;for(const i of this.sharedMeshes)(e=i.parent)==null||e.updateWorldMatrix(!1,!0),this.markBoundsDirty()}onAfterRender(){if(super.onAfterRender(),this._needUpdateBoundingSphere){for(const e of this.sharedMeshes)if(e instanceof Ia){this._needUpdateBoundingSphere=!1;try{const i=e.geometry,n=d1(e);n&&(e.geometry=n),e.computeBoundingSphere(),e.geometry=i}catch(i){console.error(`Error updating bounding sphere for ${e.name}`,i)}}}if(qS){for(const e of this.sharedMeshes)if(e instanceof Ia&&e.boundingSphere){const i=te(e.boundingSphere.center).applyMatrix4(e.matrixWorld);se.DrawWireSphere(i,e.boundingSphere.radius,"red")}}}markBoundsDirty(){this._needUpdateBoundingSphere=!0}}var Gm;(function(s){s[s.Off=0]="Off",s[s.On=1]="On",s[s.TwoSided=2]="TwoSided",s[s.ShadowsOnly=3]="ShadowsOnly"})(Gm||(Gm={}));var fd=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Hi=k("debugdroplistener");var qm;(function(s){s.FileDropped="file-dropped",s.ObjectAdded="object-added"})(qm||(qm={}));class kD extends CustomEvent{constructor(t){super(qm.ObjectAdded,{detail:t})}}const ED="blob";class Za extends W{constructor(){super(...arguments);a(this,"dropArea");a(this,"fitIntoVolume",!1);a(this,"fitVolumeSize",new R(1,1,1));a(this,"placeAtHitPosition",!0);a(this,"useNetworking",!1);a(this,"onDropped",new je);a(this,"onNetworkEvent",e=>{var i;if(!this.useNetworking){Hi&&console.debug("[DropListener] Ignoring networked event because networking is disabled",e);return}if((i=e.guid)!=null&&i.startsWith(this.guid)){const n=e.url;if(console.debug("[DropListener] Received networked event",e),n)if(Array.isArray(n))for(const o of n)this.addFromUrl(o,{screenposition:new _e,point:e.point,size:e.size},!0);else this.addFromUrl(n,{screenposition:new _e,point:e.point,size:e.size},!0)}});a(this,"handlePaste",e=>{if(this.context.connection.allowEditing===!1||e.defaultPrevented)return;navigator.clipboard.readText().then(n=>{if(n&&(n.startsWith("http")||n.startsWith("https")||n.startsWith("blob"))){const r={screenposition:new _e(this.context.input.mousePosition.x,this.context.input.mousePosition.y)};this.testIfIsInDropArea(r)&&this.addFromUrl(n,r,!1)}}).catch(console.warn)});a(this,"onDrag",e=>{Hi&&console.debug("DropListener Drag",e,this.context.connection.allowEditing),this.context.connection.allowEditing!==!1&&e.preventDefault()});a(this,"onDrop",async e=>{if(Hi&&console.debug("DropListener Drop",e,this.context.connection.allowEditing),this.context.connection.allowEditing===!1||!(e!=null&&e.dataTransfer)||e["droplistener:handled"])return;e.preventDefault();const i={screenposition:new _e(e.offsetX,e.offsetY)};if(this.dropArea&&this.testIfIsInDropArea(i)===!1)return;e["droplistener:handled"]=!0;const n=e.dataTransfer.items;if(!n)return;const o=[];for(const r in n){const l=n[r];if(l.kind==="file"){const c=l.getAsFile();if(!c)continue;o.push(c)}else l.kind==="string"&&l.type=="text/plain"&&l.getAsString(c=>{this.addFromUrl(c,i,!1)})}o.length>0&&await this.addFromFiles(o,i)});a(this,"_abort",null);a(this,"_addedObjects",new Array);a(this,"_addedModels",new Array)}loadFromURL(e,i){return this.addFromUrl(e,{screenposition:new _e,point:i==null?void 0:i.point,size:i==null?void 0:i.size},!1)}forgetObjects(){this.removePreviouslyAddedObjects(!1)}awake(){for(const e of this.gameObject.children)this.dropArea&&e.contains(this.dropArea)||this._addedObjects.push(e)}onEnable(){this.context.renderer.domElement.addEventListener("dragover",this.onDrag),this.context.renderer.domElement.addEventListener("drop",this.onDrop),window.addEventListener("paste",this.handlePaste),this.context.connection.beginListen("droplistener",this.onNetworkEvent),X()&&this.dropArea&&(this.dropArea.getComponentInChildren(tt)||console.warn("[DropListener] The assigned DropArea does not seem to have a renderer/mesh. Drag and Drop events will not be detected."))}onDisable(){this.context.renderer.domElement.removeEventListener("dragover",this.onDrag),this.context.renderer.domElement.removeEventListener("drop",this.onDrop),window.removeEventListener("paste",this.handlePaste),this.context.connection.stopListen("droplistener",this.onNetworkEvent)}async addFromUrl(e,i,n){Hi&&console.log("dropped url",e);try{if(e.startsWith("https://github.com/")){const l=e.split("/"),c=l[3],h=l[4],d=l[6],u=l.slice(7).join("/");e=`https://raw.githubusercontent.com/${c}/${h}/${d}/${u}`}else e.startsWith("https://polyhaven.com/a")&&(e=MD(e));if(!e)return null;const o=e.toLowerCase();if(o.endsWith(".hdr")||o.endsWith(".hdri")||o.endsWith(".exr")||o.endsWith(".png")||o.endsWith(".jpg")||o.endsWith(".jpeg"))return console.warn(`Fileformat is not supported: ${o}`),null;this.removePreviouslyAddedObjects();const r=await Xm.loadFileFromURL(new URL(e),{guid:this.guid,context:this.context,parent:this.gameObject,point:i.point,size:i.size});if(r&&this._addedObjects.length<=0)return i.url=e,this.onObjectLoaded(r,i,n)}catch{console.warn("String is not a valid URL",e)}return null}async addFromFiles(e,i){var n,o;if(Hi&&console.log("Add files",e),!!Array.isArray(e)&&e.length){this.deleteDropEvent(),this.removePreviouslyAddedObjects(),vm(ED,null),(n=this._abort)==null||n.abort("New files dropped"),this._abort=new AbortController;for(const r of e){if(!r)continue;if(r.type.startsWith("image/")){Hi&&console.warn("Ignoring dropped image file",r.name,r.type);continue}else if(r.name.endsWith(".bin")){Hi&&console.warn("Ignoring dropped binary file",r.name,r.type);continue}console.debug("Load file "+r.name+" + "+r.type);const l=await Xm.loadFile(r,this.context,{guid:this.guid});if(l){this.dispatchEvent(new CustomEvent(qm.FileDropped,{detail:r})),i.file=r;const c=this.onObjectLoaded(l,i,!1);c&&this.context.connection.isConnected&&this.useNetworking&&(console.debug("Uploading dropped file to blob storage"),nd.upload(r,{abort:(o=this._abort)==null?void 0:o.signal}).then(h=>{h!=null&&h.download_url&&this._addedObjects.includes(c)&&this.sendDropEvent(h.download_url,c,l.contentMD5)}).catch(console.warn));break}}}}removePreviouslyAddedObjects(e=!0){if(e)for(const i of this._addedObjects)i.parent===this.gameObject&&i.destroy();this._addedObjects.length=0,this._addedModels.length=0}onObjectLoaded(e,i,n){var p,b;const{model:o,contentMD5:r}=e;if(Hi&&console.log(`Dropped ${this.gameObject.name}`,o),!(o!=null&&o.scene))return console.warn("No object specified to add to scene",o),null;this.removePreviouslyAddedObjects();const l=o.scene;l.position.copy(this.gameObject.worldPosition);const c=Lt(this.gameObject);let h=new R(0,0,0);c.x=Math.abs(c.x),c.y=Math.abs(c.y),c.z=Math.abs(c.z);let d=l.scale.clone();const u=new bs().setFromCenterAndSize(new R(0,this.fitVolumeSize.y*c.y*.5,0).add(this.gameObject.worldPosition),this.fitVolumeSize.clone().multiply(c));if(Hi&&se.DrawWireBox3(u,255,5),this.fitIntoVolume&&(ZE(l,u,{position:!this.placeAtHitPosition}),d=l.scale.clone().divide(c),h=l.worldPosition.clone().sub(this.gameObject.worldPosition).divide(c),Hi&&se.DrawSphere(h,.1,16711680,5)),this.gameObject.attach(l),l.position.copy(h),l.quaternion.identity(),l.scale.copy(d),Hi&&se.DrawArrow(this.gameObject.worldPosition,l.getWorldPosition(new R),65280,5),this._addedObjects.push(l),this._addedModels.push(o),this.placeAtHitPosition&&i&&i.screenposition){l.visible=!1;const x=this.context.physics.raycast({screenPoint:this.context.input.convertScreenspaceToRaycastSpace(i.screenposition.clone())});if(l.visible=!0,x&&x.length>0)for(const v of x){const S=v.point.clone();Hi&&console.log("Place object at hit",v),JE(l,S);break}}Hr.autoplayAnimations(o);const f=new kD({sender:this,gltf:o,model:o,object:l,contentMD5:r,dropped:i.file||(i.url?new URL(i.url):void 0)});return this.dispatchEvent(f),(p=this.onDropped)==null||p.invoke(f.detail),!n&&((b=i.url)!=null&&b.startsWith("http"))&&this.context.connection.isConnected&&l&&this.sendDropEvent(i.url,l,r),l}async sendDropEvent(e,i,n){if(!this.useNetworking){Hi&&console.debug("[DropListener] Ignoring networked event because networking is disabled",e);return}if(this.context.connection.isConnected){console.debug('Sending drop event "'+i.name+'"',e);const o=On([i]),r={name:i.name,guid:this.guid,url:e,point:i.worldPosition.clone(),size:o.getSize(new R),contentMD5:n};this.context.connection.send("droplistener",r)}}deleteDropEvent(){this.context.connection.sendDeleteRemoteState(this.guid)}testIfIsInDropArea(e){const i=this.context.input.convertScreenspaceToRaycastSpace(e.screenposition.clone()),n=this.context.physics.raycast({screenPoint:i,recursive:!0,testObject:r=>!this._addedObjects.some(l=>l.contains(r))});if(!n.length)return X()&&console.log(`Dropped outside of drop area for DropListener "${this.name}".`),!1;const o=n[0];return!!(this.dropArea&&this.dropArea.contains(o.object))}}fd([g(z)],Za.prototype,"dropArea",void 0);fd([g()],Za.prototype,"fitIntoVolume",void 0);fd([g(R)],Za.prototype,"fitVolumeSize",void 0);fd([g()],Za.prototype,"placeAtHitPosition",void 0);fd([g()],Za.prototype,"useNetworking",void 0);fd([g(je)],Za.prototype,"onDropped",void 0);function MD(s){if(!s.startsWith("https://polyhaven.com/"))return s;const t="https://dl.polyhaven.org/file/ph-assets/Models/gltf/4k/",n=new URL(s).pathname.split("/").pop(),o=`${t}${n}/${n}_4k.gltf`;return console.log("Resolved polyhaven asset url",s,"‚Üí",o),o}var Xm;(function(s){async function t(i,n,o){const r=o.guid,l=new Ki(r),c=new Blob([i],{type:i.type||aD(i.name)||void 0}),h=URL.createObjectURL(c),d=await Ko().loadSync(n,h,i.name,l).catch(u=>(console.error(`Failed to load file "${i.name}" (${i.type}):`,u),null));return URL.revokeObjectURL(h),d?new Promise((u,f)=>{const p=new FileReader;p.readAsArrayBuffer(i),p.onloadend=async b=>{const x=p.result,v=nd.hashMD5(x);return u({model:d,contentMD5:v})}}):(console.warn(`Failed to load "${i.name}" (${i.type})`),null)}s.loadFile=t;async function e(i,n){return new Promise(async(o,r)=>{const l=new Ki(n.guid),c=i.toString();Hi&&se.DrawWireSphere(n.point,.1,16711680,3);const h=Dl.addPreview({guid:n.guid,parent:n.parent,position:n==null?void 0:n.point,size:n==null?void 0:n.size}),d=await Ko().loadSync(n.context,c,c,l,u=>{h.onProgress(u.loaded/u.total)}).catch(console.warn);if(d){const u=await fetch(c).then(p=>p.arrayBuffer()),f=nd.hashMD5(u);Hi?setTimeout(()=>Dl.removePreview(n.guid),3e3):Dl.removePreview(n.guid),o({model:d,contentMD5:f})}else Hi?setTimeout(()=>Dl.removePreview(n.guid),3e3):Dl.removePreview(n.guid),console.warn("Unsupported file type: "+i.toString())})}s.loadFileFromURL=e})(Xm||(Xm={}));var vv=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Tc extends W{constructor(){super(...arguments);a(this,"parent",null);a(this,"object",null);a(this,"limitCount",60);a(this,"_currentCount",0);a(this,"_startPosition",null);a(this,"_startQuaternion",null);a(this,"_forwardPointerEvents",new Map)}start(){var e,i;if(this._currentCount=0,this._startPosition=null,this._startQuaternion=null,this.object||(this.object=this.gameObject),this.object){if(this.object===this.gameObject){const o=new Ki(this.guid);this.object=I.instantiate(this.object,{idProvider:o,keepWorldPosition:!1});const r=I.getComponent(this.object,Tc);r==null||r.destroy();let l=this.object.getComponentInChildren(si);l||(l=this.object.addComponent(si,{dragMode:qi.SnapToSurfaces}),l.guid=o.generateUUID());let c=I.getComponent(l.gameObject,Zo);c||(c=l.gameObject.addComponent(Zo),c.guid=o.generateUUID())}this.object.visible=!1;const n=this.gameObject.getComponent(si);n&&(n.enabled=!1),this._startPosition=((e=this.object.position)==null?void 0:e.clone())??new R(0,0,0),this._startQuaternion=((i=this.object.quaternion)==null?void 0:i.clone())??new re(0,0,0,1)}this.gameObject.getComponentInParent(ws)||this.gameObject.addComponent(ws)}onEnable(){this.startCoroutine(this.cloneLimitIntervalFn())}onPointerEnter(e){e.used||this.object&&this.context.connection.allowEditing&&e.button===0&&this.context.input.setCursor("pointer")}onPointerExit(e){e.used||this.object&&this.context.connection.allowEditing&&e.button===0&&this.context.input.unsetCursor("pointer")}onPointerDown(e){if(e.used||!this.object||!this.context.connection.allowEditing||e.button!==0)return;const i=this.handleDuplication();if(i){const n=I.getComponent(i,si);n?(n.onPointerDown(e),this._forwardPointerEvents.set(e.event.space,n)):X()&&console.warn(`Duplicated object (${i.name}) does not have DragControls`)}else this._currentCount>=this.limitCount?console.warn(`[Duplicatable] Limit of ${this.limitCount} objects created within a few seconds reached. Please wait a moment before creating more objects.`):console.warn("[Duplicatable] Could not duplicate object.")}onPointerUp(e){if(e.used)return;const i=this._forwardPointerEvents.get(e.event.space);i&&(i.onPointerUp(e),this._forwardPointerEvents.delete(e.event.space))}*cloneLimitIntervalFn(){for(;this.activeAndEnabled&&!this.destroyed;)this._currentCount>0?this._currentCount-=1:this._currentCount<0&&(this._currentCount=0),yield uT(1)}handleDuplication(){var n;if(!this.object||this.limitCount>0&&this._currentCount>=this.limitCount||this.object===this.gameObject)return null;if(I.isDestroyed(this.object))return this.object=null,null;this.object.visible=!0,this._startPosition&&this.object.position.copy(this._startPosition),this._startQuaternion&&this.object.quaternion.copy(this._startQuaternion);const e=new er;this.parent||(this.parent=this.gameObject.parent),this.parent&&(e.parent=this.parent.guid??((n=this.parent.userData)==null?void 0:n.guid),e.keepWorldPosition=!0),e.position=this.worldPosition,e.rotation=this.worldQuaternion,e.context=this.context,this._currentCount+=1;const i=I.instantiateSynced(this.object,e);return console.assert(i!==this.object,"Duplicated object is original"),this.object.visible=!1,this._startPosition&&this.object.position.clone().copy(this._startPosition),this._startQuaternion&&this.object.quaternion.clone().copy(this._startQuaternion),i}}vv([g(z)],Tc.prototype,"parent",void 0);vv([g(z)],Tc.prototype,"object",void 0);vv([g()],Tc.prototype,"limitCount",void 0);var vo;(function(s){s[s.PointerEnter=0]="PointerEnter",s[s.PointerExit=1]="PointerExit",s[s.PointerDown=2]="PointerDown",s[s.PointerUp=3]="PointerUp",s[s.PointerClick=4]="PointerClick",s[s.Drag=5]="Drag",s[s.Drop=6]="Drop",s[s.Scroll=7]="Scroll",s[s.UpdateSelected=8]="UpdateSelected",s[s.Select=9]="Select",s[s.Deselect=10]="Deselect",s[s.Move=11]="Move",s[s.InitializePotentialDrag=12]="InitializePotentialDrag",s[s.BeginDrag=13]="BeginDrag",s[s.EndDrag=14]="EndDrag",s[s.Submit=15]="Submit",s[s.Cancel=16]="Cancel"})(vo||(vo={}));var xv=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class wv{constructor(){a(this,"eventID");a(this,"callback",new je)}}xv([g()],wv.prototype,"eventID",void 0);xv([g(je)],wv.prototype,"callback",void 0);class Sv extends W{constructor(){super(...arguments);a(this,"triggers",[])}invoke(e){var i;if(this.triggers)for(const n of this.triggers)n.eventID===e&&((i=n.callback)==null||i.invoke())}hasTrigger(e){var i;return((i=this.triggers)==null?void 0:i.some(n=>n.eventID===e))??!1}shouldChangeCursor(){return this.hasTrigger(vo.PointerClick)||this.hasTrigger(vo.PointerDown)||this.hasTrigger(vo.PointerUp)}onPointerClick(e){this.invoke(vo.PointerClick)}onPointerEnter(e){this.shouldChangeCursor()&&this.context.input.setCursor("pointer"),this.invoke(vo.PointerEnter)}onPointerExit(e){this.shouldChangeCursor()&&this.context.input.unsetCursor("pointer"),this.invoke(vo.PointerExit)}onPointerDown(e){this.invoke(vo.PointerDown)}onPointerUp(e){this.invoke(vo.PointerUp)}}xv([g(wv)],Sv.prototype,"triggers",void 0);class VT{constructor(t){a(this,"writer");this.writer=t}writeNode(t){}}class AD extends VT{beforeWriteNode(t,e){se.isGizmo(t)&&(e.keep=!1)}}class WT extends VT{beforeWriteTexture(t,e){t.isRenderTargetTexture&&(e.newTexture=rv(new Te(1,1,1,0)))}}function s0(s){const t=Vm.DontExport;return!(s.hideFlags&t)}var HT=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Mp=k("debuggltfexport");class GT extends Nn{constructor(){super(...arguments);a(this,"sceneRoot")}}class Do extends W{constructor(){super(...arguments);a(this,"binary",!0);a(this,"objects",[]);a(this,"ext")}async exportNow(e,i){Mp&&console.log("Exporting objects as glTF",this.objects),e||(e="scene"),(!this.objects||this.objects.length<=0)&&(this.objects=[this.context.scene]);const n={binary:this.binary,pivot:Do.calculateCenter(this.objects),...i},o=await this.export(this.objects,n).catch(r=>(console.error(r),!1));return o===!1?!1:(this.binary?e.endsWith(".glb")||(e+=".glb"):e.endsWith(".gltf")||(e+=".gltf"),this.binary?Do.saveArrayBuffer(o,e):Do.saveJson(o,e),!0)}async export(e,i){if(!e||e.length<=0){console.warn("No objects set to export");return}const n=new l1;n.register(d=>new JC(d)),n.register(d=>new WT(d)),UT(n,this.context),Do.filterTopmostParent(e);const o={trs:!1,onlyVisible:!0,truncateDrawRange:!1,binary:!0,maxTextureSize:1/0,embedImages:!0,includeCustomExtensions:!0,animations:(i==null?void 0:i.animations)||Do.collectAnimations(e),...i},r=new Array,l=new z;i!=null&&i.pivot&&l.position.sub(i.pivot),Mp&&console.log("EXPORT",e),e.forEach(d=>{d&&s0(d)&&(l.children.push(d),d.matrixAutoUpdate=!1,d.matrix.copy(d.matrixWorld),I.getComponentsInChildren(d,tt).forEach(u=>{I.isActiveInHierarchy(u.gameObject)&&u.setInstancingEnabled(!1)}),d.traverse(u=>{if(!s0(u)){const f=u.parent;u.removeFromParent(),r.push(()=>{f&&f.add(u)})}}))});const c=new ZP(l);return i!=null&&i.needleComponents&&(this.ext=new jT),this.ext&&(this.ext.registerExport(n),this.ext.context=c),new Promise((d,u)=>{Mp&&console.log("Starting glTF export.");try{n==null||n.parse(l,f=>{h(),d(f)},f=>{h(),u(f)},o)}catch(f){console.error(f),u(f)}finally{r.forEach(f=>f()),Mp&&console.log("Finished glTF export.")}});function h(){e.forEach(d=>{d&&(d.matrixAutoUpdate=!0,I.getComponentsInChildren(d,tt).forEach(u=>{I.isActiveInHierarchy(u.gameObject)&&u.setInstancingEnabled(!1)}))})}}static saveArrayBuffer(e,i){this.save(new Blob([e],{type:"application/octet-stream"}),i)}static saveJson(e,i){this.save("data: text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e)),i)}static save(e,i){const n=document.createElement("a");n.style.display="none",document.body.appendChild(n),typeof e=="string"?n.href=e:n.href=URL.createObjectURL(e),n.download=i,n.click(),n.remove()}static collectAnimations(e,i){i=i||[];for(const n of e)n&&n.traverseVisible(o=>{o.animations&&o.animations.length>0&&i.push(...o.animations)});return i}static calculateCenter(e,i){const n=i||new R;return n.set(0,0,0),e.forEach(o=>{n.add(ve(o))}),n.divideScalar(e.length),n}static filterTopmostParent(e){if(!(e.length<=0))for(let i=0;i<e.length;i++){let n=e[i];if(!n){e.splice(i,1),i--;continue}for(;n.parent;){if(e.includes(n.parent)){e.splice(i,1),i--;break}n=n.parent}}}}HT([g()],Do.prototype,"binary",void 0);HT([g(z)],Do.prototype,"objects",void 0);typeof globalThis!==void 0&&!("OffscreenCanvas"in globalThis)&&(globalThis.OffscreenCanvas=class{constructor(t,e){a(this,"canvas");return this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this.canvas.convertToBlob=(i,n)=>new Promise(o=>{this.canvas.toBlob(o,i,n)}),this.canvas}});const ID=k("debugprogress");function LD(s){s=s||new Date;const t=s.getMonth()+1,e=s.getDate(),i=s.getHours(),n=s.getMinutes(),o=s.getSeconds(),r=(t<10?"0":"")+t,l=(e<10?"0":"")+e,c=(i<10?"0":"")+i,h=(n<10?"0":"")+n,d=(o<10?"0":"")+o;return s.getFullYear()+r+l+"-"+c+h+d}class Ie{static start(t,e){typeof e=="string"&&(e={parentScope:e});const i=new DD(t,e);uu.set(t,i)}static report(t,e){const i=uu.get(t);if(!i){console.warn("Reporting progress for non-existing scope",t);return}typeof e=="string"&&(e={message:e,autoStep:!0}),i.report(e)}static end(t){const e=uu.get(t);e&&(e.end(),uu.delete(t))}}const uu=new Map;class DD{constructor(t,e){a(this,"scopeLabel");a(this,"parentScope");a(this,"childScopes",[]);a(this,"parentDepth",0);a(this,"lastStep",0);a(this,"lastAutoStepWeight",1);a(this,"lastTotalSteps",0);a(this,"onProgress");a(this,"showLogs",!1);a(this,"selfProgress",0);a(this,"totalProgress",0);a(this,"selfReports",0);a(this,"totalReports",0);this.parentScope=e!=null&&e.parentScope?uu.get(e.parentScope):void 0,this.parentScope&&(this.parentScope.childScopes.push(this),this.parentDepth=this.parentScope.parentDepth+1),this.scopeLabel=" ".repeat(this.parentDepth*2)+t,this.showLogs=(e==null?void 0:e.logTimings)??!!ID,this.showLogs&&console.time(this.scopeLabel),this.onProgress=e==null?void 0:e.onProgress}report(t,e=!1){if(t){if(t.totalSteps!==void 0&&(this.lastTotalSteps=t.totalSteps),t.currentStep!==void 0&&(this.lastStep=t.currentStep),t.autoStep!==void 0){if(t.currentStep===void 0){this.lastStep===void 0&&(this.lastStep=0);const n=typeof t.autoStep=="number"?t.autoStep:1;this.lastStep+=this.lastAutoStepWeight,this.lastAutoStepWeight=n,t.currentStep=this.lastStep}t.totalSteps=this.lastTotalSteps}t.progress!==void 0?this.selfProgress=t.progress:t.currentStep!==void 0&&t.totalSteps!==void 0&&(this.selfProgress=t.currentStep/t.totalSteps)}if(this.childScopes.length>0){let n=0,o=0;for(const l of this.childScopes)n+=l.selfProgress,o+=1;o>0&&(n/=o);const r=this.lastAutoStepWeight/(this.lastTotalSteps??1);this.totalProgress=this.selfProgress+n*r}else this.totalProgress=this.selfProgress;this.selfProgress=Math.min(1,this.selfProgress),this.totalProgress=Math.min(1,this.totalProgress);let i=(this.totalProgress*100).toFixed(3)+"%";this.childScopes.length>0&&(i+=" ("+(this.selfProgress*100).toFixed(3)+"% self)"),t!=null&&t.message&&(i=t.message+" ‚Äì "+i),this.lastStep!==void 0&&this.lastTotalSteps!==void 0&&(i="Step "+(this.lastStep+(this.lastAutoStepWeight!=1?"‚Äì"+(this.lastStep+this.lastAutoStepWeight):"")+"/"+this.lastTotalSteps)+" "+i),e?this.totalReports++:(this.selfReports++,this.totalReports++),this.showLogs&&console.timeLog(this.scopeLabel,i),this.onProgress&&this.onProgress(this.totalProgress),this.parentScope&&this.parentScope.report(void 0,!0)}end(){this.report({progress:1,autoStep:!0},!0),this.showLogs&&(console.timeLog(this.scopeLabel,"Total reports: "+this.totalReports,"Self reports: "+this.selfReports),console.timeEnd(this.scopeLabel));let t=!1;for(const e of this.childScopes)if(!(e.selfProgress>=1)){t=!0;break}t&&console.warn("Progress end with child scopes that are still running",this),this.onProgress=void 0}}const gt="</StageRoot/Materials";function jD(s,t,e){const i=new Map,n=x=>{const v=x.type___needle,S=i.get(v)||new Map;if(i.set(v,S),!S.has(x)){const C=`${v}${S.size?`_${S.size}`:""}`;S.set(x,C)}return S.get(x)},o=s.colorNode?Ap(s.colorNode):[],r=s.colorNode?`color3f inputs:diffuseColor.connect = ${gt}/${t}/${n(o.values().next().value)}.outputs:out>`:"",l=s.roughnessNode?Ap(s.roughnessNode):[],c=s.roughnessNode?`float inputs:roughness.connect = ${gt}/${t}/${n(l.values().next().value)}.outputs:out>`:"",h=s.normalNode?Ap(s.normalNode):[],d=s.normalNode?`float3 inputs:normal.connect = ${gt}/${t}/${n(h.values().next().value)}.outputs:out>`:"",u=s.metalnessNode?Ap(s.metalnessNode):[],f=s.metalnessNode?`float inputs:metallic.connect = ${gt}/${t}/${n(u.values().next().value)}.outputs:out>`:"",p=new Set([...o,...l,...h,...u]),b=UD(p,t,e,n);return console.debug(b),`

	def Material "${t}" ${s.name?`(
		displayName = "${s.name}"
	)`:""}
	{
		token outputs:mtlx:surface.connect = ${gt}/${t}/N_mtlxsurface.outputs:surface>

		def Shader "N_mtlxsurface"
		{
			uniform token info:id = "ND_UsdPreviewSurface_surfaceshader"
			${r}
			${c}
			${d}
			${f}
			token outputs:surface
		}
		
		${b}
		
	}`}function Ap(s){const t=v=>{if(v.nodeType)return v.nodeType;switch(v.type){case"TimerNode":return"float";case"TextureNode":return;case"ConvertNode":return v.convertTo;default:return}},e=v=>{const S=new Set,C=P=>{var E;if(!(!P.isNode||S.has(P))){P.nodeType___needle||(P.nodeType___needle=t(P)),P.shaderNode?(P.type___needle="ShaderCallNodeInternal",P.shaderNodeLayoutName___needle=P.shaderNode.layout.name.slice(3)):P.type___needle=P.type,S.add(P);for(const D in P)(E=P[D])!=null&&E.isNode&&(C(P[D]),P.nodeType___needle||(P.nodeType___needle=P[D].nodeType___needle)),Array.isArray(P[D])&&P[D].forEach(M=>{M.isNode&&(C(M),P.nodeType___needle||(P.nodeType___needle=M.nodeType___needle))})}};return C(v),S},i=v=>{if(v.type==="ConvertNode"){if(v.convertTo===v.node.nodeType___needle)return!0;if(v.node.type==="ConstNode"){if(v.convertTo==="vec4"&&v.node.value.isVector4)return!0;if(v.convertTo==="vec3"&&v.node.value.isVector3)return!0;if(v.convertTo==="vec2"&&v.node.value.isVector2)return!0;if(v.convertTo==="color"&&v.node.value.isColor)return!0;if(v.convertTo==="float"&&typeof v.node.value=="number")return!0}else if(v.node.type=="SplitNode"&&v.convertTo=="float"&&v.node.components.length===1)return!0}return!1},n=v=>{for(;o(v);)!v.node&&v.shaderNode?v=v.inputNodes[0]:v=v.node??v.aNode??v.bNode??v.cNode;return v},o=v=>{const S=["UniformNode","UniformGroupNode","ShaderNodeInternal"];return!v||i(v)||S.includes(v.type___needle)||v.type___needle===void 0},r=(v,S)=>{var C;for(const P of S)for(const E in P){if((C=P[E])!=null&&C.isNode&&P[E]===v)return{parent:P,label:E};if(Array.isArray(P[E])&&P[E].find(M=>M.isNode&&M===v))return{parent:P,label:E}}return null},l=(v,S)=>{if(v.shaderNode)v.inputNodes[0]=n(v.inputNodes[0]);else if(Array.isArray(v.nodes))for(let C=0;C<v.nodes.length;C++)v.nodes[C]&&o(v.nodes[C])&&(v.nodes[C]=n(v.nodes[C]));else S.forEach(C=>{v[C]&&o(v[C])&&(v[C]=n(v[C]))})},c=v=>{v.type==="MathNode"&&v.method==="mix"&&(v.cNode.nodeType___needle="float",v.cNode.type==="ConvertNode"&&(v.cNode.convertTo="float"))},h=(v,S)=>{S.label==="cNode"&&S.parent.type==="MathNode"&&S.parent.method==="mix"||(S.parent.type==="JoinNode"?v.nodeType___needle="float":v.nodeType___needle=S.parent.nodeType___needle)},d=v=>(v==null?void 0:v.type)==="ConvertNode"&&v.nodeType___needle==="color"&&v.node.nodeType___needle==="vec4",u=(v,S)=>{v.convertTo="vec3",v.nodeType___needle="vec3";const C={type:"ConvertNode",convertTo:"color",node:v,isNode:!0,nodeType___needle:"color",type___needle:"ConvertNode"},P=r(v,S);return P!=null&&P.parent&&(P.parent[P.label]=C),C},f=v=>(v==null?void 0:v.type)==="ConvertNode"&&v.node.type==="TextureNode"&&v.nodeType___needle!==v.node.nodeType___needle,p=v=>{const S=new Set;for(let C of v)if(!o(C)){if(c(C),C.type=="SplitNode"){const P=r(C,v);if(C.components.length===1)C.nodeType___needle="float";else if(P)C.nodeType___needle=P.parent.nodeType___needle;else throw new Error("SplitNode without parent found, this should not happen")}if(l(C,["node","aNode","bNode","cNode"]),C.type=="ConstNode"&&C.nodeType==null&&h(C,r(C,v)),d(C)&&S.add(u(C,v)),f(C)){C.node.nodeType___needle=C.convertTo;const P=r(C,v);P!=null&&P.parent&&(P.parent[P.label]=C.node),C=C.node}S.add(C)}return S},b=e(s);return p(b)}function FD(s,t){switch(t){case"float4":return s.isVector4?`(${s.x}, ${s.y}, ${s.z}, ${s.w})`:`(${s}, ${s}, ${s}, ${s})`;case"float3":return s.isVector3?`(${s.x}, ${s.y}, ${s.z})`:`(${s}, ${s}, ${s})`;case"float2":return s.isVector2?`(${s.x}, ${s.y})`:`(${s}, ${s})`;case"color3f":return s.isColor?`(${s.r}, ${s.g}, ${s.b})`:`(${s}, ${s}, ${s})`;default:return s.isVector4||s.isVector3||s.isVector2?`${s.x}`:s.isColor?`${s.r}`:`${s}`}}function BD(s,t,e,i){const n="        ",o=p=>({float:"float",vec2:"vector2",vec3:"vector3",vec4:"vector4",color:"color3"})[p]||"float",r=p=>({float:"float",vec2:"float2",vec3:"float3",vec4:"float4",color:"color3f"})[p]||"float",l=s.type___needle,c=s.nodeType___needle,h=o(c);let d=r(c),u="";const f=new Array;switch(l){case"UniformGroupNode":case"UniformNode":return"";case"TimerNode":u="time_float";break;case"ConstNode":u="constant_"+h,f.push(`${d} inputs:value = ${FD(s.value,d)}`);break;case"JoinNode":u="combine"+s.nodes.length+"_"+h;let p=1;for(const P of s.nodes)f.push(`float inputs:in${p++}.connect = ${gt}/${t}/${e(P)}.outputs:out>`);break;case"ConvertNode":u="convert_"+o(s.node.nodeType___needle)+"_"+h,s.node&&f.push(`${r(s.node.nodeType___needle)} inputs:in.connect = ${gt}/${t}/${e(s.node)}.outputs:out>`);break;case"MathNode":u=s.method+"_"+h,s.aNode&&!s.bNode&&f.push(`${r(s.aNode.nodeType___needle)} inputs:in.connect = ${gt}/${t}/${e(s.aNode)}.outputs:out>`),s.aNode&&s.bNode&&!s.cNode&&(f.push(`${r(s.aNode.nodeType___needle)} inputs:in1.connect = ${gt}/${t}/${e(s.aNode)}.outputs:out>`),f.push(`${r(s.bNode.nodeType___needle)} inputs:in2.connect = ${gt}/${t}/${e(s.bNode)}.outputs:out>`)),s.aNode&&s.bNode&&s.cNode&&s.method=="clamp"&&(f.push(`${r(s.aNode.nodeType___needle)} inputs:in.connect = ${gt}/${t}/${e(s.aNode)}.outputs:out>`),f.push(`${r(s.bNode.nodeType___needle)} inputs:low.connect = ${gt}/${t}/${e(s.bNode)}.outputs:out>`),f.push(`${r(s.cNode.nodeType___needle)} inputs:high.connect = ${gt}/${t}/${e(s.cNode)}.outputs:out>`)),s.aNode&&s.bNode&&s.cNode&&s.method=="mix"&&(f.push(`${r(s.aNode.nodeType___needle)} inputs:fg.connect = ${gt}/${t}/${e(s.bNode)}.outputs:out>`),f.push(`${r(s.bNode.nodeType___needle)} inputs:bg.connect = ${gt}/${t}/${e(s.aNode)}.outputs:out>`),f.push(`float inputs:mix.connect = ${gt}/${t}/${e(s.cNode)}.outputs:out>`));break;case"OperatorNode":let x="";switch(s.op){case"*":x="multiply";break;case"/":x="divide";break;case"+":x="add";break;case"-":x="subtract";break}if(u=x+"_"+h,s.aNode&&!s.bNode&&f.push(`${r(s.aNode.nodeType___needle)} inputs:in.connect = ${gt}/${t}/${e(s.aNode)}.outputs:out>`),s.aNode&&s.bNode){const P=r(s.aNode.nodeType___needle),E=r(s.bNode.nodeType___needle);(P==="color3f"&&E==="float"||E==="float"&&E==="color3f")&&(u=x+"_color3FA"),f.push(`${P} inputs:in1.connect = ${gt}/${t}/${e(s.aNode)}.outputs:out>`),f.push(`${E} inputs:in2.connect = ${gt}/${t}/${e(s.bNode)}.outputs:out>`)}break;case"TextureNode":s.uvNode?(u="tiledimage_"+h,f.push(`float2 inputs:texcoord.connect = ${gt}/${t}/${e(s.uvNode)}.outputs:out>`)):u="image_"+h;const v=s._value,S=Cv.includes(v.format),C=ND(v);f.push(`asset inputs:file = @textures/${C}.${S?"png":"jpg"}@`),i[C]={texture:v,scale:void 0};break;case"NormalMapNode":d="float3",u="normalmap",f.push(`${d} inputs:in.connect = ${gt}/${t}/${e(s.node)}.outputs:out>`);break;case"AttributeNode":u="geompropvalue_"+h,f.push('string inputs:geomprop = "st"');break;case"ShaderCallNodeInternal":u=s.shaderNodeLayoutName___needle+"_"+h,f.push(`${d} inputs:in.connect = ${gt}/${t}/${e(s.inputNodes[0])}.outputs:out>`);break;case"SplitNode":u="swizzle_"+o(s.node.nodeType___needle)+"_"+h,f.push(`${r(s.node.nodeType___needle)} inputs:in.connect = ${gt}/${t}/${e(s.node)}.outputs:out>`),f.push(`string inputs:channels = "${s.components}"`);break}return`
	${n}def Shader "${e(s)}"
	${n}{
		${n}uniform token info:id = "ND_${u}"
		${n}${d} outputs:out
		${n}${f.length>0?f.join(`
				`):""}
	${n}}
	`}function UD(s,t,e,i){let n="";for(const o of s)n+=BD(o,t,i,e);return n}function ND(s){var t;return Ss(s.name)+"_"+(((t=s.source)==null?void 0:t.id)??s.id)}function Ss(s){return s=s.replace(/[^a-zA-Z0-9_]/g,""),s.match(/^[a-zA-Z_]/)||(s="_"+s),s}function qT(s){return s=s.replace('"','\\"'),s}function XT(s){if(s.length===0)return null;const t=s.map(i=>{const n=new Array;for(;i.parent;)n.unshift(i.parent),i=i.parent;return n});return t[0].findLast(i=>t.every(n=>n.includes(i)))||null}function QT(s){const t=XT(s),e=new Set;for(const i of s){let n=i.parent;for(;n&&n!==t;)s.includes(n)||e.add(n),n=n.parent}return e}const zD=new R,$D=new re,VD=new R(1,1,1),zl=class{constructor(t,e,i=null,n=null,o=null,r=null,l=null,c=null){a(this,"uuid");a(this,"name");a(this,"type");a(this,"extraSchemas",[]);a(this,"displayName");a(this,"visibility");a(this,"transform",null);a(this,"_isDynamic");a(this,"geometry");a(this,"material");a(this,"camera");a(this,"parent");a(this,"skinnedMesh");a(this,"children",[]);a(this,"animations");a(this,"_eventListeners");a(this,"needsTranslate",!1);a(this,"needsOrient",!1);a(this,"needsScale",!1);var h,d,u;this.uuid=t,this.name=Ss(e),this.displayName=e,i?this.transform={position:((h=i.position)==null?void 0:h.clone())||null,quaternion:((d=i.quaternion)==null?void 0:d.clone())||null,scale:((u=i.scale)==null?void 0:u.clone())||null}:this.transform=null,this.geometry=n,this.material=o,this.camera=r,this.parent=null,this.children=[],this._eventListeners={},this._isDynamic=!1,this.skinnedMesh=l,this.animations=c}getMatrix(){if(!this.transform)return new xe;const{position:t,quaternion:e,scale:i}=this.transform,n=new xe;return n.compose(t||zD,e||$D,i||VD),n}setMatrix(t){if(!t||!(t instanceof xe)){this.transform=null;return}const e=new R,i=new re,n=new R;t.decompose(e,i,n),this.transform={position:e,quaternion:i,scale:n}}get matrix(){return this.getMatrix()}set matrix(t){this.setMatrix(t)}get isDynamic(){return this._isDynamic}set isDynamic(t){this._isDynamic=t}static createEmptyParent(t){const e=new zl(Ar.generateUUID(),t.name+"_empty_"+zl.USDObject_export_id++,t.transform),i=t.parent;return i&&i.add(e),e.add(t),e.isDynamic=!0,t.transform=null,e}static createEmpty(){const t=new zl(Ar.generateUUID(),"Empty_"+zl.USDObject_export_id++);return t.isDynamic=!0,t}is(t){return t?this.uuid===t.uuid:!1}isEmpty(){return!this.geometry}clone(){const t=new zl(Ar.generateUUID(),this.name,this.transform,this.geometry,this.material);return t.isDynamic=this.isDynamic,t}deepClone(){const t=this.clone();for(const e of this.children)e&&t.add(e.deepClone());return t}getPath(){let t=this.parent,e=this.name;for(;t;)e=(t.parent?t.name:t.name+"/Scenes/Scene")+"/"+e,t=t.parent;return"</"+e+">"}add(t){t.parent&&t.parent.remove(t),t.parent=this,this.children.push(t)}remove(t){const e=this.children.indexOf(t);e>=0&&(t.parent===this&&(t.parent=null),this.children.splice(e,1))}addEventListener(t,e){this._eventListeners[t]||(this._eventListeners[t]=[]),this._eventListeners[t].push(e)}removeEventListener(t,e){if(!this._eventListeners[t])return;const i=this._eventListeners[t].indexOf(e);i>=0&&this._eventListeners[t].splice(i,1)}onSerialize(t,e){const i=this._eventListeners.serialize;i&&i.forEach(n=>n(t,e))}};let Yi=zl;a(Yi,"USDObject_export_id",0);class YT extends Yi{constructor(){super(void 0,"StageRoot",null,null,null,null);a(this,"stageLength");this.children=[],this.stageLength=200}get isDocumentRoot(){return!0}get isDynamic(){return!1}add(e){e.parent=this,this.children.push(e)}remove(e){const i=this.children.indexOf(e);i>=0&&(e.parent===this&&(e.parent=null),this.children.splice(i,1))}traverse(e,i=null){if(i!==null?e(i):i=this,i.children)for(const n of i.children)this.traverse(e,n)}findById(e){let i=!1;function n(o){if(!i){if(o.uuid===e)return i=!0,o;if(o.children)for(const r of o.children){if(!r)continue;const l=n(r);if(l)return l}}}return n(this)}buildHeader(e){var u,f,p;const i=(u=e.extensions)==null?void 0:u.find(b=>(b==null?void 0:b.extensionName)==="animation"),n=(f=e.extensions)==null?void 0:f.find(b=>(b==null?void 0:b.extensionName)==="Behaviour"),o=(p=e.extensions)==null?void 0:p.find(b=>(b==null?void 0:b.extensionName)==="Physics"),r=(i==null?void 0:i.getStartTimeCode())??0,l=(i==null?void 0:i.getEndTimeCode())??0;let c="";const h=i==null?void 0:i.registeredClips;if(h)for(const b of h)c+=`	# Animation: ${b.name}, start=${i.getStartTimeByClip(b)*60}, length=${b.duration*60}
`;const d=c;return`#usda 1.0
(
	customLayerData = {
		string creator = "Needle Engine ${Gn}"
		dictionary Needle = {
			bool animations = ${i?1:0}
			bool interactive = ${n?1:0}
			bool physics = ${o?1:0}
			bool quickLookCompatible = ${e.quickLookCompatible?1:0}
		}
	}
	defaultPrim = "${Ss(this.name)}"
	metersPerUnit = 1
	upAxis = "Y"
	startTimeCode = ${r}
	endTimeCode = ${l}
	timeCodesPerSecond = 60
	framesPerSecond = 60
	doc = """Generated by Needle Engine USDZ Exporter ${Gn}"""
${d}
)
`}}const Yc=`
`,on="</StageRoot/Materials";class WD{constructor(){a(this,"str");a(this,"indent");this.str="",this.indent=0}clear(){this.str="",this.indent=0}beginBlock(t=void 0,e="{",i=!0){t!==void 0?(t=this.applyIndent(t),this.str+=t,i?(this.str+=Yc,this.str+=this.applyIndent(e)):this.str+=" "+e):this.str+=this.applyIndent(e),this.str+=Yc,this.indent+=1}closeBlock(t="}"){this.indent-=1,this.str+=this.applyIndent(t)+Yc}beginArray(t){t=this.applyIndent(t+" = ["),this.str+=t,this.str+=Yc,this.indent+=1}closeArray(){this.indent-=1,this.str+=this.applyIndent("]")+Yc}appendLine(t=""){t=this.applyIndent(t),this.str+=t,this.str+=Yc}toString(){return this.str}applyIndent(t){let e="";for(let i=0;i<this.indent;i++)e+="	";return e+t}}class HD{constructor(t,e,i){a(this,"root");a(this,"exporter");a(this,"extensions",[]);a(this,"quickLookCompatible");a(this,"exportInvisible");a(this,"materials");a(this,"textures");a(this,"files");a(this,"document");a(this,"output");a(this,"animations");this.root=t||void 0,this.exporter=e,this.quickLookCompatible=i.quickLookCompatible,this.exportInvisible=i.exportInvisible,i.extensions&&(this.extensions=i.extensions),this.materials=new Map,this.textures={},this.files={},this.document=new YT,this.output="",this.animations=[]}makeNameSafe(t){return Ss(t)}}const YS=()=>({ar:{anchoring:{type:"plane"},planeAnchoring:{alignment:"horizontal"}},quickLookCompatible:!1,extensions:[],maxTextureSize:4096,exportInvisible:!1});let GD=class{constructor(){a(this,"debug");a(this,"pruneUnusedNodes");a(this,"sceneAnchoringOptions",YS());a(this,"extensions",[]);a(this,"keepObject");a(this,"beforeWritingDocument");this.debug=!1,this.pruneUnusedNodes=!0}async parse(t,e=YS()){var S,C;e=Object.assign({},e),this.sceneAnchoringOptions=e;const i=new HD(t,this,e);this.extensions=i.extensions;const n=i.files,o="model.usda";n[o]=null,i.materials;const r=i.textures;Ie.report("export-usdz","Invoking onBeforeBuildDocument"),await dm(i,"onBeforeBuildDocument"),Ie.report("export-usdz","Done onBeforeBuildDocument"),Ie.report("export-usdz","Reparent bones to common ancestor");const l=[],c=new Set;t==null||t.traverse(P=>{if(!(!e.exportInvisible&&!P.visible)&&P instanceof Ia){const E=P.skeleton.bones,D=XT(E);if(D){const M={object:P,originalParent:P.parent,newParent:D};l.push(M),c.add(M.object.uuid),M.newParent&&c.add(M.newParent.uuid),M.originalParent&&c.add(M.originalParent.uuid)}}});for(const P of l){const{object:E,originalParent:D,newParent:M}=P;M.add(E)}Ie.report("export-usdz","Traversing hierarchy"),t&&KT(t,i.document,i,this.keepObject),Ie.report("export-usdz","Invoking onAfterBuildDocument"),await dm(i,"onAfterBuildDocument");const h=i.extensions.find(P=>P.extensionName==="Behaviour"),d=(h==null?void 0:h.getAllTargetUuids())??new Set;if(this.pruneUnusedNodes){const P={allBehaviorTargets:d,debug:!1,boneReparentings:c,quickLookCompatible:i.quickLookCompatible};this.debug&&KS(i.document,"Hierarchy BEFORE pruning",P),ZT(i.document,P),this.debug&&KS(i.document,"Hierarchy AFTER pruning")}else this.debug&&console.log("Pruning of empty nodes is disabled. This may result in a larger USDZ file.");Ie.report("export-usdz",{message:"Parsing document",autoStep:10}),await qD(i,e),Ie.report("export-usdz","Invoking onAfterSerialize"),await dm(i,"onAfterSerialize");for(const P of l){const{object:E,originalParent:D,newParent:M}=P;D&&D.add(E)}(C=(S=i.exporter)==null?void 0:S.beforeWritingDocument)==null||C.call(S);const f=i.document.buildHeader(i)+`
`+i.output;this.debug&&console.debug(f),n[o]=c1(f),i.output="",Ie.report("export-usdz",{message:"Exporting textures",autoStep:10}),Ie.start("export-usdz-textures",{parentScope:"export-usdz",logTimings:!1});const p=new gc({antialias:!1,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0}),b=Object.keys(r).length;Ie.report("export-usdz-textures",{totalSteps:b*3,currentStep:0});const x=async P=>{const E=r[P],D=E.texture,M=Cv.includes(D.format);let A={imageData:D.image};Ie.report("export-usdz-textures",{message:"read back texture",autoStep:!0});const G=E.scale!==void 0&&E.scale.x!==1&&E.scale.y!==1&&E.scale.z!==1&&E.scale.w!==1;(D.isCompressedTexture||D.isRenderTargetTexture||G)&&(A=await XD(D,e.maxTextureSize,p,E.scale)),Ie.report("export-usdz-textures",{message:"convert texture to canvas",autoStep:!0});const V=await YD(A.imageBitmap||A.imageData,e.maxTextureSize).catch(U=>{console.error("Error converting texture to canvas",D,U)});if(V){Ie.report("export-usdz-textures",{message:"convert canvas to blob",autoStep:!0});const U=await V.convertToBlob({type:M?"image/png":"image/jpeg",quality:.95});n[`textures/${P}.${M?"png":"jpg"}`]=new Uint8Array(await U.arrayBuffer())}else console.warn("Can`t export texture: ",D)};for(const P in r)await x(P);p.dispose(),Ie.end("export-usdz-textures");let v=0;for(const P in n){const E=n[P],D=34+P.length;v+=D;const M=v&63;if(M!==4){const A=64-M,G=new Uint8Array(A);n[P]=[E,{extra:{12345:G}}]}v=E.length}return Ie.report("export-usdz","zip archive"),$k(n,{level:0})}};function KT(s,t,e,i){var c;if(!e.exportInvisible&&!s.visible)return;let n,o,r;const l={position:s.position,quaternion:s.quaternion,scale:s.scale};if(s.position.x===0&&s.position.y===0&&s.position.z===0&&(l.position=null),s.quaternion.x===0&&s.quaternion.y===0&&s.quaternion.z===0&&s.quaternion.w===1&&(l.quaternion=null),s.scale.x===1&&s.scale.y===1&&s.scale.z===1&&(l.scale=null),(s instanceof le||s instanceof Ia)&&(o=s.geometry,r=s.material),i&&!i(s)&&(o=void 0,r=void 0),(s instanceof le||s instanceof Ia)&&r&&typeof r=="object"&&(r instanceof ti||r instanceof Ye||r.isMeshPhysicalNodeMaterial||r instanceof Xe&&r.type==="MeshLineMaterial")){const h=Dp(s),d=s instanceof Ia?s:null;n=new Yi(s.uuid,h,l,o,r,void 0,d,s.animations)}else if(s instanceof Ae||s instanceof _g){const h=Dp(s);n=new Yi(s.uuid,h,l,void 0,void 0,s)}else{const h=Dp(s);n=new Yi(s.uuid,h,l,void 0,void 0,void 0,void 0,s.animations)}if(n){if(n.displayName=((c=s.userData)==null?void 0:c.name)||s.name,n.visibility=s.visible?void 0:"invisible",t&&t.add(n),t=n,e.extensions)for(const h of e.extensions)h.onExportObject&&h.onExportObject.call(h,s,n,e)}else{const h=Dp(s),d=new Yi(s.uuid,h,{position:s.position,quaternion:s.quaternion,scale:s.scale});t&&t.add(d),t=d}for(const h of s.children)KT(h,t,e,i)}function KS(s,t,...e){const i={};let n=0;function o(r,l){n++;let c=r.displayName||r.name;c+=" ("+r.uuid+")",(r.geometry||r.material||r.camera||r.skinnedMesh)&&(c+=" ("+(r.geometry?"geo, ":"")+(r.material?"mat, ":"")+(r.camera?"cam, ":"")+(r.skinnedMesh?"skin, ":"")+")"),l[c]={};const d={object:r};r.material&&(d.mat=!0),r.geometry&&(d.geo=!0),r.camera&&(d.cam=!0),r.skinnedMesh&&(d.skin=!0),l[c]._self=d;for(const u of r.children)u&&o(u,l[c])}o(s,i),console.log(t+" ("+n+" nodes)",i,...e)}function ZT(s,t){var h;let e=!0;const i=new Array,n=new Array;if(s.children.length===0)e=!0;else{const d=[...s.children];for(const u of d)if(u){const f=ZT(u,t);t.debug&&(f?i.push(u):n.push(u)),e=e&&f}}const o=t.allBehaviorTargets.has(s.uuid),r=s.geometry||s.material||s.camera&&!t.quickLookCompatible||s.skinnedMesh||!1,l=t.boneReparentings.has(s.uuid),c=e&&!o&&!r&&!l;return c?(t.debug&&console.log("Pruned object:",(s.displayName||s.name)+" ("+s.uuid+")",{isVisible:r,isBehaviorSourceOrTarget:o,allChildsWerePruned:e,isBoneReparenting:l,object:s,prunedChilds:i,keptChilds:n}),(h=s.parent)==null||h.remove(s)):t.debug&&console.log("Kept object:",(s.displayName||s.name)+" ("+s.uuid+")",{isVisible:r,isBehaviorSourceOrTarget:o,allChildsWerePruned:e,isBoneReparenting:l,object:s,prunedChilds:i,keptChilds:n}),c}async function qD(s,t){Ie.start("export-usdz-resources","export-usdz");const e=[];for(const h of s.document.children)JT(h,s,e);const i=e.length;for(let h=0;h<i;h++)Ie.report("export-usdz-resources",{totalSteps:i,currentStep:h}),await new Promise((d,u)=>{e[h](),d()});Ie.end("export-usdz-resources");const n=new WD,o=s.exporter.sceneAnchoringOptions.ar;n.beginBlock(`def Xform "${s.document.name}"`),n.beginBlock(`def Scope "Scenes" (
		kind = "sceneLibrary"
	)`),n.beginBlock('def Xform "Scene"',"(",!1),n.appendLine('apiSchemas = ["Preliminary_AnchoringAPI"]'),n.appendLine("customData = {"),n.appendLine("	bool preliminary_collidesWithEnvironment = 0"),n.appendLine('	string sceneName = "Scene"'),n.appendLine("}"),n.appendLine('sceneName = "Scene"'),n.closeBlock(")"),n.beginBlock(),n.appendLine(`token preliminary:anchoring:type = "${o.anchoring.type}"`),o.anchoring.type==="plane"&&n.appendLine(`token preliminary:planeAnchoring:alignment = "${o.planeAnchoring.alignment}"`),o.anchoring.type==="image"&&n.appendLine(`rel preliminary:imageAnchoring:referenceImage = </${s.document.name}/Scenes/Scene/AnchoringReferenceImage>`),n.appendLine();const r=h=>{if(!h)return 0;let d=1;for(const u of h.children)d+=r(u);return d},l=r(s.document);Ie.start("export-usdz-xforms","export-usdz"),Ie.report("export-usdz-xforms",{totalSteps:l,currentStep:1});for(const h of s.document.children)eR(h,n,s);Ie.end("export-usdz-xforms"),Ie.report("export-usdz","invoke onAfterHierarchy"),await dm(s,"onAfterHierarchy",n),n.closeBlock(),n.closeBlock(),Ie.report("export-usdz","Building materials");const c=n3(s.materials,s.textures,t.quickLookCompatible);n.appendLine(c),n.closeBlock(),Ie.report("export-usdz","write to string"),s.output+=n.toString()}function JT(s,t,e){if(!s)return;const i=s.geometry,n=s.material;if(i)if(n&&("isMeshStandardMaterial"in n&&n.isMeshStandardMaterial||"isMeshBasicMaterial"in n&&n.isMeshBasicMaterial||n.type==="MeshLineMaterial")){const o="geometries/"+o0(i,s.name)+".usda";if(!(o in t.files)){const r=()=>{var c,h;const l=e3(i,(h=(c=s.skinnedMesh)==null?void 0:c.skeleton)==null?void 0:h.bones,t.quickLookCompatible);t.files[o]=JD(l)};e.push(r)}}else console.warn("NeedleUSDZExporter: Unsupported material type (USDZ only supports MeshStandardMaterial)",n==null?void 0:n.name);n&&t.materials.get(n.uuid)===void 0&&(t.materials[n.uuid]=n);for(const o of s.children)JT(o,t,e)}async function dm(s,t,e=null){if(s.extensions){for(const i of s.extensions)if(i&&typeof i[t]=="function"){const o=i[t].call(i,s,e);o instanceof Promise&&await o}}}let Ip=null,sn=null,Ab,Kc,Lp;async function XD(s,t=1/0,e=null,i=void 0){Ab||(Ab=new to(2,2,1,1)),Kc||(Kc=new Xo({uniforms:{blitTexture:new ys(s),flipY:new ys(!1),scale:new ys(new Ne(1,1,1,1))},vertexShader:`
            varying vec2 vUv;
			uniform bool flipY;
            void main(){
                vUv = uv;
				if (flipY)
					vUv.y = 1. - vUv.y;
                gl_Position = vec4(position.xy * 1.0,0.,.999999);
            }`,fragmentShader:`
            uniform sampler2D blitTexture;
			uniform vec4 scale; 
            varying vec2 vUv;

            void main(){ 
                gl_FragColor = vec4(vUv.xy, 0, 1);
                
                #ifdef IS_SRGB
                gl_FragColor = sRGBTransferOETF( texture2D( blitTexture, vUv) );
                #else
                gl_FragColor = texture2D( blitTexture, vUv);
                #endif
				
				gl_FragColor.rgba *= scale.rgba;
            }`}));const n=Kc.uniforms;n.blitTexture.value=s,n.flipY.value=!1,n.scale.value=new Ne(1,1,1,1),i!==void 0&&n.scale.value.copy(i),Kc.defines.IS_SRGB=s.colorSpace==Vr,Kc.needsUpdate=!0,Lp||(Lp=new le(Ab,Kc),Lp.frustumCulled=!1);const o=new Ae,r=new Xn;r.add(Lp),e||(e=Ip=new gc({antialias:!1,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0}));const l=Math.min(s.image.width,t),c=Math.min(s.image.height,t);sn&&(sn.width!==l||sn.height!==c)&&(sn.dispose(),sn=null),sn||(sn=new Qo(l,c,{format:Sg,type:uk,minFilter:bm,magFilter:bm})),e.setRenderTarget(sn),e.setSize(l,c),e.clear(),e.render(r,o),Ip&&(Ip.dispose(),Ip=null);const h=new Uint8ClampedArray(sn.width*sn.height*4);e.readRenderTargetPixels(sn,0,0,sn.width,sn.height,h);const d=new ImageData(h,sn.width,sn.height,void 0),u=await createImageBitmap(d,{premultiplyAlpha:"none"});return{imageData:d,imageBitmap:u}}function QD(s){return typeof HTMLImageElement<"u"&&s instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&s instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas||typeof ImageBitmap<"u"&&s instanceof ImageBitmap}async function YD(s,t=4096){const e=t/Math.max(s.width,s.height),i=s.width*Math.min(1,e),n=s.height*Math.min(1,e),o=new OffscreenCanvas(i,n),r={premultiplyAlpha:"none"};s.width!==i&&(r.resizeWidth=i),s.height!==n&&(r.resizeHeight=n);const l=await createImageBitmap(s,r),c=o.getContext("bitmaprenderer");return c&&c.transferFromImageBitmap(l),o}async function KD(s,t=void 0,e=!1,i=4096){if(QD(s)){const n=i/Math.max(s.width,s.height),o=new OffscreenCanvas(s.width*Math.min(1,n),s.height*Math.min(1,n)),r=o.getContext("2d",{alpha:!0,premultipliedAlpha:!1});if(!r)throw new Error("Could not get canvas 2D context");if(e===!0&&(r.translate(0,o.height),r.scale(1,-1)),r.drawImage(s,0,0,o.width,o.height),t!==void 0){const l=t.x,c=t.y,h=t.z,d=t.w,u=r.getImageData(0,0,o.width,o.height),f=u.data;for(let p=0;p<f.length;p+=4)f[p+0]=f[p+0]*l,f[p+1]=f[p+1]*c,f[p+2]=f[p+2]*h,f[p+3]=f[p+3]*d;r.putImageData(u,0,0)}return o}else throw new Error("NeedleUSDZExporter: No valid image data found. Unable to process texture.")}const rt=7;function ZD(){return`#usda 1.0
(
    customLayerData = {
        string creator = "Needle Engine USDZExporter"
    }
    metersPerUnit = 1
    upAxis = "Y"
)
`}function JD(s,t){let e=ZD();return e+=s,c1(e)}function Dp(s){return s.name.replace(/[-<>\(\)\[\]¬ß$%&\/\\\=\?\,\;]/g,"")+"_"+s.id}function ZS(s){return Ss(s.name||"bone_"+s.uuid)}function o0(s,t){return Ss(s.name||"Geometry")+"_"+s.id}function Kg(s){return Ss(s.name||"Material")+"_"+s.id}function Bh(s,t){let e=ZS(s),i=s.parent;for(;i&&i!==t;)e=ZS(i)+"/"+e,i=i.parent;return e}function eR(s,t,e){var p;if(s==null)return;Ie.report("export-usdz-xforms",{message:"buildXform "+s.displayName||s.name,autoStep:!0});const i=s.transform,n=s.geometry,o=s.material,r=s.camera,l=s.name;if(s.animations)for(const b of s.animations)e.animations.push(b);const c=n&&n.isBufferGeometry&&n.attributes.skinIndex!==void 0&&n.attributes.skinIndex.count>0,h=c?"SkelRoot":"Xform",d=new Array,u=o&&o instanceof Ye&&o.color&&o.color.r===1&&o.color.g===1&&o.color.b===1&&!o.map&&o.opacity===1&&(n==null?void 0:n.attributes.color);if(n!=null&&n.attributes.color&&!u&&console.warn("NeedleUSDZExporter: Geometry has vertex colors. Vertex colors will only be shown in QuickLook for unlit materials with white color and no texture. Otherwise, they will be ignored.",s.displayName),t.appendLine(),n?(t.beginBlock(`def ${h} "${l}"`,"(",!1),e.quickLookCompatible&&o&&o.side===Qn&&!c?t.appendLine(`prepend references = @./geometries/${o0(n)}.usda@</Geometry_doubleSided>`):t.appendLine(`prepend references = @./geometries/${o0(n)}.usda@</Geometry>`),u||d.push("MaterialBindingAPI"),c&&d.push("SkelBindingAPI")):r&&!e.quickLookCompatible?t.beginBlock(`def Camera "${l}"`,"(",!1):s.type!==void 0?t.beginBlock(`def ${s.type} "${l}"`):t.beginBlock(`def Xform "${l}"`,"(",!1),s.type===void 0&&((p=s.extraSchemas)!=null&&p.length&&d.push(...s.extraSchemas),d.length&&t.appendLine(`prepend apiSchemas = [${d.map(b=>`"${b}"`).join(", ")}]`)),s.displayName&&t.appendLine(`displayName = "${qT(s.displayName)}"`),(r||s.type===void 0)&&(t.closeBlock(")"),t.beginBlock()),n&&o){if(!u){const b=Kg(o);t.appendLine(`rel material:binding = </StageRoot/Materials/${b}>`)}!e.quickLookCompatible&&o.side===Qn&&(t.beginBlock('over "Geometry" '),t.appendLine("uniform bool doubleSided = 1"),t.closeBlock())}let f=!1;if(c?(t.appendLine("rel skel:skeleton = <Rig>"),t.appendLine("rel skel:animationSource = <Rig/_anim>"),f=!1):s.type===void 0&&i&&(f=f||i.position!==null||i.quaternion!==null||i.scale!==null,i.position&&(s.needsTranslate=!0,t.appendLine(`double3 xformOp:translate = (${Ee(i.position.x)}, ${Ee(i.position.y)}, ${Ee(i.position.z)})`)),i.quaternion&&(s.needsOrient=!0,t.appendLine(`quatf xformOp:orient = (${Ee(i.quaternion.w)}, ${Ee(i.quaternion.x)}, ${Ee(i.quaternion.y)}, ${Ee(i.quaternion.z)})`)),i.scale&&(s.needsScale=!0,t.appendLine(`double3 xformOp:scale = (${Ee(i.scale.x)}, ${Ee(i.scale.y)}, ${Ee(i.scale.z)})`))),s.visibility!==void 0&&t.appendLine(`token visibility = "${s.visibility}"`),r&&!e.quickLookCompatible&&("isOrthographicCamera"in r&&r.isOrthographicCamera?(t.appendLine(`float2 clippingRange = (${r.near}, ${r.far})`),t.appendLine(`float horizontalAperture = ${((Math.abs(r.left)+Math.abs(r.right))*10).toPrecision(rt)}`),t.appendLine(`float verticalAperture = ${((Math.abs(r.top)+Math.abs(r.bottom))*10).toPrecision(rt)}`),t.appendLine('token projection = "orthographic"')):"isPerspectiveCamera"in r&&r.isPerspectiveCamera&&(t.appendLine(`float2 clippingRange = (${r.near.toPrecision(rt)}, ${r.far.toPrecision(rt)})`),t.appendLine(`float focalLength = ${r.getFocalLength().toPrecision(rt)}`),t.appendLine(`float focusDistance = ${r.focus.toPrecision(rt)}`),t.appendLine(`float horizontalAperture = ${r.getFilmWidth().toPrecision(rt)}`),t.appendLine('token projection = "perspective"'),t.appendLine(`float verticalAperture = ${r.getFilmHeight().toPrecision(rt)}`))),s.onSerialize&&s.onSerialize(t,e),s.type===void 0){const b=new Array;s.needsTranslate&&b.push('"xformOp:translate"'),s.needsOrient&&b.push('"xformOp:orient"'),s.needsScale&&b.push('"xformOp:scale"'),b.length&&t.appendLine(`uniform token[] xformOpOrder = [${b.join(", ")}]`)}if(s.children){t.appendLine();for(const b of s.children)eR(b,t,e)}t.closeBlock()}function Ee(s){return Number.isInteger(s)?s.toString():s.toFixed(10)}function JS(s){const t=s.elements;return`( ${jp(t,0)}, ${jp(t,4)}, ${jp(t,8)}, ${jp(t,12)} )`}function jp(s,t){return`(${Ee(s[t+0])}, ${Ee(s[t+1])}, ${Ee(s[t+2])}, ${Ee(s[t+3])})`}function e3(s,t=[],e=!0){return`
def "Geometry"
${t3(s,t,e)}
`}function t3(s,t=[],e=!0){const i="Geometry",n=s.attributes,o=n.position.count,r=t&&t.length>0,l=[],c=[];let h=new Array,d=n.skinIndex;if(r){const f=[];for(const v of t)l.push({bone:v,index:t.indexOf(v)}),f.push(v.uuid);let p=1e4;for(;f.length<t.length&&p-- >0;)for(const v of l){const S=v.bone.children;for(const C of S)f.indexOf(C.uuid)===-1&&t.indexOf(C)!==-1&&(l.push({bone:C,index:t.indexOf(C)}),f.push(C.uuid))}p<=0&&console.error("Failed to sort bones in skinned mesh",l,t,f);for(const v of QT(t))l.push({bone:v,index:l.length});const b=l[0].bone.parent;l.sort((v,S)=>Bh(v.bone,b)>Bh(S.bone,b)?1:-1),l.map(v=>'"'+Bh(v.bone,b)+'"').join(", ");for(const v in l)c[l[v].index]=parseInt(v);const x=n.skinIndex;h=new Array;for(let v=0;v<x.count;v++){const S=x.getX(v),C=x.getY(v),P=x.getZ(v),E=x.getW(v);h.push(c[S],c[C],c[P],c[E])}d=new Cn(new Uint16Array(h),4)}const u=n.skinWeight&&n.skinIndex;return`
{	
    def Mesh "${i}" ${u?`(
        prepend apiSchemas = ["SkelBindingAPI"]
    )`:""}
    {
        int[] faceVertexCounts = [${Ib(s)}]
        int[] faceVertexIndices = [${Lb(s)}]
		${n.normal||e?`normal3f[] normals = [${um(n.normal,o)}] (
            interpolation = "vertex"
        )`:""}
        point3f[] points = [${um(n.position,o)}]
        ${n.uv?`texCoord2f[] primvars:st = [${tR(n.uv,o,!0)}] (
            interpolation = "vertex"
        )`:""}
		${n.uv1?Db("st1",n.uv1):""}
		${n.uv2?Db("st2",n.uv2):""}
		${n.uv3?Db("st3",n.uv3):""}
		${u?`matrix4d primvars:skel:geomBindTransform = ( (1, 0, 0, 0), (0, 1, 0, 0), (0, 0, 1, 0), (0, 0, 0, 1) ) (
				elementSize = 1
				interpolation = "constant"
			)`:""}
		${n.skinIndex?`int[] primvars:skel:jointIndices = [${eC(d,!0)}] (
			elementSize = 4
			interpolation = "vertex"
		)`:""}
		${n.skinWeight?`float[] primvars:skel:jointWeights = [${eC(n.skinWeight)}] (
			elementSize = 4
			interpolation = "vertex"
		)`:""}
		${n.color?`color3f[] primvars:displayColor = [${um(n.color,o)}] (
			interpolation = "vertex"
		)`:""}
        uniform token subdivisionScheme = "none"
    }
}
${e?`
# This is a workaround for QuickLook/RealityKit not supporting the doubleSided attribute. We're adding a second
# geometry definition here, that uses the same mesh data but appends extra faces with reversed winding order.
def "${i}_doubleSided" (
	prepend references = </Geometry>
)
{
	over "Geometry"
	{
		int[] faceVertexCounts = [${Ib(s)+", "+Ib(s)}]
		int[] faceVertexIndices = [${Lb(s)+", "+Lb(s,!0)}]
	}
}
`:""}
`}function Ib(s){const t=s.index!==null?s.index.count:s.attributes.position.count;return Array(Math.floor(t/3)).fill(3).join(", ")}function Lb(s,t=!1){const e=s.index,i=[];if(e!==null)for(let n=0;n<e.count;n++){let o=n;t&&(o=n%3===0?n+2:n%3===2?n-2:n),i.push(e.getX(o))}else{const n=s.attributes.position.count;for(let o=0;o<n;o++){let r=o;t&&(r=o%3===0?o+2:o%3===2?o-2:o),i.push(r)}}return i.join(", ")}function Db(s,t){const e=t.itemSize;switch(e){case 2:return`texCoord2f[] primvars:${s} = [${tR(t,e,!0)}] (
				interpolation = "vertex"
			)`;case 3:return`texCoord3f[] primvars:${s} = [${um(t,e)}] (
				interpolation = "vertex"
			)`;case 4:return`double4[] primvars:${s} = [${i3(t,e)}] (
				interpolation = "vertex"
			)`;default:return console.warn("USDZExporter: Attribute with "+e+" components are currently not supported. Results may be undefined for "+s+"."),""}}function um(s,t){if(s===void 0)return console.warn("USDZExporter: A mesh attribute is missing and will be set with placeholder data. The result may look incorrect."),Array(t).fill("(0, 0, 1)").join(", ");const e=[];for(let i=0;i<s.count;i++){const n=s.getX(i),o=s.getY(i),r=s.getZ(i);e.push(`(${n.toPrecision(rt)}, ${o.toPrecision(rt)}, ${r.toPrecision(rt)})`)}return e.join(", ")}function i3(s,t){if(s===void 0)return console.warn("USDZExporter: Attribute is missing. Results may be undefined."),Array(t).fill("(0, 0, 0, 0)").join(", ");const e=[];for(let i=0;i<s.count;i++){const n=s.getX(i),o=s.getY(i),r=s.getZ(i)||0,l=s.getW(i)||0;e.push(`(${n.toPrecision(rt)}, ${o.toPrecision(rt)}, ${r.toPrecision(rt)}, ${l.toPrecision(rt)})`)}return e.join(", ")}function eC(s,t=!1){const e=[];for(let i=0;i<s.count;i++){const n=s.getX(i),o=s.getY(i),r=s.getZ(i),l=s.getW(i);e.push(`${t?n:n.toPrecision(rt)}`),e.push(`${t?o:o.toPrecision(rt)}`),e.push(`${t?r:r.toPrecision(rt)}`),e.push(`${t?l:l.toPrecision(rt)}`)}return e.join(", ")}function tR(s,t,e=!1){if(s===void 0)return console.warn("USDZExporter: UVs missing."),Array(t).fill("(0, 0)").join(", ");const i=[];for(let n=0;n<s.count;n++){const o=s.getX(n);let r=s.getY(n);e&&(r=1-r),i.push(`(${o.toPrecision(rt)}, ${r.toPrecision(rt)})`)}return i.join(", ")}function n3(s,t,e=!1){const i=[];for(const n in s){const o=s[n];i.push(s3(o,t,e))}return`
	def "Materials"
    {
${i.join("")}
    }`}function hs(s){var t;return Ss(s.name)+"_"+(((t=s.source)==null?void 0:t.id)??s.id)}function ca(s,t,e,i,n,o,r=void 0,l=void 0){const c=hs(s),h=c+(l!==void 0&&l!==1?"_"+l:""),d=e&&l!==void 0&&l!==1,u=d?new Ne(1,1,1,l):void 0;l===void 0&&(l=1),d&&(l=1),u&&u.w<=.05&&(u.w=.05),i[h]={texture:s,scale:u};const f=s.channel>0?"st"+s.channel:"st";o.add(s.channel);const p=Cv.includes(s.format),b={1e3:"repeat",1001:"clamp",1002:"mirror"},x=s.repeat.clone(),v=s.offset.clone(),S=s.rotation,C=Math.sin(S),P=Math.cos(S);v.y=1-v.y-x.y,e?(x.x===0&&(x.x=1e-4),x.y===0&&(x.y=1e-4),v.x=v.x/x.x,v.y=v.y/x.y,v.x+=C/x.x,v.y+=P-1):(v.x+=C*x.x,v.y+=(1-P)*x.y);const E=Kg(n),D=x.x!=1||x.y!=1||v.x!=0||v.y!=0||S!=0,M=`${on}/${E}/${"uvReader_"+f}.outputs:result>`,A=`${on}/${E}/Transform2d_${t}.outputs:result>`,G=t!=="normal"&&r&&(r.r!==1||r.g!==1||r.b!==1||l!==1)||!1,V=t==="normal",U=n instanceof ti&&n.normalScale?n.normalScale.x*2:2,$=U.toFixed(rt),Y=(-1*(U/2)).toFixed(rt),B=(1-U).toFixed(rt);return`
		${D?`def Shader "Transform2d_${t}" (
			sdrMetadata = {
				string role = "math"
			}
		)
		{
			uniform token info:id = "UsdTransform2d"
			float2 inputs:in.connect = ${M}
			float2 inputs:scale = ${iC(x)}
			float2 inputs:translation = ${iC(v)}
			float inputs:rotation = ${(S/Math.PI*180).toFixed(rt)}
			float2 outputs:result
		}
		`:""}
		def Shader "${c}_${t}"
		{
			uniform token info:id = "UsdUVTexture"
			asset inputs:file = @textures/${h}.${p?"png":"jpg"}@
			token inputs:sourceColorSpace = "${s.colorSpace==="srgb"?"sRGB":"raw"}"
			float2 inputs:st.connect = ${D?A:M}
			${G?`
			float4 inputs:scale = (${r?r.r+", "+r.g+", "+r.b:"1, 1, 1"}, ${l})
			`:""}
			${V?`
			float4 inputs:scale = (${$}, ${$}, ${$}, 1)
			float4 inputs:bias = (${Y}, ${Y}, ${B}, 0)
			`:""}
			token inputs:wrapS = "${b[s.wrapS]}"
			token inputs:wrapT = "${b[s.wrapT]}"
			float outputs:r
			float outputs:g
			float outputs:b
			float3 outputs:rgb
			${n.transparent||n.alphaTest>0?"float outputs:a":""}
		}`}function s3(s,t,e=!1){var f,p,b;const i=Kg(s);if(s.colorWrite===!1||((f=s.userData)==null?void 0:f.isShadowCatcherMaterial)||((p=s.userData)==null?void 0:p.isLightBlendMaterial)){const x=s.userData.isLightBlendMaterial||s.userData.isShadowCatcherMaterial?"ND_realitykit_shadowreceiver_surfaceshader":"ND_realitykit_occlusion_surfaceshader";return`

		def Material "${i}" ${s.name?`(
			displayName = "${s.name}"
		)`:""}
		{
			token outputs:mtlx:surface.connect = ${on}/${i}/Occlusion.outputs:out>

			def Shader "Occlusion"
			{
				uniform token info:id = "${x}"
				token outputs:out
			}
		}`}const o="                ",r=[],l=[],c=new Set;if(s.isMeshPhysicalNodeMaterial===!0)return jD(s,i,t);let h=s.transparent||s.alphaTest?s.opacity:1,d=!1,u=!1;if(s instanceof c_&&s.transmission!==void 0&&(h*=1-s.transmission*(1-s.roughness*.5)),s.map?(r.push(`${o}color3f inputs:diffuseColor.connect = ${on}/${i}/${hs(s.map)}_diffuse.outputs:rgb>`),s instanceof Ye&&s.transparent&&s.alphaTest==0&&e?(r.push(`${o}float inputs:opacity.connect = ${on}/${i}/${hs(s.map)}_diffuse.outputs:a>`),d=!0,r.push(`${o}float inputs:opacityThreshold = ${1e-10}`),u=!0):s.transparent?(r.push(`${o}float inputs:opacity.connect = ${on}/${i}/${hs(s.map)}_diffuse.outputs:a>`),d=!0):s.alphaTest>0&&(r.push(`${o}float inputs:opacity.connect = ${on}/${i}/${hs(s.map)}_diffuse.outputs:a>`),d=!0,r.push(`${o}float inputs:opacityThreshold = ${s.alphaTest}`),u=!0),l.push(ca(s.map,"diffuse",e,t,s,c,s.color,h))):r.push(`${o}color3f inputs:diffuseColor = ${tC(s.color)}`),s.alphaHash&&e&&(u?console.warn("Opacity threshold for "+s.name+" was already connected. Skipping alphaHash opacity threshold."):(r.push(`${o}float inputs:opacityThreshold = 0.0000000001`),u=!0)),s.aoMap&&(r.push(`${o}float inputs:occlusion.connect = ${on}/${i}/${hs(s.aoMap)}_occlusion.outputs:r>`),l.push(ca(s.aoMap,"occlusion",e,t,s,c))),s.alphaMap?(r.push(`${o}float inputs:opacity.connect = ${on}/${i}/${hs(s.alphaMap)}_opacity.outputs:r>`),r.push(`${o}float inputs:opacityThreshold = 0.0000000001`),d=!0,u=!0,l.push(ca(s.alphaMap,"opacity",e,t,s,c,new Se(1,1,1),h))):(d?console.warn("Opacity for "+s.name+" was already connected. Skipping default opacity."):(r.push(`${o}float inputs:opacity = ${h}`),d=!0),s.alphaTest>0&&(u?console.warn("Opacity threshold for "+s.name+" was already connected. Skipping default opacity threshold."):(r.push(`${o}float inputs:opacityThreshold = ${s.alphaTest}`),u=!0))),s instanceof ti){if(s.emissiveMap){r.push(`${o}color3f inputs:emissiveColor.connect = ${on}/${i}/${hs(s.emissiveMap)}_emissive.outputs:rgb>`);const x=s.emissive.clone();x.multiplyScalar(s.emissiveIntensity),l.push(ca(s.emissiveMap,"emissive",e,t,s,c,x))}else if(((b=s.emissive)==null?void 0:b.getHex())>0){const x=s.emissive.clone();x.multiplyScalar(s.emissiveIntensity),r.push(`${o}color3f inputs:emissiveColor = ${tC(x)}`)}s.normalMap&&(r.push(`${o}normal3f inputs:normal.connect = ${on}/${i}/${hs(s.normalMap)}_normal.outputs:rgb>`),l.push(ca(s.normalMap,"normal",e,t,s,c))),s.roughnessMap&&s.roughness===1?(r.push(`${o}float inputs:roughness.connect = ${on}/${i}/${hs(s.roughnessMap)}_roughness.outputs:g>`),l.push(ca(s.roughnessMap,"roughness",e,t,s,c))):r.push(`${o}float inputs:roughness = ${s.roughness!==void 0?s.roughness:1}`),s.metalnessMap&&s.metalness===1?(r.push(`${o}float inputs:metallic.connect = ${on}/${i}/${hs(s.metalnessMap)}_metallic.outputs:b>`),l.push(ca(s.metalnessMap,"metallic",e,t,s,c))):r.push(`${o}float inputs:metallic = ${s.metalness!==void 0?s.metalness:0}`)}return s instanceof c_&&(r.push(`${o}float inputs:clearcoat = ${s.clearcoat}`),r.push(`${o}float inputs:clearcoatRoughness = ${s.clearcoatRoughness}`),r.push(`${o}float inputs:ior = ${s.ior}`),!s.transparent&&!(s.alphaTest>0)&&s.transmissionMap&&(r.push(`${o}float inputs:opacity.connect = ${on}/${i}/${hs(s.transmissionMap)}_transmission.outputs:r>`),l.push(ca(s.transmissionMap,"transmission",e,t,s,c)))),c.size>2?console.warn("USDZExporter: Material "+s.name+" uses more than 2 UV channels. Currently, only UV0 and UV1 are supported."):c.size===2&&(!c.has(0)||!c.has(1))&&console.warn("USDZExporter: Material "+s.name+" uses UV channels other than 0 and 1. Currently, only UV0 and UV1 are supported."),`

		def Material "${i}" ${s.name?`(
			displayName = "${qT(s.name)}"
		)`:""}
		{
			token outputs:surface.connect = ${on}/${i}/PreviewSurface.outputs:surface>

			def Shader "PreviewSurface"
			{
				uniform token info:id = "UsdPreviewSurface"
${r.join(`
`)}
				int inputs:useSpecularWorkflow = ${s instanceof Ye?"1":"0"}
				token outputs:surface
			}
${l.length>0?`
${c.has(0)?`
			def Shader "uvReader_st"
			{
				uniform token info:id = "UsdPrimvarReader_float2"
				token inputs:varname = "st"
				float2 inputs:fallback = (0.0, 0.0)
				float2 outputs:result
			}
`:""}
${c.has(1)?`
			def Shader "uvReader_st1"
			{
				uniform token info:id = "UsdPrimvarReader_float2"
				token inputs:varname = "st1"
				float2 inputs:fallback = (0.0, 0.0)
				float2 outputs:result
			}
`:""}
${l.join(`
`)}`:""}
		}`}function tC(s){return`(${s.r}, ${s.g}, ${s.b})`}function iC(s){return`(${s.x}, ${s.y})`}const Cv=[1023,33777,33778,33779,35842,35843,37496,37808,37809,37810,37811,37812,37813,37814,37815,37816,37817,37818,37819,37820,37821,36492];k("debugusdz");const lx=class{constructor(t,e,i){a(this,"id");a(this,"trigger");a(this,"action");a(this,"exclusive",!1);this.id="Behavior_"+Ss(t)+"_"+lx.global_id++,this.trigger=e,this.action=i}makeExclusive(t){return this.exclusive=t,this}writeTo(t,e,i){if(!this.trigger||!this.action)return;i.beginBlock(`def Preliminary_Behavior "${this.id}"`);let n="";if(Array.isArray(this.trigger)){n="[";for(let o=0;o<this.trigger.length;o++){const r=this.trigger[o];n+="<"+r.id+">",o+1<this.trigger.length&&(n+=", ")}n+="]"}else n=`<${this.trigger.id}>`;if(i.appendLine(`rel triggers = ${n}`),i.appendLine(`rel actions = <${this.action.id}>`),i.appendLine(`uniform bool exclusive = ${this.exclusive?1:0}`),i.appendLine(),Array.isArray(this.trigger))for(const o of this.trigger)o.writeTo(e,i),i.appendLine();else this.trigger.writeTo(e,i);i.appendLine(),this.action.writeTo(e,i),i.closeBlock()}};let ki=lx;a(ki,"global_id",0);const Zc=new Set;function r0(s,t){var i,n;let e="";if(Array.isArray(s)){Zc.clear();let o="[ ";for(let r=0;r<s.length;r++){let l=s[r];if(!l){console.warn("Invalid target object in behavior",s+". Is the object exported?");continue}if(typeof l=="string"){if(Zc.has(l))continue;o+=l,Zc.add(l)}else if(typeof l=="object"){if(l.isObject3D&&(l=t.findById(l.uuid),!l)){console.warn("Invalid target object in behavior",s+". Is the object exported?");continue}const c=(i=l.getPath)==null?void 0:i.call(l);if(Zc.has(c))continue;o+=c,Zc.add(c)}r+1<s.length&&(o+=", ")}o+=" ]",e=o,Zc.clear()}else if(typeof s=="object"){const o=s;if(o.isObject3D&&(s=t.findById(o.uuid)),!s)throw console.error("Invalid target object in behavior, the target object is likely missing from USDZ export. Is the object exported?",o),new Error(`Invalid target object in behavior, the target object is likely missing from USDZ export. Please report a bug. uuid: ${o.uuid}.`);e=(n=s.getPath)==null?void 0:n.call(s)}return e}const cx=class{constructor(t,e){a(this,"id");a(this,"targetId");a(this,"tokenId");a(this,"type");a(this,"distance");t&&(this.targetId=t),e?this.id=e:this.id="Trigger_"+cx.global_id++}writeTo(t,e){e.beginBlock(`def Preliminary_Trigger "${this.id}"`),this.targetId&&(typeof this.targetId!="string"&&(this.targetId=r0(this.targetId,t)),e.appendLine("rel affectedObjects = "+this.targetId)),this.tokenId&&e.appendLine(`token info:id = "${this.tokenId}"`),this.type&&e.appendLine(`token type = "${this.type}"`),typeof this.distance=="number"&&e.appendLine(`double distance = ${this.distance}`),e.closeBlock()}};let Na=cx;a(Na,"global_id",0);function nC(s,t={direct:!0,indirect:!0}){const e=Yi.createEmpty();e.name="InputTarget_"+e.name,e.displayName=void 0,e.type="RealityKitComponent",e.onSerialize=i=>{i.appendLine("bool allowsDirectInput = "+(t.direct?1:0)),i.appendLine("bool allowsIndirectInput = "+(t.indirect?1:0)),i.appendLine('uniform token info:id = "RealityKit.InputTarget"')},s.add(e)}class Zi{static sceneStartTrigger(){if(this.__sceneStartTrigger!==void 0)return this.__sceneStartTrigger;const t=new Na(void 0,"SceneStart");return t.tokenId="SceneTransition",t.type="enter",this.__sceneStartTrigger=t,t}static tapTrigger(t,e={direct:!0,indirect:!0}){const i=new Na(t);if(Array.isArray(t)&&t.length>1)for(const n of t)n instanceof Yi&&nC(n,e);else t instanceof Yi&&nC(t,e);return i.tokenId="TapGesture",i}static isTapTrigger(t){return(t==null?void 0:t.tokenId)==="TapGesture"}static proximityToCameraTrigger(t,e){const i=new Na(t);return i.tokenId="ProximityToCamera",i.distance=e,i}}a(Zi,"__sceneStartTrigger");class Gl{constructor(t,e){a(this,"id");a(this,"actions");a(this,"loops",0);a(this,"performCount",1);a(this,"type","serial");a(this,"multiplePerformOperation");this.id=t,this.actions=e}static getId(){return this.global_id++}addAction(t){return this.actions.push(t),this}makeParallel(){return this.type="parallel",this}makeSequence(){return this.type="serial",this}makeLooping(){return this.loops=1,this.performCount=0,this}makeRepeat(t){return this.performCount=t,this}writeTo(t,e){e.beginBlock(`def Preliminary_Action "${this.id}"`),e.beginArray("rel actions");for(const i of this.actions){if(!i)continue;const n=i===this.actions[this.actions.length-1];e.appendLine("<"+i.id+">"+(n?"":", "))}e.closeArray(),e.appendLine(),e.appendLine('token info:id = "Group"'),e.appendLine(`bool loops = ${this.loops}`),e.appendLine(`int performCount = ${this.loops>0?0:Math.max(0,this.performCount)}`),e.appendLine(`token type = "${this.type}"`),typeof this.multiplePerformOperation=="string"&&e.appendLine(`token multiplePerformOperation = "${this.multiplePerformOperation}"`),e.appendLine();for(const i of this.actions)i&&(i.writeTo(t,e),e.appendLine());e.closeBlock()}}a(Gl,"global_id",0);const hg=class{constructor(t,e){a(this,"id");a(this,"tokenId");a(this,"affectedObjects");a(this,"easeType");a(this,"motionType");a(this,"duration");a(this,"moveDistance");a(this,"style");a(this,"type");a(this,"front");a(this,"up");a(this,"start");a(this,"animationSpeed");a(this,"reversed");a(this,"pingPong");a(this,"xFormTarget");a(this,"audio");a(this,"gain");a(this,"auralMode");a(this,"multiplePerformOperation");a(this,"velocity");a(this,"comment");a(this,"animationName");t&&(this.affectedObjects=t),e?this.id=e:this.id="Action",this.id+="_"+hg.global_id++}clone(){const t=new hg,e=t.id;return Object.assign(t,this),t.id=e,t}writeTo(t,e){e.beginBlock(`def Preliminary_Action "${this.id}"`),this.comment&&e.appendLine(`# ${this.comment}`),this.affectedObjects&&(typeof this.affectedObjects!="string"&&(this.affectedObjects=r0(this.affectedObjects,t)),e.appendLine("rel affectedObjects = "+this.affectedObjects)),typeof this.duration=="number"&&(typeof this.animationSpeed=="number"&&this.animationSpeed!==1?e.appendLine(`double duration = ${this.duration/this.animationSpeed} `):e.appendLine(`double duration = ${this.duration} `)),this.easeType&&e.appendLine(`token easeType = "${this.easeType}"`),this.tokenId&&e.appendLine(`token info:id = "${this.tokenId}"`),this.tokenId==="ChangeScene"&&e.appendLine("rel scene = </StageRoot/Scenes/Scene>"),this.motionType!==void 0&&e.appendLine(`token motionType = "${this.motionType}"`),typeof this.moveDistance=="number"&&e.appendLine(`double moveDistance = ${this.moveDistance} `),this.style&&e.appendLine(`token style = "${this.style}"`),this.type&&e.appendLine(`token type = "${this.type}"`),this.front&&e.appendLine(`vector3d front = (${this.front.x}, ${this.front.y}, ${this.front.z})`),this.up&&e.appendLine(`vector3d upVector = (${this.up.x}, ${this.up.y}, ${this.up.z})`),typeof this.start=="number"&&e.appendLine(`double start = ${this.start} `),typeof this.animationSpeed=="number"&&e.appendLine(`double animationSpeed = ${this.animationSpeed.toFixed(2)} `),typeof this.reversed=="boolean"&&e.appendLine(`bool reversed = ${this.reversed}`),typeof this.pingPong=="boolean"&&e.appendLine(`bool reverses = ${this.pingPong}`),this.xFormTarget&&(typeof this.xFormTarget!="string"&&(this.xFormTarget=r0(this.xFormTarget,t)),e.appendLine(`rel xformTarget = ${this.xFormTarget}`)),typeof this.audio=="string"&&e.appendLine(`asset audio = @${this.audio}@`),typeof this.gain=="number"&&e.appendLine(`double gain = ${this.gain}`),typeof this.auralMode=="string"&&e.appendLine(`token auralMode = "${this.auralMode}"`),typeof this.multiplePerformOperation=="string"&&e.appendLine(`token multiplePerformOperation = "${this.multiplePerformOperation}"`),typeof this.velocity=="object"&&e.appendLine(`vector3d velocity = (${this.velocity.x}, ${this.velocity.y}, ${this.velocity.z})`),e.closeBlock()}};let Bn=hg;a(Bn,"global_id",0);class gs{constructor(t,e,i){a(this,"x",0);a(this,"y",0);a(this,"z",0);this.x=t,this.y=e,this.z=i}static get up(){return new gs(0,1,0)}static get right(){return new gs(1,0,0)}static get forward(){return new gs(0,0,1)}static get back(){return new gs(0,0,-1)}static get zero(){return new gs(0,0,0)}}class Ve{static sequence(...t){return new Gl("Group_"+Gl.getId(),t).makeSequence()}static parallel(...t){return new Gl("Group_"+Gl.getId(),t).makeParallel()}static fadeAction(t,e,i){const n=new Bn(t);return n.tokenId="Visibility",n.type=i?"show":"hide",n.duration=e,n.style="basic",n.motionType="none",n.moveDistance=0,n.easeType="none",n}static startAnimationAction(t,e,i=!1,n=!1){const o=new Bn(t);o.tokenId="StartAnimation";const r=e.start,l=e.duration,c=e.speed,h=e.clipName;if(o.comment=`Animation: ${h}, start=${r*60}, length=${l*60}, end=${(r+l)*60}`,o.animationName=h,o.start=r,o.duration=l,o.animationSpeed=c,o.reversed=i,o.pingPong=n,o.multiplePerformOperation="allow",i&&(o.start-=l),n){o.pingPong=!1;const d=o.clone();return d.reversed=!i,d.start=o.start,d.reversed&&(d.start-=l),Ve.sequence(o,d)}return o}static waitAction(t){const e=new Bn;return e.tokenId="Wait",e.duration=t,e.motionType=void 0,e}static lookAtCameraAction(t,e,i,n){const o=new Bn(t);return o.tokenId="LookAtCamera",o.duration=e===void 0?9999999999999:e,o.front=i??gs.forward,o.up=n??gs.up,o}static emphasize(t,e,i="bounce",n=1,o="basic"){const r=new Bn(t);return r.tokenId="Emphasize",r.duration=e,r.style=o??"basic",r.motionType=i,r.moveDistance=n,r}static transformAction(t,e,i,n,o="inout"){const r=new Bn(t);return r.tokenId="Transform",r.duration=i,r.duration=Math.max(1e-6,i),r.type=n,r.easeType=i>0?o:"none",Array.isArray(e)&&console.error("Transform target must not be an array",e),r.xFormTarget=e,r}static playAudioAction(t,e,i="play",n=1,o="spatial"){const r=new Bn(t);return r.tokenId="Audio",r.type=i,r.audio=e,r.gain=n,r.auralMode=o,r.multiplePerformOperation="allow",r}static impulseAction(t,e){const i=new Bn(t);return i.tokenId="Impulse",i.velocity=e,i}}class o3{constructor(t){a(this,"object");a(this,"model");this.object=t}get id(){return this.object.uuid}apply(t){if(!this.model&&(this.model=t.findById(this.object.uuid),!this.model)){console.error("could not find model with id "+this.object.uuid);return}this.onApply(t)}}class iR extends o3{constructor(e,i,n,o){super(e);a(this,"matrix");a(this,"material");a(this,"geometry");a(this,"_enableAction");a(this,"_disableAction");this.matrix=i,this.material=n,this.geometry=o}onApply(e){var o,r;const i=this.model;if(!i)return;(o=i.parent)!=null&&o.isDynamic||Yi.createEmptyParent(i);const n=i.clone();this.matrix&&n.setMatrix(this.matrix),this.material&&(n.material=this.material),this.geometry&&(n.geometry=this.geometry),(r=i.parent)==null||r.add(n)}enable(){return this._enableAction?this._enableAction:(this._enableAction=Ve.fadeAction(this.object,0,!0),this._enableAction)}disable(){return this._disableAction?this._disableAction:(this._disableAction=Ve.fadeAction(this.object,0,!1),this._disableAction)}}class r3{constructor(t){a(this,"actions");a(this,"sortedActions");this.actions=[...t]}organize(){this.sortedActions={};for(const t of this.actions){const e=t.id;this.sortedActions[e]||(this.sortedActions[e]=[]),this.sortedActions[e].push(t)}}getActions(t){return this.sortedActions||this.organize(),this.sortedActions[t.uuid]}}const Eo=k("debugusdzanimation"),a0=k("debugusdzanimationserialization");class ql{constructor(t,e,i){a(this,"_start");a(this,"ext");a(this,"root");a(this,"_nearestAnimatedRoot");a(this,"clip");a(this,"speed");this.ext=t,this.root=e,this.clip=i,this._nearestAnimatedRoot=this.getNearestAnimatedRoot()}get start(){return this._start===void 0&&(this._start=this.ext.getStartTimeByClip(this.clip)),this._start}get duration(){var t;return((t=this.clip)==null?void 0:t.duration)??bt.restPoseClipDuration}get nearestAnimatedRoot(){return this._nearestAnimatedRoot}get clipName(){var t;return((t=this.clip)==null?void 0:t.name)??"rest"}static isDescendantOf(t,e){let i=e;if(!i||!t)return!1;for(;i;){if(!i)return!1;if(i===t)return!0;i=i.parent}return!1}getNearestAnimatedRoot(){var e;let t;try{for(const i of((e=this.clip)==null?void 0:e.tracks)??[]){const n=Gh.parseTrackName(i.name);let o=Gh.findNode(this.root,n.nodeName);if(o)if(!t)t=o;else{if(o===t||ql.isDescendantOf(t,o))continue;if(!ql.isDescendantOf(o,t)){for(;!ql.isDescendantOf(o,t)&&o.parent;)o=o.parent;ql.isDescendantOf(o,t)||console.error("USDZExporter: Animation clip targets multiple roots that are not parent/child. Please report a bug",this.root,this.clip,t,o)}t=o}}}catch(i){console.error("USDZExporter: Exception when trying to find nearest animated root. Please report a bug",i),t=void 0}return t}}const sf=class{constructor(t,e,i){a(this,"clip");a(this,"pos");a(this,"rot");a(this,"scale");a(this,"root");a(this,"target");a(this,"duration",0);a(this,"useRootMotion",!1);if(this.root=t,this.target=e,this.clip=i,i?this.duration=i.duration:this.duration=sf.restPoseClipDuration,i&&i.tracks){const o=Math.max(...i.tracks.map(r=>r.times[r.times.length-1]));o!==this.duration&&(console.warn("USDZExporter: Animation clip duration does not match the maximum time value in the tracks.",i,o,this.duration),this.duration=o)}const n=I.getComponent(t,Ei);n&&(this.useRootMotion=n.applyRootMotion)}addTrack(t){var e,i;if(!this.clip){console.error("This is a rest clip but you're trying to add tracks to it ‚Äì this is likely a bug");return}t.name.endsWith("position")?this.pos=t:t.name.endsWith("quaternion")?this.rot=t:t.name.endsWith("scale")?this.scale=t:(t.name.endsWith("activeSelf")?console.warn("[USDZ] Animation of enabled/disabled state is not supported for USDZ export and will NOT be exported: "+t.name+" on "+(((e=this.root)==null?void 0:e.name)??this.target.name)+". Animate scale 0/1 instead."):console.warn("[USDZ] Animation track type not supported for USDZ export and will NOT be exported: "+t.name+" on "+(((i=this.root)==null?void 0:i.name)??this.target.name)+". Only .position, .rotation, .scale are supported."),X()&&qe("[USDZ] Some animations can't be exported. See console for details."))}getFrames(){var t,e,i,n,o,r;return this.clip?Math.max(((e=(t=this.pos)==null?void 0:t.times)==null?void 0:e.length)??0,((n=(i=this.rot)==null?void 0:i.times)==null?void 0:n.length)??0,((r=(o=this.scale)==null?void 0:o.times)==null?void 0:r.length)??0):2}getDuration(){return this.duration}getSortedTimesArray(t=!0,e=!0,i=!0){var c,h,d;if(!this.clip)return[0,this.duration];const n=(c=this.pos)==null?void 0:c.times,o=(h=this.rot)==null?void 0:h.times,r=(d=this.scale)==null?void 0:d.times,l=[];if(t&&n)for(const u of n)l.push(u);if(e&&o)for(const u of o)l.push(u);if(i&&r)for(const u of r)l.push(u);return l.includes(0)||l.push(0),l.sort((u,f)=>u-f),[...new Set(l)]}*getValues(t,e=!0,i=!0,n=!0){var p,b,x;const o=new R,r=new re,l=new R(1,1,1),c=this.target,h=e?(p=this.pos)==null?void 0:p.createInterpolant():void 0,d=i?(b=this.rot)==null?void 0:b.createInterpolant():void 0,u=n?(x=this.scale)==null?void 0:x.createInterpolant():void 0;h||o.set(c.position.x,c.position.y,c.position.z),d||r.set(c.quaternion.x,c.quaternion.y,c.quaternion.z,c.quaternion.w),u||l.set(c.scale.x,c.scale.y,c.scale.z),h&&h.valueSize!==3&&(h.valueSize=3),d&&d.valueSize!==4&&(d.valueSize=4),u&&u.valueSize!==3&&(u.valueSize=3);const f=0;for(let v=0-f;v<t.length+f;v++){let S=0,C=0;if(v<0?(S=t[0],C=S-sf.animationDurationPadding/2+1/60):v>=t.length?(S=t[t.length-1],C=S+sf.animationDurationPadding/2-1/60):(S=t[v],C=S),h){const P=h.evaluate(S);o.set(P[0],P[1],P[2])}if(d){const P=d.evaluate(S);r.set(P[0],P[1],P[2],P[3])}if(u){const P=u.evaluate(S);l.set(P[0],P[1],P[2])}if(this.useRootMotion&&c===this.root){const P=new xe;P.compose(o,r,l),P.multiply(c.matrix),P.decompose(o,r,l)}yield{time:C,translation:o,rotation:r,scale:l,index:v}}}};let bt=sf;a(bt,"frameRate",60),a(bt,"animationDurationPadding",6/60),a(bt,"restPoseClipDuration",6/60);class Pv{constructor(t){a(this,"dict",new Map);a(this,"rootTargetMap",new Map);a(this,"rootAndClipToRegisteredAnimationMap",new Map);a(this,"rootToRegisteredClip",new Map);a(this,"lastClipEndTime",0);a(this,"clipToStartTime",new Map);a(this,"clipToHoldClip",new Map);a(this,"serializers",[]);a(this,"injectRestPoses",!1);a(this,"injectImplicitBehaviours",!1);this.injectRestPoses=t,this.injectImplicitBehaviours=t}get extensionName(){return"animation"}get animationData(){return this.dict}get registeredClips(){return this.clipToStartTime.keys()}get animatedRoots(){return this.rootTargetMap.keys()}get holdClipMap(){return this.clipToHoldClip}getStartTimeCode(){return!this.injectRestPoses||this.rootAndClipToRegisteredAnimationMap.size===0?0:(bt.restPoseClipDuration+bt.animationDurationPadding)*60}getEndTimeCode(){let t=0;for(const[e,i]of this.rootAndClipToRegisteredAnimationMap){const n=i.start+i.duration;n>t&&(t=n)}return t*60}getClipCount(t){var i;return((i=this.rootToRegisteredClip.get(t))==null?void 0:i.length)??0??0}getStartTimeByClip(t){return t?this.clipToStartTime.has(t)?this.clipToStartTime.get(t):(console.error("USDZExporter: Missing start time for clip ‚Äì please report a bug.",t),0):0}registerAnimation(t,e){var h;if(!t)return null;this.rootTargetMap.has(t)||this.rootTargetMap.set(t,[]);const i=t.uuid+((e==null?void 0:e.uuid)??"-rest");if(this.rootAndClipToRegisteredAnimationMap.has(i))return this.rootAndClipToRegisteredAnimationMap.get(i);Eo&&console.log("registerAnimation",t,e);const n=this.injectRestPoses?1:0,o=(((h=this.rootToRegisteredClip.get(t))==null?void 0:h.length)??0)+n,r=this.rootTargetMap.get(t),l=new Set(r);if(e&&e.tracks)for(const d of e.tracks){const u=Gh.parseTrackName(d.name),f=Gh.findNode(t,u.nodeName);if(!f){console.warn("no object found for track",d.name,"using "+t.name+" instead");continue}this.dict.has(f)||this.dict.set(f,[]);const p=this.dict.get(f);if(!p){console.warn("no transform data found for target ",f,"at slot "+o+", this is likely a bug");continue}l.delete(f),this.injectRestPoses&&!p[0]&&(console.log("Injecting rest pose",f,e,"at slot",o),p[0]=new bt(null,f,null));let b=p[o];b||(b=new bt(t,f,e),p[o]=b),b.addTrack(d),r!=null&&r.includes(f)||r==null||r.push(f)}Eo&&console.log("Unregistered nodes for this clip",l,"clip",e,"at slot",o,"for root",t,"targets",r);for(const d of l){const u=this.dict.get(d);if(!u)continue;if(this.injectRestPoses&&!u[0]){console.warn("Adding rest pose for ",d,e,"at slot",o,"This is likely a bug, should have been added earlier.");const p=new bt(null,d,null);u[0]=p}let f=u[o];f||(Eo&&console.log("Adding padding clip for ",d,e,"at slot",o),f=new bt(t,d,e),u[o]=f)}const c=new ql(this,t,e);if(this.rootAndClipToRegisteredAnimationMap.set(i,c),Eo&&console.log({root:t,clip:e,info:c}),e){const d=this.rootToRegisteredClip.get(t);if(d?d.push(e):this.rootToRegisteredClip.set(t,[e]),!this.clipToStartTime.get(e)){this.lastClipEndTime==null&&(this.lastClipEndTime=bt.restPoseClipDuration);let f=this.lastClipEndTime+bt.animationDurationPadding,p=f+e.duration;const b=Math.round(f*60)/60,x=Math.round(p*60)/60;Math.abs(b-f)<.01&&(f=b),Math.abs(x-p)<.01&&(p=x),f=Math.ceil(f),p=f+e.duration,this.clipToStartTime.set(e,f),this.lastClipEndTime=p}}return c}onAfterHierarchy(t){Eo&&console.log("Animation clips per animation target node",this.dict)}onAfterBuildDocument(t){var e,i;Eo&&console.log("Animation data",{dict:this.dict,rootTargetMap:this.rootTargetMap,rootToRegisteredClip:this.rootToRegisteredClip});for(const n of this.rootTargetMap.keys()){const o=this.rootTargetMap.get(n);if(!o)continue;let r;const l=[];for(const c of o){const h=this.dict.get(c);if(!h){console.error("No data found for target on USDZ export ‚Äì please report a bug!",c);continue}r===void 0&&(r=h==null?void 0:h.length),r!==(h==null?void 0:h.length)&&console.error("Different array lengths for targets ‚Äì please report a bug!",h);for(let d=0;d<h.length;d++){let u=h[d];if(!u){const p=d-(this.injectRestPoses?1:0);h[d]=new bt(null,c,this.rootToRegisteredClip.get(n)[p]),u=h[d]}const f=u.getDuration();if(l[d]===void 0)l[d]=f;else if(l[d]!==f){console.error("Error during UDSZ export: Encountered different animation durations for animated targets. Please report a bug!",{datas:h,target:c}),l[d]=f;continue}}}}for(const n of this.serializers){const o=(e=n.model)==null?void 0:e.parent,r=(o==null?void 0:o.isDynamic)===!0;a0&&console.log(r,(i=n.model)==null?void 0:i.parent),r&&n.registerCallback(o)}}onExportObject(t,e,i){I.foreachComponent(t,o=>{const r=o;typeof r.createAnimation=="function"&&r.createAnimation(this,e,i)},!1);const n=new a3(t,this);this.serializers.push(n),n.registerCallback(e)}}class a3{constructor(t,e){a(this,"model");a(this,"object");a(this,"animationData");a(this,"ext");a(this,"callback");this.object=t,this.animationData=e.animationData,this.ext=e}registerCallback(t){this.model&&this.callback&&this.model.removeEventListener("serialize",this.callback),this.callback||(this.callback=this.onSerialize.bind(this)),a0&&console.log("REPARENT",t),this.model=t,this.callback&&this.model.addEventListener("serialize",this.callback)}skinnedMeshExport(t,e,i){var r;const n=this.model,o=this.animationData;if(n&&n.skinnedMesh){let p=function(B){const N=[];for(const[Z,ae]of B){let ie=`${Z} : [`;const J=[];for(const ye of ae)J.push(`(${Ee(ye.x)}, ${Ee(ye.y)}, ${Ee(ye.z)})`);ie=ie.concat(J.join(", ")),ie=ie.concat("],"),N.push(ie)}return N},b=function(B){const N=[];for(const[Z,ae]of B){let ie=`${Z} : [`;const J=[];for(const ye of ae)J.push(`(${Ee(ye.w)}, ${Ee(ye.x)}, ${Ee(ye.y)}, ${Ee(ye.z)})`);ie=ie.concat(J.join(", ")),ie=ie.concat("],"),N.push(ie)}return N},x=function(B){let N,Z=!0;const ae=new Map;for(const[J,ye]of B){N===void 0&&(N=ye.length),N!==ye.length&&(Z=!1);let Fe=0;for(const Ze of ye)Fe++,Ze||(ae.has(J)||ae.set(J,[]),ae.get(J).push(Fe))}Eo&&console.log("Bone count: ",B.size,"TransformData entries per bone: ",N,"Undefined bone entries: ",ae),console.assert(Z,"All bones should have the same number of TransformData entries",B),console.assert(ae.size===0,"All TransformData entries should be set",ae);const ie=[];for(const[J,ye]of B)for(let Fe=0;Fe<ye.length;Fe++){const Ze=ye[Fe],Ot=i.getStartTimeByClip(Ze.clip);ie.length<=Fe&&ie.push({pos:[],rot:[],scale:[],timeOffset:Ot});const St=ie[Fe];St.pos.push(...Ze.getSortedTimesArray(!0,!1,!1)),St.rot.push(...Ze.getSortedTimesArray(!1,!0,!1)),St.scale.push(...Ze.getSortedTimesArray(!1,!1,!0))}for(const J of ie)J.pos.sort((ye,Fe)=>ye-Fe),J.rot.sort((ye,Fe)=>ye-Fe),J.scale.sort((ye,Fe)=>ye-Fe),J.pos=[...new Set(J.pos)],J.rot=[...new Set(J.rot)],J.scale=[...new Set(J.scale)];return ie},v=function(B,N,Z){const ae=new Map,ie=new Map,J=new Map,ye=N.length;for(const Fe of Z){const Ze=B.get(Fe);let Ot;Ze?console.assert(Ze.length===ye,"We should have the same number of TransformData entries for each bone",Ze,N):Ot=new bt(null,Fe,null);for(let St=0;St<ye;St++){const ui=Ze?Ze[St]:Ot,fi=N[St];for(const{time:pi,translation:ns}of ui.getValues(fi.pos,!0,!1,!1)){const Ue=(pi+fi.timeOffset)*60;ae.has(Ue)||ae.set(Ue,new Array),ae.get(Ue).push(ns.clone())}for(const{time:pi,rotation:ns}of ui.getValues(fi.rot,!1,!0,!1)){const Ue=(pi+fi.timeOffset)*60;ie.has(Ue)||ie.set(Ue,new Array),ie.get(Ue).push(ns.clone())}for(const{time:pi,scale:ns}of ui.getValues(fi.scale,!1,!1,!0)){const Ue=(pi+fi.timeOffset)*60;J.has(Ue)||J.set(Ue,new Array),J.get(Ue).push(ns.clone())}}}return{position:ae.size==0?void 0:ae,quaternion:ie.size==0?void 0:ie,scale:J.size==0?void 0:J}},S=function(B){const N=[];for(const Z of B)N.push(`(${Ee(Z.x)}, ${Ee(Z.y)}, ${Ee(Z.z)})`);return N.join(", ")},C=function(B){const N=[];for(const Z of B)N.push(`(${Ee(Z.w)}, ${Ee(Z.x)}, ${Ee(Z.y)}, ${Ee(Z.z)})`);return N.join(", ")},P=function(B){const N=new Map;if(Eo){const Z=new Array;for(const[ae,ie]of o)Z.push(ae.uuid+": "+ie.length+" "+ie.map(J=>{var ye;return(ye=J.clip)==null?void 0:ye.uuid.substring(0,6)}).join(" "));console.log(`getPerBoneTransformData
`+Z.join(`
`))}for(const Z of B){const ae=o.get(Z);ae&&N.set(Z,ae)}return N},E=function(B){const N=P(B),Z=x(N);return v(N,Z,B)};const l=n.skinnedMesh.skeleton,c=new Array,h=[],d=[];for(const B of l.bones){h.push(B),d.push(B.uuid);const N=l.boneInverses[l.bones.indexOf(B)];c.push({bone:B,inverse:N})}let u=1e4;for(;d.length<l.bones.length&&u-- >0;)for(const B of h){const N=B.children;for(const Z of N)if(d.indexOf(Z.uuid)===-1&&l.bones.indexOf(Z)!==-1){h.push(Z),d.push(Z.uuid);const ae=l.boneInverses[l.bones.indexOf(Z)];c.push({bone:Z,inverse:ae})}}u<=0&&console.error("Failed to sort bones in skinned mesh",n.skinnedMesh,l.bones,d);for(const B of QT(l.bones))c.push({bone:B,inverse:B.matrixWorld.clone().invert()});const f=c[0].bone.parent;f||console.error("No bone parent found for skinned mesh during USDZ export",n.skinnedMesh),c.sort((B,N)=>Bh(B.bone,f)>Bh(N.bone,f)?1:-1);const D=e.quickLookCompatible,M=[],A=[],G=[],V=[];for(const{bone:B}of c){if(D){const N=B.scale;N.x==0&&(N.x=1e-5),N.y==0&&(N.y=1e-5),N.z==0&&(N.z=1e-5),M.push(new xe().compose(B.position,B.quaternion,B.scale))}else M.push(B.matrix.clone());A.push(B.position),G.push(B.quaternion),V.push(B.scale)}const U=c.map(B=>'"'+Bh(B.bone,f)+'"').join(", "),$=c.map(B=>JS(B.inverse.clone().invert())).join(", ");t.beginBlock('def Skeleton "Rig"'),t.appendLine(`uniform matrix4d[] bindTransforms = [${$}]`),t.appendLine(`uniform token[] joints = [${U}]`),t.appendLine('uniform token purpose = "guide"'),t.appendLine(`uniform matrix4d[] restTransforms = [${M.map(B=>JS(B)).join(", ")}]`);const Y=E(c.map(B=>B.bone));if(Eo){let B=1e7,N=0;for(const Z of((r=Y.position)==null?void 0:r.keys())??[])B=Math.min(B,Z),N=Math.max(N,Z);console.log("Time samples",B,N,Y)}if(t.beginBlock('def SkelAnimation "_anim"'),t.appendLine(`uniform token[] joints = [${U}]`),t.appendLine(`quatf[] rotations = [${C(G)}]`),Y&&Y.quaternion){t.beginBlock("quatf[] rotations.timeSamples = {","");const B=b(Y.quaternion);for(const N of B)t.appendLine(N);t.closeBlock()}if(t.appendLine(`half3[] scales = [${S(V)}]`),Y&&Y.scale){t.beginBlock("half3[] scales.timeSamples = {","");const B=p(Y.scale);for(const N of B)t.appendLine(N);t.closeBlock()}if(t.appendLine(`float3[] translations = [${S(A)}]`),Y&&Y.position){t.beginBlock("float3[] translations.timeSamples = {","");const B=p(Y.position);for(const N of B)t.appendLine(N);t.closeBlock()}t.closeBlock(),t.closeBlock()}}onSerialize(t,e){if(!this.model)return;const i=this.animationData.get(this.object);if(i)for(let d=0;d<i.length;d++)i[d]===void 0&&(i[d]=new bt(null,this.object,null));const n=this.ext;this.skinnedMeshExport(t,e,n);const o=this.object,r=this.model,l=this.animationData.get(o);if(!l||o.isSkinnedMesh)return;a0&&console.log("SERIALIZE",this.model.name,this.object.type,l);const c=Intl.NumberFormat("en-US",{maximumFractionDigits:3,minimumFractionDigits:0,useGrouping:!1});function h(d,u){var p;if(d.some(b=>b&&{position:b.pos,rotation:b.rot,scale:b.scale}[u])){switch(u){case"position":r.needsTranslate=!0,t.beginBlock("double3 xformOp:translate.timeSamples = {","");break;case"rotation":r.needsOrient=!0,t.beginBlock("quatf xformOp:orient.timeSamples = {","");break;case"scale":r.needsScale=!0,t.beginBlock("double3 xformOp:scale.timeSamples = {","");break}for(let b=0;b<d.length;b++){const x=d[b];if(!x)continue;const v=n.getStartTimeByClip(x.clip),S=x.getSortedTimesArray(u==="position",u==="rotation",u==="scale");if(!S||S.length===0){console.error("got an animated object but no time values?",o,x);continue}const C=!x.clip,P=u==="position"&&(x.pos||C),E=u==="rotation"&&(x.rot||C),D=u==="scale"&&(x.scale||C);if(P||E||D){const M=((p=x.clip)==null?void 0:p.name)??"rest",A=x.getDuration();Eo&&console.log("Write .timeSamples:",M,v,A,d),t.appendLine("# "+M+": start="+c.format(v*bt.frameRate)+", length="+c.format(A*bt.frameRate)+", frames="+x.getFrames())}if(P)for(const{time:M,translation:A}of x.getValues(S,!0,!1,!1)){const V=`${c.format((v+M)*bt.frameRate)}: (${Ee(A.x)}, ${Ee(A.y)}, ${Ee(A.z)}),`;t.appendLine(V)}if(E)for(const{time:M,rotation:A}of x.getValues(S,!1,!0,!1)){const V=`${c.format((v+M)*bt.frameRate)}: (${Ee(A.w)}, ${Ee(A.x)}, ${Ee(A.y)}, ${Ee(A.z)}),`;t.appendLine(V)}if(D)for(const{time:M,scale:A}of x.getValues(S,!1,!1,!0)){const V=`${c.format((v+M)*bt.frameRate)}: (${Ee(A.x)}, ${Ee(A.y)}, ${Ee(A.z)}),`;t.appendLine(V)}}t.closeBlock()}}h(l,"position"),h(l,"rotation"),h(l,"scale")}}const l3=k("debugusdz");class pd{constructor(){a(this,"files",new Array)}static getName(t){var o;const e=t.split(".").pop();let n=(o=t.split(".").slice(0,-1).join(".").split("/").pop())==null?void 0:o.replace(".","_");return n||(n="Audio_"+Math.random().toString(36).substring(2,15)),Ss(n)+"."+e}get extensionName(){return"Audio"}onExportObject(t,e,i){const n=I.getComponents(t,We);if(n.length)for(const o of n){if(!o.clip||typeof o.clip!="string"||!o.playOnAwake)continue;const r=o.clip.split("/").pop()||"Audio",l=pd.getName(o.clip),c=Ss(l);if(!this.files.some(h=>h.path===o.clip)){this.files.push({path:o.clip,name:l});const h=l.toLowerCase();i.quickLookCompatible&&!h.endsWith(".mp3")&&!h.endsWith(".wav")&&!h.endsWith(".m4a")&&console.error("Audio file "+o.clip+" from "+o.name+" is not an MP3 or WAV file. QuickLook may not support playing it.")}i.quickLookCompatible||e.addEventListener("serialize",(h,d)=>{h.appendLine(),h.beginBlock(`def SpatialAudio "${c}"`,"(",!1),h.appendLine(`displayName = "${r}"`),h.closeBlock(")"),h.beginBlock(),h.appendLine(`uniform asset filePath = @audio/${l}@`),h.appendLine(`uniform token auralMode = "${o.spatialBlend>0?"spatial":"nonSpatial"}"`),h.appendLine(`uniform token playbackMode = "${o.loop?"loopFromStage":"onceFromStart"}"`),h.appendLine(`uniform float gain = ${o.volume}`),h.closeBlock()})}}async onAfterSerialize(t){for(const e of this.files){const i="audio/"+e.name;if(t.files[i]){l3&&console.warn("Audio file with name "+i+" already exists in the context. Skipping.");continue}const r=await(await(await fetch(e.path)).blob()).arrayBuffer(),l=new Uint8Array(r);t.files[i]=l}}}var xt=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const sC=k("debugusdzbehaviours");function jf(s){s&&(s.getComponentInParent(sd)||(X()&&console.debug('Raycaster on "'+s.name+'" was automatically added, because no raycaster was found in the parent hierarchy.'),s.addComponent(ws)))}class md extends W{constructor(){super(...arguments);a(this,"object");a(this,"target");a(this,"duration",1);a(this,"relativeMotion",!1);a(this,"coroutine",null);a(this,"targetPos",new R);a(this,"targetRot",new re);a(this,"targetScale",new R)}start(){jf(this.gameObject)}onPointerEnter(){this.context.input.setCursor("pointer")}onPointerExit(){this.context.input.unsetCursor("pointer")}onPointerClick(e){var n;const i=(n=this.object)==null?void 0:n.getComponentsInChildren(De);if(i)for(const o of i)o.resetVelocities(),o.resetForcesAndTorques();e.use(),this.coroutine&&this.stopCoroutine(this.coroutine),this.relativeMotion?this.coroutine=this.startCoroutine(this.moveRelative()):this.coroutine=this.startCoroutine(this.moveToTarget())}*moveToTarget(){if(!this.target||!this.object)return;const e=ve(this.object).clone(),i=ve(this.target).clone(),n=Qe(this.object).clone(),o=Qe(this.target).clone(),r=Lt(this.object).clone(),l=Lt(this.target).clone(),c=e.distanceTo(i),h=n.angleTo(o),d=r.distanceTo(l);if(c<.01&&h<.01&&d<.01){Oi(this.object,i),Yo(this.object,o),lf(this.object,l),this.coroutine=null;return}let u=0,f=0;for(;u<1;)u+=this.context.time.deltaTime/this.duration,u>1&&(u=1),f=u<.5?4*u*u*u:1-Math.pow(-2*u+2,3)/2,this.targetPos.lerpVectors(e,i,f),this.targetRot.slerpQuaternions(n,o,f),this.targetScale.lerpVectors(r,l,f),Oi(this.object,this.targetPos),Yo(this.object,this.targetRot),lf(this.object,this.targetScale),yield;this.coroutine=null}*moveRelative(){if(!this.target||!this.object)return;const e=this.object.position.clone(),i=this.object.quaternion.clone(),n=this.object.scale.clone(),o=this.target.position.clone(),r=this.target.quaternion.clone(),l=this.target.scale.clone();o.applyQuaternion(this.object.quaternion),this.targetPos.copy(this.object.position).add(o),this.targetRot.copy(this.object.quaternion).multiply(r),this.targetScale.copy(this.object.scale).multiply(l);let c=0,h=0;for(;c<1;)c+=this.context.time.deltaTime/this.duration,c>1&&(c=1),h=c<.5?4*c*c*c:1-Math.pow(-2*c+2,3)/2,this.object.position.lerpVectors(e,this.targetPos,h),this.object.quaternion.slerpQuaternions(i,this.targetRot,h),this.object.scale.lerpVectors(n,this.targetScale,h),yield;this.coroutine=null}beforeCreateDocument(e){var i;if(this.target&&this.object&&this.gameObject){const n=new ki("Move to "+((i=this.target)==null?void 0:i.name),Zi.tapTrigger(this.gameObject),Ve.transformAction(this.object,this.target,this.duration,this.relativeMotion?"relative":"absolute"));e.addBehavior(n)}}}xt([g(z)],md.prototype,"object",void 0);xt([g(z)],md.prototype,"target",void 0);xt([g()],md.prototype,"duration",void 0);xt([g()],md.prototype,"relativeMotion",void 0);const Wi=class extends W{constructor(){super(...arguments);a(this,"materialToSwitch");a(this,"variantMaterial");a(this,"fadeDuration",0);a(this,"_objectsWithThisMaterial",null);a(this,"selfModel");a(this,"targetModels")}start(){var e;this._objectsWithThisMaterial=this.objectsWithThisMaterial,jf(this.gameObject),X()&&this._objectsWithThisMaterial.length<=0&&console.warn('ChangeMaterialOnClick: No objects found with material "'+((e=this.materialToSwitch)==null?void 0:e.name)+'"')}onPointerEnter(e){this.context.input.setCursor("pointer")}onPointerExit(e){this.context.input.unsetCursor("pointer")}onPointerClick(e){if(e.use(),!!this.variantMaterial)for(let i=0;i<this.objectsWithThisMaterial.length;i++){const n=this.objectsWithThisMaterial[i];n.material=this.variantMaterial}}get objectsWithThisMaterial(){return this._objectsWithThisMaterial!=null?this._objectsWithThisMaterial:(this._objectsWithThisMaterial=[],this.variantMaterial&&this.materialToSwitch&&this.context.scene.traverse(e=>{if(e instanceof le)if(Array.isArray(e.material)){for(const i of e.material)if(i===this.materialToSwitch){this.objectsWithThisMaterial.push(e);break}}else e.material===this.materialToSwitch?this.objectsWithThisMaterial.push(e):N2(e.material,this.materialToSwitch)&&this.objectsWithThisMaterial.push(e)}),this._objectsWithThisMaterial)}async beforeCreateDocument(e,i){this.targetModels=[],Wi._materialTriggersPerId={},Wi.variantSwitchIndex=0,this.materialToSwitch&&await Tt.assignTextureLOD(this.materialToSwitch,0),this.variantMaterial&&await Tt.assignTextureLOD(this.variantMaterial,0)}createBehaviours(e,i,n){this.objectsWithThisMaterial.find(r=>r.uuid===i.uuid)&&this.targetModels.push(i),this.gameObject.uuid===i.uuid&&(this.selfModel=i,this.materialToSwitch&&(Wi._materialTriggersPerId[this.materialToSwitch.uuid]||(Wi._materialTriggersPerId[this.materialToSwitch.uuid]=[]),Wi._materialTriggersPerId[this.materialToSwitch.uuid].push(this)))}afterCreateDocument(e,i){if(!this.materialToSwitch)return;const n=Wi._materialTriggersPerId[this.materialToSwitch.uuid];if(n){const o={};for(const r of n){const l=r.createVariants();l&&l.length>0&&(o[r.selfModel.uuid]=l)}for(const r of n){const l=[];for(const c in o)c!==r.selfModel.uuid&&l.push(...o[c]);r.createAndAttachBehaviors(e,o[r.selfModel.uuid],l)}}delete Wi._materialTriggersPerId[this.materialToSwitch.uuid]}createAndAttachBehaviors(e,i,n){const o=[],r=Math.max(0,this.fadeDuration);o.push(Ve.fadeAction([...this.targetModels,...n],r,!1)),o.push(Ve.fadeAction(i,r,!0)),e.addBehavior(new ki("Select_"+this.selfModel.name,Zi.tapTrigger(this.selfModel),Ve.parallel(...o))),Wi._parallelStartHiddenActions.push(...i),Wi._startHiddenBehaviour||(Wi._startHiddenBehaviour=new ki("StartHidden_"+this.selfModel.name,Zi.sceneStartTrigger(),Ve.fadeAction(Wi._parallelStartHiddenActions,r,!1)),e.addBehavior(Wi._startHiddenBehaviour))}static getMaterialName(e){return Ss(e.name||"Material")+"_"+e.id}createVariants(){if(!this.variantMaterial)return null;const e=[];for(const i of this.targetModels){const n=i.clone();n.name+="_Variant_"+Wi.variantSwitchIndex+++"_"+Wi.getMaterialName(this.variantMaterial),n.displayName=n.displayName+": Variant with material "+this.variantMaterial.name,n.material=this.variantMaterial,n.geometry=i.geometry,n.transform=i.transform,(!i.parent||!i.parent.isEmpty())&&Yi.createEmptyParent(i),i.parent&&i.parent.add(n),e.push(n)}return e}};let $s=Wi;a($s,"_materialTriggersPerId",{}),a($s,"_startHiddenBehaviour",null),a($s,"_parallelStartHiddenActions",[]),a($s,"variantSwitchIndex",0);xt([g(Xe)],$s.prototype,"materialToSwitch",void 0);xt([g(Xe)],$s.prototype,"variantMaterial",void 0);xt([g()],$s.prototype,"fadeDuration",void 0);const ut=class extends W{constructor(){super(...arguments);a(this,"target");a(this,"toggleOnClick",!1);a(this,"targetState",!0);a(this,"hideSelf",!0);a(this,"selfModel");a(this,"selfModelClone");a(this,"targetModel");a(this,"toggleModel");a(this,"stateBeforeCreatingDocument",!1);a(this,"targetStateBeforeCreatingDocument",!1)}start(){jf(this.gameObject)}onPointerEnter(){this.context.input.setCursor("pointer")}onPointerExit(){this.context.input.unsetCursor("pointer")}onPointerClick(e){e.use(),!this.toggleOnClick&&this.hideSelf&&(this.gameObject.visible=!1),this.target&&(this.target.visible=this.toggleOnClick?!this.target.visible:this.targetState)}createBehaviours(e,i,n){i.uuid===this.gameObject.uuid&&(this.selfModel=i,this.selfModelClone=i.clone())}beforeCreateDocument(){this.target&&(this.gameObject[ut.wasVisible]===void 0&&(this.gameObject[ut.wasVisible]=this.gameObject.activeSelf),this.target[ut.wasVisible]===void 0&&(this.target[ut.wasVisible]=this.target.activeSelf),this.stateBeforeCreatingDocument=this.gameObject[ut.wasVisible],this.targetStateBeforeCreatingDocument=this.target[ut.wasVisible],this.gameObject.visible=!0,this.target.visible=!0)}afterCreateDocument(e,i){if(!this.target)return;this.targetModel=i.document.findById(this.target.uuid);const n=this.selfModel;if(this.selfModel&&this.targetModel){let o=this.selfModel,r=this.targetState;if(this.toggleOnClick)if(r=!this.targetStateBeforeCreatingDocument,!this.selfModelClone.geometry)(!this.selfModel.parent||this.selfModel.parent.isEmpty())&&YT.createEmptyParent(this.selfModel),this.toggleModel=this.selfModel.deepClone(),this.toggleModel.name+="_toggle",this.selfModel.parent.add(this.toggleModel);else{if(!this.gameObject[ut.toggleClone]){const h=this.selfModelClone.clone();h.setMatrix(new xe),h.name+="_toggle"+ut.clonedToggleIndex++,n.add(h),this.gameObject[ut.toggleClone]=h,console.warn("USDZExport: Toggle "+this.gameObject.name+" doesn't have geometry. It will be deep cloned and nested behaviours will likely not work.")}const c=this.gameObject[ut.toggleClone];if(!this.gameObject[ut.reverseToggleClone]){const h=this.selfModelClone.clone();h.setMatrix(new xe),h.name+="_toggleReverse"+ut.clonedToggleIndex++,n.add(h),this.gameObject[ut.reverseToggleClone]=h}this.toggleModel=this.gameObject[ut.reverseToggleClone],(!this.toggleModel.geometry||!c.geometry)&&console.error("triggers without childs and without geometry won't work!",this,n.geometry),o=c,n.geometry=null,n.material=null}if(this.toggleModel){if(this.toggleOnClick){const c=[];c.push(Ve.fadeAction(o,0,!1)),c.push(Ve.fadeAction(this.toggleModel,0,!0)),c.push(Ve.fadeAction(this.targetModel,0,r)),e.addBehavior(new ki("Toggle_"+o.name+"_ToggleTo"+(r?"On":"Off"),Zi.tapTrigger(o),Ve.parallel(...c)));const h=[];h.push(Ve.fadeAction(this.toggleModel,0,!1)),h.push(Ve.fadeAction(o,0,!0)),h.push(Ve.fadeAction(this.targetModel,0,!r)),e.addBehavior(new ki("Toggle_"+o.name+"_ToggleTo"+(r?"Off":"On"),Zi.tapTrigger(this.toggleModel),Ve.parallel(...h)))}}else{const c=[];this.hideSelf&&c.push(Ve.fadeAction(o,0,!1)),c.push(Ve.fadeAction(this.targetModel,0,r)),e.addBehavior(new ki("Toggle_"+o.name+"_ToggleTo"+(r?"On":"Off"),Zi.tapTrigger(o),c.length>1?Ve.parallel(...c):c[0]))}const l=new Array;this.targetStateBeforeCreatingDocument||l.push(this.targetModel),this.stateBeforeCreatingDocument||l.push(n),this.toggleModel&&l.push(this.toggleModel),Xl.add(l,e)}}afterSerialize(e,i){this.gameObject[ut.wasVisible]!==void 0&&(this.gameObject.visible=this.gameObject[ut.wasVisible],delete this.gameObject[ut.wasVisible]),this.target&&this.target[ut.wasVisible]!==void 0&&(this.target.visible=this.target[ut.wasVisible],delete this.target[ut.wasVisible]),delete this.gameObject[ut.toggleClone],delete this.gameObject[ut.reverseToggleClone]}};let fs=ut;a(fs,"clonedToggleIndex",0),a(fs,"wasVisible",Symbol("usdz_SetActiveOnClick_wasVisible")),a(fs,"toggleClone",Symbol("clone for toggling")),a(fs,"reverseToggleClone",Symbol("clone for reverse toggling"));xt([g(z)],fs.prototype,"target",void 0);xt([g()],fs.prototype,"toggleOnClick",void 0);xt([g()],fs.prototype,"targetState",void 0);xt([g()],fs.prototype,"hideSelf",void 0);const Sr=class extends W{constructor(){super(...arguments);a(this,"wasVisible",!1)}static add(e,i){const n=Array.isArray(e)?e:[e];for(const o of n)Sr._fadeObjects.includes(o)||(console.log("adding hide on start",o),Sr._fadeObjects.push(o));Sr._fadeBehaviour===void 0&&(Sr._fadeBehaviour=new ki("HideOnStart",Zi.sceneStartTrigger(),Ve.fadeAction(Sr._fadeObjects,0,!1)),i.addBehavior(Sr._fadeBehaviour))}start(){I.setActive(this.gameObject,!1)}createBehaviours(e,i,n){i.uuid===this.gameObject.uuid&&(this.wasVisible||Sr.add(i,e))}beforeCreateDocument(){this.wasVisible=I.isActiveSelf(this.gameObject)}};let Xl=Sr;a(Xl,"_fadeBehaviour"),a(Xl,"_fadeObjects",[]);class Ff extends W{constructor(){super(...arguments);a(this,"target");a(this,"duration",.5);a(this,"motionType","bounce")}beforeCreateDocument(){}createBehaviours(e,i,n){if(this.target&&i.uuid===this.gameObject.uuid){const o=new ki("emphasize "+this.name,Zi.tapTrigger(this.gameObject),Ve.emphasize(this.target,this.duration,this.motionType,void 0,"basic"));e.addBehavior(o)}}afterCreateDocument(e,i){}}xt([g()],Ff.prototype,"target",void 0);xt([g()],Ff.prototype,"duration",void 0);xt([g()],Ff.prototype,"motionType",void 0);class dc extends W{constructor(){super(...arguments);a(this,"target");a(this,"clip","");a(this,"toggleOnClick",!1);a(this,"trigger","tap")}start(){jf(this.gameObject)}ensureAudioSource(){if(!this.target){const e=this.gameObject.addComponent(We);e&&(this.target=e,e.spatialBlend=1,e.volume=1,e.loop=!1,e.preload=!0)}}onPointerEnter(){this.context.input.setCursor("pointer")}onPointerExit(){this.context.input.unsetCursor("pointer")}onPointerClick(e){var i;e.use(),!(!((i=this.target)!=null&&i.clip)&&!this.clip)&&(this.ensureAudioSource(),this.target&&(this.target.isPlaying&&this.toggleOnClick?this.target.stop():(!this.toggleOnClick&&this.target.isPlaying&&this.target.stop(),this.clip?this.target.play(this.clip):this.target.play())))}createBehaviours(e,i,n){if(!(!this.target&&!this.clip)&&i.uuid===this.gameObject.uuid){const o=this.clip?this.clip:this.target?this.target.clip:void 0;if(!o||typeof o!="string")return;const r=this.target?this.target.gameObject:this.gameObject;pd.getName(o);const l=this.target?this.target.volume:1,c=this.target&&this.target.spatialBlend==0?"nonSpatial":"spatial";let h=!1;this.gameObject.traverse(p=>{p instanceof le&&p.visible&&(h=!0)}),h=!0;const d=e.addAudioClip(o);let u=Ve.playAudioAction(r,d,"play",l,c);this.target&&this.target.loop&&(u=Ve.sequence(u).makeLooping());const f=this.name?"_"+this.name:"";if(h&&this.trigger==="tap"){this.toggleOnClick&&(u.multiplePerformOperation="stop");const p=new ki("playAudio"+f,Zi.tapTrigger(i),u);e.addBehavior(p)}if(this.target&&this.target.playOnAwake&&this.target.enabled)if(h&&this.trigger==="tap")console.warn("USDZExport: Audio sources that are played on tap can't also auto-play at scene start due to a QuickLook bug.");else{const p=new ki("playAudioOnStart"+f,Zi.sceneStartTrigger(),u);e.addBehavior(p)}}}}xt([g(We)],dc.prototype,"target",void 0);xt([g(URL)],dc.prototype,"clip",void 0);xt([g()],dc.prototype,"toggleOnClick",void 0);const Us=class extends W{constructor(){super(...arguments);a(this,"animator");a(this,"stateName");a(this,"trigger","tap");a(this,"animation");a(this,"selfModel");a(this,"stateAnimationModel");a(this,"animationSequence",new Array);a(this,"animationLoopAfterSequence",new Array);a(this,"randomOffsetNormalized",0)}get target(){var e,i;return((e=this.animator)==null?void 0:e.gameObject)||((i=this.animation)==null?void 0:i.gameObject)}start(){jf(this.gameObject)}onPointerEnter(){this.context.input.setCursor("pointer")}onPointerExit(){this.context.input.unsetCursor("pointer")}onPointerClick(e){var i;e.use(),this.target&&this.stateName&&((i=this.animator)==null||i.play(this.stateName,0,0,.1))}createBehaviours(e,i,n){i.uuid===this.gameObject.uuid&&(this.selfModel=i)}afterSerialize(){if(Us.rootsWithExclusivePlayback.size>1){const e='Multiple root objects targeted by more than one animation. To work around QuickLook bug FB13410767, animations will be set as "exclusive" and activating them will stop other animations being marked as exclusive.';X()&&qe(e),console.warn(e,...Us.rootsWithExclusivePlayback)}Us.animationActions=[],Us.rootsWithExclusivePlayback=new Set}afterCreateDocument(e,i){if(this.animationSequence===void 0&&this.animationLoopAfterSequence===void 0||!this.stateAnimationModel||!this.target)return;const n=i.document,o=i.extensions.find(c=>c instanceof Pv);if(!o)return;const r=o.getClipCount(this.target)>1;r&&(X()&&console.warn("Setting exclusive playback for "+this.target.name+"@"+this.stateName+" because it has "+o.getClipCount(this.target)+" animations. This works around QuickLook bug FB13410767."),Us.rootsWithExclusivePlayback.add(this.target));const l=this.name?this.name:"";n.traverse(c=>{var h,d;if(c.uuid===((h=this.target)==null?void 0:h.uuid)){const u=Us.getActionForSequences(n,c,this.animationSequence,this.animationLoopAfterSequence,this.randomOffsetNormalized),f=new ki(this.trigger+"_"+l+"_toPlayAnimation_"+this.stateName+"_on_"+((d=this.target)==null?void 0:d.name),this.trigger=="tap"?Zi.tapTrigger(this.selfModel):Zi.sceneStartTrigger(),u);r&&f.makeExclusive(!0),e.addBehavior(f)}})}static getActionForSequences(e,i,n,o,r){const l=(h,d)=>{let u=Us.animationActions.find(f=>f.affectedObjects==h&&f.start==d.start&&f.duration==d.duration&&f.animationSpeed==d.speed);return u||(u=Ve.startAnimationAction(h,d),Us.animationActions.push(u)),u},c=Ve.sequence();if(n&&n.length>0)for(const h of n)c.addAction(l(i,h));if(o&&o.length>0){const h=c.actions.length==0?c:Ve.sequence();for(const d of o)h.addAction(l(i,d));h.makeLooping(),c!==h&&c.addAction(h)}return r&&r>0&&c.actions.unshift(Ve.waitAction(r)),c}static getAndRegisterAnimationSequences(e,i,n){var x,v,S,C,P,E,D,M;if(!i)return;const o=i.getComponent(Ei),r=i.getComponent(pn);if(!o&&!r)return;if(o&&!n)throw new Error("PlayAnimationOnClick: No stateName specified for animator "+o.name+" on "+i.name);let l=[],c=[];if(r){const A=e.registerAnimation(i,r.clip);A&&(r.loop?c.push(A):l.push(A));let G=0;if(r.minMaxOffsetNormalized){const V=r.minMaxOffsetNormalized.x,U=r.minMaxOffsetNormalized.y;G=(((x=r.clip)==null?void 0:x.duration)||1)*(V+Math.random()*(U-V))}return{animationSequence:l,animationLoopAfterSequence:c,randomTimeOffset:G}}const h=o==null?void 0:o.runtimeAnimatorController;let d=h==null?void 0:h.findState(n),u=[],f=[];if(h&&d){const A=new Array;A.push(d);let G=!1;for(;A.length<100;){if(!d||d===null||!d.transitions||d.transitions.length===0){(v=d.motion)!=null&&v.isLooping&&(G=!0);break}const V=d.transitions.find($=>$.conditions.length===0),U=V?h.getState(V.destinationState,0):null;if(U&&A.includes(U)){d=U,G=!0;break}else if(V){if(d=U,!d)break;A.push(d)}else{G=((S=d.motion)==null?void 0:S.isLooping)??!1;break}}if(G&&d){const V=A.indexOf(d);u=A.slice(0,V),f=A.slice(V),sC&&console.log("found loop from "+n,"states until loop",u,"states looping",f)}else u=A,f=[],sC&&console.log("found no loop from "+n,"states",u);if(!f.length){const V=u[u.length-1],U=(C=V.motion)==null?void 0:C.clip;if(U){let $;if(e.holdClipMap.has(U))$=e.holdClipMap.get(U);else{const Y=V.name+"_hold";$=U.clone(),$.duration=1,$.name=Y;const B=U.duration;$.tracks=U.tracks.map(N=>{const Z=N.clone();Z.times=new Float32Array([0,B]);const ae=N.values.length,ie=N.getValueSize(),J=N.values.slice(ae-ie,ae);return Z.values=new Float32Array(2*ie),Z.values.set(J,0),Z.values.set(J,ie),Z}),$.name=Y,e.holdClipMap.set(U,$)}if($){const Y={name:$.name,motion:{clip:$,isLooping:!1,name:$.name},speed:1,transitions:[],behaviours:[],hash:V.hash+1};f.push(Y)}}}}if(u.length===1&&(!((P=u[0].motion)!=null&&P.clip)||((D=(E=u[0].motion)==null?void 0:E.clip.tracks)==null?void 0:D.length)===0)){l=new Array;const A=e.registerAnimation(i,null);A&&l.push(A);return}if(u=u.filter(A=>{var G,V,U;return((G=A.motion)==null?void 0:G.clip)&&((U=(V=A.motion)==null?void 0:V.clip.tracks)==null?void 0:U.length)>0}),f=f.filter(A=>{var G,V,U;return((G=A.motion)==null?void 0:G.clip)&&((U=(V=A.motion)==null?void 0:V.clip.tracks)==null?void 0:U.length)>0}),u.length===0&&f.length===0){console.warn("No clips found for state "+n+" on "+(o==null?void 0:o.name)+", can't export animation data");return}const p=(A,G)=>{if(!i)return;const V=e.registerAnimation(i,A.motion.clip??null);V?(V.speed=A.speed,G.push(V)):console.warn("Couldn't register animation for state "+A.name+" on "+(o==null?void 0:o.name))};if(u.length>0){l=new Array;for(const A of u)p(A,l)}if(f.length>0){c=new Array;for(const A of f)p(A,c)}let b=0;if(o&&h&&o.minMaxOffsetNormalized){const A=o.minMaxOffsetNormalized.x,G=o.minMaxOffsetNormalized.y,V=u.length?u[0]:f.length?f[0]:null;b=(((M=V==null?void 0:V.motion.clip)==null?void 0:M.duration)||1)*(A+Math.random()*(G-A))}return{animationSequence:l,animationLoopAfterSequence:c,randomTimeOffset:b}}createAnimation(e,i,n){if(!this.target||!this.animator&&!this.animation)return;const o=Us.getAndRegisterAnimationSequences(e,this.target,this.stateName);o&&(this.animationSequence=o.animationSequence,this.animationLoopAfterSequence=o.animationLoopAfterSequence,this.randomOffsetNormalized=o.randomTimeOffset,this.stateAnimationModel=i)}};let Uo=Us;a(Uo,"animationActions",[]),a(Uo,"rootsWithExclusivePlayback",new Set);xt([g(Ei)],Uo.prototype,"animator",void 0);xt([g()],Uo.prototype,"stateName",void 0);class Bf extends W{constructor(){super(...arguments);a(this,"target")}getType(){}getDuration(){}}xt([g(z)],Bf.prototype,"target",void 0);class Zg extends W{constructor(){super(...arguments);a(this,"target")}}xt([g(Bf)],Zg.prototype,"target",void 0);class Jg extends Bf{constructor(){super(...arguments);a(this,"type",Lu.Hide);a(this,"duration",1)}getType(){switch(this.type){case Lu.Hide:return"hide";case Lu.Show:return"show"}}getDuration(){return this.duration}}xt([g()],Jg.prototype,"type",void 0);xt([g()],Jg.prototype,"duration",void 0);class nR extends Zg{}var Lu;(function(s){s[s.Show=0]="Show",s[s.Hide=1]="Hide"})(Lu||(Lu={}));const c3=100,h3=200,d3=300,hx=class{constructor(){a(this,"_quicklookButton");a(this,"_arButton");a(this,"_vrButton");a(this,"_sendToQuestButton")}static create(){return new hx}static getOrCreate(){return this._instance||(this._instance=this.create()),this._instance}get isSecureConnection(){return window.location.protocol==="https:"}get quicklookButton(){return this._quicklookButton}get arButton(){return this._arButton}get vrButton(){return this._vrButton}get sendToQuestButton(){return this._sendToQuestButton}get qrButton(){return Hs.getOrCreate().createQRCode()}createQuicklookButton(){if(this._quicklookButton)return this._quicklookButton;const t=document.createElement("button");this._quicklookButton=t,t.dataset.needle="quicklook-button";const e=Q.supportsQuickLookAR();let i="View in AR";Q.isVisionOS()?i="View in AR":(e||Q.isiOS())&&(i="Open in Quicklook"),t.innerText=i,t.prepend(Qi("view_in_ar")),ja.setElementPriority(t,h3);let n=!1,o=null;return t.addEventListener("click",()=>{o=Ef(Ge),o||(n=!0,o=new Ge),n&&(o.objectToExport=de.Current.scene),o?(t.classList.add("this-mode-is-requested"),o.exportAndOpen().then(()=>{t.classList.remove("this-mode-is-requested")}).catch(r=>{t.classList.remove("this-mode-is-requested"),console.error(r)})):console.warn("No USDZExporter component found in the scene")}),this.hideElementDuringXRSession(t),t}createARButton(t){var n;if(this._arButton)return this._arButton;const e="immersive-ar",i=document.createElement("button");return this._arButton=i,i.classList.add("webxr-button"),i.dataset.needle="webxr-ar-button",i.innerText="Enter AR",i.prepend(Qi("view_in_ar")),i.title="Click to start an AR session",i.addEventListener("click",()=>fe.start(e,t)),ja.setElementPriority(i,d3),this.updateSessionSupported(i,e),this.listenToXRSessionState(i,e),this.hideElementDuringXRSession(i),this.isSecureConnection||(i.disabled=!0,i.title="WebXR requires a secure connection (HTTPS)"),Q.isMozillaXR()||(n=navigator.xr)==null||n.addEventListener("devicechange",()=>this.updateSessionSupported(i,e)),i}createVRButton(t){var n;if(this._vrButton)return this._vrButton;const e="immersive-vr",i=document.createElement("button");return this._vrButton=i,i.classList.add("webxr-button"),i.dataset.needle="webxr-vr-button",i.innerText="Enter VR",i.prepend(Qi("panorama_photosphere")),i.title="Click to start a VR session",i.addEventListener("click",()=>fe.start(e,t)),ja.setElementPriority(i,c3),this.updateSessionSupported(i,e),this.listenToXRSessionState(i,e),this.hideElementDuringXRSession(i),this.isSecureConnection||(i.disabled=!0,i.title="WebXR requires a secure connection (HTTPS)"),Q.isMozillaXR()||(n=navigator.xr)==null||n.addEventListener("devicechange",()=>this.updateSessionSupported(i,e)),i}createSendToQuestButton(){var i;if(this._sendToQuestButton)return this._sendToQuestButton;const t="https://oculus.com/open_url/?url=",e=document.createElement("button");return this._sendToQuestButton=e,e.dataset.needle="webxr-sendtoquest-button",e.innerText="Open on Quest",e.prepend(Qi("share_windows")),e.title="Click to send this page to the Oculus Browser on your Quest",e.addEventListener("click",()=>{const n=encodeURIComponent(window.location.href),o=t+n;window.open(o)==null&&at("This page doesn't allow popups. Please paste "+o+" into your browser.")}),this.listenToXRSessionState(e),this.hideElementDuringXRSession(e),Q.isMozillaXR()||(i=navigator.xr)==null||i.addEventListener("devicechange",()=>{var n;(n=navigator.xr)!=null&&n.isSessionSupported("immersive-vr")?e.style.display="none":e.style.display=""}),e}createQRCode(){return Hs.getOrCreate().createQRCode()}updateSessionSupported(t,e){if(!(e==="immersive-ar"&&Q.isiOS()&&!Q.isVisionOS())){if(!("xr"in navigator)){t.style.display="none";return}fe.isSessionSupported(e).then(i=>{t.style.display=i?"":"none",X()&&!i&&console.log('[WebXR] "'+e+'" is not supported on this device. Make sure your server runs using HTTPS and you have a device connected that supports '+e)})}}hideElementDuringXRSession(t){W0(e=>{t["previous-display"]=t.style.display,t.style.setProperty("display","none","important")}),U1(e=>{t["previous-display"]!=null&&(t.style.display=t["previous-display"])})}listenToXRSessionState(t,e){e&&(fe.onSessionRequestStart(i=>{i.mode===e?t.classList.add("this-mode-is-requested"):(t["was-disabled"]=t.disabled,t.disabled=!0,t.classList.add("other-mode-is-requested"))}),fe.onSessionRequestEnd(i=>{t.classList.remove("this-mode-is-requested"),t.classList.remove("other-mode-is-requested"),t.disabled=t["was-disabled"]}))}};let za=hx;a(za,"_instance");var li=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Du=k("debugspriterenderer"),u3=k("wireframe"),dg=class{static getOrCreateGeometry(t){if(t.__cached_geometry)return t.__cached_geometry;if(t.guid&&dg.cache[t.guid])return Du&&console.log("Take cached geometry for sprite",t.guid),dg.cache[t.guid];const e=new Gs;t.__cached_geometry=e;const i=new Float32Array(t.triangles.length*3),n=new Float32Array(t.triangles.length*2);for(let o=0;o<t.triangles.length;o+=1){const r=t.triangles[o];i[o*3]=-t.vertices[r].x,i[o*3+1]=t.vertices[r].y,i[o*3+2]=0;const l=t.uv[r];n[o*2]=l.x,n[o*2+1]=1-l.y}return e.setAttribute("position",new Cn(i,3)),e.setAttribute("uv",new Cn(n,2)),t.guid&&(this.cache[t.guid]=e),Du&&console.log("Built sprite geometry",t,e),e}};let oc=dg;a(oc,"cache",{});var Qm;(function(s){s[s.Simple=0]="Simple",s[s.Sliced=1]="Sliced",s[s.Tiled=2]="Tiled"})(Qm||(Qm={}));class f3{constructor(){a(this,"x");a(this,"y")}}function sR(s){s&&(s.colorSpace!=Vr&&(s.colorSpace=Vr,s.needsUpdate=!0),s.minFilter==ym&&s.magFilter==ym&&(s.anisotropy=1,s.needsUpdate=!0))}let Ja=class{constructor(t){a(this,"guid");a(this,"texture");a(this,"triangles");a(this,"uv");a(this,"vertices");a(this,"__cached_geometry");a(this,"_mesh");a(this,"_material");t&&(this.texture=t,this.triangles=[0,1,2,0,2,3],this.uv=[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:0,y:1}],this.vertices=[{x:-.5,y:-.5},{x:.5,y:-.5},{x:.5,y:.5},{x:-.5,y:.5}])}get mesh(){return this._mesh||(this._mesh=new le(oc.getOrCreateGeometry(this),this.material)),this._mesh}get material(){return this._material||(this.texture&&sR(this.texture),this._material=new Ye({map:this.texture,color:16777215,side:Qn,transparent:!0})),this._material}getGeometry(){return oc.getOrCreateGeometry(this)}};li([g()],Ja.prototype,"guid",void 0);li([g(_t)],Ja.prototype,"texture",void 0);li([Nt()],Ja.prototype,"triangles",void 0);li([Nt()],Ja.prototype,"uv",void 0);li([Nt()],Ja.prototype,"vertices",void 0);const jb=Symbol("spriteOwner");class _f{constructor(){a(this,"sprites");this.sprites=[]}}li([g(Ja)],_f.prototype,"sprites",void 0);class Go{constructor(){a(this,"spriteSheet");a(this,"index",0)}static create(){const t=new Go;return t.spriteSheet=new _f,t}clone(){const t=new Go;return t.index=this.index,t.spriteSheet=this.spriteSheet,t}set sprite(t){t&&(this.spriteSheet?((this.index===null||this.index===void 0)&&(this.index=0),this.spriteSheet.sprites[this.index]=t):(this.spriteSheet=new _f,this.spriteSheet.sprites=[t],this.index=0))}get sprite(){if(this.spriteSheet)return this.spriteSheet.sprites[this.index]}update(t){if(!this.spriteSheet)return;const e=this.index;if(e<0||e>=this.spriteSheet.sprites.length)return;const i=this.spriteSheet.sprites[e],n=i==null?void 0:i.texture;if(n&&(sR(n),!i.__hasLoadedProgressive)){i.__hasLoadedProgressive=!0;const o=n;Tt.assignTextureLOD(n,0).then(r=>{r instanceof _t&&(i.texture=r,(t==null?void 0:t.map)===o&&(t.map=r,t.needsUpdate=!0))})}}}li([g(_f)],Go.prototype,"spriteSheet",void 0);li([g()],Go.prototype,"index",void 0);class Kn extends W{constructor(){super(...arguments);a(this,"drawMode",Qm.Simple);a(this,"size",{x:1,y:1});a(this,"color");a(this,"sharedMaterial");a(this,"transparent",!0);a(this,"cutoutThreshold",0);a(this,"castShadows",!1);a(this,"renderOrder",0);a(this,"toneMapped",!0);a(this,"_spriteSheet");a(this,"_currentSprite")}set texture(e){var n;if(!this._spriteSheet)return;const i=(n=this._spriteSheet.spriteSheet)==null?void 0:n.sprites[this.spriteIndex];i&&(i.texture=e,this.updateSprite())}addSprite(e,i=!1){var o,r;if(this._spriteSheet||(this._spriteSheet=Go.create()),!this._spriteSheet.spriteSheet)return-1;(o=this._spriteSheet.spriteSheet)==null||o.sprites.push(e);const n=((r=this._spriteSheet.spriteSheet)==null?void 0:r.sprites.length)-1;return i&&(this.spriteIndex=n),n}get sprite(){return this._spriteSheet}set sprite(e){if(e!==this._spriteSheet)if(typeof e=="number"){const i=Math.round(e);Du&&console.log("[SpriteSheet] Set index to "+i+" (was "+this.spriteIndex+")",e),this.spriteIndex=i}else e instanceof Ja?(this._spriteSheet||(this._spriteSheet=Go.create()),this._spriteSheet.sprite!=e&&(this._spriteSheet.sprite=e),this.updateSprite()):e!=this._spriteSheet&&(this._spriteSheet=e,this.updateSprite())}set spriteIndex(e){this._spriteSheet&&(this._spriteSheet.index=e,this.updateSprite())}get spriteIndex(){var e;return((e=this._spriteSheet)==null?void 0:e.index)??0}get spriteFrames(){var e,i;return((i=(e=this._spriteSheet)==null?void 0:e.spriteSheet)==null?void 0:i.sprites.length)??0}awake(){this._currentSprite=void 0,this._spriteSheet?this._spriteSheet=this._spriteSheet.clone():this._spriteSheet=Go.create(),Du&&console.log("Awake",this.name,this,this.sprite)}start(){this._currentSprite?this.gameObject&&this.gameObject.add(this._currentSprite):this.updateSprite()}updateSprite(e=!1){var o;if(!this.__didAwake&&!e)return!1;const i=this._spriteSheet;if(!((o=i==null?void 0:i.spriteSheet)!=null&&o.sprites))return console.warn("SpriteRenderer has no data or spritesheet assigned..."),!1;const n=i.spriteSheet.sprites[this.spriteIndex];if(!n)return Du&&console.warn("Sprite not found",this.spriteIndex,i.spriteSheet.sprites),!1;if(this._currentSprite)this._currentSprite.geometry=oc.getOrCreateGeometry(n),this._currentSprite.material.map=n.texture;else{const r=new Ye({color:16777215,side:Qn});if(u3&&(r.wireframe=!0),this.color&&(r.color||(r.color=new Se),r.color.copy(this.color),r.opacity=this.color.alpha),r.transparent=!0,r.toneMapped=this.toneMapped,r.depthWrite=!1,n.texture&&!r.wireframe){let l=n.texture;l[jb]!==void 0&&l[jb]!==this&&this.spriteFrames>1&&(l=n.texture=l.clone()),l[jb]=this,r.map=l}this.sharedMaterial=r,this._currentSprite=new le(oc.getOrCreateGeometry(n),r),this._currentSprite.renderOrder=Math.round(this.renderOrder),Tt.assignTextureLOD(r,0)}return this._currentSprite.parent!==this.gameObject&&(this.drawMode===Qm.Tiled&&this._currentSprite.scale.set(this.size.x,this.size.y,1),this.gameObject&&this.gameObject.add(this._currentSprite)),this._currentSprite&&this._currentSprite.layers.set(this.layer),this.sharedMaterial&&(this.sharedMaterial.alphaTest=this.cutoutThreshold,this.sharedMaterial.transparent=this.transparent),this._currentSprite.castShadow=this.castShadows,i==null||i.update(this.sharedMaterial),!0}}li([g()],Kn.prototype,"drawMode",void 0);li([g(f3)],Kn.prototype,"size",void 0);li([g(Te)],Kn.prototype,"color",void 0);li([g(Xe)],Kn.prototype,"sharedMaterial",void 0);li([g()],Kn.prototype,"transparent",void 0);li([g()],Kn.prototype,"cutoutThreshold",void 0);li([g()],Kn.prototype,"castShadows",void 0);li([g()],Kn.prototype,"renderOrder",void 0);li([g()],Kn.prototype,"toneMapped",void 0);li([g(Go)],Kn.prototype,"sprite",null);const oC=k("debugwebxr"),p3=new xe().makeRotationY(Math.PI),Th=class extends W{constructor(){super(...arguments);a(this,"_arScale",1);a(this,"invertForward",!1);a(this,"customReticle");a(this,"arTouchTransform",!0);a(this,"autoPlace",!1);a(this,"autoCenter",!1);a(this,"useXRAnchor",!1);a(this,"_isPlacing",!0);a(this,"_startOffset",new xe);a(this,"_createdPlacementObject",null);a(this,"_reparentedComponents",[]);a(this,"_placementScene",new Xn);a(this,"_reticle",[]);a(this,"_hits",[]);a(this,"_placementStartTime",-1);a(this,"_rigPlacementMatrix");a(this,"_anchor",null);a(this,"userInput");a(this,"onPlaceScene",e=>{var o;if(this._isPlacing==!1||e!=null&&e.used)return;let i=this._reticle[0];if(!i){console.warn("No reticle to place...");return}if(!i.visible&&!this.autoPlace){console.warn("Reticle is not visible (can not place)");return}if((o=fe.active)!=null&&o.isTrackingImages){console.warn("Scene Placement is disabled while images are being tracked");return}let n=this._hits[0];if(e&&e.origin instanceof z1){const r=this._reticle[e.origin.index];r&&(i=r,n=this._hits[e.origin.index])}if(e&&(e.stopImmediatePropagation(),e.stopPropagation(),e.use()),this._isPlacing=!1,this.context.input.removeEventListener("pointerup",this.onPlaceScene),this.onRevertSceneChanges(),i.position.copy(i.lastPos),i.quaternion.copy(i.lastQuat),this.onApplyPose(i),Th._hasPlaced=!0,this.useXRAnchor&&this.onCreateAnchor(fe.active,n),this.context.xr)for(const r of this.context.xr.controllers)r.cancelHitTestSource()});a(this,"upVec",new R(0,1,0));a(this,"lookPoint",new R);a(this,"worldUpVec",new R(0,1,0))}static onPlaced(e){const i="placed";return this._eventListeners[i]||(this._eventListeners[i]=[]),this._eventListeners[i].push(e),()=>{const n=this._eventListeners[i].indexOf(e);n>=0&&this._eventListeners[i].splice(n,1)}}static get hasPlaced(){return this._hasPlaced}get arScale(){return this._arScale}set arScale(e){this._arScale=Math.max(1e-6,e),this.onSetScale()}onEnable(){var e;(e=this.customReticle)==null||e.preload()}supportsXR(e){return e==="immersive-ar"}onEnterXR(e){oC&&console.log("ENTER WEBXR: SessionRoot start..."),this._anchor=null,Th._hasPlaced=!1,this.gameObject.updateMatrixWorld(),this._startOffset.copy(this.gameObject.matrixWorld);const i=new z;this._createdPlacementObject=i,i.name="AR Session Root",this._placementScene.name="AR Placement Scene",this._placementScene.children.length=0;for(let n=this.context.scene.children.length-1;n>=0;n--){const o=this.context.scene.children[n];this._placementScene.add(o)}if(this.context.scene.add(i),this.autoCenter){const n=On(this._placementScene.children),o=n.getCenter(new R),r=n.getSize(new R),l=new xe;l.makeTranslation(o.x,o.y-r.y*.5,o.z),this._startOffset.multiply(l)}this._reparentedComponents.length=0,this._reparentedComponents.push({comp:this,originalObject:this.gameObject}),I.addComponent(i,this);for(const n of this._reticle)xs(n);this._reticle.length=0,this._isPlacing=!0,this.context.input.addEventListener("pointerup",this.onPlaceScene,{queue:Pn.Early})}onLeaveXR(){this.context.input.removeEventListener("pointerup",this.onPlaceScene,{queue:Pn.Early}),this.onRevertSceneChanges(),this._anchor=null,Th._hasPlaced=!1,this._rigPlacementMatrix=void 0}onUpdateXR(e){var i,n,o,r;if(e.xr.isTrackingImages){for(const l of this._reticle)l.visible=!1;return}if(this._isPlacing){const l=(i=e.xr.rig)==null?void 0:i.gameObject;l&&l.parent!==this.context.scene&&this.context.scene.add(l);let c=!1;if(e.xr.isPassThrough&&e.xr.controllers.length>0&&!this.autoPlace)for(const h of e.xr.controllers){const d=h.getHitTest();d&&(c=!0,this.updateReticleAndHits(e.xr,h.index,d,e.xr.rigScale))}if(!c){const h=e.xr.getHitTest();h&&this.updateReticleAndHits(e.xr,0,h,e.xr.rigScale)}}else{if(this._anchor&&e.xr.referenceSpace){const l=e.xr.frame.getPose(this._anchor.anchorSpace,e.xr.referenceSpace);if(l&&this.context.time.frame%20===0){const c=e.xr.convertSpace(l.transform),h=this._reticle[0];h&&(h.position.copy(c.position),h.quaternion.copy(c.quaternion),this.onApplyPose(h))}}if(this.arTouchTransform?(this.userInput||(this.userInput=new lh(this.context)),(n=this.userInput)==null||n.enable()):(o=this.userInput)==null||o.disable(),this.arTouchTransform&&((r=this.userInput)!=null&&r.hasChanged)){if(e.xr.rig){const l=e.xr.rig.gameObject;this.userInput.applyMatrixTo(l.matrix,!0),l.matrix.decompose(l.position,l.quaternion,l.scale),this.userInput.factor=l.scale.x}this.userInput.reset()}}}updateReticleAndHits(e,i,n,o){this._hits[i]=n.hit;let r=this._reticle[i];if(!r){if(this.customReticle)if(this.customReticle.asset)r=cc(this.customReticle.asset);else{this.customReticle.loadAssetAsync();return}else r=new le(new fk(.07,.09,32).rotateX(-Math.PI/2),new Ye({side:Qn,depthTest:!1,depthWrite:!1,transparent:!0,opacity:1,color:15658734})),r.name="AR Placement Reticle";if(oC){const l=new Wn(1);l.position.y+=.01,r.add(l)}this._reticle[i]=r,r.matrixAutoUpdate=!1,r.visible=!1}if(r.lastPos=r.lastPos||n.position.clone(),r.lastQuat=r.lastQuat||n.quaternion.clone(),r.position.copy(r.lastPos.lerp(n.position,this.context.time.deltaTime/.1)),r.lastPos.copy(r.position),r.quaternion.copy(r.lastQuat.slerp(n.quaternion,this.context.time.deltaTime/.05)),r.lastQuat.copy(r.quaternion),r.scale.set(o,o,o),this.customReticle&&this.applyViewBasedTransform(r),r.updateMatrix(),r.visible=!0,r.parent!==this.context.scene&&this.context.scene.add(r),this._placementStartTime<0&&(this._placementStartTime=this.context.time.realtimeSinceStartup),this.autoPlace)if(this.upVec.set(0,1,0).applyQuaternion(r.quaternion),this.upVec.dot(te(0,1,0))>.9){let c=r["autoplace:timer"]||0;c>=1?(r.visible=!1,this.onPlaceScene(null)):(c+=this.context.time.deltaTime,r["autoplace:timer"]=c)}else r["autoplace:timer"]=0}onSetScale(){var i,n,o;if(!Th._hasPlaced)return;const e=(n=(i=fe.active)==null?void 0:i.rig)==null?void 0:n.gameObject;if(e){const r=((o=fe.active)==null?void 0:o.rigScale)||1,l=1/this._arScale*r,c=new xe().makeScale(l,l,l).invert();e.matrix.premultiply(c),e.matrix.decompose(e.position,e.quaternion,e.scale)}}onRevertSceneChanges(){var e;for(const i of this._reticle)i&&(i.visible=!1,i==null||i.removeFromParent());this._reticle.length=0;for(let i=this._placementScene.children.length-1;i>=0;i--){const n=this._placementScene.children[i];this.context.scene.add(n)}(e=this._createdPlacementObject)==null||e.removeFromParent();for(const i of this._reparentedComponents)I.addComponent(i.originalObject,i.comp)}async onCreateAnchor(e,i){if(i.createAnchor===void 0){console.warn("Hit does not support creating an anchor",i),X()&&qe("Hit does not support creating an anchor");return}else{const n=await i.createAnchor(e.viewerPose.transform);e.running&&n&&(this._anchor=n)}}applyViewBasedTransform(e){const i=this.context.mainCamera,n=e,o=i.worldPosition,r=n.worldPosition;this.upVec.set(0,1,0).applyQuaternion(e.quaternion);const l=i.worldPosition;l&&e.position.clone().sub(l).angleTo(this.upVec)<Math.PI/2&&this.upVec.negate();const c=this.upVec.angleTo(this.worldUpVec)*180/Math.PI,h=30;c>h&&c<180-h||c<-h&&c>-180+h?(this.lookPoint.copy(e.position).add(this.upVec),this.lookPoint.y=e.position.y,e.lookAt(this.lookPoint)):(o.y=r.y,e.lookAt(o))}onApplyPose(e){var o,r,l;const i=(r=(o=fe.active)==null?void 0:o.rig)==null?void 0:r.gameObject;if(!i){console.warn("No rig object to place");return}const n=i.parent||this.context.scene;this._rigPlacementMatrix?(l=this._rigPlacementMatrix)==null||l.decompose(i.position,i.quaternion,i.scale):this._rigPlacementMatrix=i.matrix.clone(),this.applyViewBasedTransform(e),e.updateMatrix(),this.context.scene.add(e),e.attach(i),e.removeFromParent(),i.scale.set(this.arScale,this.arScale,this.arScale),i.position.multiplyScalar(this.arScale),i.updateMatrix(),this.invertForward&&i.matrix.premultiply(p3),i.matrix.premultiply(this._startOffset),i.matrix.decompose(i.position,i.quaternion,i.scale),n.add(i)}};let No=Th;a(No,"_eventListeners",{}),a(No,"_hasPlaced",!1);const ug=class{constructor(t){a(this,"oneFingerDrag",!0);a(this,"twoFingerRotate",!0);a(this,"twoFingerScale",!0);a(this,"factor",1);a(this,"context");a(this,"offset");a(this,"plane");a(this,"_scale",1);a(this,"_hasChanged",!1);a(this,"_enabled",!1);a(this,"currentlyUsedPointerIds",new Set);a(this,"currentlyUnusedPointerIds",new Set);a(this,"onPointerDownEarly",t=>{this.isActive&&t.stopPropagation()});a(this,"onPointerDownLate",t=>{t.used?this.currentlyUsedPointerIds.add(t.pointerId):this.currentlyUsedPointerIds.size<=0&&this.currentlyUnusedPointerIds.add(t.pointerId)});a(this,"onPointerUpEarly",t=>{this.currentlyUsedPointerIds.delete(t.pointerId),this.currentlyUnusedPointerIds.delete(t.pointerId)});a(this,"prev",new Map);a(this,"_didMultitouch",!1);a(this,"touchStart",t=>{if(!t.defaultPrevented)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],n=Q.isAndroidDevice()&&i.clientY<window.innerHeight*.1;this.prev.has(i.identifier)||this.prev.set(i.identifier,{ignore:n,x:0,z:0,screenx:0,screeny:0});const o=this.prev.get(i.identifier);if(o){const r=this.getPositionOnPlane(i.clientX,i.clientY);o.x=r.x,o.z=r.z,o.screenx=i.clientX,o.screeny=i.clientY}}});a(this,"touchEnd",t=>{t.touches.length<=0&&(this._didMultitouch=!1);for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e];this.prev.delete(i.identifier)}});a(this,"touchMove",t=>{if(!t.defaultPrevented&&this.isActive){if(t.touches.length===1){if(this._didMultitouch)return;const e=t.touches[0],i=this.prev.get(e.identifier);if(!i||i.ignore)return;const n=this.getPositionOnPlane(e.clientX,e.clientY),o=n.x-i.x,r=n.z-i.z;if(o===0&&r===0)return;this.oneFingerDrag&&this.addMovement(o,r),i.x=n.x,i.z=n.z,i.screenx=e.clientX,i.screeny=e.clientY;return}else if(t.touches.length===2){this._didMultitouch=!0;const e=t.touches[0],i=t.touches[1],n=this.prev.get(e.identifier),o=this.prev.get(i.identifier);if(!n||!o)return;if(this.twoFingerRotate){const r=Math.atan2(e.clientY-i.clientY,e.clientX-i.clientX),l=Math.atan2(n.screeny-o.screeny,n.screenx-o.screenx),c=r-l;Math.abs(c)>.001&&this.addRotation(c)}if(this.twoFingerScale){const r=e.clientX-i.clientX,l=e.clientY-i.clientY,c=Math.sqrt(r*r+l*l),h=n.screenx-o.screenx,d=n.screeny-o.screeny,u=Math.sqrt(h*h+d*d),f=c-u;Math.abs(f)>2&&this.addScale(f)}n.screenx=e.clientX,n.screeny=e.clientY,o.screenx=i.clientX,o.screeny=i.clientY}}});a(this,"_raycaster",new xg);a(this,"_intersection",new R);a(this,"_screenPos",new R);a(this,"_tempMatrix",new xe);this.context=t,this.offset=new xe,this.plane=new lc,this.plane.setFromNormalAndCoplanarPoint(ug.up,ug.zero)}get scale(){return this._scale}reset(){this._scale=1,this.offset.identity(),this._hasChanged=!0}get hasChanged(){return this._hasChanged}applyMatrixTo(t,e){this._hasChanged=!1,e?(this.offset.invert(),t.premultiply(this.offset)):t.multiply(this.offset)}get isActive(){return this.currentlyUsedPointerIds.size<=0&&this.currentlyUnusedPointerIds.size>0}enable(){this._enabled||(this._enabled=!0,this.context.input.addEventListener("pointerdown",this.onPointerDownEarly,{queue:Pn.Early}),this.context.input.addEventListener("pointerdown",this.onPointerDownLate,{queue:Pn.Late}),this.context.input.addEventListener("pointerup",this.onPointerUpEarly,{queue:Pn.Early}),window.addEventListener("touchstart",this.touchStart,{passive:!1}),window.addEventListener("touchmove",this.touchMove,{passive:!1}),window.addEventListener("touchend",this.touchEnd,{passive:!1}))}disable(){this._enabled&&(this._enabled=!1,this.context.input.removeEventListener("pointerdown",this.onPointerDownEarly,{queue:Pn.Early}),this.context.input.removeEventListener("pointerdown",this.onPointerDownLate,{queue:Pn.Late}),this.context.input.removeEventListener("pointerup",this.onPointerUpEarly,{queue:Pn.Early}),window.removeEventListener("touchstart",this.touchStart),window.removeEventListener("touchmove",this.touchMove),window.removeEventListener("touchend",this.touchEnd))}getPositionOnPlane(t,e){const i=this.context.mainCamera;return this._screenPos.x=t/window.innerWidth*2-1,this._screenPos.y=-(e/window.innerHeight)*2+1,this._screenPos.z=1,this._screenPos.unproject(i),this._raycaster.set(i.position,this._screenPos.sub(i.position)),this._raycaster.ray.intersectPlane(this.plane,this._intersection),this._intersection}addMovement(t,e){t/=this._scale,e/=this._scale,t*=this.factor,e*=this.factor,this.offset.elements[12]+=t,this.offset.elements[14]+=e,(t!==0||e!==0)&&(this._hasChanged=!0)}addScale(t){t/=window.innerWidth,t*=-1,this._scale*=1+t,this._tempMatrix.makeScale(1-t,1-t,1-t),this.offset.premultiply(this._tempMatrix),t!==0&&(this._hasChanged=!0)}addRotation(t){t*=-1,this._tempMatrix.makeRotationY(t),this.offset.premultiply(this._tempMatrix),t!==0&&(this._hasChanged=!0)}};let lh=ug;a(lh,"up",new R(0,1,0)),a(lh,"zero",new R(0,0,0)),a(lh,"one",new R(1,1,1));const Ra=k("debugautosync"),Fb=Symbol("syncerId");class m3{constructor(){a(this,"_syncers",{})}getOrCreateSyncer(t){if(!t.guid)return null;if(this._syncers[t.guid])return this._syncers[t.guid];const e=new g3(t);return e[Fb]=t.guid,this._syncers[e[Fb]]=e,e}removeSyncer(t){delete this._syncers[t[Fb]]}}const Tv=new m3;class g3{constructor(t){a(this,"comp");a(this,"hasChanges",!1);a(this,"changedProperties",{});a(this,"_isReceiving",!1);a(this,"_isInit",!1);a(this,"onHandleSending",()=>{if(!this.hasChanges)return;this.hasChanges=!1;const t=this.comp.context.connection;if(!t||!t.isConnected||!t.isInRoom){for(const e in this.changedProperties)delete this.changedProperties[e];return}for(const e in this.changedProperties){const i=this.changedProperties[e];Ra&&console.log("SEND",this.comp.guid,this.networkingKey),t.send(this.networkingKey,{guid:this.comp.guid,property:e,data:i},Ns.Queued),delete this.changedProperties[e]}});a(this,"onHandleReceiving",t=>{if(Ra&&console.log("SYNCFIELD RECEIVE",this.comp.name,this.comp.guid,t),!!this._isInit&&this.comp&&t.guid===this.comp.guid)try{this._isReceiving=!0,this.comp[t.property]=t.data}catch(e){console.error(e)}finally{this._isReceiving=!1}});this.comp=t}get networkingKey(){return this.comp.guid}init(t){if(this._isInit)return;this._isInit=!0,this.comp=t,this.comp.context.post_render_callbacks.push(this.onHandleSending),this.comp.context.connection.beginListen(this.networkingKey,this.onHandleReceiving);const e=this.comp.context.connection.tryGetState(this.comp.guid);e&&this.onHandleReceiving(e)}destroy(){this._isInit&&(this.comp.context.post_render_callbacks.splice(this.comp.context.post_render_callbacks.indexOf(this.onHandleSending),1),this.comp.context.connection.stopListen(this.networkingKey,this.onHandleReceiving),this.comp=null,this._isInit=!1)}notifyChanged(t,e){this._isReceiving||(Ra&&console.log("Property changed: "+t,e),this.hasChanges=!0,this.changedProperties[t]=e)}}function y3(s,t){let e=t!==s;return!e&&s&&t&&(Array.isArray(s)&&Array.isArray(t)||typeof s=="object"&&typeof t=="object")&&(e=!0),e}const ju=Symbol("AutoSyncHandler");function b3(s){if(s[ju])return s[ju];const t=Tv.getOrCreateSyncer(s);return t==null||t.init(s),s[ju]=t,t}function _3(s){const t=s[ju];t&&(Tv.removeSyncer(t),t.destroy(),delete s[ju])}const oR=function(s=null){return function(t,e){var d;let i="";typeof e=="string"?i=e:i=e.name;let n=null,o;typeof s=="string"?o=t[s]:typeof s=="function"&&(o=s),o==null&&(X()||Ra)&&s!=null&&console.warn('syncField: no callback function found for property "'+i+'"','"'+s+'"');const r=t,l=r.__internalAwake;if(typeof l!="function"){(Ra||X())&&console.error('@syncField can currently only used on Needle Engine Components, custom object of type "'+((d=t==null?void 0:t.constructor)==null?void 0:d.name)+'" is not supported',t);return}Ra&&console.log(i);const c=Symbol(i);r.__internalAwake=function(){if(this[c]!==void 0)return;this[c]=this[i],n=Tv.getOrCreateSyncer(this);const u=Object.getOwnPropertyDescriptor(this,i);if((u==null?void 0:u.set)===void 0){let f=!1;Object.defineProperty(this,i,{set:function(p){var x;const b=this[c];if(this[c]=p,f){(X()||Ra)&&console.warn("Recursive call detected",i);return}f=!0;try{const v=y3(p,b);Ra&&console.log("SyncField assignment",i,"changed?",v,p,o),v&&(o==null?void 0:o.call(this,p,b))!==!1&&((x=b3(this))==null||x.notifyChanged(i,p))}finally{f=!1}},get:function(){return this[c]},configurable:!0,enumerable:!0})}n==null||n.init(this),l.call(this)};const h=r.__internalDestroy;r.__internalDestroy=function(){_3(this),h.call(this)}}};var ey=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const an=k("debugplayersync");class Rc extends W{constructor(){super(...arguments);a(this,"autoSync",!0);a(this,"asset");a(this,"onPlayerSpawned");a(this,"_localInstance");a(this,"onJoinedRoom",()=>{an&&console.log("PlayerSync.joinedRoom. autoSync is set to "+this.autoSync),this.autoSync&&this.getInstance()});a(this,"destroyInstance",()=>{var e;(e=this._localInstance)==null||e.then(i=>{an&&console.log("PlayerSync.destroyInstance",i),Fg(i,this.context.connection,!0,{saveInRoom:!1})}),this._localInstance=void 0})}static async setupFrom(e,i){const n=we.getOrCreateFromUrl(e);if(!n.asset){const l=await n.loadAssetAsync();l&&I.getOrAddComponent(l,oi)}const o=new Rc;o._internalInit(i),o.asset=n;const r=new z;return r.guid=e,I.addComponent(r,o),o}awake(){this.watchTabVisible(),this.onPlayerSpawned||(this.onPlayerSpawned=new je)}onEnable(){this.context.connection.beginListen(me.RoomStateSent,this.onJoinedRoom),this.context.connection.beginListen(me.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(me.LeftRoom,this.destroyInstance),this.context.connection.isInRoom&&this.onJoinedRoom()}onDisable(){this.context.connection.stopListen(me.RoomStateSent,this.onJoinedRoom),this.context.connection.stopListen(me.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(me.LeftRoom,this.destroyInstance)}async getInstance(){var i,n,o,r,l,c;if(this._localInstance)return this._localInstance;if(an&&console.log("PlayerSync.createInstance",(i=this.asset)==null?void 0:i.url),!((n=this.asset)!=null&&n.asset)&&!((o=this.asset)!=null&&o.url))return console.error('PlayerSync: can not create an instance because "asset" is not set and or has no URL!'),null;this.gameObject.guid||console.warn("PlayerSync: gameObject has no guid! This might cause issues with syncing the player state."),this._localInstance=(r=this.asset)==null?void 0:r.instantiateSynced({parent:this.gameObject,deleteOnDisconnect:!0},!0);const e=await this._localInstance;if(e){const h=I.getComponentsInChildren(e,oi);if(an&&console.log(`PlayerSync.createInstance: found ${h==null?void 0:h.length} PlayerState components. Owner: ${this.context.connection.connectionId}`),h!=null&&h.length){for(const d of h)d.owner=this.context.connection.connectionId;(l=this.onPlayerSpawned)==null||l.invoke(e)}else this._localInstance=void 0,console.error("<strong>Failed finding PlayerState on "+((c=this.asset)==null?void 0:c.url)+"</strong>: please make sure the asset has a PlayerState component!"),I.destroySynced(e)}else this._localInstance=void 0,console.warn("PlayerSync: failed instantiating asset!");return this._localInstance}watchTabVisible(){window.addEventListener("visibilitychange",e=>{if(document.visibilityState==="visible")for(let i=oi.all.length-1;i>=0;i--){const n=oi.all[i];(!n.owner||!this.context.connection.userIsInRoom(n.owner))&&n.doDestroy()}})}}ey([g()],Rc.prototype,"autoSync",void 0);ey([g(we)],Rc.prototype,"asset",void 0);ey([g(je)],Rc.prototype,"onPlayerSpawned",void 0);var l0;(function(s){s.OwnerChanged="ownerChanged"})(l0||(l0={}));const Kt=class extends W{constructor(){super(...arguments);a(this,"onOwnerChangeEvent",new je);a(this,"onFirstOwnerChangeEvent",new je);a(this,"hasOwner",!1);a(this,"owner");a(this,"dontDestroy",!1);a(this,"onUserLeftRoom",e=>{if(e.userId===this.owner){an&&console.log("PLAYERSYNC LEFT",this.owner),this.doDestroy();return}})}static get all(){return Kt._all}static get local(){return Kt._local}static getFor(e){if(e instanceof z)return I.getComponentInParent(e,Kt);if(e instanceof W)return I.getComponentInParent(e.gameObject,Kt)}static isLocalPlayer(e){const i=Kt.getFor(e);return(i==null?void 0:i.isLocalPlayer)??!1}static addEventListener(e,i){return this._callbacks[e]||(this._callbacks[e]=[]),this._callbacks[e].push(i),i}static removeEventListener(e,i){if(!this._callbacks[e])return;const n=this._callbacks[e].indexOf(i);n>=0&&this._callbacks[e].splice(n,1)}static dispatchEvent(e,i){if(this._callbacks[e])for(const n of this._callbacks[e])n(i)}get isLocalPlayer(){return this.owner===this.context.connection.connectionId}onOwnerChange(e,i){var l,c;an&&console.log(`PlayerSync.onOwnerChange: ${i} ‚Üí ${e} (me: ${this.context.connection.connectionId})`);const n=Kt._local.indexOf(this);n>=0&&Kt._local.splice(n,1);const o={playerState:this,oldValue:i,newValue:e};if(this.hasOwner||(this.hasOwner=!0,(l=this.onFirstOwnerChangeEvent)==null||l.invoke(o)),(c=this.onOwnerChangeEvent)==null||c.invoke(o),this.owner===this.context.connection.connectionId){Kt._local.push(this);const h=new CustomEvent("local-owner-changed",{detail:o});this.dispatchEvent(h)}const r=new CustomEvent("owner-changed",{detail:o});this.dispatchEvent(r),Kt.dispatchEvent(l0.OwnerChanged,r)}awake(){Kt.all.push(this),an&&console.log("Registered new PlayerState",this.guid,Kt.all.length-1,Kt.all),this.context.connection.beginListen(me.UserLeftRoom,this.onUserLeftRoom)}async start(){an&&console.log("PLAYERSTATE.START, owner: "+this.owner,this.context.connection.usersInRoom([])),this.owner?(this.context.connection.isInRoom||await Ha(300),this.context.connection.userIsInRoom(this.owner)==!1&&(an&&console.log(`PlayerSync.start ‚Üí doDestroy "${this.name}" because user "${this.owner}" is not in room anymore...`,"Currently in room:",...this.context.connection.usersInRoom()),this.doDestroy())):this.owner||(an&&console.warn("PlayerState.start ‚Üí owner is undefined!",this.name),setTimeout(()=>{!this.destroyed&&!this.owner?this.dontDestroy?an&&console.warn("PlayerState.start ‚Üí owner is still undefined but dontDestroy is set to true",this.name):(an&&console.warn(`PlayerState.start ‚Üí owner is still undefined: destroying "${this.name}" instance now`),this.doDestroy()):an&&console.log("PlayerState.start ‚Üí owner is assigned",this.owner)},2e3))}doDestroy(){an&&console.log("PlayerSync.doDestroy ‚Üí syncDestroy",this.name),Fg(this.gameObject,this.context.connection,!0,{saveInRoom:!1})}onDestroy(){if(an&&console.warn("PlayerState.onDestroy",this.owner),this.context.connection.stopListen(me.UserLeftRoom,this.onUserLeftRoom),Kt.all.splice(Kt.all.indexOf(this),1),this.isLocalPlayer){const e=Kt._local.indexOf(this);e>=0&&Kt._local.splice(e,1)}}};let oi=Kt;a(oi,"_all",[]),a(oi,"_local",[]),a(oi,"_callbacks",{});ey([oR(oi.prototype.onOwnerChange)],oi.prototype,"owner",void 0);var gd=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class ea extends W{constructor(){super(...arguments);a(this,"position","bottom");a(this,"showNeedleLogo",!1);a(this,"showSpatialMenu");a(this,"createFullscreenButton");a(this,"createMuteButton");a(this,"createQRCodeButton")}onEnable(){this.applyOptions()}applyOptions(){this.context.menu.setPosition(this.position),this.context.menu.showNeedleLogo(this.showNeedleLogo),this.createFullscreenButton===!0&&this.context.menu.showFullscreenOption(!0),this.createMuteButton===!0&&this.context.menu.showAudioPlaybackOption(!0),this.showSpatialMenu===!0&&this.context.menu.showSpatialMenu(this.showSpatialMenu),this.createQRCodeButton===!0&&(Q.isMobileDevice()||this.context.menu.showQRCodeButton(!0))}}gd([g()],ea.prototype,"position",void 0);gd([g()],ea.prototype,"showNeedleLogo",void 0);gd([g()],ea.prototype,"showSpatialMenu",void 0);gd([g()],ea.prototype,"createFullscreenButton",void 0);gd([g()],ea.prototype,"createMuteButton",void 0);gd([g()],ea.prototype,"createQRCodeButton",void 0);var Rv=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Hd=k("debugwebxr"),rC=new re().setFromAxisAngle(new R(0,1,0),Math.PI);class uc extends W{constructor(){super(...arguments);a(this,"head");a(this,"leftHand");a(this,"rightHand");a(this,"_leftHandMeshes");a(this,"_rightHandMeshes");a(this,"_syncTransforms")}async onEnterXR(e){var n;if(!this.activeAndEnabled)return;Hd&&console.warn("AVATAR ENTER XR",this.guid,this.sourceId,this,this.activeAndEnabled),this._syncTransforms&&(this._syncTransforms.length=0),await this.prepareAvatar();const i=oi.getFor(this);if(i!=null&&i.owner){const o=this.gameObject.addComponent(ni);o.avatar=this.gameObject,o.connectionId=i.owner,this.context.players.setPlayerView(i.owner,(n=this.head)==null?void 0:n.asset,Ho.Headset)}else this.context.connection.isConnected?console.error("No player state found for avatar",this):i&&!this.context.connection.isConnected&&(i.dontDestroy=!0)}onLeaveXR(e){const i=this.gameObject.getComponent(ni);i&&i.destroy()}onUpdateXR(e){var h,d;if(!this.activeAndEnabled)return;const i=oi.isLocalPlayer(this);if(!i)return;const n=e.xr;if(n.rig&&n.rig.gameObject!==this.gameObject.parent&&(this.gameObject.position.set(0,0,0),this.gameObject.rotation.set(0,0,0),this.gameObject.scale.set(1,1,1),n.rig.gameObject.add(this.gameObject)),this._syncTransforms&&i)for(const u of this._syncTransforms)u.fastMode=!0,u.isOwned()||u.requestOwnership();if(this.head&&this.context.mainCamera){const u=this.head.asset;if(u.position.copy(this.context.mainCamera.position),u.position.x*=-1,u.position.z*=-1,u.quaternion.copy(this.context.mainCamera.quaternion),u.quaternion.x*=-1,this.context.time.frameCount%10===0&&this.head.asset){const f=I.getComponentsInChildren(this.head.asset,Ci);for(const p of f)p.enabled=!1,p.gameObject.visible=!1}}const o=e.xr.leftController,r=(h=this.leftHand)==null?void 0:h.asset;o&&r?(r.position.copy(o.gripPosition),r.quaternion.copy(o.gripQuaternion),r.quaternion.multiply(rC),r.visible=o.isTracking,this.updateHandVisibility(o,r,this._leftHandMeshes)):r&&r.visible&&(r.visible=!1);const l=e.xr.rightController,c=(d=this.rightHand)==null?void 0:d.asset;l&&c?(c.position.copy(l.gripPosition),c.quaternion.copy(l.gripQuaternion),c.quaternion.multiply(rC),c.visible=l.isTracking,this.updateHandVisibility(l,c,this._rightHandMeshes)):c&&c.visible&&(c.visible=!1)}onBeforeRender(){this.context.xr&&this.context.time.frame%10===0&&this.updateRemoteAvatarVisibility()}updateHandVisibility(e,i,n){if(n){const o=e.model&&e.model.visible&&e.model!==i;n.forEach(r=>{Rr(r,!o)})}}updateRemoteAvatarVisibility(){var e,i,n;if(this.context.connection.isConnected){const o=oi.getFor(this);if(o&&o.isLocalPlayer==!1){const r=fe.getXRSync(this.context);if(r&&r.hasState(o.owner)){this.tryFindAvatarObjectsIfMissing();const l=(e=this.leftHand)==null?void 0:e.asset;l&&(l.visible=(r==null?void 0:r.isTracking(o.owner,"left"))??!1);const c=(i=this.rightHand)==null?void 0:i.asset;c&&(c.visible=(r==null?void 0:r.isTracking(o.owner,"right"))??!1)}if((n=this.head)!=null&&n.asset){const l=I.getComponentsInChildren(this.head.asset,Ci);for(const c of l)c.enabled=!1,c.gameObject.visible=!0}}}}tryFindAvatarObjectsIfMissing(){if(!this.head||!this.leftHand||!this.rightHand){const e={head:this.head,leftHand:this.leftHand,rightHand:this.rightHand};JA.tryFindAvatarObjects(this.gameObject,this.sourceId||"",e),e.head&&(this.head=e.head),e.leftHand&&(this.leftHand=e.leftHand),e.rightHand&&(this.rightHand=e.rightHand)}}async prepareAvatar(){var e,i;if(this.tryFindAvatarObjectsIfMissing(),this.head)this.head instanceof z&&(this.head=new we("",this.sourceId,this.head));else{const n=new z;n.name="Head";const o=_c.createPrimitive(Ws.Cube);n.add(o),this.gameObject.add(n),this.head=new we("",this.sourceId,n),Hd&&console.log("Create head",n)}if(this.rightHand)this.rightHand instanceof z&&(this.rightHand=new we("",this.sourceId,this.rightHand));else{const n=new z;n.name="Right Hand",this.gameObject.add(n),this.rightHand=new we("",this.sourceId,n),Hd&&console.log("Create right hand",n)}if(this.leftHand)this.leftHand instanceof z&&(this.leftHand=new we("",this.sourceId,this.leftHand));else{const n=new z;n.name="Left Hand",this.gameObject.add(n),this.leftHand=new we("",this.sourceId,n),Hd&&console.log("Create left hand",n)}await this.loadAvatarObjects(this.head,this.leftHand,this.rightHand),this._leftHandMeshes=[],(e=this.leftHand.asset)==null||e.traverse(n=>{n!=null&&n.isMesh&&this._leftHandMeshes.push(n)}),this._rightHandMeshes=[],(i=this.rightHand.asset)==null||i.traverse(n=>{n!=null&&n.isMesh&&this._rightHandMeshes.push(n)}),oi.isLocalPlayer(this.gameObject)&&(this._syncTransforms=I.getComponentsInChildren(this.gameObject,Zo))}async loadAvatarObjects(e,i,n){const o=e.loadAssetAsync(),r=i.loadAssetAsync(),l=n.loadAssetAsync(),c=new Array;o&&c.push(o),r&&c.push(r),l&&c.push(l);const h=await g1(c);Hd&&console.log("Avatar loaded results:",h)}}Rv([g(we)],uc.prototype,"head",void 0);Rv([g(we)],uc.prototype,"leftHand",void 0);Rv([g(we)],uc.prototype,"rightHand",void 0);var ty=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const ha=k("debugwebxr"),da=new Array;class Gr extends W{constructor(){super(...arguments);a(this,"createControllerModel",!0);a(this,"createHandModel",!0);a(this,"customLeftHand");a(this,"customRightHand");a(this,"_models",new Array)}supportsXR(e){return e==="immersive-vr"||e==="immersive-ar"}async onXRControllerAdded(e){var o;if(!(e.xr.isVR||e.xr.isPassThrough))return;console.debug("XR Controller Added",e.controller.side,e.controller.index);const{controller:n}=e;if(this.createControllerModel||this.createHandModel){if(n.hand){if(this.createHandModel){const r=await this.loadHandModel(this,n);if(!r||!n.connected||!n.isHand){r!=null&&r.handObject&&Vd(r.handObject,!1),(o=r==null?void 0:r.handObject)==null||o.destroy();return}this._models.push({controller:n,model:r.handObject,handmesh:r.handmesh}),this._models.sort((l,c)=>l.controller.index-c.controller.index),this.scene.add(r.handObject),n.model=r.handObject}}else if(this.createControllerModel){const r=await n.getModelUrl();if(r){const l=await this.loadModel(n,r);if(!l||!n.connected||n.isHand)return;this._models.push({controller:n,model:l}),this._models.sort((c,h)=>c.controller.index-h.controller.index),this.scene.add(l),l.traverse(c=>{c.layers.set(2),c.matrixAutoUpdate=!1,c.updateMatrix()}),n.model=l}else n.targetRayMode!=="transient-pointer"&&console.warn("XRControllerModel: no model found for "+n.side)}}}onXRControllerRemoved(e){console.debug("XR Controller Removed",e.controller.side,e.controller.index);const i=this._models.findIndex(o=>o.controller===e.controller),n=this._models[i];n&&(this._models.splice(i,1),n.model&&(Vd(n.model,!1),n.model.destroy(),n.model=void 0))}onBeforeXR(e,i){this.createHandModel&&(this.customLeftHand||this.customRightHand)&&(i.optionalFeatures=i.optionalFeatures||[],i.optionalFeatures.includes("hand-tracking")||i.optionalFeatures.push("hand-tracking"))}onLeaveXR(e){for(const i of this._models)i&&(i.model&&(Vd(i.model,!1),i.model.destroy(),i.model=void 0),i.controller.model===i.model&&(i.controller.model=null));this._models.length=0}onBeforeRender(){if(fe.active&&(ha&&(da[0]=Date.now()),this.updateRendering(fe.active),ha)){const e=Date.now()-da[0];da.push(e),da.length>=30&&(da[0]=0,da.reduce((i,n)=>i+n,0)/da.length,da.length=0)}}updateRendering(e){var i,n,o,r,l;for(let c=0;c<this._models.length;c++){const h=this._models[c];if(!h)continue;const d=h.controller;if(!d.connected){ha&&console.warn("XRControllerModel.onUpdateXR: controller is not connected anymore",d.side,d.hand);continue}if(h.model&&!h.handmesh)h.model.matrixAutoUpdate=!1,h.model.matrix.copy(d.gripMatrix),h.model.visible=d.isTracking,(i=e.rig)==null||i.gameObject.add(h.model);else if(d.inputSource.hand&&h.handmesh){const u=e.referenceSpace,f=this.context.renderer.xr.getHand(d.index);if(u&&e.frame.getJointPose){for(const p of d.inputSource.hand.values()){const b=f.joints[p.jointName];if(b){const x=d.getHandJointPose(p);if(x){const v=x.transform.position,S=x.transform.orientation;b.position.copy(v),b.quaternion.copy(S),b.matrixAutoUpdate=!1}b.visible=x!=null}}h.model&&(h.model.visible=d.isTracking,h.model.visible&&h.model.parent!==((n=e.rig)==null?void 0:n.gameObject)&&((o=e.rig)==null||o.gameObject.add(h.model))),(r=h.model)!=null&&r.visible&&((l=h.handmesh)==null||l.updateMesh(),h.model.matrixAutoUpdate=!1,h.model.matrix.identity(),h.model.applyMatrix4(Mh))}}}}async loadModel(e,i){var r;if(!e.connected)return console.warn("XRControllerModel.onXRControllerAdded: controller is not connected anymore",e.side),null;const o=await we.getOrCreate("",i).instantiate();return Vd(o),(r=fe.active)!=null&&r.isPassThrough&&o.traverseVisible(l=>{this.makeOccluder(l)}),o}async loadHandModel(e,i){const n=this.context,o=n.renderer.xr.getHand(i.index);o||(ha?se.DrawLabel(i.rayWorldPosition,"No hand found for index "+i.index,.05,5):console.warn("No hand found for index "+i.index));const r=new Wr;dv(r,n),await n0(r,n,this.sourceId??"",this.sourceId??"");const l=BT(r);let c="";const h=i.side==="left"?this.customLeftHand:this.customRightHand;h?(c=h.url.split(".").slice(0,-1).join("."),r.setPath("")):(c=i.inputSource.handedness==="left"?"left":"right",r.setPath("https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/"));const d=new z;Vd(d);const u=new Wk(d,o,r.path,c,r,f=>{var b;const p=l==null?void 0:l.gltf;((b=p==null?void 0:p.scene.children)==null?void 0:b.length)===0&&(p.scene.children[0]=f),l!=null&&l.gltf&&Ko().createBuiltinComponents(e.context,e.sourceId||c,l.gltf,null,l),f.traverse(x=>{var v;x.layers.set(2),(v=fe.active)!=null&&v.isPassThrough&&!h&&this.makeOccluder(x),x instanceof le&&Tt.assignMeshLOD(x,0)}),i.connected||(ha&&se.DrawLabel(i.rayWorldPosition,"Hand is loaded but not connected anymore",.05,5),f.removeFromParent())});if(ha&&d.add(new Wn(.5)),i.inputSource.hand){ha&&console.log(i.inputSource.hand);for(const f of i.inputSource.hand.values())if(o.joints[f.jointName]===void 0){const p=new Ir;p.matrixAutoUpdate=!1,p.visible=!0,o.joints[f.jointName]=p,o.add(p)}}else ha&&se.DrawLabel(i.rayWorldPosition,"No inputSource.hand found for index "+i.index,.05,5);return{handObject:d,handmesh:u}}makeOccluder(e){if(e instanceof le){let i=e.material;i instanceof Xe&&(i=e.material=i.clone(),i.depthWrite=!0,i.depthTest=!0,i.colorWrite=!1,e.receiveShadow=!1,e.renderOrder=-100)}}}a(Gr,"factory",new Vk);ty([g()],Gr.prototype,"createControllerModel",void 0);ty([g()],Gr.prototype,"createHandModel",void 0);ty([g(we)],Gr.prototype,"customLeftHand",void 0);ty([g(we)],Gr.prototype,"customRightHand",void 0);class Ov extends W{}var el=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Bb=k("debugwebxr");class Cs extends W{constructor(){super(...arguments);a(this,"movementSpeed",1.5);a(this,"rotationStep",30);a(this,"useTeleport",!0);a(this,"usePinchToTeleport",!0);a(this,"useTeleportTarget",!1);a(this,"useTeleportFade",!1);a(this,"showRays",!0);a(this,"showHits",!0);a(this,"isXRMovementHandler",!0);a(this,"xrSessionMode","immersive-vr");a(this,"_didApplyRotation",!1);a(this,"_didTeleport",!1);a(this,"_teleportBuffer",new Array);a(this,"_plane",null);a(this,"_lines",[]);a(this,"_hitDiscs",[]);a(this,"_hitDistances",[]);a(this,"_lastHitDistances",[]);a(this,"hitPointRaycastFilter",e=>e.type==="SkinnedMesh"?"continue in children":!0)}onUpdateXR(e){const i=e.xr.rig;if(!(i!=null&&i.gameObject)||e.xr.isPassThrough)return;const n=e.xr.leftController,o=e.xr.rightController;n&&this.onHandleMovement(n,i.gameObject),o&&(this.onHandleRotation(o,i.gameObject),this.useTeleport&&this.onHandleTeleport(o,i.gameObject))}onLeaveXR(e){for(const i of this._lines)i.removeFromParent();for(const i of this._hitDiscs)i==null||i.removeFromParent()}onBeforeRender(){var e;(e=this.context.xr)!=null&&e.running&&(this.showRays&&this.renderRays(this.context.xr),this.showHits&&this.renderHits(this.context.xr))}onHandleMovement(e,i){const n=e.getStick("xr-standard-thumbstick");if(n.x!=0||n.y!=0){const o=te(n.x,0,n.y);o.multiplyScalar(this.context.time.deltaTimeUnscaled*this.movementSpeed);const r=Lt(i);o.multiplyScalar(r.x),o.applyQuaternion(e.xr.poseOrientation),o.y=0,o.applyQuaternion(i.worldQuaternion),X()&&Number.isNaN(o.x)&&console.error("Stick movement resulted in NaN",{stick:n,vec:o}),i.position.add(o),i.updateWorldMatrix(!1,!1);for(const l of i.children)l.updateWorldMatrix(!1,!1)}}onHandleRotation(e,i){if(e._isMxInk)return;const o=e.getStick("xr-standard-thumbstick").x;if(this._didApplyRotation)Math.abs(o)<.3&&(this._didApplyRotation=!1);else if(Math.abs(o)>.5){this._didApplyRotation=!0;const r=o>0?1:-1,l=ve(this.context.mainCamera).clone();i.rotateY(r*ee.toRadians(this.rotationStep));const h=ve(this.context.mainCamera).clone().sub(l);h.y=0,i.position.sub(h)}}onHandleTeleport(e,i){var o,r,l,c,h;let n=0;if(e.hand&&this.usePinchToTeleport&&e.isTeleportGesture){const d=e.getPointerId("primary");if(d!=null&&this.context.input.getIsPointerIdInUse(d))return;const u=e.getGesture("pinch");u&&(n=u.value)}else n=(o=e.getStick("xr-standard-thumbstick"))==null?void 0:o.y;if(this._didTeleport)n>=0&&n<.4?this._didTeleport=!1:n<0&&n>-.4&&(this._didTeleport=!1);else if(n>.8){this._didTeleport=!0;const d=this.context.physics.raycastFromRay(e.ray)[0];if(d&&d.object instanceof Xh){const f=(r=d.normal)==null?void 0:r.dot(te(0,1,0));if(f!==void 0&&f<.4)return}let u=d==null?void 0:d.point;if(!u&&!this.useTeleportTarget){this._plane||(this._plane=new lc(new R(0,1,0),0));const f=i.worldPosition;this._plane.setFromNormalAndCoplanarPoint(new R(0,1,0),f);const p=e.ray;u=f.clone(),this._plane.intersectLine(new pk(p.origin,te(p.direction).multiplyScalar(1e4).add(p.origin)),u),u.distanceTo(f)>i.scale.x*10&&(u=null)}if(u){if(this.useTeleportTarget&&!I.getComponentInParent(d.object,Ov))return;const f=u.clone();if(Bb&&se.DrawSphere(u,.025,16711680,5),(l=this.context.mainCamera)==null?void 0:l.position){const b=(c=this.context.xr)==null?void 0:c.getUserOffsetInRig();b&&(b.y=0,f.sub(b),Bb&&se.DrawWireSphere(b.add(f),.025,65280,5))}this._teleportBuffer.push(i.matrix.clone()),this._teleportBuffer.length>10&&this._teleportBuffer.shift(),this.useTeleportFade?(h=e.xr.fadeTransition())==null||h.then(()=>{i.worldPosition=f}):i.worldPosition=f}}else if(n<-.8&&(this._didTeleport=!0,this._teleportBuffer.length>0)){const d=this._teleportBuffer.pop();d&&d.decompose(i.position,i.quaternion,i.scale)}}renderRays(e){var i;for(let n=0;n<this._lines.length;n++){const o=this._lines[n];o&&(o.visible=!1)}for(let n=0;n<e.controllers.length;n++){const o=e.controllers[n];let r=this._lines[n];if(!o.connected||!o.isTracking||!o.ray||o.targetRayMode==="transient-pointer"||!o.hasSelectEvent){r&&(r.visible=!1);continue}r||(r=this.createRayLineObject(),r.scale.z=.5,this._lines[n]=r),o.updateRayWorldPosition(),o.updateRayWorldQuaternion();const l=o.rayWorldPosition,c=o.rayWorldQuaternion;r.position.copy(l),r.quaternion.copy(c);const h=e.rigScale,d=this.usePinchToTeleport&&o.isTeleportGesture,u=this._lastHitDistances[n],f=this._hitDistances[n]!=null,p=u??h;r.scale.set(h,h,p),r.visible=!0,r.layers.disableAll(),r.layers.enable(2);let b=r.material.opacity;d?b=1:this.showHits&&p<e.rigScale*.5?b=0:(i=o.getButton("primary"))!=null&&i.pressed?b=.5:b=f?.2:.1,r.material.opacity=ee.lerp(r.material.opacity,b,this.context.time.deltaTimeUnscaled/.1),r.parent!==this.context.scene&&this.context.scene.add(r)}}renderHits(e){var i;for(const n of this._hitDiscs){if(!n)continue;const o=n.controller;if(!o||!o.connected||!o.isTracking){n.visible=!1;continue}}for(let n=0;n<e.controllers.length;n++){const o=e.controllers[n];if(!o.connected||!o.isTracking||!o.ray||!o.hasSelectEvent)continue;let r=this._hitDiscs[n],l=!0;const c=o.getPointerId("primary");c!=null&&this.context.input.getIsPointerIdInUse(c)&&(r&&(r.visible=!1),this._hitDistances[n]=null,this._lastHitDistances[n]=0,l=!1);const h=this.context.time.smoothedFps>=59?1:10;if((this.context.time.frame+o.index)%h!==0&&(l=!1),!l){const f=this._hitDiscs[n];f&&f.visible&&f.hit&&this.updateHitPointerPosition(o,f,f.hit.distance);continue}const d=this.context.physics.raycastFromRay(o.ray,{testObject:this.hitPointRaycastFilter,precise:!1});let u=d.find(f=>this.usePinchToTeleport&&o.isTeleportGesture?!0:this.isObjectWithInteractiveComponent(f.object));if(u||(u=d[0]),r&&(r.controller=o,r.hit=u),this._hitDistances[n]=(u==null?void 0:u.distance)||null,u){this._lastHitDistances[n]=u.distance;const f=e.rigScale??1;Bb&&(se.DrawWireSphere(u.point,.025*f,16711680),se.DrawLabel(te(0,.2,0).add(u.point),u.object.name,.02,0)),r||(r=this.createHitPointObject(),this._hitDiscs[n]=r),r.hit=u,r.visible=u.distance>f*.05;let p=.01*(f+u.distance);const b=(i=o.getButton("primary"))==null?void 0:i.pressed;b&&(p*=1.1),r.scale.set(p,p,p),r.layers.set(2);let x=r.material.opacity;if(b?x=1:x=u.distance<.15*f?.2:.6,r.material.opacity=ee.lerp(r.material.opacity,x,this.context.time.deltaTimeUnscaled/.1),r.visible){if(u.normal){this.updateHitPointerPosition(o,r,u.distance);const v=u.normal.applyQuaternion(Qe(u.object));r.quaternion.setFromUnitVectors(v3,v)}else this.updateHitPointerPosition(o,r,u.distance);r.parent!==this.context.scene&&this.context.scene.add(r)}}else this._hitDiscs[n]&&(this._hitDiscs[n].visible=!1)}}isObjectWithInteractiveComponent(e,i=0){return J_(e)||e.isUI===!0?!0:e.isScene?!1:e.parent?this.isObjectWithInteractiveComponent(e.parent,i+1):!1}updateHitPointerPosition(e,i,n){const o=te(e.rayWorldPosition);o.add(te(0,0,n-.01).applyQuaternion(e.rayWorldQuaternion)),i.position.lerp(o,this.context.time.deltaTimeUnscaled/.05)}createHitPointObject(){const e=new le(new vg(.3,6,6),new Ye({color:15658734,opacity:.7,transparent:!0,depthTest:!1,depthWrite:!1,side:Qn}));return e.layers.disableAll(),e.layers.enable(2),e}createRayLineObject(){const e=new Hk;e.layers.disableAll(),e.layers.enable(2);const i=new Gk;e.geometry=i;const n=new Float32Array(9);n.set([0,0,.02,0,0,.4,0,0,1]),i.setPositions(n);const o=new Float32Array(9);o.set([1,1,1,.1,.1,.1,0,0,0]),i.setColors(o);const r=new qk({color:16777215,vertexColors:!0,worldUnits:!0,linewidth:.004,transparent:!0,depthWrite:!1,blending:e1,dashed:!1});return e.material=r,e}}el([g()],Cs.prototype,"movementSpeed",void 0);el([g()],Cs.prototype,"rotationStep",void 0);el([g()],Cs.prototype,"useTeleport",void 0);el([g()],Cs.prototype,"usePinchToTeleport",void 0);el([g()],Cs.prototype,"useTeleportTarget",void 0);el([g()],Cs.prototype,"useTeleportFade",void 0);el([g()],Cs.prototype,"showRays",void 0);el([g()],Cs.prototype,"showHits",void 0);const v3=new R(0,1,0);var ci=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Gd=k("debugwebxr"),x3=k("debugusdz"),$l=class extends W{constructor(){super(...arguments);a(this,"createVRButton",!0);a(this,"createARButton",!0);a(this,"createSendToQuestButton",!0);a(this,"createQRCode",!0);a(this,"useDefaultControls",!0);a(this,"showControllerModels",!0);a(this,"showHandModels",!0);a(this,"usePlacementReticle",!0);a(this,"customARPlacementReticle");a(this,"usePlacementAdjustment",!0);a(this,"arScale",1);a(this,"useXRAnchor",!1);a(this,"autoPlace",!1);a(this,"autoCenter",!1);a(this,"useQuicklookExport",!1);a(this,"useDepthSensing",!1);a(this,"useSpatialGrab",!0);a(this,"defaultAvatar");a(this,"_playerSync");a(this,"_createdComponentsInSession",[]);a(this,"_usdzExporter");a(this,"_exitXRMenuButton");a(this,"_previousXRState",0);a(this,"_spatialGrabRaycaster");a(this,"_activeWebARSessionRoot",null);a(this,"onAvatarSpawned",e=>{Gd&&console.log("WebXR.onAvatarSpawned",e),I.getComponentInChildren(e,uc)??(i=I.addComponent(e,uc))});a(this,"_buttonFactory");a(this,"_buttons",[])}awake(){fe.getXRSync(this.context)}onEnable(){var e,i,n;window.location.protocol!=="https:"&&qe('<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebXR_Device_API" target="_blank">WebXR</a> only works on secure connections (https).'),(e=navigator.xr)==null||e.isSessionSupported("immersive-ar").catch(()=>!1).then(o=>{const r=Q.isVisionOS()&&!o;(this.useQuicklookExport||r)&&(I.findObjectOfType(Ge)||(Gd&&console.log("WebXR: Adding USDZExporter"),this._usdzExporter=I.addComponent(this.gameObject,Ge),this._usdzExporter.objectToExport=this.context.scene,this._usdzExporter.autoExportAnimations=!0,this._usdzExporter.autoExportAudioSources=!0))}),this.handleCreatingHTML(),this.handleOfferSession(),this.defaultAvatar===!0&&(Gd&&console.warn("WebXR: No default avatar set, using static default avatar"),this.defaultAvatar=new we("https://cdn.needle.tools/static/avatars/DefaultAvatar.glb")),this.defaultAvatar&&(this._playerSync=this.gameObject.getOrAddComponent(Rc),this._playerSync.autoSync=!1),this._playerSync&&typeof this.defaultAvatar!="boolean"&&(this._playerSync.asset=this.defaultAvatar,(i=this._playerSync.onPlayerSpawned)==null||i.removeEventListener(this.onAvatarSpawned),(n=this._playerSync.onPlayerSpawned)==null||n.addEventListener(this.onAvatarSpawned))}onDisable(){var e;(e=this._usdzExporter)==null||e.destroy(),this.removeButtons()}async handleOfferSession(){return this.createVRButton&&await fe.isVRSupported()&&this.createVRButton?fe.offerSession("immersive-vr","default",this.context):this.createARButton&&await fe.isARSupported()&&this.createARButton?fe.offerSession("immersive-ar","default",this.context):!1}get session(){return fe.active??null}get sessionMode(){return fe.activeMode??null}get arSessionRoot(){return this._activeWebARSessionRoot}async enterVR(e){return fe.start("immersive-vr",e,this.context)}async enterAR(e){return fe.start("immersive-ar",e,this.context)}exitXR(){fe.stop()}get isActiveWebXR(){return!$l.activeWebXRComponent||$l.activeWebXRComponent===this}onBeforeXR(e,i){var n;if(!this.isActiveWebXR){console.warn(`WebXR: another WebXR component is already active (${(n=$l.activeWebXRComponent)==null?void 0:n.name}). This is ignored: ${this.name}`);return}if(this.activeAndEnabled===!1||this.destroyed){console.debug("[WebXR] onBeforeXR called on disabled or destroyed component");return}$l.activeWebXRComponent=this,e=="immersive-ar"&&this.useDepthSensing&&(i.optionalFeatures=i.optionalFeatures||[],i.optionalFeatures.push("depth-sensing"))}async onEnterXR(e){if(!this.isActiveWebXR)return;Gd&&console.log("WebXR onEnterXR"),this._previousXRState=un.Global.Mask;const i=e.xr.isVR;if(un.Global.Set(i?ms.VR:ms.AR),e.xr.isAR){let n=I.findObjectOfType(No,this.context,!1);if(!n)if(this.usePlacementReticle){const o=new z;for(const r of this.context.scene.children)o.add(r);this.context.scene.add(o),n=I.addComponent(o,No),this._createdComponentsInSession.push(n)}else(Gd||X())&&console.warn("WebXR: No WebARSessionRoot found in scene and usePlacementReticle is disabled in WebXR component.");this._activeWebARSessionRoot=n,n&&(n.customReticle=this.customARPlacementReticle,n.arScale=this.arScale,n.arTouchTransform=this.usePlacementAdjustment,n.autoPlace=this.autoPlace,n.autoCenter=this.autoCenter,n.useXRAnchor=this.useXRAnchor)}this.useDefaultControls&&this.setDefaultMovementEnabled(!0),(this.showControllerModels||this.showHandModels)&&this.setDefaultControllerRenderingEnabled(!0),this.useSpatialGrab&&(this._spatialGrabRaycaster=I.findObjectOfType(sc)??void 0,this._spatialGrabRaycaster||(this._spatialGrabRaycaster=this.gameObject.addComponent(sc))),this.createLocalAvatar(e.xr),e.xr.isScreenBasedAR||(this._exitXRMenuButton=this.context.menu.appendChild({label:"Quit XR",onClick:()=>this.exitXR(),icon:"exit_to_app",priority:2e4}))}onUpdateXR(e){this.isActiveWebXR&&this._spatialGrabRaycaster&&(this._spatialGrabRaycaster.enabled=this.useSpatialGrab)}onLeaveXR(e){var i,n;if((i=this._exitXRMenuButton)==null||i.remove(),!!this.isActiveWebXR){un.Global.Set(this._previousXRState),(n=this._playerSync)==null||n.destroyInstance();for(const o of this._createdComponentsInSession)o.destroy();this._createdComponentsInSession.length=0,this._activeWebARSessionRoot=null,this.handleOfferSession(),kg(1).then(()=>$l.activeWebXRComponent=null)}}setDefaultMovementEnabled(e){let i=this.gameObject.getComponent(Cs);return!i&&e&&(i=this.gameObject.addComponent(Cs),this._createdComponentsInSession.push(i)),i&&(i.enabled=e),i}setDefaultControllerRenderingEnabled(e){let i=this.gameObject.getComponent(Gr);return!i&&e&&(i=this.gameObject.addComponent(Gr),this._createdComponentsInSession.push(i),i.createControllerModel=this.showControllerModels,i.createHandModel==this.showHandModels),i&&(i.enabled=e),i}async createLocalAvatar(e){this._playerSync&&e.running&&typeof this.defaultAvatar!="boolean"&&(this._playerSync.asset=this.defaultAvatar,await this._playerSync.getInstance())}getButtonsContainer(){return this.getButtonsFactory()}getButtonsFactory(){return this._buttonFactory||(this._buttonFactory=za.getOrCreate()),this._buttonFactory}handleCreatingHTML(){if(this.createARButton||this.createVRButton||this.useQuicklookExport){if((Q.isiOS()&&Q.isSafari()||x3)&&this.useQuicklookExport){const e=I.findObjectOfType(Ge);if(!e||e&&e.allowCreateQuicklookButton){const i=this.getButtonsFactory().createQuicklookButton();this.addButton(i)}}if(this.createARButton){const e=this.getButtonsFactory().createARButton();this.addButton(e)}if(this.createVRButton){const e=this.getButtonsFactory().createVRButton();this.addButton(e)}}if(this.createSendToQuestButton&&!Q.isQuest()&&fe.isVRSupported().then(e=>{if(!e){const i=this.getButtonsFactory().createSendToQuestButton();this.addButton(i)}}),this.createQRCode){const e=Ef(ea);if(e&&e.createQRCodeButton===!1)X()&&console.warn("WebXR: QRCode button is disabled in the Needle Menu component");else if(!Q.isMobileDevice()){const i=Hs.getOrCreate().createQRCode();this.addButton(i)}}}addButton(e){this._buttons.push(e),this.context.menu.appendChild(e)}removeButtons(){for(const e of this._buttons)e.remove();this._buttons.length=0}};let pt=$l;a(pt,"activeWebXRComponent",null);ci([g()],pt.prototype,"createVRButton",void 0);ci([g()],pt.prototype,"createARButton",void 0);ci([g()],pt.prototype,"createSendToQuestButton",void 0);ci([g()],pt.prototype,"createQRCode",void 0);ci([g()],pt.prototype,"useDefaultControls",void 0);ci([g()],pt.prototype,"showControllerModels",void 0);ci([g()],pt.prototype,"showHandModels",void 0);ci([g()],pt.prototype,"usePlacementReticle",void 0);ci([g(we)],pt.prototype,"customARPlacementReticle",void 0);ci([g()],pt.prototype,"usePlacementAdjustment",void 0);ci([g()],pt.prototype,"arScale",void 0);ci([g()],pt.prototype,"useXRAnchor",void 0);ci([g()],pt.prototype,"autoPlace",void 0);ci([g()],pt.prototype,"autoCenter",void 0);ci([g()],pt.prototype,"useQuicklookExport",void 0);ci([g()],pt.prototype,"useDepthSensing",void 0);ci([g()],pt.prototype,"useSpatialGrab",void 0);ci([g(we)],pt.prototype,"defaultAvatar",void 0);const Fp=k("debugusdzbehaviours");class rR{constructor(){a(this,"behaviours",[]);a(this,"behaviourComponents",[]);a(this,"behaviourComponentsCopy",[]);a(this,"audioClips",[]);a(this,"audioClipsCopy",[]);a(this,"targetUuids",new Set)}get extensionName(){return"Behaviour"}addBehavior(t){this.behaviours.push(t)}addAudioClip(t){if(!t||typeof t!="string")return"";const i="audio/"+pd.getName(t);return this.audioClips.push({clipUrl:t,filesKey:i}),i}getAllTargetUuids(){return this.targetUuids}onBeforeBuildDocument(t){if(!t.root)return Promise.resolve();const e=[];return t.root.traverse(i=>{I.foreachComponent(i,n=>{var r;const o=n;if(typeof o.createBehaviours=="function"||typeof o.beforeCreateDocument=="function"||typeof o.afterCreateDocument=="function"||typeof o.afterSerialize=="function"){this.behaviourComponents.push(o);const l=(r=o.beforeCreateDocument)==null?void 0:r.call(o,this,t);l instanceof Promise&&e.push(l)}},!1)}),Fp&&console.log("onBeforeBuildDocument: all components",this.behaviourComponents),Promise.all(e)}onExportObject(t,e,i){var n;for(const o of this.behaviourComponents)(n=o.createBehaviours)==null||n.call(o,this,e,i)}onAfterBuildDocument(t){for(const u of this.behaviourComponents)typeof u.afterCreateDocument=="function"&&u.afterCreateDocument(this,t);this.behaviourComponentsCopy=this.behaviourComponents.slice(),this.behaviourComponents.length=0,this.audioClipsCopy=this.audioClips.slice(),this.audioClips.length=0;const e=new Set,i=new Set,n=new Set,o=new Set,r=Fp;let l=`graph LR
`,c="";function h(u){if(u instanceof Gl){r&&(l+=`subgraph Group_${u.id}
`);for(const f of u.actions)r&&(l+=`${u.id}[${u.id}] -- ${u.type},loops:${u.loops} --> ${f.id}[${f.id}]
`),h(f);r&&(l+=`end
`)}else if(u instanceof Bn){u.tokenId==="StartAnimation"&&o.add(u);let f=u.tokenId;u.type!==void 0&&(f+=":"+u.type);const p=u.affectedObjects;if(p)if(Array.isArray(p))for(const x of p)i.add(x),r&&(c+=`${u.id}[${u.id}
${f}] -- ${f} --> ${x.uuid}(("${x.displayName||x.name||x.uuid}"))
`);else typeof p=="object"?(i.add(p),r&&(c+=`${u.id}[${u.id}
${f}] -- ${f} --> ${p.uuid}(("${p.displayName||p.name||p.uuid}"))
`)):typeof p=="string"&&i.add({uuid:p});const b=u.xFormTarget;b&&(typeof b=="object"?(i.add(b),r&&(c+=`${u.id}[${u.id}
${f}] -- ${f} --> ${b.uuid}(("${b.displayName||b.name||b.uuid}"))
`)):typeof b=="string"&&i.add({uuid:b}))}}function d(u,f){if(Array.isArray(u))for(const p of u)d(p,f);else if(u instanceof Na){let p=u.tokenId;u.type!==void 0&&(p+=":"+u.type),typeof u.targetId=="object"&&(e.add(u.targetId),r&&(c+=`${u.targetId.uuid}(("${u.targetId.displayName}")) --> ${u.id}[${u.id}
${p}]
`)),r&&(l+=`${u.id}((${u.id})) -- ${p} --> ${f.id}[${f.tokenId||f.id}]
`)}}for(const u of this.behaviours)r&&(l+=`subgraph ${u.id}
`),h(u.action),d(u.trigger,u.action),r&&(l+=`end
`);r&&(l+=`
`+c),r&&(console.log("All USDZ behaviours",this.behaviours),this.behaviours.length&&(console.warn("The Mermaid graph can be pasted into https://massive-mermaid.glitch.me/ or https://mermaid.live/edit. It should be in your clipboard already!"),console.log(l),navigator.clipboard.writeText(l)));{let u=`gantt
title Animations
dateFormat X
axisFormat %s
`;const f=Array.from(o),p=new Set;for(const S of f)if(S.affectedObjects&&typeof S.affectedObjects!="string"){if(Array.isArray(S.affectedObjects))for(const C of S.affectedObjects)p.add(C);else p.add(S.affectedObjects);r&&(u+=`section ${S.animationName} (${S.id})
`,u+=`${S.id} : ${S.start}, ${S.duration}s
`)}r&&o.size&&console.log(u);const b=new Set;for(const S of p){S.getPath||console.error("USDZExporter: Animation target object has no getPath method. This is likely a bug",S);let C=S.getPath();C.startsWith("<")&&(C=C.substring(1)),C.endsWith(">")&&(C=C.substring(0,C.length-1)),b.add({path:C,obj:S})}const x=Array.from(b).sort((S,C)=>S.path.length-C.path.length),v=new Array;for(let S=0;S<x.length;S++)for(let C=S+1;C<x.length;C++)if(x[C].path.startsWith(x[S].path)){const P=x[C],E=x[S];v.push({child:P.obj.displayName+" ("+P.path+")",parent:E.obj.displayName+" ("+E.path+")"})}v.length&&console.warn("USDZExporter: There are overlapping PlayAnimation actions. This can lead to undefined runtime behaviour when playing multiple animations. Please restructure the hierarchy so that animations don't overlap.",{overlappingTargets:v,playAnimationActions:o})}for(const u of new Set([...e,...i]))if(Array.isArray(u))for(const f of u)n.add(f.uuid);else n.add(u.uuid);Fp&&console.log("All Behavior trigger sources and action targets",e,i,n),this.targetUuids=new Set(n)}onAfterHierarchy(t,e){var i;if((i=this.behaviours)!=null&&i.length){e.beginBlock('def Scope "Behaviors"');for(const n of this.behaviours)n.writeTo(this,t.document,e);e.closeBlock()}}async onAfterSerialize(t){Fp&&console.log("onAfterSerialize behaviours",this.behaviourComponentsCopy);for(const e of this.behaviourComponentsCopy)typeof e.afterSerialize=="function"&&(e.afterSerialize.constructor.name==="AsyncFunction"?await e.afterSerialize(this,t):e.afterSerialize(this,t));for(const{clipUrl:e,filesKey:i}of this.audioClipsCopy){if(t.files[i])return;const r=await(await(await fetch(e)).blob()).arrayBuffer(),l=new Uint8Array(r);t.files[i]=l}this.behaviourComponentsCopy.length=0,this.audioClipsCopy.length=0}}class aR{get extensionName(){return"Physics"}onExportObject(t,e,i){const n=I.getComponents(t,De).filter(c=>c.enabled),o=I.getComponents(t,no).filter(c=>c.enabled&&!c.isTrigger);let r=n.length>0?n[0]:null;const l=o.length>0?o[0]:null;l&&!r&&(r=new De,r.isKinematic=!0),r&&e.addEventListener("serialize",(c,h)=>{var d,u,f;if(r){if(c.appendLine(),c.beginBlock('def RealityKitComponent "RigidBody"',"{",!0),r.useGravity||c.appendLine("bool gravityEnabled = 0"),c.appendLine('uniform token info:id = "RealityKit.RigidBody"'),r.isKinematic&&c.appendLine('token motionType = "Kinematic"'),c.beginBlock('def RealityKitStruct "massFrame"',"{",!0),c.appendLine(`float m_mass = ${r.mass}`),c.beginBlock('def RealityKitStruct "m_pose"',"{",!0),c.appendLine(`float3 position = (${r.centerOfMass.x}, ${r.centerOfMass.y}, ${r.centerOfMass.z})`),c.closeBlock("}"),c.closeBlock("}"),o.length>0){const p=o[0];c.beginBlock('def RealityKitStruct "material"',"{",!0);const b=p.sharedMaterial;b&&b.dynamicFriction!==void 0&&c.appendLine(`double dynamicFriction = ${(d=p.sharedMaterial)==null?void 0:d.dynamicFriction}`),b&&b.bounciness!==void 0&&c.appendLine(`double restitution = ${(u=p.sharedMaterial)==null?void 0:u.bounciness}`),b&&b.staticFriction!==void 0&&c.appendLine(`double staticFriction = ${(f=p.sharedMaterial)==null?void 0:f.staticFriction}`),c.closeBlock("}")}c.closeBlock("}")}}),l&&(e.addEventListener("serialize",(c,h)=>{var f;c.beginBlock('def RealityKitComponent "Collider"',"{",!0),c.appendLine("uint group = 1"),c.appendLine('uniform token info:id = "RealityKit.Collider"'),c.appendLine("uint mask = 4294967295");const u=l.isTrigger?"Trigger":"Default";if(c.appendLine(`token type = "${u}"`),c.beginBlock('def RealityKitStruct "Shape"',"{",!0),l instanceof Df){const p=l;c.appendLine('token shapeType = "Sphere"'),c.appendLine(`float radius = ${p.radius}`)}else if(l instanceof Sc){const p=l;c.appendLine('token shapeType = "Box"'),c.appendLine(`float3 extent = (${p.size.x}, ${p.size.y}, ${p.size.z})`)}else if(l instanceof Ga){const p=l;c.appendLine('token shapeType = "Capsule"'),c.appendLine(`float radius = ${p.radius}`),c.appendLine(`float height = ${p.height}`)}else if(l instanceof Cc&&((f=l.sharedMesh)!=null&&f.geometry)){const p=l.sharedMesh.geometry;p.boundingBox||p.computeBoundingBox();const b=l.sharedMesh.geometry.boundingBox;b&&(c.appendLine('token shapeType = "Box"'),c.appendLine(`float3 extent = (${b.max.x-b.min.x}, ${b.max.y-b.min.y}, ${b.max.z-b.min.z})`),console.log("[USDZ] Only Box, Sphere, and Capsule colliders are supported in visionOS/iOS. MeshCollider will be exported as Box",l))}else console.warn("[USDZ] Only Box, Sphere, and Capsule colliders are supported in visionOS/iOS. Ignoring collider:",l);c.beginBlock('def RealityKitStruct "pose"',"{",!0),c.closeBlock("}"),c.closeBlock("}"),c.closeBlock("}")}),o.length>1&&console.log("WARNING: Multiple colliders detected. visionOS / iOS can only support objects with a single collider, only exporting the first collider: ",l))}}const w3=k("debugshadowcomponents");s1.prototype.interactable={get(){return this.interactive},set(s){this.interactable=s}};class eo extends W{constructor(){super(...arguments);a(this,"_shadowComponent",null);a(this,"_controlsChildLayout",!0);a(this,"_root");a(this,"_parentComponent")}isRoot(){var e;return((e=this.Root)==null?void 0:e.gameObject)===this.gameObject}get canvas(){const e=this.Root;return e!=null&&e.isCanvas?e:null}get Canvas(){return this.canvas}markDirty(){Rn.markUIDirty(this.context)}get shadowComponent(){return this._shadowComponent}set shadowComponent(e){this._shadowComponent=e}get controlsChildLayout(){return this._controlsChildLayout}set controlsChildLayout(e){this._controlsChildLayout=e,this.shadowComponent&&(this.shadowComponent.autoLayout=e)}get Root(){return this._root===void 0&&(this._root=I.getComponentInParent(this.gameObject,iy)),this._root}__internalNewInstanceCreated(e){return super.__internalNewInstanceCreated(e),this.shadowComponent=null,this._root=void 0,this._parentComponent=void 0,this}onEnable(){super.onEnable()}addShadowComponent(e,i){var r;if(!e)return;this.removeShadowComponent();const n=this.isRoot()?this.gameObject:this.gameObject.parent;if(this._parentComponent=I.getComponentInParent(n,eo),!this._parentComponent){console.warn(`Component "${this.name}" doesn't have a UI parent anywhere. Do you have an UI element outside a Canvas? UI components must be a child of a Canvas component`,this);return}e.name=this.name+" ("+(this.constructor.name??"UI")+")",e.autoLayout=this._parentComponent.controlsChildLayout,e[zn]=this,this.setShadowComponentOwner(e);let o=!1;if(((r=this.Root)==null?void 0:r.gameObject)===this.gameObject)this.gameObject.add(e);else{const l=this._parentComponent.shadowComponent;l&&(l==null||l.add(e),o=!0)}this.shadowComponent=e,i&&i.shadowComponent&&this.shadowComponent&&i.shadowComponent.add(this.shadowComponent),Of&&e.add(new Wn(.5)),this.onAfterAddedToScene(),o&&Ik(),w3&&console.warn("Added shadow component",this.shadowComponent)}setShadowComponentOwner(e){if(e&&(e[zn]===void 0||e[zn]===this)&&(e[zn]=this,e.children))for(const i of e.children)this.setShadowComponentOwner(i)}traverseOwnedShadowComponents(e,i,n){if(e&&e[zn]===i){n(e);for(const o of e.children)this.traverseOwnedShadowComponents(o,i,n)}}removeShadowComponent(){this.shadowComponent&&this.shadowComponent.removeFromParent()}onAfterAddedToScene(){}setInteractable(e){this.shadowComponent&&(this.shadowComponent.interactable=e)}}class iy extends eo{awake(){super.awake()}}var Uf=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Ub=k("debugui"),Nb=k("debuguilayout");class S3{constructor(){a(this,"width");a(this,"height")}}class C3{constructor(){a(this,"x");a(this,"y");a(this,"width");a(this,"height")}}const Is=new R,qd=new xe,Bp=new re;class Mi extends eo{constructor(){super(...arguments);a(this,"_anchoredPosition");a(this,"sizeDelta",new _e(100,100));a(this,"pivot",new _e(.5,.5));a(this,"anchorMin",new _e(0,0));a(this,"anchorMax",new _e(1,1));a(this,"minWidth");a(this,"minHeight");a(this,"lastMatrix");a(this,"rectBlock");a(this,"_transformNeedsUpdate",!1);a(this,"_initialPosition");a(this,"_parentRectTransform");a(this,"_lastUpdateFrame",-1);a(this,"_lastAnchoring");a(this,"_createdBlocks",[]);a(this,"_createdTextBlocks",[])}get parent(){return this._parentRectTransform}get translation(){return this.gameObject.position}get rotation(){return this.gameObject.quaternion}get scale(){return this.gameObject.scale}get anchoredPosition(){return this._anchoredPosition||(this._anchoredPosition=new _e),this._anchoredPosition}set anchoredPosition(e){this._anchoredPosition=e}get width(){let e=this.sizeDelta.x;if(this.anchorMin.x!==this.anchorMax.x&&this._parentRectTransform){const i=this._parentRectTransform.width,n=this.anchorMax.x-this.anchorMin.x;e=i*n,e+=this.sizeDelta.x}return this.minWidth!==void 0&&e<this.minWidth?this.minWidth:e}get height(){let e=this.sizeDelta.y;if(this.anchorMin.y!==this.anchorMax.y&&this._parentRectTransform){const i=this._parentRectTransform.height,n=this.anchorMax.y-this.anchorMin.y;e=i*n,e+=this.sizeDelta.y}return this.minHeight!==void 0&&e<this.minHeight?this.minHeight:e}awake(){super.awake(),this._lastUpdateFrame=-1,this._parentRectTransform=void 0,this.rectBlock=new z,this.rectBlock.name=this.name,this.lastMatrix=new xe,this._lastAnchoring=null,this._initialPosition=this.gameObject.position.clone(),this._initialPosition.z=0,this._anchoredPosition||(this._anchoredPosition=new _e),sh(this,"_anchoredPosition",()=>{this.markDirty()}),sh(this,"sizeDelta",()=>{this.markDirty()}),sh(this,"pivot",()=>{this.markDirty()}),sh(this,"anchorMin",()=>{this.markDirty()}),sh(this,"anchorMax",()=>{this.markDirty()})}onEnable(){var e;super.onEnable(),this.rectBlock||(this.rectBlock=new z),this.lastMatrix||(this.lastMatrix=new xe),this._lastAnchoring||(this._lastAnchoring=new _e),this._initialPosition||(this._initialPosition=new R),this._anchoredPosition||(this._anchoredPosition=new _e),this.addShadowComponent(this.rectBlock),this._transformNeedsUpdate=!0,(e=this.canvas)==null||e.registerTransform(this)}onDisable(){var e;super.onDisable(),this.removeShadowComponent(),(e=this.canvas)==null||e.unregisterTransform(this)}onParentRectTransformChanged(e){this._transformNeedsUpdate||this.onApplyTransform(Nb?`${e.name} changed`:void 0)}get isDirty(){return this._transformNeedsUpdate||(this._transformNeedsUpdate=!this.lastMatrix.equals(this.gameObject.matrix)),this._transformNeedsUpdate}markDirty(){this._transformNeedsUpdate||(Nb&&console.warn("RectTransform markDirty()",this.name),this._transformNeedsUpdate=!0,this._lastUpdateFrame=-1)}updateTransform(){(this._transformNeedsUpdate||!this.lastMatrix.equals(this.gameObject.matrix))&&this.canUpdate()&&this.onApplyTransform(this._transformNeedsUpdate?"Marked dirty":"Matrix changed")}canUpdate(){return this._transformNeedsUpdate&&this.activeAndEnabled&&this._lastUpdateFrame!==this.context.time.frame}onApplyTransform(e){var o;if(this.context.time.frameCount===this._lastUpdateFrame)return;this._lastUpdateFrame=this.context.time.frameCount;const i=this.shadowComponent;if(!i)return;this.gameObject.parent?this._parentRectTransform=I.getComponentInParent(this.gameObject.parent,Mi):this._parentRectTransform=void 0,this._transformNeedsUpdate=!1,Nb&&console.warn("RectTransform ‚Üí ApplyTransform",this.name+" because "+e),this.isRoot()?this.Root.screenspace||(i.rotation.y=Math.PI):(i.matrix.identity(),i.matrixAutoUpdate=!1,Is.set(0,0,0),this.applyPivot(Is),i.matrix.setPosition(Is.x,Is.y,0),(this.gameObject.quaternion.x||this.gameObject.quaternion.y||this.gameObject.quaternion.z)&&(Bp.copy(this.gameObject.quaternion),Bp.x*=-1,Bp.z*=-1,qd.makeRotationFromQuaternion(Bp),i.matrix.premultiply(qd)),Is.set(0,0,0),this.applyAnchoring(Is),(o=this.canvas)!=null&&o.screenspace?Is.z+=.1:Is.z+=.01,qd.identity(),qd.setPosition(Is.x,Is.y,Is.z),i.matrix.premultiply(qd),i.matrix.scale(this.gameObject.scale)),this.lastMatrix.copy(this.gameObject.matrix);const n=!0;for(const r of ov(this.gameObject,eo,n,1)){if(r===this||!r.activeAndEnabled)continue;const l=r;l.onParentRectTransformChanged&&l.onParentRectTransformChanged(this)}}applyAnchoring(e){this._lastAnchoring||(this._lastAnchoring=new _e);const i=this._lastAnchoring.sub(this._anchoredPosition);this.gameObject.position.x+=i.x,this.gameObject.position.y+=i.y,this._lastAnchoring.copy(this._anchoredPosition),e.x+=this._initialPosition.x-this.gameObject.position.x,e.y+=this._initialPosition.y-this.gameObject.position.y,e.z+=this._initialPosition.z-this.gameObject.position.z;const n=this._parentRectTransform;if(n){let o=0;const r=1-this.anchorMax.y-this.anchorMin.y;o-=n.height*.5*r,e.y+=o;let l=0;const c=1-this.anchorMax.x-this.anchorMin.x;l-=n.width*.5*c,e.x+=l}}applyPivot(e){if(this.pivot&&!this.isRoot()){const i=this.pivot.x-.5;e.x-=i*this.sizeDelta.x*this.gameObject.scale.x;const n=this.pivot.y-.5;e.y-=n*this.sizeDelta.y*this.gameObject.scale.y}}getBasicOptions(){const e={width:this.sizeDelta.x,height:this.sizeDelta.y,offset:0,backgroundOpacity:0,borderWidth:0,borderRadius:0,borderOpacity:0,letterSpacing:-.03};return this.ensureValidSize(e),e}ensureValidSize(e,i=1e-4){return e.width<=0&&(e.width=i),e.height<=0&&(e.height=1e-4),e}createNewBlock(e){e={...this.getBasicOptions(),...e},Ub&&console.log(this.name,e);const i=new s1(e);return this._createdBlocks.push(i),i}createNewText(e){Ub&&console.log(e),e={...this.getBasicOptions(),...e},Ub&&console.log(this.name,e);const i=new n1(e);return this._createdTextBlocks.push(i),i}}Uf([g(_e)],Mi.prototype,"anchoredPosition",null);Uf([g(_e)],Mi.prototype,"sizeDelta",void 0);Uf([g(_e)],Mi.prototype,"pivot",void 0);Uf([g(_e)],Mi.prototype,"anchorMin",void 0);Uf([g(_e)],Mi.prototype,"anchorMax",void 0);var lR=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Nf extends W{constructor(){super(...arguments);a(this,"effectColor");a(this,"effectDistance")}}lR([g(Te)],Nf.prototype,"effectColor",void 0);lR([g(_e)],Nf.prototype,"effectDistance",void 0);var cR=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Tl={backgroundColor:new Se(1,1,1),backgroundOpacity:1,borderColor:new Se(1,1,1),borderOpacity:1},Rh=class extends eo{constructor(){super(...arguments);a(this,"_alphaFactor",1);a(this,"sRGBColor",new Se(1,0,1));a(this,"raycastTarget",!0);a(this,"uiObject",null);a(this,"_color",null);a(this,"_rect",null);a(this,"_stateManager",null);a(this,"_currentlyCreatingPanel",!1)}get isGraphic(){return!0}get color(){return this._color||(this._color=new Te(1,1,1,1)),this._color}set color(e){(!this._color||this._color.r!==e.r||this._color.g!==e.g||this._color.b!==e.b||this._color.alpha!==e.alpha)&&(this._color||(this._color=new Te(1,1,1,1)),this._color.copy(e),this.onColorChanged())}setAlphaFactor(e){this._alphaFactor=e,this.onColorChanged()}get alphaFactor(){return this._alphaFactor}onColorChanged(){var e,i;if(this.uiObject){this.sRGBColor.copy(this._color),this.sRGBColor.convertLinearToSRGB(),Tl.backgroundColor=this.sRGBColor,Tl.backgroundOpacity=this._color.alpha;const n=(e=this.uiObject._simpleState__activeStates)==null?void 0:e[0];if(n){const o=(i=this.uiObject._simpleState__states)==null?void 0:i[n];o&&("backgroundColor"in o&&(Tl.backgroundColor=o.backgroundColor),"backgroundOpacity"in o&&(Tl.backgroundOpacity=o.backgroundOpacity))}Tl.backgroundOpacity*=this._alphaFactor,this.applyEffects(Tl,this._alphaFactor),this.uiObject.set(Tl),this.markDirty()}}get m_Color(){return this._color}get rectTransform(){if(this._rect||(this._rect=I.getComponent(this.gameObject,Mi)),!this._rect)throw new Error("Not Supported: Make sure to add a RectTransform component before adding a UI Graphic component.");return this._rect}onParentRectTransformChanged(){var e;(e=this.uiObject)==null||e.set({width:this.rectTransform.width,height:this.rectTransform.height}),this.markDirty()}__internalNewInstanceCreated(e){return super.__internalNewInstanceCreated(e),this._rect=null,this.uiObject=null,this._stateManager=null,this._color&&(this._color=this._color.clone()),this}setState(e){this.makePanel(),this.uiObject&&(this.uiObject.setState(e),this==null||this.markDirty())}setupState(e){this.makePanel(),this.uiObject&&(this._stateManager||(this._stateManager=new Lk(this.uiObject)),this.uiObject.setupState(e.state,e.attributes))}setOptions(e){this.makePanel(),this.uiObject&&this.uiObject.set(e)}awake(){super.awake(),this.makePanel(),sh(this,"_color",()=>FL(this,this.onColorChanged))}onEnable(){var e;super.onEnable(),this.uiObject&&((e=this.rectTransform.shadowComponent)==null||e.add(this.uiObject),this.addShadowComponent(this.uiObject,this.rectTransform))}onDisable(){super.onDisable(),this.uiObject&&this.removeShadowComponent()}makePanel(){if(this.uiObject||this._currentlyCreatingPanel)return;this._currentlyCreatingPanel=!0;const e=.015,i={backgroundColor:this.color,backgroundOpacity:this.color.alpha,offset:e};this.onBeforeCreate(i),this.applyEffects(i),this.onCreate(i),this.controlsChildLayout=!1,this._currentlyCreatingPanel=!1,this.onAfterCreated(),this.onColorChanged()}onBeforeCreate(e){}onCreate(e){this.uiObject=this.rectTransform.createNewBlock(e),this.uiObject.name=this.name}onAfterCreated(){}applyEffects(e,i=1){var o;const n=(o=this.gameObject)==null?void 0:o.getComponent(Nf);n&&(n.effectDistance&&(e.borderWidth=Math.max(Math.abs(n.effectDistance.x),Math.abs(n.effectDistance.y))),n.effectColor&&(e.borderColor=n.effectColor,e.borderOpacity=n.effectColor.alpha*i))}async setTexture(e){if(this.setOptions({backgroundOpacity:0}),e){if(Rh.textureCache.has(e))e=Rh.textureCache.get(e);else if(!e.isRenderTargetTexture){const i=e.clone();i.colorSpace=$r,Rh.textureCache.set(e,i),e=i}this.setOptions({backgroundImage:e,borderRadius:0,backgroundOpacity:this.color.alpha,backgroundSize:"stretch"}),Tt.assignTextureLOD(e,0).then(i=>{i instanceof _t&&(e&&Rh.textureCache.set(e,i),this.setOptions({backgroundImage:i}),this.markDirty())})}else this.setOptions({backgroundImage:void 0,borderRadius:0,backgroundOpacity:this.color.alpha});this.markDirty()}onAfterAddedToScene(){super.onAfterAddedToScene(),this.shadowComponent&&(this.shadowComponent.offset=this.shadowComponent.position.z)}};let Fr=Rh;a(Fr,"textureCache",new Map);cR([g(Te)],Fr.prototype,"color",null);cR([g()],Fr.prototype,"raycastTarget",void 0);class ny extends Fr{constructor(){super(...arguments);a(this,"_flippedObject",!1)}onAfterCreated(){this.uiObject&&!this._flippedObject&&(this._flippedObject=!0,this.uiObject.scale.y*=-1)}}var ta=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Rl=k("debugtext");var Re;(function(s){s[s.UpperLeft=0]="UpperLeft",s[s.UpperCenter=1]="UpperCenter",s[s.UpperRight=2]="UpperRight",s[s.MiddleLeft=3]="MiddleLeft",s[s.MiddleCenter=4]="MiddleCenter",s[s.MiddleRight=5]="MiddleRight",s[s.LowerLeft=6]="LowerLeft",s[s.LowerCenter=7]="LowerCenter",s[s.LowerRight=8]="LowerRight"})(Re||(Re={}));var Fu;(function(s){s[s.Truncate=0]="Truncate",s[s.Overflow=1]="Overflow"})(Fu||(Fu={}));var Bu;(function(s){s[s.Wrap=0]="Wrap",s[s.Overflow=1]="Overflow"})(Bu||(Bu={}));var xn;(function(s){s[s.Normal=0]="Normal",s[s.Bold=1]="Bold",s[s.Italic=2]="Italic",s[s.BoldAndItalic=3]="BoldAndItalic"})(xn||(xn={}));class gn extends Fr{constructor(){super(...arguments);a(this,"alignment",Re.UpperLeft);a(this,"verticalOverflow",Fu.Truncate);a(this,"horizontalOverflow",Bu.Wrap);a(this,"lineSpacing",1);a(this,"supportRichText",!1);a(this,"font");a(this,"fontStyle",xn.Normal);a(this,"sRGBTextColor",new Se(1,0,1));a(this,"_text","");a(this,"_fontSize",12);a(this,"_textMeshUi",null);a(this,"_didHandleTextRenderOnTop",!1)}setAlphaFactor(e){var i;super.setAlphaFactor(e),(i=this.uiObject)==null||i.set({fontOpacity:this.color.alpha*this.alphaFactor}),this.markDirty()}get text(){return this._text}set text(e){e!==this._text&&(this._text=e,this.feedText(this.text,this.supportRichText),this.markDirty())}set_text(e){this.text=e}get fontSize(){return this._fontSize}set fontSize(e){var i;this._fontSize=e,(i=this.uiObject)==null||i.set({fontSize:e})}onColorChanged(){var e;this.sRGBTextColor.copy(this.color),this.sRGBTextColor.convertLinearToSRGB(),(e=this.uiObject)==null||e.set({color:this.sRGBTextColor,fontOpacity:this.color.alpha})}onParentRectTransformChanged(){super.onParentRectTransformChanged(),this.uiObject&&this.updateOverflow()}onBeforeCanvasRender(e){this.updateOverflow()}updateOverflow(){var i;const e=(i=this.uiObject)==null?void 0:i._overflow;e&&(e._needsUpdate=!0)}onCreate(e){Rl&&console.log(this),this.horizontalOverflow==Bu.Overflow&&(e.whiteSpace="pre"),this.verticalOverflow==Fu.Truncate&&(this.context.renderer.localClippingEnabled=!0,e.overflow="hidden"),this.horizontalOverflow==Bu.Overflow&&this.verticalOverflow==Fu.Truncate,e.lineHeight=this.lineSpacing,delete e.backgroundOpacity,delete e.backgroundColor,Rl&&(e.backgroundColor=16750848,e.backgroundOpacity=.5);const i=this.rectTransform;e={...e,...this.getTextOpts()},this.getAlignment(e),Rl&&(e.backgroundColor=Math.random()*16777215,e.backgroundOpacity=.1),this.uiObject=i.createNewText(e),this.feedText(this.text,this.supportRichText)}onAfterAddedToScene(){super.onAfterAddedToScene(),this.handleTextRenderOnTop()}getTextOpts(){const e=this.fontSize,i={color:this.color,fontOpacity:this.color.alpha,fontSize:e,fontKerning:"normal"};return this.setFont(i,this.fontStyle),i}onEnable(){var e;super.onEnable(),this._didHandleTextRenderOnTop=!1,this.uiObject&&this.uiObject.addAfterUpdate(()=>{this.setShadowComponentOwner(this.uiObject),this.markDirty()}),setTimeout(()=>this.markDirty(),10),(e=this.canvas)==null||e.registerEventReceiver(this)}onDisable(){var e;super.onDisable(),(e=this.canvas)==null||e.unregisterEventReceiver(this)}getAlignment(e){switch(e.flexDirection="column",this.alignment){case Re.UpperLeft:case Re.MiddleLeft:case Re.LowerLeft:e.textAlign="left";break;case Re.UpperCenter:case Re.MiddleCenter:case Re.LowerCenter:e.textAlign="center";break;case Re.UpperRight:case Re.MiddleRight:case Re.LowerRight:e.textAlign="right";break}switch(this.alignment){default:case Re.UpperLeft:case Re.UpperCenter:case Re.UpperRight:e.alignItems="start";break;case Re.MiddleLeft:case Re.MiddleCenter:case Re.MiddleRight:e.alignItems="center";break;case Re.LowerLeft:case Re.LowerCenter:case Re.LowerRight:e.alignItems="end";break}return e}feedText(e,i){var n,o,r;if(Rl&&console.log("feedText",this.uiObject,e,i),!!this.uiObject)if(this._textMeshUi||(this._textMeshUi=[]),this.uiObject.children.length=0,!i||e.length===0)this.uiObject.textContent=e;else{let l=this.getNextTag(e);if(l){if(l.startIndex>0){for(let d=this.uiObject.children.length-1;d>=0;d--){const u=this.uiObject.children[d];u.isUI&&(this.uiObject.remove(u),u.clear())}const h=new zy({textContent:e.substring(0,l.startIndex),color:"inherit"});this.uiObject.add(h)}}else{this.uiObject.textContent="",this.setOptions({textContent:e});return}const c=[];for(;l;){const h=this.getNextTag(e,l.endIndex),d={fontFamily:(n=this.uiObject)==null?void 0:n.get("fontFamily"),color:"inherit",textContent:""};if(h){d.textContent=this.getText(e,l,h),this.handleTag(l,d,c);const u=new zy(d);(o=this.uiObject)==null||o.add(u)}else{d.textContent=e.substring(l.endIndex),this.handleTag(l,d,c);const u=new zy(d);(r=this.uiObject)==null||r.add(u)}l=h}}}handleTextRenderOnTop(){this._didHandleTextRenderOnTop||(this._didHandleTextRenderOnTop=!0,this.startCoroutine(this.renderOnTopCoroutine()))}*renderOnTopCoroutine(){if(!this.canvas)return;const e=[],i=this.canvas,n={renderOnTop:i.renderOnTop,depthWrite:i.depthWrite,doubleSided:i.doubleSided};for(;;){let o=!1;if(this._textMeshUi)for(let r=0;r<this._textMeshUi.length;r++){if(e[r]===!0)continue;o=!0;const l=this._textMeshUi[r];l.textContent&&(Um(l,n),e[r]=!0)}if(!o)break;yield}}handleTag(e,i,n){if(!e.isEndTag){if(e.type.includes("color")){const o=new zb(e,{color:i.color});if(n.push(o),e.type.length>6){const r=parseInt("0x"+e.type.substring(7));i.color=r}else i.color=new Se(1,1,1)}else if(e.type=="b"){this.setFont(i,xn.Bold);const o=new zb(e,{fontWeight:700});n.push(o)}else if(e.type=="i"){this.setFont(i,xn.Italic);const o=new zb(e,{fontStyle:"italic"});n.push(o)}}}getText(e,i,n){return e.substring(i.endIndex,n.startIndex)}getNextTag(e,i=0){const n=e.indexOf("<",i),o=e.indexOf(">",n);if(n>=0&&o>=0){const r=e.substring(n+1,o);return{type:r,startIndex:n,endIndex:o+1,isEndTag:r.startsWith("/")}}return null}setFont(e,i){if(!this.font)return;const n=this.font,o=this.getFamilyNameWithCorrectSuffix(n,i);Rl&&console.log("Selected font family:"+o);let r=Nx.getFontFamily(o);switch(r||(r=Nx.addFontFamily(o)),e.fontFamily=r,i){default:case xn.Normal:e.fontWeight=400,e.fontStyle="normal";break;case xn.Bold:e.fontWeight=700,e.fontStyle="normal";break;case xn.Italic:e.fontWeight=400,e.fontStyle="italic";break;case xn.BoldAndItalic:e.fontStyle="italic",e.fontWeight=400}let l=r.getVariant(e.fontWeight,e.fontStyle);if(!l){let c=o;c!=null&&c.endsWith("-msdf.json")||(c+="-msdf.json");let h=o;h!=null&&h.endsWith(".png")||(h+=".png"),l=r.addVariant(e.fontWeight,e.fontStyle,c,h),l==null||l.addEventListener("ready",()=>{this.markDirty()})}}getFamilyNameWithCorrectSuffix(e,i){var d;(e.startsWith("https:")||e.startsWith("http:"))&&(e=new URL(e).pathname);const n=e.lastIndexOf("-");if(n<0)return e;const o=(d=e.substring(n+1))==null?void 0:d.toLowerCase();if(P3.includes(o))return Rl&&console.warn("Unsupported font style: "+o),e;const r=e.lastIndexOf("/");let l=e;r>=0&&(l=l.substring(r+1));const c=l[0]===l[0].toUpperCase(),h=e.substring(0,n>r?n:e.length);switch(Rl&&console.log("Select font: ",e,xn[i],l,c,h),i){case xn.Normal:return c?h+"-Regular":h+"-regular";case xn.Bold:return c?h+"-Bold":h+"-bold";case xn.Italic:return c?h+"-Italic":h+"-italic";case xn.BoldAndItalic:return c?h+"-BoldItalic":h+"-bolditalic";default:return e}}}ta([g()],gn.prototype,"alignment",void 0);ta([g()],gn.prototype,"verticalOverflow",void 0);ta([g()],gn.prototype,"horizontalOverflow",void 0);ta([g()],gn.prototype,"lineSpacing",void 0);ta([g()],gn.prototype,"supportRichText",void 0);ta([g(URL)],gn.prototype,"font",void 0);ta([g()],gn.prototype,"fontStyle",void 0);ta([g()],gn.prototype,"text",null);ta([g()],gn.prototype,"fontSize",null);class zb{constructor(t,e){a(this,"tag");a(this,"previousValues");this.tag=t,this.previousValues=e}}const P3=["medium","mediumitalic","black","blackitalic","thin","thinitalic","extrabold","light","lightitalic","semibold"];var Uu;(function(s){s.singleLine="singleLine",s.hardBreaks="hardBreaks",s.flowing="flowing"})(Uu||(Uu={}));var ph;(function(s){s.left="left",s.center="center",s.right="right",s.justified="justified"})(ph||(ph={}));var mh;(function(s){s.top="top",s.middle="middle",s.lowerMiddle="lowerMiddle",s.baseline="baseline",s.bottom="bottom"})(mh||(mh={}));class gh{constructor(t){a(this,"id");a(this,"content","");a(this,"font",[]);a(this,"pointSize",144);a(this,"width");a(this,"height");a(this,"depth");a(this,"wrapMode");a(this,"horizontalAlignment");a(this,"verticalAlignment");a(this,"material");this.id=t}static getId(){return this.global_id++}setDepth(t){return this.depth=t,this}setPointSize(t){return this.pointSize=t,this}setHorizontalAlignment(t){return this.horizontalAlignment=t,this}setVerticalAlignment(t){return this.verticalAlignment=t,this}writeTo(t,e){var n;e.beginBlock(`def Preliminary_Text "${this.id}"`,"(",!1),e.appendLine('prepend apiSchemas = ["MaterialBindingAPI"]'),e.closeBlock(")"),e.beginBlock(),this.content&&e.appendLine(`string content = "${this.content}"`),(!this.font||this.font.length<=0)&&(this.font||(this.font=[]),(n=this.font)==null||n.push("sans-serif"));const i=this.font.map(o=>`"${o}"`).join(", ");e.appendLine(`string[] font = [ ${i} ]`),e.appendLine(`double pointSize = ${this.pointSize}`),typeof this.width=="number"&&e.appendLine(`double width = ${this.width}`),typeof this.height=="number"&&e.appendLine(`double height = ${this.height}`),typeof this.depth=="number"&&e.appendLine(`double depth = ${this.depth}`),this.wrapMode&&e.appendLine(`token wrapMode = "${this.wrapMode}"`),this.horizontalAlignment&&e.appendLine(`token horizontalAlignment = "${this.horizontalAlignment}"`),this.verticalAlignment&&e.appendLine(`token verticalAlignment = "${this.verticalAlignment}"`),this.material!==void 0&&e.appendLine(`rel material:binding = </StageRoot/Materials/${Kg(this.material)}>`),e.closeBlock()}}a(gh,"global_id",0);class hR{static singleLine(t,e,i){const n=new gh("text_"+gh.getId());return n.content=t,e&&(n.pointSize=e),i&&(n.depth=i),n}static multiLine(t,e,i,n,o,r){const l=new gh("text_"+gh.getId());return l.content=t,l.width=e,l.height=i,l.horizontalAlignment=n,l.verticalAlignment=o,r!==void 0&&(l.wrapMode=r),l}}const T3=new xe().makeRotationY(Math.PI),R3=new xe().makeScale(-1,1,-1);class kv{get extensionName(){return"text"}exportText(t,e,i){const n=I.getComponent(t,gn);if(!n)return;const o=I.getComponent(t,Mi);let r=100,l=100;o&&(r=o.width,l=o.height);const c=T3.clone();o&&c.premultiply(R3),e.setMatrix(c);const h=n.color.clone();e.material=new ti({color:h,emissive:h}),e.addEventListener("serialize",(d,u)=>{let f=n.text;f=f.replace(/\r/g,""),f=f.replace(/\n/g,"\\n");const p=hR.multiLine(f,r,l,ph.center,mh.bottom,Uu.flowing);this.setTextAlignment(p,n.alignment),this.setOverflow(p,n),e.material&&(p.material=e.material),p.pointSize=this.convertToTextSize(n.fontSize),p.depth=.001,p.writeTo(void 0,d)})}convertToTextSize(t){return 1/.0502*144*t}setOverflow(t,e){e.horizontalOverflow?t.wrapMode=Uu.singleLine:t.wrapMode=Uu.flowing}setTextAlignment(t,e){switch(e){case Re.LowerLeft:case Re.MiddleLeft:case Re.UpperLeft:t.horizontalAlignment=ph.left;break;case Re.LowerCenter:case Re.MiddleCenter:case Re.UpperCenter:t.horizontalAlignment=ph.center;break;case Re.LowerRight:case Re.MiddleRight:case Re.UpperRight:t.horizontalAlignment=ph.right;break}switch(e){case Re.LowerLeft:case Re.LowerCenter:case Re.LowerRight:t.verticalAlignment=mh.bottom;break;case Re.MiddleLeft:case Re.MiddleCenter:case Re.MiddleRight:t.verticalAlignment=mh.middle;break;case Re.UpperLeft:case Re.UpperCenter:case Re.UpperRight:t.verticalAlignment=mh.top;break}}}var zt=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const aC=k("debuguilayout");class yd{constructor(){a(this,"left",0);a(this,"right",0);a(this,"top",0);a(this,"bottom",0)}get vertical(){return this.top+this.bottom}get horizontal(){return this.left+this.right}}zt([g()],yd.prototype,"left",void 0);zt([g()],yd.prototype,"right",void 0);zt([g()],yd.prototype,"top",void 0);zt([g()],yd.prototype,"bottom",void 0);var c0;(function(s){s[s.UpperLeft=0]="UpperLeft",s[s.UpperCenter=1]="UpperCenter",s[s.UpperRight=2]="UpperRight",s[s.MiddleLeft=3]="MiddleLeft",s[s.MiddleCenter=4]="MiddleCenter",s[s.MiddleRight=5]="MiddleRight",s[s.LowerLeft=6]="LowerLeft",s[s.LowerCenter=7]="LowerCenter",s[s.LowerRight=8]="LowerRight",s[s.Custom=9]="Custom"})(c0||(c0={}));var rc;(function(s){s.Horizontal="x",s.Vertical="y"})(rc||(rc={}));class Zn extends W{constructor(){super(...arguments);a(this,"_rectTransform",null);a(this,"_needsUpdate",!1);a(this,"childAlignment",c0.UpperLeft);a(this,"reverseArrangement",!1);a(this,"spacing",0);a(this,"padding");a(this,"minWidth",0);a(this,"minHeight",0);a(this,"flexibleHeight",0);a(this,"flexibleWidth",0);a(this,"preferredHeight",0);a(this,"preferredWidth",0)}get rectTransform(){return this._rectTransform}onParentRectTransformChanged(e){this._needsUpdate=!0}get isDirty(){return this._needsUpdate}get isLayoutGroup(){return!0}updateLayout(){this._rectTransform&&(aC&&console.warn("Layout Update",this.context.time.frame,this.name),this._needsUpdate=!1,this.onCalculateLayout(this._rectTransform))}start(){this._needsUpdate=!0}onEnable(){aC&&console.log(this.name,this),this._rectTransform=this.gameObject.getComponent(Mi);const e=this.gameObject.getComponentInParent(ri);e&&e.registerLayoutGroup(this),this._needsUpdate=!0}onDisable(){const e=this.gameObject.getComponentInParent(ri);e&&e.unregisterLayoutGroup(this)}set m_Spacing(e){e!==this.spacing&&(this._needsUpdate=!0,this.spacing=e)}get m_Spacing(){return this.spacing}}zt([g()],Zn.prototype,"childAlignment",void 0);zt([g()],Zn.prototype,"reverseArrangement",void 0);zt([g()],Zn.prototype,"spacing",void 0);zt([g(yd)],Zn.prototype,"padding",void 0);zt([g()],Zn.prototype,"minWidth",void 0);zt([g()],Zn.prototype,"minHeight",void 0);zt([g()],Zn.prototype,"flexibleHeight",void 0);zt([g()],Zn.prototype,"flexibleWidth",void 0);zt([g()],Zn.prototype,"preferredHeight",void 0);zt([g()],Zn.prototype,"preferredWidth",void 0);class tl extends Zn{constructor(){super(...arguments);a(this,"childControlHeight",!0);a(this,"childControlWidth",!0);a(this,"childForceExpandHeight",!1);a(this,"childForceExpandWidth",!1);a(this,"childScaleHeight",!1);a(this,"childScaleWidth",!1)}onCalculateLayout(e){var G;const i=this.primaryAxis,n=e.width;let o=n;const r=e.height;let l=r;o-=this.padding.horizontal,l-=this.padding.vertical,i===rc.Horizontal?this.padding.horizontal:this.padding.vertical;const c=i===rc.Horizontal,h=c?"y":"x",d=c?this.childControlWidth:this.childControlHeight,u=c?this.childControlHeight:this.childControlWidth,f=c?this.childForceExpandWidth:this.childForceExpandHeight,p=c?this.childForceExpandHeight:this.childForceExpandWidth,b=c?l:o,x=c?n:r,v=.5*(c?this.childAlignment%3:Math.floor(this.childAlignment/3));let S=0;c?S+=this.padding.left:S+=this.padding.top;let C=0,P=0;for(let V=0;V<this.gameObject.children.length;V++){const U=this.gameObject.children[V],$=I.getComponent(U,Mi);$!=null&&$.activeAndEnabled&&(P+=1,c?C+=$.width:C+=$.height)}let E=0;const D=this.spacing*(P-1);if(f||d){let V=0;c?V=o-=D:V=l-=D,P>0&&(E=V/P)}let M=0;M+=this.padding.left,M-=this.padding.right,v!==0&&(S=x-C,S*=v,S-=D*v,c?(S-=this.padding.right*v,S+=this.padding.left*(1-v),S<this.padding.left&&(S=this.padding.left)):(S-=this.padding.bottom*v,S+=this.padding.top*(1-v),S<this.padding.top&&(S=this.padding.top)));let A=1;for(let V=0;V<this.gameObject.children.length;V++){const U=this.gameObject.children[V],$=I.getComponent(U,Mi);if($!=null&&$.activeAndEnabled){(G=$.pivot)==null||G.set(.5,.5),$.anchorMin.set(0,1),$.anchorMax.set(0,1);const Y=n*.5+M*.5;$.anchoredPosition.x!==Y&&($.anchoredPosition.x=Y);const B=r*-.5;$.anchoredPosition.y!==B&&($.anchoredPosition.y=B),p&&u&&$.sizeDelta[h]!==b&&($.sizeDelta[h]=b),f&&d&&$.sizeDelta[i]!==E&&($.sizeDelta[i]=E);const N=c?$.width:$.height,Z=N*.5;if(S+=Z,f){const ie=E*A-E*.5;ie>S&&(S=ie-E*.5+N+this.padding.left,S-=Z)}let ae=S;i===rc.Vertical&&(ae=-ae),$.anchoredPosition[i]!==ae&&($.anchoredPosition[i]=ae),S+=Z,S+=this.spacing,A+=1}}}}zt([g()],tl.prototype,"childControlHeight",void 0);zt([g()],tl.prototype,"childControlWidth",void 0);zt([g()],tl.prototype,"childForceExpandHeight",void 0);zt([g()],tl.prototype,"childForceExpandWidth",void 0);zt([g()],tl.prototype,"childScaleHeight",void 0);zt([g()],tl.prototype,"childScaleWidth",void 0);class dR extends tl{get primaryAxis(){return rc.Vertical}}class uR extends tl{get primaryAxis(){return rc.Horizontal}}class fR extends Zn{onCalculateLayout(){}}var tr=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},Oo;(function(s){s[s.ScreenSpaceOverlay=0]="ScreenSpaceOverlay",s[s.ScreenSpaceCamera=1]="ScreenSpaceCamera",s[s.WorldSpace=2]="WorldSpace",s[s.Undefined=-1]="Undefined"})(Oo||(Oo={}));const $b=k("debuguilayout");class ri extends iy{constructor(){super(...arguments);a(this,"_renderOnTop");a(this,"_depthWrite",!1);a(this,"_doubleSided",!0);a(this,"_castShadows",!1);a(this,"_receiveShadows",!1);a(this,"_renderMode",Oo.Undefined);a(this,"_rootCanvas");a(this,"_scaleFactor",1);a(this,"worldCamera");a(this,"planeDistance",-1);a(this,"_boundRenderSettingsChanged",this.onRenderSettingsChanged.bind(this));a(this,"previousParent",null);a(this,"_lastMatrixWorld",null);a(this,"_rectTransforms",[]);a(this,"_layoutGroups",new Map);a(this,"_receivers",[]);a(this,"onBeforeRenderRoutine",()=>{var e,i,n,o;if(this.previousParent=this.gameObject.parent,((e=this.context.xr)!=null&&e.isVR||(i=this.context.xr)!=null&&i.isPassThrough)&&this.screenspace){this.gameObject.visible=!1,this.gameObject.removeFromParent();return}this.renderOnTop||this.screenspace?this.gameObject.removeFromParent():(this.onUpdateRenderMode(),this.handleLayoutUpdates(),(n=this.shadowComponent)==null||n.updateMatrixWorld(!0),(o=this.shadowComponent)==null||o.updateWorldMatrix(!0,!0),this.invokeBeforeRenderEvents(),Rn.ensureUpdateMeshUI(zx,this.context))});a(this,"onAfterRenderRoutine",()=>{var e,i,n,o,r;if(((e=this.context.xr)!=null&&e.isVR||(i=this.context.xr)!=null&&i.isPassThrough)&&this.screenspace){(n=this.previousParent)==null||n.add(this.gameObject);return}if((this.screenspace||this.renderOnTop)&&this.previousParent&&this.context.mainCamera){if(this.screenspace){const h=this.context.mainCamera;h==null||h.add(this.gameObject)}else this.previousParent.add(this.gameObject);const l=this.context.renderer.autoClear,c=this.context.renderer.autoClearColor;this.context.renderer.autoClear=!1,this.context.renderer.autoClearColor=!1,this.context.renderer.clearDepth(),this.onUpdateRenderMode(!0),this.handleLayoutUpdates(),(o=this.shadowComponent)==null||o.updateMatrixWorld(!0),this.invokeBeforeRenderEvents(),Rn.ensureUpdateMeshUI(zx,this.context,!0),this.context.renderer.render(this.gameObject,this.context.mainCamera),this.context.renderer.autoClear=l,this.context.renderer.autoClearColor=c,this.previousParent.add(this.gameObject)}(r=this._lastMatrixWorld)==null||r.copy(this.gameObject.matrixWorld)});a(this,"_updateRenderSettingsRoutine");a(this,"_activeRenderMode",-1);a(this,"_lastWidth",-1);a(this,"_lastHeight",-1)}get isCanvas(){return!0}get screenspace(){return this.renderMode!==Oo.WorldSpace}set renderOnTop(e){e!==this._renderOnTop&&(this._renderOnTop=e,this.onRenderSettingsChanged())}get renderOnTop(){return this._renderOnTop!==void 0?this._renderOnTop:!!(this.screenspace&&this._renderMode===Oo.ScreenSpaceOverlay)}set depthWrite(e){this._depthWrite!==e&&(this._depthWrite=e,this.onRenderSettingsChanged())}get depthWrite(){return this._depthWrite}set doubleSided(e){this._doubleSided!==e&&(this._doubleSided=e,this.onRenderSettingsChanged())}get doubleSided(){return this._doubleSided}set castShadows(e){this._castShadows!==e&&(this._castShadows=e,this.onRenderSettingsChanged())}get castShadows(){return this._castShadows}set receiveShadows(e){this._receiveShadows!==e&&(this._receiveShadows=e,this.onRenderSettingsChanged())}get receiveShadows(){return this._receiveShadows}get renderMode(){return this._renderMode}set renderMode(e){this._renderMode!==e&&(this._renderMode=e,this.onRenderSettingsChanged())}set rootCanvas(e){this._rootCanvas instanceof ri||(this._rootCanvas=e)}get rootCanvas(){return this._rootCanvas}get scaleFactor(){return this._scaleFactor}set scaleFactor(e){this._scaleFactor=e}awake(){var e;this.shadowComponent=this.gameObject,this.previousParent=this.gameObject.parent,$b&&console.log("Canvas.Awake()",((e=this.previousParent)==null?void 0:e.name)+"/"+this.gameObject.name),super.awake()}start(){this.applyRenderSettings()}onEnable(){super.onEnable(),this._updateRenderSettingsRoutine=void 0,this._lastMatrixWorld=new xe,this.applyRenderSettings(),document.addEventListener("resize",this._boundRenderSettingsChanged),this.context.pre_render_callbacks.push(this.onBeforeRenderRoutine),this.context.post_render_callbacks.push(this.onAfterRenderRoutine)}onDisable(){super.onDisable(),document.removeEventListener("resize",this._boundRenderSettingsChanged);const e=this.context.pre_render_callbacks.indexOf(this.onBeforeRenderRoutine);e!==-1&&this.context.pre_render_callbacks.splice(e,1);const i=this.context.post_render_callbacks.indexOf(this.onAfterRenderRoutine);i!==-1&&this.context.post_render_callbacks.splice(i,1)}registerTransform(e){this._rectTransforms.push(e)}unregisterTransform(e){const i=this._rectTransforms.indexOf(e);i!==-1&&this._rectTransforms.splice(i,1)}registerLayoutGroup(e){const i=e.gameObject;this._layoutGroups.set(i,e)}unregisterLayoutGroup(e){const i=e.gameObject;this._layoutGroups.delete(i)}registerEventReceiver(e){this._receivers.push(e)}unregisterEventReceiver(e){const i=this._receivers.indexOf(e);i!==-1&&this._receivers.splice(i,1)}async onEnterXR(e){this.screenspace?(e.xr.isVR||e.xr.isPassThrough)&&(this.gameObject.visible=!1):(this.gameObject.visible=!1,await kg(1).then(()=>{this.gameObject.visible=!0}))}onLeaveXR(e){this.screenspace&&(e.xr.isVR||e.xr.isPassThrough)&&(this.gameObject.visible=!0)}invokeBeforeRenderEvents(){var e;for(const i of this._receivers)(e=i.onBeforeCanvasRender)==null||e.call(i,this)}handleLayoutUpdates(){this._lastMatrixWorld===null&&(this._lastMatrixWorld=new xe);const e=!this._lastMatrixWorld.equals(this.gameObject.matrixWorld);$b&&e&&console.log("Canvas Layout changed",this.context.time.frameCount,this.name);const i=!1;for(const n of this._rectTransforms){e&&n.markDirty();let o=this._layoutGroups.get(n.gameObject);n.isDirty&&!o&&(o=n.gameObject.getComponentInParent(Zn)),(n.isDirty||o!=null&&o.isDirty)&&($b&&!i&&console.log("CANVAS UPDATE ### "+n.name+" ##################################### "+this.context.time.frame),o==null||o.updateLayout(),n.updateTransform())}}applyRenderSettings(){this.onRenderSettingsChanged()}onRenderSettingsChanged(){this._updateRenderSettingsRoutine||(this._updateRenderSettingsRoutine=this.startCoroutine(this._updateRenderSettingsDelayed(),ge.OnBeforeRender))}*_updateRenderSettingsDelayed(){if(yield,this._updateRenderSettingsRoutine=void 0,this.shadowComponent){this.onUpdateRenderMode(),Um(this.shadowComponent,this);for(const e of I.getComponentsInChildren(this.gameObject,eo))Um(e.shadowComponent,this)}}onUpdateRenderMode(e=!1){if(!e&&this._renderMode===this._activeRenderMode&&this._lastWidth===this.context.domWidth&&this._lastHeight===this.context.domHeight)return;this._activeRenderMode=this._renderMode;let i=this.context.mainCameraComponent,n=10;switch(i&&i.nearClipPlane>0&&i.farClipPlane>0&&(n=ee.lerp(i.nearClipPlane,i.farClipPlane,.01)),this._renderMode===Oo.ScreenSpaceCamera&&(this.worldCamera&&(i=this.worldCamera),this.planeDistance>0&&(n=this.planeDistance)),this._renderMode){case Oo.ScreenSpaceOverlay:case Oo.ScreenSpaceCamera:if(this._lastWidth=this.context.domWidth,this._lastHeight=this.context.domHeight,!i)return;const o=n+.01;this.gameObject.position.x=0,this.gameObject.position.y=0,this.gameObject.position.z=-o,this.gameObject.quaternion.identity();const r=this.gameObject.getComponent(Mi);let l=!1;r.sizeDelta.x!==this.context.domWidth&&(l=!0),r.sizeDelta.y!==this.context.domHeight&&(l=!0);const c=i.fieldOfView*Math.PI/180,h=2*Math.tan(c/2)*Math.abs(o);this.gameObject.scale.x=h/this.context.domHeight,this.gameObject.scale.y=h/this.context.domHeight,this.gameObject.scale.z=.01,l&&(r.sizeDelta.x=this.context.domWidth,r.sizeDelta.y=this.context.domHeight,r==null||r.markDirty());break;case Oo.WorldSpace:this._lastWidth=-1,this._lastHeight=-1;break}}}tr([g()],ri.prototype,"renderOnTop",null);tr([g()],ri.prototype,"depthWrite",null);tr([g()],ri.prototype,"doubleSided",null);tr([g()],ri.prototype,"castShadows",null);tr([g()],ri.prototype,"receiveShadows",null);tr([g()],ri.prototype,"renderMode",null);tr([g(ri)],ri.prototype,"rootCanvas",null);tr([g()],ri.prototype,"scaleFactor",null);tr([g(ze)],ri.prototype,"worldCamera",void 0);tr([g()],ri.prototype,"planeDistance",void 0);var Ev=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class fc extends W{constructor(){super(...arguments);a(this,"_alpha",1);a(this,"interactable",!0);a(this,"blocksRaycasts",!0);a(this,"_isDirty",!1);a(this,"_buffer",[])}get alpha(){return this._alpha}set alpha(e){e!==this._alpha&&(this._alpha=e,this.markDirty())}get isCanvasGroup(){return!0}markDirty(){this._isDirty||(this._isDirty=!0,this.startCoroutine(this.applyChangesDelayed(),ge.OnBeforeRender))}*applyChangesDelayed(){this._isDirty=!1,this.applyChangesNow()}applyChangesNow(){this._buffer.length=0;for(const e of I.getComponentsInChildren(this.gameObject,eo,this._buffer)){const i=e;i.setAlphaFactor&&i.setAlphaFactor(this._alpha)}}}Ev([g()],fc.prototype,"alpha",null);Ev([g()],fc.prototype,"interactable",void 0);Ev([g()],fc.prototype,"blocksRaycasts",void 0);class pR{get extensionName(){return"tmui"}onExportObject(t,e,i){const n=I.getComponent(t,ri);if(n&&n.enabled&&n.renderMode===Oo.WorldSpace){const o=new kv,r=I.getComponent(t,Mi),l=I.getComponent(t,fc),c=new Array;if(r){if(!I.isActiveSelf(t)){const u=I.isActiveSelf(t);I.setActive(t,!0),r.onEnable(),r.updateTransform(),c.push(()=>{r.onDisable(),I.setActive(t,u)})}t.traverse(u=>{if(!I.isActiveInHierarchy(u)){const f=I.isActiveSelf(u);I.setActive(u,!0);const p=I.getComponent(u,eo);p&&(p.onEnable(),c.push(()=>{p.onDisable()}));const b=I.getComponent(u,Mi);b&&(b.onEnable(),b.updateTransform(),b.onApplyTransform(),c.push(()=>{b.onDisable()}));const x=I.getComponent(u,gn);x&&(x.onEnable(),c.push(()=>{x.onDisable()})),c.push(()=>{I.setActive(u,f)})}}),r.width,r.height;const h=Yi.createEmpty(),d=r.shadowComponent;if(e.add(h),d){const u=d.matrix;h.setMatrix(u);const f=new Map,p=new Map;f.set(d,h),p.set(d,l?l.alpha:1),d.traverse(b=>{if(b===d)return;const x=Yi.createEmpty();x.setMatrix(b.matrix);const v=b.parent,S=!!v&&typeof v.textContent=="string"&&v.textContent.length>0;let C=p.get(v)||1;const P=I.getComponent(b,fc);if(P&&(C*=P.alpha),b instanceof le&&S){const D=b[zn];D?o.exportText(D.gameObject,x,i):console.error("Error when exporting UI: shadow component owner not found. This is likely a bug.",b)}if(b instanceof le&&!S){const D=b.geometry.clone();D.scale(1,1,-1),this.flipWindingOrder(D),x.geometry=D;const M=new Se,A=b.material.opacity;M.copy(b.material.color),x.material=new Ye({color:M,opacity:A*C,map:b.material.map,transparent:!0})}f.set(b,x),p.set(b,C);const E=f.get(v);if(!E){console.error("Error when exporting UI: shadow component parent not found!",b,b.parent);return}E.add(x)})}}for(const h of c)h()}}flipWindingOrder(t){const e=t.index.array;for(let i=0,n=e.length/3;i<n;i++){const o=e[i*3];e[i*3]=e[i*3+2],e[i*3+2]=o}t.index.needsUpdate=!0}}const fu=k("debugusdz");function O3(s,t){var l;const e=[],i=I.getComponentsInChildren(s,Ei),n=I.getComponentsInChildren(s,pn),o=new Array,r=new Array;if(t.injectImplicitBehaviours)for(const c of i){if(!c||!c.runtimeAnimatorController||!c.enabled)continue;const h=c.runtimeAnimatorController.activeState;if(!h||!h.motion||!h.motion.clip||((l=h.motion.clip.tracks)==null?void 0:l.length)<1||o.includes(c))continue;const d=new Uo;d.animator=c,d.stateName=h.name,d.trigger="start",d.name="PlayAnimationOnClick_implicitAtStart_"+d.stateName;const u=new z;I.addComponent(u,d),r.push(u),o.push(c),s.add(u)}else for(const c of i){if(!c||!c.runtimeAnimatorController||!c.enabled)continue;fu&&console.log(c);const h=[];for(const d of c.runtimeAnimatorController.enumerateActions()){fu&&console.log(d);const u=d.getClip();h.includes(u)||h.push(u)}e.push({root:c.gameObject,clips:h})}if(t.injectImplicitBehaviours)for(const c of n){if(!c||!c.clip||!c.enabled||!c.playAutomatically||o.includes(c))continue;const h=new Uo;h.animation=c,h.stateName=c.clip.name,h.trigger="start",h.name="PlayAnimationOnClick_implicitAtStart_"+h.stateName;const d=new z;I.addComponent(d,h),r.push(d),o.push(c),s.add(d)}else for(const c of n){fu&&console.log(c);const h=[];for(const d of c.animations)h.includes(d)||h.push(d);e.push({root:c.gameObject,clips:h})}fu&&(e==null?void 0:e.length)>0&&console.log("USDZ Animation Clips without behaviours",e);for(const c of e)for(const h of c.clips)t.registerAnimation(c.root,h);return r}function k3(s,t){const e=I.getComponentsInChildren(s,We),i=I.getComponentsInChildren(s,dc),n=new Array,o=new Array;fu&&console.log({audioSources:e,playAudioOnClicks:i});for(const r of i){if(!r.target)continue;const l=e.indexOf(r.target);l>-1&&e.splice(l,1)}for(const r of e){if(!r||!r.clip||r.volume<=0||n.includes(r))continue;const l=new dc;l.target=r,l.name="PlayAudioOnClick_implicitAtStart_",l.trigger="start";const c=new z;I.addComponent(c,l),console.log("implicit PlayAudioOnStart",c,l),o.push(c),n.push(r),s.add(c)}return o}function E3(s){return new ki("DisableAtStart",Zi.sceneStartTrigger(),Ve.fadeAction(s,0,!1))}function lC(s,t){const e=s.domElement.shadowRoot.querySelector("link[rel='ar']");if(e)return e;const i=document.createElement("div");i.classList.add("menu"),i.classList.add("quicklook-menu"),i.style.display="none",i.style.visibility="hidden";const n=document.createElement("button");n.id="open-in-ar",t?(n.innerText="View in AR",n.title="View this scene in AR. The scene will be exported to USDZ and opened with Apple's QuickLook."):(n.innerText="View in AR",n.title="Download this scene for AR. Open the downloaded USDZ file to view it in AR using Apple's QuickLook."),i.appendChild(n);const o=document.createElement("a");o.id="needle-usdz-link",o.style.display="none",o.rel="ar",o.href="",o.target="_blank",i.appendChild(o);const r=document.createElement("img");return r.id="button",o.appendChild(r),s.domElement.shadowRoot.appendChild(i),o}var Li=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const yi=k("debugusdz"),M3=k("debugusdzpruning");class bd{constructor(){a(this,"callToAction");a(this,"checkoutTitle");a(this,"checkoutSubtitle");a(this,"callToActionURL")}}Li([g()],bd.prototype,"callToAction",void 0);Li([g()],bd.prototype,"checkoutTitle",void 0);Li([g()],bd.prototype,"checkoutSubtitle",void 0);Li([g()],bd.prototype,"callToActionURL",void 0);const Ca=class extends W{constructor(){super(...arguments);a(this,"objectToExport");a(this,"autoExportAnimations",!0);a(this,"autoExportAudioSources",!0);a(this,"exportFileName");a(this,"customUsdzFile");a(this,"customBranding");a(this,"anchoringType","plane");a(this,"maxTextureSize",2048);a(this,"planeAnchoringAlignment","horizontal");a(this,"interactive",!0);a(this,"physics",!0);a(this,"allowCreateQuicklookButton",!0);a(this,"quickLookCompatible",!0);a(this,"extensions",[]);a(this,"link");a(this,"button");a(this,"onClickedOpenInARElement",e=>{e.preventDefault(),this.exportAndOpen()});a(this,"_currentExportTasks",new Map);a(this,"_previousTimeScale",1);a(this,"lastCallback");a(this,"_rootSessionRootWasAppliedTo",null);a(this,"_rootPositionBeforeExport",new R);a(this,"_rootRotationBeforeExport",new re);a(this,"_rootScaleBeforeExport",new R)}start(){var e,i,n;yi&&(console.log("USDZExporter",this),console.log("Debug USDZ Mode. Press 'T' to export"),window.addEventListener("keydown",o=>{switch(o.key){case"t":this.exportAndOpen();break}})),this.objectToExport||(this.objectToExport=this.gameObject),!((i=(e=this.objectToExport)==null?void 0:e.children)!=null&&i.length)&&!((n=this.objectToExport)!=null&&n.isMesh)&&(this.objectToExport=this.context.scene)}onEnable(){var n;const e=Q.supportsQuickLookAR(),i=Q.isiOS()||Q.isiPad();!this.button&&(yi||e||i)&&(this.allowCreateQuicklookButton&&(this.button=this.createQuicklookButton()),this.lastCallback=this.quicklookCallback.bind(this),this.link=lC(this.context,e),this.link.addEventListener("message",this.lastCallback)),yi&&at("USDZ Exporter enabled: "+this.name),(n=document.getElementById("open-in-ar"))==null||n.addEventListener("click",this.onClickedOpenInARElement),ff.registerExporter(this)}onDisable(){var e,i,n;(e=this.button)==null||e.remove(),(i=this.link)==null||i.removeEventListener("message",this.lastCallback),yi&&at("USDZ Exporter disabled: "+this.name),(n=document.getElementById("open-in-ar"))==null||n.removeEventListener("click",this.onClickedOpenInARElement),ff.unregisterExporter(this)}async exportAsync(){return this.exportAndOpen()}async exportAndOpen(){var n;let e=this.exportFileName??((n=this.objectToExport)==null?void 0:n.name)??this.name;if(e+="-"+LD(),Dr()||(e!==""&&(e+="-"),e+="MadeWithNeedle"),this.link||(this.link=lC(this.context,Q.supportsQuickLookAR())),this.customUsdzFile)return yi&&console.log("Exporting custom usdz",this.customUsdzFile),this.openInQuickLook(this.customUsdzFile,e),null;if(!this.objectToExport)return console.warn("No object to export",this),null;Ca.beforeExport.invoke({exporter:this});const i=await this.export(this.objectToExport).finally(()=>{Ca.afterExport.invoke({exporter:this})});return i?(yi&&console.log("USDZ generation done. Downloading as "+e),this.openInQuickLook(i,e),i):(console.error("USDZ generation failed. Please report a bug",this),null)}async export(e){if(!e)return console.warn("No object to export"),null;const i=this._currentExportTasks.get(e);if(i)return i;const n=this.internalExport(e);return n instanceof Promise?(this._currentExportTasks.set(e,n),n.then(o=>(this._currentExportTasks.delete(e),o)).catch(o=>(this._currentExportTasks.delete(e),console.error("Error during USDZ export ‚Äì please report a bug!",o),null))):n}async internalExport(e){Ie.start("export-usdz",{onProgress:M=>{this.dispatchEvent(new CustomEvent("export-progress",{detail:{progress:M}}))}}),Ie.report("export-usdz",{message:"Starting export",totalSteps:40,currentStep:0}),Ie.report("export-usdz",{message:"Load progressive textures",autoStep:5}),Ie.start("export-usdz-textures","export-usdz");const i=I.getComponentsInChildren(e,Kn);for(const M of i)M&&M.enabled&&M.updateSprite(!0);const n=I.getComponentsInChildren(e,tt),o=new Array;let r=0;for(const M of n){for(const A of M.sharedMeshes)if(A){let G=0;const V={exporter:this,type:"mesh",object:M.gameObject,mesh:A};if(Ca.beforeLODExport.invoke(V),V.overrideLevel!==void 0)if(V.overrideLevel===-1){yi&&console.warn("Skipping LOD export for mesh due to overrideLevel -1",M.gameObject,A);continue}else V.overrideLevel>=0&&(G=V.overrideLevel,yi&&console.log("Overriding LOD level for mesh export to level "+G+" "+A.name));const U=Tt.assignMeshLOD(A,G);U instanceof Promise&&o.push(new Promise(($,Y)=>{U.then(()=>{r++,Ie.report("export-usdz-textures",{message:"Loaded progressive mesh",currentStep:r,totalSteps:o.length}),$()}).catch(B=>Y(B))}))}for(const A of M.sharedMaterials)if(A){let G=0;const V={exporter:this,type:"texture",object:M.gameObject,material:A};if(Ca.beforeLODExport.invoke(V),V.overrideLevel!==void 0)if(V.overrideLevel===-1){yi&&console.warn("Skipping LOD assignment due to overrideLevel -1",M.gameObject,A);continue}else V.overrideLevel>=0&&(G=V.overrideLevel,yi&&console.log("Overriding LOD level for texture export to level "+G+" "+A.name));const U=Tt.assignTextureLOD(A,G);U instanceof Promise&&o.push(new Promise(($,Y)=>{U.then(()=>{r++,Ie.report("export-usdz-textures",{message:"Loaded progressive texture",currentStep:r,totalSteps:o.length}),$()}).catch(B=>Y(B))}))}}yi&&at("Progressive Loading: "+o.length),await Promise.all(o),yi&&at("Progressive Loading: done"),Ie.end("export-usdz-textures");const l=un.Global.Mask;un.Global.Set(ms.AR);const c=new GD,h=new Pv(this.quickLookCompatible);let d;const u=[];this.interactive&&(u.push(new rR),u.push(new pd),globalThis.true&&I.getComponentsInChildren(e,De).length>0&&(this.physics?(d=new aR,u.push(d)):X()&&console.warn("USDZExporter: Physics export is disabled, but there are active Rigidbody components in the scene. They will not be exported.")),u.push(new kv),u.push(new pR));const f=[h,...u,...this.extensions],p={self:this,exporter:c,extensions:f,object:e};Ie.report("export-usdz","Invoking before-export"),this.dispatchEvent(new CustomEvent("before-export",{detail:p})),this.applyWebARSessionRoot(),this._previousTimeScale=this.context.time.timeScale,this.context.time.timeScale=0,Ie.report("export-usdz","auto export animations and audio sources");const b=new Array;this.autoExportAnimations&&b.push(...O3(e,h)),f.find(M=>M.extensionName==="Audio")&&this.autoExportAudioSources&&b.push(...k3(e)),c.debug=yi,c.pruneUnusedNodes=!M3;const v=Hl.instance.objs.map(M=>M.batchedMesh);c.keepObject=M=>{let A=!0;const G=I.getComponent(M,tt);return G&&!G.enabled&&(A=!1),A&&v.includes(M)&&(A=!1),A&&I.getComponentInParent(M,qn)&&(A=!1),A&&I.getComponentInParent(M,Kr)&&(A=!1),yi&&!A&&console.log("USDZExporter: Discarding object",M),A},c.beforeWritingDocument=()=>{if(X()&&h&&d){const M=h.animatedRoots;for(const A of M){const G=I.getComponentsInChildren(A,De).filter(U=>U.enabled),V=I.getComponents(A,no).filter(U=>U.enabled&&!U.isTrigger);(G.length>0||V.length>0)&&console.error("An animated object has physics components in its child hierarchy. This can lead to undefined behaviour due to a bug in Apple's QuickLook (FB15925487). Remove the physics components from child objects or verify that you get the expected results.",A)}}};const S=new Array;this.objectToExport&&this.quickLookCompatible&&this.interactive&&this.objectToExport.traverse(M=>{M.visible||S.push(M)});const C=f.find(M=>M.extensionName==="Behaviour");this.interactive&&C&&S.length>0&&C.addBehavior(E3(S));let P=!0;this.quickLookCompatible&&!this.interactive&&(P=!1),this.anchoringType!=="plane"&&this.anchoringType!=="none"&&this.anchoringType!=="image"&&this.anchoringType!=="face"&&(this.anchoringType="plane"),this.planeAnchoringAlignment!=="horizontal"&&this.planeAnchoringAlignment!=="vertical"&&this.planeAnchoringAlignment!=="any"&&(this.planeAnchoringAlignment="horizontal"),Ie.report("export-usdz","Invoking exporter.parse");const E=await c.parse(this.objectToExport,{ar:{anchoring:{type:this.anchoringType},planeAnchoring:{alignment:this.planeAnchoringAlignment}},extensions:f,quickLookCompatible:this.quickLookCompatible,maxTextureSize:this.maxTextureSize,exportInvisible:P}),D=new Blob([E],{type:"model/vnd.usdz+zip"});this.revertWebARSessionRoot(),this.context.time.timeScale=this._previousTimeScale,Ie.report("export-usdz","Invoking after-export"),this.dispatchEvent(new CustomEvent("after-export",{detail:p}));for(const M of b)I.destroy(M);return un.Global.Set(l),Ie.end("export-usdz"),D}openInQuickLook(e,i){const n=e instanceof Blob?URL.createObjectURL(e):e,o=this.buildQuicklookOverlay();yi&&console.log("QuickLook Overlay",o);const r=o.callToAction?encodeURIComponent(o.callToAction):"",l=o.checkoutTitle?encodeURIComponent(o.checkoutTitle):"",c=o.checkoutSubtitle?encodeURIComponent(o.checkoutSubtitle):"";this.link.href=n+`#callToAction=${r}&checkoutTitle=${l}&checkoutSubtitle=${c}&callToActionURL=${o.callToActionURL}`,this.lastCallback||(this.lastCallback=this.quicklookCallback.bind(this),this.link.addEventListener("message",this.lastCallback)),this.link.download=i+".usdz",this.link.click()}download(e,i){Ca.save(e,i)}static save(e,i){const n=document.createElement("a");n.style.display="none",document.body.appendChild(n),typeof e=="string"?n.href=e:n.href=URL.createObjectURL(e),n.download=i,n.click(),n.remove()}quicklookCallback(e){if((e==null?void 0:e.data)=="_apple_ar_quicklook_button_tapped"){yi&&qe("Quicklook closed via call to action button");var i=new CustomEvent("quicklook-button-tapped",{detail:this});if(this.dispatchEvent(i),!i.defaultPrevented){const n=new URLSearchParams(this.link.href);if(n){const o=n.get("callToActionURL");yi&&at("Quicklook url: "+o),o&&(Dr()?globalThis.open(o,"_blank"):console.warn("Quicklook closed: custom redirects require a Needle Engine Pro license: https://needle.tools/pricing",o))}}}}buildQuicklookOverlay(){var n,o,r,l,c,h;const e={};return this.customBranding&&Object.assign(e,this.customBranding),Dr()||(console.log("Custom Quicklook banner text requires pro license: https://needle.tools/pricing"),e.callToAction="Close",e.checkoutTitle="üåµ Made with Needle",e.checkoutSubtitle="_"),(((n=e.callToAction)==null?void 0:n.length)||((o=e.checkoutTitle)==null?void 0:o.length)||((r=e.checkoutSubtitle)==null?void 0:r.length))&&((l=e.callToAction)!=null&&l.length||(e.callToAction="\0"),(c=e.checkoutTitle)!=null&&c.length||(e.checkoutTitle="\0"),(h=e.checkoutSubtitle)!=null&&h.length||(e.checkoutSubtitle="\0")),this.dispatchEvent(new CustomEvent("quicklook-overlay",{detail:e})),e}getARScaleAndTarget(){if(!this.objectToExport)return{scale:1,_invertForward:!1,target:this.gameObject,sessionRoot:null};const e=I.findObjectOfType(pt);let i=I.getComponentInParent(this.objectToExport,No);i||(i=I.getComponentInChildren(this.objectToExport,No));let n=1,o=!1;const r=this.objectToExport;return e?n=e.arScale:i&&(n=i.arScale,o=i.invertForward),{scale:1/n,_invertForward:o,target:r,sessionRoot:(i==null?void 0:i.gameObject)??null}}applyWebARSessionRoot(){if(!this.objectToExport)return;const{scale:e,_invertForward:i,target:n,sessionRoot:o}=this.getARScaleAndTarget(),r=o==null?void 0:o.matrixWorld.clone().invert();this._rootSessionRootWasAppliedTo=n,this._rootPositionBeforeExport.copy(n.position),this._rootRotationBeforeExport.copy(n.quaternion),this._rootScaleBeforeExport.copy(n.scale),n.scale.multiplyScalar(e),i&&n.quaternion.multiply(Ca.invertForwardQuaternion),n.updateMatrix(),n.updateMatrixWorld(!0),o&&r&&n.matrix.premultiply(r)}revertWebARSessionRoot(){if(!this.objectToExport||!this._rootSessionRootWasAppliedTo)return;const e=this._rootSessionRootWasAppliedTo;e.position.copy(this._rootPositionBeforeExport),e.quaternion.copy(this._rootRotationBeforeExport),e.scale.copy(this._rootScaleBeforeExport),e.updateMatrix(),e.updateMatrixWorld(!0),this._rootSessionRootWasAppliedTo=null}createQuicklookButton(){const i=za.getOrCreate().createQuicklookButton();return i.parentNode||this.context.menu.appendChild(i),i}};let Ge=Ca;a(Ge,"beforeExport",new je),a(Ge,"afterExport",new je),a(Ge,"beforeLODExport",new je),a(Ge,"invertForwardMatrix",new xe().makeRotationY(Math.PI)),a(Ge,"invertForwardQuaternion",new re().setFromEuler(new Ht(0,Math.PI,0)));Li([g(z)],Ge.prototype,"objectToExport",void 0);Li([g()],Ge.prototype,"autoExportAnimations",void 0);Li([g()],Ge.prototype,"autoExportAudioSources",void 0);Li([g()],Ge.prototype,"exportFileName",void 0);Li([g(URL)],Ge.prototype,"customUsdzFile",void 0);Li([g(bd)],Ge.prototype,"customBranding",void 0);Li([g()],Ge.prototype,"anchoringType",void 0);Li([g()],Ge.prototype,"maxTextureSize",void 0);Li([g()],Ge.prototype,"planeAnchoringAlignment",void 0);Li([g()],Ge.prototype,"interactive",void 0);Li([g()],Ge.prototype,"physics",void 0);Li([g()],Ge.prototype,"allowCreateQuicklookButton",void 0);Li([g()],Ge.prototype,"quickLookCompatible",void 0);var Mv=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},h0;(function(s){s[s.Linear=1]="Linear",s[s.Exponential=2]="Exponential",s[s.ExponentialSquared=3]="ExponentialSquared"})(h0||(h0={}));class zf extends W{constructor(){super(...arguments);a(this,"_fog")}get fog(){return this._fog||(this._fog=new qC(0,0,50)),this._fog}get mode(){return h0.Linear}set near(e){this.fog.near=e}get near(){return this.fog.near}set far(e){this.fog.far=e}get far(){return this.fog.far}set color(e){this.fog.color.copy(e)}get color(){return this.fog.color}onEnable(){this.scene.fog=this.fog}onDisable(){this.scene.fog===this._fog&&(this.scene.fog=null)}}Mv([g()],zf.prototype,"near",null);Mv([g()],zf.prototype,"far",null);Mv([g(Se)],zf.prototype,"color",null);var Av=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class _d extends W{constructor(){super(...arguments);a(this,"objectBounds",!1);a(this,"color");a(this,"isGizmo",!0);a(this,"_gizmoObject",null);a(this,"_boxHelper",null)}onEnable(){this.isGizmo&&!Of||(this._gizmoObject||(this.objectBounds?this._gizmoObject=new mk(this.gameObject,this.color??16776960):(this.objectBounds=!1,this._gizmoObject=Z0(this.color??16776960))),this.objectBounds?(this.scene.add(this._gizmoObject),this._boxHelper=this._gizmoObject,this.startCoroutine(this.syncObjectBounds(),ge.OnBeforeRender)):this.gameObject.add(this._gizmoObject))}onDisable(){this._gizmoObject&&this.gameObject.remove(this._gizmoObject)}*syncObjectBounds(){var e;for(;this._boxHelper;)(e=this._boxHelper)==null||e.update(),yield}}Av([g()],_d.prototype,"objectBounds",void 0);Av([g(Se)],_d.prototype,"color",void 0);Av([g()],_d.prototype,"isGizmo",void 0);var Iv=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class $f extends W{constructor(){super(...arguments);a(this,"isGizmo",!1);a(this,"color0");a(this,"color1");a(this,"gridHelper");a(this,"size");a(this,"divisions");a(this,"offset")}onEnable(){if(this.isGizmo&&!Of)return;const e=this.size,i=this.divisions;this.gridHelper||(this.gridHelper=new WC(e,i,this.color0??new Se(.4,.4,.4),this.color1??new Se(.6,.6,.6)),this.offset!==void 0&&(this.gridHelper.position.y+=this.offset)),this.gridHelper&&this.gameObject.add(this.gridHelper)}onDisable(){this.gridHelper&&(this.gameObject.remove(this.gridHelper),this.gridHelper=null)}}Iv([g()],$f.prototype,"isGizmo",void 0);Iv([g(Se)],$f.prototype,"color0",void 0);Iv([g(Se)],$f.prototype,"color1",void 0);var Lv=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Dv extends W{constructor(){super(...arguments);a(this,"connectedBody");a(this,"_rigidBody",null)}get rigidBody(){return this._rigidBody}onEnable(){this._rigidBody||(this._rigidBody=this.gameObject.getComponent(De)),this.rigidBody&&this.connectedBody&&this.startCoroutine(this.create())}*create(){yield,this.rigidBody&&this.connectedBody&&this.activeAndEnabled&&this.createJoint(this.rigidBody,this.connectedBody)}}Lv([g(De)],Dv.prototype,"connectedBody",void 0);class mR extends Dv{createJoint(t,e){var i;(i=this.context.physics.engine)==null||i.addFixedJoint(t,e)}}class sy extends Dv{constructor(){super(...arguments);a(this,"anchor");a(this,"axis")}createJoint(e,i){var n;this.axis&&this.anchor&&((n=this.context.physics.engine)==null||n.addHingeJoint(e,i,this.anchor,this.axis))}}Lv([g(R)],sy.prototype,"anchor",void 0);Lv([g(R)],sy.prototype,"axis",void 0);var Jn=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};function Jc(s){return s*Math.PI/180}const cC=300,ua=k("debuglights");var vr;(function(s){s[s.Spot=0]="Spot",s[s.Directional=1]="Directional",s[s.Point=2]="Point",s[s.Area=3]="Area",s[s.Rectangle=3]="Rectangle",s[s.Disc=4]="Disc"})(vr||(vr={}));var Ym;(function(s){s[s.Realtime=4]="Realtime",s[s.Baked=2]="Baked",s[s.Mixed=1]="Mixed"})(Ym||(Ym={}));var Nu;(function(s){s[s.None=0]="None",s[s.Hard=1]="Hard",s[s.Soft=2]="Soft"})(Nu||(Nu={}));class Di extends W{constructor(){super(...arguments);a(this,"type",0);a(this,"_range",1);a(this,"_spotAngle",30);a(this,"_innerSpotAngle",10);a(this,"_color",new Se(16777215));a(this,"_shadowNearPlane",.1);a(this,"_shadowBias",0);a(this,"_shadowNormalBias",0);a(this,"_overrideShadowBiasSettings",!1);a(this,"_shadows",1);a(this,"lightmapBakeType",Ym.Realtime);a(this,"_intensity",-1);a(this,"_shadowDistance");a(this,"shadowWidth");a(this,"shadowHeight");a(this,"_shadowResolution");a(this,"light")}get range(){return this._range}set range(e){this._range=e,this.light&&(this.light.type==="SpotLight"||this.light.type==="PointLight")&&"distance"in this.light&&(this.light.distance=e)}get spotAngle(){return this._spotAngle}set spotAngle(e){this._spotAngle=e,this.light&&this.light.type==="SpotLight"&&"angle"in this.light&&(this.light.angle=Jc(e/2))}get innerSpotAngle(){return this._innerSpotAngle}set innerSpotAngle(e){if(this._innerSpotAngle=e,this.light&&this.light.type==="SpotLight"&&"penumbra"in this.light){const i=this.spotAngle,o=1-Jc(e/2)/Jc(i/2);this.light.penumbra=o}}set color(e){this._color=e,this.light!==void 0&&(this.light.color=e)}get color(){return this.light?this.light.color:this._color}set shadowNearPlane(e){var i,n;if(e!==this._shadowNearPlane&&(this._shadowNearPlane=e,((n=(i=this.light)==null?void 0:i.shadow)==null?void 0:n.camera)!==void 0)){const o=this.light.shadow.camera;o.near=e}}get shadowNearPlane(){return this._shadowNearPlane}set shadowBias(e){var i,n;e!==this._shadowBias&&(this._shadowBias=e,((n=(i=this.light)==null?void 0:i.shadow)==null?void 0:n.bias)!==void 0&&(this.light.shadow.bias=e,this.light.shadow.needsUpdate=!0))}get shadowBias(){return this._shadowBias}set shadowNormalBias(e){var i,n;e!==this._shadowNormalBias&&(this._shadowNormalBias=e,((n=(i=this.light)==null?void 0:i.shadow)==null?void 0:n.normalBias)!==void 0&&(this.light.shadow.normalBias=e,this.light.shadow.needsUpdate=!0))}get shadowNormalBias(){return this._shadowNormalBias}set shadows(e){this._shadows=e,this.light&&(this.light.castShadow=e!==Nu.None,this.updateShadowSoftHard())}get shadows(){return this._shadows}set intensity(e){this._intensity=e,this.light&&(this.light.intensity=e),ua&&console.log("Set light intensity to "+this._intensity,e,this)}get intensity(){return this._intensity}get shadowDistance(){const e=this.light;return e!=null&&e.shadow?e.shadow.camera.far:-1}set shadowDistance(e){this._shadowDistance=e;const i=this.light;if(i!=null&&i.shadow){const n=i.shadow.camera;n.far=e,n.updateProjectionMatrix()}}get shadowResolution(){const e=this.light;return e!=null&&e.shadow?e.shadow.mapSize.x:-1}set shadowResolution(e){if(e===this._shadowResolution)return;this._shadowResolution=e;const i=this.light;i!=null&&i.shadow&&(i.shadow.mapSize.set(e,e),i.shadow.needsUpdate=!0)}get isBaked(){return this.lightmapBakeType===Ym.Baked}get selfIsLight(){if(this.gameObject.isLight===!0)return!0;switch(this.gameObject.type){case"SpotLight":case"PointLight":case"DirectionalLight":return!0}return!1}getWorldPosition(e){return this.light?this.type===vr.Directional?this.light.getWorldPosition(e).multiplyScalar(1):this.light.getWorldPosition(e):e}awake(){this.color=new Se(this.color??16777215),ua&&console.log(this.name,this)}onEnable(){ua&&console.log("ENABLE LIGHT",this.name),this.createLight(),!this.isBaked&&(this.light&&(this.light.visible=!0,this.light.intensity=this._intensity,ua&&console.log("Set light intensity to "+this.light.intensity,this.name),this.selfIsLight||this.light.parent!==this.gameObject&&this.gameObject.add(this.light)),this.type===vr.Directional&&this.startCoroutine(this.updateMainLightRoutine(),ge.LateUpdate))}onDisable(){ua&&console.log("DISABLE LIGHT",this.name),this.light&&(this.selfIsLight?this.light.intensity=0:this.light.visible=!1)}createLight(){const e=this.selfIsLight;if(e&&!this.light)switch(this.light=this.gameObject,this.light.name=this.name,this._intensity=this.light.intensity,this.type){case vr.Directional:this.setDirectionalLight(this.light);break}else if(!this.light)switch(this.type){case vr.Directional:const i=new r_(this.color,this.intensity*Math.PI);if(i.position.set(0,0,-cC*.5).applyQuaternion(this.gameObject.quaternion),this.gameObject.add(i.target),Qh(i.target,0,0,0),this.light=i,this.gameObject.position.set(0,0,0),this.gameObject.rotation.set(0,0,0),ua){const l=new yk(this.light,.2,this.color);this.context.scene.add(l)}break;case vr.Spot:const n=new gk(this.color,this.intensity*Math.PI,this.range,Jc(this.spotAngle/2),1-Jc(this.innerSpotAngle/2)/Jc(this.spotAngle/2),2);n.position.set(0,0,0),n.rotation.set(0,0,0),this.light=n;const o=n.target;n.add(o),o.position.set(0,0,this.range),o.rotation.set(0,0,0);break;case vr.Point:const r=new R0(this.color,this.intensity*Math.PI,this.range);this.light=r;break}if(this.light){if(this._intensity>=0?this.light.intensity=this._intensity:this._intensity=this.light.intensity,this.shadows!==Nu.None?this.light.castShadow=!0:this.light.castShadow=!1,this.light.shadow){this._shadowResolution!==void 0&&this._shadowResolution>4?(this.light.shadow.mapSize.width=this._shadowResolution,this.light.shadow.mapSize.height=this._shadowResolution):(this.light.shadow.mapSize.width=2048,this.light.shadow.mapSize.height=2048),ua&&console.log("Override shadow bias?",this._overrideShadowBiasSettings,this.shadowBias,this.shadowNormalBias),this.light.shadow.bias=this.shadowBias,this.light.shadow.normalBias=this.shadowNormalBias,this.updateShadowSoftHard();const i=this.light.shadow.camera;if(i.near=this.shadowNearPlane,this._shadowDistance!==void 0&&typeof this._shadowDistance=="number"?i.far=this._shadowDistance:i.far=cC*Math.abs(this.gameObject.scale.z),this.gameObject.scale.set(1,1,1),this.shadowWidth!==void 0)i.left=-this.shadowWidth/2,i.right=this.shadowWidth/2;else{const n=this.gameObject.scale.x;i.left*=n,i.right*=n}if(this.shadowHeight!==void 0)i.top=this.shadowHeight/2,i.bottom=-this.shadowHeight/2;else{const n=this.gameObject.scale.y;i.top*=n,i.bottom*=n}this.light.shadow.needsUpdate=!0,ua&&this.context.scene.add(new bk(i))}this.isBaked?this.light.removeFromParent():e||this.gameObject.add(this.light)}}*updateMainLightRoutine(){for(;;){this.type===vr.Directional&&((!this.context.mainLight||this.intensity>this.context.mainLight.intensity)&&(this.context.mainLight=this),yield);break}}updateShadowSoftHard(){this.light&&this.light.shadow&&(this.shadows===Nu.Soft||(this.light.shadow.radius=1,this.light.shadow.blurSamples=1))}setDirectionalLight(e){e.add(e.target),e.target.position.set(0,0,-1)}}a(Di,"allowChangingRendererShadowMapType",!0);Jn([g()],Di.prototype,"type",void 0);Jn([g()],Di.prototype,"range",null);Jn([g()],Di.prototype,"spotAngle",null);Jn([g()],Di.prototype,"innerSpotAngle",null);Jn([g(Se)],Di.prototype,"color",null);Jn([g()],Di.prototype,"shadowNearPlane",null);Jn([g()],Di.prototype,"shadowBias",null);Jn([g()],Di.prototype,"shadowNormalBias",null);Jn([g()],Di.prototype,"shadows",null);Jn([g()],Di.prototype,"lightmapBakeType",void 0);Jn([g()],Di.prototype,"intensity",null);Jn([g()],Di.prototype,"shadowDistance",null);Jn([g()],Di.prototype,"shadowResolution",null);new R(0,0,0);var Vf=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Vb=k("debuglods"),A3=k("nolods");var d0;(function(s){s[s.None=0]="None",s[s.CrossFade=1]="CrossFade",s[s.SpeedTree=2]="SpeedTree"})(d0||(d0={}));class Wf{constructor(){a(this,"screenRelativeTransitionHeight");a(this,"distance");a(this,"renderers")}}Vf([g()],Wf.prototype,"screenRelativeTransitionHeight",void 0);Vf([g()],Wf.prototype,"distance",void 0);Vf([g(tt)],Wf.prototype,"renderers",void 0);class I3{constructor(t){a(this,"model");this.model=t}get renderers(){return this.model.renderers}}class oy extends W{constructor(){super(...arguments);a(this,"fadeMode",d0.None);a(this,"localReferencePoint");a(this,"lodCount",0);a(this,"size",0);a(this,"animateCrossFading",!1);a(this,"lodModels");a(this,"_lods",[]);a(this,"_settings",[]);a(this,"_lodsHandler");a(this,"_distanceFactor",1)}start(){if(Vb&&console.log("LODGROUP",this.name,this.lodModels,this),!A3&&!this._lodsHandler&&this.gameObject&&this.lodModels&&Array.isArray(this.lodModels)){const e=[];for(const n of this.lodModels){const o=new I3(n);this._lods.push(o);for(const r of o.renderers)e.includes(r)||e.push(r)}this._lodsHandler=new Array;for(let n=0;n<e.length;n++){const o=new _k;this._lodsHandler.push(o),this.gameObject.add(o)}const i=new z;i.name="Cull "+this.name;for(let n=0;n<e.length;n++){const o=e[n],r=this._lodsHandler[n],l=o.gameObject;Vb&&console.log(n,l.name);for(const c of this._lods){const h=c.model.distance;let d=null;if(c.renderers.includes(o)?d=l:d=i,d.type==="Group"){console.warn(`LODGroup ${this.name}: Group or MultiMaterial object's are not supported as LOD object: ${d.name}`);continue}Vb&&console.log("LEVEL",d.name,h),r.autoUpdate=!1,this.onAddLodLevel(r,d,c.model.distance)}}}}onAfterRender(){if(!this.gameObject||!this._lodsHandler)return;const e=this.context.mainCamera;if(e)for(const i of this._lodsHandler){i.update(e);const n=i.getCurrentLevel(),o=i.levels[n];i.layers.mask=o.object.layers.mask}}onAddLodLevel(e,i,n){if(i===this.gameObject){console.warn("LODGroup component must be on parent object and not mesh directly at the moment",i.name,i);return}e.addLevel(i,n*this._distanceFactor,.01);const o={lod:e,levelIndex:e.levels.length-1,distance:n};this._settings.push(o)}distanceFactor(e){if(e!==this._distanceFactor){this._distanceFactor=e;for(const i of this._settings){const n=i.lod.levels[i.levelIndex];n.distance=i.distance*e}}}}Vf([g(R)],oy.prototype,"localReferencePoint",void 0);Vf([g(Wf)],oy.prototype,"lodModels",void 0);var gR=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Up=k("debugnestedgltf");class ry extends W{constructor(){super(...arguments);a(this,"filePath");a(this,"loaded",new je);a(this,"loadAssetInParent",!0);a(this,"_isLoadingOrDoneLoading",!1)}listenToProgress(e){var i;(i=this.filePath)==null||i.beginListenDownload(e)}preload(){var e;return((e=this.filePath)==null?void 0:e.preload())||null}async start(){var i,n,o,r,l;if(this._isLoadingOrDoneLoading)return;Up&&console.log(this,this.guid);const e=this.gameObject.parent;if(e&&this.filePath){this._isLoadingOrDoneLoading=!0;const c=new er;c.idProvider=new Ki(this.hash(this.guid)),c.parent=this.loadAssetInParent!==!1?e:this.gameObject,this.gameObject.updateMatrix();const h=this.gameObject.matrix;Up&&console.log("Load nested:",((i=this.filePath)==null?void 0:i.url)??this.filePath,this.gameObject.position);const d=await((o=(n=this.filePath)==null?void 0:n.instantiate)==null?void 0:o.call(this.filePath,c));Up&&console.log("Nested loaded:",((r=this.filePath)==null?void 0:r.url)??this.filePath,d),d&&this.loadAssetInParent!==!1&&(d.matrixAutoUpdate=!1,d.matrix.identity(),d.applyMatrix4(h),d.matrixAutoUpdate=!0,d.layers.disableAll(),d.layers.set(this.layer),this.loaded.invoke({component:this,instance:d,asset:this.filePath})),Up&&console.log("Nested loading done:",((l=this.filePath)==null?void 0:l.url)??this.filePath,d)}}onDestroy(){var e;(e=this.filePath)==null||e.unload()}hash(e){let i=0;for(let n=0;n<e.length;n++)i=e.charCodeAt(n)+((i<<5)-i);return i}}gR([g(we)],ry.prototype,"filePath",void 0);gR([g(je)],ry.prototype,"loaded",void 0);var jv=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const L3=k("debugnet");class qa extends W{constructor(){super(...arguments);a(this,"url",null);a(this,"urlParameterName",null);a(this,"localhost",null)}awake(){L3&&console.log(this),this.context.connection.registerProvider(this)}getWebsocketUrl(){let e=this.url?qa.GetUrl(this.url,this.localhost):null;if(this.urlParameterName){const r=k(this.urlParameterName);r&&typeof r=="string"&&(e=r)}if(!e)return null;const n=new RegExp("(((https?)|(?<socket_prefix>wss?))://)?(www.)?(?<url>.+)","gm").exec(e);return n!=null&&n.groups?(n==null?void 0:n.groups.socket_prefix)?e:"wss://"+(n==null?void 0:n.groups.url):null}static GetUrl(e,i){let n=e;const o=qa.IsLocalNetwork()&&i;if(o&&(n=i),e!=null&&e.startsWith("/")){const r=o?n:window.location.origin;r!=null&&r.endsWith("/")&&e.startsWith("/")&&(e=e.substring(1)),n=r+e}return n}static IsLocalNetwork(e=window.location.hostname){return _s(e)}}jv([g()],qa.prototype,"url",void 0);jv([g()],qa.prototype,"urlParameterName",void 0);jv([g()],qa.prototype,"localhost",void 0);var ay=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class vd extends W{constructor(){super(...arguments);a(this,"referenceSpace");a(this,"from");a(this,"affectPosition",!1);a(this,"affectRotation",!1);a(this,"alignLookDirection",!1);a(this,"levelLookDirection",!1);a(this,"levelPosition",!1);a(this,"positionOffset",new R(0,0,0));a(this,"rotationOffset",new R(0,0,0));a(this,"offset",new R(0,0,0))}update(){if(!this.from)return;var e=ve(this.from),i=Qe(this.from);this.offset.copy(this.positionOffset);const n=this.offset.length();if(this.referenceSpace&&this.offset.transformDirection(this.referenceSpace.matrixWorld).multiplyScalar(n),e.add(this.offset),this.levelPosition&&this.referenceSpace){const c=new lc(this.gameObject.up,0),h=ve(this.referenceSpace);c.setFromNormalAndCoplanarPoint(this.gameObject.up,h);const d=new R(0,0,0);c.projectPoint(e,d),e.copy(d)}this.affectPosition&&Oi(this.gameObject,e);const o=new Ht(this.rotationOffset.x,this.rotationOffset.y,this.rotationOffset.z),r=new re().setFromEuler(o);this.affectRotation&&Yo(this.gameObject,i.multiply(r));const l=new R;this.from.getWorldDirection(l).multiplyScalar(50),this.levelLookDirection&&(l.y=0),this.alignLookDirection&&this.gameObject.lookAt(l)}}ay([g(I)],vd.prototype,"referenceSpace",void 0);ay([g(I)],vd.prototype,"from",void 0);ay([g(R)],vd.prototype,"positionOffset",void 0);ay([g(R)],vd.prototype,"rotationOffset",void 0);const yR=Math.sqrt(5),D3=(yR-1)/4,bi=(5-yR)/20,Np=s=>Math.floor(s)|0,zp=new Float64Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]);function j3(s=Math.random){const t=F3(s),e=new Float64Array(t).map(r=>zp[r%32*4]),i=new Float64Array(t).map(r=>zp[r%32*4+1]),n=new Float64Array(t).map(r=>zp[r%32*4+2]),o=new Float64Array(t).map(r=>zp[r%32*4+3]);return function(l,c,h,d){let u,f,p,b,x;const v=(l+c+h+d)*D3,S=Np(l+v),C=Np(c+v),P=Np(h+v),E=Np(d+v),D=(S+C+P+E)*bi,M=S-D,A=C-D,G=P-D,V=E-D,U=l-M,$=c-A,Y=h-G,B=d-V;let N=0,Z=0,ae=0,ie=0;U>$?N++:Z++,U>Y?N++:ae++,U>B?N++:ie++,$>Y?Z++:ae++,$>B?Z++:ie++,Y>B?ae++:ie++;const J=N>=3?1:0,ye=Z>=3?1:0,Fe=ae>=3?1:0,Ze=ie>=3?1:0,Ot=N>=2?1:0,St=Z>=2?1:0,ui=ae>=2?1:0,fi=ie>=2?1:0,pi=N>=1?1:0,ns=Z>=1?1:0,Ts=ae>=1?1:0,Ue=ie>=1?1:0,lo=U-J+bi,na=$-ye+bi,Lc=Y-Fe+bi,ji=B-Ze+bi,mi=U-Ot+2*bi,Dc=$-St+2*bi,ss=Y-ui+2*bi,jc=B-fi+2*bi,gl=U-pi+3*bi,Id=$-ns+3*bi,yl=Y-Ts+3*bi,sa=B-Ue+3*bi,Ld=U-1+4*bi,Fc=$-1+4*bi,Bc=Y-1+4*bi,Dd=B-1+4*bi,os=S&255,rr=C&255,bl=P&255,ar=E&255;let oa=.6-U*U-$*$-Y*Y-B*B;if(oa<0)u=0;else{const Je=os+t[rr+t[bl+t[ar]]];oa*=oa,u=oa*oa*(e[Je]*U+i[Je]*$+n[Je]*Y+o[Je]*B)}let Rs=.6-lo*lo-na*na-Lc*Lc-ji*ji;if(Rs<0)f=0;else{const Je=os+J+t[rr+ye+t[bl+Fe+t[ar+Ze]]];Rs*=Rs,f=Rs*Rs*(e[Je]*lo+i[Je]*na+n[Je]*Lc+o[Je]*ji)}let lr=.6-mi*mi-Dc*Dc-ss*ss-jc*jc;if(lr<0)p=0;else{const Je=os+Ot+t[rr+St+t[bl+ui+t[ar+fi]]];lr*=lr,p=lr*lr*(e[Je]*mi+i[Je]*Dc+n[Je]*ss+o[Je]*jc)}let Os=.6-gl*gl-Id*Id-yl*yl-sa*sa;if(Os<0)b=0;else{const Je=os+pi+t[rr+ns+t[bl+Ts+t[ar+Ue]]];Os*=Os,b=Os*Os*(e[Je]*gl+i[Je]*Id+n[Je]*yl+o[Je]*sa)}let cr=.6-Ld*Ld-Fc*Fc-Bc*Bc-Dd*Dd;if(cr<0)x=0;else{const Je=os+1+t[rr+1+t[bl+1+t[ar+1]]];cr*=cr,x=cr*cr*(e[Je]*Ld+i[Je]*Fc+n[Je]*Bc+o[Je]*Dd)}return 27*(u+f+p+b+x)}}function F3(s){const e=new Uint8Array(512);for(let i=0;i<512/2;i++)e[i]=i;for(let i=0;i<512/2-1;i++){const n=i+~~(s()*(256-i)),o=e[i];e[i]=e[n],e[n]=o}for(let i=256;i<512;i++)e[i]=e[i-256];return e}var il=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Vn{constructor(t=0,e=0){a(this,"time",0);a(this,"value",0);a(this,"inTangent",1/0);a(this,"inWeight");a(this,"outTangent",1/0);a(this,"outWeight");a(this,"weightedMode");this.time=t,this.value=e}}il([g()],Vn.prototype,"time",void 0);il([g()],Vn.prototype,"value",void 0);il([g()],Vn.prototype,"inTangent",void 0);il([g()],Vn.prototype,"inWeight",void 0);il([g()],Vn.prototype,"outTangent",void 0);il([g()],Vn.prototype,"outWeight",void 0);il([g()],Vn.prototype,"weightedMode",void 0);class zo{constructor(){a(this,"keys",[])}static linearFromTo(t,e,i){const n=new zo,o=new Vn;o.time=0,o.value=t;const r=new Vn;return r.time=i,r.value=e,n.keys.push(o,r),n}static constant(t){const e=new zo,i=new Vn;return i.time=0,i.value=t,e.keys.push(i),e}clone(){var e;const t=new zo;return t.keys=((e=this.keys)==null?void 0:e.map(i=>{const n=new Vn;return n.time=i.time,n.value=i.value,n.inTangent=i.inTangent,n.inWeight=i.inWeight,n.outTangent=i.outTangent,n.outWeight=i.outWeight,n.weightedMode=i.weightedMode,n}))||[],t}get duration(){return!this.keys||this.keys.length==0?0:this.keys[this.keys.length-1].time}evaluate(t){if(!this.keys||this.keys.length==0)return 0;if(this.keys.length===1)return this.keys[0].value;if(this.keys[0].time>=t)return this.keys[0].value;for(let e=0;e<this.keys.length;e++){const i=this.keys[e];if(i.time<=t)if(e+1<this.keys.length){const o=this.keys[e+1];if(o.time<t)continue;return!isFinite(i.outTangent)||!isFinite(o.inTangent)?i.value:zo.interpolateValue(t,i,o)}else return i.value}return this.keys[this.keys.length-1].value}static interpolateValue(t,e,i){const n=e.time,o=e.value,r=e.outTangent,l=i.time,c=i.value,h=i.inTangent,d=l-n,u=d*d,f=u*d,p=((r+h)*d-2*(c-o))/f,b=(3*(c-o)-(h+2*r)*d)/u,x=r,v=o,S=t-n,C=S*S,P=C*S;return p*P+b*C+x*S+v}}il([g(Vn)],zo.prototype,"keys",void 0);var L=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const $p=k("debugparticles");var Mo;(function(s){s[s.Billboard=0]="Billboard",s[s.Stretch=1]="Stretch",s[s.HorizontalBillboard=2]="HorizontalBillboard",s[s.VerticalBillboard=3]="VerticalBillboard",s[s.Mesh=4]="Mesh"})(Mo||(Mo={}));class xd{constructor(){a(this,"alphaKeys",[]);a(this,"colorKeys",[])}get duration(){return 1}evaluate(t,e){let i,n=0,o=null,r=0;for(let l=0;l<this.alphaKeys.length;l++){const c=this.alphaKeys[l];(c.time<t||!i)&&(i=c,n=l)}for(let l=0;l<this.colorKeys.length;l++){const c=this.colorKeys[l];(c.time<t||!o)&&(o=c,r=l)}if(o)if(r+1<this.colorKeys.length){const c=this.colorKeys[r+1],h=ee.remap(t,o.time,c.time,0,1);e.r=ee.lerp(o.color.r,c.color.r,h),e.g=ee.lerp(o.color.g,c.color.g,h),e.b=ee.lerp(o.color.b,c.color.b,h)}else e.r=o.color.r,e.g=o.color.g,e.b=o.color.b;if(i)if(n+1<this.alphaKeys.length){const c=this.alphaKeys[n+1],h=ee.remap(t,i.time,c.time,0,1);e.alpha=ee.lerp(i.alpha,c.alpha,h)}else e.alpha=i.alpha;return e}}L([g()],xd.prototype,"alphaKeys",void 0);L([g()],xd.prototype,"colorKeys",void 0);var It;(function(s){s[s.Constant=0]="Constant",s[s.Curve=1]="Curve",s[s.TwoCurves=2]="TwoCurves",s[s.TwoConstants=3]="TwoConstants"})(It||(It={}));var xo;(function(s){s[s.Color=0]="Color",s[s.Gradient=1]="Gradient",s[s.TwoColors=2]="TwoColors",s[s.TwoGradients=3]="TwoGradients",s[s.RandomColor=4]="RandomColor"})(xo||(xo={}));var Zs;(function(s){s[s.Local=0]="Local",s[s.World=1]="World",s[s.Custom=2]="Custom"})(Zs||(Zs={}));var rn;(function(s){s[s.Sphere=0]="Sphere",s[s.SphereShell=1]="SphereShell",s[s.Hemisphere=2]="Hemisphere",s[s.HemisphereShell=3]="HemisphereShell",s[s.Cone=4]="Cone",s[s.Box=5]="Box",s[s.Mesh=6]="Mesh",s[s.ConeShell=7]="ConeShell",s[s.ConeVolume=8]="ConeVolume",s[s.ConeVolumeShell=9]="ConeVolumeShell",s[s.Circle=10]="Circle",s[s.CircleEdge=11]="CircleEdge",s[s.SingleSidedEdge=12]="SingleSidedEdge",s[s.MeshRenderer=13]="MeshRenderer",s[s.SkinnedMeshRenderer=14]="SkinnedMeshRenderer",s[s.BoxShell=15]="BoxShell",s[s.BoxEdge=16]="BoxEdge",s[s.Donut=17]="Donut",s[s.Rectangle=18]="Rectangle",s[s.Sprite=19]="Sprite",s[s.SpriteRenderer=20]="SpriteRenderer"})(rn||(rn={}));var Fl;(function(s){s[s.Random=0]="Random",s[s.Loop=1]="Loop",s[s.PingPong=2]="PingPong",s[s.BurstSpread=3]="BurstSpread"})(Fl||(Fl={}));class ce{constructor(){a(this,"mode","Constant");a(this,"constant");a(this,"constantMin");a(this,"constantMax");a(this,"curve");a(this,"curveMin");a(this,"curveMax");a(this,"curveMultiplier")}static constant(t){const e=new ce;return e.setConstant(t),e}static betweenTwoConstants(t,e){const i=new ce;return i.setMinMaxConstant(t,e),i}static curve(t,e=1){const i=new ce;return i.setCurve(t,e),i}setConstant(t){this.mode=It.Constant,this.constant=t}setMinMaxConstant(t,e){this.mode=It.TwoConstants,this.constantMin=t,this.constantMax=e}setCurve(t,e=1){this.mode=It.Curve,this.curve=t,this.curveMultiplier=e}clone(){var e,i,n;const t=new ce;return t.mode=this.mode,t.constant=this.constant,t.constantMin=this.constantMin,t.constantMax=this.constantMax,t.curve=(e=this.curve)==null?void 0:e.clone(),t.curveMin=(i=this.curveMin)==null?void 0:i.clone(),t.curveMax=(n=this.curveMax)==null?void 0:n.clone(),t.curveMultiplier=this.curveMultiplier,t}evaluate(t,e){const i=e===void 0?Math.random():e;switch(this.mode){case It.Constant:case"Constant":return this.constant;case It.Curve:case"Curve":return t=ee.clamp01(t),this.curve.evaluate(t)*this.curveMultiplier;case It.TwoCurves:case"TwoCurves":const n=t*this.curveMin.duration,o=t*this.curveMax.duration;return ee.lerp(this.curveMin.evaluate(n),this.curveMax.evaluate(o),i%1)*this.curveMultiplier;case It.TwoConstants:case"TwoConstants":return ee.lerp(this.constantMin,this.constantMax,i%1);default:this.curveMax.evaluate(t)*this.curveMultiplier;break}return 0}getMax(){switch(this.mode){case It.Constant:case"Constant":return this.constant;case It.Curve:case"Curve":return this.getMaxFromCurve(this.curve)*this.curveMultiplier;case It.TwoCurves:case"TwoCurves":return Math.max(this.getMaxFromCurve(this.curveMin),this.getMaxFromCurve(this.curveMax))*this.curveMultiplier;case It.TwoConstants:case"TwoConstants":return Math.max(this.constantMin,this.constantMax);default:return 0}}getMaxFromCurve(t){if(!t)return 0;let e=Number.MIN_VALUE;for(let i=0;i<t.keys.length;i++){const n=t.keys[i];n.value>e&&(e=n.value)}return e}}L([g()],ce.prototype,"mode",void 0);L([g()],ce.prototype,"constant",void 0);L([g()],ce.prototype,"constantMin",void 0);L([g()],ce.prototype,"constantMax",void 0);L([g(zo)],ce.prototype,"curve",void 0);L([g(zo)],ce.prototype,"curveMin",void 0);L([g(zo)],ce.prototype,"curveMax",void 0);L([g()],ce.prototype,"curveMultiplier",void 0);const Zt=class{constructor(){a(this,"mode",xo.Color);a(this,"color");a(this,"colorMin");a(this,"colorMax");a(this,"gradient");a(this,"gradientMin");a(this,"gradientMax")}static constant(t){const e=new Zt;return e.constant(t),e}static betweenTwoColors(t,e){const i=new Zt;return i.betweenTwoColors(t,e),i}constant(t){return this.mode=xo.Color,this.color=t,this}betweenTwoColors(t,e){return this.mode=xo.TwoColors,this.colorMin=t,this.colorMax=e,this}evaluate(t,e){const i=e===void 0?Math.random():e;switch(this.mode){case xo.Color:case"Color":return this.color;case xo.Gradient:case"Gradient":return this.gradient.evaluate(t,Zt._temp),Zt._temp;case xo.TwoColors:case"TwoColors":return Zt._temp.lerpColors(this.colorMin,this.colorMax,i);case xo.TwoGradients:case"TwoGradients":return this.gradientMin.evaluate(t,Zt._temp),this.gradientMax.evaluate(t,Zt._temp2),Zt._temp.lerp(Zt._temp2,i);case xo.RandomColor:case"RandomColor":const o=Math.random();return this.gradientMin.evaluate(t,Zt._temp),this.gradientMax.evaluate(t,Zt._temp2),Zt._temp.lerp(Zt._temp2,o)}return Zt._temp.set(16777215),Zt._temp.alpha=1,Zt._temp}};let Ri=Zt;a(Ri,"_temp",new Te(0,0,0,1)),a(Ri,"_temp2",new Te(0,0,0,1));L([g()],Ri.prototype,"mode",void 0);L([g(Te)],Ri.prototype,"color",void 0);L([g(Te)],Ri.prototype,"colorMin",void 0);L([g(Te)],Ri.prototype,"colorMax",void 0);L([g(xd)],Ri.prototype,"gradient",void 0);L([g(xd)],Ri.prototype,"gradientMin",void 0);L([g(xd)],Ri.prototype,"gradientMax",void 0);var Km;(function(s){s[s.Hierarchy=0]="Hierarchy",s[s.Local=1]="Local",s[s.Shape=2]="Shape"})(Km||(Km={}));class yn{constructor(){a(this,"cullingMode");a(this,"duration");a(this,"emitterVelocityMode");a(this,"flipRotation");a(this,"gravityModifier");a(this,"gravityModifierMultiplier");a(this,"loop");a(this,"maxParticles");a(this,"playOnAwake");a(this,"prewarm");a(this,"ringBufferLoopRange");a(this,"ringBufferMode");a(this,"scalingMode");a(this,"simulationSpace");a(this,"simulationSpeed");a(this,"startColor");a(this,"startDelay");a(this,"startDelayMultiplier");a(this,"startLifetime");a(this,"startLifetimeMultiplier");a(this,"startRotation");a(this,"startRotationMultiplier");a(this,"startRotation3D");a(this,"startRotationX");a(this,"startRotationXMultiplier");a(this,"startRotationY");a(this,"startRotationYMultiplier");a(this,"startRotationZ");a(this,"startRotationZMultiplier");a(this,"startSize");a(this,"startSize3D");a(this,"startSizeMultiplier");a(this,"startSizeX");a(this,"startSizeXMultiplier");a(this,"startSizeY");a(this,"startSizeYMultiplier");a(this,"startSizeZ");a(this,"startSizeZMultiplier");a(this,"startSpeed");a(this,"startSpeedMultiplier");a(this,"stopAction");a(this,"useUnscaledTime")}}L([g(ce)],yn.prototype,"gravityModifier",void 0);L([g(Ri)],yn.prototype,"startColor",void 0);L([g(ce)],yn.prototype,"startDelay",void 0);L([g(ce)],yn.prototype,"startLifetime",void 0);L([g(ce)],yn.prototype,"startRotation",void 0);L([g(ce)],yn.prototype,"startRotationX",void 0);L([g(ce)],yn.prototype,"startRotationY",void 0);L([g(ce)],yn.prototype,"startRotationZ",void 0);L([g(ce)],yn.prototype,"startSize",void 0);L([g(ce)],yn.prototype,"startSizeX",void 0);L([g(ce)],yn.prototype,"startSizeY",void 0);L([g(ce)],yn.prototype,"startSizeZ",void 0);L([g(ce)],yn.prototype,"startSpeed",void 0);class u0{constructor(){a(this,"cycleCount");a(this,"maxCount");a(this,"minCount");a(this,"probability");a(this,"repeatInterval");a(this,"time");a(this,"count");a(this,"_performed",0)}reset(){this._performed=0}run(t){if(t<=this.time)return 0;let e=0;if(this.cycleCount===0||this._performed<this.cycleCount){const i=this.time+this.repeatInterval*this._performed;if(t>=i&&(this._performed+=1,Math.random()<this.probability))switch(this.count.mode){case It.Constant:e=this.count.constant;break;case It.TwoConstants:e=ee.lerp(this.count.constantMin,this.count.constantMax,Math.random());break;case It.Curve:e=this.count.curve.evaluate(Math.random());break;case It.TwoCurves:const n=Math.random();e=ee.lerp(this.count.curveMin.evaluate(n),this.count.curveMax.evaluate(n),Math.random());break}}return e}}class nl{constructor(){a(this,"enabled");a(this,"bursts");a(this,"rateOverTime");a(this,"rateOverTimeMultiplier");a(this,"rateOverDistance");a(this,"rateOverDistanceMultiplier");a(this,"system")}get burstCount(){var t;return((t=this.bursts)==null?void 0:t.length)??0}reset(){var t;(t=this.bursts)==null||t.forEach(e=>e.reset())}getBurst(){let t=0;if(this.burstCount>0)for(let e=0;e<this.burstCount;e++){const i=this.bursts[e];this.system.main.loop&&i.time>=this.system.time&&i.reset(),t+=Math.round(i.run(this.system.time))}return t}}L([g()],nl.prototype,"enabled",void 0);L([g()],nl.prototype,"bursts",void 0);L([g(ce)],nl.prototype,"rateOverTime",void 0);L([g()],nl.prototype,"rateOverTimeMultiplier",void 0);L([g(ce)],nl.prototype,"rateOverDistance",void 0);L([g()],nl.prototype,"rateOverDistanceMultiplier",void 0);class Fv{constructor(){a(this,"enabled");a(this,"color")}}L([g(Ri)],Fv.prototype,"color",void 0);class wd{constructor(){a(this,"enabled");a(this,"separateAxes");a(this,"size");a(this,"sizeMultiplier");a(this,"x");a(this,"xMultiplier");a(this,"y");a(this,"yMultiplier");a(this,"z");a(this,"zMultiplier");a(this,"_time",0);a(this,"_temp",new R)}evaluate(t,e,i){if(e||(e=this._temp),!this.enabled)return e.x=e.y=e.z=1,e;if(this.separateAxes)e.x=this.x.evaluate(t,i)*this.xMultiplier,e.y=this.y.evaluate(t,i)*this.yMultiplier,e.z=this.z.evaluate(t,i)*this.zMultiplier;else{const n=this.size.evaluate(t,i)*this.sizeMultiplier;e.x=n}return e}}L([g(ce)],wd.prototype,"size",void 0);L([g(ce)],wd.prototype,"x",void 0);L([g(ce)],wd.prototype,"y",void 0);L([g(ce)],wd.prototype,"z",void 0);var wa;(function(s){s[s.Vertex=0]="Vertex",s[s.Edge=1]="Edge",s[s.Triangle=2]="Triangle"})(wa||(wa={}));const Oh=class{constructor(){a(this,"shapeType",rn.Box);a(this,"enabled",!0);a(this,"alignToDirection",!1);a(this,"angle",0);a(this,"arc",360);a(this,"arcSpread");a(this,"arcSpeedMultiplier");a(this,"arcMode");a(this,"boxThickness");a(this,"position");a(this,"rotation");a(this,"_rotation",new Ht);a(this,"scale");a(this,"radius");a(this,"radiusThickness");a(this,"sphericalDirectionAmount");a(this,"randomDirectionAmount");a(this,"randomPositionAmount");a(this,"meshShapeType");a(this,"meshRenderer");a(this,"_meshObj");a(this,"_meshGeometry");a(this,"system");a(this,"_space");a(this,"_worldSpaceMatrix",new xe);a(this,"_worldSpaceMatrixInverse",new xe);a(this,"_vector",new R(0,0,0));a(this,"_temp",new R(0,0,0));a(this,"_triangle",new vk);a(this,"_dir",new R);a(this,"_loopTime",0);a(this,"_loopDirection",1);$p&&console.log(this)}get type(){return rn[this.shapeType]}initialize(t){this.onInitialize(t),t.position.x=this._vector.x,t.position.y=this._vector.y,t.position.z=this._vector.z}toJSON(){return this}clone(){return new Oh}setMesh(t){this.meshRenderer=t,t?(this._meshObj=t.sharedMeshes[Math.floor(Math.random()*t.sharedMeshes.length)],this._meshGeometry=this._meshObj.geometry):(this._meshObj=void 0,this._meshGeometry=void 0)}update(t,e){}onUpdate(t,e,i,n){this.system=t,this._space=i,i===Zs.World&&(this._worldSpaceMatrix.copy(n.matrixWorld),this._worldSpaceMatrix.elements[0]=1,this._worldSpaceMatrix.elements[5]=1,this._worldSpaceMatrix.elements[10]=1,this._worldSpaceMatrixInverse.copy(this._worldSpaceMatrix).invert())}applyRotation(t){const e=this.rotation.x!==0||this.rotation.y!==0||this.rotation.z!==0;return e&&(this._rotation.x=ee.toRadians(this.rotation.x),this._rotation.y=ee.toRadians(this.rotation.y),this._rotation.z=ee.toRadians(this.rotation.z),this._rotation.order="ZYX",t.applyEuler(this._rotation)),e}onInitialize(t){this._vector.set(0,0,0),t.mesh=void 0,t.mesh_geometry=void 0;const e=this._temp.copy(this.position),i=this._space===Zs.World;i&&e.applyQuaternion(this.system.worldQuaternion);let n=this.radius;if(i&&(n*=this.system.worldScale.x),this.enabled){switch(this.shapeType){case rn.Box:$p&&se.DrawWireBox(this.position,this.scale,14540253,1),this._vector.x=Math.random()*this.scale.x-this.scale.x/2,this._vector.y=Math.random()*this.scale.y-this.scale.y/2,this._vector.z=Math.random()*this.scale.z-this.scale.z/2,this._vector.add(e);break;case rn.Cone:this.randomConePoint(this.position,this.angle,n,this.radiusThickness,this.arc,this.arcMode,this._vector);break;case rn.Sphere:this.randomSpherePoint(this.position,n,this.radiusThickness,this.arc,this._vector);break;case rn.Circle:this.randomCirclePoint(this.position,n,this.radiusThickness,this.arc,this._vector);break;case rn.MeshRenderer:const o=this.meshRenderer;(o==null?void 0:o.destroyed)==!1&&this.setMesh(o);const r=t.mesh=this._meshObj,l=t.mesh_geometry=this._meshGeometry;if(r&&l)switch(this.meshShapeType){case wa.Vertex:{const c=l.getAttribute("position"),h=Math.floor(Math.random()*c.count);this._vector.fromBufferAttribute(c,h),this._vector.applyMatrix4(r.matrixWorld),t.mesh_normal=h}break;case wa.Edge:break;case wa.Triangle:{const c=l.index;if(c){let h=Math.random(),d=Math.random();h+d>1&&(h=1-h,d=1-d);const u=Math.floor(Math.random()*(c.count/3));let f=u*3,p=u*3+1,b=u*3+2;f=c.getX(f),p=c.getX(p),b=c.getX(b);const x=l.getAttribute("position");this._triangle.a.fromBufferAttribute(x,f),this._triangle.b.fromBufferAttribute(x,p),this._triangle.c.fromBufferAttribute(x,b),this._vector.set(0,0,0).addScaledVector(this._triangle.a,h).addScaledVector(this._triangle.b,d).addScaledVector(this._triangle.c,1-(h+d)),this._vector.applyMatrix4(r.matrixWorld),t.mesh_normal=u}}break}break;default:this._vector.set(0,0,0),X()&&!globalThis.__particlesystem_shapetype_unsupported&&(console.warn("ParticleSystem ShapeType is not supported:",rn[this.shapeType]),globalThis.__particlesystem_shapetype_unsupported=!0);break}this.randomizePosition(this._vector,this.randomPositionAmount)}this.applyRotation(this._vector),i&&(this._vector.applyQuaternion(this.system.worldQuaternion),this._vector.add(this.system.worldPos)),$p&&se.DrawSphere(this._vector,.03,16711680,.5,!0)}getDirection(t,e){var i;if(!this.enabled)return this._dir.set(0,0,1),this._dir;switch(this.shapeType){case rn.Box:this._dir.set(0,0,1);break;case rn.Cone:this._dir.set(0,0,1);break;case rn.Circle:case rn.Sphere:const n=e.x,o=e.y,r=e.z;this._dir.set(n,o,r),(i=this.system)!=null&&i.worldspace?this._dir.sub(this.system.worldPos):this._dir.sub(this.position);break;case rn.MeshRenderer:const l=t.mesh,c=t.mesh_geometry;if(l&&c)switch(this.meshShapeType){case wa.Vertex:{const h=c.getAttribute("normal"),d=t.mesh_normal;this._dir.fromBufferAttribute(h,d)}break;case wa.Edge:break;case wa.Triangle:{const h=c.index;if(h){const d=t.mesh_normal,u=h.getX(d*3),f=h.getX(d*3+1),p=h.getX(d*3+2),b=c.getAttribute("position"),x=te(),v=te(),S=te();x.fromBufferAttribute(b,u),v.fromBufferAttribute(b,f),S.fromBufferAttribute(b,p),x.sub(v),S.sub(v),x.cross(S),this._dir.copy(x).multiplyScalar(-1);const C=Qe(l);this._dir.applyQuaternion(C)}}break}break;default:this._dir.set(0,0,1);break}return this._space===Zs.World&&this._dir.applyQuaternion(this.system.worldQuaternion),this.applyRotation(this._dir),this._dir.normalize(),this.spherizeDirection(this._dir,this.sphericalDirectionAmount),this.randomizeDirection(this._dir,this.randomDirectionAmount),$p&&(se.DrawSphere(e,.01,8925952,.5,!0),se.DrawDirection(e,this._dir,8925952,.5,!0)),this._dir}randomizePosition(t,e){if(e<=0)return;const i=Oh._tempVec;i.set(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1),i.x*=e*this.scale.x,i.y*=e*this.scale.y,i.z*=e*this.scale.z,t.add(i)}randomizeDirection(t,e){if(e===0)return;const i=Oh._randomQuat,n=Oh._tempVec;n.set(Math.random()-.5,Math.random()-.5,Math.random()-.5).normalize(),i.setFromAxisAngle(n,e*Math.random()*Math.PI),t.applyQuaternion(i)}spherizeDirection(t,e){if(e===0)return;const i=Math.random()*Math.PI*2,n=Math.acos(1-Math.random()*2),o=Math.sin(n)*Math.cos(i),r=Math.sin(n)*Math.sin(i),l=Math.cos(n),c=new R(o,r,l);t.lerp(c,e)}randomSpherePoint(t,e,i,n,o){const r=Math.random(),l=Math.random(),c=2*Math.PI*r*(n/360),h=Math.acos(2*l-1),d=ee.lerp(1,1-Math.pow(1-Math.random(),Math.PI),i)*e,u=t.x+this.scale.x*(-d*Math.sin(h)*Math.cos(c)),f=t.y+this.scale.y*(d*Math.sin(h)*Math.sin(c)),p=t.z+this.scale.z*(d*Math.cos(h));o.x=u,o.y=f,o.z=p}randomCirclePoint(t,e,i,n,o){const r=Math.random(),l=2*Math.PI*r*(n/360),c=ee.lerp(1,1-Math.pow(1-Math.random(),Math.PI),i)*e,h=t.x+this.scale.x*c*Math.cos(l),d=t.y+this.scale.y*c*Math.sin(l),u=t.z;o.x=h,o.y=d,o.z=u}randomConePoint(t,e,i,n,o,r,l){let c=0,h=0;switch(r){case Fl.Random:c=Math.random(),h=Math.random();break;case Fl.PingPong:this._loopTime>1&&(this._loopDirection=-1),this._loopTime<0&&(this._loopDirection=1);case Fl.Loop:c=.5,h=Math.random(),this._loopTime+=this.system.deltaTime*this._loopDirection;break}let d=2*Math.PI*c*(o/360);switch(r){case Fl.PingPong:case Fl.Loop:d+=Math.PI+.5,d+=this._loopTime*Math.PI*2,d%=ee.toRadians(o);break}const u=Math.acos(2*h-1),f=ee.lerp(1,1-Math.pow(1-Math.random(),Math.PI),n)*i,p=t.x+-f*Math.sin(u)*Math.cos(d),b=t.y+f*Math.sin(u)*Math.sin(d),x=t.z;l.x=p*this.scale.x,l.y=b*this.scale.y,l.z=x*this.scale.z}};let lt=Oh;a(lt,"_randomQuat",new re),a(lt,"_tempVec",new R);L([g()],lt.prototype,"shapeType",void 0);L([g()],lt.prototype,"enabled",void 0);L([g()],lt.prototype,"alignToDirection",void 0);L([g()],lt.prototype,"angle",void 0);L([g()],lt.prototype,"arc",void 0);L([g()],lt.prototype,"arcSpread",void 0);L([g()],lt.prototype,"arcSpeedMultiplier",void 0);L([g()],lt.prototype,"arcMode",void 0);L([g(R)],lt.prototype,"boxThickness",void 0);L([g(R)],lt.prototype,"position",void 0);L([g(R)],lt.prototype,"rotation",void 0);L([g(R)],lt.prototype,"scale",void 0);L([g()],lt.prototype,"radius",void 0);L([g()],lt.prototype,"radiusThickness",void 0);L([g()],lt.prototype,"sphericalDirectionAmount",void 0);L([g()],lt.prototype,"randomDirectionAmount",void 0);L([g()],lt.prototype,"randomPositionAmount",void 0);L([g()],lt.prototype,"meshShapeType",void 0);L([g(Yg)],lt.prototype,"meshRenderer",void 0);class Ke{constructor(){a(this,"damping");a(this,"enabled");a(this,"frequency");a(this,"octaveCount");a(this,"octaveMultiplier");a(this,"octaveScale");a(this,"positionAmount");a(this,"quality");a(this,"remap");a(this,"remapEnabled");a(this,"remapMultiplier");a(this,"remapX");a(this,"remapXMultiplier");a(this,"remapY");a(this,"remapYMultiplier");a(this,"remapZ");a(this,"remapZMultiplier");a(this,"scrollSpeedMultiplier");a(this,"separateAxes");a(this,"strengthMultiplier");a(this,"strengthX");a(this,"strengthXMultiplier");a(this,"strengthY");a(this,"strengthYMultiplier");a(this,"strengthZ");a(this,"strengthZMultiplier");a(this,"_noise");a(this,"_time",0);a(this,"_temp",new R)}update(t){this._time+=t.time.deltaTime*this.scrollSpeedMultiplier}apply(t,e,i,n,o,r){if(!this.enabled)return;this._noise||(this._noise=j3(()=>0));const l=this._temp.set(e.x,e.y,e.z).multiplyScalar(this.frequency),c=this._noise(l.x,l.y,l.z,this._time),h=this._noise(l.x,l.y,l.z,this._time+1e3*this.frequency),d=this._noise(l.x,l.y,l.z,this._time+2e3*this.frequency);this._temp.set(c,h,d).normalize();const u=o/r;let f=this.positionAmount.evaluate(u);this.separateAxes?(this._temp.x*=f*this.strengthXMultiplier,this._temp.y*=f*this.strengthYMultiplier,this._temp.z*=f*this.strengthZMultiplier):(this.strengthX&&(f*=this.strengthX.evaluate(u)*1.5),this._temp.multiplyScalar(f)),i.x+=this._temp.x,i.y+=this._temp.y,i.z+=this._temp.z}}L([g()],Ke.prototype,"damping",void 0);L([g()],Ke.prototype,"enabled",void 0);L([g()],Ke.prototype,"frequency",void 0);L([g()],Ke.prototype,"octaveCount",void 0);L([g()],Ke.prototype,"octaveMultiplier",void 0);L([g()],Ke.prototype,"octaveScale",void 0);L([g(ce)],Ke.prototype,"positionAmount",void 0);L([g()],Ke.prototype,"quality",void 0);L([g(ce)],Ke.prototype,"remap",void 0);L([g()],Ke.prototype,"remapEnabled",void 0);L([g()],Ke.prototype,"remapMultiplier",void 0);L([g(ce)],Ke.prototype,"remapX",void 0);L([g()],Ke.prototype,"remapXMultiplier",void 0);L([g(ce)],Ke.prototype,"remapY",void 0);L([g()],Ke.prototype,"remapYMultiplier",void 0);L([g(ce)],Ke.prototype,"remapZ",void 0);L([g()],Ke.prototype,"remapZMultiplier",void 0);L([g()],Ke.prototype,"scrollSpeedMultiplier",void 0);L([g()],Ke.prototype,"separateAxes",void 0);L([g()],Ke.prototype,"strengthMultiplier",void 0);L([g(ce)],Ke.prototype,"strengthX",void 0);L([g()],Ke.prototype,"strengthXMultiplier",void 0);L([g(ce)],Ke.prototype,"strengthY",void 0);L([g()],Ke.prototype,"strengthYMultiplier",void 0);L([g(ce)],Ke.prototype,"strengthZ",void 0);L([g()],Ke.prototype,"strengthZMultiplier",void 0);var f0;(function(s){s[s.PerParticle=0]="PerParticle",s[s.Ribbon=1]="Ribbon"})(f0||(f0={}));var p0;(function(s){s[s.Stretch=0]="Stretch",s[s.Tile=1]="Tile",s[s.DistributePerSegment=2]="DistributePerSegment",s[s.RepeatPerSegment=3]="RepeatPerSegment"})(p0||(p0={}));class Rt{constructor(){a(this,"enabled");a(this,"attachRibbonToTransform",!1);a(this,"colorOverLifetime");a(this,"colorOverTrail");a(this,"dieWithParticles",!0);a(this,"inheritParticleColor",!0);a(this,"lifetime");a(this,"lifetimeMultiplier");a(this,"minVertexDistance",.2);a(this,"mode",f0.PerParticle);a(this,"ratio",1);a(this,"ribbonCount",1);a(this,"shadowBias",0);a(this,"sizeAffectsLifetime",!1);a(this,"sizeAffectsWidth",!1);a(this,"splitSubEmitterRibbons",!1);a(this,"textureMode",p0.Stretch);a(this,"widthOverTrail");a(this,"widthOverTrailMultiplier");a(this,"worldSpace",!1)}getWidth(t,e,i,n){const o=this.widthOverTrail.evaluate(i,n);return t*=o,t}getColor(t,e,i){const n=this.colorOverTrail.evaluate(i),o=this.colorOverLifetime.evaluate(e);t.x*=n.r*o.r,t.y*=n.g*o.g,t.z*=n.b*o.b,"alpha"in n&&"alpha"in o&&(t.w*=n.alpha*o.alpha)}}L([g()],Rt.prototype,"enabled",void 0);L([g()],Rt.prototype,"attachRibbonToTransform",void 0);L([g(Ri)],Rt.prototype,"colorOverLifetime",void 0);L([g(Ri)],Rt.prototype,"colorOverTrail",void 0);L([g()],Rt.prototype,"dieWithParticles",void 0);L([g()],Rt.prototype,"inheritParticleColor",void 0);L([g(ce)],Rt.prototype,"lifetime",void 0);L([g()],Rt.prototype,"lifetimeMultiplier",void 0);L([g()],Rt.prototype,"minVertexDistance",void 0);L([g()],Rt.prototype,"mode",void 0);L([g()],Rt.prototype,"ratio",void 0);L([g()],Rt.prototype,"ribbonCount",void 0);L([g()],Rt.prototype,"shadowBias",void 0);L([g()],Rt.prototype,"sizeAffectsLifetime",void 0);L([g()],Rt.prototype,"sizeAffectsWidth",void 0);L([g()],Rt.prototype,"splitSubEmitterRibbons",void 0);L([g()],Rt.prototype,"textureMode",void 0);L([g(ce)],Rt.prototype,"widthOverTrail",void 0);L([g()],Rt.prototype,"widthOverTrailMultiplier",void 0);L([g()],Rt.prototype,"worldSpace",void 0);class Dt{constructor(){a(this,"enabled");a(this,"space",Zs.Local);a(this,"orbitalX");a(this,"orbitalY");a(this,"orbitalZ");a(this,"orbitalXMultiplier");a(this,"orbitalYMultiplier");a(this,"orbitalZMultiplier");a(this,"orbitalOffsetX");a(this,"orbitalOffsetY");a(this,"orbitalOffsetZ");a(this,"speedModifier");a(this,"speedModifierMultiplier");a(this,"x");a(this,"xMultiplier");a(this,"y");a(this,"yMultiplier");a(this,"z");a(this,"zMultiplier");a(this,"_system");a(this,"_temp",new R);a(this,"_temp2",new R);a(this,"_temp3",new R);a(this,"_hasOrbital",!1);a(this,"_index",0);a(this,"_orbitalMatrix",new xe)}update(t){this._system=t}init(t){this._index==0&&(t.debug=!0),this._index+=1,t.orbitx=this.orbitalX.evaluate(Math.random()),t.orbity=this.orbitalY.evaluate(Math.random()),t.orbitz=this.orbitalZ.evaluate(Math.random()),this._hasOrbital=t.orbitx!=0||t.orbity!=0||t.orbitz!=0}apply(t,e,i,n,o,r,l){var p;if(!this.enabled)return;const c=r/l,h=this.speedModifier.evaluate(c)*this.speedModifierMultiplier,d=this.x.evaluate(c),u=this.y.evaluate(c),f=this.z.evaluate(c);if(this._temp.set(-d,u,f),this._system&&this._system.main.simulationSpace===Zs.World&&this._temp.applyQuaternion(this._system.worldQuaternion),this._hasOrbital&&((p=this._system)==null?void 0:p.worldPos)){const x=this._temp2.set(i.x,i.y,i.z),v=this.orbitalXMultiplier,S=this.orbitalYMultiplier,C=this.orbitalZMultiplier,P=h*Math.PI*2*10,E=Math.cos(P*v),D=Math.sin(P*v),M=Math.cos(P*S),A=Math.sin(P*S),G=Math.cos(P*C),V=Math.sin(P*C),U=x.x*(M*G)+x.y*(M*V)+x.z*-A,$=x.x*(D*A*G-E*V)+x.y*(D*A*V+E*G)+x.z*(D*M),Y=x.x*(E*A*G+D*V)+x.y*(E*A*V-D*G)+x.z*(E*M),B=this._temp3.set(x.x-U,x.y-$,x.z-Y);B.normalize(),B.multiplyScalar(.2/o*Math.max(this.orbitalXMultiplier,this.orbitalYMultiplier,this.orbitalZMultiplier)),n.x+=B.x,n.y+=B.y,n.z+=B.z}n.x+=this._temp.x,n.y+=this._temp.y,n.z+=this._temp.z,n.x*=h,n.y*=h,n.z*=h}}L([g()],Dt.prototype,"enabled",void 0);L([g()],Dt.prototype,"space",void 0);L([g(ce)],Dt.prototype,"orbitalX",void 0);L([g(ce)],Dt.prototype,"orbitalY",void 0);L([g(ce)],Dt.prototype,"orbitalZ",void 0);L([g()],Dt.prototype,"orbitalXMultiplier",void 0);L([g()],Dt.prototype,"orbitalYMultiplier",void 0);L([g()],Dt.prototype,"orbitalZMultiplier",void 0);L([g()],Dt.prototype,"orbitalOffsetX",void 0);L([g()],Dt.prototype,"orbitalOffsetY",void 0);L([g()],Dt.prototype,"orbitalOffsetZ",void 0);L([g(ce)],Dt.prototype,"speedModifier",void 0);L([g()],Dt.prototype,"speedModifierMultiplier",void 0);L([g(ce)],Dt.prototype,"x",void 0);L([g()],Dt.prototype,"xMultiplier",void 0);L([g(ce)],Dt.prototype,"y",void 0);L([g()],Dt.prototype,"yMultiplier",void 0);L([g(ce)],Dt.prototype,"z",void 0);L([g()],Dt.prototype,"zMultiplier",void 0);var m0;(function(s){s[s.Lifetime=0]="Lifetime",s[s.Speed=1]="Speed",s[s.FPS=2]="FPS"})(m0||(m0={}));var hC;(function(s){s[s.Grid=0]="Grid",s[s.Sprites=1]="Sprites"})(hC||(hC={}));var dC;(function(s){s[s.Custom=0]="Custom",s[s.Random=1]="Random",s[s.MeshIndex=2]="MeshIndex"})(dC||(dC={}));var uC;(function(s){s[s.WholeSheet=0]="WholeSheet",s[s.SingleRow=1]="SingleRow"})(uC||(uC={}));class bn{constructor(){a(this,"animation");a(this,"enabled");a(this,"cycleCount");a(this,"frameOverTime");a(this,"frameOverTimeMultiplier");a(this,"numTilesX");a(this,"numTilesY");a(this,"startFrame");a(this,"startFrameMultiplier");a(this,"rowMode");a(this,"rowIndex");a(this,"spriteCount");a(this,"timeMode")}sampleOnceAtStart(){if(this.timeMode===m0.Lifetime)switch(this.frameOverTime.mode){case It.Constant:case It.TwoConstants:case It.TwoCurves:case It.Curve:return!0}return!1}getStartIndex(){return this.sampleOnceAtStart()?Math.random()*(this.numTilesX*this.numTilesY):0}evaluate(t){if(!this.sampleOnceAtStart())return this.getIndex(t)}getIndex(t){const e=this.numTilesX*this.numTilesY;t=t*this.cycleCount;let i=this.frameOverTime.evaluate(t%1);return i*=this.frameOverTimeMultiplier,i*=e,i=i%e,i=Math.floor(i),i}}L([g()],bn.prototype,"animation",void 0);L([g()],bn.prototype,"enabled",void 0);L([g()],bn.prototype,"cycleCount",void 0);L([g(ce)],bn.prototype,"frameOverTime",void 0);L([g()],bn.prototype,"frameOverTimeMultiplier",void 0);L([g()],bn.prototype,"numTilesX",void 0);L([g()],bn.prototype,"numTilesY",void 0);L([g(ce)],bn.prototype,"startFrame",void 0);L([g()],bn.prototype,"startFrameMultiplier",void 0);L([g()],bn.prototype,"rowMode",void 0);L([g()],bn.prototype,"rowIndex",void 0);L([g()],bn.prototype,"spriteCount",void 0);L([g()],bn.prototype,"timeMode",void 0);class ir{constructor(){a(this,"enabled");a(this,"separateAxes");a(this,"x");a(this,"xMultiplier");a(this,"y");a(this,"yMultiplier");a(this,"z");a(this,"zMultiplier")}evaluate(t,e){return this.enabled?this.separateAxes?0:this.z.evaluate(t,e)*-1:0}}L([g()],ir.prototype,"enabled",void 0);L([g()],ir.prototype,"separateAxes",void 0);L([g(ce)],ir.prototype,"x",void 0);L([g()],ir.prototype,"xMultiplier",void 0);L([g(ce)],ir.prototype,"y",void 0);L([g()],ir.prototype,"yMultiplier",void 0);L([g(ce)],ir.prototype,"z",void 0);L([g()],ir.prototype,"zMultiplier",void 0);class so{constructor(){a(this,"enabled");a(this,"range");a(this,"separateAxes");a(this,"x");a(this,"xMultiplier");a(this,"y");a(this,"yMultiplier");a(this,"z");a(this,"zMultiplier")}evaluate(t,e){if(!this.enabled)return 0;if(!this.separateAxes){const i=ee.lerp(this.range.x,this.range.y,e);return this.z.evaluate(i)*-1}return 0}}L([g()],so.prototype,"enabled",void 0);L([g()],so.prototype,"range",void 0);L([g()],so.prototype,"separateAxes",void 0);L([g(ce)],so.prototype,"x",void 0);L([g()],so.prototype,"xMultiplier",void 0);L([g(ce)],so.prototype,"y",void 0);L([g()],so.prototype,"yMultiplier",void 0);L([g(ce)],so.prototype,"z",void 0);L([g()],so.prototype,"zMultiplier",void 0);class hi{constructor(){a(this,"enabled");a(this,"dampen");a(this,"drag");a(this,"dragMultiplier");a(this,"limit");a(this,"limitMultiplier");a(this,"separateAxes");a(this,"limitX");a(this,"limitXMultiplier");a(this,"limitY");a(this,"limitYMultiplier");a(this,"limitZ");a(this,"limitZMultiplier");a(this,"multiplyDragByParticleSize",!1);a(this,"multiplyDragByParticleVelocity",!1);a(this,"space");a(this,"_temp",new R);a(this,"_temp2",new R)}apply(t,e,i,n,o,r,l){if(this.enabled){const c=this.limit.evaluate(o)*this.limitMultiplier;if(e.length()>c){this._temp.copy(e).normalize().multiplyScalar(c);const d=this.dampen*.5;e.x=ee.lerp(e.x,this._temp.x,d),e.y=ee.lerp(e.y,this._temp.y,d),e.z=ee.lerp(e.z,this._temp.z,d),i.x=ee.lerp(i.x,this._temp.x,d),i.y=ee.lerp(i.y,this._temp.y,d),i.z=ee.lerp(i.z,this._temp.z,d)}}}}L([g()],hi.prototype,"enabled",void 0);L([g()],hi.prototype,"dampen",void 0);L([g(ce)],hi.prototype,"drag",void 0);L([g()],hi.prototype,"dragMultiplier",void 0);L([g(ce)],hi.prototype,"limit",void 0);L([g()],hi.prototype,"limitMultiplier",void 0);L([g()],hi.prototype,"separateAxes",void 0);L([g(ce)],hi.prototype,"limitX",void 0);L([g()],hi.prototype,"limitXMultiplier",void 0);L([g(ce)],hi.prototype,"limitY",void 0);L([g()],hi.prototype,"limitYMultiplier",void 0);L([g(ce)],hi.prototype,"limitZ",void 0);L([g()],hi.prototype,"limitZMultiplier",void 0);L([g()],hi.prototype,"multiplyDragByParticleSize",void 0);L([g()],hi.prototype,"multiplyDragByParticleVelocity",void 0);L([g()],hi.prototype,"space",void 0);var Zm;(function(s){s[s.Initial=0]="Initial",s[s.Current=1]="Current"})(Zm||(Zm={}));class sl{constructor(){a(this,"enabled");a(this,"curve");a(this,"curveMultiplier");a(this,"mode");a(this,"system");a(this,"_temp",new R);a(this,"_firstUpdate",!0);a(this,"_frames",0)}clone(){var e;const t=new sl;return t.enabled=this.enabled,t.curve=(e=this.curve)==null?void 0:e.clone(),t.curveMultiplier=this.curveMultiplier,t.mode=this.mode,t}get _lastWorldPosition(){return this.system._iv_lastWorldPosition||(this.system._iv_lastWorldPosition=new R),this.system._iv_lastWorldPosition}get _velocity(){return this.system._iv_velocity||(this.system._iv_velocity=new R),this.system._iv_velocity}awake(t){this.system=t,this.reset()}reset(){this._firstUpdate=!0}update(t){this.enabled&&this.system.worldspace!==!1&&(this._firstUpdate?(this._firstUpdate=!1,this._velocity.set(0,0,0),this._lastWorldPosition.copy(this.system.worldPos)):this._lastWorldPosition&&(this._velocity.copy(this.system.worldPos).sub(this._lastWorldPosition).multiplyScalar(1/this.system.deltaTime),this._lastWorldPosition.copy(this.system.worldPos)))}applyInitial(t){if(this.enabled&&this.system.worldspace!==!1&&this.mode===Zm.Initial){const e=this.curve.evaluate(Math.random(),Math.random());this._temp.copy(this._velocity).multiplyScalar(e),t.x+=this._temp.x,t.y+=this._temp.y,t.z+=this._temp.z}}applyCurrent(t,e,i){if(this.enabled&&this.system&&this.system.worldspace!==!1&&this.mode===Zm.Current){const n=this.curve.evaluate(e,i);this._temp.copy(this._velocity).multiplyScalar(n),t.x+=this._temp.x,t.y+=this._temp.y,t.z+=this._temp.z}}}L([g()],sl.prototype,"enabled",void 0);L([g(ce)],sl.prototype,"curve",void 0);L([g()],sl.prototype,"curveMultiplier",void 0);L([g()],sl.prototype,"mode",void 0);class es{constructor(){a(this,"enabled");a(this,"range");a(this,"separateAxes");a(this,"size");a(this,"sizeMultiplier");a(this,"x");a(this,"xMultiplier");a(this,"y");a(this,"yMultiplier");a(this,"z");a(this,"zMultiplier")}evaluate(t,e,i,n){const o=t.length(),r=ee.remap(o,this.range.x,this.range.y,0,1),l=this.size.evaluate(r,i);return n.x*=l,n.y*=l,n.z*=l,n}}L([g()],es.prototype,"enabled",void 0);L([g(_e)],es.prototype,"range",void 0);L([g()],es.prototype,"separateAxes",void 0);L([g(ce)],es.prototype,"size",void 0);L([g()],es.prototype,"sizeMultiplier",void 0);L([g(ce)],es.prototype,"x",void 0);L([g()],es.prototype,"xMultiplier",void 0);L([g(ce)],es.prototype,"y",void 0);L([g()],es.prototype,"yMultiplier",void 0);L([g(ce)],es.prototype,"z",void 0);L([g()],es.prototype,"zMultiplier",void 0);class Hf{constructor(){a(this,"enabled");a(this,"range");a(this,"color")}evaluate(t,e,i){const n=t.length(),o=ee.remap(n,this.range.x,this.range.y,0,1),r=this.color.evaluate(o,e);i.x*=r.r,i.y*=r.g,i.z*=r.b,"alpha"in r&&(i.w*=r.alpha)}}L([g()],Hf.prototype,"enabled",void 0);L([g(_e)],Hf.prototype,"range",void 0);L([g(Ri)],Hf.prototype,"color",void 0);new R(1,1,1);new R(0,0,1);class bR{constructor(t,e,i,n){a(this,"system");a(this,"particleSystem");a(this,"subSystem");a(this,"subParticleSystem");a(this,"type","NeedleParticleSubEmitter");a(this,"emitterType");a(this,"emitterProbability");a(this,"q_",new re);a(this,"v_",new R);a(this,"v2_",new R);a(this,"_emitterMatrix",new $y);a(this,"_circularBuffer");this.system=t,this.particleSystem=e,this.subSystem=i,this.subParticleSystem=n,this.subParticleSystem&&this.subParticleSystem&&(this.subParticleSystem.onlyUsedByOther=!0);const o=1e3;this._circularBuffer=new vs(()=>new $y,o)}clone(){throw new Error("Method not implemented.")}initialize(t){t.emissionState={burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0},this._emitterMatrix.copy(this.subSystem.matrixWorld).invert().premultiply(this.system.matrixWorld),this._emitterMatrix.setPosition(0,0,0),this.emitterType===Jm.Birth&&this.run(t)}update(t,e){this.run(t)}frameUpdate(t){}toJSON(){}reset(){}run(t){if(this.subSystem.currentParticles>=this.subSystem.main.maxParticles||!this.subParticleSystem||!t.emissionState||this.emitterProbability&&Math.random()>this.emitterProbability)return;const e=this.system.deltaTime;if(this.emitterType===Jm.Death){let n=t.life;if(t[yh]!==void 0&&(n=t[yh]),!(t.age+e*1.2>=n))return;const r=this.subSystem.main.maxParticles-this.subSystem.currentParticles;t.emissionState.waitEmiting=r}const i=new $y;i.set(1,0,0,t.position.x,0,1,0,t.position.y,0,0,1,t.position.z,0,0,0,1),this.particleSystem.worldSpace||i.multiplyMatrices(this._emitterMatrix,i),this.subParticleSystem.emit(e,t.emissionState,i)}}var wt=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Sa=k("debugparticles"),B3=k("noprogressive"),U3=k("debugprogressive");var Jm;(function(s){s[s.Birth=0]="Birth",s[s.Collision=1]="Collision",s[s.Death=2]="Death",s[s.Trigger=3]="Trigger",s[s.Manual=4]="Manual"})(Jm||(Jm={}));class oo extends W{constructor(){super(...arguments);a(this,"renderMode");a(this,"particleMaterial");a(this,"trailMaterial");a(this,"particleMesh");a(this,"maxParticleSize");a(this,"minParticleSize");a(this,"velocityScale");a(this,"cameraVelocityScale");a(this,"lengthScale")}start(){if(this.maxParticleSize!==.5&&this.minParticleSize!==0&&X()){const e=`ParticleSystem "${this.name}" has non-default min/max particle size. This may not render correctly. Please set min size to 0 and the max size to 0.5 and use the "StartSize" setting instead`;console.warn(e)}}get transparent(){var i;return((i=this.particleMaterial)==null?void 0:i.transparent)??!1}getMaterial(e=!1){let i=e===!0&&this.trailMaterial?this.trailMaterial:this.particleMaterial;if(i){if(i.type==="MeshStandardMaterial"){Sa&&console.debug("ParticleSystemRenderer.getMaterial: MeshStandardMaterial detected, converting to MeshBasicMaterial. See https://github.com/Alchemist0823/three.quarks/issues/101"),"map"in i&&i.map&&(i.map.colorSpace=$r,i.map.premultiplyAlpha=!1);const n=new Ye;n.copy(i),e?this.trailMaterial=n:this.particleMaterial=n}i.map&&(i.map.colorSpace=$r,i.map.premultiplyAlpha=!1),e&&i.side===Wa&&(i=i.clone(),i.side=Tg,e?this.trailMaterial=i:this.particleMaterial=i)}return i&&!B3&&i._didRequestTextureLOD===void 0&&(i._didRequestTextureLOD=0,U3&&console.log("Load material LOD",i.name),Tt.assignTextureLOD(i,0)),i}getMesh(e){let i=null;if(!i&&(this.particleMesh instanceof le&&(i=this.particleMesh.geometry),i===null)){i=new to(1,1);const o=i.attributes.uv;for(let r=0;r<o.count;r++)o.setX(r,1-o.getX(r))}return new le(i,this.getMaterial())}}wt([g()],oo.prototype,"renderMode",void 0);wt([g(Xe)],oo.prototype,"particleMaterial",void 0);wt([g(Xe)],oo.prototype,"trailMaterial",void 0);wt([g()],oo.prototype,"maxParticleSize",void 0);wt([g()],oo.prototype,"minParticleSize",void 0);wt([g()],oo.prototype,"velocityScale",void 0);wt([g()],oo.prototype,"cameraVelocityScale",void 0);wt([g()],oo.prototype,"lengthScale",void 0);class Vp{constructor(t,e=1){a(this,"_curve");a(this,"_factor");a(this,"type","function");this._curve=t,this._factor=e}startGen(t){}genValue(t,e){return this._curve.evaluate(e,Math.random())*this._factor}toJSON(){throw new Error("Method not implemented.")}clone(){throw new Error("Method not implemented.")}}class Bv{constructor(t){a(this,"type","value");a(this,"system");this.system=t}toJSON(){throw new Error("Method not implemented.")}clone(){throw new Error("Method not implemented.")}startGen(t){}}class N3 extends Bv{genValue(){return this.system.textureSheetAnimation.getStartIndex()}}class z3 extends Bv{constructor(){super(...arguments);a(this,"_lastPosition",new R);a(this,"_lastDistance",0)}update(){const e=ve(this.system.gameObject);this._lastDistance=this._lastPosition.distanceTo(e),this._lastPosition.copy(e)}genValue(){if(!this.system.isPlaying||!this.system.emission.enabled||this.system.currentParticles>=this.system.maxParticles)return 0;let e=this.system.emission.rateOverTime.evaluate(this.system.time/this.system.duration,Math.random());if(this.system.deltaTime>0){const o=this.system.emission.rateOverDistance.evaluate(this.system.time/this.system.duration,Math.random());let l=this._lastDistance/this.system.deltaTime*o;Number.isFinite(l)||(l=0),e+=l}const i=this.system.emission.getBurst();i>0&&(e+=i/this.system.deltaTime);const n=this.system.maxParticles-this.system.currentParticles;return ee.clamp(e,0,n/this.system.deltaTime)}}class $3 extends Bv{genValue(){return this.system.isPlaying,0}}class Oc{constructor(t){a(this,"system");a(this,"type");this.type=Object.getPrototypeOf(this).constructor.name||"ParticleSystemBaseBehaviour",t&&(this.system=t)}get context(){return this.system.context}initialize(t){}update(t,e){}frameUpdate(t){}toJSON(){throw new Error("Method not implemented.")}clone(){throw new Error("Method not implemented.")}reset(){}}class V3 extends Oc{constructor(){super(...arguments);a(this,"type","NeedleTextureSheet")}update(e,i){const n=this.system.textureSheetAnimation;if(n.enabled){const o=e.age/e.life,r=n.evaluate(o);r!==void 0&&(e.uvTile=r)}}}const fC=Symbol("particleRotation");class W3 extends Oc{constructor(){super(...arguments);a(this,"type","NeedleRotation")}initialize(e){e[fC]=Math.random()}update(e,i){if(e.rotation===void 0)return;const n=e.age/e.life;if(typeof e.rotation=="number"&&(this.system.rotationOverLifetime.enabled?e.rotation+=this.system.rotationOverLifetime.evaluate(n,e[fC])*i:this.system.renderer.renderMode===Mo.Billboard&&(e.rotation=Math.PI),this.system.rotationBySpeed.enabled)){const o=e.velocity.length();e.rotation+=this.system.rotationBySpeed.evaluate(n,o)*i}}}const pC=Symbol("sizeLerpFactor"),H3=new R;class G3 extends Oc{constructor(){super(...arguments);a(this,"type","NeedleSize");a(this,"_minSize",0);a(this,"_maxSize",1)}initialize(e){e[pC]=Math.random(),this._minSize=this.system.renderer.minParticleSize,this._maxSize=this.system.renderer.maxParticleSize}update(e,i){const n=e.age/e.life;let o=1;this.system.sizeOverLifetime.enabled&&(o*=this.system.sizeOverLifetime.evaluate(n,void 0,e[pC]).x);let r=1;this.system.renderer.renderMode!==Mo.Mesh&&(r=this.system.worldScale.x/this.system.cameraScale);const l=te(e.startSize).multiplyScalar(o*r);if(e.size.set(l.x,l.y,l.z),this.system.localspace){const c=_R(this.system,H3);e.size.x*=c.x,e.size.y*=c.y,e.size.z*=c.z}}}const yh=Symbol("particleLife"),Wb=Symbol("trailLifetime"),mC=Symbol("trailStartLength"),Hb=Symbol("trailWidthRandom");class q3 extends Oc{constructor(){super(...arguments);a(this,"type","NeedleTrail")}initialize(e){e instanceof Vx&&(e[yh]=e.life,this.system.trails.enabled&&this.system.trails.dieWithParticles===!1&&(e[Wb]=this.system.trails.lifetime.evaluate(Math.random(),Math.random()),e.life+=e[Wb]),e[mC]=e.length,e[Hb]=Math.random())}update(e){var i;if((i=this.system.trails)!=null&&i.enabled&&e instanceof Vx){const n=e,o=e.age/e[yh],r=e.previous.values(),l=e.previous.length;for(let c=0;c<l;c++){const d=r.next().value,u=1-c/(l-1),f=e.size;if(f.x<=0&&!this.system.trails.sizeAffectsWidth){const p=20*this.system.trails.widthOverTrail.evaluate(.5,n[Hb]);f.x=p,f.y=p,f.z=p}d.size=this.system.trails.getWidth(f.x,o,u,n[Hb]),d.color.copy(e.color),this.system.trails.getColor(d.color,o,u)}if(e.age>e[yh]){e.velocity.set(0,0,0);const c=(e.age-e[yh])/e[Wb];n.length=ee.lerp(e[mC],0,c)}}}}const Wp=Symbol("startVelocity"),gC=Symbol("gravityModifier"),Gb=Symbol("gravitySpeed"),Hp=Symbol("velocity lerp factor"),g0=new R;class X3 extends Oc{constructor(){super(...arguments);a(this,"type","NeedleVelocity");a(this,"_gravityDirection",new R)}initialize(e){var r,l;const i=this.system.main.simulationSpeed;e.startSpeed=this.system.main.startSpeed.evaluate(Math.random(),Math.random());const n=this.system.shape.getDirection(e,e.position);e.velocity.x=n.x*e.startSpeed,e.velocity.y=n.y*e.startSpeed,e.velocity.z=n.z*e.startSpeed,(r=this.system.inheritVelocity)!=null&&r.enabled&&this.system.inheritVelocity.applyInitial(e.velocity),e[Wp]?e[Wp].copy(e.velocity):e[Wp]=e.velocity.clone();const o=this.system.main.gravityModifier.evaluate(Math.random(),Math.random());e[gC]=o*i,e[Gb]=o*i*.5,e[Hp]=Math.random(),(l=this.system.velocityOverLifetime)==null||l.init(e),this._gravityDirection.set(0,-1,0),this.system.main.simulationSpace===Zs.Local&&this._gravityDirection.applyQuaternion(this.system.worldQuaternionInverted).normalize()}update(e,i){var f;const n=e[Wp],o=e[gC];if(o!==0){const p=o*e[Gb];g0.copy(this._gravityDirection).multiplyScalar(p),e[Gb]+=i*.05,n.add(g0)}e.velocity.copy(n);const r=e.age/e.life;(f=this.system.inheritVelocity)!=null&&f.enabled&&this.system.inheritVelocity.applyCurrent(e.velocity,r,e[Hp]);const l=this.system.noise;l.enabled&&l.apply(0,e.position,e.velocity,i,e.age,e.life);const c=this.system.sizeBySpeed;c!=null&&c.enabled&&(e.size=c.evaluate(e.velocity,r,e[Hp],e.size));const h=this.system.colorBySpeed;h!=null&&h.enabled&&h.evaluate(e.velocity,e[Hp],e.color);const d=this.system.velocityOverLifetime;d.enabled&&d.apply(e,0,e.position,e.velocity,i,e.age,e.life);const u=this.system.limitVelocityOverLifetime;if(u.enabled&&u.apply(e.position,n,e.velocity,e.size,r,i,1),this.system.worldspace){const p=this.system.worldScale;e.velocity.x*=p.x,e.velocity.y*=p.y,e.velocity.z*=p.z}}}const yC=Symbol("colorLerpFactor"),bC=new Te(1,1,1,1),Ol=new Te(1,1,1,1);class Q3 extends Oc{constructor(){super(...arguments);a(this,"type","NeedleColor")}initialize(e){}_init(e){const i=this.system.renderer.particleMaterial;Ol.copy(this.system.main.startColor.evaluate(Math.random())),i!=null&&i.color&&(bC.copy(i.color),Ol.multiply(bC)),Ol.convertLinearToSRGB(),e.startColor.set(Ol.r,Ol.g,Ol.b,Ol.alpha),e.color.copy(e.startColor),e[yC]=Math.random()}update(e,i){if(e.age===0&&this._init(e),this.system.colorOverLifetime.enabled){const n=e.age/e.life,o=this.system.colorOverLifetime.color.evaluate(n,e[yC]);e.color.set(o.r,o.g,o.b,"alpha"in o?o.alpha:1).multiply(e.startColor)}else e.color.copy(e.startColor)}}class Y3{constructor(t){a(this,"system");a(this,"emission");a(this,"autoDestroy");a(this,"startLength");a(this,"emissionBursts");a(this,"onlyUsedByOther");a(this,"behaviors",[]);a(this,"rendererEmitterSettings",{startLength:new aE(220),followLocalOrigin:!1});a(this,"flatWhiteTexture");a(this,"clonedTexture",{original:void 0,clone:void 0});this.system=t,this.emission=new z3(this.system)}get anim(){return this.system.textureSheetAnimation}get prewarm(){return!1}get material(){return this.system.renderer.getMaterial(this.system.trails.enabled)}get layers(){return this.system.gameObject.layers}update(){this.emission.update()}get looping(){return this.system.main.loop}get duration(){return this.system.duration}get shape(){return this.system.shape}get startLife(){return new Vp(this.system.main.startLifetime)}get startSpeed(){return new Vp(this.system.main.startSpeed)}get startRotation(){return new Vp(this.system.main.startRotation)}get startSize(){return new Vp(this.system.main.startSize)}get startColor(){return new oE(new rE(1,1,1,1))}get emissionOverTime(){return this.emission}get emissionOverDistance(){return new $3(this.system)}get instancingGeometry(){return this.system.renderer.getMesh(this.system.renderer.renderMode).geometry}get renderMode(){if(this.system.trails.enabled===!0)return yr.Trail;switch(this.system.renderer.renderMode){case Mo.Billboard:return yr.BillBoard;case Mo.Stretch:return yr.StretchedBillBoard;case Mo.HorizontalBillboard:return yr.HorizontalBillBoard;case Mo.VerticalBillboard:return yr.VerticalBillBoard;case Mo.Mesh:return yr.Mesh}return yr.BillBoard}get speedFactor(){var e;let t=this.system.main.simulationSpeed;return((e=this.system.renderer)==null?void 0:e.renderMode)===Mo.Stretch&&(t*=this.system.renderer.velocityScale??1),t}get texture(){const t=this.material;if(t&&t.map){const e=t.map;if(this.clonedTexture.original!==e||!this.clonedTexture.clone){const i=e.clone();i.premultiplyAlpha=!1,i.colorSpace=$r,this.clonedTexture.original=e,this.clonedTexture.clone=i}return this.clonedTexture.clone}return this.flatWhiteTexture||(this.flatWhiteTexture=rv(new Te(1,1,1,1),1)),this.flatWhiteTexture}get startTileIndex(){return new N3(this.system)}get uTileCount(){var t;return this.anim.enabled?(t=this.anim)==null?void 0:t.numTilesX:void 0}get vTileCount(){var t;return this.anim.enabled?(t=this.anim)==null?void 0:t.numTilesY:void 0}get renderOrder(){return 1}get blending(){var t;return((t=this.system.renderer.particleMaterial)==null?void 0:t.blending)??xk}get transparent(){return this.system.renderer.transparent}get worldSpace(){return this.system.main.simulationSpace===Zs.World}}class K3{constructor(){a(this,"burstParticleIndex",0);a(this,"burstParticleCount",0);a(this,"isBursting",!1);a(this,"travelDistance",0);a(this,"previousWorldPos");a(this,"burstIndex",0);a(this,"burstWaveIndex",0);a(this,"time",0);a(this,"waitEmiting",0)}}class vt extends W{constructor(){super(...arguments);a(this,"_state");a(this,"colorOverLifetime");a(this,"main");a(this,"emission");a(this,"sizeOverLifetime");a(this,"shape");a(this,"noise");a(this,"trails");a(this,"velocityOverLifetime");a(this,"limitVelocityOverLifetime");a(this,"inheritVelocity");a(this,"colorBySpeed");a(this,"textureSheetAnimation");a(this,"rotationOverLifetime");a(this,"rotationBySpeed");a(this,"sizeBySpeed");a(this,"_cameraScale",1);a(this,"__worldQuaternion",new re);a(this,"_worldQuaternionInverted",new re);a(this,"_worldScale",new R);a(this,"_worldPositionFrame",-1);a(this,"_worldPos",new R);a(this,"_renderer");a(this,"_batchSystem");a(this,"_particleSystem");a(this,"_interface");a(this,"_container");a(this,"_time",0);a(this,"_isPlaying",!0);a(this,"_isUsedAsSubsystem",!1);a(this,"_didPreWarm",!1);a(this,"_bursts");a(this,"_subEmitterSystems");a(this,"_lastBatchesCount",-1)}play(e=!1){var i;e&&I.foreachComponent(this.gameObject,n=>{n instanceof vt&&n!==this&&n.play(!1)},!0),this._isPlaying=!0,this._particleSystem&&(this._particleSystem.emissionState.time=0,this._particleSystem.emitEnded=!1),(i=this.emission)==null||i.reset()}pause(e=!0){e&&I.foreachComponent(this.gameObject,i=>{i instanceof vt&&i!==this&&i.pause(!1)},!0),this._isPlaying=!1}stop(e=!0,i=!1){e&&I.foreachComponent(this.gameObject,n=>{n instanceof vt&&n!==this&&n.stop(!1,i)},!0),this._isPlaying=!1,this._time=0,i&&this.reset()}reset(){var e;this._time=0,this._particleSystem&&(this._particleSystem.particleNum=0,this._particleSystem.emissionState.time=0,this._particleSystem.emitEnded=!1,(e=this.emission)==null||e.reset())}emit(e){if(this._particleSystem){this.onUpdate(),e=Math.min(e,this.maxParticles-this.currentParticles),this._state||(this._state=new K3),this._state.waitEmiting=e,this._state.time=0;const i=this._particleSystem.emitEnded;this._particleSystem.emitEnded=!1,this._particleSystem.emit(this.deltaTime,this._state,this._particleSystem.emitter.matrixWorld),this._particleSystem.emitEnded=i}}get playOnAwake(){return this.main.playOnAwake}set playOnAwake(e){this.main.playOnAwake=e}get renderer(){return this._renderer}get isPlaying(){return this._isPlaying}get currentParticles(){var e;return((e=this._particleSystem)==null?void 0:e.particleNum)??0}get maxParticles(){return this.main.maxParticles}get time(){return this._time}get duration(){return this.main.duration}get deltaTime(){return this.context.time.deltaTime*this.main.simulationSpeed}get scale(){return this.gameObject.scale.x}get cameraScale(){return this._cameraScale}get container(){return this._container}get worldspace(){return this.main.simulationSpace===Zs.World}get localspace(){return this.main.simulationSpace===Zs.Local}get worldQuaternion(){return this.__worldQuaternion}get worldQuaternionInverted(){return this._worldQuaternionInverted}get worldScale(){return this._worldScale}get worldPos(){return this._worldPositionFrame!==this.context.time.frame&&(this._worldPositionFrame=this.context.time.frame,ve(this.gameObject,this._worldPos)),this._worldPos}get matrixWorld(){return this._container.matrixWorld}get isSubsystem(){return this._isUsedAsSubsystem}addBehaviour(e){return this._particleSystem?(e instanceof Oc&&(e.system=this),Sa&&console.debug("Add custom ParticleSystem Behaviour",e),this._particleSystem.addBehavior(e),!0):!1}removeBehaviour(e){if(!this._particleSystem)return!1;const i=this._particleSystem.behaviors,n=i.indexOf(e);return n!==-1&&((X()||Sa)&&console.debug("Remove custom ParticleSystem Behaviour",n,e),i.splice(n,1)),!0}removeAllBehaviours(){return this._particleSystem?(this._particleSystem.behaviors.length=0,!0):!1}get behaviours(){return this._particleSystem?this._particleSystem.behaviors:null}get particleSystem(){return this._particleSystem??null}set bursts(e){for(let i=0;i<e.length;i++){const n=e[i];if(!(n instanceof u0)){const o=new u0;ed(o,n),e[i]=o}}this._bursts=e}set subEmitterSystems(e){for(let i=0;i<e.length;i++){const n=e[i];if(!(n instanceof y0)){const o=new y0;ed(o,n),e[i]=o}}Sa&&e.length>0&&console.log("SubEmitters: ",e,this),this._subEmitterSystems=e}onAfterDeserialize(e){if(this._subEmitterSystems&&Array.isArray(this._subEmitterSystems))for(const i of this._subEmitterSystems)i._deserialize(this.context,this.gameObject)}awake(){if(this._worldPositionFrame=-1,this._renderer=this.gameObject.getComponent(oo),!this.main)throw new Error("Not Supported: ParticleSystem needs a serialized MainModule. Creating new particle systems at runtime is currently not supported.");this._container=new z,this._container.matrixAutoUpdate=!1,this.context.scene.add(this._container),this._batchSystem=new nE,this._batchSystem.name=this.gameObject.name,this._container.add(this._batchSystem),this._interface=new Y3(this),this._particleSystem=new sE(this._interface),this._particleSystem.addBehavior(new G3(this)),this._particleSystem.addBehavior(new Q3(this)),this._particleSystem.addBehavior(new V3(this)),this._particleSystem.addBehavior(new W3(this)),this._particleSystem.addBehavior(new X3(this)),this._particleSystem.addBehavior(new q3(this)),this._batchSystem.addSystem(this._particleSystem);const e=this._particleSystem.emitter;this.context.scene.add(e),this.inheritVelocity.system&&this.inheritVelocity.system!==this&&(this.inheritVelocity=this.inheritVelocity.clone()),this.inheritVelocity.awake(this),Sa&&(console.log(this),this.gameObject.add(new Wn(1)))}start(){this.addSubParticleSystems(),this.updateLayers(),this.renderer.particleMesh instanceof le&&this._interface.renderMode==yr.Mesh&&Tt.assignMeshLOD(this.renderer.particleMesh,0).then(e=>{e&&this.particleSystem&&this._interface.renderMode==yr.Mesh&&(this.particleSystem.instancingGeometry=e)})}onDestroy(){var e,i,n,o;(e=this._container)==null||e.removeFromParent(),(i=this._batchSystem)==null||i.removeFromParent(),(n=this._particleSystem)==null||n.emitter.removeFromParent(),(o=this._particleSystem)==null||o.dispose()}onEnable(){this.main&&(this.inheritVelocity&&(this.inheritVelocity.system=this),this._batchSystem&&(this._batchSystem.visible=!0),this.playOnAwake&&this.play(),this._isPlaying=this.playOnAwake)}onDisable(){this._batchSystem&&(this._batchSystem.visible=!1)}onBeforeRender(){var e;this.main&&(this._didPreWarm===!1&&((e=this.main)==null?void 0:e.prewarm)===!0&&(this._didPreWarm=!0,this.preWarm()),this.onUpdate(),this.onSimulate(this.deltaTime))}preWarm(){var d;if(!((d=this.emission)!=null&&d.enabled)||this.emission.rateOverTime.getMax()<=0)return;const i=1/60,n=this.main.duration,o=this.main.startLifetime.getMax(),r=1e3,l=Math.min(Math.max(n,o)/Math.max(.01,this.main.simulationSpeed),r),c=Math.ceil(l/i),h=Date.now();Sa&&console.log(`Particles ${this.name} - Prewarm for ${c} frames (${l} sec). Duration: ${n}, Lifetime: ${o}`);for(let u=0;u<c&&!(this.currentParticles>=this.maxParticles);u++){const f=Date.now()-h;if(f>2e3){console.warn(`Particles ${this.name} - Prewarm took too long. Aborting: ${f}`);break}this.onUpdate(),this.onSimulate(i)}}onSimulate(e){if(this._batchSystem){let i=this.context.time.frameCount%60===0;this._lastBatchesCount!==this._batchSystem.batches.length&&(this._lastBatchesCount=this._batchSystem.batches.length,i=!0),i&&this.updateLayers(),this._batchSystem.update(e)}this._time+=e,this._time>this.duration&&(this._time=0)}updateLayers(){if(this._batchSystem)for(let e=0;e<this._batchSystem.batches.length;e++){const i=this._batchSystem.batches[e];i.layers.disableAll();const n=this.layer;i.layers.mask=1<<n}}onUpdate(){var o,r;if(this._bursts&&(this.emission.bursts=this._bursts,delete this._bursts),!this._isPlaying)return;const e=this.context.mainCamera;if(e){const l=Lt(e);this._cameraScale=l.x}const i=!this.worldspace,n=this.gameObject;if(Qe(n,this.__worldQuaternion),this._worldQuaternionInverted.copy(this.__worldQuaternion).invert(),Lt(this.gameObject,this._worldScale),i&&this._container&&((o=this.gameObject)!=null&&o.parent)){const l=_R(this,g0);this._container.matrix.makeScale(l.x,l.y,l.z),this._container.matrix.makeRotationFromQuaternion(this.__worldQuaternion),this._container.matrix.setPosition(this.worldPos),this._container.matrix.scale(this.gameObject.scale)}this.emission.system=this,this._interface.update(),this.shape.onUpdate(this,this.context,this.main.simulationSpace,this.gameObject),this.noise.update(this.context),(r=this.inheritVelocity)==null||r.update(this.context),this.velocityOverLifetime.update(this)}addSubParticleSystems(){var e;if(this._subEmitterSystems&&this._particleSystem)for(const i of this._subEmitterSystems){i.particleSystem&&(i.particleSystem.__internalAwake?i.particleSystem.__internalAwake():X()&&console.warn("SubParticleSystem serialization issue(?)",i.particleSystem,i));const n=(e=i.particleSystem)==null?void 0:e._particleSystem;if(n){i.particleSystem._isUsedAsSubsystem=!0;const o=new bR(this,this._particleSystem,i.particleSystem,n);o.emitterType=i.type,o.emitterProbability=i.emitProbability,this._particleSystem.addBehavior(o)}else Sa&&console.warn("Could not add SubParticleSystem",i,this)}}}wt([g(Fv)],vt.prototype,"colorOverLifetime",void 0);wt([g(yn)],vt.prototype,"main",void 0);wt([g(nl)],vt.prototype,"emission",void 0);wt([g(wd)],vt.prototype,"sizeOverLifetime",void 0);wt([g(lt)],vt.prototype,"shape",void 0);wt([g(Ke)],vt.prototype,"noise",void 0);wt([g(Rt)],vt.prototype,"trails",void 0);wt([g(Dt)],vt.prototype,"velocityOverLifetime",void 0);wt([g(hi)],vt.prototype,"limitVelocityOverLifetime",void 0);wt([g(sl)],vt.prototype,"inheritVelocity",void 0);wt([g(Hf)],vt.prototype,"colorBySpeed",void 0);wt([g(bn)],vt.prototype,"textureSheetAnimation",void 0);wt([g(ir)],vt.prototype,"rotationOverLifetime",void 0);wt([g(so)],vt.prototype,"rotationBySpeed",void 0);wt([g(es)],vt.prototype,"sizeBySpeed",void 0);class y0{constructor(){a(this,"particleSystem");a(this,"emitProbability",1);a(this,"properties");a(this,"type")}_deserialize(t,e){const i=this.particleSystem;if(i instanceof vt)return;let n="";i&&typeof i.guid=="string"&&(n=i.guid,this.particleSystem=I.findByGuid(n,e)),Sa&&!(this.particleSystem instanceof vt)&&console.warn("Could not find particle system for sub emitter",n,e,this)}}function _R(s,t){if(t.set(1,1,1),s.gameObject.parent&&s.localspace)switch(s.main.scalingMode){case Km.Local:t=Lt(s.gameObject.parent,t),t.x=1/t.x,t.y=1/t.y,t.z=1/t.z;break;default:if(!s.unsupported_scaling_mode){s.unsupported_scaling_mode=!0;const e="ParticleSystem scale mode "+Km[s.main.scalingMode]+" is not supported";X()&&qe(e),console.warn(e,s.name,s)}t=Lt(s.gameObject,t);break}return t}var Uv=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Gf extends W{constructor(){super(...arguments);a(this,"strength",1);a(this,"radius",2);a(this,"targets",[])}update(){var n;const e=this.gameObject.worldPosition,i=-this.strength*this.context.time.deltaTime;(n=this.targets)==null||n.forEach(o=>{if(!o)return;const r=o.gameObject.worldPosition.sub(e),l=r.length();if(l>this.radius)return;let c=i;l>1?c/=l*l:c/=Math.max(.05,l),o.applyImpulse(r.multiplyScalar(c))})}}Uv([g()],Gf.prototype,"strength",void 0);Uv([g()],Gf.prototype,"radius",void 0);Uv([g(De)],Gf.prototype,"targets",void 0);class vf extends W{constructor(){super(...arguments);a(this,"_didAssignPlayerColor",!1);a(this,"tryAssignColor",()=>{const e=I.getComponentInParent(this.gameObject,oi);if(e&&e.owner)return this._didAssignPlayerColor=!0,this.assignUserColor(e.owner),!0;const i=I.getComponentInParent(this.gameObject,ni);return i!=null&&i.connectionId?(this._didAssignPlayerColor=!0,this.assignUserColor(i.connectionId),!0):!1})}onEnable(){this.context.connection.beginListen(me.JoinedRoom,this.tryAssignColor),this._didAssignPlayerColor||this.startCoroutine(this.waitForConnection())}onDisable(){this.context.connection.stopListen(me.JoinedRoom,this.tryAssignColor)}*waitForConnection(){for(;!this.destroyed&&this.activeAndEnabled&&(yield uT(.2),!this.tryAssignColor()););}assignUserColor(e){const i=vf.hashCode(e),n=vf.colorFromHashCode(i);if(this.gameObject.type==="Mesh"){const o=this.gameObject;this.assignColor(n,e,o)}else if(this.gameObject.children)for(const o of this.gameObject.children){const r=o;r.material&&r.material.color&&this.assignColor(n,e,r)}}assignColor(e,i,n){let o=n.material;o&&(o._playerMaterial!==i&&(o=o.clone(),o._playerMaterial=i,n.material=o),o.color=e)}static hashCode(e){var i=0,n,o;if(e.length===0)return i;for(n=0;n<e.length;n++)o=e.charCodeAt(n),i=(i<<5)-i+o,i|=0;return i}static colorFromHashCode(e){const i=(e&16711680)>>16,n=(e&65280)>>8,o=e&255;return new Se(i/255,n/255,o/255)}}const pu=k("debugpost");let b0=null;function Z3(s){b0=s}function vR(s){let t=s.gameObject;for(;t;){for(const e of ov(t))if(e.isPostProcessingManager===!0)return e;t=t.parent}return null}function J3(s){let t=vR(s);if(!t)if(b0){pu&&console.warn("Adding postprocessing manager to the scene.");const e=s.scene;t=Wo(e,b0)}else X()&&console.warn("No post processing manager found");return t}const Yt={AT_START:-1e4,NormalPass:0,DepthDownsamplingPass:10,SSAO:20,SMAA:30,TiltShift:40,DepthOfField:50,ChromaticAberration:60,Bloom:70,Vignette:80,Pixelation:90,ToneMapping:100,HueSaturation:110,BrightnessContrast:120,Sharpening:130,AT_END:1e4};let Ft=null;function ej(s){pu==="verbose"&&console.debug("Before ordering effects",[...s]),Ft||(Ft=new Map,Ft.set(q.POSTPROCESSING.MODULE.NormalPass,Yt.NormalPass),Ft.set(q.POSTPROCESSING.MODULE.DepthDownsamplingPass,Yt.DepthDownsamplingPass),Ft.set(q.POSTPROCESSING.MODULE.SMAAEffect,Yt.SMAA),Ft.set(q.POSTPROCESSING.MODULE.SSAOEffect,Yt.SSAO),Ft.set(q.POSTPROCESSING_AO.MODULE.N8AOPostPass,Yt.SSAO),Ft.set(q.POSTPROCESSING_AO.MODULE.N8AOPass,Yt.SSAO),Ft.set(q.POSTPROCESSING.MODULE.TiltShiftEffect,Yt.TiltShift),Ft.set(q.POSTPROCESSING.MODULE.DepthOfFieldEffect,Yt.DepthOfField),Ft.set(q.POSTPROCESSING.MODULE.ChromaticAberrationEffect,Yt.ChromaticAberration),Ft.set(q.POSTPROCESSING.MODULE.BloomEffect,Yt.Bloom),Ft.set(q.POSTPROCESSING.MODULE.SelectiveBloomEffect,Yt.Bloom),Ft.set(q.POSTPROCESSING.MODULE.VignetteEffect,Yt.Vignette),Ft.set(q.POSTPROCESSING.MODULE.PixelationEffect,Yt.Pixelation),Ft.set(q.POSTPROCESSING.MODULE.ToneMappingEffect,Yt.ToneMapping),Ft.set(q.POSTPROCESSING.MODULE.HueSaturationEffect,Yt.HueSaturation),Ft.set(q.POSTPROCESSING.MODULE.BrightnessContrastEffect,Yt.BrightnessContrast)),s.sort((t,e)=>{const i=typeof t.priority=="number"?t.priority:Ft.get(t.effect.constructor)??Number.NEGATIVE_INFINITY,n=typeof e.priority=="number"?e.priority:Ft.get(e.effect.constructor)??Number.NEGATIVE_INFINITY;return i===Number.NEGATIVE_INFINITY?(pu&&console.warn("Unknown effect found: ",t.constructor.name,t),1):n===Number.NEGATIVE_INFINITY?(pu&&console.warn("Unknown effect found: ",e.constructor.name,e),-1):i-n}),pu==="verbose"&&console.debug("After ordering effects",[...s])}var xR=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const tj=k("debugpost");class ne{constructor(t){a(this,"isVolumeParameter",!0);a(this,"_isInitialized",!1);a(this,"_active",!0);a(this,"_value");a(this,"_valueRaw");a(this,"_defaultValue");a(this,"valueProcessor");a(this,"onValueChanged");t!==void 0&&this.initialize(t)}get isInitialized(){return this._isInitialized}initialize(t){t!==void 0&&(this._value=t,this._defaultValue=t,this._valueRaw=t,this._isInitialized=!0)}get overrideState(){return this._active}set overrideState(t){if(this._active===t)return;this._active=t;const e=t?this._valueRaw:this._defaultValue;this.processValue(e,!0)}get value(){return this._valueRaw}set value(t){this.isInitialized||this.initialize(t),this.processValue(t,!1)}set defaultValue(t){this._defaultValue=t}__init(){this.processValue(this._valueRaw,!0)}processValue(t,e){if(t==null||!e&&this.testIfValueChanged(t)===!1)return;const i=this._value;tj&&typeof i=="number"&&typeof t=="number"&&(i==null||i.toFixed(4),t==null||t.toFixed(4)),!this._active&&this._defaultValue!==void 0?(this._value=this._defaultValue,t=this._defaultValue,this._valueRaw=t):(this._valueRaw=t,this._active&&this.valueProcessor&&(t=this.valueProcessor(t)),this._value=t),this.onValueChanged&&this.onValueChanged(t,i,this)}testIfValueChanged(t){return this._valueRaw!==t}}xR([g()],ne.prototype,"overrideState",null);xR([g()],ne.prototype,"value",null);class ij extends Ps{constructor(){super([ne])}onSerialize(t,e){}onDeserialize(t,e){const i=e.target,n=e.path;let o;if(i&&n&&(o=i[n]),(typeof o!="object"||typeof o=="object"&&o.isVolumeParameter!==!0)&&(o=new ne),typeof t=="object"&&"value"in t){const r=t.value;o.initialize(r),o.overrideState=t.overrideState}else o.value=t;return o}}new ij;var nj=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const qb=k("debugpost");class Gt extends W{constructor(e=void 0){super();a(this,"order");a(this,"active",!0);a(this,"_manager",null);a(this,"_result");a(this,"_postprocessingContext",null);if(e)for(const i of Object.keys(e)){const n=e[i],o=this[i];o instanceof ne?o.initialize(n):o!==void 0&&(this[i]=n)}}get isPostProcessingEffect(){return!0}onEnable(){super.onEnable(),qb&&console.warn("Enable",this.constructor.name+(this.__internalDidAwakeAndStart?"":" (awake)")),this.__internalDidAwakeAndStart&&(this.active=!0),this.onEffectEnabled()}onDisable(){var e;super.onDisable(),qb&&console.warn("Disable",this.constructor.name),(e=this._manager)==null||e.removeEffect(this),this.active=!1}onEffectEnabled(e){e&&e.isPostProcessingManager===!0?this._manager=e:this._manager||(this._manager=J3(this)),this._manager.addEffect(this),this._manager.dirty=!0}init(){}get postprocessingContext(){return this._postprocessingContext}apply(e){var i;return this._postprocessingContext=e,this._result||(this.initParameters(),this._result=(i=this.onCreateEffect)==null?void 0:i.call(this)),this._result&&this.initParameters(),this._result}unapply(){}dispose(){qb&&console.warn("DISPOSE",this),this._result&&(Array.isArray(this._result)?this._result.forEach(e=>e.dispose()):this._result.dispose()),this._result=void 0}initParameters(){const e=Object.keys(this);for(const i of e){const n=this[i];n instanceof ne&&n.__init()}}onEditorModification(e){const i=e.propertyName;if(this[i]instanceof ne){const n=e.value;return this[i].value=n,!0}}}nj([g()],Gt.prototype,"active",void 0);var sj=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const oj=k("debugpost"),_0={};function ro(s,t){_0[s]=t}function rj(s){return s.__type in _0?_0[s.__type]:(oj&&s.__type&&console.warn("Unknown postprocessing type",s.__type,s),Gt)}class Nv{constructor(){a(this,"components",[])}__init(t){var e;(e=this.components)==null||e.forEach(i=>{i.gameObject===void 0&&t.gameObject.addComponent(i),i.init()})}addEffect(t){this.components.push(t)}removeEffect(t){const e=this.components.indexOf(t);e>=0&&this.components.splice(e,1)}}sj([Nt([s=>rj(s),Gt])],Nv.prototype,"components",void 0);var aj=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const lj=k("debugpost");var _C;(function(s){s[s.LOW=0]="LOW",s[s.MEDIUM=1]="MEDIUM",s[s.HIGH=2]="HIGH",s[s.ULTRA=3]="ULTRA"})(_C||(_C={}));class ly extends Gt{constructor(){super(...arguments);a(this,"preset",new ne(2))}get typeName(){return"Antialiasing"}onCreateEffect(){var i;const e=new q.POSTPROCESSING.MODULE.SMAAEffect({preset:((i=this.preset)==null?void 0:i.value)??q.POSTPROCESSING.MODULE.SMAAPreset.HIGH,edgeDetectionMode:q.POSTPROCESSING.MODULE.EdgeDetectionMode.LUMA});return this.preset.onValueChanged=n=>{lj&&console.log("Antialiasing preset changed to",n),e.applyPreset(n)},e}}aj([g(ne)],ly.prototype,"preset",void 0);ro("Antialiasing",ly);var zv=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const dx=class extends Gt{constructor(){super(...arguments);a(this,"threshold",new ne(.9));a(this,"intensity",new ne(1));a(this,"scatter",new ne(.7));a(this,"selectiveBloom")}get typeName(){return"Bloom"}init(){this.threshold.valueProcessor=e=>e,this.intensity.valueProcessor=e=>e,this.scatter.valueProcessor=e=>e}onCreateEffect(){let e;if(this.selectiveBloom==null&&(this.selectiveBloom=dx.useSelectiveBloom),this.selectiveBloom){const i=e=new q.POSTPROCESSING.MODULE.SelectiveBloomEffect(this.context.scene,this.context.mainCamera,{blendFunction:q.POSTPROCESSING.MODULE.BlendFunction.ADD,mipmapBlur:!0,luminanceThreshold:this.threshold.value,luminanceSmoothing:this.scatter.value,radius:.85,intensity:this.intensity.value});i.inverted=!0}else e=new q.POSTPROCESSING.MODULE.BloomEffect({blendFunction:q.POSTPROCESSING.MODULE.BlendFunction.ADD,mipmapBlur:!0,luminanceThreshold:this.threshold.value,luminanceSmoothing:this.scatter.value,radius:.85,intensity:this.intensity.value});return this.intensity.onValueChanged=i=>{e.intensity=i},this.threshold.onValueChanged=i=>{e.luminanceMaterial.threshold=Math.pow(i,2.2)},this.scatter.onValueChanged=i=>{e.luminancePass.enabled=!0,e.luminanceMaterial.smoothing=i,e.mipmapBlurPass&&(e.mipmapBlurPass.radius=Ar.lerp(.1,.9,i))},e}};let Br=dx;a(Br,"useSelectiveBloom",!1);zv([g(ne)],Br.prototype,"threshold",void 0);zv([g(ne)],Br.prototype,"intensity",void 0);zv([g(ne)],Br.prototype,"scatter",void 0);ro("Bloom",Br);var cj=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class cy extends Gt{constructor(){super(...arguments);a(this,"intensity",new ne(0))}get typeName(){return"ChromaticAberration"}onCreateEffect(){const e=new q.POSTPROCESSING.MODULE.ChromaticAberrationEffect;return e.offset=new _e(0,0),e.radialModulation=!0,e.modulationOffset=.15,this.intensity.valueProcessor=i=>i*.02,this.intensity.onValueChanged=i=>{e.offset.x=-i,e.offset.y=i},e}}cj([g(ne)],cy.prototype,"intensity",void 0);ro("ChromaticAberration",cy);var Pi;(function(s){s[s.None=0]="None",s[s.Neutral=1]="Neutral",s[s.ACES=2]="ACES",s[s.AgX=3]="AgX",s[s.KhronosNeutral=4]="KhronosNeutral"})(Pi||(Pi={}));const vC=new Map;function Xb(s){switch(s){case Pi.None:return L0;case Pi.Neutral:return I0;case Pi.ACES:return Pg;case Pi.AgX:return Cg;case Pi.KhronosNeutral:return qh;default:return vC.has(s)||(vC.set(s,!0),console.warn("[Postprocessing] Unknown tone mapping mode",s)),qh}}function hj(s){switch(s){case L0:return Pi.None;case Pg:return Pi.ACES;case Cg:return Pi.AgX;case qh:return Pi.Neutral;case I0:return Pi.Neutral;default:return Pi.None}}function fm(s){switch(s){case L0:return q.POSTPROCESSING.MODULE.ToneMappingMode.LINEAR;case Pg:return q.POSTPROCESSING.MODULE.ToneMappingMode.ACES_FILMIC;case Cg:return q.POSTPROCESSING.MODULE.ToneMappingMode.AGX;case qh:return q.POSTPROCESSING.MODULE.ToneMappingMode.NEUTRAL;case I0:return q.POSTPROCESSING.MODULE.ToneMappingMode.REINHARD;default:return q.POSTPROCESSING.MODULE.ToneMappingMode.LINEAR}}var wR=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Qb=k("debugpost");class pc extends Gt{constructor(){super(...arguments);a(this,"mode",new ne(void 0));a(this,"exposure",new ne(1));a(this,"_tonemappingEffect",null)}get typeName(){return"ToneMapping"}setMode(e){const i=Pi[e];return i===void 0?(console.error("[PostProcessing] Invalid ToneMapping mode",e),this):(this.mode.value=i,this)}get isToneMapping(){return!0}onEffectEnabled(){const e=vR(this);e&&super.onEffectEnabled(e)}onCreateEffect(){var n;if(this.mode.isInitialized==!1){const o=hj(this.context.renderer.toneMapping);Qb&&console.log("[PostProcessing] Initializing ToneMapping mode to renderer.toneMapping",this.context.renderer.toneMapping+" ‚Üí "+o),this.mode.initialize(o)}(n=this._tonemappingEffect)==null||n.dispose();const e=Xb(this.mode.value),i=this._tonemappingEffect=new q.POSTPROCESSING.MODULE.ToneMappingEffect({mode:fm(e)});return this.mode.onValueChanged=o=>{if(typeof o=="string")o=mT(o),i.mode=fm(o);else{const r=Xb(o);i.mode=fm(r)}i.name="ToneMapping ("+Pi[o]+")",Qb&&console.log("[PostProcessing] ToneMapping mode changed to",Pi[o],e,i.mode)},Qb&&console.log("[PostProcessing] Use ToneMapping",Pi[this.mode.value],e,i.mode,"renderer.tonemapping: "+this.context.renderer.toneMapping),i}onBeforeRender(){var e;if(this._tonemappingEffect&&((e=this.postprocessingContext)!=null&&e.handler.getEffectIsActive(this._tonemappingEffect))&&(this.mode.overrideState&&(this.context.renderer.toneMapping=Xb(this.mode.value)),this.exposure.overrideState&&this.exposure.value!==void 0)){const i=Math.max(0,this.exposure.value);this.context.renderer.toneMappingExposure=i}}}wR([g(ne)],pc.prototype,"mode",void 0);wR([g(ne)],pc.prototype,"exposure",void 0);ro("Tonemapping",pc);var hy=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class kc extends Gt{constructor(){super(...arguments);a(this,"remap",!0);a(this,"postExposure",new ne(1));a(this,"contrast",new ne(0));a(this,"hueShift",new ne(0));a(this,"saturation",new ne(0))}get typeName(){return"ColorAdjustments"}init(){this.postExposure.valueProcessor=e=>(this.remap&&(e=Math.pow(2,e)),e),this.contrast.valueProcessor=e=>{if(!this.remap)return e;let i=1;return e>0?i=200:e<0&&(i=100),e/i},this.contrast.defaultValue=0,this.hueShift.valueProcessor=e=>this.remap?Math.PI*e/180:e,this.hueShift.defaultValue=0,this.saturation.valueProcessor=e=>this.remap?e<0?e/100:e/(100*Math.PI):e,this.saturation.defaultValue=0}onCreateEffect(){var r,l;const e=[];let i=(r=this.postprocessingContext)==null?void 0:r.components.find(c=>c instanceof pc);i||(i=new pc,(l=this.postprocessingContext)==null||l.components.push(i)),this.postExposure.onValueChanged=c=>{this.postExposure.overrideState&&i?i.exposure.value=c:console.warn("[PostProcessing] PostExposure is set to override but no ToneMappingEffect found in the postprocessing stack. Please add a ToneMappingEffect to your postprocessing stack to use PostExposure.")};const n=new q.POSTPROCESSING.MODULE.BrightnessContrastEffect;this.contrast.onValueChanged=c=>n.contrast=c;const o=new q.POSTPROCESSING.MODULE.HueSaturationEffect;return this.hueShift.onValueChanged=c=>o.hue=c,this.saturation.onValueChanged=c=>o.saturation=c,e.push(n),e.push(o),e}}hy([g(ne)],kc.prototype,"postExposure",void 0);hy([g(ne)],kc.prototype,"contrast",void 0);hy([g(ne)],kc.prototype,"hueShift",void 0);hy([g(ne)],kc.prototype,"saturation",void 0);ro("ColorAdjustments",kc);var Ec=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},v0;(function(s){s[s.Off=0]="Off",s[s.Gaussian=1]="Gaussian",s[s.Bokeh=2]="Bokeh"})(v0||(v0={}));const dj=k("debugpost");class nr extends Gt{constructor(){super(...arguments);a(this,"mode");a(this,"focusDistance",new ne(1));a(this,"focalLength",new ne(.2));a(this,"aperture",new ne(20));a(this,"gaussianMaxRadius",new ne);a(this,"resolutionScale",new ne(1*1/window.devicePixelRatio));a(this,"bokehScale",new ne)}get typeName(){return"DepthOfField"}init(){this.focalLength.valueProcessor=i=>{const n=i/300,o=2;return ee.lerp(o,.01,n)};const e=20;this.aperture.valueProcessor=i=>{const n=1-i/32;return ee.lerp(1,e,n)}}onCreateEffect(){if(this.mode===v0.Off){dj&&console.warn("DepthOfField: Mode is set to Off");return}const e=new q.POSTPROCESSING.MODULE.DepthOfFieldEffect(this.context.mainCamera,{worldFocusRange:.2,focalLength:1,bokehScale:20,resolutionScale:this.resolutionScale.value});return this.focusDistance.onValueChanged=i=>{e.cocMaterial.worldFocusDistance=i},this.focalLength.onValueChanged=i=>e.cocMaterial.worldFocusRange=i,this.aperture.onValueChanged=i=>e.bokehScale=i,this.resolutionScale&&(this.resolutionScale.onValueChanged=i=>e.resolution.scale=i),[e]}unapply(){}}Ec([g()],nr.prototype,"mode",void 0);Ec([g(ne)],nr.prototype,"focusDistance",void 0);Ec([g(ne)],nr.prototype,"focalLength",void 0);Ec([g(ne)],nr.prototype,"aperture",void 0);Ec([g(ne)],nr.prototype,"gaussianMaxRadius",void 0);Ec([g(ne)],nr.prototype,"resolutionScale",void 0);Ec([g(ne)],nr.prototype,"bokehScale",void 0);ro("DepthOfField",nr);class eg extends Gt{constructor(e){super();a(this,"effect");this.effect=e}get typeName(){return this.effect.constructor.name}onCreateEffect(){return this.effect}}var uj=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class dy extends Gt{constructor(){super(...arguments);a(this,"granularity",new ne(10))}get typeName(){return"PixelationEffect"}onCreateEffect(){const e=new q.POSTPROCESSING.MODULE.PixelationEffect;return this.granularity.onValueChanged=i=>{e.granularity=i},e}}uj([g(ne)],dy.prototype,"granularity",void 0);ro("PixelationEffect",dy);var qf=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class ol extends Gt{constructor(){super(...arguments);a(this,"intensity",new ne(2));a(this,"falloff",new ne(1));a(this,"samples",new ne(9));a(this,"color",new ne(new Se(0,0,0)));a(this,"luminanceInfluence",new ne(.7));a(this,"_ssao")}get typeName(){return"ScreenSpaceAmbientOcclusion"}onBeforeRender(){if(this._ssao&&this.context.mainCamera instanceof Ae){const e=this.context.mainCamera.far-this.context.mainCamera.near;this._ssao.ssaoMaterial.worldDistanceFalloff=e*.01,this._ssao.ssaoMaterial.worldDistanceThreshold=this.context.mainCamera.far}}onCreateEffect(){const e=this.context.mainCamera,i=new q.POSTPROCESSING.MODULE.NormalPass(this.context.scene,e),n=new q.POSTPROCESSING.MODULE.DepthDownsamplingPass({normalBuffer:i.texture,resolutionScale:.5}),o=this._ssao=new q.POSTPROCESSING.MODULE.SSAOEffect(e,i.texture,{normalDepthBuffer:n.texture,worldDistanceThreshold:1,worldDistanceFalloff:1,worldProximityThreshold:.1,worldProximityFalloff:2,intensity:1,blendFunction:q.POSTPROCESSING.MODULE.BlendFunction.MULTIPLY,luminanceInfluence:.5});this.intensity.onValueChanged=l=>{o.intensity=l},this.falloff.onValueChanged=l=>{o.ssaoMaterial.radius=l*.1},this.samples.onValueChanged=l=>{o.ssaoMaterial.samples=l},this.color.onValueChanged=l=>{o.color||(o.color=new Se),o.color.copy(l)},this.luminanceInfluence.onValueChanged=l=>{o.luminanceInfluence=l};const r=new Array;return r.push(i),r.push(n),r.push(o),r}}qf([g(ne)],ol.prototype,"intensity",void 0);qf([g(ne)],ol.prototype,"falloff",void 0);qf([g(ne)],ol.prototype,"samples",void 0);qf([g(ne)],ol.prototype,"color",void 0);qf([g(ne)],ol.prototype,"luminanceInfluence",void 0);ro("ScreenSpaceAmbientOcclusion",ol);var Mc=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const fj=k("debugN8AO");var zu;(function(s){s[s.Performance=0]="Performance",s[s.Low=1]="Low",s[s.Medium=2]="Medium",s[s.High=3]="High",s[s.Ultra=4]="Ultra"})(zu||(zu={}));class sr extends Gt{constructor(){super(...arguments);a(this,"gammaCorrection",!0);a(this,"aoRadius",new ne(1));a(this,"falloff",new ne(1));a(this,"intensity",new ne(1));a(this,"color",new ne(new Se(0,0,0)));a(this,"screenspaceRadius",!1);a(this,"quality",zu.Medium);a(this,"_ssao")}get typeName(){return"ScreenSpaceAmbientOcclusionN8"}get pass(){return this._ssao}onValidate(){this._ssao&&(this._ssao.setQualityMode(zu[this.quality]),this._ssao.configuration.gammaCorrection=this.gammaCorrection,this._ssao.configuration.screenSpaceRadius=this.screenspaceRadius)}onCreateEffect(){const e=this.context.mainCamera,i=this.context.domWidth,n=this.context.domHeight,o=this._ssao=new q.POSTPROCESSING_AO.MODULE.N8AOPostPass(this.context.scene,e,i,n);o.name="SSAO_N8";const r=zu[this.quality];o.setQualityMode(r),o.configuration.transparencyAware=!1;const l=new Qo(i,n);return o.configuration.beautyRenderTarget=l,o.configuration.autoRenderBeauty=!1,o.configuration.gammaCorrection=this.gammaCorrection,o.configuration.screenSpaceRadius=this.screenspaceRadius,fj&&(o.enableDebugMode(),console.log(o),setInterval(()=>{console.log("SSAO",o.lastTime)},1e3),setInterval(()=>{console.log("SSAO",o.enabled,{ssao:o,autoRenderBeauty:o.configuration.autoRenderBeauty})},4e3)),this.intensity.onValueChanged=c=>{o.configuration.intensity=c},this.falloff.onValueChanged=c=>{o.configuration.distanceFalloff=c},this.aoRadius.onValueChanged=c=>{o.configuration.aoRadius=c},this.color.onValueChanged=c=>{o.color||(o.color=new Se),o.configuration.color.copy(c)},o}}Mc([en(),g()],sr.prototype,"gammaCorrection",void 0);Mc([g(ne)],sr.prototype,"aoRadius",void 0);Mc([g(ne)],sr.prototype,"falloff",void 0);Mc([g(ne)],sr.prototype,"intensity",void 0);Mc([g(ne)],sr.prototype,"color",void 0);Mc([en(),g()],sr.prototype,"screenspaceRadius",void 0);Mc([en(),g()],sr.prototype,"quality",void 0);ro("ScreenSpaceAmbientOcclusionN8",sr);var SR=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class uy extends Gt{constructor(){super(...arguments);a(this,"order",Yt.Sharpening);a(this,"_effect");a(this,"_amount",1);a(this,"_radius",1)}get typeName(){return"Sharpening"}onCreateEffect(){return this._effect??(this._effect=new(pj())),this.effect}get effect(){return this._effect}set amount(e){this._amount=e,this._effect&&(this._effect.uniforms.get("amount").value=e)}get amount(){return this._effect?this._effect.uniforms.get("amount").value:this._amount}set radius(e){this._radius=e,this._effect&&(this._effect.uniforms.get("radius").value=e)}get radius(){return this._effect?this._effect.uniforms.get("radius").value:this._radius}}SR([g()],uy.prototype,"amount",null);SR([g()],uy.prototype,"radius",null);function pj(){const s=`
      void mainSupport() {
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    `,t=`
    uniform sampler2D tDiffuse;
    uniform float amount;
    uniform float radius;
    
    void mainImage(const in vec4 inputColor, const in vec2 uv, out vec4 outputColor) {
        float tx = 1.0 / resolution.x;
        float ty = 1.0 / resolution.y;
        vec2 texelSize = vec2(tx, ty);
    
        vec4 blurred = vec4(0.0);
        float total = 0.0;
    
        for (float x = -radius; x <= radius; x++) {
            for (float y = -radius; y <= radius; y++) {
                vec2 offset = vec2(x, y) * texelSize;
                vec4 diffuse = texture2D(tDiffuse, uv + offset);
                float weight = exp(-length(offset) * amount);
                blurred += diffuse * weight;
                total += weight;
            }
        }
    
        if (total > 0.0) {
            blurred /= total;
        }
    
        // Calculate the sharpened color using inputColor
        vec4 sharp = inputColor + clamp(inputColor - blurred, 0.0, 1.0) * amount;
        // Keep original alpha
        sharp.a = inputColor.a;
    
        // Ensure the sharp color does not go below 0 or above 1
        // This means: sharpening must happen AFTER tonemapping.
        sharp = clamp(sharp, 0.0, 1.0);
    
        outputColor = sharp;
    }
    
    `;class e extends q.POSTPROCESSING.MODULE.Effect{constructor(){super("Sharpening",t,{vertexShader:s,blendFunction:q.POSTPROCESSING.MODULE.BlendFunction.NORMAL,uniforms:new Map([["amount",new ys(1)],["radius",new ys(1)]]),attributes:lE.CONVOLUTION})}}return e}var Sd=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class ia extends Gt{constructor(){super(...arguments);a(this,"offset",new ne(0));a(this,"rotation",new ne(0));a(this,"focusArea",new ne(.4));a(this,"feather",new ne(.3));a(this,"kernelSize",new ne(2));a(this,"resolutionScale",new ne(1/window.devicePixelRatio))}get typeName(){return"TiltShiftEffect"}init(){this.offset.defaultValue=0,this.rotation.defaultValue=0,this.focusArea.defaultValue=.4,this.feather.defaultValue=.3,this.kernelSize.defaultValue=q.POSTPROCESSING.MODULE.KernelSize.MEDIUM,this.resolutionScale.defaultValue=1/window.devicePixelRatio}onCreateEffect(){const e=new q.POSTPROCESSING.MODULE.TiltShiftEffect({kernelSize:q.POSTPROCESSING.MODULE.KernelSize.VERY_LARGE,offset:this.offset.value,rotation:this.rotation.value,focusArea:this.focusArea.value,feather:this.feather.value});return this.offset.onValueChanged=i=>e.offset=i,this.rotation.onValueChanged=i=>e.rotation=i,this.focusArea.onValueChanged=i=>e.focusArea=i,this.feather.onValueChanged=i=>e.feather=i,this.kernelSize.onValueChanged=i=>e.blurPass.kernelSize=i,this.resolutionScale.onValueChanged=i=>e.resolution.scale=i/window.devicePixelRatio,e}}Sd([g(ne)],ia.prototype,"offset",void 0);Sd([g(ne)],ia.prototype,"rotation",void 0);Sd([g(ne)],ia.prototype,"focusArea",void 0);Sd([g(ne)],ia.prototype,"feather",void 0);Sd([g(ne)],ia.prototype,"kernelSize",void 0);Sd([g(ne)],ia.prototype,"resolutionScale",void 0);ro("TiltShiftEffect",ia);var $v=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Cd extends Gt{constructor(){super(...arguments);a(this,"color",new ne({r:0,g:0,b:0,a:1}));a(this,"intensity",new ne(0));a(this,"center",new ne({x:.5,y:.5}))}get typeName(){return"Vignette"}init(){this.color.defaultValue={r:0,g:0,b:0,a:1},this.intensity.defaultValue=0,this.center.defaultValue={x:.5,y:.5}}onCreateEffect(){const e=new q.POSTPROCESSING.MODULE.VignetteEffect;return this.intensity.onValueChanged=i=>{e.offset=i,this.updateDarkness(e)},this.color.onValueChanged=i=>{this.updateDarkness(e)},e}updateDarkness(e){const i=this.intensity.value;e.darkness=i}}$v([g(ne)],Cd.prototype,"color",void 0);$v([g(ne)],Cd.prototype,"intensity",void 0);$v([g(ne)],Cd.prototype,"center",void 0);ro("Vignette",Cd);globalThis.true=globalThis.true!==void 0?globalThis.true:!0;const po=k("debugpost"),Yb=Symbol("needle:postprocessing-handler"),Xd=Symbol("needle:previous-autoclear-state"),Qd=Symbol("needle:previous-tone-mapping");class CR{constructor(t){a(this,"_composer",null);a(this,"_lastVolumeComponents");a(this,"_effects",[]);a(this,"_isActive",!1);a(this,"context");a(this,"_anyPassHasDepth",!1);a(this,"_anyPassHasNormal",!1);a(this,"_hasSmaaEffect",!1);a(this,"_customInputBuffer",null);a(this,"_customInputBufferId",0);a(this,"_multisampling",0);a(this,"_menuEntry",null);a(this,"_passIndices",null);this.context=t}getEffectIsActive(t){return t?this._isActive&&this._effects.some(e=>e.effect===t):!1}get isActive(){return this._isActive}get composer(){return this._composer}apply(t){return"env"in import.meta&&{}.VITE_NEEDLE_USE_POSTPROCESSING==="false"?(po?console.warn("Postprocessing is disabled via vite env setting"):console.debug("Postprocessing is disabled via vite env setting"),Promise.resolve()):(this._isActive=!0,this.onApply(this.context,t))}unapply(t=!0){var n,o;if(po&&console.log("Unapplying postprocessing effects"),this._isActive=!1,this._lastVolumeComponents){for(const r of this._lastVolumeComponents)r.unapply();this._lastVolumeComponents.length=0}const e=this.context;e[Yb]===this&&(delete e[Yb],typeof e.renderer[Xd]=="boolean"&&(e.renderer.autoClear=e.renderer[Xd]),typeof e.renderer[Qd]=="number"&&(e.renderer.toneMapping=e.renderer[Qd])),(n=this._composer)==null||n.removeAllPasses(),t&&((o=this._composer)==null||o.dispose()),e.composer===this._composer&&(e.composer=null),this.handleDevicePixelRatio()}dispose(){this.unapply(!0);for(const t of this._effects)t.effect.dispose();this._effects.length=0,this._composer=null}async onApply(t,e){if(!e)return;await Promise.all([q.POSTPROCESSING.load(),q.POSTPROCESSING_AO.load()]),t[Yb]=this,po&&console.log("Apply Postprocessing Effects",e),this._lastVolumeComponents=[...e],this._effects.length=0;const i={handler:this,components:this._lastVolumeComponents};for(let n=0;n<this._lastVolumeComponents.length;n++){const o=this._lastVolumeComponents[n];if(o.context=t,o.apply){if(o.active){let c=function(h,d){return d?(d instanceof q.POSTPROCESSING.MODULE.Effect||d instanceof q.POSTPROCESSING.MODULE.Pass||console.warn(`PostprocessingEffect ${h} created neither Effect nor Pass - this might be caused by a bundler error or false import. Below you find some possible solutions:
- If you create custom effect try creating it like this: 'new NEEDLE_ENGINE_MODULES.POSTPROCESSING.MODULE.Effect(...)' instead of 'new Effect(...)'`),!0):!1};if(!t.mainCameraComponent){console.error("No camera in scene found or available yet - can not create postprocessing effects");return}const r=o.apply(i);if(!r)continue;const l=o.typeName||o.constructor.name;if(Array.isArray(r))for(const h of r)c(l,h)&&this._effects.push({effect:h,typeName:o.typeName,priority:o.order});else{if(!c(l,r))continue;this._effects.push({effect:r,typeName:o.typeName,priority:o.order})}}}else o.active&&qe("Volume component is not a VolumeComponent: "+o.__type)}this.applyEffects(t)}get anyPassHasDepth(){return this._anyPassHasDepth}get anyPassHasNormal(){return this._anyPassHasNormal}get hasSmaaEffect(){return this._hasSmaaEffect}set multisampling(t){this._multisampling=t}get multisampling(){return this._multisampling}applyEffects(t){var d;if(this._anyPassHasDepth=!1,this._anyPassHasNormal=!1,this._hasSmaaEffect=!1,this._effects.length<=0)return;const e=t.mainCameraComponent,i=t.renderer,n=t.scene,o=e.threeCamera;if(typeof i[Xd]=="boolean"&&(i.autoClear=i[Xd]),i[Xd]=i.autoClear,typeof i[Qd]=="number"&&(i.toneMapping=i[Qd]),i[Qd]=i.toneMapping,i.toneMapping!=gm&&!this._effects.find(u=>u instanceof q.POSTPROCESSING.MODULE.ToneMappingEffect)){const u=new q.POSTPROCESSING.MODULE.ToneMappingEffect;u.name=`ToneMapping (${i.toneMapping})`,u.mode=fm(i.toneMapping),this._effects.push({typeName:"ToneMapping",effect:u,priority:Yt.ToneMapping})}this._composer||(this._composer=new q.POSTPROCESSING.MODULE.EffectComposer(i,{frameBufferType:Ny,stencilBuffer:!0})),t.composer&&t.composer!==this._composer&&console.warn("There's already an active EffectComposer in your scene: replacing it with a new one. This might cause unexpected behaviour. Make sure to only use one PostprocessingManager/Volume in your scene."),t.composer=this._composer;const r=t.composer;r.setMainCamera(o),r.setRenderer(i),r.setMainScene(n),r.autoRenderToScreen=!0,r.multisampling=0;for(const u of r.passes)u.dispose();r.removeAllPasses();const l=new q.POSTPROCESSING.MODULE.RenderPass(n,o);l.name="RenderPass",l.mainScene=n,r.addPass(l);const c=l.render;(d=this._customInputBuffer)==null||d.dispose(),this._customInputBuffer=null,l.render=(u,f,p,b,x)=>{var v;f&&(f.samples=0,p&&(p.samples=0),(!this._customInputBuffer||this._customInputBuffer.width!==f.width||this._customInputBuffer.height!==f.height||this._customInputBuffer.samples!==this._multisampling||this._customInputBuffer.texture.format!==f.texture.format||this._customInputBuffer.texture.type!==Ny)&&((v=this._customInputBuffer)==null||v.dispose(),this._customInputBuffer=new Qo(f.width,f.height,{format:f.texture.format,type:Ny,depthBuffer:f.depthBuffer,depthTexture:f.depthTexture?new YC(f.width,f.height):void 0,stencilBuffer:f.stencilBuffer,samples:Math.max(0,this._multisampling),minFilter:f.texture.minFilter??bm,magFilter:f.texture.magFilter??bm,generateMipmaps:f.texture.generateMipmaps}),this._customInputBufferId++,this._customInputBuffer.texture.name=`CustomInputBuffer-${this._customInputBufferId}`,this._customInputBuffer.depthTexture&&f.depthTexture&&(this._customInputBuffer.depthTexture.format=f.depthTexture.format,this._customInputBuffer.depthTexture.type=f.depthTexture.type),this._customInputBuffer.samples>0&&(this._customInputBuffer.ignoreDepthForMultisampleCopy=!1),po&&console.warn(`[PostProcessing] Input buffer created with size ${this._customInputBuffer.width}x${this._customInputBuffer.height} and samples ${this._customInputBuffer.samples}`)),c.call(l,u,this._customInputBuffer,p,b,x),Fn.blit(this._customInputBuffer.texture,f,{renderer:u,depthTexture:this._customInputBuffer.depthTexture,depthWrite:!0,depthTest:!0}))};try{ej(this._effects);let u=!1,f=null;for(let x=this._effects.length-1;x>=0;x--){const v=this._effects[x].effect;if(v instanceof q.POSTPROCESSING.MODULE.ToneMappingEffect){if(u){po&&console.warn(`[PostProcessing] Found multiple tonemapping effects in the scene: ${v.name} and ${f==null?void 0:f.name}. Only the last one added will be used.`),this._effects.splice(x,1);continue}f=v,u=!0}}const p=[];let b=!1;for(let x=0;x<this._effects.length;x++){const S=this._effects[x].effect;if(S instanceof q.POSTPROCESSING.MODULE.SMAAEffect?this._hasSmaaEffect=!0:S instanceof q.POSTPROCESSING.MODULE.NormalPass&&(this._anyPassHasNormal=!0),!(S instanceof q.POSTPROCESSING.MODULE.ToneMappingEffect&&f!==S))if(S instanceof q.POSTPROCESSING.MODULE.Effect){const C=S.getAttributes(),P=q.POSTPROCESSING.MODULE.EffectAttribute.CONVOLUTION;C&P&&(po&&console.log("[PostProcessing] Convolution effect: "+S.name),b&&(po&&console.log("[PostProcessing] ‚Üí Merging effects ["+p.map(E=>E.name).join(", ")+"]"),this.createPassForMergeableEffects(p,r,o,n)),b=!0),p.push(S)}else S instanceof q.POSTPROCESSING.MODULE.Pass?(b=!1,this.createPassForMergeableEffects(p,r,o,n),S.renderToScreen=!1,r.addPass(S)):(b=!1,this.createPassForMergeableEffects(p,r,o,n),r.addPass(S))}this.createPassForMergeableEffects(p,r,o,n)}catch(u){console.error("Error while applying postprocessing effects",u),r.passes.forEach(f=>f.dispose()),r.removeAllPasses()}let h=!1;for(let u=r.passes.length-1;u>=0;u--){const f=r.passes[u];let p=!1,b=!1;f.enabled&&(h||(p=!0,b=!0),h=!0),f.renderToScreen=b,(f==null?void 0:f.configuration)!==void 0?f.configuration.gammaCorrection=p:"autosetGamma"in f&&(f.autosetGamma=p),this._anyPassHasDepth||(this._anyPassHasDepth=f.needsDepthTexture)}this.handleDevicePixelRatio(),po&&console.log("[PostProcessing] Passes ‚Üí",[...r.passes],`
---------------------------------
‚Ä¢ `+r.passes.map(u=>u.name||u.constructor.name+"*").join(`
‚Ä¢ `)+`
`),po&&this._onCreateEffectsDebug(this._composer,o)}createPassForMergeableEffects(t,e,i,n){if(t.length>0){const o=new q.POSTPROCESSING.MODULE.EffectPass(i,...t);o.name=t.map(r=>r.name).join(", "),o.mainScene=n,o.enabled=!0,o.renderToScreen=!1,e.addPass(o),t.length=0}}handleDevicePixelRatio(){typeof this.context.devicePixelRatio=="number"&&this.context.requestSizeUpdate()}_onCreateEffectsDebug(t,e){if(po==="passes"){const i=new q.POSTPROCESSING.MODULE.DepthEffect({blendFunction:q.POSTPROCESSING.MODULE.BlendFunction.NORMAL,inverted:!0});i.name="Depth Effect";const n=new q.POSTPROCESSING.MODULE.EffectPass(e,i);if(n.name="Depth Effect Pass",n.enabled=!1,t.passes.push(n),this._passIndices!==null){const r=[t.passes[0]];this._passIndices.length>0&&r.push(...this._passIndices.filter(l=>l!==0).map(l=>t.passes[l]).filter(l=>l)),r.length>0&&console.log("[PostProcessing] Passes (selected) ‚Üí",r),t.passes.length=0;for(const l of r)l.enabled=!0,l.renderToScreen=!1,t.addPass(l)}const o=this.context.menu;if(o&&this._passIndices===null){this._menuEntry&&this._menuEntry.remove();const r=document.createElement("select");r.multiple=!0;const l=document.createElement("option");l.innerText="Final Output",l.value="-1",r.appendChild(l);for(const c of t.passes){const h=document.createElement("option");h.innerText=c.name,h.value=`${t.passes.indexOf(c)}`,h.title=c.name,r.appendChild(h)}o.appendChild(r),this._menuEntry=r,r.addEventListener("change",()=>{const c=Array.from(r.selectedOptions).map(h=>parseInt(h.value));c.length===1&&c[0]===-1?this._passIndices=null:this._passIndices=c,this.applyEffects(this.context)})}}}}var PR=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const kl=k("debugpost");class Xf extends W{constructor(){super(...arguments);a(this,"sharedProfile");a(this,"multisampling","auto");a(this,"_postprocessing");a(this,"_activeEffects",[]);a(this,"_effects",[]);a(this,"_componentEnabledTime",-1);a(this,"_multisampleAutoChangeTime",0);a(this,"_multisampleAutoDecreaseTime",0);a(this,"_lastApplyTime");a(this,"_rapidApplyCount",0);a(this,"_isDirty",!1);a(this,"_modificationQueue");a(this,"_recreateId",-1)}get isPostProcessingManager(){return!0}get effects(){return this._activeEffects}get dirty(){return this._isDirty}set dirty(e){this._isDirty=e}addEffect(e){let i=e;return i instanceof Gt||(i=new eg(i),typeof e.order=="number"&&(i.order=e.order)),i.gameObject===void 0&&this.gameObject.addComponent(i),this._effects.includes(i)||(this._effects.push(i),this._isDirty=!0),e}removeEffect(e){var n,o,r,l;let i=-1;if(e instanceof Gt?i=this._effects.indexOf(e):i=this._effects.findIndex(c=>c instanceof eg&&c.effect===e),i!==-1)return this._effects.splice(i,1),this._isDirty=!0,e;if(e instanceof Gt){const c=(o=(n=this.sharedProfile)==null?void 0:n.components)==null?void 0:o.indexOf(e);c!==void 0&&c!==-1&&(this._isDirty=!0,(l=(r=this.sharedProfile)==null?void 0:r.components)==null||l.splice(c,1))}return e}markDirty(){this._isDirty=!0}awake(){var e;kl&&(console.log("PostprocessingManager Awake",this),console.log("Press P to toggle post processing"),window.addEventListener("keydown",i=>{i.key==="p"&&(this.enabled=!this.enabled,at("Toggle PostProcessing "+this.name+": Enabled="+this.enabled),this.markDirty())})),(e=this.sharedProfile)==null||e.__init(this)}onEnable(){this._componentEnabledTime=this.context.time.realtimeSinceStartup,this._isDirty=!0}onDisable(){var e;(e=this._postprocessing)==null||e.unapply(),this._isDirty=!1}onBeforeRender(){if(!this.context.isInXR&&(this.context.mainCamera&&this._isDirty&&this.apply(),this.context.composer&&this._postprocessing&&this._postprocessing.composer===this.context.composer)){if(this.context.renderer.getContext().isContextLost()&&this.context.renderer.forceContextRestore(),this.context.composer.getRenderer()!==this.context.renderer&&this.context.composer.setRenderer(this.context.renderer),this.context.composer.setMainScene(this.context.scene),this.multisampling==="auto")if(this._postprocessing&&this._postprocessing.hasSmaaEffect)this._postprocessing.multisampling!==0&&(this._postprocessing.multisampling=0,(kl||X())&&console.log(`[PostProcessing] multisampling is disabled because it's set to 'auto' on your PostprocessingManager/Volume component that also has an SMAA effect.

If you need multisampling consider changing 'auto' to a fixed value (e.g. 4).`));else{const e=this.context.time.realtimeSinceStartup-this._multisampleAutoChangeTime;if(this.context.time.realtimeSinceStartup-this._componentEnabledTime>2&&e>.5){const i=this._postprocessing.multisampling;if(this._postprocessing.multisampling>0&&this.context.time.smoothedFps<=50){this._multisampleAutoChangeTime=this.context.time.realtimeSinceStartup,this._multisampleAutoDecreaseTime=this.context.time.realtimeSinceStartup;let n=this._postprocessing.multisampling*.5;n=Math.floor(n),n!=this._postprocessing.multisampling&&(this._postprocessing.multisampling=n),kl&&console.debug(`[PostProcessing] Reduced multisampling from ${i} to ${this._postprocessing.multisampling}`)}else if(e>1&&this.context.time.smoothedFps>=59&&this._postprocessing.multisampling<this.context.renderer.capabilities.maxSamples&&this.context.time.realtimeSinceStartup-this._multisampleAutoDecreaseTime>10){this._multisampleAutoChangeTime=this.context.time.realtimeSinceStartup;let n=this._postprocessing.multisampling<=0?1:this._postprocessing.multisampling*2;n=Math.floor(n),n!==this._postprocessing.multisampling&&(this._postprocessing.multisampling=n),kl&&console.debug(`[PostProcessing] Increased multisampling from ${i} to ${this._postprocessing.multisampling}`)}}}else{const e=Math.max(0,Math.min(this.multisampling,this.context.renderer.capabilities.maxSamples));e!==this._postprocessing.multisampling&&(this._postprocessing.multisampling=e)}if(this.context.mainCamera){const e=this.context.composer.passes;for(const i of e)if(i.mainCamera&&i.mainCamera!==this.context.mainCamera){this.context.composer.setMainCamera(this.context.mainCamera);break}}}}onDestroy(){var e;(e=this._postprocessing)==null||e.dispose()}apply(){var e,i,n;if(kl&&console.log(`Apply PostProcessing "${this.name||"unnamed"}"`),X()&&(this._lastApplyTime!==void 0&&Date.now()-this._lastApplyTime<100&&(this._rapidApplyCount++,this._rapidApplyCount===5&&console.warn("Detected rapid post processing modifications - this might be a bug",this)),this._lastApplyTime=Date.now()),this._isDirty=!1,this._activeEffects.length=0,(e=this.sharedProfile)!=null&&e.components){const o=this.sharedProfile.components;for(const r of o)r.active&&r.enabled&&!this._activeEffects.includes(r)&&this._activeEffects.push(r)}for(const o of this._effects)o.active&&o.enabled&&!this._activeEffects.includes(o)&&this._activeEffects.push(o);this._activeEffects.length>0?(this._postprocessing||(this._postprocessing=new CR(this.context)),(i=this._postprocessing.apply(this._activeEffects))==null||i.then(()=>{this.activeAndEnabled&&(this._applyPostQueue(),this._postprocessing?(this.multisampling==="auto"?this._postprocessing.multisampling=Q.isMobileDevice()?2:4:this._postprocessing.multisampling=Math.max(0,Math.min(this.multisampling,this.context.renderer.capabilities.maxSamples)),kl&&console.debug(`[PostProcessing] Set multisampling to ${this._postprocessing.multisampling} (Is Mobile: ${Q.isMobileDevice()})`)):kl&&console.warn("[PostProcessing] No composer found"))})):(n=this._postprocessing)==null||n.unapply(!1)}_applyPostQueue(){if(this._modificationQueue){for(const e of this._modificationQueue.values())this.onEditorModification(e);this._modificationQueue.clear()}}onEditorModification(e){var i,n;if(e.propertyName.startsWith("postprocessing.")){if(!this._postprocessing)return this._modificationQueue||(this._modificationQueue=new Map),this._modificationQueue.set(e.propertyName,e),!0;if(!((i=this._activeEffects)!=null&&i.length))return;const o=e.propertyName.split(".");if(o.length===3||o.length===4){const r=o[1],l=o[2];for(const c of this._activeEffects)if(((n=c.typeName)==null?void 0:n.toLowerCase())===r.toLowerCase()){if(l==="active"){c.active=e.value,this.scheduleRecreate();return}if(!Gp.has(r)){const h=new Array;Gp.set(r,h);const d=Object.keys(c);for(const u of d)c[u]instanceof ne&&h.push(u)}if(Gp.has(r)){const h=l.toLowerCase(),d=Gp.get(r);for(const u of d)if(u.toLowerCase()===h){const f=c[u];f instanceof ne&&(o.length===4&&o[3]==="active"?(f.overrideState=e.value,this.scheduleRecreate()):f&&f.value!==void 0&&(f.value=e.value));return}}console.warn("Unknown modification",l);return}}return!0}return!1}scheduleRecreate(){const e=++this._recreateId;setTimeout(()=>{e===this._recreateId&&(this.onDisable(),this.onEnable())},200)}}PR([Nt(Nv)],Xf.prototype,"sharedProfile",void 0);PR([Nt()],Xf.prototype,"multisampling",void 0);const Gp=new Map;Z3(Xf);async function Vv(s){const{NeedleEngineWebComponent:t}=await qs(()=>Promise.resolve().then(()=>SF),void 0,import.meta.url);t.observedAttributes.includes(s)||t.observedAttributes.push(s)}var di=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Jt=k("debugsceneswitcher"),mj=k("sceneswitcher:clearscene"),pm="scene";Vv(pm);const fa=Promise.resolve(!1);class $t extends W{constructor(){super(...arguments);a(this,"autoLoadFirstScene",!0);a(this,"scenes",[]);a(this,"loadingScene");a(this,"queryParameterName","scene");a(this,"useSceneName",!0);a(this,"clamp",!0);a(this,"useHistory",!0);a(this,"useKeyboard",!0);a(this,"useSwipe",!0);a(this,"useSceneLighting",!0);a(this,"useSceneBackground",!0);a(this,"preloadNext",1);a(this,"preloadPrevious",1);a(this,"preloadConcurrent",2);a(this,"createMenuButtons",!1);a(this,"sceneLoadingStart",new je);a(this,"sceneLoadingProgress",new je);a(this,"sceneLoaded",new je);a(this,"_currentIndex",-1);a(this,"_currentScene");a(this,"_currentSceneAsset");a(this,"_engineElementOverserver");a(this,"_preloadScheduler");a(this,"_menuButtons");a(this,"__lastSwitchScene");a(this,"__lastSwitchScenePromise");a(this,"onPopState",async e=>{if(!this.useHistory)return;const i=this.useHistory;try{this.useHistory=!1;let n=!1;if(this.queryParameterName&&(n=await this.tryLoadFromQueryParam()),!n){const o=e==null?void 0:e.state;if(o&&o.startsWith(this.guid)){const r=o.substr(this.guid.length+2);Jt&&console.log("PopState",r),await this.trySelectSceneFromValue(r)}}}finally{this.useHistory=i}});a(this,"normalizedSwipeThresholdX",.1);a(this,"_didSwipe",!1);a(this,"onInputPointerMove",e=>{if(this.useSwipe&&!this._didSwipe&&e.button===0&&e.pointerType==="touch"&&this.context.input.getPointerPressedCount()===1){const i=this.context.input.getPointerPositionDelta(e.button);if(i){const n=i.x/this.context.domWidth;n>=this.normalizedSwipeThresholdX?(this._didSwipe=!0,this.selectPrev()):n<=-this.normalizedSwipeThresholdX&&(this._didSwipe=!0,this.selectNext())}}});a(this,"onInputPointerUp",e=>{e.button===0&&(this._didSwipe=!1)});a(this,"onInputKeyDown",e=>{if(!this.useKeyboard||!this.scenes)return;const i=e.key.toLowerCase();if(!i)return;const n=parseInt(i)-1;if(n>=0){this.trySelectSceneFromValue(n);return}switch(i){case"arrowright":case"d":this.selectNext();break;case"arrowleft":case"a":this.selectPrev();break}});a(this,"_currentlyLoadingScene");a(this,"_lastLoadingScene");a(this,"_loadingScenePromise");a(this,"_isCurrentlyLoading",!1);a(this,"_currentLoadingProgress")}get currentIndex(){return this._currentIndex}get currentLoadingProgress(){return this._currentLoadingProgress}get currentlyLoadingScene(){return this._currentlyLoadingScene}get currentlyLoadedScene(){return this._currentScene}awake(){this._currentScene=void 0,this._lastLoadingScene=void 0,this.__lastSwitchScenePromise=void 0,this.scenes===void 0&&(this.scenes=[]);for(const e of this.scenes)e&&!e.hasUrl&&e.asset instanceof z?I.remove(e.asset):e instanceof z&&I.remove(e);Jt&&console.log("SceneSwitcher",this)}async onEnable(){if(globalThis.addEventListener("popstate",this.onPopState),this.context.input.addEventListener(Le.KeyDown,this.onInputKeyDown),this.context.input.addEventListener(Le.PointerMove,this.onInputPointerMove),this.context.input.addEventListener(Le.PointerUp,this.onInputPointerUp),this._engineElementOverserver||(this._engineElementOverserver=new MutationObserver(e=>{for(const i of e)if(i.type==="attributes"&&i.attributeName===pm){const n=this.context.domElement.getAttribute(pm);n!==null&&this.trySelectSceneFromValue(n)}})),this._engineElementOverserver.observe(this.context.domElement,{attributes:!0}),this._preloadScheduler||(this._preloadScheduler=new gj(this)),this._preloadScheduler.maxLoadAhead=this.preloadNext,this._preloadScheduler.maxLoadBehind=this.preloadPrevious,this._preloadScheduler.maxConcurrent=this.preloadConcurrent,this._preloadScheduler.begin(2e3),this.autoLoadFirstScene&&this._currentIndex===-1&&!await this.tryLoadFromQueryParam()){const e=this.context.domElement.getAttribute(pm);try{(e===null||!await this.trySelectSceneFromValue(e))&&this._currentIndex===-1&&this.select(0)}finally{}}this.createMenuButtons&&(this._menuButtons??(this._menuButtons=[]),this._menuButtons.push(this.context.menu.appendChild({label:"Previous",icon:"arrow_back_ios",onClick:()=>this.selectPrev(),priority:-1005,class:"row2"})),this._menuButtons.push(this.context.menu.appendChild({label:"Next",icon:"arrow_forward_ios",iconSide:"right",onClick:()=>this.selectNext(),priority:-1e3,class:"row2"})))}onDisable(){var e;if(globalThis.removeEventListener("popstate",this.onPopState),this.context.input.removeEventListener(Le.KeyDown,this.onInputKeyDown),this.context.input.removeEventListener(Le.PointerMove,this.onInputPointerMove),this.context.input.removeEventListener(Le.PointerUp,this.onInputPointerUp),(e=this._preloadScheduler)==null||e.stop(),this._menuButtons){for(const i of this._menuButtons)i.remove();this._menuButtons=void 0}}addScene(e){if(typeof e=="string"){let i=this.context.addressables.findAssetReference(e);return i||(i=new we(e),this.context.addressables.registerAssetReference(i)),this.scenes.push(i),i}return this.scenes.push(e),e}selectNext(){return this.select(this._currentIndex+1)}selectPrev(){return this.select(this._currentIndex-1)}select(e){var n,o,r;if(Jt&&console.log("[SceneSwitcher] select",e),typeof e=="object"&&console.warn('[SceneSwitcher] Switching to "'+e+'" might not work. Please either use an index or a AssetReference (not a scene reference)'),typeof e=="string"){const l=(n=this.scenes)==null?void 0:n.find(c=>c.url===e);if(!l){const c=we.getOrCreate(this.sourceId??"",e,this.context);return this.switchScene(c)}if(l)e=(o=this.scenes)==null?void 0:o.indexOf(l);else return fa}if(!((r=this.scenes)!=null&&r.length))return fa;if(e<0){if(this.clamp)return fa;e=this.scenes.length-1}else if(e>=this.scenes.length){if(this.clamp)return fa;e=0}const i=this.scenes[e];return this.switchScene(i)}unload(){return this.__lastSwitchScene=void 0,this.__lastSwitchScenePromise=void 0,this.__unloadCurrentScene()}async reload(){if(this.__lastSwitchScene){const e=this.__lastSwitchScene;return this.__lastSwitchScene=void 0,this.switchScene(e)}return!1}async switchScene(e){var n;if(!(e instanceof we)){const o=typeof e;if(o==="string")return this.select(e);if(o==="number")return this.select(e);if(e&&e instanceof z){const r=(n=this.scenes)==null?void 0:n.indexOf(e);e=new we(e.name,void 0,e),r>=0&&(this.scenes[r]=e)}else return console.warn(`[SceneSwitcher] Can't switch to scene of type ${o}`),!1}return e.url===this.sourceId?(console.warn("[SceneSwitcher] Can't load own scene - prevent recursive loading",this.sourceId),!1):this.__lastSwitchScene===e&&this.__lastSwitchScenePromise?this.__lastSwitchScenePromise:(this.__lastSwitchScene=e,this.__lastSwitchScenePromise=this.__internalSwitchScene(e),await this.__lastSwitchScenePromise)}async __unloadCurrentScene(){const e=this._currentScene;if(this._currentScene=void 0,e){Jt&&console.log("[SceneSwitcher] UNLOAD",e.url,"HasURL?: "+e.hasUrl);const i=this.tryGetSceneEventListener(e.asset);if(i!=null&&i.sceneClosing){const n=i.sceneClosing();n instanceof Promise&&await n}e.hasUrl?(e.unload(),this._currentSceneAsset&&xs(this._currentSceneAsset,!0,!1)):I.remove(this._currentSceneAsset)}}async __internalSwitchScene(e){var n,o,r,l,c;await this.__unloadCurrentScene();const i=this._currentIndex=((n=this.scenes)==null?void 0:n.indexOf(e))??-1;try{Jt&&console.debug(`${Date.now()} [SceneSwitcher] Loading scene start: ${e.url} (index: ${i})`),this._currentlyLoadingScene=e,this._currentLoadingProgress=new ProgressEvent("progress",{loaded:0,total:1});const h=new CustomEvent("loadscene-start",{detail:{scene:e,switcher:this,index:i}});this.dispatchEvent(h),(o=this.sceneLoadingStart)==null||o.invoke(h.detail),await this.onStartLoading(),await e.loadAssetAsync((u,f)=>{var p;if(Jt){const b=f.loaded/f.total,x="["+"=".repeat(Math.floor(b*20))+"-".repeat(20-Math.floor(b*20))+"]";console.debug(`${Date.now()} [SceneSwitcher] Loading scene progress: ${(b*100).toFixed(1)} % ${x}`,e.url)}this._currentLoadingProgress=f,this.dispatchEvent(f),(p=this.sceneLoadingProgress)==null||p.invoke(f)}).catch(console.error),await this.onEndLoading();const d=new CustomEvent("loadscene-finished",{detail:{scene:e,switcher:this,index:i}});if(this.dispatchEvent(d),this._currentLoadingProgress=void 0,this._currentlyLoadingScene=void 0,d.defaultPrevented)return Jt&&console.warn("[SceneSwitcher] Adding loaded scene prevented:",e,d),!1;if(!e.asset)return Jt&&console.warn("[SceneSwitcher] Failed loading scene:",e),!1;if(this._currentIndex===i){if(Jt&&console.log("[SceneSwitcher] ADD",e.url),this._currentScene=e,mj){const p=((r=this.context.mainCameraComponent)==null?void 0:r.gameObject)||this.context.mainCamera;p==null||p.removeFromParent();const b=this.gameObject.removeFromParent();xs(this.context.scene,!0,!0),this.context.scene=new Xn,this.context.scene.add(b),p&&this.context.scene.add(p)}if(e.asset.parent?this._currentSceneAsset=cc(e.asset,{parent:this.gameObject}):(this._currentSceneAsset=e.asset,I.add(e.asset,this.gameObject)),this.useSceneLighting&&this.context.sceneLighting.enable(e),this.useSceneBackground){const p=this.context.lightmaps.tryGetSkybox(e.url);p?(p.mapping=Vo,this.context.scene.background=p):Jt&&console.warn("[SceneSwitcher] Can't find skybox for scene "+e.url)}if(this.useHistory&&i>=0){let p=i.toString();if(this.useSceneName&&(e instanceof z?p=e.name:e.url&&(p=xC(e.url))),(l=this.queryParameterName)!=null&&l.length)vm(this.queryParameterName,p,this.useHistory);else{const b=history.state,x=this.guid+"::"+i;b!==x&&history.pushState(x,"unused",location.href)}}const u=this.tryGetSceneEventListener(e.asset);if(u!=null&&u.sceneOpened){const p=u.sceneOpened(this);p instanceof Promise&&await p}Jt&&console.debug(`${Date.now()} [SceneSwitcher] Loading scene finished: ${e.url} (index: ${i})`);const f=new CustomEvent("scene-opened",{detail:{scene:e,switcher:this,index:i}});return this.dispatchEvent(f),(c=this.sceneLoaded)==null||c.invoke(this),!0}}catch(h){console.error(h)}return!1}preload(e){if(e>=0&&e<this.scenes.length){const i=this.scenes[e];if(i instanceof we)return i.preload()}return fa}tryLoadFromQueryParam(){var i;if(!((i=this.queryParameterName)!=null&&i.length))return fa;const e=k(this.queryParameterName);return typeof e=="boolean"?fa:this.trySelectSceneFromValue(e)}trySelectSceneFromValue(e){if(typeof e=="string"){const i=parseInt(e);if(i>=0&&i<this.scenes.length)return this.select(i);{const n=e.toLowerCase();for(let o=0;o<this.scenes.length;o++){const r=this.scenes[o];if(!r)continue;if((r instanceof z?r.name:xC(r.url)).toLowerCase().includes(n))return this.select(o)}}}else if(typeof e=="number"&&e>=0&&e<this.scenes.length)return this.select(e);return _s()&&console.warn('[SceneSwitcher] Can not find scene: "'+e+'"',this),fa}async onStartLoading(){var e,i;if(this._isCurrentlyLoading=!0,this.loadingScene&&(this._lastLoadingScene!==this.loadingScene&&(this._loadingScenePromise=void 0),this._lastLoadingScene=this.loadingScene,this._loadingScenePromise||(this._loadingScenePromise=(e=this.loadingScene)==null?void 0:e.loadAssetAsync().then(n=>n!=null)),await this._loadingScenePromise,this._isCurrentlyLoading&&((i=this.loadingScene)!=null&&i.asset))){Jt&&console.log("Add loading scene",this.loadingScene.url,this.loadingScene.asset);const n=this.loadingScene.asset;I.add(n,this.gameObject);const o=this.tryGetSceneEventListener(n);if(o!=null&&o.sceneOpened){const r=o.sceneOpened(this);r instanceof Promise&&await r}}if(this._isCurrentlyLoading){const n=this.tryGetSceneEventListener(this.gameObject);if(n&&n.sceneOpened){const o=n.sceneOpened(this);o instanceof Promise&&await o}}}async onEndLoading(){var e;if(this._isCurrentlyLoading=!1,(e=this.loadingScene)!=null&&e.asset){Jt&&console.log("Remove loading scene",this.loadingScene.url);const i=this.loadingScene.asset,n=this.tryGetSceneEventListener(i);if(typeof(n==null?void 0:n.sceneClosing)=="function"){const o=n.sceneClosing();o instanceof Promise&&await o}I.remove(i)}if(!this._isCurrentlyLoading){const i=this.tryGetSceneEventListener(this.gameObject);if(i&&i.sceneClosing){const n=i.sceneClosing();n instanceof Promise&&await n}}}tryGetSceneEventListener(e,i=0){if(!e)return null;const n=I.foreachComponent(e,o=>{const r=o;if(r.sceneClosing||r.sceneOpened)return r});if(i===0&&!n&&e.children.length)for(const o of e.children){const r=this.tryGetSceneEventListener(o,i+1);if(r)return r}return n||null}}di([g()],$t.prototype,"autoLoadFirstScene",void 0);di([g(we)],$t.prototype,"scenes",void 0);di([g(we)],$t.prototype,"loadingScene",void 0);di([g()],$t.prototype,"queryParameterName",void 0);di([g()],$t.prototype,"useSceneName",void 0);di([g()],$t.prototype,"clamp",void 0);di([g()],$t.prototype,"useHistory",void 0);di([g()],$t.prototype,"useKeyboard",void 0);di([g()],$t.prototype,"useSwipe",void 0);di([g()],$t.prototype,"useSceneLighting",void 0);di([g()],$t.prototype,"useSceneBackground",void 0);di([g()],$t.prototype,"preloadNext",void 0);di([g()],$t.prototype,"preloadPrevious",void 0);di([g()],$t.prototype,"preloadConcurrent",void 0);di([g()],$t.prototype,"createMenuButtons",void 0);di([g(je)],$t.prototype,"sceneLoadingStart",void 0);di([g(je)],$t.prototype,"sceneLoadingProgress",void 0);di([g(je)],$t.prototype,"sceneLoaded",void 0);function xC(s){const t=s.split("/").pop(),e=t==null?void 0:t.split(".").shift();return e!=null&&e.length?e:s}class gj{constructor(t,e=1,i=1,n=2){a(this,"maxLoadAhead");a(this,"maxLoadBehind");a(this,"maxConcurrent");a(this,"_isRunning",!1);a(this,"_switcher");a(this,"_loadTasks",[]);a(this,"_maxConcurrentLoads",1);this._switcher=t,this.maxLoadAhead=e,this.maxLoadBehind=i,this.maxConcurrent=n}begin(t){if(this._isRunning)return;Jt&&console.log("[SceneSwitcher] Preload scheduled",{delay:t}),this._isRunning=!0;let e=-10,i,n;const o=this._switcher.scenes,r=Date.now()+t,l=setInterval(()=>{if(this.allLoaded()&&(Jt&&console.log("[SceneSwitcher] All scenes (pre-)loaded"),this.stop()),!this._isRunning){clearInterval(l);return}if(Date.now()<r||this.canLoadNewScene()===!1)return;(e===-10||e!==this._switcher.currentIndex)&&(e=this._switcher.currentIndex,n=0,i=0);const c=n%2===0;c&&(i+=1),n+=1;const h=c?this.maxLoadAhead:this.maxLoadBehind;if(i>h)return;const d=c?e+i:e-i;if(!(d<0)&&!(d<0||d>=o.length)&&!this._loadTasks.some(u=>u.index===d)){const u=o[d];Jt&&console.log("[SceneSwitcher] Schedule preload scene",{roomIndex:d,searchForward:c,lastRoom:e,currentIndex:this._switcher.currentIndex,tasks:this._loadTasks.length},u==null?void 0:u.url),new yj(d,u,this._loadTasks)}},200)}stop(){this._isRunning=!1}canLoadNewScene(){return this._loadTasks.length<this._maxConcurrentLoads}allLoaded(){if(this._switcher.scenes){for(const t of this._switcher.scenes)if(t!=null&&t.isLoaded&&t.isLoaded()===!1)return!1}return!0}}class yj{constructor(t,e,i){a(this,"index");a(this,"asset");a(this,"tasks");this.index=t,this.asset=e,this.tasks=i,i.push(this),this.awaitLoading()}async awaitLoading(){this.asset&&!this.asset.isLoaded()&&(Jt&&console.log("[SceneSwitcher] Preload start: "+this.asset.url,this.index),await this.asset.preload(),Jt&&console.log("[SceneSwitcher] Preload finished: "+this.asset.url,this.index));const t=this.tasks.indexOf(this);t>=0&&this.tasks.splice(t,1)}}function bj(){return new Promise((s,t)=>{const i=()=>{i!=null&&(document.removeEventListener("pointerdown",i),document.removeEventListener("click",i),document.removeEventListener("dragstart",i),document.removeEventListener("touchstart",i),s())};document.addEventListener("pointerdown",i),document.addEventListener("click",i),document.addEventListener("dragstart",i),document.addEventListener("touchstart",i)})}async function _j(s){await bj(),s()}var ts=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Xt=k("debugvideo");var Oa;(function(s){s[s.None=0]="None",s[s.AdjustHeight=1]="AdjustHeight",s[s.AdjustWidth=2]="AdjustWidth"})(Oa||(Oa={}));var xr;(function(s){s[s.VideoClip=0]="VideoClip",s[s.Url=1]="Url"})(xr||(xr={}));var $u;(function(s){s[s.None=0]="None",s[s.AudioSource=1]="AudioSource",s[s.Direct=2]="Direct",s[s.APIOnly=3]="APIOnly"})($u||($u={}));var Vu;(function(s){s[s.CameraFarPlane=0]="CameraFarPlane",s[s.CameraNearPlane=1]="CameraNearPlane",s[s.RenderTexture=2]="RenderTexture",s[s.MaterialOverride=3]="MaterialOverride"})(Vu||(Vu={}));class ai extends W{constructor(){super();a(this,"playOnAwake",!0);a(this,"aspectMode",Oa.None);a(this,"clip",null);a(this,"source",xr.Url);a(this,"_url",null);a(this,"renderMode");a(this,"targetMaterialProperty");a(this,"targetMaterialRenderer");a(this,"targetTexture");a(this,"time",0);a(this,"_playbackSpeed",1);a(this,"_isLooping",!1);a(this,"_muted",!1);a(this,"_audioOutputMode",$u.Direct);a(this,"playInBackground",!0);a(this,"_crossOrigin","anonymous");a(this,"_videoElement",null);a(this,"_videoTexture",null);a(this,"_videoMaterial",null);a(this,"_isPlaying",!1);a(this,"wasPlaying",!1);a(this,"visibilityChanged",e=>{switch(document.visibilityState){case"hidden":this.playInBackground||(this.wasPlaying=this._isPlaying,this.pause());break;case"visible":this.wasPlaying&&!this._isPlaying&&this.play();break}});a(this,"_receivedInput",!1);a(this,"_overlay",null);a(this,"_targetObjects");a(this,"_updateAspectRoutineId",-1);a(this,"_hls");a(this,"onHlsAvailable",()=>{var e;Xt&&console.log("HLS: available",this.clip),!(!this.shouldUseM3U||!this.url)&&(this._hls||(this._hls=new Hls),this.videoElement.autoplay=!0,this._hls.loadSource(this.url),this._hls.attachMedia(this.videoElement),(e=this._videoElement)==null||e.play(),Xt&&console.log("HLS: loaded",this.clip))});_j(()=>{this._receivedInput=!0,this.updateVideoElementSettings()}),this._targetObjects=[],k("videoscreenspace")&&window.addEventListener("keydown",e=>{e.key==="f"&&(this.screenspace=!this.screenspace)})}get url(){return this._url}set url(e){const n=this._url!==e;this.__didAwake?n&&this.setClipURL(e??""):this._url=e}get playbackSpeed(){var e;return((e=this._videoElement)==null?void 0:e.playbackRate)??this._playbackSpeed}set playbackSpeed(e){this._playbackSpeed=e,this._videoElement&&(this._videoElement.playbackRate=e)}get isLooping(){var e;return((e=this._videoElement)==null?void 0:e.loop)??this._isLooping}set isLooping(e){this._isLooping=e,this._videoElement&&(this._videoElement.loop=e)}get currentTime(){var e;return((e=this._videoElement)==null?void 0:e.currentTime)??this.time}set currentTime(e){this._videoElement?this._videoElement.currentTime=e:this.time=e}get isPlaying(){const e=this._videoElement;if(e){if(e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>e.HAVE_CURRENT_DATA)return!0;if(e.srcObject&&e.srcObject.active)return!0}return!1}get crossOrigin(){var e;return((e=this._videoElement)==null?void 0:e.crossOrigin)??this._crossOrigin}set crossOrigin(e){this._crossOrigin=e,this._videoElement&&(e!==null?this._videoElement.setAttribute("crossorigin",e):this._videoElement.removeAttribute("crossorigin"))}get videoMaterial(){return!this._videoMaterial&&!this.create(!1)?null:this._videoMaterial}get videoTexture(){return!this._videoTexture&&!this.create(!1)?null:this._videoTexture}get videoElement(){return!this._videoElement&&!this.create(!1)?null:this._videoElement}requestPictureInPicture(){return this._videoElement?this._videoElement.requestPictureInPicture():null}get muted(){var e;return((e=this._videoElement)==null?void 0:e.muted)??this._muted}set muted(e){this._muted=e,this._videoElement&&(this._videoElement.muted=e)}get currentVideo(){return this.clip}set audioOutputMode(e){e!==this._audioOutputMode&&(e===$u.AudioSource&&X()&&console.warn("VideoAudioOutputMode.AudioSource is not yet implemented"),this._audioOutputMode=e,this.updateVideoElementSettings())}get audioOutputMode(){return this._audioOutputMode}preloadVideo(){Xt&&console.log("Video Preload: "+this.name,this.clip),this.create(!1)}preload(){this.preloadVideo()}setVideo(e){this.clip=e,this.source=xr.VideoClip,this._videoElement?(this._videoElement.srcObject=e,this._isPlaying&&this.play(),this.updateAspect()):this.create(this.playOnAwake)}setClipURL(e){this._url!==e&&(this._url=e,this.source=xr.Url,Xt&&console.log("set url",e),this._videoElement?e.endsWith(".m3u8")||e.includes(".m3u")?this.ensureM3UCanBePlayed():(this._videoElement.src=e,this._isPlaying&&(this.stop(),this.play())):this.create(this.playOnAwake))}onEnable(){var e,i;Xt&&console.log("VideoPlayer.onEnable",xr[this.source],this.clip,this.url,this),window.addEventListener("visibilitychange",this.visibilityChanged),this.playOnAwake===!0?this.create(!0):this.preloadVideo(),this.screenspace?(e=this._overlay)==null||e.start():(i=this._overlay)==null||i.stop()}onDisable(){var e;window.removeEventListener("visibilitychange",this.visibilityChanged),(e=this._overlay)==null||e.stop(),this.pause()}onDestroy(){var e;this._videoElement&&((e=this.videoElement)==null||e.remove(),this._videoElement=null),this._videoTexture&&(this._videoTexture.dispose(),this._videoTexture=null)}play(){var e,i;if(this._videoElement||this.create(!1),!this._videoElement){Xt&&console.warn("Can not play: no video element found",this);return}if(!(this._isPlaying&&!((e=this._videoElement)!=null&&e.ended)&&!((i=this._videoElement)!=null&&i.paused))){if(this._isPlaying=!0,this._receivedInput||(this._videoElement.muted=!0),this.handleBeginPlaying(!1),this.shouldUseM3U){this.ensureM3UCanBePlayed();return}Xt&&console.log("Video Play()",this.clip,this._videoElement,this.time),this._videoElement.currentTime=this.time,this._videoElement.play().catch(n=>{var o;console.log(n),Xt&&console.error("Error playing video",n,"CODE="+n.code,(o=this.videoElement)==null?void 0:o.src,this),setTimeout(()=>{this._isPlaying&&!this.destroyed&&this.activeAndEnabled&&this.play()},1e3)}),Xt&&console.log("play",this._videoElement,this.time)}}stop(){this._isPlaying=!1,this.time=0,this._videoElement&&(this._videoElement.currentTime=0,this._videoElement.pause(),Xt&&console.log("STOP",this))}pause(){var e,i;this.time=((e=this._videoElement)==null?void 0:e.currentTime)??0,this._isPlaying=!1,(i=this._videoElement)==null||i.pause(),Xt&&console.log("PAUSE",this,this.currentTime)}create(e){let i;switch(this.source){case xr.VideoClip:i=this.clip;break;case xr.Url:i=this.url,!(i!=null&&i.length)&&typeof this.clip=="string"&&(i=this.clip);break}return i?(this._videoElement||(Xt&&console.warn("Create VideoElement",this),this._videoElement=this.createVideoElement(),this.context.domElement.shadowRoot.prepend(this._videoElement),this.updateVideoElementStyles()),typeof i=="string"?(Xt&&console.log("Set Video src",i),this._videoElement.src=i):(Xt&&console.log("Set Video srcObject",i),this._videoElement.srcObject=i),this._videoTexture||(this._videoTexture=new wk(this._videoElement)),this._videoTexture.flipY=!1,this._videoTexture.colorSpace=Vr,e&&this.handleBeginPlaying(e),Xt&&console.log("Video: handle playing done...",i,e),!0):(Xt&&console.warn("No video source set",this),!1)}updateAspect(){this.aspectMode!==Oa.None&&this.startCoroutine(this.updateAspectImpl())}get screenspace(){var e;return((e=this._overlay)==null?void 0:e.enabled)??!1}set screenspace(e){var i;if(e){if(!this._videoTexture)return;this._overlay||(this._overlay=new vj(this.context)),this._overlay.add(this._videoTexture)}else(i=this._overlay)==null||i.remove(this._videoTexture);this._overlay&&(this._overlay.enabled=e)}createVideoElement(){const e=document.createElement("video");return this._crossOrigin&&e.setAttribute("crossorigin",this._crossOrigin),Xt&&console.log("created video element",e),e}handleBeginPlaying(e){var o,r;if(!this.activeAndEnabled||!this._videoElement)return;this._targetObjects.length=0;let i=this.gameObject;switch(this.renderMode){case Vu.MaterialOverride:i=(o=this.targetMaterialRenderer)==null?void 0:o.gameObject,i||(i=(r=I.getComponent(this.gameObject,tt))==null?void 0:r.gameObject);break;case Vu.RenderTexture:console.error("VideoPlayer renderTexture not implemented yet. Please use material override instead");return}if(!i){console.error("Missing target for video material renderer",this.name,Vu[this.renderMode],this);return}const n=i.material;if(n){this._targetObjects.push(i),n!==this._videoMaterial&&(this._videoMaterial=n.clone(),i.material=this._videoMaterial);const l="map",c=this._videoMaterial;if(!this.targetMaterialProperty)c[l]=this._videoTexture;else switch(this.targetMaterialProperty){default:c[l]=this._videoTexture;break}}else{console.warn("Can not play video, no material found, this might be a multimaterial case which is not supported yet");return}this.updateVideoElementSettings(),this.updateVideoElementStyles(),e&&(this.shouldUseM3U&&this.ensureM3UCanBePlayed(),this.play())}updateVideoElementSettings(){if(!this._videoElement)return;this._videoElement.loop=this._isLooping,this._videoElement.currentTime=this.currentTime,this._videoElement.playbackRate=this._playbackSpeed,this._videoElement.playsInline=!0;let e=!this._receivedInput||this.audioOutputMode===$u.None;!e&&this._muted&&(e=!0),this._videoElement.muted=e,this.playOnAwake&&(this._videoElement.autoplay=!0)}updateVideoElementStyles(){this._videoElement&&(this._videoElement.style.userSelect="none",this._videoElement.style.visibility="hidden",this._videoElement.style.display="none",this.updateAspect())}*updateAspectImpl(){const e=++this._updateAspectRoutineId,i=void 0,n=this.clip;for(;e===this._updateAspectRoutineId&&this.aspectMode!==Oa.None&&this.clip&&n===this.clip&&this._isPlaying;){if(!n||typeof n=="string")return;let o;for(const r of n.getVideoTracks()){const l=r.getSettings();if(l&&l.width&&l.height){o=l.width/l.height;break}else o=this.context.renderer.domElement.clientWidth/this.context.renderer.domElement.clientHeight}if(o===void 0){for(let r=0;r<10;r++)yield;if(!this.isPlaying)break;continue}if(i===o){yield;continue}for(const r of this._targetObjects){let l=1;if(r.parent){const c=Lt(r.parent);l=c.x/c.y}switch(this.aspectMode){case Oa.AdjustHeight:r.scale.y=1/o*r.scale.x*l;break;case Oa.AdjustWidth:r.scale.x=o*r.scale.y*l;break}}for(let r=0;r<3;r++)yield}}get shouldUseM3U(){return this.url!=null&&(this.url.endsWith(".m3u8")||this.url.endsWith(".m3u"))&&this.source===xr.Url}ensureM3UCanBePlayed(){if(!this.shouldUseM3U)return;let e=document.head.querySelector("script[data-hls_library]");e?globalThis.Hls?this.onHlsAvailable():e.addEventListener("load",this.onHlsAvailable):(Xt&&console.log("HLS: load script"),e=document.createElement("script"),e.dataset.hls_library="hls.js",e.src="https://cdn.jsdelivr.net/npm/hls.js@1",e.addEventListener("load",this.onHlsAvailable),document.head.append(e))}}ts([g()],ai.prototype,"playOnAwake",void 0);ts([g()],ai.prototype,"aspectMode",void 0);ts([g(URL)],ai.prototype,"clip",void 0);ts([g()],ai.prototype,"source",void 0);ts([g(URL)],ai.prototype,"url",null);ts([g()],ai.prototype,"renderMode",void 0);ts([g()],ai.prototype,"targetMaterialProperty",void 0);ts([g(tt)],ai.prototype,"targetMaterialRenderer",void 0);ts([g(_t)],ai.prototype,"targetTexture",void 0);ts([g()],ai.prototype,"time",void 0);ts([g()],ai.prototype,"playbackSpeed",null);ts([g()],ai.prototype,"isLooping",null);ts([g()],ai.prototype,"audioOutputMode",null);class vj{constructor(t){a(this,"context");a(this,"_videos",[]);a(this,"_screenspaceModeQuad");a(this,"_isInScreenspaceMode",!1);a(this,"_input");this.context=t,this._input=new xj(this)}get enabled(){return this._isInScreenspaceMode}set enabled(t){t?this.start():this.stop()}add(t){this._videos.indexOf(t)===-1&&this._videos.push(t)}remove(t){if(!t)return;const e=this._videos.indexOf(t);e>=0&&this._videos.splice(e,1)}start(){var n;if(this._isInScreenspaceMode||this._videos.length<0)return;const t=this._videos[this._videos.length-1];if(!t)return;if(this._isInScreenspaceMode=!0,!this._screenspaceModeQuad){if(this._screenspaceModeQuad=_c.createPrimitive(Ws.Quad,{material:new wj(t)}),!this._screenspaceModeQuad)return;this._screenspaceModeQuad.geometry.scale(2,2,2)}const e=this._screenspaceModeQuad;this.context.scene.add(e),this.updateScreenspaceMaterialUniforms();const i=e.material;i==null||i.reset(),(n=this._input)==null||n.enable(i)}stop(){var t;this._isInScreenspaceMode=!1,this._screenspaceModeQuad&&((t=this._input)==null||t.disable(),this._screenspaceModeQuad.removeFromParent())}updateScreenspaceMaterialUniforms(){var e;const t=(e=this._screenspaceModeQuad)==null?void 0:e.material;t&&(t.screenAspect=this.context.domElement.clientWidth/this.context.domElement.clientHeight)}}class xj{constructor(t){a(this,"_onResizeScreenFn");a(this,"_onKeyUpFn");a(this,"_onMouseWheelFn");a(this,"context");a(this,"overlay");a(this,"_material");a(this,"_isPinching",!1);a(this,"_lastPinch",0);this.overlay=t,this.context=t.context}enable(t){this._material=t,window.addEventListener("resize",this._onResizeScreenFn=()=>{this.overlay.updateScreenspaceMaterialUniforms()}),window.addEventListener("keyup",this._onKeyUpFn=n=>{n.key==="Escape"&&this.overlay.stop()}),window.addEventListener("wheel",this._onMouseWheelFn=n=>{this.overlay.enabled&&(t.zoom+=n.deltaY*5e-4,n.preventDefault())},{passive:!1});const e=new _e;window.addEventListener("mousemove",n=>{if(this.overlay.enabled&&this.context.input.getPointerPressed(0)){const o=new _e(n.movementX,n.movementY);o.x/=this.context.domElement.clientWidth,o.y/=this.context.domElement.clientHeight,e.set(o.x,o.y),e.multiplyScalar(t.zoom/-this.context.time.deltaTime*.01),t.offset=t.offset.add(e)}}),window.addEventListener("pointermove",n=>{this.overlay.enabled&&this.context.input.getPointerPressed(0)&&this.context.input.getTouchesPressedCount()===1&&(e.set(n.movementX,n.movementY),e.multiplyScalar(t.zoom*-this.context.time.deltaTime*.05),t.offset=t.offset.add(e))});let i=0;window.addEventListener("touchstart",n=>{if(n.touches.length<2){this.context.time.time-i<.3&&this.overlay.stop(),i=this.context.time.time;return}this._isPinching=!0,this._lastPinch=0}),window.addEventListener("touchmove",n=>{if(!this._isPinching||!this._material)return;const o=n.touches[0],r=n.touches[1],l=o.clientX-r.clientX,c=o.clientY-r.clientY,h=Math.sqrt(l*l+c*c);if(this._lastPinch!==0){const d=h-this._lastPinch;this._material.zoom-=d*.004}this._lastPinch=h}),window.addEventListener("touchend",()=>{this._isPinching=!1})}disable(){this._onResizeScreenFn&&(window.removeEventListener("resize",this._onResizeScreenFn),this._onResizeScreenFn=void 0),this._onKeyUpFn&&(window.removeEventListener("keyup",this._onKeyUpFn),this._onKeyUpFn=void 0),this._onMouseWheelFn&&(window.removeEventListener("wheel",this._onMouseWheelFn),this._onMouseWheelFn=void 0)}}class wj extends Xo{constructor(e){super();a(this,"_offset",new _e);this.uniforms={map:{value:e},screenAspect:{value:1},offsetScale:{value:new Ne(0,0,1,1)}},this.vertexShader=`
        uniform sampler2D map;
        uniform float screenAspect;
        uniform vec4 offsetScale;
        varying vec2 vUv;

        void main() {

            gl_Position = vec4( position , 1.0 );
            vUv = uv;
            vUv.y = 1. - vUv.y;

            // fit into screen
            ivec2 res = textureSize(map, 0);
            float videoAspect = float(res.x) / float(res.y);
            float aspect = videoAspect / screenAspect;
            if(aspect >= 1.0) 
            {
                vUv.y = vUv.y * aspect;
                float offset = (1. - aspect) * .5;
                vUv.y = vUv.y + offset;
            }
            else
            {
                vUv.x = vUv.x / aspect;
                float offset = (1. - 1. / aspect) * .5;
                vUv.x = vUv.x + offset;
            }

            vUv.x -= .5;
            vUv.y -= .5;

            vUv.x *= offsetScale.z;
            vUv.y *= offsetScale.z;
            vUv.x += offsetScale.x;
            vUv.y += offsetScale.y;

            vUv.x += .5;
            vUv.y += .5;
        }

        `,this.fragmentShader=`
        uniform sampler2D map;
        varying vec2 vUv;
        void main() {
            if(vUv.x < 0. || vUv.x > 1. || vUv.y < 0. || vUv.y > 1.)
                gl_FragColor = vec4(0., 0., 0., 1.);
            else
            {
                vec4 texcolor = texture2D(map, vUv);
                gl_FragColor = texcolor;
            }
        }
        `}set screenAspect(e){this.uniforms.screenAspect.value=e,this.needsUpdate=!0}set offset(e){const i=this.uniforms.offsetScale.value;i.x=e.x,i.y=e.y,this.uniforms.offsetScale.value=i,this.needsUpdate=!0}get offset(){const e=this.uniforms.offsetScale.value;return this._offset.set(e.x,e.y),this._offset}set zoom(e){const i=this.uniforms.offsetScale.value;e<.001&&(e=.001),i.z=e,this.needsUpdate=!0}get zoom(){return this.uniforms.offsetScale.value.z}reset(){this.offset=this.offset.set(0,0),this.zoom=1,this.needsUpdate=!0}}var Qf=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const _i=k("debugscreensharing");var x0;(function(s){s[s.Screen=0]="Screen",s[s.Camera=1]="Camera",s[s.Canvas=2]="Canvas",s[s.Microphone=3]="Microphone"})(x0||(x0={}));var Ln;(function(s){s[s.Idle=0]="Idle",s[s.Sending=1]="Sending",s[s.Receiving=2]="Receiving"})(Ln||(Ln={}));class Ac extends W{constructor(){super(...arguments);a(this,"allowStartOnClick",!0);a(this,"autoConnect",!1);a(this,"_videoPlayer");a(this,"_audioSource");a(this,"device","Screen");a(this,"deviceName");a(this,"deviceFilter");a(this,"_net");a(this,"_requestOpen",!1);a(this,"_currentStream",null);a(this,"_currentMode",Ln.Idle);a(this,"onJoinedRoom",async()=>{await Ha(1e3),this.autoConnect&&!this.isSending&&!this.isReceiving&&this.context.connection.isInRoom&&this.share()});a(this,"_activeShareRequest",null);a(this,"onReceiveStream",e=>{var i;((i=e.stream)==null?void 0:i.active)===!0&&this.setStream(e.stream,Ln.Receiving)});a(this,"onCallEnded",e=>{_i&&console.log("CALL ENDED",this.isReceiving,this==null?void 0:this.screenspace),this.isReceiving&&(this.screenspace=!1)})}onPointerEnter(){this.context.connection.allowEditing!=!1&&this.allowStartOnClick&&this.context.input.setCursor("pointer")}onPointerExit(){this.context.connection.allowEditing!=!1&&this.allowStartOnClick&&this.context.input.unsetCursor("pointer")}onPointerClick(e){var i;if(this.context.connection.allowEditing!=!1&&this.allowStartOnClick&&!(e&&e.pointerId!==0)){if(this.isReceiving&&((i=this.videoPlayer)!=null&&i.isPlaying)){this.videoPlayer&&(this.videoPlayer.screenspace=!this.videoPlayer.screenspace);return}if(this.isSending){this.close();return}this.share()}}set videoPlayer(e){this._videoPlayer&&(this.isSending||this.isReceiving)&&this._videoPlayer.stop(),this._videoPlayer=e,this._videoPlayer&&this._currentStream&&(this.isSending||this.isReceiving)&&this._videoPlayer.setVideo(this._currentStream)}get videoPlayer(){return this._videoPlayer}get screenspace(){var e;return((e=this.videoPlayer)==null?void 0:e.screenspace)??!1}set screenspace(e){this.videoPlayer&&(this.videoPlayer.screenspace=e)}get currentScream(){return this._currentStream}get currentMode(){return this._currentMode}get isSending(){var e;return((e=this._currentStream)==null?void 0:e.active)&&this._currentMode===Ln.Sending}get isReceiving(){if(this._currentMode===Ln.Receiving){if(!this._currentStream||this._currentStream.active===!1)return!1;const e=this._currentStream.getTracks();for(const i of e)if(i.readyState==="live")return!0}return!1}get requiresVideoPlayer(){return this.device!=="Microphone"}awake(){typeof this.device=="number"&&(this.device=x0[this.device]),_i&&console.log("Screensharing",this.name,this),We.registerWaitForAllowAudio(()=>{this._videoPlayer&&this._currentStream&&this._currentMode===Ln.Receiving&&(this._videoPlayer.playInBackground=!0,this._videoPlayer.setVideo(this._currentStream))}),this._net=new Gg(this)}onEnable(){var e,i,n;(e=this._net)==null||e.enable(),(i=this._net)==null||i.addEventListener(Pt.StreamReceived,this.onReceiveStream),(n=this._net)==null||n.addEventListener(Pt.StreamEnded,this.onCallEnded),this.context.connection.beginListen(me.JoinedRoom,this.onJoinedRoom),this.autoConnect&&Ha(1e3).then(()=>(this.enabled&&this.autoConnect&&!this.isReceiving&&!this.isSending&&this.context.connection.isInRoom&&this.share(),0))}onDisable(){var e,i,n;(e=this._net)==null||e.removeEventListener(Pt.StreamReceived,this.onReceiveStream),(i=this._net)==null||i.removeEventListener(Pt.StreamEnded,this.onCallEnded),this.context.connection.stopListen(me.JoinedRoom,this.onJoinedRoom),(n=this._net)==null||n.disable(),this.close()}_ensureVideoPlayer(){const e=new ai;e.aspectMode=Oa.AdjustWidth,I.addComponent(this.gameObject,e),this._videoPlayer=e}async share(e){return this._activeShareRequest?this._activeShareRequest:(this._activeShareRequest=this.internalShare(e),this._activeShareRequest.then(()=>this._activeShareRequest=null))}async internalShare(e){if(this.context.connection.isInRoom===!1){console.warn("Can not start screensharing: requires network connection"),X()&&qe("Can not start screensharing: requires network connection. Add a SyncedRoom component or join a room first.");return}if(e!=null&&e.device&&(this.device=e.device),!this.videoPlayer&&this.requiresVideoPlayer&&(this._videoPlayer||(this._videoPlayer=I.getComponent(this.gameObject,ai)??void 0),this.videoPlayer||this._ensureVideoPlayer(),!this.videoPlayer)){console.warn("Can not share video without a videoPlayer assigned");return}this._requestOpen=!0;try{const i=(e==null?void 0:e.constraints)??{echoCancellation:!0,autoGainControl:!1},n={video:i,audio:i},o=n.video;switch(o!==void 0&&typeof o!="boolean"&&(o.width||(o.width={max:1920}),o.height||(o.height={max:1920}),o.aspectRatio||(o.aspectRatio={ideal:1.7777777778}),o.frameRate||(o.frameRate={ideal:24}),o.facingMode||(o.facingMode={ideal:"user"})),this.device){case"Camera":this.tryShareUserCamera(n,e);break;case"Screen":{if(!navigator.mediaDevices.getDisplayMedia){console.error("No getDisplayMedia support");return}const c=await navigator.mediaDevices.getDisplayMedia(n);this._requestOpen?this.setStream(c,Ln.Sending):Mr(c)}break;case"Canvas":const r=0,l=this.context.renderer.domElement.captureStream(r);this.setStream(l,Ln.Sending);break;case"Microphone":{if(!navigator.mediaDevices.getUserMedia){console.error("No getDisplayMedia support");return}n.video=!1;const c=await navigator.mediaDevices.getUserMedia(n);this._requestOpen?this.setStream(c,Ln.Sending):Mr(c)}break;default:console.error("Can not start screen sharing: Unknown device type",this.device)}}catch(i){if(i.name==="NotAllowedError"){console.log("Selection cancelled"),this._requestOpen=!1;return}console.error("Error opening video",i)}}close(){var e;this._requestOpen=!1,this._currentStream&&(_i&&console.warn("Close current stream / disposing resources, stream was active?",this._currentStream.active),(e=this._net)==null||e.stopSendingStream(this._currentStream),Mr(this._currentStream),this._currentMode=Ln.Idle,this._currentStream=null)}setStream(e,i){var r,l,c;if(e===this._currentStream||(this.close(),!e))return;this._currentStream=e,this._requestOpen=!0,this._currentMode=i;const n=this.device!=="Microphone",o=i===Ln.Sending;n?(this._videoPlayer||this._ensureVideoPlayer(),this._videoPlayer?this._videoPlayer.setVideo(e):console.error("No video player assigned for video stream")):(this._audioSource||(this._audioSource=new We,this._audioSource.spatialBlend=0,this._audioSource.volume=1,this.gameObject.addComponent(this._audioSource)),o||(_i&&console.log("PLAY",e.getAudioTracks()),this._audioSource.volume=1,(r=this._audioSource)==null||r.play(e))),o&&((l=this._net)==null||l.startSendingStream(e)),o&&(this._videoPlayer&&(this._videoPlayer.muted=!0),(c=this._audioSource)==null||c.stop());for(const h of e.getTracks())h.addEventListener("ended",()=>{_i&&console.log("Track ended",h),this.close()}),_i&&h.kind==="video"&&console.log(o?"Video ‚Üí":"Video ‚Üê",h.getSettings())}async tryShareUserCamera(e,i){const n=(await navigator.mediaDevices.enumerateDevices()).filter(r=>r.kind==="videoinput");_i&&console.log(`Request camera. These are your kind:videoinput devices:
`,n);let o=!1;for(const r of n)try{if(!this._requestOpen){_i&&console.log("Camera selection cancelled");break}if(r.kind!=="videoinput"){_i&&console.log("Skipping non-video device",r);continue}const l=r.deviceId;if((i==null?void 0:i.deviceId)!=null||(i==null?void 0:i.deviceFilter)!=null){if((i==null?void 0:i.deviceId)!==void 0&&l!==i.deviceId){_i&&console.log("Skipping device due to options.deviceId: "+r.label+"; "+r.deviceId);continue}if(i!=null&&i.deviceFilter&&i.deviceFilter(r)===!1){_i&&console.log("Skipping device due to options.deviceFilter: "+r.label+"; "+r.deviceId);continue}}else if(this.deviceFilter)if(this.deviceFilter(r)===!1){_i&&console.log("Skipping device due to ScreenShare.deviceFilter: "+r.label+"; "+r.deviceId);continue}else _i&&console.log("Selected device by filter",r);else if(this.deviceName){const d=r.label.toLowerCase(),u=this.deviceName.toLowerCase(),f=d.includes(u),p=r.deviceId===this.deviceName;if(!f&&!p){_i&&console.log("Skipping device due to ScreenShare.deviceName: "+r.label+"; "+r.deviceId);continue}else _i&&console.log("Selected device by name",r)}e.video!==!1&&((typeof e.video>"u"||typeof e.video=="boolean")&&(e.video={}),e.video.deviceId=l),o=!0;const h=await navigator.mediaDevices.getUserMedia(e).catch(d=>(console.error("Failed to get user media",d),null));if(h===null)continue;this._requestOpen?(this.setStream(h,Ln.Sending),_i&&console.log("Selected camera",r)):(Mr(h),_i&&console.log("Camera selection cancelled"));break}catch(l){if(l.message==="Failed to allocate videosource"||l.message==="Could not start video source"){qe("Failed to start video: Try another camera (Code "+l.code+")"),console.warn(l);continue}else console.error("Failed to get user media",l.message,l.code,l)}!o&&X()&&(qe("No camera found for sharing. Please connect a camera (see console for more information)"),console.warn("No camera found for sharing. Please connect a camera",n,this.deviceName,"Using deviceFilter? "+this.deviceFilter!=null,"Using options? "+i!=null,"Using deviceName? "+this.deviceName!=null,"Using options.deviceId? "+(i==null?void 0:i.deviceId)!=null,"Using options.deviceFilter? "+(i==null?void 0:i.deviceFilter)!=null))}}Qf([g()],Ac.prototype,"allowStartOnClick",void 0);Qf([g()],Ac.prototype,"autoConnect",void 0);Qf([g(ai)],Ac.prototype,"videoPlayer",null);Qf([g()],Ac.prototype,"device",void 0);Qf([g()],Ac.prototype,"deviceName",void 0);var Pd=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Sj=k("debugseethrough");let Cj=0;class rl extends W{constructor(){super(...arguments);a(this,"referencePoint",null);a(this,"fadeDuration",.05);a(this,"minAlpha",0);a(this,"useAlphaHash",!0);a(this,"overrideAlpha",-1);a(this,"autoUpdate",!0);a(this,"_referencePointVector",new R);a(this,"_referencePointDir",new R);a(this,"_distance",0);a(this,"_renderer",null);a(this,"_needsUpdate",!0);a(this,"_id",Cj++);a(this,"rendererMaterials",new WeakMap);a(this,"rendererMaterialsOriginal",new WeakMap)}set needsUpdate(e){this._needsUpdate=e}get needsUpdate(){return this._needsUpdate}onEnable(){this._needsUpdate=!0,this._renderer=null,Uh.components.push(this)}onDisable(){var i;(i=this._renderer)==null||i.forEach(n=>{const o=this.rendererMaterialsOriginal.get(n);for(let r=0;r<n.sharedMaterials.length;r++)n.sharedMaterials[r]&&o&&o[r]&&(n.sharedMaterials[r]=o[r]);this.rendererMaterials.delete(n),this.rendererMaterialsOriginal.delete(n)});const e=Uh.components.indexOf(this);e!==-1&&Uh.components.splice(e,1)}update(){if(this._needsUpdate?(this._needsUpdate=!1,this._renderer=this.gameObject.getComponentsInChildren(tt),this.updateDirection()):this.autoUpdate&&(this.context.time.frame+this._id)%20===0&&this.updateDirection(),!this.autoUpdate||!this.referencePoint)return;const i=this._referencePointDir.dot(this.context.mainCamera.worldForward)>.2;if(Sj&&this.referencePoint){const n=this.gameObject.worldPosition;se.DrawArrow(te(n),n.sub(this._referencePointDir),i?16711680:65280),se.DrawWireSphere(this.referencePoint.worldPosition,.05,255)}i?this.updateAlpha(this.minAlpha,this.fadeDuration):this.updateAlpha(1,this.fadeDuration)}updateDirection(){this.referencePoint??(this.referencePoint=this.context.scene),this._referencePointVector.copy(this.gameObject.worldPosition.sub(this.referencePoint.worldPosition)),this._distance=this._referencePointVector.length(),this._referencePointDir.copy(this._referencePointVector).multiply(te(1,.5,1)).normalize()}updateAlpha(e,i=this.fadeDuration){var n;this.overrideAlpha!==void 0&&this.overrideAlpha!==-1&&(e=this.overrideAlpha),(n=this._renderer)==null||n.forEach(o=>{if(e<.9?o.gameObject.raycastAllowed=!1:o.gameObject.raycastAllowed=!0,!this.rendererMaterials.has(o)){const l=new Array,c=new Array;for(let h=0;h<o.sharedMaterials.length;h++){const d=o.sharedMaterials[h];if(!d)continue;l.push(d);const u=d.clone();u.userData=d.userData||{},u.userData.seeThrough={initial:{opacity:u.opacity,transparent:u.transparent,alphaHash:u.alphaHash}},c.push(u),o.sharedMaterials[h]=u}this.rendererMaterials.set(o,c),this.rendererMaterialsOriginal.set(o,l)}const r=o.hasLightmap?o.sharedMaterials:this.rendererMaterials.get(o);if(r)for(const l of r){if(!l)continue;let c=ee.lerp(l.opacity,e,i<=0?1:this.context.time.deltaTime/i);c>=.99?c=1:c<=.01&&(c=0);const h=l.transparent,d=l.alphaHash,u=l.opacity;if(l.alphaHash=this.useAlphaHash,l.userData&&"seeThrough"in l.userData){const f=l.userData.seeThrough.initial;l.opacity=f.opacity*c,l.transparent=l.opacity>=1?f.transparent:!this.useAlphaHash}else l.transparent=l.opacity>=1?!1:!this.useAlphaHash;(h!==l.transparent||d!==l.alphaHash||l.opacity!==u)&&(l.needsUpdate=!0)}})}}Pd([g(z)],rl.prototype,"referencePoint",void 0);Pd([g()],rl.prototype,"fadeDuration",void 0);Pd([g()],rl.prototype,"minAlpha",void 0);Pd([g()],rl.prototype,"useAlphaHash",void 0);Pd([g()],rl.prototype,"overrideAlpha",void 0);Pd([g()],rl.prototype,"autoUpdate",void 0);class Uh{get extensionName(){return"SeeThrough"}}a(Uh,"components",[]);const wC=new Uh;Ge.beforeExport.addEventListener(s=>{Uh.components.length!==0&&s.exporter.extensions.includes(wC)===!1&&s.exporter.extensions.push(wC)});var TR=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},bh;(function(s){s[s.ShadowMask=0]="ShadowMask",s[s.Additive=1]="Additive",s[s.Occluder=2]="Occluder"})(bh||(bh={}));class fy extends W{constructor(){super(...arguments);a(this,"mode",bh.ShadowMask);a(this,"shadowColor",new Te(0,0,0,1));a(this,"targetMesh")}start(){if(this.gameObject instanceof le)this.gameObject instanceof le&&this.gameObject.material&&(this.gameObject.material=this.gameObject.material.clone(),this.targetMesh=this.gameObject,this.targetMesh.receiveShadow=!0);else{const e=_c.createPrimitive(Ws.Quad,{name:"ShadowCatcher",material:new ti({color:10066329,roughness:1,metalness:0,transparent:!0})});e.receiveShadow=!0,e.geometry.rotateX(-Math.PI/2),this.gameObject.add(e),this.targetMesh=e}if(!this.targetMesh){console.warn("ShadowCatcher: no mesh to apply shadow catching to. Groups are currently not supported.");return}switch(this.targetMesh.layers.set(2),this.mode){case bh.ShadowMask:this.applyShadowMaterial();break;case bh.Additive:this.applyLightBlendMaterial();break;case bh.Occluder:this.applyOccluderMaterial();break}}applyLightBlendMaterial(){if(!this.targetMesh)return;const e=this.targetMesh.material;e.blending=e1,this.applyMaterialOptions(e),e.onBeforeCompile=i=>{i.fragmentShader=i.fragmentShader.replace("vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;",`vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;
            // diffuse-only lighting with overdrive to somewhat compensate
            // for the loss of indirect lighting and to make it more visible.
            vec3 direct = (reflectedLight.directDiffuse + reflectedLight.directSpecular) * 6.6;
            float max = max(direct.r, max(direct.g, direct.b));
            
            // early out - we're simply returning direct lighting and some alpha based on it so it can 
            // be blended onto the scene.
            gl_FragColor = vec4(direct, max);
            return;
            `)},e.userData.isLightBlendMaterial=!0}applyShadowMaterial(){if(this.targetMesh)if(this.targetMesh.material.type!=="ShadowMaterial"){const e=new VC;e.color=this.shadowColor,e.opacity=this.shadowColor.alpha,this.applyMaterialOptions(e),this.targetMesh.material=e,e.userData.isShadowCatcherMaterial=!0}else{const e=this.targetMesh.material;e.color=this.shadowColor,e.opacity=this.shadowColor.alpha,this.applyMaterialOptions(e),e.userData.isShadowCatcherMaterial=!0}}applyOccluderMaterial(){if(this.targetMesh){let e=this.targetMesh.material;if(!e){const i=new Ye;this.targetMesh.material=i,e=i}e.depthWrite=!0,e.stencilWrite=!0,e.colorWrite=!1,this.gameObject.renderOrder=-100}}applyMaterialOptions(e){e&&(e.depthWrite=!1,e.stencilWrite=!1)}}TR([g()],fy.prototype,"mode",void 0);TR([g(Te)],fy.prototype,"shadowColor",void 0);const qp=new Map;function Pj(s,t){if(qp.has(s))return qp.get(s);const e=new URL(s,window.location.href),i=Tj(e,t);return qp.set(s,i),i.finally(()=>{qp.delete(s)}),i}async function Tj(s,t){if(!s)return Promise.resolve(null);const e=s.pathname,i=s.toString().toLowerCase().includes("pmrem")||s.searchParams.get("pmrem")!=null,n=e.endsWith(".exr"),o=e.endsWith(".hdr"),r=e.endsWith(".ktx2");let l;if(n)l=new D0;else if(o)l=new r1;else if(r){const{ktx2Loader:u}=F0(t);l=u}else l=new Wh;const c=s.toString();return await l.loadAsync(c).then(u=>{if(u){const f=e.lastIndexOf("/");u.name=e.substring(f>=0?f+1:0),i&&(u.mapping=t1),l instanceof Wh&&(u.colorSpace=Vr)}return u}).catch(u=>(console.warn("Failed to load texture from url:",s),null))}var Yf=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const cn=k("debugskybox");Vv("background-image");Vv("environment-image");const SC={studio:{url:"https://cdn.needle.tools/static/skybox/modelviewer-Neutral.pmrem4x4.ktx2?pmrem",url_low:"https://cdn.needle.tools/static/skybox/modelviewer-Neutral-small.pmrem4x4.ktx2?pmrem"},"blurred-skybox":{url:"https://cdn.needle.tools/static/skybox/blurred-skybox.pmrem4x4.ktx2?pmrem",url_low:"https://cdn.needle.tools/static/skybox/blurred-skybox-small.pmrem4x4.ktx2?pmrem"},"quicklook-ar":{url:"https://cdn.needle.tools/static/skybox/QuickLook-ARMode.pmrem4x4.ktx2?pmrem",url_low:"https://cdn.needle.tools/static/skybox/QuickLook-ARMode-small.pmrem4x4.ktx2?pmrem"},quicklook:{url:"https://cdn.needle.tools/static/skybox/QuickLook-ObjectMode.pmrem4x4.ktx2?pmrem",url_low:"https://cdn.needle.tools/static/skybox/QuickLook-ObjectMode-small.pmrem4x4.ktx2?pmrem"}};function CC(s,t,e,i,n){if(t==="transparent"||t!=null&&t.startsWith("rgb")||t!=null&&t.startsWith("#"))return console.warn(`Needle Engine: Invalid ${n} value (${t}). Did you mean to set background-color instead?`),null;const o=new qr;o.sourceId=mE(t),o.allowDrop=!1,o.allowNetworking=!1,o.background=e,o.environment=i,I.addComponent(s.scene,o);const r=l=>{if(cn&&console.log(n,"CHANGED TO",l),l){if(typeof l!="string"){console.warn("Invalid attribute value for "+n);return}o.setSkybox(l)}else if(o.sourceId&&(i&&(s.sceneLighting.internalEnableReflection(o.sourceId)||(s.scene.environment=null)),e)){const c=s.lightmaps.tryGetSkybox(o.sourceId);s.scene.background=c}};return p1(s.domElement,n,r),o.addEventListener("destroy",()=>{cn&&console.log("Destroyed attribute remote skybox",n),m1(s.domElement,n,r)}),o.setSkybox(t)}const tg=new Array;Be.registerCallback(Me.ContextCreationStart,s=>{const t=s.context,e=t.domElement.getAttribute("background-image"),i=t.domElement.getAttribute("environment-image");if(e){cn&&console.log("Creating RemoteSkybox to load background "+e);const n=CC(t,e,!0,!1,"background-image");n&&tg.push(n)}if(i){cn&&console.log("Creating RemoteSkybox to load environment "+i);const n=CC(t,i,!1,!0,"environment-image");n&&tg.push(n)}});Be.registerCallback(Me.ContextCreationStart,()=>Promise.all(tg).finally(()=>{tg.length=0}));class qr extends W{constructor(){super(...arguments);a(this,"url","studio");a(this,"allowDrop",!0);a(this,"background",!0);a(this,"environment",!0);a(this,"allowNetworking",!0);a(this,"_prevUrl");a(this,"_prevLoadedEnvironment");a(this,"_prevEnvironment",null);a(this,"_prevBackground",null);a(this,"validProtocols",["file:","blob:","data:"]);a(this,"validTextureTypes",[".ktx2",".hdr",".exr",".jpg",".jpeg",".png"]);a(this,"onDragOverEvent",e=>{if(this.allowDrop&&e.dataTransfer)for(const i of e.dataTransfer.types)(i==="text/uri-list"||i==="Files")&&e.preventDefault()});a(this,"onDrop",e=>{var i,n,o,r;if(this.allowDrop&&e.dataTransfer){for(const l of e.dataTransfer.types)if(cn&&console.log(l),l==="text/uri-list"){const c=e.dataTransfer.getData(l);cn&&console.log(l,c);let h=(n=(i=new RegExp(/polyhaven.com\/asset_img\/.+?\/(?<name>.+)\.png/).exec(c))==null?void 0:i.groups)==null?void 0:n.name;if(h||(h=(r=(o=new RegExp(/polyhaven\.com\/a\/(?<name>.+)/).exec(c))==null?void 0:o.groups)==null?void 0:r.name),cn&&console.log(h),h){const d="https://dl.polyhaven.org/file/ph-assets/HDRIs/exr/1k/"+h+"_1k.exr";console.log(`[Remote Skybox] Setting skybox from url: ${d}`),e.preventDefault(),this.setSkybox(d);break}else if(this.isValidTextureType(c)){console.log("[Remote Skybox] Setting skybox from url: "+c),e.preventDefault(),this.setSkybox(c);break}else{console.warn(`[RemoteSkybox] Unknown url ${c}. If you want to load a skybox from a url, make sure it is a valid image url. Url must end with${this.validTextureTypes.join(", ")}.`);const d=new CustomEvent("dropped-unknown-url",{detail:{sender:this,event:e,url:c,apply:u=>{e.preventDefault(),this.setSkybox(u)}}});this.dispatchEvent(d)}}else if(l=="Files"){const c=e.dataTransfer.files.item(0);if(cn&&console.log(l,c),!c)continue;if(!this.isValidTextureType(c.name)){console.warn(`[RemoteSkybox]: File "${c.name}" is not supported. Supported files are ${this.validTextureTypes.join(", ")}`);return}e.preventDefault(),this.setSkybox(c.name);break}}})}onEnable(){this.setSkybox(this.url),this.registerDropEvents()}onDisable(){var e;this.context.scene.environment===this._prevLoadedEnvironment&&(this.context.scene.environment=this._prevEnvironment,ze.backgroundShouldBeTransparent(this.context)||(this.context.scene.background=this._prevBackground),this._prevLoadedEnvironment=void 0),this.unregisterDropEvents(),(e=this.context.mainCameraComponent)==null||e.applyClearFlags()}urlChangedSyncField(){this.allowNetworking&&this.url&&(this.isRemoteTexture(this.url)?this.setSkybox(this.url):cn&&console.warn(`RemoteSkybox: Not setting skybox: ${this.url} is not a remote texture. If you want to set a local texture, set allowNetworking to false.`))}async setSkybox(e,i){var o,r;if(!this.activeAndEnabled||(e=Rj(e,this.environment,this.background),!e))return!1;if(i??(i=e),this.isValidTextureType(i)||console.warn('Potentially invalid skybox URL: "'+i+'" on '+(this.name||((o=this.gameObject)==null?void 0:o.name)||"context")),cn&&console.log("Set RemoteSkybox url: "+e),this._prevUrl===e&&this._prevLoadedEnvironment)return this.apply(),!0;(r=this._prevLoadedEnvironment)==null||r.dispose(),this._prevLoadedEnvironment=void 0,this._prevUrl=e;const n=await Pj(e,this.context.renderer);return n?!this.enabled||this.destroyed?(cn&&console.warn("RemoteSkybox: Component is disabled or destroyed"),!1):this._prevUrl!==e?(cn&&console.warn("RemoteSkybox: URL changed while loading texture, aborting setSkybox"),!1):(this.url=e,this._prevLoadedEnvironment=n,this.apply(),!0):(cn&&console.warn("RemoteSkybox: Failed to load texture from url",e),!1)}apply(){var i;const e=this._prevLoadedEnvironment;if(e&&(e instanceof KC||e instanceof Sk||e.mapping==t1||(e.mapping=Ck,e.needsUpdate=!0),!this.destroyed)){if(!this.context){console.warn("RemoteSkybox: Context is not available - can not apply skybox.");return}this.context.scene.background!==e&&(this._prevBackground=this.context.scene.background),this.context.scene.environment!==e&&(this._prevEnvironment=this.context.scene.environment),cn&&console.log("Set RemoteSkybox ("+(this.environment&&this.background?"environment and background":this.environment?"environment":this.background?"background":"none")+")",this.url,!ze.backgroundShouldBeTransparent(this.context)),this.environment&&(this.context.scene.environment=e),this.background&&!ze.backgroundShouldBeTransparent(this.context)&&(this.context.scene.background=e),((i=this.context.mainCameraComponent)==null?void 0:i.backgroundBlurriness)!==void 0&&(this.context.scene.backgroundBlurriness=this.context.mainCameraComponent.backgroundBlurriness)}}isRemoteTexture(e){return e.startsWith("http://")||e.startsWith("https://")}isValidTextureType(e){for(const i of this.validTextureTypes)if(e.includes(i))return!0;for(const i of this.validProtocols)if(e.startsWith(i))return!0;return!1}registerDropEvents(){this.unregisterDropEvents(),this.context.domElement.addEventListener("dragover",this.onDragOverEvent),this.context.domElement.addEventListener("drop",this.onDrop)}unregisterDropEvents(){this.context.domElement.removeEventListener("dragover",this.onDragOverEvent),this.context.domElement.removeEventListener("drop",this.onDrop)}}Yf([oR(qr.prototype.urlChangedSyncField),g(URL)],qr.prototype,"url",void 0);Yf([g()],qr.prototype,"allowDrop",void 0);Yf([g()],qr.prototype,"background",void 0);Yf([g()],qr.prototype,"environment",void 0);Yf([g()],qr.prototype,"allowNetworking",void 0);function Rj(s,t,e){if(s==null)return null;const i=t&&!e,n=SC[s.toLowerCase()];return n?i?n.url_low:n.url:(typeof s=="string"&&(s!=null&&s.length)&&(X()||cn)&&!s.startsWith("http")&&!s.startsWith("file:")&&!s.startsWith("blob:")&&!s.startsWith("data:")&&console.warn(`RemoteSkybox: Unknown magic skybox name "${s}". Valid names are: ${Object.keys(SC).map(r=>`"${r}"`).join(", ")}`),s)}var py=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const ux=class extends W{constructor(){super(...arguments);a(this,"target",null);a(this,"followFactor",.1);a(this,"rotateFactor",.1);a(this,"positionAxes",dh.All);a(this,"flipForward",!1);a(this,"_firstUpdate",!0)}onBeforeRender(){this.updateNow(!1)}updateNow(e){if(!(!this.target||this.target===this.gameObject)){if(this.followFactor>0){const i=ve(this.target),n=this._firstUpdate||e?1:ee.clamp01(this.context.time.deltaTime*this.followFactor),o=this.worldPosition;this.positionAxes&dh.X&&(o.x=ee.lerp(o.x,i.x,n)),this.positionAxes&dh.Y&&(o.y=ee.lerp(o.y,i.y,n)),this.positionAxes&dh.Z&&(o.z=ee.lerp(o.z,i.z,n)),this.worldPosition=o}if(this.rotateFactor>0){const i=Qe(this.target);this.flipForward&&i.premultiply(ux._invertForward);const n=this._firstUpdate||e?1:ee.clamp01(this.context.time.deltaTime*this.rotateFactor);this.worldQuaternion=this.worldQuaternion.slerp(i,n)}this._firstUpdate=!1}}};let qo=ux;a(qo,"_invertForward",new re().setFromAxisAngle(new R(0,1,0),Math.PI));py([g(z)],qo.prototype,"target",void 0);py([g()],qo.prototype,"followFactor",void 0);py([g()],qo.prototype,"rotateFactor",void 0);py([g()],qo.prototype,"positionAxes",void 0);var Kf=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Wu=k("debugspatialtrigger"),PC=new Va,TC=new Va;function Oj(s,t){return PC.mask=s,TC.mask=t,PC.test(TC)}class Ur extends W{constructor(){super(...arguments);a(this,"triggerMask",0);a(this,"onEnter");a(this,"onStay");a(this,"onExit");a(this,"currentIntersected",[]);a(this,"lastIntersected",[])}start(){Wu&&console.log(this.name,this.triggerMask,this)}update(){this.currentIntersected.length=0;for(const e of ac.triggers)Oj(e.triggerMask,this.triggerMask)&&e.test(this.gameObject)&&this.currentIntersected.push(e);for(let e=this.lastIntersected.length-1;e>=0;e--){const i=this.lastIntersected[e];this.currentIntersected.indexOf(i)<0&&(this.onExitTrigger(i),this.lastIntersected.splice(e,1))}for(const e of this.currentIntersected)this.lastIntersected.indexOf(e)<0&&this.onEnterTrigger(e),this.onStayTrigger(e);this.lastIntersected.length=0,this.lastIntersected.push(...this.currentIntersected)}onEnterTrigger(e){var i;Wu&&console.log("ENTER TRIGGER",this.name,e.name,this,e),e.raiseOnEnterEvent(this),(i=this.onEnter)==null||i.invoke()}onExitTrigger(e){var i;Wu&&console.log("EXIT TRIGGER",this.name,e.name),e.raiseOnExitEvent(this),(i=this.onExit)==null||i.invoke()}onStayTrigger(e){var i;e.raiseOnStayEvent(this),(i=this.onStay)==null||i.invoke()}}Kf([g()],Ur.prototype,"triggerMask",void 0);Kf([g(je)],Ur.prototype,"onEnter",void 0);Kf([g(je)],Ur.prototype,"onStay",void 0);Kf([g(je)],Ur.prototype,"onExit",void 0);const of=class extends W{constructor(){super(...arguments);a(this,"triggerMask");a(this,"boxHelper")}start(){Wu&&console.log(this.name,this.triggerMask,this)}onEnable(){var e;of.triggers.push(this),this.boxHelper||(this.boxHelper=I.addComponent(this.gameObject,Nn),(e=this.boxHelper)==null||e.showHelper(null,Wu))}onDisable(){of.triggers.splice(of.triggers.indexOf(this),1)}test(e){return this.boxHelper?this.boxHelper.isInBox(e)??!1:!1}raiseOnEnterEvent(e){I.foreachComponent(this.gameObject,i=>{i!==e&&i instanceof Ur&&i.onEnterTrigger(this)},!1)}raiseOnStayEvent(e){I.foreachComponent(this.gameObject,i=>{i!==e&&i instanceof Ur&&i.onStayTrigger(this)},!1)}raiseOnExitEvent(e){I.foreachComponent(this.gameObject,i=>{i!==e&&i instanceof Ur&&i.onExitTrigger(this)},!1)}};let ac=of;a(ac,"triggers",[]);Kf([g()],ac.prototype,"triggerMask",void 0);var kj=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},rd;(function(s){s[s.FirstPerson=0]="FirstPerson",s[s.ThirdPerson=1]="ThirdPerson"})(rd||(rd={}));const $n=k("debugspectator");class Wv extends W{constructor(){super(...arguments);a(this,"cam",null);a(this,"useKeys",!0);a(this,"_mode",rd.FirstPerson);a(this,"orbit",null);a(this,"_handler");a(this,"eventSub_WebXRRequestStartEvent",null);a(this,"eventSub_WebXRStartEvent",null);a(this,"eventSub_WebXREndEvent",null);a(this,"_debug");a(this,"_networking")}get mode(){return this._mode}set mode(e){this._mode=e}get isSpectating(){var e;return((e=this._handler)==null?void 0:e.currentTarget)!==void 0}isSpectatingUser(e){var i;return((i=this.target)==null?void 0:i.userId)===e}isFollowedBy(e){var i;return(i=this.followers)==null?void 0:i.includes(e)}get followers(){return this._networking.followers}stopSpectating(){if(this.context.isInXR){this.followSelf();return}this.target=void 0}get localId(){return this.context.connection.connectionId??"local"}set target(e){var i;if(this._handler){const n=(i=this._handler.currentTarget)==null?void 0:i.userId,o=this.context.players.getPlayerView(this.localId);e===void 0||this.context.isInXR===!1&&(o==null?void 0:o.currentObject)===e.currentObject?this._handler.currentTarget!==void 0&&(this._handler.disable(),I.setActive(this.gameObject,!1),this.orbit&&(this.orbit.enabled=!0),this._networking.onSpectatedObjectChanged(e,n)):this._handler.currentTarget!==e&&(this._handler.set(e),I.setActive(this.gameObject,!0),this.orbit&&(this.orbit.enabled=!1),this._networking.onSpectatedObjectChanged(e,n))}}get target(){var e;return(e=this._handler)==null?void 0:e.currentTarget}requestAllFollowMe(){this._networking.onRequestFollowMe()}get isSpectatingSelf(){var e,i;return this.isSpectating&&((e=this.target)==null?void 0:e.currentObject)===((i=this.context.players.getPlayerView(this.localId))==null?void 0:i.currentObject)}awake(){if(this._debug=new Aj(this.context,this),this._networking=new Dj(this.context,this),this._networking.awake(),I.setActive(this.gameObject,!1),this.cam=I.getComponent(this.gameObject,ze),!this.cam){console.warn("SpectatorCamera: Spectator camera needs camera component on the same object.",this);return}!this._handler&&this.cam&&(this._handler=new Ej(this.context,this.cam,this)),this.orbit=I.getComponent(this.context.mainCamera,He)}onDestroy(){var e,i;this.stopSpectating(),(e=this._handler)==null||e.destroy(),(i=this._networking)==null||i.destroy()}isSupportedPlatform(){const e=window.navigator.userAgent,i=/Windows NT/.test(e)&&/Edg/.test(e)&&!/Win64/.test(e);return Q.isDesktop()&&!Q.isMobileDevice()&&!i}onBeforeXR(e){this.isSupportedPlatform()&&I.setActive(this.gameObject,!0)}onEnterXR(e){this.isSupportedPlatform()&&($n&&console.log(this.context.mainCamera),this.context.mainCamera&&this.followSelf())}onLeaveXR(e){var i,n;this.context.removeCamera(this.cam),I.setActive(this.gameObject,!1),(i=this._handler)==null||i.set(void 0),(n=this._handler)==null||n.disable(),this.isSpectatingSelf&&this.stopSpectating(),this.orbit&&(this.orbit.enabled=!0)}followSelf(){this.target=this.context.players.getPlayerView(this.context.connection.connectionId),this.target||(this.context.players.setPlayerView(this.localId,this.context.mainCamera,Ho.Headset),this.target=this.context.players.getPlayerView(this.localId)),$n&&console.log("Follow self",this.target)}onAfterRender(){var d,u,f;if(!this.cam)return;const e=this.context.renderer,i=e.xr.enabled;if(!e.xr.isPresenting&&!((d=this._handler)!=null&&d.currentTarget))return;(u=this._handler)==null||u.update(this._mode);const n=e.getRenderTarget();let o=null;const r=e.state;if(!n||n.isXRRenderTarget===!0){if(!e.state.bindFramebuffer||!r.bindXRFramebuffer)return;o=e._framebuffer,r.bindXRFramebuffer(null)}this.setAvatarFlagsBeforeRender();const l=this.context.mainCameraComponent;if(l){const p=l.backgroundColor;p&&e.setClearColor(p,p.alpha),this.cam.backgroundColor=p,this.cam.clearFlags=l.clearFlags,this.cam.nearClipPlane=l.nearClipPlane,this.cam.farClipPlane=l.farClipPlane}else e.setClearColor(new Se(1,1,1));e.setRenderTarget(null),e.xr.enabled=!1;const c=(f=this.cam)==null?void 0:f.threeCamera;this.context.updateAspect(c);const h=e.xr.isPresenting;e.xr.isPresenting=!1,e.setSize(this.context.domWidth,this.context.domHeight),e.render(this.context.scene,c),e.xr.isPresenting=h,e.xr.enabled=i,n?e.setRenderTarget(n):r.bindXRFramebuffer&&r.bindXRFramebuffer(o),this.resetAvatarFlags()}setAvatarFlagsBeforeRender(){const e=this._mode===rd.FirstPerson;for(const i of ni.instances)if(i.avatar&&"isLocalAvatar"in i.avatar&&"flags"in i.avatar){let n=ms.All;this.isSpectatingSelf&&(n=e&&i.avatar.isLocalAvatar?ms.FirstPerson:ms.ThirdPerson);const o=i.avatar.flags;if(!o)continue;for(const r of o)r.UpdateVisible(n)}}resetAvatarFlags(){var e;for(const i of ni.instances)if(i.avatar&&"flags"in i.avatar){const n=i.avatar.flags;if(!n)continue;for(const o of n)"isLocalAvatar"in i.avatar&&((e=i.avatar)!=null&&e.isLocalAvatar)?o.UpdateVisible(ms.FirstPerson):o.UpdateVisible(ms.ThirdPerson)}}}kj([g()],Wv.prototype,"useKeys",void 0);class Ej{constructor(t,e,i){a(this,"context");a(this,"cam");a(this,"spectator");a(this,"follow");a(this,"target");a(this,"view");a(this,"currentObject");this.context=t,this.cam=e,this.spectator=i}get currentTarget(){return this.view}set(t){const e=t==null?void 0:t.currentObject;if(!e){this.spectator.stopSpectating();return}e!==this.currentObject&&(this.currentObject=e,this.view=t,this.follow||(this.follow=I.addComponent(this.cam.gameObject,qo)),this.target||(this.target=new z),e.add(this.target),this.follow.enabled=!0,this.follow.target=this.target,$n&&console.log("FOLLOW",e),this.context.isInXR?this.context.removeCamera(this.cam):this.context.setCurrentCamera(this.cam))}disable(){$n&&console.log("STOP FOLLOW",this.currentObject),this.view=void 0,this.currentObject=void 0,this.context.removeCamera(this.cam),this.follow&&(this.follow.enabled=!1)}destroy(){var t;(t=this.target)==null||t.removeFromParent(),this.follow&&I.destroy(this.follow)}update(t){var n,o,r,l,c,h;if(((n=this.currentTarget)==null?void 0:n.isConnected)===!1||((o=this.currentTarget)==null?void 0:o.removed)===!0){$n&&console.log("Target disconnected or timeout",this.currentTarget),this.spectator.stopSpectating();return}this.currentTarget&&((r=this.currentTarget)==null?void 0:r.currentObject)!==this.currentObject&&($n&&console.log("Target changed",this.currentObject,"to",this.currentTarget.currentObject),this.set(this.currentTarget));const e=this.context.mainCamera;if(e){const d=this.cam.threeCamera;(d.near!==e.near||d.far!==e.far)&&(d.near=e.near,d.far=e.far,d.updateProjectionMatrix())}const i=(l=this.follow)==null?void 0:l.target;if(!(!i||!this.follow)){switch(t){case rd.FirstPerson:((c=this.view)==null?void 0:c.viewDevice)!==Ho.Browser?(this.follow.followFactor=5,this.follow.rotateFactor=5):(this.follow.followFactor=50,this.follow.rotateFactor=50),i.position.set(0,0,0);break;case rd.ThirdPerson:this.follow.followFactor=3,this.follow.rotateFactor=2,i.position.set(0,.5,1.5);break}this.follow.flipForward=!1,((h=this.view)==null?void 0:h.viewDevice)!==Ho.Browser?i.quaternion.copy(Mj):i.quaternion.identity()}}}const Mj=new re().setFromAxisAngle(new R(0,1,0),Math.PI);class Aj{constructor(t,e){a(this,"context");a(this,"spectator");this.context=t,this.spectator=e,console.log("[Spectator Camera] Click other avatars or cameras to follow them. Press ESC to exit spectator mode."),this.context.domElement.addEventListener("keydown",n=>{if(!this.spectator.useKeys)return;n.key==="Escape"&&this.spectator.stopSpectating()});let i=0;this.context.input.addEventListener(Le.PointerDown,n=>{i=this.context.time.time}),this.context.input.addEventListener(Le.PointerUp,n=>{const o=this.context.time.time-i;o>1?this.spectator.stopSpectating():this.context.input.getPointerClicked(0)&&o<.3&&this.trySelectObject()})}trySelectObject(){const t=new Ya;t.setMask(16777215);const e=this.context.physics.raycast(t);if($n&&console.log(...e),e!=null&&e.length)for(const i of e){if(i.distance<.2)continue;const n=i.object,o=oi.getFor(n);let r=o==null?void 0:o.owner;if(!r){const l=I.getComponentInParent(n,ni);r=l==null?void 0:l.connectionId}if(r){const l=this.context.players.getPlayerView(r);this.spectator.target=l,$n&&console.log("spectate",r,o);break}}}}class Ij{constructor(t,e,i){a(this,"guid");a(this,"dontSave",!0);a(this,"targetUserId");a(this,"stoppedFollowing");this.guid=t,this.targetUserId=e,this.stoppedFollowing=i}}class Lj{constructor(t,e){a(this,"guid");a(this,"userId");this.guid=t.guid,this.userId=e}}class Dj{constructor(t,e){a(this,"followers",[]);a(this,"context");a(this,"spectator");a(this,"_followerEventMethod");a(this,"_requestFollowMethod");a(this,"_joinedRoomMethod");a(this,"_lastRequestFollowUser");a(this,"_enforceFollowInterval");this.context=t,this.spectator=e,this._followerEventMethod=this.onFollowerEvent.bind(this),this._requestFollowMethod=this.onRequestFollowEvent.bind(this),this._joinedRoomMethod=this.onUserJoinedRoom.bind(this)}awake(){this.context.connection.beginListen("spectator-follower-changed",this._followerEventMethod),this.context.connection.beginListen("spectator-request-follow",this._requestFollowMethod),this.context.connection.beginListen(me.JoinedRoom,this._joinedRoomMethod),this.context.domElement.addEventListener("keydown",t=>{this.spectator.useKeys&&(t.key==="f"?this.onRequestFollowMe():t.key==="Escape"&&this.onRequestFollowMe(!0))})}destroy(){this.context.connection.stopListen("spectator-follower-changed",this._followerEventMethod),this.context.connection.stopListen("spectator-request-follow",this._requestFollowMethod),this.context.connection.stopListen(me.JoinedRoom,this._joinedRoomMethod)}onSpectatedObjectChanged(t,e){if($n&&console.log(this.context.connection.connectionId,"onSpectatedObjectChanged",t,e),this.context.connection.connectionId){const i=(t==null?void 0:t.userId)===void 0,n=i?e:t==null?void 0:t.userId,o=new Ij(this.context.connection.connectionId,n,i);this.context.connection.send("spectator-follower-changed",o)}}onRequestFollowMe(t=!1){if($n&&console.log("Request follow",this.context.connection.connectionId),this.context.connection.connectionId){this.spectator.stopSpectating();const e=t?void 0:this.context.connection.connectionId,i=new Lj(this.spectator,e);this.context.connection.send("spectator-request-follow",i)}}onUserJoinedRoom(){k("followme")&&this.onRequestFollowMe()}onFollowerEvent(t){const e=t.targetUserId,i=t.guid;if($n&&console.log(t),e===this.context.connection.connectionId)if(t.stoppedFollowing){const n=this.followers.indexOf(i);n!==-1&&(this.followers.splice(n,1),this.removeDisconnectedFollowers(),console.log(i,"unfollows you",this.followers.length))}else this.followers.includes(i)||(this.followers.push(i),this.removeDisconnectedFollowers(),console.log(i,"follows you",this.followers.length))}removeDisconnectedFollowers(){for(let t=this.followers.length-1;t>=0;t--){const e=this.followers[t];this.context.connection.userIsInRoom(e)===!1&&this.followers.splice(t,1)}}onRequestFollowEvent(t){if(this._lastRequestFollowUser=t,t.userId===this.context.connection.connectionId)this.spectator.stopSpectating();else if(t.userId===void 0)this.spectator.stopSpectating();else{const e=this.context.players.getPlayerView(t.userId);if(e)this.spectator.target=e;else return $n&&console.warn("Could not find view",t.userId),this.enforceFollow(),!1}return!0}enforceFollow(){this._enforceFollowInterval||(this._enforceFollowInterval=setInterval(()=>{this._lastRequestFollowUser===void 0||this._lastRequestFollowUser.userId&&this.spectator.isFollowedBy(this._lastRequestFollowUser.userId)?(clearInterval(this._enforceFollowInterval),this._enforceFollowInterval=void 0):($n&&console.log("REQUEST FOLLOW AGAIN",this._lastRequestFollowUser.userId),this.onRequestFollowEvent(this._lastRequestFollowUser))},1e3))}}var Td=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const RC=k("debugsplines");class Xr{constructor(){a(this,"position",new R);a(this,"rotation",new re);a(this,"tangentIn",new R);a(this,"tangentOut",new R)}}Td([Nt(R)],Xr.prototype,"position",void 0);Td([Nt(re)],Xr.prototype,"rotation",void 0);Td([Nt(R)],Xr.prototype,"tangentIn",void 0);Td([Nt(R)],Xr.prototype,"tangentOut",void 0);class Rd extends W{constructor(){super(...arguments);a(this,"_closed",!1);a(this,"spline",[]);a(this,"_isDirty",!1);a(this,"_curve",null);a(this,"_builtCurve",!1);a(this,"_debugLine",null)}addKnot(e){if(e instanceof Xr)this.spline.push(e),this._isDirty=!0;else{const i=new Xr;i.position.copy(e.position),this.spline.push(i),this._isDirty=!0}return this}removeKnot(e){if(typeof e=="number")this.spline.splice(e,1),this._isDirty=!0;else{const i=this.spline.indexOf(e);i!==-1&&(this.spline.splice(i,1),this._isDirty=!0)}return this}getPointAt(e,i){if(!this.curve)return new R;const n=this.curve.getPointAt(ee.clamp01(e),i),o=this.gameObject.matrixWorld??void 0;return o&&n.applyMatrix4(o),n}markDirty(){this._isDirty=!0}getTangentAt(e,i){if(!this.curve)return i??new R;const n=this.gameObject.worldQuaternion;return this.curve.getTangentAt(ee.clamp01(e),i).applyQuaternion(n)}set closed(e){this._closed=e,this._isDirty=!0}get closed(){return this._closed}set debug(e){e&&!this._builtCurve&&this.buildCurve(),this._debugLine&&(this._debugLine.visible=e)}get curve(){return this._curve}get isDirty(){return this._isDirty}awake(){RC&&(console.log(`[Spline] ${this.name}`,this),this.buildCurve())}update(){this._isDirty&&this.buildCurve(!0),this._debugLine&&this._debugLine.parent!==this.gameObject&&this.gameObject.add(this._debugLine)}buildCurve(e=!1){if(!(this._builtCurve&&!e)){if(this._builtCurve=!0,!this.spline){console.error("[Spline] Can not build curve, no spline data",this.name);return}this._isDirty=!1,this._curve=jj(this.spline,this.closed),this.buildDebugCurve()}}buildDebugCurve(){var e,i;if(RC&&this.spline&&this._curve){(e=this._debugLine)==null||e.removeFromParent(),this._debugLine=null;const n=new O0({color:6684927}),o=this.spline.length*10,r=this._curve.getPoints(o),l=new Gs().setFromPoints(r);this._debugLine=new Hh(l,n),(i=this.gameObject)==null||i.add(this._debugLine)}}}Td([Nt()],Rd.prototype,"closed",null);Td([Nt(Xr)],Rd.prototype,"spline",void 0);function jj(s,t){const e=s.map(o=>new R(-o.position.x,o.position.y,o.position.z));e.length===1&&e.push(e[0]);const i=s.reduce((o,r)=>o+Math.abs(r.tangentOut.x)+Math.abs(r.tangentOut.y)+Math.abs(r.tangentOut.z),0)/s.length,n=ee.remap(i,0,.3,0,.5);return new Pk(e,t,"catmullrom",n)}var al=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class ao extends W{constructor(){super(...arguments);a(this,"spline",null);a(this,"object");a(this,"useLookAt",!0);a(this,"lookAt",null);a(this,"clamp",!1);a(this,"autoRun",!0);a(this,"duration",10);a(this,"pullStrength",1);a(this,"_position01",0);a(this,"_needsUpdate",!1);a(this,"onUserInput",()=>{var e;(e=this.object)!=null&&e.contains(this.context.mainCamera)&&(this._needsUpdate=!1,this._performedUpdates+=999)});a(this,"_lastPosition01",0);a(this,"_requiredUpdates",0);a(this,"_performedUpdates",0);a(this,"_lastPositionVector",new R)}get position01(){return this._position01}set position01(e){this._position01=e,this._needsUpdate=!0}reset(){this._position01=0}start(){this.object===void 0&&(this.object=this.gameObject),this.updateFromPosition()}onEnable(){window.addEventListener("pointerdown",this.onUserInput,{passive:!0}),this.context.domElement.addEventListener("wheel",this.onUserInput,{passive:!0})}onDisable(){window.removeEventListener("pointerdown",this.onUserInput),this.context.domElement.removeEventListener("wheel",this.onUserInput)}update(){this.autoRun&&(this._needsUpdate=!0,this._position01+=this.context.time.deltaTime/this.duration),this._needsUpdate&&(this._needsUpdate=!1,this.updateFromPosition())}updateFromPosition(){if(!this.spline||!this.spline.curve||!this.object)return;this.clamp?this._position01=ee.clamp01(this._position01):this._position01=this._position01%1;const e=this._position01>=1?1:this._position01%1,i=this.spline.getPointAt(e);if(this.pullStrength>=1)this.object.worldPosition=i;else if(this._position01!==this._lastPosition01&&(this._performedUpdates=0),this._requiredUpdates=Math.round(100/this.pullStrength),this._performedUpdates<this._requiredUpdates){const n=this.object.worldPosition;this._performedUpdates++;const o=ee.clamp01(this.pullStrength),r=this.object.worldPosition=n.lerp(i,o*(this.context.time.deltaTime/.3));this._lastPositionVector.copy(r),this._needsUpdate=!0}if(this.useLookAt)if(this.lookAt)this.object.lookAt(this.lookAt.worldPosition);else{const n=this.spline.getTangentAt(e);this.object.lookAt(i.add(n))}this._lastPosition01=this._position01}}al([Nt(Rd)],ao.prototype,"spline",void 0);al([Nt(z)],ao.prototype,"object",void 0);al([Nt()],ao.prototype,"useLookAt",void 0);al([Nt(z)],ao.prototype,"lookAt",void 0);al([Nt()],ao.prototype,"clamp",void 0);al([Nt()],ao.prototype,"position01",null);al([Nt()],ao.prototype,"autoRun",void 0);al([Nt()],ao.prototype,"duration",void 0);class Ao{constructor(){a(this,"bb",null);a(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}static getRootAsSyncedCameraModel(t,e){return(e||new Ao).__init(t.readInt32(t.position())+t.position(),t)}static getSizePrefixedRootAsSyncedCameraModel(t,e){return t.setPosition(t.position()+H0),(e||new Ao).__init(t.readInt32(t.position())+t.position(),t)}userId(t){const e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__string(this.bb_pos+e,t):null}guid(t){const e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__string(this.bb_pos+e,t):null}dontSave(){const t=this.bb.__offset(this.bb_pos,8);return t?!!this.bb.readInt8(this.bb_pos+t):!1}pos(t){const e=this.bb.__offset(this.bb_pos,10);return e?(t||new nc).__init(this.bb_pos+e,this.bb):null}rot(t){const e=this.bb.__offset(this.bb_pos,12);return e?(t||new nc).__init(this.bb_pos+e,this.bb):null}static startSyncedCameraModel(t){t.startObject(5)}static addUserId(t,e){t.addFieldOffset(0,e,0)}static addGuid(t,e){t.addFieldOffset(1,e,0)}static addDontSave(t,e){t.addFieldInt8(2,+e,0)}static addPos(t,e){t.addFieldStruct(3,e,0)}static addRot(t,e){t.addFieldStruct(4,e,0)}static endSyncedCameraModel(t){return t.endObject()}static finishSyncedCameraModelBuffer(t,e){t.finish(e)}static finishSizePrefixedSyncedCameraModelBuffer(t,e){t.finish(e,void 0,!0)}}var Fj=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const ig="SCAM";W1(ig,Ao.getRootAsSyncedCameraModel);const An=new Tf;class Bj{constructor(t,e){a(this,"userId");a(this,"guid");this.guid=e,this.userId=t}send(t,e){if(t){An.clear();const i=An.createString(this.guid),n=An.createString(this.userId);Ao.startSyncedCameraModel(An),Ao.addGuid(An,i),Ao.addUserId(An,n);const o=ve(t),r=z0(t);Ao.addPos(An,nc.createVec3(An,o.x,o.y,o.z)),Ao.addRot(An,nc.createVec3(An,r.x,r.y,r.z));const l=Ao.endSyncedCameraModel(An);An.finish(l,ig),e.sendBinary(An.asUint8Array())}}}const fg=class extends W{constructor(){super(...arguments);a(this,"cameraPrefab",null);a(this,"_lastWorldPosition");a(this,"_lastWorldQuaternion");a(this,"_model",null);a(this,"_needsUpdate",!0);a(this,"_lastUpdateTime",0);a(this,"remoteCams",{});a(this,"userToCamMap",{});a(this,"_camTimeoutInSeconds",10);a(this,"_receiveCallback",null)}getCameraObject(e){const i=this.userToCamMap[e];return i?this.remoteCams[i].obj:null}async awake(){this._lastWorldPosition=this.worldPosition.clone(),this._lastWorldQuaternion=this.worldQuaternion.clone(),this.cameraPrefab&&("uri"in this.cameraPrefab&&(this.cameraPrefab=await this.cameraPrefab.instantiate(this.gameObject)),this.cameraPrefab&&"isObject3D"in this.cameraPrefab&&(this.cameraPrefab.visible=!1))}onEnable(){this._receiveCallback=this.context.connection.beginListenBinary(ig,this.onReceivedRemoteCameraInfoBin.bind(this))}onDisable(){this.context.connection.stopListenBinary(ig,this._receiveCallback)}update(){for(const o in this.remoteCams){const r=this.remoteCams[o],l=this.context.time.realtimeSinceStartup-r.lastUpdate;if(!r||l>this._camTimeoutInSeconds){X()&&console.log("Remote cam timeout",o),r!=null&&r.obj&&I.destroy(r.obj),delete this.remoteCams[o],r&&delete this.userToCamMap[r.userId],fg.instances.push(r),this.context.players.removePlayerView(r.userId,Ho.Browser);continue}}if(this.context.isInXR)return;const e=this.context.mainCamera;if(e===null){this.enabled=!1;return}if(!this.context.connection.isConnected||this.context.connection.connectionId===null)return;this._model===null&&(this._model=new Bj(this.context.connection.connectionId,this.context.connection.connectionId+"_camera"));const i=ve(e),n=Qe(e);(i.distanceTo(this._lastWorldPosition)>.001||n.angleTo(this._lastWorldQuaternion)>.01)&&(this._needsUpdate=!0),this._lastWorldPosition.copy(i),this._lastWorldQuaternion.copy(n),!((!this._needsUpdate||this.context.time.frameCount%2!==0)&&!(this.context.time.realtimeSinceStartup-this._lastUpdateTime>this._camTimeoutInSeconds*.5))&&(this._lastUpdateTime=this.context.time.realtimeSinceStartup,this._needsUpdate=!1,this._model.send(e,this.context.connection),this.context.isInXR||this.context.players.setPlayerView(this.context.connection.connectionId,e,Ho.Browser))}onReceivedRemoteCameraInfoBin(e){const i=e.guid();if(!i)return;const n=e.userId();if(!n||!this.context.connection.userIsInRoom(n)||!this.cameraPrefab)return;let o=this.remoteCams[i];if(!o)if("isObject3D"in this.cameraPrefab){const h=new er;h.context=this.context;const d=I.instantiate(this.cameraPrefab,h);o=this.remoteCams[i]={obj:d,lastUpdate:this.context.time.realtimeSinceStartup,userId:n},o.obj.visible=!0,this.gameObject.add(d),this.userToCamMap[n]=i,fg.instances.push(o);const u=I.getOrAddComponent(d,ni);u.connectionId=n,u.avatar=d}else return;const r=o.obj;this.context.players.setPlayerView(n,r,Ho.Browser),o.lastUpdate=this.context.time.realtimeSinceStartup,Qs.markDirty(r);const l=e.pos();l&&Qh(r,l.x(),l.y(),l.z());const c=e.rot();c&&Mg(r,c.x(),c.y(),c.z())}};let Nh=fg;a(Nh,"instances",[]);Fj([g([z,we])],Nh.prototype,"cameraPrefab",void 0);var ll=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Kb="view",Zb=k("debugsyncedroom");class or extends W{constructor(){super(...arguments);a(this,"roomName","");a(this,"urlParameterName","room");a(this,"joinRandomRoom");a(this,"requireRoomParameter",!1);a(this,"autoRejoin",!0);a(this,"createJoinButton",!0);a(this,"createViewOnlyButton",!1);a(this,"_lastJoinedRoom");a(this,"_roomPrefix","");a(this,"_lastPingTime",0);a(this,"_lastRoomTime",-1);a(this,"_userWantsToBeInARoom",!1);a(this,"_roomButton");a(this,"_roomButtonIconJoin");a(this,"_roomButtonIconLeave");a(this,"updateRoomButtonState",()=>{var e,i;this._roomButton&&(this.context.connection.isInRoom?(this._roomButton.title="Leave the networked room",this._roomButton.textContent="Leave Room",(e=this._roomButtonIconJoin)==null||e.remove(),this._roomButton.prepend(this._roomButtonIconLeave)):(this._roomButton.title="Create or join a networked room",this._roomButton.textContent="Join Room",(i=this._roomButtonIconLeave)==null||i.remove(),this._roomButton.prepend(this._roomButtonIconJoin)))});a(this,"_viewOnlyButton");a(this,"onCreateViewOnlyButton",()=>{if(!this._viewOnlyButton){const e=document.createElement("button");this._viewOnlyButton=e,e.classList.add("view-only-button"),e.setAttribute("priority","90"),e.onclick=()=>{var n;const i=this.getViewOnlyUrl();i!=null&&i.length?navigator.canShare({url:i})?(n=navigator.share({url:i}))==null||n.catch(o=>{console.warn(o)}):(navigator.clipboard.writeText(i),at("View only URL copied to clipboard")):qe("Could not create view only URL")},e.title="Copy the view only URL: A page accessed by the view only URL can not be modified by visiting users.",e.textContent="Share View URL",e.prepend(Qi("visibility"))}this.context.menu.appendChild(this._viewOnlyButton)})}get currentRoomName(){const e=k(Kb);return e||k(this.urlParameterName)}set roomPrefix(e){this._roomPrefix=e}get roomPrefix(){return this._roomPrefix}awake(){var e;this.joinRandomRoom===void 0&&((e=this.roomName)==null?void 0:e.length)<=0&&(this.joinRandomRoom=!0),Zb&&console.log(`SyncedRoom roomName:${this.roomName}, urlParamName:${this.urlParameterName}, joinRandomRoom:${this.joinRandomRoom}`)}onEnable(){const e=k(Kb);if(e&&typeof e=="string"&&e.length>0){console.log("Join as viewer"),this.context.connection.joinRoom(e,!0);return}if(this.tryJoinRoom(),this.createJoinButton){const i=this.createRoomButton();this.context.menu.appendChild(i)}this.createViewOnlyButton&&this.onEnableViewOnlyButton()}onDisable(){var e;(e=this._roomButton)==null||e.remove(),this.onDisableViewOnlyButton(),this.roomName&&this.roomName.length>0&&this.context.connection.leaveRoom(this.roomName)}onDestroy(){this.destroyRoomButton()}tryJoinRandomRoom(){this.setRandomRoomUrlParameter(),this.tryJoinRoom()}tryJoinRoom(e=0){var n;e===void 0&&(e=0);let i=!1;if(((n=this.urlParameterName)==null?void 0:n.length)>0){const o=k(this.urlParameterName);if(o&&(typeof o=="string"||typeof o=="number")){i=!0;const r=fE(o.toString());this.roomName=r}else if(this.joinRandomRoom&&(console.log("No room name found in url, generating random one"),this.setRandomRoomUrlParameter(),e<1))return this.tryJoinRoom(e+1)}else this.joinRandomRoom&&(this.roomName===null||this.roomName===void 0||this.roomName.length<=0)&&(this.roomName=this.generateRoomName());return this.requireRoomParameter&&!i?((Zb||X())&&console.warn('[SyncedRoom] Missing required room parameter "'+this.urlParameterName+`" in url - will not connect.
To allow joining a room without a query parameter you can set "requireRoomParameter" to false.`),!1):(this.context.connection.isConnected||this.context.connection.connect(),this._lastJoinedRoom=this.roomName,this._roomPrefix&&(this.roomName=this._roomPrefix+this.roomName),this.roomName.length<=0?(console.warn(`[SyncedRoom] Room name is not set so we can not join a networked room.
Please choose one of the following options to fix this:
A) Set a room name in the SyncedRoom component
B) Set a room name in the URL parameter "?`+this.urlParameterName+`=my_room"
C) Set "joinRandomRoom" to true`),!1):(Zb&&console.log("Join "+this.roomName),this._userWantsToBeInARoom=!0,this.context.connection.joinRoom(this.roomName),!0))}update(){this.context.connection.isConnected&&(this.context.time.time-this._lastPingTime>3&&(this._lastPingTime=this.context.time.time,this.context.connection.sendPing()),this.context.connection.isInRoom&&(this._lastRoomTime=this.context.time.time)),this._lastRoomTime>0&&this.context.time.time-this._lastRoomTime>.3&&(this._lastRoomTime=-1,this.autoRejoin?this._userWantsToBeInARoom&&(console.log("Disconnected from networking backend - attempt reconnecting now"),this.tryJoinRoom()):X()&&console.warn("You are not connected to a room anymore (possibly because the tab was inactive for too long and the server kicked you?)"))}getViewOnlyUrl(){if(this.context.connection.isConnected&&this.context.connection.currentRoomViewId){const e=window.location.search,i=new URLSearchParams(e);return i.has(this.urlParameterName)&&i.delete(this.urlParameterName),i.set(Kb,this.context.connection.currentRoomViewId),window.location.origin+window.location.pathname+"?"+i.toString()}return null}setRandomRoomUrlParameter(){const e=Rg(),i=this.generateRoomName();k(this.urlParameterName)?e.set(this.urlParameterName,i):e.append(this.urlParameterName,i),u1(i,e)}generateRoomName(){let e="";for(let i=0;i<6;i++)e+=Math.floor(Math.random()*10).toFixed(0);return e}createRoomButton(){if(this._roomButton)return this._roomButton;const e=document.createElement("button");return this._roomButton=e,e.classList.add("create-room-button"),e.setAttribute("priority","90"),e.onclick=()=>{if(this.context.connection.isInRoom)this.urlParameterName&&vm(this.urlParameterName,null),this.context.connection.leaveRoom(),this._userWantsToBeInARoom=!1;else{if(this.urlParameterName){const i=k(this.urlParameterName);(!i||i===!0)&&(this._lastJoinedRoom?vm(this.urlParameterName,this._lastJoinedRoom):this.setRandomRoomUrlParameter())}this.tryJoinRoom()}},this._roomButtonIconJoin=Qi("group"),this._roomButtonIconLeave=Qi("group_off"),this.updateRoomButtonState(),this.context.connection.beginListen(me.JoinedRoom,this.updateRoomButtonState),this.context.connection.beginListen(me.LeftRoom,this.updateRoomButtonState),e}destroyRoomButton(){this.context.connection.stopListen(me.JoinedRoom,this.updateRoomButtonState),this.context.connection.stopListen(me.LeftRoom,this.updateRoomButtonState)}onEnableViewOnlyButton(){this.context.connection.isConnected?this.onCreateViewOnlyButton():(this.context.connection.stopListen(me.JoinedRoom,this.onCreateViewOnlyButton),this.context.connection.beginListen(me.JoinedRoom,this.onCreateViewOnlyButton))}onDisableViewOnlyButton(){var e;this.context.connection.stopListen(me.JoinedRoom,this.onCreateViewOnlyButton),(e=this._viewOnlyButton)==null||e.remove()}}ll([g()],or.prototype,"roomName",void 0);ll([g()],or.prototype,"urlParameterName",void 0);ll([g()],or.prototype,"joinRandomRoom",void 0);ll([g()],or.prototype,"requireRoomParameter",void 0);ll([g()],or.prototype,"autoRejoin",void 0);ll([g()],or.prototype,"createJoinButton",void 0);ll([g()],or.prototype,"createViewOnlyButton",void 0);ll([g()],or.prototype,"roomPrefix",null);function Uj(){const s=k("testwindowcount")||0;s&&s>0&&Nj(s)}function Nj(s){if(k("testwindow"))return null;const t=new URL(window.location.href);Hx(t.searchParams,ZL,1),Hx(t.searchParams,"testwindow",1);const e=t.toString(),i=[];window.onbeforeunload=()=>{for(const c of i)c.close()};const n=.05,o=128;let r=0,l=0;for(let c=0;c<s;c++){r*o+o*.01>=window.innerWidth&&(l+=1,r=0);const h=r*(o*(1+n))+window.screenLeft,d=l*(o*(1+n))+window.screenTop+90+60*l;r+=1;const u=window.open(e,"test window "+c,`popup=yes width=${o} height=${o} top=${d} left=${h}`);if(!u){console.warn("Failed to open window");continue}i.push(u),u.onload=()=>{u.onbeforeunload=()=>{for(let f=0;f<i.length;f++){const p=i[f];p!==u&&p.close()}i.length=0}}}return i}class RR extends W{awake(){Uj()}}class OR extends W{constructor(){super(...arguments);a(this,"transformsPerFrame",10);a(this,"interval",0);a(this,"useFlatbuffers",!0);a(this,"builder",null);a(this,"models",null)}awake(){if(this.useFlatbuffers)this.context.connection.beginListenBinary(bf,e=>{});else{this.models=[];for(let e=0;e<this.transformsPerFrame;e++)this.models.push(new kR(this.context.connection.connectionId+"_simulatedTransform_"+e,this))}}update(){if(this.context.connection.isConnected){if(this.useFlatbuffers){if(!this.context.connection.connectionId||this.context.time.frameCount%this.interval!==0)return;this.builder===null&&(this.builder=new Tf(1024));const e=this.builder;for(let i=0;i<this.transformsPerFrame;i++){e.clear();const n=PT(this.context.connection.connectionId,this);this.context.connection.sendBinary(n)}}else if(this.models)for(let e=0;e<this.models.length;e++){const i=this.models[e];i.dontSave=!0,i.update(this,null),this.context.connection.send("TestSimulateUserData-"+e,i)}}}}class kR{constructor(t,e){a(this,"guid");a(this,"fast",!1);a(this,"position");a(this,"rotation");a(this,"velocity");a(this,"dontSave");this.guid=t,this.position={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0,w:0},this.update(e,null)}isValid(){return this.fast!==void 0||this.position!==void 0||this.rotation!==void 0||this.velocity!==void 0}update(t,e){const i=t.worldPosition;this.position.x=i.x,this.position.y=i.y,this.position.z=i.z;const n=t.worldQuaternion;if(this.rotation.x=n.x,this.rotation.y=n.y,this.rotation.z=n.z,this.rotation.w=n.w,this.fast=!1,e){const o=e.getVelocity();this.velocity===void 0&&(this.velocity={x:0,y:0,z:0}),this.velocity.x=o.x,this.velocity.y=o.y,this.velocity.z=o.z}}}a(kR,"temp",new R);var my=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const zj=k("debugsignals");class Hv{constructor(){a(this,"guid")}}my([g()],Hv.prototype,"guid",void 0);class gy{constructor(){a(this,"signal");a(this,"reaction")}}my([g(Hv)],gy.prototype,"signal",void 0);my([g(je)],gy.prototype,"reaction",void 0);const To=class extends W{constructor(){super(...arguments);a(this,"events")}static invoke(e){if(To.receivers[e]){const i=To.receivers[e];if(!i)return;for(const n of i)n.invoke(e)}}awake(){zj&&console.log("SignalReceiver awake",this)}onEnable(){if(this.events)for(const e of this.events)To.receivers[e.signal.guid]||(To.receivers[e.signal.guid]=[]),To.receivers[e.signal.guid].push(this)}onDisable(){if(this.events){for(const e of this.events)if(To.receivers[e.signal.guid]){const i=To.receivers[e.signal.guid].indexOf(this);i>=0&&To.receivers[e.signal.guid].splice(i,1)}}}invoke(e){if(!this.events||!Array.isArray(this.events))return;const i=typeof e=="object"?e.guid:e;for(const n of this.events)if(n.signal.guid===i)try{if(n.reaction){if(!n.reaction.invoke){console.warn("Missing invoke - possibly a serialization error",n,this);continue}}else{console.warn("Missing reaction for signal",n,this);continue}n.reaction.invoke()}catch(o){console.error(o)}}};let $a=To;a($a,"receivers",{});my([g(gy)],$a.prototype,"events",void 0);var Dn;(function(s){s.Activation="ActivationTrack",s.Animation="AnimationTrack",s.Audio="AudioTrack",s.Control="ControlTrack",s.Marker="MarkerTrack",s.Signal="SignalTrack"})(Dn||(Dn={}));var wo;(function(s){s[s.None=0]="None",s[s.Hold=1]="Hold",s[s.Loop=2]="Loop",s[s.PingPong=3]="PingPong",s[s.Continue=4]="Continue"})(wo||(wo={}));var w0;(function(s){s.Signal="SignalEmitter"})(w0||(w0={}));const $o=k("debugtimeline");class Zf{constructor(){a(this,"director");a(this,"track")}get muted(){return this.track.muted}set muted(t){var e;t!==this.track.muted&&(this.track.muted=t,(e=this.onMuteChanged)==null||e.call(this))}*forEachClip(t=!1){var e;if((e=this.track)!=null&&e.clips)if(t)for(let i=this.track.clips.length-1;i>=0;i--)yield this.track.clips[i];else for(const i of this.track.clips)yield i}getClipTime(t,e){return e.clipIn+(t-e.start)*e.timeScale}getClipTimeNormalized(t,e){return(t-e.start)/e.duration}evaluateWeight(t,e,i,n=!0){if(e<0||e>=i.length)return 0;const o=i[e];if(n||t>=o.start&&t<=o.end){let r=1;const l=!1;if(o.easeInDuration>0){const c=Math.min((t-o.start)/o.easeInDuration,1);r*=c}if(o.easeOutDuration>0&&!l){const c=Math.min((o.end-t)/o.easeOutDuration,1);r*=c}return r}return 0}}class $j{constructor(t){a(this,"clip");a(this,"rootPositionOffset");a(this,"rootQuaternionOffset");a(this,"rootStartPosition");a(this,"rootEndPosition");a(this,"rootStartQuaternion");a(this,"rootEndQuaternion");const e=t.getClip();this.clip=e;const i=t.getRoot(),n=i.name+".position",o=i.name+".quaternion";$o&&console.log(e.name,e.tracks,n);for(const r of e.tracks)if(!(r.times.length<=0)){if(r.name.endsWith(n))this.rootStartPosition=new R().fromArray(r.values,0),this.rootEndPosition=new R().fromArray(r.values,r.values.length-3),this.rootPositionOffset=this.rootEndPosition.clone().sub(this.rootStartPosition),$o&&console.log(this.rootPositionOffset);else if(r.name.endsWith(o)&&(this.rootStartQuaternion=new re().fromArray(r.values,0),this.rootEndQuaternion=new re().fromArray(r.values,r.values.length-4),this.rootQuaternionOffset=this.rootEndQuaternion.clone().multiply(this.rootStartQuaternion),$o)){const l=new Ht().setFromQuaternion(this.rootQuaternionOffset);console.log("ROT",l)}}}get hasOffsets(){return this.rootPositionOffset!==void 0||this.rootQuaternionOffset!==void 0}}class ng extends Zf{constructor(){super(...arguments);a(this,"models",[]);a(this,"trackOffset");a(this,"target");a(this,"mixer");a(this,"clips",[]);a(this,"actions",[]);a(this,"weight",1);a(this,"_actionOffsets",[]);a(this,"_didBind",!1);a(this,"_animator",null);a(this,"_useclipOffsets",!0);a(this,"_totalOffsetPosition",new R);a(this,"_totalOffsetRotation",new re);a(this,"_totalOffsetPosition2",new R);a(this,"_totalOffsetRotation2",new re);a(this,"_summedPos",new R);a(this,"_tempPos",new R);a(this,"_summedRot",new re);a(this,"_tempRot",new re);a(this,"_clipRotQuat",new re)}onDisable(){var e;(e=this.mixer)==null||e.stopAllAction()}onDestroy(){this.director.context.animations.unregisterAnimationMixer(this.mixer)}onStateChanged(){this._animator&&kS(this._animator.gameObject,this,this.director.enabled&&this.director.weight>0)}createHooks(e,i){var l,c,h;if(((l=i.tracks)==null?void 0:l.length)<=0){console.warn("No tracks in AnimationClip",i);return}let n=!1,o=!1;const r=(c=i.tracks.find(d=>d.name.includes(".position")||d.name.includes(".quaternion")))==null?void 0:c.name.split(".");if(r){const d=r[r.length-2],u=d+".position",f=d+".quaternion";for(const p of i.tracks)!n&&p.name.endsWith(u)?(n=!0,this.createPositionInterpolant(i,e,p)):!o&&p.name.endsWith(f)&&(o=!0,this.createRotationInterpolant(i,e,p))}if(!n||!o){const d=(h=this.mixer)==null?void 0:h.getRoot(),u=i.tracks[0],f=u.name.lastIndexOf("."),p=u.name.substring(0,f),b=p.substring(p.lastIndexOf(".")+1),x=d.getObjectByName(b);if(x)if(n){if(!o){const v=i.tracks[0].name.substring(0,f)+".quaternion";$o&&console.warn("Create quaternion track",b,x);const S=new Rk(v,[0,i.duration],[0,0,0,1,0,0,0,1]);i.tracks.push(S),this.createRotationInterpolant(i,e,S)}}else{const v=p+".position";$o&&console.warn("Create position track",b,x);const S=new Tk(v,[0,i.duration],[0,0,0,0,0,0]);i.tracks.push(S),this.createPositionInterpolant(i,e,S)}}}bind(){if(!this._didBind){this._didBind=!0,$o&&console.log(this.models),this.mixer?this.target=this.mixer.getRoot():console.warn("No mixer was assigned to animation track");for(const e of this.actions){const i=new $j(e);this._actionOffsets.push(i)}this.target&&(this._animator=I.getComponent(this.target,Ei)??null,this._animator&&kS(this._animator.gameObject,this,!0));for(const e of this.models){const i=e.asset,n=i.position,o=i.rotation;n&&n.x!==void 0&&(n.isVector3||(i.position=new R(n.x,n.y,n.z)),o.isQuaternion||(i.rotation=new re(o.x,o.y,o.z,o.w)))}this.ensureTrackOffsets()}}ensureTrackOffsets(){if(this.trackOffset){const e=this.trackOffset.position;e&&(e.isVector3||(this.trackOffset.position=new R(e.x,e.y,e.z)));const i=this.trackOffset.rotation;i&&(i.isQuaternion||(this.trackOffset.rotation=new re(i.x,i.y,i.z,i.w)))}}evaluate(e){var c,h,d,u,f,p,b;if(this.track.muted||!this.mixer)return;this.bind(),this._totalOffsetPosition.set(0,0,0),this._totalOffsetRotation.set(0,0,0,1),this._totalOffsetPosition2.set(0,0,0),this._totalOffsetRotation2.set(0,0,0,1);let i=0,n=0,o=!1,r=!1,l=0;for(let x=0;x<this.clips.length;x++){const v=this.models[x],S=this.actions[x],C=v.asset;S.weight=0;const P=e>=v.start&&e<=v.end,E=v.preExtrapolationMode,D=v.postExtrapolationMode,M=x<this.clips.length-1?this.models[x+1]:null;let A=P,G=!1;if(!A&&!o&&v.end<e&&D!==wo.None?(!M||M.start>e)&&(A=!0,o=!0):x==0&&!A&&!r&&v.start>e&&E!==wo.None&&(!M||M.start<e)&&(A=!0,G=!0,r=!0),A){let V=this.weight;V*=this.evaluateWeight(e,x,this.models,A),V*=this.director.weight;let U=P;if(G)switch(E){case wo.Hold:break;case wo.Loop:e+=v.start,U=!0;break;default:e+=v.start,U=!0;break}let $=this.getClipTime(e,v),Y=0;const B=C.duration;if(G&&E===wo.Hold&&($=0),U){if(C.loop)for(Y+=Math.floor($/(B+1e-6));$>B;)$-=B}else if(!P&&o)switch(D){case wo.Hold:$=this.getClipTime(v.end,v);break;case wo.Loop:$%=B;break;case wo.PingPong:const ae=Math.floor($/B)%2!==0;$%=B,ae&&($=B-$);break}v.reversed===!0?S.time=S.getClip().duration-$:S.time=$,S.timeScale=0;const N=Math.max(0,V);if(S.weight=N,l+=N,S.clampWhenFinished=!1,S.isRunning()||S.play(),this._useclipOffsets){const Z=i==0?this._totalOffsetPosition:this._totalOffsetPosition2,ae=i==0?this._totalOffsetRotation:this._totalOffsetRotation2;i<1&&(n=1-V),i+=1;const ie=this._summedPos.set(0,0,0),J=this._tempPos.set(0,0,0),ye=this._summedRot.identity(),Fe=this._tempRot.identity(),Ze=C.rotation;Ze&&(this._clipRotQuat.identity(),this._clipRotQuat.slerp(Ze,V));const Ot=this._actionOffsets[x];if(Ot.hasOffsets)for(let St=0;St<Y;St++)Ot.rootPositionOffset?J.copy(Ot.rootPositionOffset):J.set(0,0,0),J.applyQuaternion(ye),this._clipRotQuat&&J.applyQuaternion(this._clipRotQuat),Ot.rootQuaternionOffset&&(Fe.copy(Ot.rootQuaternionOffset),ye.multiply(Fe)),ie.add(J);this._clipRotQuat&&ae.multiply(this._clipRotQuat),ae.multiply(ye),C.position&&ie.add(C.position),Z.add(ie)}}}if(this._useclipOffsets&&(this._totalOffsetPosition.lerp(this._totalOffsetPosition2,n),this._totalOffsetRotation.slerp(this._totalOffsetRotation2,n)),this.__mixerError===void 0&&($o||X())&&((h=(c=this._animator)==null?void 0:c.runtimeAnimatorController)!=null&&h.mixer)&&this.mixer!==((u=(d=this._animator)==null?void 0:d.runtimeAnimatorController)==null?void 0:u.mixer)&&(this.__mixerError=!0,console.error("AnimationTrack mixer is not shared with the animator controller - this might result in the timeline to not animate properly. Please report a bug to the Needle Engine team!",this)),(f=this._animator)!=null&&f.runtimeAnimatorController){const x=Math.max(0,1-l);(b=(p=this._animator)==null?void 0:p.runtimeAnimatorController)==null||b.update(x)}else this.mixer.update(e)}createRotationInterpolant(e,i,n){var c;const o=n.createInterpolant.bind(n),r=new re;this.ensureTrackOffsets();const l=(c=this.trackOffset)==null?void 0:c.rotation;n.createInterpolant=()=>{const h=o(),d=h.evaluate.bind(h);return h.evaluate=u=>{var p;const f=d(u);if(r.set(f[0],f[1],f[2],f[3]),r.premultiply(this._totalOffsetRotation),l&&r.premultiply(l),this.director.animationCallbackReceivers)for(const b of this.director.animationCallbackReceivers)(p=b==null?void 0:b.onTimelineRotation)==null||p.call(b,this.director,this.target,u,r);return f[0]=r.x,f[1]=r.y,f[2]=r.z,f[3]=r.w,f},h}}createPositionInterpolant(e,i,n){var d,u;const o=n.createInterpolant.bind(n),r=new R;this.ensureTrackOffsets();const l=(d=this.trackOffset)==null?void 0:d.rotation,c=(u=this.trackOffset)==null?void 0:u.position;let h;n.createInterpolant=()=>{const f=o(),p=f.evaluate.bind(f);return f.evaluate=b=>{var v,S,C;const x=p(b);if(r.set(x[0],x[1],x[2]),i.removeStartOffset&&(h===void 0?(h=null,h=(S=(v=this._actionOffsets.find(P=>P.clip===e))==null?void 0:v.rootStartPosition)==null?void 0:S.clone()):h!=null&&h.isVector3&&r.sub(h)),r.applyQuaternion(this._totalOffsetRotation),r.add(this._totalOffsetPosition),l&&r.applyQuaternion(l),c&&(r.x-=c.x,r.y+=c.y,r.z+=c.z),this.director.animationCallbackReceivers)for(const P of this.director.animationCallbackReceivers)(C=P==null?void 0:P.onTimelinePosition)==null||C.call(P,this.director,this.target,b,r);return x[0]=r.x,x[1]=r.y,x[2]=r.z,x},f}}}const Vj=k("mutetimeline"),kh=class extends Zf{constructor(){super(...arguments);a(this,"models",[]);a(this,"listener");a(this,"audio",[]);a(this,"audioContextTimeOffset",[]);a(this,"lastTime",0);a(this,"audioSource");a(this,"_audioLoader",null);a(this,"_playableDirectorResumed",!1)}getAudioFilePath(e){const i=this.director.sourceId;return yc(i,e)}onAllowAudioChanged(e){for(let i=0;i<this.models.length;i++){const n=this.models[i];this.audio[i].setVolume(e?n.asset.volume:0)}}addModel(e){const i=new Ok(this.listener);this.audio.push(i);const n=e;n._didTriggerPlay=!1,this.models.push(n)}onDisable(){for(const e of this.audio)e.isPlaying&&e.stop();for(const e of this.models)e._didTriggerPlay=!1}onDestroy(){for(const e of this.audio)e.source&&(e==null||e.disconnect());this.audio.length=0}onMuteChanged(){if(this.muted)for(let e=0;e<this.audio.length;e++){const i=this.audio[e];i!=null&&i.isPlaying&&i.stop()}}stop(){for(let e=0;e<this.audio.length;e++){const i=this.audio[e];i!=null&&i.isPlaying&&i.stop()}for(const e of this.models)e._didTriggerPlay=!1}onPauseChanged(){for(let e=0;e<this.audio.length;e++){const i=this.audio[e];i!=null&&i.isPlaying&&i.stop()}this._playableDirectorResumed=this.director.isPlaying}evaluate(e){if(Vj||this.track.muted||this.director.speed<0)return;const i=this.director.context.application.muted,n=this._playableDirectorResumed;this._playableDirectorResumed=!1;const o=i?.1:0;for(let r=0;r<this.models.length;r++){const l=this.models[r],c=this.audio[r],h=l.asset;if((!c||!c.buffer)&&this.isInTimeRange(l,e-1,e+1)&&this.handleAudioLoading(l,c),We.userInteractionRegistered!==!1&&!(c===null||!c.buffer))if(c.playbackRate=this.director.context.time.timeScale*this.director.speed,c.loop=h.loop,e>=l.start&&e<=l.end&&e<this.director.duration){if(!c.isPlaying||!this.director.isPlaying)(n||!l._didTriggerPlay&&this.lastTime<e)&&(l.duration*l.timeScale>.3?c.offset=l.clipIn+(e-l.start)*l.timeScale:c.offset=0,$o&&console.log("Timeline Audio ("+this.track.name+") play with offset "+c.offset+" - "+l.asset.clip),c.play(o),l._didTriggerPlay=!0);else{const u=l.clipIn+(e-l.start)*l.timeScale,f=c.context.currentTime-c._startedAt+c.offset;Math.abs(u-f)>.3&&(c.offset=u,c.stop(),c.play(o))}let d=h.volume;if(this.track.volume!==void 0&&(d*=this.track.volume),i&&(d=0),l.easeInDuration>0){const u=Math.min((e-l.start)/l.easeInDuration,1);d*=u}if(l.easeOutDuration>0){const u=Math.min((l.end-e)/l.easeOutDuration,1);d*=u}c.setVolume(d*this.director.weight)}else l._didTriggerPlay=!1,this.director.isPlaying&&c.isPlaying&&c.stop()}this.lastTime=e}loadAudio(e,i=0,n=0){let o=null;const r=e-n,l=e+i;for(const c of this.models)if(this.isInTimeRange(c,r,l)){const h=this.audio[this.models.indexOf(c)],d=this.handleAudioLoading(c,h);d!==null&&(o===null&&(o=[]),o.push(d))}return o!==null?Promise.all(o):null}isInTimeRange(e,i,n){return i<=e.start&&n>=e.end||i>=e.start&&i<=e.end||n>=e.start&&n<=e.end}static dispose(){kh._audioBuffers.clear()}handleAudioLoading(e,i){this._audioLoader||(this._audioLoader=new l_);const n=this.getAudioFilePath(e.asset.clip);if(kh._audioBuffers.get(n)){const r=kh._audioBuffers.get(n);return r.then(l=>{l&&i.setBuffer(l)}),r}$o&&console.warn("LOAD audio track",n,this.director.sourceId);const o=new Promise((r,l)=>{this._audioLoader.load(n,c=>{i.setBuffer(c),r(c)},void 0,c=>{console.error("Error loading audio",c),r(null)})});return kh._audioBuffers.set(n,o),o}};let zh=kh;a(zh,"_audioBuffers",new Map);class Gv extends Zf{constructor(){super(...arguments);a(this,"models",[]);a(this,"needsSorting",!0)}*foreachMarker(e=null){this.needsSorting&&this.sort();for(const i of this.models)i&&i.type===e&&(yield i)}onEnable(){this.needsSorting=!0}evaluate(e){this.needsSorting&&this.sort()}sort(){this.needsSorting=!1,this.models.sort((e,i)=>e.time-i.time)}}class sg extends Zf{constructor(){super(...arguments);a(this,"models",[]);a(this,"didTrigger",[]);a(this,"receivers",[])}evaluate(e){var n;if(this.track.muted)return;const i=this.director.context.time.deltaTime*1.5;for(let o=0;o<this.models.length;o++){const r=this.models[o],l=this.didTrigger[o],c=r.time-e;let h=!1;if(r.retroActive)h=c<=1e-6;else{const d=Math.abs(c);(d===0||d>=1e-5&&d<i)&&(h=!0)}if(h){if(!l)if($o&&console.log("Trigger signal",e,r.time,r),this.didTrigger[o]=!0,((n=this.receivers)==null?void 0:n.length)<=0)$a.invoke(r.asset);else for(const d of this.receivers)d&&d.invoke(r.asset)}else r.emitOnce||(this.didTrigger[o]=!1)}}}class qv extends Zf{constructor(){super(...arguments);a(this,"models",[]);a(this,"timelines",[]);a(this,"_previousActiveModel",null)}resolveSourceObjects(e){for(let i=this.models.length-1;i>=0;i--){const o=this.models[i].asset;if(!o.sourceObject||typeof o.sourceObject!="object"){console.log("no source object, removing model",i,o),this.models.splice(i,1);continue}else{const r=I.getComponent(o.sourceObject,Js);this.timelines.push(r),r&&o.updateDirector&&(r.playOnAwake=!1)}}}evaluate(e){var i;this._previousActiveModel=null;for(let n=0;n<this.models.length;n++){const o=this.models[n],r=o.asset;if(e>=o.start&&e<=o.end){this._previousActiveModel=o;const l=this.getClipTime(e,o);if(r.controlActivation){const c=r.sourceObject;c.visible=!0}if(r.updateDirector){const c=this.timelines[n];c&&(c.isPlaying&&c.pause(),c.time=l,c.evaluate())}}else{const l=(i=this._previousActiveModel)==null?void 0:i.asset;if(r.controlActivation){const c=r.sourceObject;(l==null?void 0:l.sourceObject)!==c&&(c.visible=!1)}}}}}var ER=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Ls=k("debugtimeline");var _h;(function(s){s[s.Hold=0]="Hold",s[s.Loop=1]="Loop",s[s.None=2]="None"})(_h||(_h={}));var OC;(function(s){s[s.None=0]="None",s[s.Hold=1]="Hold",s[s.Loop=2]="Loop",s[s.PingPong=3]="PingPong",s[s.Continue=4]="Continue"})(OC||(OC={}));const pg=class extends W{constructor(){super(...arguments);a(this,"playableAsset");a(this,"playOnAwake");a(this,"extrapolationMode",_h.Loop);a(this,"waitForAudio",!0);a(this,"_visibilityChangeEvt");a(this,"_clonedPlayableAsset",!1);a(this,"_speed",1);a(this,"_guidsMap");a(this,"_isPlaying",!1);a(this,"_internalUpdateRoutine");a(this,"_isPaused",!1);a(this,"_isStopping",!1);a(this,"_time",0);a(this,"_duration",0);a(this,"_weight",1);a(this,"_animationTracks",[]);a(this,"_audioTracks",[]);a(this,"_signalTracks",[]);a(this,"_markerTracks",[]);a(this,"_controlTracks",[]);a(this,"_customTracks",[]);a(this,"_tracksArray",[]);a(this,"animationCallbackReceivers",[])}static registerCreateTrack(e,i){this.createTrackFunctions[e]=i}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get time(){return this._time}set time(e){typeof e=="number"&&!Number.isNaN(e)?this._time=e:(Ls||_s())&&console.error("INVALID TIMELINE.TIME VALUE",e,this.name)}get duration(){return this._duration}set duration(e){this._duration=e}get weight(){return this._weight}set weight(e){this._weight=e}get speed(){return this._speed}set speed(e){this._speed=e}awake(){var e,i,n,o;Ls&&console.log(`[Timeline] Awake '${this.name}'`,this),this.rebuildGraph(),!this.isValid()&&(Ls||X())&&(Ls?console.warn("PlayableDirector is not valid","Asset?",this.playableAsset,"Tracks:",(e=this.playableAsset)==null?void 0:e.tracks,"IsArray?",Array.isArray((i=this.playableAsset)==null?void 0:i.tracks),this):(o=(n=this.playableAsset)==null?void 0:n.tracks)!=null&&o.length?console.warn("PlayableDirector is not valid"):console.warn("PlayableDirector has no tracks"))}onEnable(){var e,i,n;Ls&&console.log("[Timeline] OnEnable",this.name,this.playOnAwake);for(const o of this._audioTracks)(e=o.onEnable)==null||e.call(o);for(const o of this._customTracks)(i=o.onEnable)==null||i.call(o);for(const o of this._animationTracks)(n=o.onEnable)==null||n.call(o);this.playOnAwake&&this.play(),this._visibilityChangeEvt||(this._visibilityChangeEvt=()=>{switch(document.visibilityState){case"hidden":this.setAudioTracksAllowPlaying(!1);break;case"visible":this.setAudioTracksAllowPlaying(!0);break}}),window.addEventListener("visibilitychange",this._visibilityChangeEvt)}onDisable(){var e,i,n;Ls&&console.log("[Timeline] OnDisable",this.name),this.stop();for(const o of this._audioTracks)(e=o.onDisable)==null||e.call(o);for(const o of this._customTracks)(i=o.onDisable)==null||i.call(o);for(const o of this._animationTracks)(n=o.onDisable)==null||n.call(o);this._visibilityChangeEvt&&window.removeEventListener("visibilitychange",this._visibilityChangeEvt)}onDestroy(){var e;for(const i of this._allTracks)for(const n of i)(e=n.onDestroy)==null||e.call(n)}rebuildGraph(){this.isValid()&&(this.resolveBindings(),this.updateTimelineDuration(),this.setupAndCreateTrackHandlers())}async play(){if(!this.isValid())return;const e=this._isPaused==!0;if(this._isPaused=!1,!this._isPlaying){if(this._isPlaying=!0,e&&this.invokePauseChangedMethodsOnTracks(),this.waitForAudio){const i=[];for(const n of this._audioTracks){const o=n.loadAudio(this._time,1,0);o&&i.push(o)}if(i.length>0&&(await Promise.all(i),!this._isPlaying))return;for(;this._audioTracks.length>0&&this._isPlaying&&!We.userInteractionRegistered&&this.waitForAudio;)await Ha(200)}this.invokeStateChangedMethodsOnTracks(),this._internalUpdateRoutine=this.startCoroutine(this.internalUpdate(),ge.LateUpdate)}}pause(){this.isValid()&&(this._isPlaying=!1,!this._isPaused&&(this._isPaused=!0,this.internalEvaluate(),this.invokePauseChangedMethodsOnTracks(),this.invokeStateChangedMethodsOnTracks()))}stop(){this._isStopping=!0;for(const n of this._audioTracks)n.stop();const e=this._isPaused==!0,i=this._isPlaying;this._isPlaying&&(this._time=0,this._isPlaying=!1,this._isPaused=!1,this.internalEvaluate(),e&&this.invokePauseChangedMethodsOnTracks()),this._isPlaying=!1,this._isPaused=!1,e&&!i&&this.invokePauseChangedMethodsOnTracks(),i&&this.invokeStateChangedMethodsOnTracks(),this._internalUpdateRoutine&&this.stopCoroutine(this._internalUpdateRoutine),this._internalUpdateRoutine=null,this._isStopping=!1}evaluate(){this.internalEvaluate(!0)}isValid(){return this.playableAsset&&this.playableAsset.tracks&&Array.isArray(this.playableAsset.tracks)}*forEachTrack(){for(const e of this._allTracks)for(const i of e)yield i}get animationTracks(){return this._animationTracks}get audioTracks(){return this._audioTracks}get signalTracks(){return this._signalTracks}get markerTracks(){return this._markerTracks}*foreachMarker(e=null){for(const i of this._markerTracks)for(const n of i.foreachMarker(e))yield n}resolveGuids(e){this._guidsMap=e}get _allTracks(){return this._tracksArray.length=0,this._tracksArray.push(this._animationTracks),this._tracksArray.push(this._audioTracks),this._tracksArray.push(this._signalTracks),this._tracksArray.push(this._markerTracks),this._tracksArray.push(this._controlTracks),this._tracksArray.push(this._customTracks),this._tracksArray}invokePauseChangedMethodsOnTracks(){var e;for(const i of this.forEachTrack())(e=i.onPauseChanged)==null||e.call(i)}invokeStateChangedMethodsOnTracks(){var e;for(const i of this.forEachTrack())(e=i.onStateChanged)==null||e.call(i,this._isPlaying)}*internalUpdate(){for(;this._isPlaying&&this.activeAndEnabled;)!this._isPaused&&this._isPlaying&&(this._time+=this.context.time.deltaTime*this.speed,this.internalEvaluate()),yield}internalEvaluate(e=!1){if(!this.isValid())return;let i=this._time;switch(this.extrapolationMode){case _h.Hold:this._speed>0?i=Math.min(i,this._duration):this._speed<0&&(i=Math.max(i,0)),this._time=i;break;case _h.Loop:i%=this._duration,this._time=i;break;case _h.None:if(i>this._duration){this.stop();return}break}const n=this._time;for(const o of this.playableAsset.tracks)if(!o.muted)switch(o.type){case Dn.Activation:if(!e&&!this._isPlaying)continue;for(let r=0;r<o.outputs.length;r++){const l=o.outputs[r];if(typeof l=="object"){let c=!1;if(o.clips)for(const d of o.clips)d.start<=n&&n<=d.end&&(c=!0);const h=l;h.visible!==void 0&&h.visible!==c&&(h.visible=c,Ls&&console.warn(this.name,"set ActivationTrack-"+r,h.name,c,n))}}break}for(const o of this._allTracks)for(const r of o)this._isStopping&&r instanceof ng||r.evaluate(n)}resolveBindings(){if(this._clonedPlayableAsset||(this._clonedPlayableAsset=!0,this.playableAsset=Og(this.playableAsset)),!this.playableAsset||!this.playableAsset.tracks)return;const e=this.findRoot(this.gameObject);for(const i of this.playableAsset.tracks){for(let n=i.outputs.length-1;n>=0;n--){let o=i.outputs[n];if(typeof o=="string"){this._guidsMap&&this._guidsMap[o]&&(o=this._guidsMap[o]);const r=I.findByGuid(o,e);r===null||typeof r!="object"?(i.outputs.splice(n,1),console.warn("Failed to resolve binding",o,i.name,i.type)):(Ls&&console.log("Resolved binding",o,"to",r),i.outputs[n]=r)}else if(o===null){if(i.outputs.splice(n,1),pg.createTrackFunctions[i.type])continue;i.type!==Dn.Audio&&i.type!==Dn.Control&&i.type!==Dn.Marker&&i.type!==Dn.Signal&&console.warn("Missing binding",o,i.name,i.type,this.name,this.playableAsset.name)}}if(i.type===Dn.Control&&i.clips)for(let n=0;n<i.clips.length;n++){const o=i.clips[n];let r=o.asset.sourceObject;if(typeof r=="string"){this._guidsMap&&this._guidsMap[r]&&(r=this._guidsMap[r]);const l=I.findByGuid(r,e);l===null||typeof l!="object"?console.warn("Failed to resolve sourceObject binding",r,i.name,o):(Ls&&console.log("Resolved binding",r,"to",l),o.asset.sourceObject=l)}}}}findRoot(e){return e.parent?this.findRoot(e.parent):e}updateTimelineDuration(){if(this._duration=0,!(!this.playableAsset||!this.playableAsset.tracks)){for(const e of this.playableAsset.tracks)if(e.muted!==!0){if(e.clips)for(const i of e.clips)i.end>this._duration&&(this._duration=i.end);if(e.markers)for(const i of e.markers)i.time>this._duration&&(this._duration=i.time+.001)}}}setupAndCreateTrackHandlers(){var i,n,o;if(this._animationTracks.length=0,this._audioTracks.length=0,this._signalTracks.length=0,!this.playableAsset)return;let e=I.findObjectOfType(Aa,this.context);for(const r of this.playableAsset.tracks){const l=r.type,c=pg.createTrackFunctions[l];if(c!=null){const h=c(this,r);if(typeof h.evaluate=="function"){h.director=this,h.track=r,this._customTracks.push(h);continue}}if(r.type===Dn.Animation){if(!r.clips||r.clips.length<=0){Ls&&console.warn("Animation track has no clips",r);continue}for(let h=r.outputs.length-1;h>=0;h--){let d=r.outputs[h];if(d instanceof z){const f=I.getOrAddComponent(d,Ei);f&&(d=f)}const u=(i=d==null?void 0:d.gameObject)==null?void 0:i.animations;if(u){const f=new ng;f.trackOffset=r.trackOffset,f.director=this,f.track=r;for(let p=0;p<r.clips.length;p++){const b=r.clips[p],x=b.asset;if(!x){console.error(`Timeline ${this.name}: clip #${p} on track "${r.name}" has no animation data`);continue}const v=x.clip;let S=v;if((typeof S=="string"||typeof S=="number")&&(S=u.find(P=>P.name===v)),Ls&&console.log(x,v,"‚Üí",S),!S){console.warn("Could not find animationClip for model",b,r.name,this.name,(n=this.playableAsset)==null?void 0:n.name,u,d);continue}d instanceof Ei&&d.runtimeAnimatorController&&(d.__internalDidAwakeAndStart||d.initializeRuntimeAnimatorController(),d.runtimeAnimatorController.mixer||d.runtimeAnimatorController.bind(d),f.mixer=d.runtimeAnimatorController.mixer),f.mixer||(f.mixer=new M0(d.gameObject),this.context.animations.registerAnimationMixer(f.mixer)),f.clips.push(S),f.mixer.uncacheAction(S),f.createHooks(b.asset,S);const C=f.mixer.clipAction(S);f.actions.push(C),f.models.push(b)}this._animationTracks.push(f)}}}else if(r.type===Dn.Audio){if(!r.clips||r.clips.length<=0)continue;const h=new zh;h.director=this,h.track=r,h.audioSource=r.outputs.find(d=>d instanceof We),this._audioTracks.push(h),e||(e=(o=this.context.mainCameraComponent)==null?void 0:o.gameObject.addComponent(Aa)),h.listener=e.listener;for(let d=0;d<r.clips.length;d++){const u=r.clips[d];h.addModel(u)}}else if(r.type===Dn.Marker){if(r.markers){const h=new sg;h.director=this,h.track=r;const d=new Gv;d.director=this,d.track=r;for(const u of r.markers)switch(u.type){case w0.Signal:h.models.push(u),h.didTrigger.push(!1);break;default:d.models.push(u);break}if(h!==null&&h.models.length>0){const u=I.getComponent(this.gameObject,$a);u&&(h.receivers.push(u),this._signalTracks.push(h))}d!==null&&d.models.length>0&&this._markerTracks.push(d)}}else if(r.type===Dn.Signal){const h=new sg;if(h.director=this,h.track=r,r.markers)for(const d of r.markers)h.models.push(d),h.didTrigger.push(!1);for(const d of r.outputs)h.receivers.push(d);this._signalTracks.push(h)}else if(r.type===Dn.Control){const h=new qv;if(h.director=this,h.track=r,r.clips)for(const d of r.clips)h.models.push(d);h.resolveSourceObjects(this.context),this._controlTracks.push(h)}}}setAudioTracksAllowPlaying(e){for(const i of this._audioTracks)i.onAllowAudioChanged(e)}registerAnimationCallback(e){this.animationCallbackReceivers.push(e)}unregisterAnimationCallback(e){const i=this.animationCallbackReceivers.indexOf(e);i!==-1&&this.animationCallbackReceivers.splice(i,1)}};let Js=pg;a(Js,"createTrackFunctions",{});ER([g()],Js.prototype,"playOnAwake",void 0);ER([g()],Js.prototype,"extrapolationMode",void 0);var yy=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Od extends W{constructor(){super(...arguments);a(this,"isGizmo",!1);a(this,"translationSnap",1);a(this,"rotationSnapAngle",15);a(this,"scaleSnap",.25);a(this,"_control");a(this,"orbit");a(this,"onControlChangedEvent",e=>{const i=this.orbit;if(i&&(i.enabled=!e.value),e.value){const n=this.gameObject.getComponentInParent(Zo);n&&(n.fastMode=!0,n.requestOwnership())}else{const n=this.gameObject.getComponentInParent(Zo);n&&(n.fastMode=!1)}});a(this,"windowKeyDownListener",e=>{if(this.enabled&&this._control)switch(e.keyCode){case 81:this._control.setSpace(this._control.space==="local"?"world":"local");break;case 16:this.enableSnapping();break;case 87:this._control.setMode("translate");break;case 69:this._control.setMode("rotate");break;case 82:this._control.setMode("scale");break;case 187:case 107:this._control.setSize(this._control.size+.1);break;case 189:case 109:this._control.setSize(Math.max(this._control.size-.1,.1));break;case 88:this._control.showX=!this._control.showX;break;case 89:this._control.showY=!this._control.showY;break;case 90:this._control.showZ=!this._control.showZ;break;case 32:this._control.enabled=!this._control.enabled;break}});a(this,"windowKeyUpListener",e=>{if(this.enabled)switch(e.keyCode){case 16:this.disableSnapping();break}})}get control(){return this._control}onEnable(){var e;if(!(this.isGizmo&&!Of)&&this.context.mainCamera&&(this._control||(this._control=new Xk(this.context.mainCamera,this.context.renderer.domElement),this._control.enabled=!0,this._control.getRaycaster().layers.set(2),this._control.size=1,("_root"in this._control?this._control._root:this._control).traverse(n=>{const o=n;if(o.layers.set(2),o){const r=o.material;r&&(r.opacity=.3)}}),this.orbit=I.getComponentInParent(this.context.mainCamera,He)??void 0),this._control)){const i=this._control.getHelper();this.context.scene.add(i),this._control.attach(this.gameObject),(e=this._control)==null||e.addEventListener("dragging-changed",this.onControlChangedEvent),window.addEventListener("keydown",this.windowKeyDownListener),window.addEventListener("keyup",this.windowKeyUpListener)}}onDisable(){var e,i,n;(i=(e=this._control)==null?void 0:e.getHelper())==null||i.removeFromParent(),(n=this._control)==null||n.removeEventListener("dragging-changed",this.onControlChangedEvent),window.removeEventListener("keydown",this.windowKeyDownListener),window.removeEventListener("keyup",this.windowKeyUpListener)}enableSnapping(){this._control&&(this._control.setTranslationSnap(this.translationSnap),this._control.setRotationSnap(Ar.degToRad(this.rotationSnapAngle)),this._control.setScaleSnap(this.scaleSnap))}disableSnapping(){this._control&&(this._control.setTranslationSnap(null),this._control.setRotationSnap(null),this._control.setScaleSnap(null))}}yy([g()],Od.prototype,"isGizmo",void 0);yy([g()],Od.prototype,"translationSnap",void 0);yy([g()],Od.prototype,"rotationSnapAngle",void 0);yy([g()],Od.prototype,"scaleSnap",void 0);var by=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Xv{constructor(){a(this,"texture",null);a(this,"rect")}}by([g(_t)],Xv.prototype,"texture",void 0);let Jf=class extends ny{constructor(){super(...arguments);a(this,"_sprite");a(this,"pixelsPerUnitMultiplier",1)}set image(e){this.sprite||(this.sprite=new Xv),this.sprite.texture=e,this.onAfterCreated()}get image(){return this.sprite?this.sprite.texture:null}get sprite(){return this._sprite}set sprite(e){this._sprite!==e&&(this._sprite=e,this.onAfterCreated())}isBuiltinSprite(){var i,n,o,r,l,c,h;const e=this.sprite;switch((i=e==null?void 0:e.texture)==null?void 0:i.name){case"InputFieldBackground":case"UISprite":case"Background":case"Knob":return!0}return!((o=(n=e==null?void 0:e.texture)==null?void 0:n.name)!=null&&o.length)&&((l=(r=e==null?void 0:e.texture)==null?void 0:r.image)==null?void 0:l.width)===32&&((h=(c=e==null?void 0:e.texture)==null?void 0:c.image)==null?void 0:h.height)===32}onBeforeCreate(e){var i,n;super.onBeforeCreate(e),this.isBuiltinSprite()&&(e.borderRadius=5/this.pixelsPerUnitMultiplier,((n=(i=this.sprite)==null?void 0:i.texture)==null?void 0:n.name)==="Knob"&&(e.borderRadius=999))}onAfterCreated(){var e;this.__didAwake&&(super.onAfterCreated(),!this.isBuiltinSprite()&&this.setTexture((e=this.sprite)==null?void 0:e.texture))}};by([g(Xv)],Jf.prototype,"sprite",null);by([g()],Jf.prototype,"pixelsPerUnitMultiplier",void 0);class Qv extends ny{constructor(){super(...arguments);a(this,"_mainTexture")}get mainTexture(){return this._mainTexture}set mainTexture(e){this._mainTexture!==e&&(this._mainTexture=e,this.onAfterCreated())}onAfterCreated(){this.__didAwake&&(super.onAfterCreated(),this.setTexture(this.mainTexture))}}by([g(_t)],Qv.prototype,"mainTexture",null);var is=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const El=k("debugbutton");var So;(function(s){s[s.None=0]="None",s[s.ColorTint=1]="ColorTint",s[s.SpriteSwap=2]="SpriteSwap",s[s.Animation=3]="Animation"})(So||(So={}));class cl{constructor(){a(this,"colorMultiplier");a(this,"disabledColor");a(this,"fadeDuration");a(this,"highlightedColor");a(this,"normalColor");a(this,"pressedColor");a(this,"selectedColor")}}is([g()],cl.prototype,"colorMultiplier",void 0);is([g(Te)],cl.prototype,"disabledColor",void 0);is([g()],cl.prototype,"fadeDuration",void 0);is([g(Te)],cl.prototype,"highlightedColor",void 0);is([g(Te)],cl.prototype,"normalColor",void 0);is([g(Te)],cl.prototype,"pressedColor",void 0);is([g(Te)],cl.prototype,"selectedColor",void 0);class Wj{constructor(){a(this,"disabledTrigger");a(this,"highlightedTrigger");a(this,"normalTrigger");a(this,"pressedTrigger");a(this,"selectedTrigger")}}class hl extends W{constructor(){super(...arguments);a(this,"onClick",new je);a(this,"_isHovered",0);a(this,"colors");a(this,"transition");a(this,"animationTriggers");a(this,"animator");a(this,"_interactable",!0);a(this,"_requestedAnimatorTrigger");a(this,"_isInit",!1);a(this,"_image")}click(){var e;(e=this.onClick)==null||e.invoke()}onPointerEnter(e){var n,o;const i=e.event.pointerType==="mouse"&&e.button===0;i&&(this._isHovered+=1),El&&console.warn("Button Enter",i,this._isHovered,(n=this.animationTriggers)==null?void 0:n.highlightedTrigger,this.animator),this.interactable&&(this.transition==So.Animation&&this.animationTriggers&&this.animator?this.animator.setTrigger(this.animationTriggers.highlightedTrigger):this.transition===So.ColorTint&&this.colors&&((o=this._image)==null||o.setState("hovered")),i&&this.context.input.setCursor("pointer"))}onPointerExit(){var e,i;this._isHovered-=1,this._isHovered<0&&(this._isHovered=0),El&&console.log("Button Exit",this._isHovered,(e=this.animationTriggers)==null?void 0:e.highlightedTrigger,this.animator),this.interactable&&(this._isHovered>0||(this._isHovered=0,this.transition==So.Animation&&this.animationTriggers&&this.animator?this.animator.setTrigger(this.animationTriggers.normalTrigger):this.transition===So.ColorTint&&this.colors&&((i=this._image)==null||i.setState("normal")),this.context.input.unsetCursor("pointer")))}onPointerDown(e){var i,n;El&&console.log("Button Down",(i=this.animationTriggers)==null?void 0:i.highlightedTrigger,this.animator),this.interactable&&(this.transition==So.Animation&&this.animationTriggers&&this.animator?this.animator.setTrigger(this.animationTriggers.pressedTrigger):this.transition===So.ColorTint&&this.colors&&((n=this._image)==null||n.setState("pressed")))}onPointerUp(e){var i,n;El&&console.warn("Button Up",(i=this.animationTriggers)==null?void 0:i.highlightedTrigger,this.animator,this._isHovered),this.interactable&&(this.transition==So.Animation&&this.animationTriggers&&this.animator?this.animator.setTrigger(this._isHovered?this.animationTriggers.highlightedTrigger:this.animationTriggers.normalTrigger):this.transition===So.ColorTint&&this.colors&&((n=this._image)==null||n.setState(this._isHovered?"hovered":"normal")))}onPointerClick(e){if(this.interactable&&!(e.button!==0&&e.event.pointerType===Ea.Mouse)&&(El&&(console.warn("Button Click",this.onClick),at("CLICKED button "+this.name+" at "+this.context.time.frameCount)),this.onClick&&this.onClick.listenerCount>0&&(this.onClick.invoke(),e.use(),El))){const i=this.gameObject.worldPosition;i.add(this.gameObject.worldUp.multiplyScalar(1+Math.random()*.5)),se.DrawLabel(i,"CLICK:"+Date.now(),.1,1+Math.random()*.5)}}set interactable(e){this._interactable=e,this._image&&(this._image.setInteractable(e),e?this._image.setState("normal"):this._image.setState("disabled"))}get interactable(){return this._interactable}set_interactable(e){this.interactable=e}awake(){super.awake(),El&&console.log(this),this._isInit=!1,this.init()}start(){var e;(e=this._image)==null||e.setInteractable(this.interactable),this.gameObject.getComponentInParent(sd)||this.gameObject.addComponent(pv)}onEnable(){super.onEnable()}onDestroy(){this._isHovered&&this.context.input.unsetCursor("pointer")}*setAnimatorTriggerAtEndOfFrame(e){var i;this._requestedAnimatorTrigger=e,yield,yield,this._requestedAnimatorTrigger==e&&((i=this.animator)==null||i.setTrigger(e))}init(){this._isInit||(this._isInit=!0,this._image=I.getComponent(this.gameObject,Jf),this._image&&(this.stateSetup(this._image),this.interactable?this._image.setState("normal"):this._image.setState("disabled")))}stateSetup(e){var p,b,x,v,S;e.setInteractable(this.interactable);const i=this.getFinalColor(e.color,(p=this.colors)==null?void 0:p.normalColor),n={state:"normal",attributes:{backgroundColor:i,backgroundOpacity:i.alpha}};e.setupState(n);const o=this.getFinalColor(e.color,(b=this.colors)==null?void 0:b.highlightedColor),r={state:"hovered",attributes:{backgroundColor:o,backgroundOpacity:o.alpha}};e.setupState(r);const l=this.getFinalColor(e.color,(x=this.colors)==null?void 0:x.pressedColor),c={state:"pressed",attributes:{backgroundColor:l,backgroundOpacity:l.alpha}};e.setupState(c);const h=this.getFinalColor(e.color,(v=this.colors)==null?void 0:v.selectedColor),d={state:"selected",attributes:{backgroundColor:h,backgroundOpacity:h.alpha}};e.setupState(d);const u=this.getFinalColor(e.color,(S=this.colors)==null?void 0:S.disabledColor),f={state:"disabled",attributes:{backgroundColor:u,backgroundOpacity:u.alpha}};e.setupState(f)}getFinalColor(e,i){return i?e.clone().multiply(i).convertLinearToSRGB():e.clone().convertLinearToSRGB()}}is([g(je)],hl.prototype,"onClick",void 0);is([g(cl)],hl.prototype,"colors",void 0);is([g()],hl.prototype,"transition",void 0);is([g(Wj)],hl.prototype,"animationTriggers",void 0);is([g(Ei)],hl.prototype,"animator",void 0);is([g()],hl.prototype,"interactable",null);var _y=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const pa=k("debuginputfield"),ue=class extends W{constructor(){super(...arguments);a(this,"textComponent");a(this,"placeholder");a(this,"onValueChanged");a(this,"onEndEdit");a(this,"inputEventFn");a(this,"_iosEventFn")}get text(){var e;return((e=this.textComponent)==null?void 0:e.text)??""}set text(e){this.textComponent&&(this.textComponent.text=e,this.placeholder&&(e.length>0?this.placeholder.gameObject.visible=!1:this.placeholder.gameObject.visible=!0))}get isFocused(){return ue.active===this}start(){pa&&console.log(this.name,this)}onEnable(){var e;ue.htmlField||(ue.htmlField=document.createElement("input"),ue.htmlField.style.width="0px",ue.htmlField.style.height="0px",ue.htmlField.style.padding="0px",ue.htmlField.style.border="none",ue.htmlField.style.overflow="hidden",ue.htmlField.style.caretColor="transparent",ue.htmlField.style.outline="none",ue.htmlField.classList.add("ar"),ue.htmlField.onfocus=()=>ue.htmlFieldFocused=!0,ue.htmlField.onblur=()=>ue.htmlFieldFocused=!1,document.body.append(ue.htmlField)),this.inputEventFn||(this.inputEventFn=this.onInput.bind(this)),ue.htmlField.addEventListener("keyup",this.inputEventFn),this.placeholder&&((e=this.textComponent)!=null&&e.text.length)&&I.setActive(this.placeholder.gameObject,!1),Q.isiOS()&&(this._iosEventFn=this.processInputOniOS.bind(this),window.addEventListener("click",this._iosEventFn))}onDisable(){var e;(e=ue.htmlField)==null||e.removeEventListener("keyup",this.inputEventFn),this.onDeselected(),this._iosEventFn&&window.removeEventListener("click",this._iosEventFn)}clear(){ue.active===this&&ue.htmlField?(ue.htmlField.value="",this.setTextFromInputField()):(this.textComponent&&(this.textComponent.text=""),this.placeholder&&I.setActive(this.placeholder.gameObject,!0))}select(){this.onSelected()}deselect(){this.onDeselected()}onPointerEnter(e){e.event.pointerType==="mouse"&&e.button===0&&this.context.input.setCursor("text")}onPointerExit(e){this.context.input.unsetCursor("text")}onPointerClick(e){pa&&console.log("CLICK",e,ue.active),ue.activeTime=this.context.time.time,ue.active!==this&&this.startCoroutine(this.activeLoop(),ge.LateUpdate),this.selectInputField()}*activeLoop(){for(this.onSelected();ue.active===this&&!(this.context.input.getPointerClicked(0)&&this.context.time.time-ue.activeTime>.2);)this.setTextFromInputField(),yield;this.onDeselected()}onSelected(){var e,i,n,o;if(ue.active!==this&&(pa&&console.log("Select",this.name,this,ue.htmlField,this.context.isInXR,this.context.arOverlayElement,(e=this.textComponent)==null?void 0:e.text,(i=ue.htmlField)==null?void 0:i.value),(n=ue.active)==null||n.onDeselected(),ue.active=this,this.placeholder&&I.setActive(this.placeholder.gameObject,!1),ue.htmlField)){if(ue.htmlField.value=((o=this.textComponent)==null?void 0:o.text)||"",pa&&console.log("set input field value",ue.htmlField.value),this.context.isInXR){const r=this.context.arOverlayElement;r&&r.append(ue.htmlField)}this.selectInputField()}}onDeselected(){var e;ue.active===this&&(ue.active=null,pa&&console.log("Deselect",this.name,this),ue.htmlField&&(ue.htmlField.blur(),document.body.append(ue.htmlField)),this.placeholder&&(!this.textComponent||this.textComponent.text.length<=0)&&I.setActive(this.placeholder.gameObject,!0),ue.htmlField&&((e=this.onEndEdit)==null||e.invoke(ue.htmlField.value)))}update(){var e;ue.active===this&&((e=this.textComponent)==null||e.markDirty())}onInput(e){var i,n;if(ue.active===this){if(pa&&console.log(e.code,e,(i=ue.htmlField)==null?void 0:i.value,(n=this.textComponent)==null?void 0:n.text),e.code==="Escape"||e.code==="Enter"){this.onDeselected();return}ue.htmlField&&(this.textComponent&&(this.setTextFromInputField(),this.placeholder&&I.setActive(this.placeholder.gameObject,this.textComponent.text.length<=0)),this.selectInputField())}}setTextFromInputField(){var e;if(this.textComponent&&ue.htmlField){const i=this.textComponent.text,n=ue.htmlField.value,o=this.textComponent.text!==ue.htmlField.value;this.textComponent.text=ue.htmlField.value,o&&(pa&&console.log("[InputField] value changed:",n,i),(e=this.onValueChanged)==null||e.invoke(n,i))}}selectInputField(){ue.htmlField&&(pa&&console.log("Focus Inputfield",ue.htmlFieldFocused,ue.htmlField),ue.htmlField.setSelectionRange(ue.htmlField.value.length,ue.htmlField.value.length),Q.isiOS()?(ue.htmlField.style.display="block",ue.htmlField.focus({preventScroll:!0})):setTimeout(()=>{var e;return(e=ue.htmlField)==null?void 0:e.focus()},1))}processInputOniOS(){const e=this.context.physics.raycast();if(!e.length)return;const n=e[0].object,o=mv(n);((o==null?void 0:o.gameObject)===this.gameObject||(o==null?void 0:o.gameObject.parent)===this.gameObject)&&this.selectInputField()}};let ps=ue;a(ps,"active",null),a(ps,"activeTime",-1),a(ps,"htmlField",null),a(ps,"htmlFieldFocused",!1);_y([g(gn)],ps.prototype,"textComponent",void 0);_y([g(gn)],ps.prototype,"placeholder",void 0);_y([g(je)],ps.prototype,"onValueChanged",void 0);_y([g(je)],ps.prototype,"onEndEdit",void 0);var MR=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class vy extends W{constructor(){super(...arguments);a(this,"id",null);a(this,"keepAspect",!1);a(this,"_object",null)}onEnable(){if(this._object){this.gameObject.add(this._object);return}if(!this.id||!this.context.mainCamera)return;const e=document.getElementById(this.id);if(!e){console.warn('Could not find element with id "'+this.id+'"');return}e.style.display="block",e.style.visibility="hidden";const i=new Qk;i.listenToPointerEvents(this.context.renderer,this.context.mainCamera),this.gameObject.add(i);const n=new Yk(e);i.add(n),n.visible=!1;const o=n.material;o.transparent=!0,setTimeout(()=>{n.visible=!0;const r=z0(this.gameObject).clone();Mg(this.gameObject,0,0,0),this.gameObject.updateMatrixWorld();const l=new bs;l.setFromObject(i),this.setWorldRotation(r.x,r.y,r.z);const c=l.max.x-l.min.x,h=l.max.y-l.min.y;if(this.keepAspect){const u=c/h;c>h?n.scale.set(1/c,1/h/u,1):n.scale.set(1/c*u,1/h,1)}else n.scale.set(1/c,1/h,1);const d=this.gameObject.scale;n.scale.multiply(d)},1)}onDisable(){var e;(e=this._object)==null||e.removeFromParent()}}MR([g()],vy.prototype,"id",void 0);MR([g()],vy.prototype,"keepAspect",void 0);/* @license
 * Copyright 2021 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the 'License');
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an 'AS IS' BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Hj={topLight:{intensity:500,position:[.418,16.199,.3]},room:{position:[-.757,13.219,.717],scale:[31.713,28.305,28.591]},boxes:[{position:[-10.906,2.009,1.846],rotation:-.195,scale:[2.328,7.905,4.651]},{position:[-5.607,-.754,-.758],rotation:.994,scale:[1.97,1.534,3.955]},{position:[6.167,.857,7.803],rotation:.561,scale:[3.927,6.285,3.687]},{position:[-2.017,.018,6.124],rotation:.333,scale:[2.002,4.566,2.064]},{position:[2.291,-.756,-2.621],rotation:-.286,scale:[1.546,1.552,1.496]},{position:[-2.193,-.369,-5.547],rotation:.516,scale:[3.875,3.487,2.986]}],lights:[{intensity:50,position:[-16.116,14.37,8.208],scale:[.1,2.428,2.739]},{intensity:50,position:[-16.109,18.021,-8.207],scale:[.1,2.425,2.751]},{intensity:17,position:[14.904,12.198,-1.832],scale:[.15,4.265,6.331]},{intensity:43,position:[-.462,8.89,14.52],scale:[4.38,5.441,.088]},{intensity:20,position:[3.235,11.486,-12.541],scale:[2.5,2,.1]},{intensity:100,position:[0,20,0],scale:[1,.1,1]}]},Gj={topLight:{intensity:400,position:[.5,14,.5]},room:{position:[0,13.2,0],scale:[31.5,28.5,31.5]},boxes:[{position:[-10.906,-1,1.846],rotation:-.195,scale:[2.328,7.905,4.651]},{position:[-5.607,-.754,-.758],rotation:.994,scale:[1.97,1.534,3.955]},{position:[6.167,-.16,7.803],rotation:.561,scale:[3.927,6.285,3.687]},{position:[-2.017,.018,6.124],rotation:.333,scale:[2.002,4.566,2.064]},{position:[2.291,-.756,-2.621],rotation:-.286,scale:[1.546,1.552,1.496]},{position:[-2.193,-.369,-5.547],rotation:.516,scale:[3.875,3.487,2.986]}],lights:[{intensity:80,position:[-14,10,8],scale:[.1,2.5,2.5]},{intensity:80,position:[-14,14,-4],scale:[.1,2.5,2.5]},{intensity:23,position:[14,12,0],scale:[.1,5,5]},{intensity:16,position:[0,9,14],scale:[5,5,.1]},{intensity:80,position:[7,8,-14],scale:[2.5,2.5,.1]},{intensity:80,position:[-7,16,-14],scale:[2.5,2.5,.1]},{intensity:1,position:[0,20,0],scale:[.1,.1,.1]}]};class Yv extends Xn{constructor(t){super(),this.position.y=-3.5;const e=new Vh;e.deleteAttribute("uv");const i=new ti({metalness:0,side:Tg}),n=new ti({metalness:0}),o=t=="legacy"?Hj:Gj,r=new R0(16777215,o.topLight.intensity,28,2);r.position.set(...o.topLight.position),this.add(r);const l=new le(e,i);l.position.set(...o.room.position),l.scale.set(...o.room.scale),this.add(l);for(const c of o.boxes){const h=new le(e,n);h.position.set(...c.position),h.rotation.set(0,c.rotation,0),h.scale.set(...c.scale),this.add(h)}for(const c of o.lights){const h=new le(e,this.createAreaLightMaterial(c.intensity));h.position.set(...c.position),h.scale.set(...c.scale),this.add(h)}}createAreaLightMaterial(t){const e=new Ye;return e.color.setScalar(t),e}}var xy=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const fx=class extends W{constructor(){super(...arguments);a(this,"target");a(this,"invertForward",!1);a(this,"keepUpDirection",!0);a(this,"copyTargetRotation",!1)}onBeforeRender(){let e=this.target;if(e||(e=this.context.mainCamera,X()&&!this.__did_warn&&(this.__did_warn=!0,console.debug(`[LookAt] No target set on ${this.name}, using main camera as target.`))),!e)return;let i=this.copyTargetRotation;(this.context.isInVR||this.context.isInPassThrough)&&(i=!1),Eg(this.gameObject,e,this.keepUpDirection,i),this.invertForward&&this.gameObject.quaternion.multiply(fx.flipYQuat)}createBehaviours(e,i,n){if(i.uuid===this.gameObject.uuid){let o=i;if(this.keepUpDirection){const l=Yi.createEmptyParent(i);o=l;const c=this.invertForward?-1:1;l.setMatrix(l.getMatrix().multiply(new xe().makeRotationZ(Math.PI/2*c))),i.setMatrix(i.getMatrix().multiply(new xe().makeRotationZ(-Math.PI/2*c)))}const r=new ki("lookat "+this.name,Zi.sceneStartTrigger(),Ve.lookAtCameraAction(o,void 0,this.invertForward?gs.back:gs.forward,this.keepUpDirection?gs.up:gs.zero));e.addBehavior(r)}}};let Nr=fx;a(Nr,"flipYQuat",new re().setFromAxisAngle(new R(0,1,0),Math.PI));xy([g(z)],Nr.prototype,"target",void 0);xy([g()],Nr.prototype,"invertForward",void 0);xy([g()],Nr.prototype,"keepUpDirection",void 0);xy([g()],Nr.prototype,"copyTargetRotation",void 0);var Kv=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},vh;(function(s){s[s.NewTab=0]="NewTab",s[s.SameTab=1]="SameTab",s[s.NewWindow=2]="NewWindow"})(vh||(vh={}));class ep extends W{constructor(){super(...arguments);a(this,"url");a(this,"mode",vh.NewTab);a(this,"clickable",!0)}async open(){if(!this.url){console.warn("OpenURL: URL is not set, can't open.",this);return}this._validateUrl();let e=this.url;switch(!e.startsWith("mailto:")&&e.includes("@")&&(e="mailto:"+e),X()&&at("Open URL: "+e),this.mode){case vh.NewTab:Q.isSafari(),globalThis.open(e,"_blank");break;case vh.SameTab:Q.isSafari()&&Q.isiOS()?globalThis.open(e,"_top"):globalThis.open(e,"_self");break;case vh.NewWindow:Q.isSafari()?globalThis.open(e,"_top"):globalThis.open(e,"_new");break}}start(){this.gameObject.getComponentInParent(ws)||this.gameObject.addComponent(ws)}onPointerEnter(e){!e.used&&this.clickable&&this.context.input.setCursor("pointer")}onPointerExit(){this.clickable&&this.context.input.unsetCursor("pointer")}onPointerClick(e){var i;this.clickable&&!e.used&&((i=this.url)!=null&&i.length)&&this.open()}_validateUrl(){this.url&&this.url.startsWith("www.")&&(X()&&console.warn("URL is not valid, adding https:// to the start of the URL",this.url),this.url="https://"+this.url)}}Kv([g()],ep.prototype,"url",void 0);Kv([g()],ep.prototype,"mode",void 0);Kv([g()],ep.prototype,"clickable",void 0);zg(s=>{const t=s.domElement.getAttribute("clickthrough");if(e(t)){const i=s.scene.addComponent(Zv);p1(s.domElement,"clickthrough",()=>{const n=s.domElement.getAttribute("clickthrough");i.enabled=e(n)})}function e(i){return i!==null&&i!=="0"&&i!=="false"}});class Zv extends W{constructor(){super(...arguments);a(this,"_previousPointerEvents","all");a(this,"onPointerEvent",e=>{if(e.pointerId>0)return;const i=e.intersections;(i==null?void 0:i.length)<=0?this.context.domElement.style.pointerEvents="none":this.context.domElement.style.pointerEvents="all"});a(this,"_touchDidHitAnything",!1);a(this,"onTouchStart",e=>{const i=e.touches[0];if(!i)return;const n=i.clientX/window.innerWidth*2-1,o=-(i.clientY/window.innerHeight)*2+1;this.context.physics.raycast({screenPoint:new _e(n,o)}).length>0&&(this._touchDidHitAnything=!0)});a(this,"onTouchEnd",e=>{const i=this._touchDidHitAnything;this._touchDidHitAnything=!1,setTimeout(()=>{i&&(this.context.domElement.style.pointerEvents="all")},100)})}onEnable(){this.context.input.addEventListener("pointerdown",this.onPointerEvent),this.context.input.addEventListener("pointermove",this.onPointerEvent,{queue:100}),window.addEventListener("touchstart",this.onTouchStart,{passive:!0}),window.addEventListener("touchend",this.onTouchEnd,{passive:!0}),this._previousPointerEvents=this.context.domElement.style.pointerEvents}onDisable(){this.context.input.removeEventListener("pointerdown",this.onPointerEvent),this.context.input.removeEventListener("pointermove",this.onPointerEvent),window.removeEventListener("touchstart",this.onTouchStart),window.removeEventListener("touchend",this.onTouchEnd),this.context.domElement.style.pointerEvents=this._previousPointerEvents}onPointerEnter(){}}var wy=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const qj=k("debugcursor");class Ic extends W{constructor(){super(...arguments);a(this,"damping",0);a(this,"useFullPage",!0);a(this,"keepDistance",!0);a(this,"snapToSurface",!1);a(this,"_distance",-1);a(this,"_ndc_x",0);a(this,"_ndc_y",0);a(this,"_onPointerMove",e=>{if(!this.useFullPage)return;const i=e.clientX,n=e.clientY,o=this.context.domX,r=this.context.domY,l=this.context.domWidth,c=this.context.domHeight;this._ndc_x=(i-o)/l*2-1,this._ndc_y=-(n-r)/c*2+1})}updateDistance(e=!1){!e&&this.keepDistance&&this._distance!==-1||(this._distance=this.gameObject.worldPosition.distanceTo(this.context.mainCamera.worldPosition))}awake(){this._distance=-1}onEnable(){this._distance=-1,window.addEventListener("pointermove",this._onPointerMove)}onDisable(){window.removeEventListener("pointermove",this._onPointerMove)}lateUpdate(){this.updateDistance();const e=this.useFullPage?this._ndc_x:this.context.input.mousePositionRC.x,i=this.useFullPage?this._ndc_y:this.context.input.mousePositionRC.y,n=this.context.mainCamera,o=n.worldPosition,r=te(e,i,1).unproject(n);r.sub(o).normalize();const l=te(r).multiplyScalar(this._distance).add(o);let c=l;if(this.damping>0){const h=this.gameObject.worldPosition;h.lerp(l,this.context.time.deltaTime/this.damping),this.gameObject.worldPosition=h,c=h}else this.gameObject.worldPosition=l;if(this.snapToSurface){Jb.origin=c,Jb.direction=r.multiplyScalar(-1);const h=this.context.physics.raycastFromRay(Jb);if(h!=null&&h.length){const d=h[0];this.damping>0?this.gameObject.worldPosition=c.lerp(d.point,this.context.time.deltaTime/this.damping):this.gameObject.worldPosition=d.point,qj&&se.DrawLine(d.point,d.normal.add(d.point),65280)}}}}a(Ic,"NAME","CursorFollow");wy([g()],Ic.prototype,"damping",void 0);wy([g()],Ic.prototype,"useFullPage",void 0);wy([g()],Ic.prototype,"keepDistance",void 0);wy([g()],Ic.prototype,"snapToSurface",void 0);const Jb=new zr;var kd=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};let Qr=class extends W{constructor(){super(...arguments);a(this,"type","linear");a(this,"duration",.1);a(this,"scaleFactor",1.1);a(this,"hovered",null);a(this,"idle",null);a(this,"animation",null)}start(){this.idle||(this.idle=Hr.emptyClip()),(!this.hovered||!(this.hovered instanceof Hn))&&(this.hovered=Hr.createScaleClip({type:"linear",duration:this.duration||.1,scale:this.gameObject.scale,scaleFactor:this.scaleFactor||1.1})),this.animation??(this.animation=this.gameObject.addComponent(pn)),this.animation.playAutomatically=!1,this.playIdle()}onEnable(){this.animation&&(this.animation.enabled=!0),this.playIdle()}onDisable(){this.animation&&(this.animation.enabled=!1),this.playIdle()}onPointerEnter(){this.playHover()}onPointerExit(){this.playIdle()}playIdle(){var e;this.idle&&((e=this.animation)==null||e.play(this.idle,{exclusive:!0,fadeDuration:.1,loop:!0}))}playHover(){var e;this.hovered&&((e=this.animation)==null||e.play(this.hovered,{exclusive:!0,fadeDuration:.1,loop:!1,clampWhenFinished:!0}))}};kd([g()],Qr.prototype,"type",void 0);kd([g()],Qr.prototype,"duration",void 0);kd([g()],Qr.prototype,"scaleFactor",void 0);kd([g(Hn)],Qr.prototype,"hovered",void 0);kd([g(Hn)],Qr.prototype,"idle",void 0);Qr=kd([YP],Qr);var Xj=Object.defineProperty,Qj=(s,t,e)=>t in s?Xj(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Bt=(s,t,e)=>(Qj(s,typeof t!="symbol"?t+"":t,e),e);(function(){class s{}class t extends s{constructor(y){super(),Bt(this,"value"),this.value=y}}class e extends s{constructor(y){super(),Bt(this,"value"),this.value=y}}class i extends s{constructor(y){super(),Bt(this,"value"),this.value=y}}class n extends s{constructor(y,_="unrestricted"){super(),Bt(this,"type"),Bt(this,"value"),this.value=y,this.type=_}}class o extends s{constructor(y){super(),Bt(this,"value"),this.value=y}}class r extends s{}class l extends s{constructor(y){super(),Bt(this,"value"),this.value=y}}class c extends s{}class h extends s{constructor(y){super(),Bt(this,"value"),this.value=y}}class d extends s{constructor(y,_="integer"){super(),Bt(this,"value"),Bt(this,"type"),this.value=y,this.type=_}}class u extends s{constructor(y){super(),Bt(this,"value"),this.value=y}}class f extends s{constructor(y,_,w){super(),Bt(this,"value"),Bt(this,"type"),Bt(this,"unit"),this.value=y,this.type=_,this.unit=w}}class p extends s{}class b extends s{}class x extends s{}class v extends s{}class S extends s{}class C extends s{}class P extends s{}class E extends s{}class D extends s{}class M extends s{}class A extends s{}class G extends s{}class V{constructor(y){Bt(this,"input"),Bt(this,"index",0),this.input=y}consume(){const y=this.input.codePointAt(this.index);return y!==void 0&&(this.index+=String.fromCodePoint(y).length),y}reconsume(y){y!==void 0&&(this.index-=String.fromCodePoint(y).length)}peek(){const y=[];let _=this.index;for(let w=0;w<3&&_<this.input.length;w++){const T=this.input.codePointAt(_);y.push(T),_+=String.fromCodePoint(T).length}return y}}function U(m){return m===10}function $(m){return U(m)||m===8192||m===32}function Y(m){return m>=48&&m<=57}function B(m){return Y(m)||m>=65&&m<=70||m>=97&&m<=102}function N(m){return function(y){return function(_){return _>=65&&_<=90}(y)||function(_){return _>=97&&_<=122}(y)}(m)||function(y){return y>=128}(m)||m===95}function Z(m){return N(m)||Y(m)||m===45}function ae(m){return m>=0&&m<=8||m===11||m>=14&&m<=31||m===127}function ie(m,y){return m===92&&!U(y)}function J(m,y,_){return m===45?N(y)||y===45||ie(y,_):!!N(m)||m===92&&ie(m,y)}function ye(m,y,_){return m===43||m===45?Y(y)||y===46&&Y(_):Y(m===46?y:m)}function Fe(m){const y=m.consume();if(B(y)){let _=[y];for(;B(...m.peek())&&_.length<5;)_.push(m.consume());$(...m.peek())&&m.consume();const w=parseInt(String.fromCodePoint(..._),16);return w===0||w>1114111?65533:w}return y===void 0?65533:y}function Ze(m,y){const _=new o("");for(;;){const w=m.consume();if(w===y||w===void 0)return _;if(w===10)return m.reconsume(w),new r;if(w===92){const T=m.peek()[0];T===void 0||(U(T)?m.consume():_.value+=String.fromCodePoint(Fe(m)))}else _.value+=String.fromCodePoint(w)}}function Ot(m){let y="";for(;;){const _=m.consume();if(Z(_))y+=String.fromCodePoint(_);else{if(!ie(...m.peek()))return m.reconsume(_),y;y+=String.fromCodePoint(Fe(m))}}}function St(m){let y=function(_){let w="integer",T="";for([43,45].includes(_.peek()[0])&&(T+=String.fromCodePoint(_.consume()));Y(..._.peek());)T+=String.fromCodePoint(_.consume());if(_.peek()[0]===46&&Y(_.peek()[1]))for(T+=String.fromCodePoint(_.consume(),_.consume()),w="number";Y(..._.peek());)T+=String.fromCodePoint(_.consume());return[69,101].includes(_.peek()[0])&&([45,43].includes(_.peek()[1])&&Y(_.peek()[2])?(T+=String.fromCodePoint(_.consume(),_.consume(),_.consume()),w="number"):Y(_.peek()[1])&&(T+=String.fromCodePoint(_.consume(),_.consume()),w="number")),{value:parseFloat(T),type:w}}(m);return J(...m.peek())?new f(y.value,y.type,Ot(m)):m.peek()[0]===37?(m.consume(),new u(y.value)):new d(y.value,y.type)}function ui(m){for(;;){const y=m.consume();if(y===41||y===void 0)return;ie(...m.peek())&&Fe(m)}}function fi(m){const y=Ot(m);if(y.match(/url/i)&&m.peek()[0]===40){for(m.consume();$(m.peek()[0])&&$(m.peek()[1]);)m.consume();return[34,39].includes(m.peek()[0])||$(m.peek()[0])&&[34,39].includes(m.peek()[1])?new e(y):function(_){const w=new l("");for(;$(..._.peek());)_.consume();for(;;){const T=_.consume();if(T===41||T===void 0)return w;if($(T)){for(;$(..._.peek());)_.consume();return _.peek()[0]===41||_.peek()[0]===void 0?(_.consume(),w):(ui(_),new c)}if([34,39,40].includes(T)||ae(T))return ui(_),new c;if(T===92){if(!ie(..._.peek()))return ui(_),new c;w.value+=Fe(_)}else w.value+=String.fromCodePoint(T)}}(m)}return m.peek()[0]===40?(m.consume(),new e(y)):new t(y)}function pi(m){const y=m.consume(),_=m.peek();if($(y)){for(;$(...m.peek());)m.consume();return new p}if(y===34)return Ze(m,y);if(y===35){if(Z(_[0])||ie(..._)){const w=new n;return J(..._)&&(w.type="id"),w.value=Ot(m),w}return new h(String.fromCodePoint(y))}return y===39?Ze(m,y):y===40?new D:y===41?new M:y===43?ye(..._)?(m.reconsume(y),St(m)):new h(String.fromCodePoint(y)):y===44?new C:y===45?ye(...m.peek())?(m.reconsume(y),St(m)):m.peek()[0]===45&&m.peek()[1]===62?(m.consume(),m.consume(),new x):J(...m.peek())?(m.reconsume(y),fi(m)):new h(String.fromCodePoint(y)):y===46?ye(...m.peek())?(m.reconsume(y),St(m)):new h(String.fromCodePoint(y)):y===58?new v:y===59?new S:y===60?_[0]===33&&_[1]===45&&_[2]===45?(m.consume(),m.consume(),m.consume(),new b):new h(String.fromCodePoint(y)):y===64?J(..._)?new i(Ot(m)):new h(String.fromCodePoint(y)):y===91?new P:y===92?ie(..._)?(m.reconsume(y),fi(m)):new h(String.fromCodePoint(y)):y===93?new E:y===123?new A:y===125?new G:Y(y)?(m.reconsume(y),St(m)):N(y)?(m.reconsume(y),fi(m)):y===void 0?void 0:new h(String.fromCodePoint(y))}const ns=new Set(["px","deg","s","hz","dppx","number","fr"]);function Ts(m){return ns.has(m.toLowerCase())}function Ue(m,y){if(["x","y"].includes(m))return m;if(!y)throw new Error("To determine the normalized axis the computedStyle of the source is required.");const _=y.writingMode=="horizontal-tb";if(m==="block")m=_?"y":"x";else{if(m!=="inline")throw new TypeError(`Invalid axis ‚Äú${m}‚Äù`);m=_?"x":"y"}return m}function lo(m){const y=[];let _=0;function w(){let O=0;const F=_;for(;_<m.length;){const K=m.slice(_,_+1);if(/\s/.test(K)&&O===0)break;if(K==="(")O+=1;else if(K===")"&&(O-=1,O===0)){_++;break}_++}return m.slice(F,_)}function T(){for(;/\s/.test(m.slice(_,_+1));)_++}for(;_<m.length;){const O=m.slice(_,_+1);/\s/.test(O)?T():y.push(w())}return y}function na(m,y){return m.reduce((_,w)=>(_.has(w[y])?_.get(w[y]).push(w):_.set(w[y],[w]),_),new Map)}function Lc(m,y){const _=[],w=[];for(const T of m)y(T)?_.push(T):w.push(T);return[_,w]}function ji(m,y={}){function _(w){return Array.from(w).map(T=>ji(T,y))}if(m instanceof CSSUnitValue){if(m.unit==="percent"&&y.percentageReference){const T=m.value/100*y.percentageReference.value,O=y.percentageReference.unit;return new CSSUnitValue(T,O)}const w=m.toSum();if(w&&w.values.length===1&&(m=w.values[0]),m instanceof CSSUnitValue&&m.unit==="em"&&y.fontSize&&(m=new CSSUnitValue(m.value*y.fontSize.value,y.fontSize.unit)),m instanceof CSSKeywordValue){if(m.value==="e")return new CSSUnitValue(Math.E,"number");if(m.value==="pi")return new CSSUnitValue(Math.PI,"number")}return m}if(!m.operator)return m;switch(m.operator){case"sum":m=new CSSMathSum(..._(m.values));break;case"product":m=new CSSMathProduct(..._(m.values));break;case"negate":m=new CSSMathNegate(ji(m.value,y));break;case"clamp":m=new CSSMathClamp(ji(m.lower,y),ji(m.value,y),ji(m.upper,y));break;case"invert":m=new CSSMathInvert(ji(m.value,y));break;case"min":m=new CSSMathMin(..._(m.values));break;case"max":m=new CSSMathMax(..._(m.values))}if(m instanceof CSSMathMin||m instanceof CSSMathMax){const w=Array.from(m.values);if(w.every(T=>T instanceof CSSUnitValue&&T.unit!=="percent"&&Ts(T.unit)&&T.unit===w[0].unit)){const T=Math[m.operator].apply(Math,w.map(({value:O})=>O));return new CSSUnitValue(T,w[0].unit)}}if(m instanceof CSSMathMin||m instanceof CSSMathMax){const w=Array.from(m.values),[T,O]=Lc(w,K=>K instanceof CSSUnitValue&&K.unit!=="percent"),F=Array.from(na(T,"unit").values());if(F.some(K=>K.length>0)){const K=F.map(H=>{const oe=Math[m.operator].apply(Math,H.map(({value:pe})=>pe));return new CSSUnitValue(oe,H[0].unit)});m=m instanceof CSSMathMin?new CSSMathMin(...K,...O):new CSSMathMax(...K,...O)}return w.length===1?w[0]:m}if(m instanceof CSSMathNegate)return m.value instanceof CSSUnitValue?new CSSUnitValue(0-m.value.value,m.value.unit):m.value instanceof CSSMathNegate?m.value.value:m;if(m instanceof CSSMathInvert)return m.value instanceof CSSMathInvert?m.value.value:m;if(m instanceof CSSMathSum){let w=function(O){const F=O.filter(K=>K instanceof CSSUnitValue);return[...O.filter(K=>!(K instanceof CSSUnitValue)),...Array.from(na(F,"unit").entries()).map(([K,H])=>{const oe=H.reduce((pe,{value:Pe})=>pe+Pe,0);return new CSSUnitValue(oe,K)})]},T=[];for(const O of m.values)O instanceof CSSMathSum?T.push(...O.values):T.push(O);return T=w(T),T.length===1?T[0]:new CSSMathSum(...T)}if(m instanceof CSSMathProduct){let w=[];for(const F of m.values)F instanceof CSSMathProduct?w.push(...F.values):w.push(F);const[T,O]=Lc(w,F=>F instanceof CSSUnitValue&&F.unit==="number");if(T.length>1){const F=T.reduce((K,{value:H})=>K*H,1);w=[new CSSUnitValue(F,"number"),...O]}if(w.length===2){let F,K;for(const H of w)H instanceof CSSUnitValue&&H.unit==="number"?F=H:H instanceof CSSMathSum&&[...H.values].every(oe=>oe instanceof CSSUnitValue)&&(K=H);if(F&&K)return new CSSMathSum(...[...K.values].map(H=>new CSSUnitValue(H.value*F.value,H.unit)))}if(w.every(F=>F instanceof CSSUnitValue&&Ts(F.unit)||F instanceof CSSMathInvert&&F.value instanceof CSSUnitValue&&Ts(F.value.unit))){const F=new CSSMathProduct(...w).toSum();if(F&&F.values.length===1)return F.values[0]}return new CSSMathProduct(...w)}return m}const mi=null,Dc=["percent","length","angle","time","frequency","resolution","flex"],ss={fontRelativeLengths:{units:new Set(["em","rem","ex","rex","cap","rcap","ch","rch","ic","ric","lh","rlh"])},viewportRelativeLengths:{units:new Set(["vw","lvw","svw","dvw","vh","lvh","svh","dvh","vi","lvi","svi","dvi","vb","lvb","svb","dvb","vmin","lvmin","svmin","dvmin","vmax","lvmax","svmax","dvmax"])},absoluteLengths:{units:new Set(["cm","mm","Q","in","pt","pc","px"]),compatible:!0,canonicalUnit:"px",ratios:{cm:96/2.54,mm:96/2.54/10,Q:96/2.54/40,in:96,pc:16,pt:96/72,px:1}},angle:{units:new Set(["deg","grad","rad","turn"]),compatible:!0,canonicalUnit:"deg",ratios:{deg:1,grad:.9,rad:180/Math.PI,turn:360}},time:{units:new Set(["s","ms"]),compatible:!0,canonicalUnit:"s",ratios:{s:1,ms:.001}},frequency:{units:new Set(["hz","khz"]),compatible:!0,canonicalUnit:"hz",ratios:{hz:1,khz:1e3}},resolution:{units:new Set(["dpi","dpcm","dppx"]),compatible:!0,canonicalUnit:"dppx",ratios:{dpi:1/96,dpcm:2.54/96,dppx:1}}},jc=new Map;for(const m of Object.values(ss))if(m.compatible)for(const y of m.units)jc.set(y,m);function gl(m){return jc.get(m)}function Id(m,y){const _={...m};for(const w of Object.keys(y))_[w]?_[w]+=y[w]:_[w]=y[w];return _}function yl(m){return m==="number"?{}:m==="percent"?{percent:1}:ss.absoluteLengths.units.has(m)||ss.fontRelativeLengths.units.has(m)||ss.viewportRelativeLengths.units.has(m)?{length:1}:ss.angle.units.has(m)?{angle:1}:ss.time.units.has(m)?{time:1}:ss.frequency.units.has(m)?{frequency:1}:ss.resolution.units.has(m)?{resolution:1}:m==="fr"?{flex:1}:mi}function sa(m){if(m instanceof CSSUnitValue){let{unit:y,value:_}=m;const w=gl(m.unit);return w&&y!==w.canonicalUnit&&(_*=w.ratios[y],y=w.canonicalUnit),y==="number"?[[_,{}]]:[[_,{[y]:1}]]}if(m instanceof CSSMathInvert){if(!(m.value instanceof CSSUnitValue))throw new Error("Not implemented");const y=sa(m.value);if(y===mi||y.length>1)return mi;const _=y[0],w={};for(const[T,O]of Object.entries(_[1]))w[T]=-1*O;return y[0]=[1/_[0],w],y}if(m instanceof CSSMathProduct){let y=[[1,{}]];for(const _ of m.values){const w=sa(_),T=[];if(w===mi)return mi;for(const O of y)for(const F of w)T.push([O[0]*F[0],Id(O[1],F[1])]);y=T}return y}throw new Error("Not implemented")}function Ld(m,y){if(yl(y)===mi)throw new SyntaxError("The string did not match the expected pattern.");const _=sa(m);if(!_)throw new TypeError;if(_.length>1)throw new TypeError("Sum has more than one item");const w=function(T,O){const F=T.unit,K=T.value,H=gl(F),oe=gl(O);return!oe||H!==oe?mi:new CSSUnitValue(K*oe.ratios[F]/oe.ratios[O],O)}(Fc(_[0]),y);if(w===mi)throw new TypeError;return w}function Fc(m){const[y,_]=m,w=Object.entries(_);if(w.length>1)return mi;if(w.length===0)return new CSSUnitValue(y,"number");const T=w[0];return T[1]!==1?mi:new CSSUnitValue(y,T[0])}function Bc(m,...y){if(y&&y.length)throw new Error("Not implemented");const _=sa(m).map(w=>Fc(w));if(_.some(w=>w===mi))throw new TypeError("Type error");return new CSSMathSum(..._)}function Dd(m,y){if(m.percentHint&&y.percentHint&&m.percentHint!==y.percentHint)return mi;const _={...m,percentHint:m.percentHint??y.percentHint};for(const w of Dc)y[w]&&(_[w]??(_[w]=0),_[w]+=y[w]);return _}class os{constructor(y,_){Bt(this,"name"),Bt(this,"values"),this.name=y,this.values=_}}class rr{constructor(y,_){Bt(this,"value"),Bt(this,"associatedToken"),this.value=y,this.associatedToken=_}}function bl(m){if(Array.isArray(m))return m;if(typeof m=="string")return function(y){const _=new V(y),w=[];for(;;){const T=pi(_);if(T===void 0)return w;w.push(T)}}(m);throw new TypeError("Invalid input type "+typeof m)}function ar(m){const y=m.shift();return y instanceof A||y instanceof P||y instanceof D?function(_,w){let T;if(w instanceof A)T=G;else if(w instanceof D)T=M;else{if(!(w instanceof P))return;T=E}const O=new rr([],w);for(;;){const F=_.shift();if(F instanceof T||F===void 0)return O;_.unshift(F),O.value.push(ar(_))}}(m,y):y instanceof e?function(_,w){const T=new os(_.value,[]);for(;;){const O=w.shift();if(O instanceof M||O===void 0)return T;w.unshift(O),T.values.push(ar(w))}}(y,m):y}function oa(m){if(m instanceof D||m instanceof M)return 6;if(m instanceof h)switch(m.value){case"*":case"/":return 4;case"+":case"-":return 2}}function Rs(m){return m[m.length-1]}function lr(m,y,_){const w=["+","-"].includes(m.value)?"ADDITION":"MULTIPLICATION",T=y.type===w?y.values:[y],O=_.type===w?_.values:[_];return m.value==="-"?O[0]={type:"NEGATE",value:O[0]}:m.value==="/"&&(O[0]={type:"INVERT",value:O[0]}),{type:w,values:[...T,...O]}}function Os(m){if(m.type==="ADDITION")return new CSSMathSum(...m.values.map(y=>Os(y)));if(m.type==="MULTIPLICATION")return new CSSMathProduct(...m.values.map(y=>Os(y)));if(m.type==="NEGATE")return new CSSMathNegate(Os(m.value));if(m.type==="INVERT")return new CSSMathInvert(Os(m.value));if(m instanceof rr)return cr(new os("calc",m.value));if(m instanceof t){if(m.value==="e")return new CSSUnitValue(Math.E,"number");if(m.value==="pi")return new CSSUnitValue(Math.PI,"number");throw new SyntaxError("Invalid math expression")}return Je(m)}function cr(m){if(m.name==="min"||m.name==="max"){const w=m.values.filter(T=>!(T instanceof p||T instanceof C)).map(T=>ji(cr(new os("calc",T))));return m.name==="min"?new CSSMathMin(...w):new CSSMathMax(...w)}if(m.name!=="calc")return null;const y=Os(function(w){const T=[],O=[];for(;w.length;){const F=w.shift();if(F instanceof d||F instanceof f||F instanceof u||F instanceof os||F instanceof rr||F instanceof t)O.push(F);else if(F instanceof h&&["*","/","+","-"].includes(F.value)){for(;T.length&&!(Rs(T)instanceof D)&&oa(Rs(T))>oa(F);){const K=T.pop(),H=O.pop(),oe=O.pop();O.push(lr(K,oe,H))}T.push(F)}else if(F instanceof D)T.push(F);else if(F instanceof M){if(!T.length)return null;for(;!(Rs(T)instanceof D);){const K=T.pop(),H=O.pop(),oe=O.pop();O.push(lr(K,oe,H))}if(!(Rs(T)instanceof D))return null;T.pop()}else if(!(F instanceof p))return null}for(;T.length;){if(Rs(T)instanceof D)return null;const F=T.pop(),K=O.pop(),H=O.pop();O.push(lr(F,H,K))}return O[0]}([...m.values]));let _;try{_=ji(y)}catch{new CSSStyleSheet().insertRule("error",0)}return _ instanceof CSSUnitValue?new CSSMathSum(_):_}function Je(m){return m instanceof os&&["calc","min","max","clamp"].includes(m.name)?cr(m):m instanceof d&&m.value===0&&!m.unit?new CSSUnitValue(0,"px"):m instanceof d?new CSSUnitValue(m.value,"number"):m instanceof u?new CSSUnitValue(m.value,"percent"):m instanceof f?new CSSUnitValue(m.value,m.unit):void 0}function KR(m){const y=function(_){const w=bl(_);for(;w[0]instanceof p;)w.shift();if(w[0]===void 0)return null;const T=ar(w);for(;w[0]instanceof p;)w.shift();return w[0]===void 0?T:null}(m);return y===null&&new CSSStyleSheet().insertRule("error",0),y instanceof d||y instanceof u||y instanceof f||y instanceof os||new CSSStyleSheet().insertRule("error",0),y instanceof f&&yl(y.unit)===null&&new CSSStyleSheet().insertRule("error",0),Je(y)}(function(){let m=new WeakMap;function y(O){const F=[];for(let H=0;H<O.length;H++)F[H]=typeof(K=O[H])=="number"?new CSSUnitValue(K,"number"):K;var K;return F}class _{static parse(F){return F instanceof _?F:ji(KR(F),{})}}class w extends _{constructor(F,K,H,oe){super(),m.set(this,{values:y(F),operator:K,name:H||K,delimiter:oe||", "})}get operator(){return m.get(this).operator}get values(){return m.get(this).values}toString(){const F=m.get(this);return`${F.name}(${F.values.join(F.delimiter)})`}}const T={CSSNumericValue:_,CSSMathValue:w,CSSUnitValue:class extends _{constructor(O,F){super(),m.set(this,{value:O,unit:F})}get value(){return m.get(this).value}set value(O){m.get(this).value=O}get unit(){return m.get(this).unit}to(O){return Ld(this,O)}toSum(...O){return Bc(this,...O)}type(){return yl(m.get(this).unit)}toString(){const O=m.get(this);return`${O.value}${function(F){switch(F){case"percent":return"%";case"number":return"";default:return F.toLowerCase()}}(O.unit)}`}},CSSKeywordValue:class{constructor(O){this.value=O}toString(){return this.value.toString()}},CSSMathSum:class extends w{constructor(O){super(arguments,"sum","calc"," + ")}},CSSMathProduct:class extends w{constructor(O){super(arguments,"product","calc"," * ")}toSum(...O){return Bc(this,...O)}type(){return m.get(this).values.map(O=>O.type()).reduce(Dd)}},CSSMathNegate:class extends w{constructor(O){super([arguments[0]],"negate","-")}get value(){return m.get(this).values[0]}type(){return this.value.type()}},CSSMathInvert:class extends w{constructor(O){super([1,arguments[0]],"invert","calc"," / ")}get value(){return m.get(this).values[1]}type(){return function(O){const F={};for(const K of Dc)F[K]=-1*O[K];return F}(m.get(this).values[1].type())}},CSSMathMax:class extends w{constructor(){super(arguments,"max")}},CSSMathMin:class extends w{constructor(){super(arguments,"min")}}};if(!window.CSS&&!Reflect.defineProperty(window,"CSS",{value:{}}))throw Error("Error installing CSSOM support");window.CSSUnitValue||["number","percent","em","ex","px","cm","mm","in","pt","pc","Q","vw","vh","vmin","vmax","rems","ch","deg","rad","grad","turn","ms","s","Hz","kHz","dppx","dpi","dpcm","fr"].forEach(O=>{if(!Reflect.defineProperty(CSS,O,{value:F=>new CSSUnitValue(F,O)}))throw Error(`Error installing CSS.${O}`)});for(let[O,F]of Object.entries(T))if(!(O in window)&&!Reflect.defineProperty(window,O,{value:F}))throw Error(`Error installing CSSOM support for ${O}`)})();const px="block";let Fi=new WeakMap,hr=new WeakMap;const tp=["entry","exit","cover","contain","entry-crossing","exit-crossing"];function mx(m){return m===document.scrollingElement?document:m}function _l(m){Ry(m);let y=Fi.get(m).animations;if(y.length===0)return;let _=m.currentTime;for(let w=0;w<y.length;w++)y[w].tickAnimation(_)}function gx(m,y){if(!m)return null;const _=hr.get(m).sourceMeasurements,w=getComputedStyle(m);let T=_.scrollTop;return Ue(y,w)==="x"&&(T=Math.abs(_.scrollLeft)),T}function Ty(m,y){const _=ji(m,y);if(_ instanceof CSSUnitValue){if(_.unit==="px")return _.value;throw TypeError("Unhandled unit type "+_.unit)}throw TypeError("Unsupported value type: "+typeof m)}function Ry(m){if(!(m instanceof Nc))return void function(_){const w=Fi.get(_);if(!w.anonymousSource)return;const T=bx(w.anonymousSource,w.anonymousTarget);Uc(_,T)}(m);const y=m.subject;if(!y||getComputedStyle(y).display=="none")return void Uc(m,null);Uc(m,Iy(y))}function yx(m){return["block","inline","x","y"].includes(m)}function Oy(m){const y=getComputedStyle(m);return{scrollLeft:m.scrollLeft,scrollTop:m.scrollTop,scrollWidth:m.scrollWidth,scrollHeight:m.scrollHeight,clientWidth:m.clientWidth,clientHeight:m.clientHeight,writingMode:y.writingMode,direction:y.direction,scrollPaddingTop:y.scrollPaddingTop,scrollPaddingBottom:y.scrollPaddingBottom,scrollPaddingLeft:y.scrollPaddingLeft,scrollPaddingRight:y.scrollPaddingRight}}function ky(m,y){if(!m||!y)return;let _=0,w=0,T=y;const O=m.offsetParent;for(;T&&T!=O;)w+=T.offsetLeft,_+=T.offsetTop,T=T.offsetParent;w-=m.offsetLeft+m.clientLeft,_-=m.offsetTop+m.clientTop;const F=getComputedStyle(y);return{top:_,left:w,offsetWidth:y.offsetWidth,offsetHeight:y.offsetHeight,fontSize:F.fontSize}}function ip(m){let y=hr.get(m);y.sourceMeasurements=Oy(m);for(const _ of y.timelineRefs){const w=_.deref();w instanceof Nc&&(Fi.get(w).subjectMeasurements=ky(m,w.subject))}y.updateScheduled||(setTimeout(()=>{for(const _ of y.timelineRefs){const w=_.deref();w&&_l(w)}y.updateScheduled=!1}),y.updateScheduled=!0)}function Uc(m,y){const _=Fi.get(m),w=_.source;if(w!=y){if(w){const T=hr.get(w);if(T){T.timelineRefs.delete(m);const O=Array.from(T.timelineRefs).filter(F=>F.deref()===void 0);for(const F of O)T.timelineRefs.delete(F);T.timelineRefs.size===0&&(T.disconnect(),hr.delete(w))}}if(_.source=y,y){let T=hr.get(y);if(!T){T={timelineRefs:new Set,sourceMeasurements:Oy(y)},hr.set(y,T);const O=new ResizeObserver(H=>{for(const oe of H)ip(_.source)});O.observe(y);for(const H of y.children)O.observe(H);const F=new MutationObserver(H=>{for(const oe of H)ip(oe.target)});F.observe(y,{attributes:!0,attributeFilter:["style","class"]});const K=()=>{T.sourceMeasurements.scrollLeft=y.scrollLeft,T.sourceMeasurements.scrollTop=y.scrollTop;for(const H of T.timelineRefs){const oe=H.deref();oe&&_l(oe)}};mx(y).addEventListener("scroll",K),T.disconnect=()=>{O.disconnect(),F.disconnect(),mx(y).removeEventListener("scroll",K)}}T.timelineRefs.add(new WeakRef(m))}}}function Ey(m,y){let _=Fi.get(m).animations;for(let w=0;w<_.length;w++)_[w].animation==y&&_.splice(w,1)}function My(m,y,_){let w=Fi.get(m).animations;for(let T=0;T<w.length;T++)if(w[T].animation==y)return;w.push({animation:y,tickAnimation:_}),queueMicrotask(()=>{_l(m)})}class tn{constructor(y){if(Fi.set(this,{source:null,axis:px,anonymousSource:y?y.anonymousSource:null,anonymousTarget:y?y.anonymousTarget:null,subject:null,inset:null,animations:[],subjectMeasurements:null}),Uc(this,y&&y.source!==void 0?y.source:document.scrollingElement),y&&y.axis!==void 0&&y.axis!=px){if(!yx(y.axis))throw TypeError("Invalid axis");Fi.get(this).axis=y.axis}_l(this)}set source(y){Uc(this,y),_l(this)}get source(){return Fi.get(this).source}set axis(y){if(!yx(y))throw TypeError("Invalid axis");Fi.get(this).axis=y,_l(this)}get axis(){return Fi.get(this).axis}get duration(){return CSS.percent(100)}get phase(){const y=this.source;if(!y)return"inactive";let _=getComputedStyle(y);return _.display=="none"?"inactive":y==document.scrollingElement||_.overflow!="visible"&&_.overflow!="clip"?"active":"inactive"}get currentTime(){const _=this.source;if(!_||!_.isConnected||this.phase=="inactive")return null;const w=getComputedStyle(_);if(w.display==="inline"||w.display==="none")return null;const T=this.axis,O=gx(_,T),F=function(K,H){const oe=hr.get(K).sourceMeasurements,pe=getComputedStyle(K).writingMode=="horizontal-tb";return H==="block"?H=pe?"y":"x":H==="inline"&&(H=pe?"x":"y"),H==="y"?oe.scrollHeight-oe.clientHeight:H==="x"?oe.scrollWidth-oe.clientWidth:void 0}(_,T);return F>0?CSS.percent(100*O/F):CSS.percent(100)}get __polyfill(){return!0}}function Ay(m,y){let _=m.parentElement;for(;_!=null;){if(y(_))return _;_=_.parentElement}}function bx(m,y){switch(m){case"root":return document.scrollingElement;case"nearest":return Iy(y);case"self":return y;default:throw new TypeError("Invalid ScrollTimeline Source Type.")}}function ZR(m){switch(getComputedStyle(m).display){case"block":case"inline-block":case"list-item":case"table":case"table-caption":case"flow-root":case"flex":case"grid":return!0}return!1}function _x(m){const y=getComputedStyle(m);return y.transform!="none"||y.perspective!="none"||y.willChange=="transform"||y.willChange=="perspective"||y.filter!="none"||y.willChange=="filter"||y.backdropFilter!="none"}function JR(m){return getComputedStyle(m).position!="static"||_x(m)}function eO(m){switch(getComputedStyle(m).position){case"static":case"relative":case"sticky":return Ay(m,ZR);case"absolute":return Ay(m,JR);case"fixed":return Ay(m,_x)}}function Iy(m){if(m&&m.isConnected){for(;m=eO(m);)switch(getComputedStyle(m)["overflow-x"]){case"auto":case"scroll":case"hidden":return m==document.body&&getComputedStyle(document.scrollingElement).overflow=="visible"?document.scrollingElement:m}return document.scrollingElement}}function jd(m,y){const _=Fi.get(m),w=_.subjectMeasurements,T=hr.get(_.source).sourceMeasurements;return m.phase==="inactive"?null:m instanceof Nc?Ly(y,T,w,_.axis,_.inset):null}function Ly(m,y,_,w,T){const O=y.direction=="rtl"||y.writingMode=="vertical-rl";let F,K,H={fontSize:_.fontSize};Ue(w,y)==="x"?(F=_.offsetWidth,K=_.left,H.scrollPadding=[y.scrollPaddingLeft,y.scrollPaddingRight],O&&(K+=y.scrollWidth-y.clientWidth,H.scrollPadding=[y.scrollPaddingRight,y.scrollPaddingLeft]),H.containerSize=y.clientWidth):(F=_.offsetHeight,K=_.top,H.scrollPadding=[y.scrollPaddingTop,y.scrollPaddingBottom],H.containerSize=y.clientHeight);const oe=function(By,ap){const uO={start:0,end:0};if(!By)return uO;const[fO,pO]=[By.start,By.end].map((Lx,Dx)=>Lx==="auto"?ap.scrollPadding[Dx]==="auto"?0:parseFloat(ap.scrollPadding[Dx]):Ty(Lx,{percentageReference:CSS.px(ap.containerSize),fontSize:CSS.px(parseFloat(ap.fontSize))}));return{start:fO,end:pO}}(T,H),pe=K-H.containerSize+oe.end,Pe=K+F-oe.start,Oe=pe+F,nt=Pe-F,jt=Math.min(Oe,nt),_n=Math.max(Oe,nt);let ks,rs;const Ix=F>H.containerSize-oe.start-oe.end;switch(m){case"cover":ks=pe,rs=Pe;break;case"contain":ks=jt,rs=_n;break;case"entry":ks=pe,rs=jt;break;case"exit":ks=_n,rs=Pe;break;case"entry-crossing":ks=pe,rs=Ix?_n:jt;break;case"exit-crossing":ks=Ix?jt:_n,rs=Pe}return{start:ks,end:rs}}function vx(m,y){if(m instanceof Nc){const{rangeName:_,offset:w}=y;return xx(jd(m,_),w,jd(m,"cover"),m.subject)}if(m instanceof tn){const{axis:_,source:w}=m,{sourceMeasurements:T}=hr.get(w);let O;return O=Ue(_,T)==="x"?T.scrollWidth-T.clientWidth:T.scrollHeight-T.clientHeight,Ty(y,{percentageReference:CSS.px(O)})/O}unsupportedTimeline(m)}function xx(m,y,_,w){if(!m||!_)return 0;let T=getComputedStyle(w);return(Ty(y,{percentageReference:CSS.px(m.end-m.start),fontSize:CSS.px(parseFloat(T.fontSize))})+m.start-_.start)/(_.end-_.start)}let Nc=class extends tn{constructor(y){super(y);const _=Fi.get(this);_.subject=y&&y.subject?y.subject:void 0,y&&y.inset&&(_.inset=function(w){if(!w)return{start:0,end:0};let T;if(T=typeof w=="string"?lo(w).map(O=>{if(O==="auto")return"auto";try{return CSSNumericValue.parse(O)}catch{throw TypeError(`Could not parse inset "${w}"`)}}):Array.isArray(w)?w:[w],T.length===0||T.length>2)throw TypeError("Invalid inset");for(const O of T){if(O==="auto")continue;const F=O.type();if(F.length!==1&&F.percent!==1)throw TypeError("Invalid inset")}return{start:T[0],end:T[1]??T[0]}}(y.inset)),_.subject&&(new ResizeObserver(()=>{ip(_.source)}).observe(_.subject),new MutationObserver(()=>{ip(_.source)}).observe(_.subject,{attributes:!0,attributeFilter:["class","style"]})),Ry(this),_.subjectMeasurements=ky(_.source,_.subject),_l(this)}get source(){return Ry(this),Fi.get(this).source}set source(y){throw new Error("Cannot set the source of a view timeline")}get subject(){return Fi.get(this).subject}get axis(){return Fi.get(this).axis}get currentTime(){const _=gx(this.source,this.axis);if(_==null)return null;const w=jd(this,"cover");if(!w)return null;const T=(_-w.start)/(w.end-w.start);return CSS.percent(100*T)}get startOffset(){return CSS.px(jd(this,"cover").start)}get endOffset(){return CSS.px(jd(this,"cover").end)}};const tO=document.getAnimations,iO=window.Element.prototype.getAnimations,nO=window.Element.prototype.animate,wx=window.Animation;class zc{constructor(){this.state="pending",this.nativeResolve=this.nativeReject=null,this.promise=new Promise((y,_)=>{this.nativeResolve=y,this.nativeReject=_})}resolve(y){this.state="resolved",this.nativeResolve(y)}reject(y){this.state="rejected",this.promise.catch(()=>{}),this.nativeReject(y)}}function Fd(m){m.readyPromise=new zc,requestAnimationFrame(()=>{var y;(((y=m.timeline)==null?void 0:y.currentTime)??null)!==null&&(np(m),m.pendingTask!=="play"||m.startTime===null&&m.holdTime===null?m.pendingTask==="pause"&&Px(m):Cx(m))})}function Sx(){return new DOMException("The user aborted a request","AbortError")}function vl(m,y){if(y===null)return y;if(typeof y!="number")throw new DOMException(`Unexpected value: ${y}.  Cannot convert to CssNumberish`,"InvalidStateError");const _=m.rangeDuration??100,w=ur(m),T=w?_*y/w:0;return CSS.percent(T)}function Ct(m,y){if(m.timeline){if(y===null)return y;if(y.unit==="percent"){const _=m.rangeDuration??100,w=ur(m);return y.value*w/_}throw new DOMException("CSSNumericValue must be a percentage for progress based animations.","NotSupportedError")}{if(y==null||typeof y=="number")return y;const _=y.to("ms");if(_)return _.value;throw new DOMException("CSSNumericValue must be either a number or a time value for time based animations.","InvalidStateError")}}function Cx(m){const y=Ct(m,m.timeline.currentTime);if(m.holdTime!=null)co(m),m.animation.playbackRate==0?m.startTime=y:(m.startTime=y-m.holdTime/m.animation.playbackRate,m.holdTime=null);else if(m.startTime!==null&&m.pendingPlaybackRate!==null){const _=(y-m.startTime)*m.animation.playbackRate;co(m);const w=m.animation.playbackRate;w==0?(m.holdTime=null,m.startTime=y):m.startTime=y-_/w}m.readyPromise&&m.readyPromise.state=="pending"&&m.readyPromise.resolve(m.proxy),dr(m,!1,!1),fr(m),m.pendingTask=null}function Px(m){const y=Ct(m,m.timeline.currentTime);m.startTime!=null&&m.holdTime==null&&(m.holdTime=(y-m.startTime)*m.animation.playbackRate),co(m),m.startTime=null,m.readyPromise.resolve(m.proxy),dr(m,!1,!1),fr(m),m.pendingTask=null}function Tx(m){if(!m.finishedPromise||m.finishedPromise.state!="pending"||m.proxy.playState!="finished")return;m.finishedPromise.resolve(m.proxy),m.animation.pause();const y=new CustomEvent("finish",{detail:{currentTime:m.proxy.currentTime,timelineTime:m.proxy.timeline.currentTime}});Object.defineProperty(y,"currentTime",{get:function(){return this.detail.currentTime}}),Object.defineProperty(y,"timelineTime",{get:function(){return this.detail.timelineTime}}),requestAnimationFrame(()=>{queueMicrotask(()=>{m.animation.dispatchEvent(y)})})}function $c(m){return m.pendingPlaybackRate!==null?m.pendingPlaybackRate:m.animation.playbackRate}function co(m){m.pendingPlaybackRate!==null&&(m.animation.playbackRate=m.pendingPlaybackRate,m.pendingPlaybackRate=null)}function Rx(m){if(!m.timeline)return null;const y=Ct(m,m.timeline.currentTime);if(y===null||m.startTime===null)return null;let _=(y-m.startTime)*m.animation.playbackRate;return _==-0&&(_=0),_}function dr(m,y,_){if(!m.timeline)return;let w=y?Ct(m,m.proxy.currentTime):Rx(m);if(w&&m.startTime!=null&&!m.proxy.pending){const T=$c(m),O=ur(m);let F=m.previousCurrentTime;T>0&&w>=O&&m.previousCurrentTime!=null?((F===null||F<O)&&(F=O),m.holdTime=y?w:F):T<0&&w<=0?((F==null||F>0)&&(F=0),m.holdTime=y?w:F):T!=0&&(y&&m.holdTime!==null&&(m.startTime=function(K,H){if(!K.timeline)return null;const oe=Ct(K,K.timeline.currentTime);return oe==null?null:oe-H/K.animation.playbackRate}(m,m.holdTime)),m.holdTime=null)}fr(m),m.previousCurrentTime=Ct(m,m.proxy.currentTime),m.proxy.playState=="finished"?(m.finishedPromise||(m.finishedPromise=new zc),m.finishedPromise.state=="pending"&&(_?Tx(m):Promise.resolve().then(()=>{Tx(m)}))):(m.finishedPromise&&m.finishedPromise.state=="resolved"&&(m.finishedPromise=new zc),m.animation.playState!="paused"&&m.animation.pause())}function ur(m){const y=function(w){const T=w.proxy.effect.getTiming();return w.normalizedTiming||T}(m),_=y.delay+y.endDelay+y.iterations*y.duration;return Math.max(0,_)}function fr(m){if(m.timeline)if(m.startTime!==null){const y=m.timeline.currentTime;if(y==null)return;Dy(m,(Ct(m,y)-m.startTime)*m.animation.playbackRate)}else m.holdTime!==null&&Dy(m,m.holdTime)}function Dy(m,y){const _=m.timeline,w=m.animation.playbackRate,T=_.currentTime&&_.currentTime.value==(w<0?0:100)?w<0?.001:-.001:0;m.animation.currentTime=y+T}function jy(m,y){if(!m.timeline)return;const _=m.proxy.playState=="paused"&&m.proxy.pending;let w=!1,T=Ct(m,m.proxy.currentTime);$c(m)==0&&T==null&&(m.holdTime=0),T==null&&(m.autoAlignStartTime=!0),(m.proxy.playState==="finished"||_)&&(m.holdTime=null,m.startTime=null,m.autoAlignStartTime=!0),m.holdTime&&(m.startTime=null),m.pendingTask&&(m.pendingTask=null,w=!0),(m.holdTime!==null||m.autoAlignStartTime||_||m.pendingPlaybackRate!==null)&&(m.readyPromise&&!w&&(m.readyPromise=null),fr(m),m.readyPromise||Fd(m),m.pendingTask="play",My(m.timeline,m.animation,Fy.bind(m.proxy)),dr(m,!1,!1))}function Fy(m){const y=Ce.get(this);if(!y)return;if(m==null)return void(y.proxy.playState!=="paused"&&y.animation.playState!="idle"&&y.animation.cancel());np(y),y.pendingTask&&requestAnimationFrame(()=>{y.pendingTask!=="play"||y.startTime===null&&y.holdTime===null?y.pendingTask==="pause"&&Px(y):Cx(y)});const _=this.playState;if(_=="running"||_=="finished"){const w=Ct(y,m);Dy(y,(w-Ct(y,this.startTime))*this.playbackRate),dr(y,!1,!1)}}function Ox(m){m.specifiedTiming=null}let Ce=new WeakMap;window.addEventListener("pagehide",m=>{Ce=new WeakMap},!1);let kx=new WeakMap;function np(m){if(!m.autoAlignStartTime||!m.timeline||!m.timeline.currentTime||m.proxy.playState==="idle"||m.proxy.playState==="paused"&&m.holdTime!==null)return;const y=m.rangeDuration;let _,w;try{_=CSS.percent(100*function(O){if(!O.animationRange)return 0;const F=O.animationRange.start==="normal"?Ex(O.timeline):O.animationRange.start;return vx(O.timeline,F)}(m))}catch(O){_=CSS.percent(0),m.animationRange.start="normal",console.warn("Exception when calculating start offset",O)}try{w=CSS.percent(100*(1-function(O){if(!O.animationRange)return 0;const F=O.animationRange.end==="normal"?Mx(O.timeline):O.animationRange.end;return 1-vx(O.timeline,F)}(m)))}catch(O){w=CSS.percent(100),m.animationRange.end="normal",console.warn("Exception when calculating end offset",O)}m.rangeDuration=w.value-_.value;const T=$c(m);m.startTime=Ct(m,T>=0?_:w),m.holdTime=null,m.rangeDuration!==y&&Ox(m)}function sp(m){throw new Error("Unsupported timeline class")}function Ex(m){return m instanceof ViewTimeline?{rangeName:"cover",offset:CSS.percent(0)}:m instanceof tn?CSS.percent(0):void sp()}function Mx(m){return m instanceof ViewTimeline?{rangeName:"cover",offset:CSS.percent(100)}:m instanceof tn?CSS.percent(100):void sp()}function sO(m,y){if(!y)return{start:"normal",end:"normal"};const _={start:Ex(m),end:Mx(m)};if(m instanceof ViewTimeline){const w=lo(y),T=[],O=[];if(w.forEach(F=>{if(tp.includes(F))T.push(F);else try{O.push(CSSNumericValue.parse(F))}catch{throw TypeError(`Could not parse range "${y}"`)}}),T.length>2||O.length>2||O.length==1)throw TypeError("Invalid time range or unsupported time range format.");return T.length&&(_.start.rangeName=T[0],_.end.rangeName=T.length>1?T[1]:T[0]),O.length>1&&(_.start.offset=O[0],_.end.offset=O[1]),_}if(m instanceof tn){const w=y.split(" ");if(w.length!=2)throw TypeError("Invalid time range or unsupported time range format.");return _.start=CSSNumericValue.parse(w[0]),_.end=CSSNumericValue.parse(w[1]),_}sp()}function op(m,y,_){if(!y||y==="normal")return"normal";if(m instanceof ViewTimeline){let w="cover",T=_==="start"?CSS.percent(0):CSS.percent(100);if(y instanceof Object)y.rangeName!==void 0&&(w=y.rangeName),y.offset!==void 0&&(T=y.offset);else{const O=lo(y);O.length===1?tp.includes(O[0])?w=O[0]:T=ji(CSSNumericValue.parse(O[0]),{}):O.length===2&&(w=O[0],T=ji(CSSNumericValue.parse(O[1]),{}))}if(!tp.includes(w))throw TypeError("Invalid range name");return{rangeName:w,offset:T}}if(m instanceof tn)return CSSNumericValue.parse(y);sp()}class rp{constructor(y,_,w={}){const T=_ instanceof tn,O=y instanceof wx?y:new wx(y,T?void 0:_);kx.set(O,this),Ce.set(this,{animation:O,timeline:T?_:void 0,playState:T?"idle":null,readyPromise:null,finishedPromise:null,startTime:null,holdTime:null,rangeDuration:null,previousCurrentTime:null,autoAlignStartTime:!1,pendingPlaybackRate:null,pendingTask:null,specifiedTiming:null,normalizedTiming:null,effect:null,animationRange:T?sO(_,w["animation-range"]):null,proxy:this})}get effect(){const y=Ce.get(this);return y.timeline?(y.effect||(y.effect=function(_){const w=_.animation.effect,T=w.updateTiming,O={apply:function(oe){w.getTiming();const pe=oe.apply(w);if(_.timeline){const Pe=_.duration??100;pe.localTime=vl(_,pe.localTime),pe.endTime=vl(_,pe.endTime),pe.activeDuration=vl(_,pe.activeDuration);const Oe=ur(_),nt=pe.iterations?(Oe-pe.delay-pe.endDelay)/pe.iterations:0;pe.duration=Oe?CSS.percent(Pe*nt/Oe):CSS.percent(0),_.timeline.currentTime===void 0&&(pe.localTime=null)}return pe}},F={apply:function(oe,pe){if(_.specifiedTiming)return _.specifiedTiming;_.specifiedTiming=oe.apply(w);let Pe,Oe=Object.assign({},_.specifiedTiming);if(Oe.duration===1/0)throw TypeError("Effect duration cannot be Infinity when used with Scroll Timelines");return(Oe.duration===null||Oe.duration==="auto"||_.autoDurationEffect)&&_.timeline&&(_.autoDurationEffect=!0,Oe.delay=0,Oe.endDelay=0,Pe=Oe.iterations?1e5:0,Oe.duration=Oe.iterations?(Pe-Oe.delay-Oe.endDelay)/Oe.iterations:0,Oe.duration<0&&(Oe.duration=0,Oe.endDelay=Pe-Oe.delay),T.apply(w,[Oe])),_.normalizedTiming=Oe,_.specifiedTiming}},K={apply:function(oe,pe,Pe){if(Pe&&Pe.length){if(_.timeline&&Pe[0]){const Oe=Pe[0],nt=Oe.duration;if(nt===1/0)throw TypeError("Effect duration cannot be Infinity when used with Scroll Timelines");if(Oe.iterations===1/0)throw TypeError("Effect iterations cannot be Infinity when used with Scroll Timelines");nt!==void 0&&nt!=="auto"&&(_.autoDurationEffect=null)}_.specifiedTiming&&oe.apply(w,[_.specifiedTiming]),oe.apply(w,Pe),Ox(_)}}},H=new Proxy(w,{get:function(oe,pe){const Pe=oe[pe];return typeof Pe=="function"?Pe.bind(w):Pe},set:function(oe,pe,Pe){return oe[pe]=Pe,!0}});return H.getComputedTiming=new Proxy(w.getComputedTiming,O),H.getTiming=new Proxy(w.getTiming,F),H.updateTiming=new Proxy(w.updateTiming,K),H}(y)),y.effect):y.animation.effect}set effect(y){const _=Ce.get(this);_.animation.effect=y,_.effect=null,_.autoDurationEffect=null}get timeline(){const y=Ce.get(this);return y.timeline||y.animation.timeline}set timeline(y){const _=Ce.get(this),w=this.timeline;if(w==y)return;const T=this.playState,O=this.currentTime;let F,K=ur(_);F=O===null?null:K===0?0:Ct(_,O)/K;const H=w instanceof tn,oe=y instanceof tn,pe=this.pending;if(H&&Ey(_.timeline,_.animation),oe)return _.timeline=y,co(_),_.autoAlignStartTime=!0,_.startTime=null,_.holdTime=null,T!=="running"&&T!=="finished"||(_.readyPromise&&_.readyPromise.state!=="resolved"||Fd(_),_.pendingTask="play",My(_.timeline,_.animation,Fy.bind(this))),T==="paused"&&F!==null&&(_.holdTime=F*K),pe&&(_.readyPromise&&_.readyPromise.state!="resolved"||Fd(_),_.pendingTask=T=="paused"?"pause":"play"),_.startTime!==null&&(_.holdTime=null),void dr(_,!1,!1);if(_.animation.timeline!=y)throw TypeError("Unsupported timeline: "+y);if(Ey(_.timeline,_.animation),_.timeline=null,H)switch(O!==null&&(_.animation.currentTime=F*ur(_)),T){case"paused":_.animation.pause();break;case"running":case"finished":_.animation.play()}}get startTime(){const y=Ce.get(this);return y.timeline?vl(y,y.startTime):y.animation.startTime}set startTime(y){const _=Ce.get(this);if(y=Ct(_,y),!_.timeline)return void(_.animation.startTime=y);_.autoAlignStartTime=!1,Ct(_,_.timeline.currentTime)==null&&_.startTime!=null&&(_.holdTime=null,fr(_));const w=Ct(_,this.currentTime);co(_),_.startTime=y,_.startTime!==null&&_.animation.playbackRate!=0?_.holdTime=null:_.holdTime=w,_.pendingTask&&(_.pendingTask=null,_.readyPromise.resolve(this)),dr(_,!0,!1),fr(_)}get currentTime(){const y=Ce.get(this);return y.timeline?y.holdTime!=null?vl(y,y.holdTime):vl(y,Rx(y)):y.animation.currentTime}set currentTime(y){const _=Ce.get(this);_.timeline?(function(w,T){if(T==null&&w.currentTime!==null)throw new TypeError;T=Ct(w,T),w.autoAlignStartTime=!1,w.holdTime!==null||w.startTime===null||w.timeline.phase==="inactive"||w.animation.playbackRate===0?w.holdTime=T:w.startTime=Ct(w,w.timeline.currentTime)-T/w.animation.playbackRate,w.timeline.phase==="inactive"&&(w.startTime=null),w.previousCurrentTime=null}(_,y),_.pendingTask=="pause"&&(_.holdTime=Ct(_,y),co(_),_.startTime=null,_.pendingTask=null,_.readyPromise.resolve(this)),dr(_,!0,!1)):_.animation.currentTime=y}get playbackRate(){return Ce.get(this).animation.playbackRate}set playbackRate(y){const _=Ce.get(this);if(!_.timeline)return void(_.animation.playbackRate=y);_.pendingPlaybackRate=null;const w=this.currentTime;_.animation.playbackRate=y,w!==null&&(this.currentTime=w)}get playState(){const y=Ce.get(this);if(!y.timeline)return y.animation.playState;const _=Ct(y,this.currentTime);return _===null&&y.startTime===null&&y.pendingTask==null?"idle":y.pendingTask=="pause"||y.startTime===null&&y.pendingTask!="play"?"paused":_!=null&&(y.animation.playbackRate>0&&_>=ur(y)||y.animation.playbackRate<0&&_<=0)?"finished":"running"}get rangeStart(){var y;return((y=Ce.get(this).animationRange)==null?void 0:y.start)??"normal"}set rangeStart(y){const _=Ce.get(this);if(!_.timeline)return _.animation.rangeStart=y;_.timeline instanceof tn&&(_.animationRange.start=op(_.timeline,y,"start"),np(_),fr(_))}get rangeEnd(){var y;return((y=Ce.get(this).animationRange)==null?void 0:y.end)??"normal"}set rangeEnd(y){const _=Ce.get(this);if(!_.timeline)return _.animation.rangeEnd=y;_.timeline instanceof tn&&(_.animationRange.end=op(_.timeline,y,"end"),np(_),fr(_))}get replaceState(){return Ce.get(this).animation.pending}get pending(){const y=Ce.get(this);return y.timeline?!!y.readyPromise&&y.readyPromise.state=="pending":y.animation.pending}finish(){const y=Ce.get(this);if(!y.timeline)return void y.animation.finish();const _=$c(y),w=ur(y);if(_==0)throw new DOMException("Cannot finish Animation with a playbackRate of 0.","InvalidStateError");if(_>0&&w==1/0)throw new DOMException("Cannot finish Animation with an infinite target effect end.","InvalidStateError");co(y);const T=_<0?0:w;this.currentTime=vl(y,T);const O=Ct(y,y.timeline.currentTime);y.startTime===null&&O!==null&&(y.startTime=O-T/y.animation.playbackRate),y.pendingTask=="pause"&&y.startTime!==null&&(y.holdTime=null,y.pendingTask=null,y.readyPromise.resolve(this)),y.pendingTask=="play"&&y.startTime!==null&&(y.pendingTask=null,y.readyPromise.resolve(this)),dr(y,!0,!0)}play(){const y=Ce.get(this);y.timeline?jy(y):y.animation.play()}pause(){const y=Ce.get(this);y.timeline?this.playState!="paused"&&(y.animation.currentTime===null&&(y.autoAlignStartTime=!0),y.pendingTask=="play"?y.pendingTask=null:y.readyPromise=null,y.readyPromise||Fd(y),y.pendingTask="pause",My(y.timeline,y.animation,Fy.bind(y.proxy))):y.animation.pause()}reverse(){const y=Ce.get(this),_=$c(y),w=Ct(y,this.currentTime),T=ur(y)==1/0,O=_!=0&&(_<0||w>0||!T);if(!y.timeline||!O)return O&&(y.pendingPlaybackRate=-$c(y)),void y.animation.reverse();if(y.timeline.phase=="inactive")throw new DOMException("Cannot reverse an animation with no active timeline","InvalidStateError");this.updatePlaybackRate(-_),jy(y)}updatePlaybackRate(y){const _=Ce.get(this);if(_.pendingPlaybackRate=y,!_.timeline)return void _.animation.updatePlaybackRate(y);const w=this.playState;if(!_.readyPromise||_.readyPromise.state!="pending")switch(w){case"idle":case"paused":co(_);break;case"finished":const T=Ct(_,_.timeline.currentTime),O=T!==null?(T-_.startTime)*_.animation.playbackRate:null;_.startTime=y==0?T:T!=null&&O!=null?(T-O)/y:null,co(_),dr(_,!1,!1),fr(_);break;default:jy(_)}}persist(){Ce.get(this).animation.persist()}get id(){return Ce.get(this).animation.id}set id(y){Ce.get(this).animation.id=y}cancel(){const y=Ce.get(this);y.timeline?(this.playState!="idle"&&(function(_){_.pendingTask&&(_.pendingTask=null,co(_),_.readyPromise.reject(Sx()),Fd(_),_.readyPromise.resolve(_.proxy))}(y),y.finishedPromise&&y.finishedPromise.state=="pending"&&y.finishedPromise.reject(Sx()),y.finishedPromise=new zc,y.animation.cancel()),y.startTime=null,y.holdTime=null,Ey(y.timeline,y.animation)):y.animation.cancel()}get onfinish(){return Ce.get(this).animation.onfinish}set onfinish(y){Ce.get(this).animation.onfinish=y}get oncancel(){return Ce.get(this).animation.oncancel}set oncancel(y){Ce.get(this).animation.oncancel=y}get onremove(){return Ce.get(this).animation.onremove}set onremove(y){Ce.get(this).animation.onremove=y}get finished(){const y=Ce.get(this);return y.timeline?(y.finishedPromise||(y.finishedPromise=new zc),y.finishedPromise.promise):y.animation.finished}get ready(){const y=Ce.get(this);return y.timeline?(y.readyPromise||(y.readyPromise=new zc,y.readyPromise.resolve(this)),y.readyPromise.promise):y.animation.ready}addEventListener(y,_,w){Ce.get(this).animation.addEventListener(y,_,w)}removeEventListener(y,_,w){Ce.get(this).animation.removeEventListener(y,_,w)}dispatchEvent(y){Ce.get(this).animation.dispatchEvent(y)}}function oO(m,y){const _=y.timeline;_ instanceof tn&&delete y.timeline;const w=nO.apply(this,[m,y]),T=new rp(w,_);return _ instanceof tn&&(w.pause(),Ce.get(T).animationRange={start:op(_,y.rangeStart,"start"),end:op(_,y.rangeEnd,"end")},T.play()),T}function Ax(m){for(let y=0;y<m.length;++y){let _=kx.get(m[y]);_&&(m[y]=_)}return m}function rO(m){return Ax(iO.apply(this,[m]))}function aO(m){return Ax(tO.apply(this,[m]))}const qt={IDENTIFIER:/[\w\\\@_-]+/g,WHITE_SPACE:/\s*/g,NUMBER:/^[0-9]+/,TIME:/^[0-9]+(s|ms)/,SCROLL_TIMELINE:/scroll-timeline\s*:([^;}]+)/,SCROLL_TIMELINE_NAME:/scroll-timeline-name\s*:([^;}]+)/,SCROLL_TIMELINE_AXIS:/scroll-timeline-axis\s*:([^;}]+)/,VIEW_TIMELINE:/view-timeline\s*:([^;}]+)/,VIEW_TIMELINE_NAME:/view-timeline-name\s*:([^;}]+)/,VIEW_TIMELINE_AXIS:/view-timeline-axis\s*:([^;}]+)/,VIEW_TIMELINE_INSET:/view-timeline-inset\s*:([^;}]+)/,ANIMATION_TIMELINE:/animation-timeline\s*:([^;}]+)/,ANIMATION_TIME_RANGE:/animation-range\s*:([^;}]+)/,ANIMATION_NAME:/animation-name\s*:([^;}]+)/,ANIMATION:/animation\s*:([^;}]+)/,ANONYMOUS_SCROLL_TIMELINE:/scroll\(([^)]*)\)/,ANONYMOUS_VIEW_TIMELINE:/view\(([^)]*)\)/},Vc=["block","inline","x","y"],lO=["nearest","root","self"],ra=new class{constructor(){this.cssRulesWithTimelineName=[],this.nextAnonymousTimelineNameIndex=0,this.anonymousScrollTimelineOptions=new Map,this.anonymousViewTimelineOptions=new Map,this.sourceSelectorToScrollTimeline=[],this.subjectSelectorToViewTimeline=[],this.keyframeNamesSelectors=new Map}transpileStyleSheet(m,y,_){const w={sheetSrc:m,index:0,name:_};for(;w.index<w.sheetSrc.length&&(this.eatWhitespace(w),!(w.index>=w.sheetSrc.length));){if(this.lookAhead("/*",w)){for(;this.lookAhead("/*",w);)this.eatComment(w),this.eatWhitespace(w);continue}const T=this.parseQualifiedRule(w);T&&(y?this.parseKeyframesAndSaveNameMapping(T,w):this.handleScrollTimelineProps(T,w))}return w.sheetSrc}getAnimationTimelineOptions(m,y){for(let _=this.cssRulesWithTimelineName.length-1;_>=0;_--){const w=this.cssRulesWithTimelineName[_];try{if(y.matches(w.selector)&&(!w["animation-name"]||w["animation-name"]==m))return{"animation-timeline":w["animation-timeline"],"animation-range":w["animation-range"]}}catch{}}return null}getAnonymousScrollTimelineOptions(m,y){const _=this.anonymousScrollTimelineOptions.get(m);return _?{anonymousSource:_.source,anonymousTarget:y,source:bx(_.source??"nearest",y),axis:_.axis?_.axis:"block"}:null}getScrollTimelineOptions(m,y){const _=this.getAnonymousScrollTimelineOptions(m,y);if(_)return _;for(let w=this.sourceSelectorToScrollTimeline.length-1;w>=0;w--){const T=this.sourceSelectorToScrollTimeline[w];if(T.name==m){const O=this.findPreviousSiblingOrAncestorMatchingSelector(y,T.selector);if(O)return{source:O,...T.axis?{axis:T.axis}:{}}}}return null}findPreviousSiblingOrAncestorMatchingSelector(m,y){let _=m;for(;_;){if(_.matches(y))return _;_=_.previousElementSibling||_.parentElement}return null}getAnonymousViewTimelineOptions(m,y){const _=this.anonymousViewTimelineOptions.get(m);return _?{subject:y,axis:_.axis?_.axis:"block",inset:_.inset?_.inset:"auto"}:null}getViewTimelineOptions(m,y){const _=this.getAnonymousViewTimelineOptions(m,y);if(_)return _;for(let w=this.subjectSelectorToViewTimeline.length-1;w>=0;w--){const T=this.subjectSelectorToViewTimeline[w];if(T.name==m){const O=this.findPreviousSiblingOrAncestorMatchingSelector(y,T.selector);if(O)return{subject:O,axis:T.axis,inset:T.inset}}}return null}handleScrollTimelineProps(m,y){if(m.selector.includes("@keyframes"))return;const _=m.block.contents.includes("animation-name:"),w=m.block.contents.includes("animation-timeline:"),T=m.block.contents.includes("animation:");if(this.saveSourceSelectorToScrollTimeline(m),this.saveSubjectSelectorToViewTimeline(m),!w&&!_&&!T)return;let O=[],F=[],K=!1;w&&(O=this.extractScrollTimelineNames(m.block.contents)),_&&(F=this.extractMatches(m.block.contents,qt.ANIMATION_NAME)),w&&_||(T&&this.extractMatches(m.block.contents,qt.ANIMATION).forEach(H=>{const oe=this.extractAnimationName(H);oe&&w&&F.push(oe),w&&(this.hasDuration(H)||(this.hasAutoDuration(H)&&(m.block.contents=m.block.contents.replace("auto","    ")),m.block.contents=m.block.contents.replace(H," 1s "+H),K=!0))}),K&&this.replacePart(m.block.startIndex,m.block.endIndex,m.block.contents,y)),this.saveRelationInList(m,O,F)}saveSourceSelectorToScrollTimeline(m){const y=m.block.contents.includes("scroll-timeline:"),_=m.block.contents.includes("scroll-timeline-name:"),w=m.block.contents.includes("scroll-timeline-axis:");if(!y&&!_)return;let T=[];if(y){const F=this.extractMatches(m.block.contents,qt.SCROLL_TIMELINE);for(const K of F){const H=this.split(K);let oe={selector:m.selector,name:""};H.length==1?oe.name=H[0]:H.length==2&&(Vc.includes(H[0])?(oe.axis=H[0],oe.name=H[1]):(oe.axis=H[1],oe.name=H[0])),T.push(oe)}}if(_){const F=this.extractMatches(m.block.contents,qt.SCROLL_TIMELINE_NAME);for(let K=0;K<F.length;K++)if(K<T.length)T[K].name=F[K];else{let H={selector:m.selector,name:F[K]};T.push(H)}}let O=[];if(w){const F=this.extractMatches(m.block.contents,qt.SCROLL_TIMELINE_AXIS);if(O=F.filter(K=>Vc.includes(K)),O.length!=F.length)throw new Error("Invalid axis")}for(let F=0;F<T.length;F++)O.length&&(T[F].axis=O[F%T.length]);this.sourceSelectorToScrollTimeline.push(...T)}saveSubjectSelectorToViewTimeline(m){const y=m.block.contents.includes("view-timeline:"),_=m.block.contents.includes("view-timeline-name:"),w=m.block.contents.includes("view-timeline-axis:"),T=m.block.contents.includes("view-timeline-inset:");if(!y&&!_)return;let O=[];if(y){const H=this.extractMatches(m.block.contents,qt.VIEW_TIMELINE);for(let oe of H){const pe=this.split(oe);let Pe={selector:m.selector,name:"",inset:null};pe.length==1?Pe.name=pe[0]:pe.length==2&&(Vc.includes(pe[0])?(Pe.axis=pe[0],Pe.name=pe[1]):(Pe.axis=pe[1],Pe.name=pe[0])),O.push(Pe)}}if(_){const H=this.extractMatches(m.block.contents,qt.VIEW_TIMELINE_NAME);for(let oe=0;oe<H.length;oe++)if(oe<O.length)O[oe].name=H[oe];else{let pe={selector:m.selector,name:H[oe],inset:null};O.push(pe)}}let F=[],K=[];if(T&&(F=this.extractMatches(m.block.contents,qt.VIEW_TIMELINE_INSET)),w){const H=this.extractMatches(m.block.contents,qt.VIEW_TIMELINE_AXIS);if(K=H.filter(oe=>Vc.includes(oe)),K.length!=H.length)throw new Error("Invalid axis")}for(let H=0;H<O.length;H++)F.length&&(O[H].inset=F[H%O.length]),K.length&&(O[H].axis=K[H%O.length]);this.subjectSelectorToViewTimeline.push(...O)}hasDuration(m){return m.split(" ").filter(y=>{return _=y,qt.TIME.exec(_);var _}).length>=1}hasAutoDuration(m){return m.split(" ").filter(y=>y==="auto").length>=1}saveRelationInList(m,y,_){let w=[];m.block.contents.includes("animation-range:")&&(w=this.extractMatches(m.block.contents,qt.ANIMATION_TIME_RANGE));const T=Math.max(y.length,_.length,w.length);for(let O=0;O<T;O++)this.cssRulesWithTimelineName.push({selector:m.selector,"animation-timeline":y[O%y.length],..._.length?{"animation-name":_[O%_.length]}:{},...w.length?{"animation-range":w[O%w.length]}:{}})}extractScrollTimelineNames(m){const y=qt.ANIMATION_TIMELINE.exec(m)[1].trim(),_=[];return y.split(",").map(w=>w.trim()).forEach(w=>{if(function(T){return(T.startsWith("scroll")||T.startsWith("view"))&&T.includes("(")}(w)){const T=this.saveAnonymousTimelineName(w);_.push(T)}else _.push(w)}),_}saveAnonymousTimelineName(m){const y=":t"+this.nextAnonymousTimelineNameIndex++;return m.startsWith("scroll(")?this.anonymousScrollTimelineOptions.set(y,this.parseAnonymousScrollTimeline(m)):this.anonymousViewTimelineOptions.set(y,this.parseAnonymousViewTimeline(m)),y}parseAnonymousScrollTimeline(m){const y=qt.ANONYMOUS_SCROLL_TIMELINE.exec(m);if(!y)return null;const _=y[1],w={};return _.split(" ").forEach(T=>{Vc.includes(T)?w.axis=T:lO.includes(T)&&(w.source=T)}),w}parseAnonymousViewTimeline(m){const y=qt.ANONYMOUS_VIEW_TIMELINE.exec(m);if(!y)return null;const _=y[1],w={};return _.split(" ").forEach(T=>{Vc.includes(T)?w.axis=T:w.inset=w.inset?`${w.inset} ${T}`:T}),w}extractAnimationName(m){return this.findMatchingEntryInContainer(m,this.keyframeNamesSelectors)}findMatchingEntryInContainer(m,y){const _=m.split(" ").filter(w=>y.has(w));return _?_[0]:null}parseIdentifier(m){qt.IDENTIFIER.lastIndex=m.index;const y=qt.IDENTIFIER.exec(m.sheetSrc);if(!y)throw this.parseError(m,"Expected an identifier");return m.index+=y[0].length,y[0]}parseKeyframesAndSaveNameMapping(m,y){if(m.selector.startsWith("@keyframes")){const _=this.replaceKeyframesAndGetMapping(m,y);m.selector.split(" ").forEach((w,T)=>{T>0&&this.keyframeNamesSelectors.set(w,_)})}}replaceKeyframesAndGetMapping(m,y){function _(H){return tp.some(oe=>H.startsWith(oe))}const w=m.block.contents,T=function(H){let oe=0,pe=-1,Pe=-1;const Oe=[];for(let nt=0;nt<H.length;nt++)H[nt]=="{"?oe++:H[nt]=="}"&&oe--,oe==1&&H[nt]!="{"&&H[nt]!="}"&&pe==-1&&(pe=nt),oe==2&&H[nt]=="{"&&(Pe=nt,Oe.push({start:pe,end:Pe}),pe=Pe=-1);return Oe}(w);if(T.length==0)return new Map;const O=new Map;let F=!1;const K=[];K.push(w.substring(0,T[0].start));for(let H=0;H<T.length;H++){const oe=w.substring(T[H].start,T[H].end);let pe=[];oe.split(",").forEach(Pe=>{const Oe=Pe.split(" ").map(jt=>jt.trim()).filter(jt=>jt!="").join(" "),nt=O.size;O.set(nt,Oe),pe.push(`${nt}%`),_(Oe)&&(F=!0)}),K.push(pe.join(",")),H==T.length-1?K.push(w.substring(T[H].end)):K.push(w.substring(T[H].end,T[H+1].start))}return F?(m.block.contents=K.join(""),this.replacePart(m.block.startIndex,m.block.endIndex,m.block.contents,y),O):new Map}parseQualifiedRule(m){const y=m.index,_=this.parseSelector(m).trim();if(_)return{selector:_,block:this.eatBlock(m),startIndex:y,endIndex:m.index}}removeEnclosingDoubleQuotes(m){let y=m[0]=='"'?1:0,_=m[m.length-1]=='"'?m.length-1:m.length;return m.substring(y,_)}assertString(m,y){if(m.sheetSrc.substr(m.index,y.length)!=y)throw this.parseError(m,`Did not find expected sequence ${y}`);m.index+=y.length}replacePart(m,y,_,w){if(w.sheetSrc=w.sheetSrc.slice(0,m)+_+w.sheetSrc.slice(y),w.index>=y){const T=w.index-y;w.index=m+_.length+T}}eatComment(m){this.assertString(m,"/*"),this.eatUntil("*/",m,!0),this.assertString(m,"*/")}eatBlock(m){const y=m.index;this.assertString(m,"{");let _=1;for(;_!=0;)this.lookAhead("/*",m)?this.eatComment(m):(m.sheetSrc[m.index]==="{"?_++:m.sheetSrc[m.index]==="}"&&_--,this.advance(m));const w=m.index;return{startIndex:y,endIndex:w,contents:m.sheetSrc.slice(y,w)}}advance(m){if(m.index++,m.index>m.sheetSrc.length)throw this.parseError(m,"Advanced beyond the end")}parseError(m,y){return Error(`(${m.name?m.name:"<anonymous file>"}): ${y}`)}eatUntil(m,y,_=!1){const w=y.index;for(;!this.lookAhead(m,y);)this.advance(y);return _&&(y.sheetSrc=y.sheetSrc.slice(0,w)+" ".repeat(y.index-w)+y.sheetSrc.slice(y.index)),y.sheetSrc.slice(w,y.index)}parseSelector(m){let y=m.index;if(this.eatUntil("{",m),y===m.index)throw Error("Empty selector");return m.sheetSrc.slice(y,m.index)}eatWhitespace(m){qt.WHITE_SPACE.lastIndex=m.index;const y=qt.WHITE_SPACE.exec(m.sheetSrc);y&&(m.index+=y[0].length)}lookAhead(m,y){return y.sheetSrc.substr(y.index,m.length)==m}peek(m){return m.sheetSrc[m.index]}extractMatches(m,y,_=","){return y.exec(m)[1].trim().split(_).map(w=>w.trim())}split(m){return m.split(" ").map(y=>y.trim()).filter(y=>y!="")}};function cO(m,y,_,w,T,O){const F=Oy(y),K=ky(y,_);return xx(Ly(m,F,K,w,T),O,Ly("cover",F,K,w,T),_)}function hO(m,y,_){const w=ra.getAnimationTimelineOptions(y,_);if(!w)return null;const T=w["animation-timeline"];if(!T)return null;let O=ra.getScrollTimelineOptions(T,_)||ra.getViewTimelineOptions(T,_);return O?(O.subject&&function(F,K){const H=Iy(K.subject),oe=K.axis||K.axis;function pe(Oe,nt){let jt=null;for(const[_n,ks]of Oe)if(_n==100*nt.offset){if(ks=="from")jt=0;else if(ks=="to")jt=100;else{const rs=ks.split(" ");jt=rs.length==1?parseFloat(rs[0]):100*cO(rs[0],H,K.subject,oe,K.inset,CSS.percent(parseFloat(rs[1])))}break}return jt}const Pe=ra.keyframeNamesSelectors.get(F.animationName);if(Pe&&Pe.size){const Oe=[];F.effect.getKeyframes().forEach(jt=>{const _n=pe(Pe,jt);_n!==null&&_n>=0&&_n<=100&&(jt.offset=_n/100,Oe.push(jt))});const nt=Oe.sort((jt,_n)=>jt.offset<_n.offset?-1:jt.affset>_n.offset?1:0);F.effect.setKeyframes(nt)}}(m,O),{timeline:O.source?new tn(O):new Nc(O),animOptions:w}):null}function dO(){if(CSS.supports("animation-timeline: --works"))return!0;(function(){function y(w){if(w.innerHTML.trim().length===0||"aphrodite"in w.dataset)return;let T=ra.transpileStyleSheet(w.innerHTML,!0);T=ra.transpileStyleSheet(T,!1),w.innerHTML=T}function _(w){w.type!="text/css"&&w.rel!="stylesheet"||!w.href||new URL(w.href,document.baseURI).origin==location.origin&&fetch(w.getAttribute("href")).then(async T=>{const O=await T.text();let F=ra.transpileStyleSheet(O,!0);if(F=ra.transpileStyleSheet(O,!1),F!=O){const K=new Blob([F],{type:"text/css"}),H=URL.createObjectURL(K);w.setAttribute("href",H)}})}new MutationObserver(w=>{for(const T of w)for(const O of T.addedNodes)O instanceof HTMLStyleElement&&y(O),O instanceof HTMLLinkElement&&_(O)}).observe(document.documentElement,{childList:!0,subtree:!0}),document.querySelectorAll("style").forEach(w=>y(w)),document.querySelectorAll("link").forEach(w=>_(w))})();const m=CSS.supports;CSS.supports=y=>(y=y.replaceAll(/(animation-timeline|scroll-timeline(-(name|axis))?|view-timeline(-(name|axis|inset))?|timeline-scope)\s*:/g,"--supported-property:"),m(y)),window.addEventListener("animationstart",y=>{y.target.getAnimations().filter(_=>_.animationName===y.animationName).forEach(_=>{const w=hO(_,_.animationName,y.target);if(w)if(!w.timeline||_ instanceof rp)_.timeline=w.timeline;else{const T=new rp(_,w.timeline,w.animOptions);_.pause(),T.play()}})})}(function(){if(!dO()){if(!Reflect.defineProperty(window,"ScrollTimeline",{value:tn}))throw Error("Error installing ScrollTimeline polyfill: could not attach ScrollTimeline to window");if(!Reflect.defineProperty(window,"ViewTimeline",{value:Nc}))throw Error("Error installing ViewTimeline polyfill: could not attach ViewTimeline to window");if(!Reflect.defineProperty(Element.prototype,"animate",{value:oO}))throw Error("Error installing ScrollTimeline polyfill: could not attach WAAPI's animate to DOM Element");if(!Reflect.defineProperty(window,"Animation",{value:rp}))throw Error("Error installing Animation constructor.");if(!Reflect.defineProperty(Element.prototype,"getAnimations",{value:rO}))throw Error("Error installing ScrollTimeline polyfill: could not attach WAAPI's getAnimations to DOM Element");if(!Reflect.defineProperty(document,"getAnimations",{value:aO}))throw Error("Error installing ScrollTimeline polyfill: could not attach WAAPI's getAnimations to document")}})()})();var Ed=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Yd=k("debugscroll");class dl extends W{constructor(){super(...arguments);a(this,"target",null);a(this,"damping",0);a(this,"invert",!1);a(this,"htmlSelector",null);a(this,"mode","window");a(this,"changed",new je);a(this,"_current_value",0);a(this,"_target_value",0);a(this,"_appliedValue",-1);a(this,"_needsUpdate",!1);a(this,"_firstUpdate",!1);a(this,"_lastSelectorValue",null);a(this,"_lastSelectorElement",null);a(this,"updateCurrentScrollValue",()=>{var e;switch(this.mode){case"window":if((e=this.htmlSelector)!=null&&e.length){if(this.htmlSelector!==this._lastSelectorValue&&(this._lastSelectorElement=document.querySelector(this.htmlSelector),this._lastSelectorValue=this.htmlSelector),this._lastSelectorElement){const i=this._lastSelectorElement.getBoundingClientRect();this._target_value=-i.top/(i.height-window.innerHeight);break}}else if(!(window.document.body.scrollHeight<=window.innerHeight)){const i=window.document.body.scrollHeight-window.innerHeight;this._target_value=window.scrollY/(i||1)}break}(isNaN(this._target_value)||!isFinite(this._target_value))&&(this._target_value=-1)})}get currentValue(){return this._current_value}awake(){this._firstUpdate=!0}onEnable(){window.addEventListener("wheel",this.updateCurrentScrollValue,{passive:!0}),this._appliedValue=-1,this._needsUpdate=!0}onDisable(){window.removeEventListener("wheel",this.updateCurrentScrollValue)}lateUpdate(){if(this.updateCurrentScrollValue(),this._target_value>=0&&(this.damping>0&&!this._firstUpdate?(this._current_value=ee.lerp(this._current_value,this._target_value,this.context.time.deltaTime/this.damping),Math.abs(this._current_value-this._target_value)<.001&&(this._current_value=this._target_value)):this._current_value=this._target_value),this._needsUpdate||this._current_value!==this._appliedValue){this._appliedValue=this._current_value,this._needsUpdate=!1;let e=!1;if(this.changed.listenerCount>0){const i={type:"change",value:this._current_value,component:this,preventDefault:()=>{i.defaultPrevented=!0},defaultPrevented:!1};this.changed.invoke(i),e=i.defaultPrevented}if(!e){const i=this.invert?1-this._current_value:this._current_value;Array.isArray(this.target)?this.target.forEach(n=>n&&this.applyScroll(n,i)):this.target&&this.applyScroll(this.target,i),Yd&&this.context.time.frame%30===0&&console.debug(`[ScrollFollow] ${this._current_value.toFixed(5)} ‚Äî ${(this._target_value*100).toFixed(0)}%, targets [${Array.isArray(this.target)?this.target.length:1}]`)}this._firstUpdate=!1}}applyScroll(e,i){if(e)if(e instanceof Js)this.handleTimelineTarget(e,i),e.isPlaying&&e.pause(),e.evaluate();else if(e instanceof Ei)e.setFloat("scroll",i);else if(e instanceof pn)e.time=i*e.duration;else if(e instanceof We){if(!e.duration)return;e.time=i*e.duration}else if(e instanceof ao)e.position01=i;else if(e instanceof Di)e.intensity=i;else if(e instanceof z){const n=e;n["needle:scrollbounds"]===void 0&&(n["needle:scrollbounds"]=On(e)||null);const o=n["needle:scrollbounds"];o&&(e.position.y=-o.min.y-i*(o.max.y-o.min.y))}else"scroll"in e&&(typeof e.scroll=="number"?e.scroll=i:typeof e.scroll=="function"&&e.scroll(i))}handleTimelineTarget(e,i){var h;const n=e.duration;let o=kC.get(e);if(!o){o=[],kC.set(e,o);let d=0;for(const u of e.foreachMarker("ScrollMarker")){const f=d++;if(u.element===void 0||u.needsUpdate===!0||u.element&&!((h=u.element)!=null&&h.parentNode)){u.needsUpdate=!1;try{if(u.element=AR(f),Yd&&console.debug(`ScrollMarker #${f} (${u.time.toFixed(2)}) found`,u.element),!u.element){(Yd||X())&&console.warn(`No HTML element found for ScrollMarker: ${u.name} (index ${f})`);continue}}catch(p){u.element=null,console.error("ScrollMarker selector is not valid: "+u.name+`
`,p)}}u.element&&o.push(u)}o.length<=0&&document.querySelectorAll("[data-timeline-marker]").forEach(f=>{const p=f.getAttribute("data-timeline-marker"),b=parseFloat(p||"NaN");isNaN(b)?(X()||Yd)&&console.warn('[ScrollFollow] data-timeline-marker attribute is not a valid number. Supported are numbers only (e.g. <div data-timeline-marker="0.5">)'):o.push({time:b,element:f})});for(const u of o)u.element&&(u.timeline=new ViewTimeline({subject:u.element,axis:"block"}))}mo.length=0;let r=0;const l=1/60;let c=0;for(let d=0;d<o.length;d++){const u=o[d];if(!u.element)continue;const f=o[d+1],p=f?f.time-l:n;c+=1;const b=u.timeline;if(b){const x=Yj(b),v=1-Math.abs(x-.5)*2,S=`marker${d}`;if(x>0&&x<=1){const C=u.time+(p-u.time)*x;mo.push({name:S,time:C,weight:v}),r+=v}else d===0&&x<=0?(mo.push({name:S,time:0,weight:1}),r+=1):d===o.length-1&&x>=1&&(mo.push({name:S,time:n,weight:1}),r+=1)}}if(mo.length<=0&&c<=0)e.time=i*n;else if(mo.length>0){let d=mo[0].time;if(mo.length>1)for(const f of mo){const p=f.weight/Math.max(1e-5,r),b=Math.abs(f.time-d);d+=b*p}this.damping<=0||this._firstUpdate?e.time=d:e.time=ee.lerp(e.time,d,this.context.time.deltaTime/this.damping),Math.abs(e.time-d)>.001&&(this._needsUpdate=!0),Yd&&this.context.time.frame%30===0&&console.log(`[ScrollFollow ] Timeline ${e.name}: ${d.toFixed(3)}`,mo.map(f=>`[${f.name} ${(f.weight*100).toFixed(0)}%]`).join(", "))}}}Ed([g([W,z])],dl.prototype,"target",void 0);Ed([g()],dl.prototype,"damping",void 0);Ed([g()],dl.prototype,"invert",void 0);Ed([g()],dl.prototype,"htmlSelector",void 0);Ed([g()],dl.prototype,"mode",void 0);Ed([g(je)],dl.prototype,"changed",void 0);const kC=new WeakMap,mo=[],e_=new Array;let t_=!0;function AR(s){return t_?(t_=!1,e_.length=0,document.querySelectorAll("[data-timeline-marker]").forEach((e,i)=>{e_[i]=e}),t_=!1,AR(s)):e_[s]||null}function Yj(s){if(!s.source)return 0;const t=s.currentTime,e=s.duration;let i=1;return(e.unit==="seconds"||e.unit==="percent")&&(i=e.value),t.unit==="seconds"?t.value/i:t.value/100}var Sy=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},js;const ma=k("debugviewbox"),Kj=new Te(.5,.5,.5,.5);var ou;let mc=js=(ou=class extends W{constructor(){super(...arguments);a(this,"referenceFieldOfView",-1);a(this,"_mode","continuous");a(this,"debug",!1);a(this,"_applyCount",0);a(this,"internalUpdate",()=>{if(this.context.isInXR||this.destroyed||!this.activeAndEnabled)return;if(!(js.instances[js.instances.length-1]===this)){(ma||this.debug)&&se.DrawWireBox(this.gameObject.worldPosition,this.gameObject.worldScale,Kj);return}(ma||this.debug)&&se.DrawWireBox(this.gameObject.worldPosition,this.gameObject.worldScale,14540032,0,!0,this.gameObject.worldQuaternion);const i=this.context.mainCamera;if(!i||!(i instanceof Ae))return;if((this.referenceFieldOfView===void 0||this.referenceFieldOfView===-1)&&(this.referenceFieldOfView=i.fov,console.debug("[ViewBox] No referenceFieldOfView set, using camera fov:",this.referenceFieldOfView)),this.referenceFieldOfView===void 0||this.referenceFieldOfView<=0){(ma||this.debug)&&console.warn("[ViewBox] No valid referenceFieldOfView set, cannot adjust box size:",this.referenceFieldOfView);return}if(this._applyCount>=1&&this.mode==="once")return;this._applyCount++;const n=this.context.domWidth,o=this.context.domHeight;let r=n,l=o,c=1,h=1;const d=this.context.focusRectSize;d&&(r=d.width,l=d.height,c=n/r,h=o/l),js._tempProjectionMatrix.copy(i.projectionMatrix),js._tempProjectionMatrixInverse.copy(i.projectionMatrixInverse);const u=i.view,f=i.zoom,p=i.aspect,b=i.fov;i.view=null,i.zoom=1,i.fov=this.referenceFieldOfView,i.updateProjectionMatrix();const x=this.gameObject.worldPosition,v=this.gameObject.worldScale,S=i.worldPosition,C=S.distanceTo(x),P=Math.max(v.x,v.y,v.z),E=te(S).sub(x);if(C<P){(this.debug||ma)&&console.warn("[ViewBox] Moving camera out of bounds",C,"<",P);const Z=te(E);Z.y*=1e-8,Z.normalize();const ae=P-C,ie=S.add(Z.multiplyScalar(ae));i.worldPosition=ie.lerp(S,1-this.context.time.deltaTime)}const D=te(x);i.worldToLocal(D),i.lookAt(x),i.updateMatrixWorld();const M=this.referenceFieldOfView*Math.PI/180,A=2*Math.tan(M/2)*C,G=A*i.aspect,V=this.projectBoxIntoCamera(i,1),U=V.maxX-V.minX,$=V.maxY-V.minY,B=this.fit(U*i.aspect,$,G/c,A/h)/(A*.5),N=te(x);N.project(i),this.context.focusRectSettings.offsetX=N.x,this.context.focusRectSettings.offsetY=N.y,this.context.focusRectSettings.zoom=B,this.context.focusRect||this.context.setCameraFocusRect(this.context.domElement),i.view=u,i.zoom=f,i.aspect=p,i.fov=b,i.projectionMatrix.copy(js._tempProjectionMatrix),i.projectionMatrixInverse.copy(js._tempProjectionMatrixInverse)});a(this,"_projectedBoxElement",null)}get mode(){return this._mode}set mode(e){e!==this._mode&&(this._mode=e,e==="once"&&(this._applyCount=0),(ma||this.debug)&&console.debug("[ViewBox] Set mode:",e))}onEnable(){(ma||this.debug||X())&&console.debug("[ViewBox] Using camera fov:",this.referenceFieldOfView),js.instances.push(this),this._applyCount=0,this.removeUpdateCallback(),this.context.pre_render_callbacks.push(this.internalUpdate)}onDisable(){var i;(ma||this.debug)&&console.debug("[ViewBox] Disabled");const e=js.instances.indexOf(this);e!==-1&&js.instances.splice(e,1),(i=this._projectedBoxElement)==null||i.remove(),this.removeUpdateCallback()}removeUpdateCallback(){const e=this.context.pre_render_callbacks.indexOf(this.internalUpdate);e!==-1&&this.context.pre_render_callbacks.splice(e,1)}fit(e,i,n,o){const r=n/e,l=o/i;return Math.min(r,l)}projectBoxIntoCamera(e,i){const n=.5*i,o=[te(-n,-n,-n),te(n,-n,-n),te(-n,n,-n),te(n,n,-n),te(-n,-n,n),te(n,-n,n),te(-n,n,n),te(n,n,n)];let r=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY,c=Number.POSITIVE_INFINITY,h=Number.NEGATIVE_INFINITY;for(let d=0;d<o.length;d++){const u=o[d];u.applyMatrix4(this.gameObject.matrixWorld),u.project(e),u.x<r&&(r=u.x),u.x>l&&(l=u.x),u.y<c&&(c=u.y),u.y>h&&(h=u.y)}return ma&&(this._projectedBoxElement||(this._projectedBoxElement=document.createElement("div")),this._projectedBoxElement.parentElement!==this.context.domElement&&this.context.domElement.appendChild(this._projectedBoxElement),this._projectedBoxElement.style.position="fixed",this._projectedBoxElement.style.outline="2px dashed rgba(255,0,0,.5)",this._projectedBoxElement.style.left=(r*.5+.5)*this.context.domWidth+"px",this._projectedBoxElement.style.top=(-h*.5+.5)*this.context.domHeight+"px",this._projectedBoxElement.style.width=(l-r)*.5*this.context.domWidth+"px",this._projectedBoxElement.style.height=(h-c)*.5*this.context.domHeight+"px",this._projectedBoxElement.style.pointerEvents="none",this._projectedBoxElement.style.zIndex="1000"),{minX:r,maxX:l,minY:c,maxY:h}}},a(ou,"instances",[]),a(ou,"_tempProjectionMatrix",new xe),a(ou,"_tempProjectionMatrixInverse",new xe),ou);Sy([g()],mc.prototype,"referenceFieldOfView",void 0);Sy([g()],mc.prototype,"mode",null);Sy([g()],mc.prototype,"debug",void 0);mc=js=Sy([YP],mc);var Md=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class ul extends W{constructor(){super(...arguments);a(this,"side","none");a(this,"controller",!0);a(this,"hands",!1);a(this,"controlVisibility",!0);a(this,"useGripSpace",!1);a(this,"resetTransformAfterXRSession",!0);a(this,"_startPosition",new R);a(this,"_startRotation",new re);a(this,"_startScale",new R)}get activeAndEnabled(){return!0}onEnterXR(e){this._startPosition.copy(this.gameObject.position),this._startRotation.copy(this.gameObject.quaternion),this._startScale.copy(this.gameObject.scale)}onUpdateXR(e){if(!this.enabled)return;const i=e.xr.getController(this.side);if(i){if(i.hand&&!this.hands){this.controlVisibility&&(this.gameObject.visible=!1);return}else if(!this.controller){this.controlVisibility&&(this.gameObject.visible=!1);return}this.controlVisibility&&(this.gameObject.visible=!0),this.useGripSpace||i.targetRayMode==="transient-pointer"?(this.gameObject.worldPosition=i.gripWorldPosition,this.gameObject.worldQuaternion=i.gripWorldQuaternion,this.gameObject.worldScale=te(i.xr.rigScale,i.xr.rigScale,i.xr.rigScale).multiply(this._startScale)):(this.gameObject.worldPosition=i.rayWorldPosition,this.gameObject.worldQuaternion=i.rayWorldQuaternion,this.gameObject.worldScale=te(i.xr.rigScale,i.xr.rigScale,i.xr.rigScale).multiply(this._startScale))}}onLeaveXR(e){this.resetTransformAfterXRSession&&(this.gameObject.position.copy(this._startPosition),this.gameObject.quaternion.copy(this._startRotation),this.gameObject.scale.copy(this._startScale))}}Md([g()],ul.prototype,"side",void 0);Md([g()],ul.prototype,"controller",void 0);Md([g()],ul.prototype,"hands",void 0);Md([g()],ul.prototype,"controlVisibility",void 0);Md([g()],ul.prototype,"useGripSpace",void 0);Md([g()],ul.prototype,"resetTransformAfterXRSession",void 0);function IR(s,t){const e=s.xr.getFrame();if(!e)return console.warn("No XRFrame available"),!1;const i=e.session.enabledFeatures;if(i&&!i.some(o=>o==="camera-access"))return console.error(`No camera feed available - please request the 'camera-access' feature before starting WebXR or add the ARCameraBackground component to your scene.

Example to request camera-access in global scope:
NeedleXRSession.onSessionRequestStart(evt => {
    evt.init.optionalFeatures = evt.init.optionalFeatures || [];
    evt.init.optionalFeatures.push('camera-access');
});
`),X()&&Ag("No camera feed available - please request the 'camera-access' feature before starting WebXR or add the ARCameraBackground component to your scene"),!1;const n=e.getViewerPose(s.xr.getReferenceSpace());if(n)for(const o of n.views)if("camera"in o&&o.camera){let r=s.xr.getBinding();if(r||(r=new XRWebGLBinding(e.session,s.getContext())),r){let l=null;if("getCameraImage"in r){Zj(s,t);const c=s.properties.get(t);if(c)return l=r.getCameraImage(o.camera),c.__webglTexture=l,!0;console.warn("No texture properties found for target texture")}}else console.error(o.camera,s.xr)}else console.error("NO CAMERA IN VIEW");else console.error(s.xr.getReferenceSpace(),e);return!1}const EC=new WeakMap;function Zj(s,t){const e=EC.get(t)||new WeakSet;if(e.has(s))return;e.add(s),EC.set(t,e),console.debug("Initialize texture for camera feed");const i=new Ye,n=new to,o=new Xn;o.add(new le(n,i));const r=new Ae;i.map=t,s.render(o,r)}function J4(s,t,e,i="image/webp",n){return LR({context:s,width:t,height:e,mimeType:i,camera:n})}function LR(s){var M,A;s||(s={});const{transparent:t=!1}=s;let{mimeType:e,context:i,width:n,height:o,camera:r}=s;if(!i&&(i=Be.Current,!i))return console.error("Can not save screenshot: No needle-engine context found or provided."),null;if(!r&&(r=i.mainCamera,!r))return console.error("No camera found"),null;const l=i.renderer,c=l.xr.enabled&&l.xr.isPresenting;if(c&&i.currentFrameEvent!=ge.EarlyUpdate)return console.warn("Screenshot: defer to access XR frame"),new Promise(V=>{Yr(U=>{const $=LR(s);V($)},ge.EarlyUpdate,{once:!0})});const h=l.domElement,d=h.width,u=h.height;n||(n=d),o||(o=u);const f=n,p=o;let b=window.devicePixelRatio||1,x=1;i.devicePixelRatio==="auto"||i.devicePixelRatio==="manual"?x=1:x=i.devicePixelRatio/window.devicePixelRatio,b*=x,n/=b,o/=b,n=Math.floor(n),o=Math.floor(o),l.xr.isPresenting&&l.xr.getFrame();const v=l.xr.enabled;l.xr.enabled=!1,l.xr.isPresenting=!1,h.style.width=`${n}px`,h.style.height=`${o}px`;const S=l.getRenderTarget(),C=l.getClearColor(new Se),P=l.getClearAlpha(),E=i.scene.background,D="aspect"in r?r.aspect:null;try{const G=s.render_events!==!1,V=new Array;G&&(kf(i.scene,tt,V),V.forEach(N=>{var Z;if(N==null||N.onBeforeRender(),N.isInstancingActive&&N.instances)for(let ae=0;ae<((Z=N.instances)==null?void 0:Z.length);ae++){const ie=N.instances[ae];Rr(ie.object,!0)}})),t&&(i.scene.background=null,l.setClearColor(0,0)),s.background&&(i.scene.background=null,l.setClearColor(s.background),s.background instanceof Te&&l.setClearAlpha(s.background.a)),t&&l.setClearAlpha(0),l.setSize(n,o,!1),"cam"in r&&(r=r.threeCamera),r instanceof Ae&&(r.aspect=n/o,r.updateProjectionMatrix());const U="type"in s&&s.type==="texture";let $=null;U&&($=new Qo(n,o,{wrapS:Ux,wrapT:Ux,format:1023}),l.setRenderTarget($));let Y=h;if(c?($&&console.error('Taking XR screenshots with { type: "texture" } is currently not supported.'),Y=og.compositeWithCameraImage({width:f,height:p,scene:i.scene,camera:r,renderer:l})):i.renderNow(r||null),r instanceof Ae&&D!=null&&(r.aspect=D,r.updateProjectionMatrix()),G&&V.forEach(N=>N.onAfterRender()),!e&&"download_filename"in s&&s.download_filename)switch((M=s.download_filename.split(".").pop())==null?void 0:M.toLowerCase()){case"png":e="image/png";break;case"jpg":case"jpeg":e="image/jpeg";break;case"webp":e="image/webp";break}if(t&&s.trim===!0){const N=Jj(Y);N&&(Y=N)}if("type"in s){if(s.type==="texture")return $?(s.target&&(s.target.image=$==null?void 0:$.texture.image,s.target.needsUpdate=!0),$.texture.offset.set(0,-1),$.texture.needsUpdate=!0,$.texture):(console.error("No target texture found"),null);if(s.type==="blob")return new Promise((Z,ae)=>{Y.toBlob(ie=>{Z(ie)},e)});if(s.type==="share")return new Promise((Z,ae)=>{Y.toBlob(ie=>{if(ie&&"share"in navigator){let J="file_type"in s&&s.file_type||e;e||(J="image/png");const ye=(J==null?void 0:J.split("/")[1])||"png",Fe=new File([ie],"filename"in s?s.filename||`screenshot.${ye}`:`screenshot.${ye}`,{type:J});return navigator.share({title:"title"in s?s.title:void 0,text:"text"in s?s.text:void 0,url:"url"in s?s.url:void 0,files:[Fe]}).catch(Ze=>{console.warn("User cancelled share",Ze.message)}).finally(()=>{Z({blob:ie,shared:!0})})}return{blob:ie,shared:!1}},e)})}const B=Y.toDataURL(e);if("download_filename"in s&&s.download_filename){let N=s.download_filename;if(Q.isMobileDevice()&&typeof window<"u"){const Z=N+"_screenshots",ae=N.split("."),ie=(A=ae.pop())==null?void 0:A.toLowerCase();let J=0;localStorage.getItem(Z)&&(J=parseInt(sessionStorage.getItem(Z)||"0")),J>0&&(N=`${ae.join()}-${J}.${ie}`),J+=1,sessionStorage.setItem(Z,J.toString())}eF(B,N)}return B}finally{l.setRenderTarget(S),i.scene.background=E,l.setSize(d,u,!1),l.setClearColor(C,P),D!=null&&r instanceof Ae&&(r.aspect=D,r.updateProjectionMatrix()),l.xr.enabled=v,l.xr.isPresenting=c,c||i.updateSize(!0)}return null}function Jj(s){if(!("document"in globalThis))return null;const t=document.createElement("canvas");t.width=s.width,t.height=s.height;const e=t.getContext("2d");if(!e)return null;e.drawImage(s,0,0);const i=t.width,n=t.height,r=e.getImageData(0,0,i,n).data;let l=n,c=i,h=0,d=0;for(let x=0;x<n;x++)for(let v=0;v<i;v++){const S=(x*i+v)*4;r[S+3]!==0&&(v<c&&(c=v),v>d&&(d=v),x<l&&(l=x),x>h&&(h=x))}const u=d-c+1,f=h-l+1,p=document.createElement("canvas"),b=p.getContext("2d");return b?(p.width=u,p.height=f,b.drawImage(t,c,l,u,f,0,0,u,f),p):null}let Kd=null;function eF(s,t){if(s){if(!s.startsWith("data:image")){console.error("Can not save image: Data url is not an image",s);return}Kd||(Kd=document.createElement("a")),Kd.href=s,Kd.download=t,Kd.click()}}var og;(function(s){let t=null,e=null,i=null,n=null,o=null;function r(h){const{renderer:d,width:u,height:f}=h,p=d.xr.enabled,b=d.getRenderTarget(),x=d.autoClear,v=u,S=f,C=u/f;(!i||i.width!==v||i.height!==S)&&(i??(i=new Qo(v,S,{colorSpace:Vr})),i.width=v,i.height=S,i.samples=4,i.texture.repeat.y=-1,i.texture.offset.y=1),(!o||o.width!==v||o.height!==S)&&(o=document.createElement("canvas"),o.width=v,o.height=S,o.style.position="fixed",o.style.top="0px",o.style.right="0px",o.style.width="300px",o.style.height=`${300/C}px`,o.style.zIndex="1000",o.style.pointerEvents="none",o.style.opacity="1.0",o.style.willChange="contents"),t||(t=c({defines:{DECODE_VIDEO_TEXTURE:!0}})),e||(e=c()),n||(n=new _t),d.xr.updateCamera(h.camera),d.xr.enabled=!1,d.autoClear=!1,d.clear(),d.setSize(v,S),d.setRenderTarget(i),IR(h.renderer,n)||console.error("Could not update texture from XR frame");const E=I.findObjectOfType(Cy);return E?E.setTexture(n):(t.setTexture(n),d.render(t,h.camera)),d.clearDepth(),d.setSize(v,S),d.render(h.scene,h.camera),d.setRenderTarget(null),e.setTexture(i.texture),d.render(e,h.camera),o.getContext("2d",{alpha:!1}).drawImage(d.domElement,0,0,o.width,o.height),d.setRenderTarget(b),d.xr.enabled=p,d.autoClear=x,o}s.compositeWithCameraImage=r;const l=`
uniform sampler2D t2D;
varying vec2 vUv;

void main() {

    vec4 texColor = texture2D( t2D, vUv );

    #ifdef DECODE_VIDEO_TEXTURE

        // inline sRGB decode (TODO: Remove this code when https://crbug.com/1256340 is solved)
        texColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );

    #endif

    gl_FragColor = texColor;
    #include <tonemapping_fragment>
    #include <colorspace_fragment>
}
`;function c(h){const d=(h==null?void 0:h.material)||new Xo({name:"BackgroundMaterial",uniforms:i1.clone(_m.background.uniforms),vertexShader:_m.background.vertexShader,fragmentShader:l,defines:h==null?void 0:h.defines,side:Wa,depthTest:!1,depthWrite:!1,fog:!1});Object.defineProperty(d,"map",{get:function(){return this.threeTexture}});const u=new le(new to(2,2),d);return f_(u,!1),u.geometry.deleteAttribute("normal"),u.renderOrder=-1e6,u.setTexture=function(f){d.uniforms.t2D.value=f},u}s.makeFullscreenPlane=c})(og||(og={}));var tF=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const MC=k("debugarcamera");class Cy extends W{constructor(){super(...arguments);a(this,"backgroundTint",new Te(1,1,1,1));a(this,"backgroundPlane");a(this,"threeTexture");a(this,"forceTextureInitialization",function(){const e=new Ye,i=new to,n=new Xn;n.add(new le(i,e));const o=new Ae;return function(l,c){e.map=c,l.render(n,o),MC&&console.warn("Force texture initialization")}}());a(this,"preRender",()=>{if(!this||!this.gameObject)return;if(this.context.renderer.xr.getFrame()){if(!this.threeTexture&&this.context.renderer&&(this.threeTexture=new _t,this.forceTextureInitialization(this.context.renderer,this.threeTexture)),this.backgroundPlane===void 0){const n=this.backgroundTint;this.backgroundPlane=og.makeFullscreenPlane({material:new Xo({name:"BackgroundMaterial",uniforms:{...i1.clone(_m.background.uniforms),tint:{value:new Ne(n.r,n.g,n.b,n.a)}},vertexShader:_m.background.vertexShader,fragmentShader:iF,side:Qn,depthTest:!1,depthWrite:!1,fog:!1})})}this.backgroundPlane.parent!==this.scene&&this.scene.add(this.backgroundPlane),this.backgroundPlane.material instanceof Xo&&this.backgroundPlane.material.uniforms.tint.value.set(this.backgroundTint.r,this.backgroundTint.g,this.backgroundTint.b,this.backgroundTint.a),this.updateFromFrame()}})}onBeforeXR(e,i){e==="immersive-ar"&&(i.optionalFeatures=i.optionalFeatures||[],i.optionalFeatures.push("camera-access"),MC&&console.warn("Requesting camera-access"))}onEnterXR(e){e.xr.mode==="immersive-ar"&&(this.backgroundPlane&&(this.context.scene.add(this.backgroundPlane),this.backgroundPlane.visible=!1),this.backgroundPlane&&this.context.scene.add(this.backgroundPlane),this.context.pre_render_callbacks.push(this.preRender))}onLeaveXR(e){this.backgroundPlane&&this.backgroundPlane.removeFromParent();const i=this.context.pre_render_callbacks.indexOf(this.preRender);i>=0&&this.context.pre_render_callbacks.splice(i,1)}get background(){return this.backgroundPlane}onBeforeRender(e){this.updateFromFrame()}updateFromFrame(){var e;this.threeTexture&&((e=this.context.xr)==null?void 0:e.mode)==="immersive-ar"&&(IR(this.context.renderer,this.threeTexture),this.setTexture(this.threeTexture))}setTexture(e){this.backgroundPlane&&(this.threeTexture=e,this.backgroundPlane.setTexture(this.threeTexture),this.backgroundPlane.visible=!0)}}tF([g(Te)],Cy.prototype,"backgroundTint",void 0);const iF=`
uniform sampler2D t2D;
uniform vec4 tint;

varying vec2 vUv;

void main() {

    vec4 texColor = texture2D( t2D, vUv );
    texColor.w = 1.0;

    // inline sRGB decode
    texColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );

    gl_FragColor = texColor * tint;

    #include <tonemapping_fragment>
    #include <colorspace_fragment>
}
`;var fl=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Hu=k("debugimagetracking"),mg=class{constructor(t,e,i,n,o,r){a(this,"measuredSize");a(this,"state");a(this,"_position");a(this,"_rotation");a(this,"_trackingComponent");a(this,"_trackedImage");a(this,"_bitmap");a(this,"_pose");this._trackingComponent=t,this._trackedImage=e,this._bitmap=i,this.measuredSize=n,this.state=o,this._pose=r}get url(){return this._trackedImage.image??""}get widthInMeters(){return this._trackedImage.widthInMeters??void 0}get bitmap(){return this._bitmap}get model(){return this._trackedImage}getPosition(t){return this.ensureTransformData(),t.copy(this._position),t}getQuaternion(t){return this.ensureTransformData(),t.copy(this._rotation),t}applyToObject(t,e=void 0){this.ensureTransformData();const i=t.position.distanceToSquared(this._position)/.05+t.quaternion.angleTo(this._rotation)/.05;e&&(e*=Math.max(1,i)),e===void 0||e>=1?(t.position.copy(this._position),t.quaternion.copy(this._rotation)):(e=Math.max(0,Math.min(1,e)),t.position.lerp(this._position,e),t.quaternion.slerp(this._rotation,e))}ensureTransformData(){if(!this._position){this._position=mg._positionBuffer.get(),this._rotation=mg._rotationBuffer.get();const t=this._pose.transform,e=fe.active.convertSpace(t);this._position.copy(e==null?void 0:e.position),this._rotation.copy(e==null?void 0:e.quaternion)}}};let xh=mg;a(xh,"_positionBuffer",new vs(()=>new R,20)),a(xh,"_rotationBuffer",new vs(()=>new re,20));class pl{constructor(t){a(this,"image");a(this,"widthInMeters",.25);a(this,"object");a(this,"createObjectInstance",!1);a(this,"imageDoesNotMove",!1);a(this,"hideWhenTrackingIsLost",!0);this.image=t.url,this.widthInMeters=t.widthInMeters,t.object instanceof z?this.object=new we({asset:t.object}):this.object=t.object,t.createObjectInstance!==void 0&&(this.createObjectInstance=t.createObjectInstance),t.imageDoesNotMove!==void 0&&(this.imageDoesNotMove=t.imageDoesNotMove),t.hideWhenTrackingIsLost!==void 0&&(this.hideWhenTrackingIsLost=t.hideWhenTrackingIsLost)}getNameFromUrl(){if(this.image){const t=this.image.split("/");return t[t.length-1]}return null}}fl([g(URL)],pl.prototype,"image",void 0);fl([g()],pl.prototype,"widthInMeters",void 0);fl([g(we)],pl.prototype,"object",void 0);fl([g()],pl.prototype,"createObjectInstance",void 0);fl([g()],pl.prototype,"imageDoesNotMove",void 0);fl([g()],pl.prototype,"hideWhenTrackingIsLost",void 0);class nF{constructor(t,e){a(this,"exporter");a(this,"component");a(this,"isImageTrackingExtension",!0);a(this,"shouldExport",!0);a(this,"filename",null);a(this,"imageModel",null);this.exporter=t,this.component=e,Hu&&console.log(this),this.exporter.anchoringType="image"}get extensionName(){return"image-tracking"}onBeforeBuildDocument(t){var i;const e=this.exporter.extensions.filter(n=>{var r;const o=n;return o.isImageTrackingExtension&&o.component.activeAndEnabled&&((r=o.component.trackedImages)==null?void 0:r.length)>0}).indexOf(this);this.shouldExport=e===0,this.shouldExport&&((i=this.component.trackedImages)==null?void 0:i.length)>1&&(Hu||X())&&(qe("USDZ: Only one tracked image is supported."),console.warn("USDZ: Only one tracked image is supported. Will choose the first one in the trackedImages list"))}onAfterHierarchy(t,e){if(!this.shouldExport)return;const i=Q.getiOSVersion(),r=(i?parseInt(i.split(".")[0]):18)>=18?1:100;e.beginBlock('def Preliminary_ReferenceImage "AnchoringReferenceImage"'),e.appendLine("uniform asset image = @image_tracking/"+this.filename+"@"),e.appendLine("uniform double physicalWidth = "+(this.imageModel.widthInMeters*r).toFixed(8)),e.closeBlock()}async onAfterSerialize(t){if(!this.shouldExport)return;const e=this.imageModel,i=Gu.get(e.image),r=await(await(await KD(i)).convertToBlob({type:"image/png"})).arrayBuffer();t.files["image_tracking/"+this.filename]=new Uint8Array(r)}onExportObject(t,e,i){var r,l;if(!this.shouldExport)return;const n=this.component;if(!n||!((r=n.trackedImages)!=null&&r.length)||!n.activeAndEnabled)return;const o=n.trackedImages[0];if(((l=o.object)==null?void 0:l.asset)===t){this.imageModel=o,this.filename=o.getNameFromUrl()||"marker.png";const{scale:c,target:h}=this.exporter.getARScaleAndTarget();let d=t;const u=new xe;if(t!==h)for(;d&&d.parent&&d.parent!==h;)d=d.parent,u.premultiply(d.matrix);const f=u.clone().invert();e.setMatrix(f.scale(new R(c,c,c)))}}}class Py extends W{constructor(){super(...arguments);a(this,"trackedImages",[]);a(this,"smooth",!0);a(this,"trackedImageIndexMap",new Map);a(this,"_supported",!0);a(this,"onBeforeUSDZExport",e=>{var i;this.activeAndEnabled&&((i=this.trackedImages)!=null&&i.length)&&e.exporter.extensions.push(new nF(e.exporter,this))});a(this,"imageToObjectMap",new Map);a(this,"currentImages",[]);a(this,"webXRIncubationsWarning",`Image tracking is currently not supported on this device. On Chrome for Android, you can enable the <a target="_blank" href="#" onclick="() => console.log('I')">chrome://flags/#webxr-incubations</a> flag.`);a(this,"onImageTrackingUpdate",e=>{const i=fe.active;if(i)for(const n of e){const o=n.model,r=n.state==="tracked";if(!o.object)continue;let l=this.imageToObjectMap.get(o);if(l===void 0)l={object:null,frames:0,lastTrackingTime:Date.now()},this.imageToObjectMap.set(o,l),o.object.loadAssetAsync().then(c=>{if(o.createObjectInstance&&c&&(c=I.instantiate(c)),c){l.object=c;for(const h of c.getComponentsInChildren(tt))h.setInstancingEnabled(!1);i.rig?(i.rig.gameObject.add(c),n.applyToObject(c),c.activeSelf||I.setActive(c,!0)):console.warn("XRImageTracking: missing XRRig")}});else{if(l.frames++,r&&(l.lastTrackingTime=Date.now()),o.imageDoesNotMove&&l.frames>10||!l.object)continue;i.rig&&(i.rig.gameObject.add(l.object),n.applyToObject(l.object,this.smooth?this.context.time.deltaTimeUnscaled*3:void 0),l.object.activeSelf||I.setActive(l.object,!0))}}})}setPrimaryImage(e){const i=this.trackedImages.indexOf(e);if(i>=0){const n=this.trackedImages[0];n!==e&&(this.trackedImages[0]=e,this.trackedImages[i]=n)}else console.warn(`[WebXRImageTracking] Can not set primary: image not found in 'trackedImages' array ${e.image}`)}addImage(e,i=!1){this.trackedImages.includes(e)||(this.trackedImages.push(e),AC(e.image)),i&&this.setPrimaryImage(e)}get supported(){return this._supported}awake(){if(Hu&&console.log(this),!!this.trackedImages)for(const e of this.trackedImages)e.image&&AC(e.image)}onEnable(){Ge.beforeExport.addEventListener(this.onBeforeUSDZExport)}onDisable(){Ge.beforeExport.removeEventListener(this.onBeforeUSDZExport)}onBeforeXR(e,i){var n;if(this.trackedImages){i.optionalFeatures=i.optionalFeatures||[],i.optionalFeatures.includes("image-tracking")||i.optionalFeatures.push("image-tracking"),i.trackedImages||(i.trackedImages=[]);for(const o of this.trackedImages)if((n=o.image)!=null&&n.length&&o.widthInMeters>0){const r=Gu.get(o.image);r&&(this.trackedImageIndexMap.set(i.trackedImages.length,o),i.trackedImages.push({image:r,widthInMeters:o.widthInMeters}))}}}onEnterXR(e){var i;if(this.trackedImages){for(const n of this.trackedImages)if((i=n.object)!=null&&i.asset){const o=n.object.asset;o.userData||(o.userData={});const r={visible:o.visible,parent:o.parent,matrix:o.matrix.clone()};o.userData["image-tracking"]=r}}for(const n of this.imageToObjectMap.values())n.frames=0}onLeaveXR(e){var i,n;if(!this.supported&&Q.isAndroidDevice()&&qe(this.webXRIncubationsWarning),this.trackedImages){for(const o of this.trackedImages)if((i=o.object)!=null&&i.asset){const r=o.object.asset;if(r.userData){const l=r.userData["image-tracking"];l&&(r.visible=l.visible,(n=l.parent)==null||n.add(r),r.matrix.copy(l.matrix),r.matrix.decompose(r.position,r.quaternion,r.scale)),delete r.userData["image-tracking"]}}}}onUpdateXR(e){var o;this.currentImages.length=0;const i=e.xr.frame;if(!i)return;if("getImageTrackingResults"in i){if(((o=e.xr.session.enabledFeatures)==null?void 0:o.includes("image-tracking"))===!1)return;if(i.session&&typeof i.getImageTrackingResults=="function"){const r=i.getImageTrackingResults();if(r.length>0){const l=this.context.renderer.xr.getReferenceSpace();if(l){for(const c of r){const h=c.trackingState,d=c.index,u=this.trackedImageIndexMap.get(d);if(u){const f=i.getPose(c.imageSpace,l),p=new xh(this,u,c.image,c.measuredSize,h,f);this.currentImages.push(p)}else Hu&&console.warn("No tracked image for index",d)}if(this.currentImages.length>0)try{this.dispatchEvent(new CustomEvent("image-tracking",{detail:this.currentImages})),this.onImageTrackingUpdate(this.currentImages)}catch(c){console.error(c)}}}}}else{this.didPrintWarning||(this.didPrintWarning=!0,console.log(this.webXRIncubationsWarning)),this._supported=!1,qe(this.webXRIncubationsWarning);return}const n=1e3;for(const[r,l]of this.imageToObjectMap){if(!l.object||!r||r.hideWhenTrackingIsLost===!1)continue;let c=!1;for(const h of this.currentImages)if(h.model===r){const d=Date.now()-l.lastTrackingTime;if(Hu&&at(r.image+", State: "+h.state+(r.imageDoesNotMove?" (static)":"")+(d<=n?" (hysteresis)":"")),r.imageDoesNotMove||h.state==="tracked"||d<=n){c=!0;break}}c||I.setActive(l.object,!1)}}}fl([g(pl)],Py.prototype,"trackedImages",void 0);fl([g()],Py.prototype,"smooth",void 0);const Gu=new Map,Xp=new Map;async function AC(s){if(Gu.has(s))return Xp.has(s)?Xp.get(s):Promise.resolve(!0);const t=new Promise(e=>{Gu.set(s,null);const i=document.createElement("img");i.src=s,i.addEventListener("load",async()=>{const n=await createImageBitmap(i);Gu.set(s,n),e(!0)})});return Xp.set(s,t),t.finally(()=>{Xp.delete(s)}),t}var Ad=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Ml=k("debugplanetracking");class ml extends W{constructor(){super(...arguments);a(this,"dataTemplate");a(this,"occluder",!0);a(this,"initiateRoomCaptureIfNoData",!0);a(this,"usePlaneData",!0);a(this,"useMeshData",!0);a(this,"runInVR",!0);a(this,"bounds",new bs);a(this,"center",new R);a(this,"labelOffset",new R);a(this,"_dataId",1);a(this,"_allPlanes",new Map);a(this,"_allMeshes",new Map);a(this,"firstTimeNoPlanesDetected",-100);a(this,"makeOccluder",(e,i,n=!1)=>{if(i){if(i instanceof Array){for(const o of i)this.makeOccluder(e,o,n);return}!n&&!i.name.toLowerCase().includes("occlu")||(i.colorWrite=!1,i.depthTest=!0,i.depthWrite=!0,i.transparent=!1,i.polygonOffset=!0,i.polygonOffsetFactor=1,i.polygonOffsetUnits=.1,e.renderOrder=-1e3)}});a(this,"_flipForwardMatrix",new xe().makeRotationY(Math.PI));a(this,"_verticesCache",new Map)}get trackedPlanes(){return this._allPlanes.values()}get trackedMeshes(){return this._allMeshes.values()}onBeforeXR(e,i){e==="immersive-vr"&&!this.runInVR||(i.optionalFeatures=i.optionalFeatures||[],this.usePlaneData&&!i.optionalFeatures.includes("plane-detection")&&i.optionalFeatures.push("plane-detection"),this.useMeshData&&!i.optionalFeatures.includes("mesh-detection")&&i.optionalFeatures.push("mesh-detection"))}onEnterXR(e){for(const i of this._allPlanes.keys())this.removeData(i,this._allPlanes);for(const i of this._allMeshes.keys())this.removeData(i,this._allMeshes)}onLeaveXR(e){for(const i of this._allPlanes.keys())this.removeData(i,this._allPlanes);for(const i of this._allMeshes.keys())this.removeData(i,this._allMeshes)}onUpdateXR(e){if(!this.runInVR&&e.xr.isVR)return;const i=e.xr.rig;if(!i){console.warn("No XR rig found, cannot parent tracked planes to it");return}const n=e.xr.frame;if(!this.context.renderer.xr.getReferenceSpace())return;const l=n.detectedPlanes,c=n.detectedMeshes,h=l!==void 0&&l.size>0,d=c!==void 0&&c.size>0;if(this.initiateRoomCaptureIfNoData&&(!h&&!d&&this.firstTimeNoPlanesDetected<-10&&(this.firstTimeNoPlanesDetected=Date.now()),(h||d)&&(this.firstTimeNoPlanesDetected=-1),this.firstTimeNoPlanesDetected>0&&Date.now()-this.firstTimeNoPlanesDetected>2500&&"initiateRoomCapture"in n.session&&(n.session.initiateRoomCapture(),this.firstTimeNoPlanesDetected=-1)),l!==void 0&&this.processFrameData(e.xr,i.gameObject,n,l,this._allPlanes),c!==void 0&&this.processFrameData(e.xr,i.gameObject,n,c,this._allMeshes),Ml){const u=this.context.mainCameraComponent.gameObject.worldPosition;for(const f of this._allPlanes.values())!f.mesh||!f.mesh.visible||(this.bounds.makeEmpty(),f.mesh.traverse(p=>{p instanceof le&&this.bounds.expandByObject(p)}),this.bounds.getCenter(this.center),this.labelOffset.copy(u).sub(this.center).normalize().multiplyScalar(.1),se.DrawLabel(this.center.add(this.labelOffset),(f.xrData.semanticLabel||"plane").toUpperCase()+`
`+f.xrData.lastChangedTime.toFixed(2),.02))}}removeData(e,i){const n=i.get(e);if(!n)return;i.delete(e),Ml&&console.log("Plane no longer tracked, id="+n.id),n.mesh&&(n.mesh.removeFromParent(),n.mesh.traverse(r=>{const l=r.userData.normalsHelper;l?(l.dispose(),l.removeFromParent()):Ml&&console.warn("No normals helper found for mesh",n.mesh)}),xs(n.mesh,!0,!0));const o=new CustomEvent("plane-tracking",{detail:{type:"plane-removed",context:n}});this.dispatchEvent(o)}processFrameData(e,i,n,o,r){const c=this.context.renderer.xr.getReferenceSpace();if(c){for(const h of r.keys())o.has(h)||this.removeData(h,r);for(const h of o){const d="planeSpace"in h?h.planeSpace:"meshSpace"in h?h.meshSpace:void 0;if(!d)continue;const u=n.getPose(d,c);let f;if(r.has(h)){const p=r.get(h);if(f=p.mesh,p.timestamp<h.lastChangedTime){if(p.timestamp=h.lastChangedTime,p.mesh){const x=this.createGeometry(h);if(p.mesh instanceof le)p.mesh.geometry.dispose(),p.mesh.geometry=x,this.makeOccluder(p.mesh,p.mesh.material);else if(p.mesh instanceof Ir)for(const v of p.mesh.children)v instanceof le&&(v.geometry.dispose(),v.geometry=x,this.makeOccluder(v,v.material));if(p.collider){const v=p.mesh;p.collider.sharedMesh=v,p.collider.convex=this.checkIfContextShouldBeConvex(v,p.xrData),p.collider.onDisable(),p.collider.onEnable()}Ml&&(console.log("Plane updated, id="+p.id,p),p.mesh.traverse(v=>{if(!(v instanceof le))return;const S=v.userData.normalsHelper;S&&S.update()}))}const b=new CustomEvent("plane-tracking",{detail:{type:"plane-updated",context:p}});this.dispatchEvent(b)}}else{if(!this.dataTemplate){const p=new le;Ml?p.material=new kk:this.occluder?(p.material=new Ye,this.makeOccluder(p,p.material,!0)):p.material=new Ye({wireframe:!0,opacity:.5,transparent:!0,color:3355443}),this.dataTemplate=new we("","",p)}if(!this.dataTemplate.asset)this.dataTemplate.loadAssetAsync();else{const p=I.instantiate(this.dataTemplate.asset);if(p.name="xr-tracked-plane",f=p,T1(p,!1),p instanceof le)ft(p.geometry),p.geometry=this.createGeometry(h),this.makeOccluder(p,p.material,this.occluder&&!this.dataTemplate);else if(p instanceof Ir)for(const v of p.children)v instanceof le&&(ft(v.geometry),v.geometry=this.createGeometry(h),this.makeOccluder(v,v.material,this.occluder&&!this.dataTemplate));const b=p.getComponent(Cc);if(b){const v=p;b.sharedMesh=v,b.convex=this.checkIfContextShouldBeConvex(v,h),b.onDisable(),b.onEnable()}p.matrixAutoUpdate=!1,p.matrixWorldNeedsUpdate=!0,i.add(p);const x={id:this._dataId++,xrData:h,timestamp:h.lastChangedTime,mesh:p,collider:b};r.set(h,x),Ml&&console.log("New plane detected, id="+x.id,x,{hasCollider:!!b,isGroup:p instanceof Ir});try{const v=new CustomEvent("plane-tracking",{detail:{type:"plane-added",context:x}});this.dispatchEvent(v)}catch(v){console.error(v)}}}f&&(u?(f.visible=!0,f.matrix.fromArray(u.transform.matrix),f.matrix.premultiply(this._flipForwardMatrix)):f.visible=!1,Ml&&f.traverse(p=>{if(p instanceof le)if(p.userData.normalsHelper)p.userData.normalsHelper.update();else{const b=new Kk(p,.05,255);b.layers.disableAll(),b.layers.set(2),this.context.scene.add(b),p.userData.normalsHelper=b}}))}}}checkIfContextShouldBeConvex(e,i){if(!e)return!0;if(e){const n=new bs;n.expandByObject(e);const o=new R;n.getSize(o);let r=!0;return o.x>2&&o.y>2&&o.z>1.5&&(r=!1),r&&"semanticLabel"in i&&i.semanticLabel==="wall"&&(r=!0),r}return!0}createGeometry(e){return"polygon"in e?this.createPlaneGeometry(e.polygon):"vertices"in e&&"indices"in e?this.createMeshGeometry(e.vertices,e.indices):new Gs}createMeshGeometry(e,i){const n=e.toString()+"_"+i.toString();if(this._verticesCache.has(n))return this._verticesCache.get(n);const o=new Gs;o.setIndex(new Cn(i,1)),o.setAttribute("position",new Cn(e,3));const r=Array();for(let l=0;l<e.length;l+=3)r.push(e[l],e[l+2]);return o.setAttribute("uv",new Cn(e,3)),o.computeVertexNormals(),this._verticesCache.set(n,o),o}createPlaneGeometry(e){const i=new Gs,n=[],o=[];e.forEach(p=>{n.push(p.x,p.y,p.z),o.push(p.x,p.z)});const r=new R(n[0],n[1],n[2]),l=new R(n[3],n[4],n[5]),c=new R(n[6],n[7],n[8]),h=new R,d=new R;h.subVectors(l,r),d.subVectors(c,r),h.cross(d),h.normalize();const u=[];for(let p=0;p<n.length/3;p++)u.push(h.x,h.y,h.z);const f=[];for(let p=2;p<e.length;++p)f.push(0,p-1,p);return i.setAttribute("position",new Cn(new Float32Array(n),3)),i.setAttribute("uv",new Cn(new Float32Array(o),2)),i.setAttribute("normal",new Cn(new Float32Array(u),3)),i.setIndex(f),i.computeBoundingBox(),i.computeBoundingSphere(),i}}Ad([g(we)],ml.prototype,"dataTemplate",void 0);Ad([g()],ml.prototype,"occluder",void 0);Ad([g()],ml.prototype,"initiateRoomCaptureIfNoData",void 0);Ad([g()],ml.prototype,"usePlaneData",void 0);Ad([g()],ml.prototype,"useMeshData",void 0);Ad([g()],ml.prototype,"runInVR",void 0);var sF=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const IC=k("debugwebxr");class Jv extends W{constructor(){super(...arguments);a(this,"priority",0);a(this,"_startScale")}get isActive(){return this.activeAndEnabled&&this.gameObject.visible}setAsActiveXRRig(){var e;(e=fe.active)==null||e.setRigActive(this)}setPriority(e){this.priority=e}awake(){if(IC){const e=new z;e.position.y+=.5,this.gameObject.add(e);const i=e.addNewComponent(_d);i&&(i.isGizmo=!1);const n=new Wn(.5);this.gameObject.add(n)}}isXRRig(){return!0}supportsXR(e){return!0}onEnterXR(e){this._startScale=this.gameObject.scale.clone(),e.xr.addRig(this),IC&&console.log("WebXR: add Rig",this.name,this.priority)}onLeaveXR(e){e.xr.removeRig(this),this._startScale&&this.gameObject&&this.gameObject.scale.copy(this._startScale)}}sF([g()],Jv.prototype,"priority",void 0);class oF extends W{constructor(){super(...arguments);a(this,"toggleKey","KeyP")}update(){this.context.input.isKeyDown(this.toggleKey)&&this.context.domElement.classList.toggle("presentation-mode")}}j.add("AlignmentConstraint",Vg);j.add("Animation",pn);j.add("Animator",Ei);j.add("AudioListener",Aa);j.add("AudioSource",We);j.add("Avatar_Brain_LookAt",$m);j.add("Avatar_MouthShapes",qg);j.add("Avatar_MustacheShake",kT);j.add("AvatarBlink_Simple",hd);j.add("AvatarEyeLook_Rotation",Ua);j.add("AxesHelper",Lf);j.add("BasicIKConstraint",MT);j.add("BoxHelperComponent",Nn);j.add("Camera",ze);j.add("CharacterController",dd);j.add("CharacterControllerInput",Ka);j.add("SphereCollider",Df);j.add("BoxCollider",Sc);j.add("MeshCollider",Cc);j.add("CapsuleCollider",Ga);j.add("ContactShadows",qn);j.add("LogStats",AT);j.add("DeleteBox",Fh);j.add("Deletable",LT);j.add("DeviceFlag",_v);j.add("DragControls",si);j.add("DropListener",Za);j.add("Duplicatable",Tc);j.add("EventListEvent",fv);j.add("EventTrigger",Sv);j.add("GltfExportBox",GT);j.add("GltfExport",Do);j.add("VariantAction",iR);j.add("ChangeTransformOnClick",md);j.add("ChangeMaterialOnClick",$s);j.add("SetActiveOnClick",fs);j.add("HideOnStart",Xl);j.add("EmphasizeOnClick",Ff);j.add("PlayAudioOnClick",dc);j.add("PlayAnimationOnClick",Uo);j.add("PreliminaryAction",Bf);j.add("PreliminaryTrigger",Zg);j.add("VisibilityAction",Jg);j.add("TapGestureTrigger",nR);j.add("USDZExporter",Ge);j.add("Fog",zf);j.add("BoxGizmo",_d);j.add("GridHelper",$f);j.add("GroundProjectedEnv",Kr);j.add("UsageMarker",Qg);j.add("Interactable",IT);j.add("FixedJoint",mR);j.add("HingeJoint",sy);j.add("Light",Di);j.add("LODGroup",oy);j.add("LookAtConstraint",cd);j.add("NeedleMenu",ea);j.add("NestedGltf",ry);j.add("Networking",qa);j.add("OffsetConstraint",vd);j.add("CameraTargetReachedEvent",Nm);j.add("OrbitControls",He);j.add("ParticleSystemRenderer",oo);j.add("ParticleSystem",vt);j.add("Attractor",Gf);j.add("PlayerColor",vf);j.add("Antialiasing",ly);j.add("BloomEffect",Br);j.add("ChromaticAberration",cy);j.add("ColorAdjustments",kc);j.add("DepthOfField",nr);j.add("EffectWrapper",eg);j.add("PixelationEffect",dy);j.add("ScreenSpaceAmbientOcclusion",ol);j.add("ScreenSpaceAmbientOcclusionN8",sr);j.add("SharpeningEffect",uy);j.add("TiltShiftEffect",ia);j.add("ToneMappingEffect",pc);j.add("Vignette",Cd);j.add("Volume",Xf);j.add("ReflectionProbe",Bo);j.add("Renderer",tt);j.add("MeshRenderer",Yg);j.add("SkinnedMeshRenderer",$T);j.add("Rigidbody",De);j.add("SceneSwitcher",$t);j.add("ScreenCapture",Ac);j.add("SeeThrough",rl);j.add("ShadowCatcher",fy);j.add("RemoteSkybox",qr);j.add("SmoothFollow",qo);j.add("SpatialTriggerReceiver",Ur);j.add("SpatialTrigger",ac);j.add("SpectatorCamera",Wv);j.add("SplineContainer",Rd);j.add("SplineWalker",ao);j.add("SpriteRenderer",Kn);j.add("SyncedCamera",Nh);j.add("SyncedRoom",or);j.add("SyncedTransform",Zo);j.add("TestRunner",RR);j.add("TestSimulateUserData",OR);j.add("PlayableDirector",Js);j.add("SignalReceiver",$a);j.add("AnimationTrackHandler",ng);j.add("AudioTrackHandler",zh);j.add("MarkerTrackHandler",Gv);j.add("SignalTrackHandler",sg);j.add("ControlTrackHandler",qv);j.add("TransformGizmo",Od);j.add("BaseUIComponent",eo);j.add("UIRootComponent",iy);j.add("Button",hl);j.add("Canvas",ri);j.add("CanvasGroup",fc);j.add("EventSystem",Rn);j.add("Graphic",Fr);j.add("MaskableGraphic",ny);j.add("Image",Jf);j.add("RawImage",Qv);j.add("InputField",ps);j.add("VerticalLayoutGroup",dR);j.add("HorizontalLayoutGroup",uR);j.add("GridLayoutGroup",fR);j.add("Outline",Nf);j.add("ObjectRaycaster",ws);j.add("GraphicRaycaster",pv);j.add("SpatialGrabRaycaster",sc);j.add("RectTransform",Mi);j.add("SpatialHtml",vy);j.add("Text",gn);j.add("EnvironmentScene",Yv);j.add("LookAt",Nr);j.add("OpenURL",ep);j.add("VideoPlayer",ai);j.add("Voip",wc);j.add("ClickThrough",Zv);j.add("CursorFollow",Ic);j.add("HoverAnimation",Qr);j.add("ScrollFollow",dl);j.add("ViewBox",mc);j.add("Avatar",uc);j.add("XRControllerFollow",ul);j.add("XRControllerModel",Gr);j.add("XRControllerMovement",Cs);j.add("TeleportTarget",Ov);j.add("WebARCameraBackground",Cy);j.add("WebARSessionRoot",No);j.add("WebXR",pt);j.add("AvatarMarker",ni);j.add("WebXRImageTracking",Py);j.add("WebXRPlaneTracking",ml);j.add("XRRig",Jv);j.add("XRFlag",Ci);j.add("PlayerSync",Rc);j.add("PlayerState",oi);j.add("PresentationMode",oF);const qu=ii,rF=k("debugtypestore");rF&&console.log(j);function aF(s,t){const i=G2(s,t);return i!==void 0?i:null}const lF=new H2,i_=Symbol("deserialize-queue");async function cF(s,t,e,i=null,n){if(!e){console.debug("Can not create component instances: gltf is null");return}const o=[];let r=i;typeof r=="number"&&(r=new Ki(i));const l=t.indexOf("?");t=l===-1?t:t.substring(0,l);const c=new ZP(e.scene);c.gltfId=t,c.context=s,c.gltf=e,c.nodeToObject=n==null?void 0:n.nodeToObjectMap,c.implementationInformation=lF;let h=s[i_];if(h||(h=s[i_]=[]),e.scenes)for(const d of e.scenes)await P0(c,d,h,o,0);if(e.children)for(const d of e.children)await P0(c,d,h,o,0);s.new_scripts_pre_setup_callbacks.push(()=>{const d=s[i_];if(d){for(const u of d)hF(u,c);d.length=0}if(r){const u={},f=[];C0(e,r,u,f);for(const p of e.scenes)C0(p,r,u,f);for(const p of f)p.resolveGuids(u)}})}const S0=Symbol("original-component-name"),eh=new Map;function C0(s,t,e,i){if(t===null||!s)return;const n=s.guid,o=s.guid;o!=null&&o.length&&(eh.has(o)||(qu&&console.log('Creating InstanceIdProvider with key "'+o+'" for object '+s.name),eh.set(o,new Ki(o))));const r=o&&eh.get(o)||t;if(s.guid=r.generateUUID(),n&&n!=="invalid"&&(e[n]=s.guid),s&&s.userData&&s.userData.components)for(const l of s.userData.components){if(l===null)continue;const c=l.guid;c?eh.has(c)||(qu&&console.log('Creating InstanceIdProvider with key "'+c+'" for component '+l[S0]),eh.set(c,new Ki(c))):qu&&console.warn("Can not create IdProvider: component "+l[S0]+" has no guid",l.guid);const h=eh.get(c)||t,d=l.guid;l.guid=h.generateUUID(),d&&d!=="invalid"&&(e[d]=l.guid),l.resolveGuids&&i.push(l)}if(s.children)for(const l of s.children)C0(l,t,e,i)}const Zd=[];async function P0(s,t,e,i,n){var r,l,c,h,d;if(!t)return;const o=t.userData;if(o){const u=o.builtin_components;if(u&&u.length>0)for(const f of u)try{if(f===null)continue;const p=j.get(f.name);if(p!=null){const b=new p;b.sourceId=s.gltfId,ed(b,f,s.implementationInformation),b.context=s.context,"guid"in f&&(b[Kp]=f.guid),b[S0]=f.name,Lh(t,b,!1),e.push({instance:b,compData:f,obj:t}),b.isCamera&&s.context&&s.context.mainCamera===null&&b.tag==="MainCamera"&&s.context.setCurrentCamera(b),((c=(l=(r=s.context)==null?void 0:r.physics)==null?void 0:l.engine)==null?void 0:c.isInitialized)===!1&&(b.isCollider||b.isRigidbody)&&((d=(h=s.context)==null?void 0:h.physics.engine)==null||d.initialize())}else qu&&console.debug("unknown component: "+f.name),Zd.includes(f.name)||Zd.push(f.name)}catch(p){console.error(f.name+" - "+p.message,p)}}if(t.children)for(const u of t.children)await P0(s,u,e,i,n+1);if(Zd.length>0&&n===0){const u=Zd.join(", ");console.warn(`Unknown components in scene: ${u}`),Zd.length=0,_s()&&at(`<strong>Unknown components in scene</strong>:

${u}

This could mean you forgot to add a npmdef to your ExportInfo
<a href="https://engine.needle.tools/docs/project_structure.html#creating-and-installing-a-npmdef" target="_blank">documentation</a>`,Ti.Warn)}}function hF(s,t){const{instance:e,compData:i,obj:n}=s;t.object=n,t.target=e,N_(e,i,t),qu&&console.debug("add "+i.name,i,e)}class DR{createBuiltinComponents(t,e,i,n,o){return cF(t,e,i,n,o)}writeBuiltinComponentData(t,e){return aF(t,e)}parseSync(t,e,i,n){return fF(t,e,i,n)}loadSync(t,e,i,n,o){return BR(t,e,i,n,o)}}j1(DR);const jR=k("printGltf")||k("printgltf"),dF=k("debugfileformat");async function FR(s,t,e){const i=await lD(s,{useExtension:!0})||"unknown";dF&&console.debug(`Determined file type: '${i}' for url '${s}'`,{registeredModelLoaderCallbacks:uh});for(const n of uh){const{callback:o}=n,r=o({context:t,url:s,mimetype:i});if(r instanceof Promise&&await r,r)return console.debug(`Using custom loader (${n.name||"unnamed"}) for ${i} at '${s}'`),r}switch(i){case"unsupported":return null;default:case"unknown":{console.warn(`Unknown file type (${i}). Needle Engine will fallback to the GLTFLoader - To support more model formats please create a Needle loader plugin.
Use import { NeedleEngineModelLoader } from "@needle-tools/engine" namespace to register your loader.`,s);const n=new Wr;return await n0(n,t,s,e),n}case"model/fbx":case"model/vnd.autodesk.fbx":return new h1;case"model/obj":return new j0;case"model/vnd.usdz+zip":case"model/vnd.usd+zip":case"model/vnd.usda+zip":return console.warn(i.toUpperCase()+" files are not supported."),null;case"model/gltf+json":case"model/gltf-binary":case"model/vrm":{const n=new Wr;return await n0(n,t,s,e),n}}}function uF(s,t){return BR((t==null?void 0:t.context)||de.Current,s,s,(t==null?void 0:t.seed)||null,t==null?void 0:t.onprogress)}async function fF(s,t,e,i){typeof e!="string"&&(console.warn("Parse gltf binary without path, this might lead to errors in resolving extensions. Please provide the source path of the gltf/glb file",e,typeof e),e=""),jR&&console.log("Parse glTF",e);const n=await FR(e,s,e);if(!n)return;const{componentsExtension:o}=UR(n,s);if(n instanceof j0){typeof t!="string"&&(t=new TextDecoder().decode(t));const l=n.parse(t);return await Xu(n,s,e,l,i,o)}if(!(n instanceof Wr)){if(n.parse===void 0){console.error("Loader does not support parse");return}const l=n.parse(t,e);return await Xu(n,s,e,l,i,o)}return new Promise((l,c)=>{try{let h=e.split("?")[0].trimEnd();const d=h.split("/");d.length>0&&d[d.length-1]!==""&&d.pop(),h=d.join("/"),h.endsWith("/")||(h+="/"),n.resourcePath=h,n.parse(t,"",async u=>{const f=await Xu(n,s,e,u,i,o);l(f)},u=>{console.error('Loading asset at "'+e+`" failed
`,u),l(void 0)})}catch(h){console.error(h),c(h)}})}async function BR(s,t,e,i,n){mF(t);const o=await FR(t,s,e);if(!o)return;const{componentsExtension:r}=UR(o,s);if(!(o instanceof Wr)){const l=await o.loadAsync(t,n);return await Xu(o,s,t,l,i,r)}return new Promise((l,c)=>{try{o.load(t,async h=>{const d=await Xu(o,s,e,h,i,r);l(d)},h=>{n==null||n.call(o,h)},h=>{console.error('Loading asset at "'+t+`" failed
`,h),l(void 0)})}catch(h){console.error(h),c(h)}})}function UR(s,t){const e=BT(s);return s instanceof Wr&&dv(s,t),{componentsExtension:e}}async function Xu(s,t,e,i,n,o){if(jR&&console.warn("Loaded",e,i),i==null)return console.error(`Loaded model is null '${e}' - please make sure the loader is registered correctly`),{scene:new z,animations:[],scenes:[]};if(typeof i!="object")return console.error(`Loaded model is not an object '${e}' - please make sure the loader is registered correctly`),{scene:new z,animations:[],scenes:[]};if(i instanceof z)i={scene:i,animations:i.animations,scenes:[i]};else if(i instanceof Gs){const r=new ti({color:new Se(14540253)}),l=new le(i,r);i={scene:l,animations:[],scenes:[l]}}else Array.isArray(i.scenes)===!1&&console.error(`[Needle Engine] The loaded model object does not have a scenes property '${e}' - please make sure the loader is registered correctly and three.js is not imported multiple times.`);return e.includes("?")&&(e=e.split("?")[0]),gF(s,i),WL(i)&&(PD(e,i,t),await Ko().createBuiltinComponents(t,e,i,n,o||void 0)),await pF(i.scene,t,t.mainCamera),i}async function pF(s,t,e){e||(e=t.mainCamera);try{e?await t.renderer.compileAsync(s,e,t.scene).catch(i=>{console.warn(i.message)}):m2(s,t)}catch(i){console.warn((i==null?void 0:i.message)||i)}}function mF(s){if(new URL(s,window.location.href).href.startsWith("file://")){const e=`Hi - it looks like you are trying to load a local file which will not work. You need to use a webserver to serve your files.
Please refer to the documentation on <a href="https://fwd.needle.tools/needle-engine/docs/local-server">https://docs.needle.tools</a> or ask for help in our <a href="https://discord.needle.tools">discord community</a>`;at(e),console.warn(e)}}function gF(s,t){var e;if("scenes"in t){for(const i of t.scenes)if(i&&!((e=i.animations)!=null&&e.length))for(const n of t.animations)i.animations.includes(n)||i.animations.push(n)}if(s instanceof h1||s instanceof j0){let i=t;i instanceof z||(i=t.scene||t.scenes.find(n=>n)),i.traverse(n=>{const o=n;o!=null&&o.isMesh&&R1(o,o.material)})}}const Jd=k("debugoverlay"),NR="ar",yF="quit-ar";class bF{constructor(){a(this,"arContainer",null);a(this,"currentSession",null);a(this,"_createdAROnlyElements",[]);a(this,"_reparentedObjects",[]);a(this,"contentElement",null);a(this,"originalDomOverlayParent",null);a(this,"requestEndAR",()=>{this.onRequestedEndAR()})}get ARContainer(){return this.arContainer}onBegin(t,e,i){var n;if(this.currentSession=i,this.arContainer=e,Q.isMozillaXR()||Q.isNeedleAppClip()){const o=t.domElement.children;for(let r=0;r<(o==null?void 0:o.length);r++){const l=o[r];if(!l||l===this.arContainer)return;this._reparentedObjects.push({el:l,previousParent:l.parentElement}),(n=this.arContainer)==null||n.appendChild(l)}e?(this.originalDomOverlayParent=e.parentNode,this.originalDomOverlayParent&&(console.log("Reparent DOM Overlay to body",e,e.style.display),e.style.display="",e.style.visibility="",document.body.appendChild(e))):console.warn("WebXRViewer: No DOM Overlay found")}this.ensureQuitARButton(this.arContainer)}onEnd(t){var e;for(const i of this._createdAROnlyElements)i.remove&&i.remove();for(const i of this._reparentedObjects){const n=i.el;(e=i.previousParent)==null||e.appendChild(n)}this._reparentedObjects.length=0,Q.isMozillaXR()&&setTimeout(()=>{var r;const i=t.renderer.domElement;i&&((r=t.domElement.shadowRoot)==null||r.prepend(i));const n=document.querySelectorAll("*");for(var o=0;o<n.length;o++){const l=n[o];l&&l._displayChanged!==void 0&&l._displayWas!==void 0&&(l.style.display=l._displayWas)}},10)}createOverlayContainer(t){if(this.contentElement)return this.contentElement;Jd&&console.log("Setup overlay container");const e=t.shadowRoot.querySelector(".content");this.contentElement=e;const i=t.shadowRoot.querySelector(".overlay-content");return i&&e.appendChild(i),Jd&&!Q.isMobileDevice()&&this.ensureQuitARButton(e),e}onRequestedEndAR(){this.currentSession&&(this.currentSession.end(),this.currentSession=null)}ensureQuitARButton(t){const e=document.createElement("slot");e.style.display="contents",e.style.padding="10px",e.setAttribute("name","quit-ar"),this.appendElement(e,t),this._createdAROnlyElements.push(e),e.style.pointerEvents="auto",Q.isNeedleAppClip()&&(e.style.display="none");const i=document.querySelector(`.${yF}`);if(i){i.addEventListener("click",this.requestEndAR),Jd&&i.addEventListener("click",()=>console.log("Clicked quit-ar button"));return}e.addEventListener("click",this.requestEndAR),Jd&&e.addEventListener("click",()=>console.log("Clicked fallback close button"));const n=document.createElement("div");n.style.cssText=`
            position: fixed;
            top: 0;
            right: 0;
            z-index: 600;
            pointer-events: all;
        `,this.appendElement(n,e);var o=document.createElementNS("http://www.w3.org/2000/svg","svg");o.classList.add("quit-ar-button"),o.setAttribute("width","40px"),o.setAttribute("height","40px"),o.style.cssText=`
            background: rgba(255, 255, 255, .4);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,.3);
            outline: 1px solid rgba(255, 255, 255, .6);
            display: flex;
            justify-content: center;
            align-items: center;
        `,n.appendChild(o);var r=document.createElementNS("http://www.w3.org/2000/svg","path");r.setAttribute("d","M 12,12 L 28,28 M 28,12 12,28"),r.setAttribute("stroke","#000000"),r.setAttribute("stroke-width","2px"),r.style.cssText=`
            /**filter: drop-shadow(0 0px 1.2px rgba(0,0,0,.7));**/
        `,o.appendChild(r),Jd&&console.log("Created fallback close button",o,t)}appendElement(t,e){return e.shadowRoot?e.shadowRoot.appendChild(t):e.appendChild(t)}}const Bl=k("debugloading"),eu=k("debugloadingrendering");k("debuglicense");class eB{constructor(){a(this,"className");a(this,"additionalClasses")}}let tu=0,LC;function zR(s){Bl&&console.log(s.progress.loaded.toFixed(0)+"/"+s.progress.total.toFixed(0),s);const t=s.count,e=s.progress.total;e===0||e===void 0?(LC!==s.name&&(tu=0),LC=s.name,tu+=(1-tu)*.001,Bl&&qe("Loading "+s.name+" did not report total size")):tu=s.progress.loaded/e;const i=s.index/t+tu/t;return ee.clamp01(i)}const gg=class{constructor(t,e){a(this,"loadingProgress",0);a(this,"_element");a(this,"_progress",0);a(this,"_allowCustomLoadingElement",!0);a(this,"_loadingElement");a(this,"_loadingTextContainer",null);a(this,"_loadingBar",null);a(this,"_loadingBarFinishedColor",null);a(this,"_messageContainer",null);a(this,"_loadingElementOptions");a(this,"_progressLoop");this._element=t,this._loadingElementOptions=e}async onLoadingBegin(t){const e=this._element.shadowRoot||this._element;if(Bl&&console.warn("Begin Loading"),!this._loadingElement){for(let i=0;i<e.children.length;i++){const n=e.children[i];if(n.classList.contains(gg.LoadingContainerClassName)){if(!this._allowCustomLoadingElement){Bl&&console.warn("Remove custom loading container"),e.removeChild(n);continue}this._loadingElement=this.createLoadingElement(n)}}this._loadingElement||(this._loadingElement=this.createLoadingElement())}this._progress=0,this.loadingProgress=0,this._loadingElement.style.display="flex",e.appendChild(this._loadingElement),this.smoothProgressLoop(),this.setMessage(t??"")}onLoadingUpdate(t,e){var n;if(!((n=this._loadingElement)!=null&&n.parentNode))return;let i=0;typeof t=="number"?i=t:("index"in t&&(i=zR(t)),!e&&"name"in t&&this.setMessage("loading "+t.name)),this.loadingProgress=i,e&&this.setMessage(e),this.updateDisplay()}onLoadingFinished(){Bl&&console.warn("Finished Loading"),eu||(this.loadingProgress=1,this.onDoneLoading())}setMessage(t){this._messageContainer&&(this._messageContainer.innerText=t)}smoothProgressLoop(){if(this._progressLoop)return;let t=1/12;eu&&(t=1/500,typeof eu=="number"&&(t*=eu)),this._progressLoop=setInterval(()=>{this.loadingProgress>=.95&&!eu&&(t=.9),this._progress=ee.lerp(this._progress,this.loadingProgress,t*this.loadingProgress),this.updateDisplay()},t)}onDoneLoading(){if(this._loadingElement){Bl&&console.log("Hiding loading element");const t=this._loadingElement;t.animate([{opacity:1},{opacity:0}],{duration:200,easing:"ease-in-out"}).addEventListener("finish",()=>{t.style.display="none",t.remove()})}this._progressLoop&&clearInterval(this._progressLoop),this._progressLoop=null}updateDisplay(){const t=this._progress,e=(t*100).toFixed(0)+"%";this._loadingBar&&(this._loadingBar.style.width=t*100+"%",t>=1&&this._loadingBarFinishedColor&&(this._loadingBar.style.background=this._loadingBarFinishedColor)),this._loadingTextContainer&&(this._loadingTextContainer.textContent=e)}createLoadingElement(t){var b,x;Bl&&!t&&console.log("Creating loading element"),this._loadingElement=t||document.createElement("div");let e=this._element.getAttribute("loading-style");(!e||e==="auto")&&(window.matchMedia("(prefers-color-scheme: dark)").matches?e="dark":e="light");const i=Dr();if(!t){this._loadingElement.style.position="absolute",this._loadingElement.style.width="100%",this._loadingElement.style.height="100%",this._loadingElement.style.left="0",this._loadingElement.style.top="0",this._loadingElement.style.overflow="hidden";const v=this._element.getAttribute("loading-background");v?this._loadingElement.style.background=v:this._loadingElement.style.backgroundColor="transparent",this._loadingElement.style.display="flex",this._loadingElement.style.alignItems="center",this._loadingElement.style.justifyContent="center",this._loadingElement.style.zIndex="0",this._loadingElement.style.flexDirection="column",this._loadingElement.style.pointerEvents="none",this._loadingElement.style.color="white",this._loadingElement.style.fontFamily='system-ui, Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"',this._loadingElement.style.fontSize="1rem",e==="light"?this._loadingElement.style.color="rgba(0,0,0,.6)":this._loadingElement.style.color="rgba(255,255,255,.3)"}const n=((b=this._loadingElementOptions)==null?void 0:b.className)??gg.LoadingContainerClassName;if(this._loadingElement.classList.add(n),(x=this._loadingElementOptions)!=null&&x.additionalClasses)for(const v of this._loadingElementOptions.additionalClasses)this._loadingElement.classList.add(v);const o=document.createElement("div");o.style.cssText=`
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            pointer-events: none;
        `,this._loadingElement.appendChild(o);const r=this._element.getAttribute("poster");if(r!==null&&r!=="0"){const v=document.createElement("div"),S=r!=null&&r.length?"0px":"50px";v.style.cssText=`
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            right: 0;
            z-index: -1;
            overflow: hidden;

            margin: -${S};
            background: url('${r!=null&&r.length?r:"/include/poster.webp"}') center center no-repeat;
            background-size: cover;
            filter: blur(${S});
        `,this._loadingElement.appendChild(v)}const l=document.createElement("img"),c="80%",h="15%",d=".2s";if(l.style.userSelect="none",l.style.objectFit="contain",l.style.transform="translateY(30px)",l.style.opacity="0.0000001",l.style.transition=`transform 1s ease-out ${d}, opacity .3s ease-in-out ${d}`,l.src=Zh,i&&this._element){const v=this._element.getAttribute("logo-src");v&&(l.src=v,setTimeout(()=>{l.style.opacity="1",l.style.transform="translateY(0px)"},1))}l.style.width=`${c}`,l.style.height=`min(1000px, max(${h}, 50px))`,o.appendChild(l);const u=document.createElement("div");u.style.cssText=`
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        opacity: 0;
        transition: opacity 1s ease-in-out 4s;
        `,setTimeout(()=>{u.style.opacity="1"},1),this._loadingElement.appendChild(u);const f=document.createElement("div"),p=100;return f.style.display="flex",f.style.width=p+"%",f.style.height="5px",f.style.position="absolute",f.style.left="0",f.style.top="0px",f.style.opacity="0",f.style.transition="opacity 1s ease-in-out",f.style.backgroundColor="rgba(240,240,240,.5)",setTimeout(()=>{f.style.opacity="1"},1),this._loadingElement.appendChild(f),this._loadingBar=document.createElement("div"),f.appendChild(this._loadingBar),this._loadingBar.style.backgroundAttachment="fixed",this._loadingBar.style.background="#c4c4c4ab",this._loadingBarFinishedColor="#ddddddab",this._loadingBar.style.width="0%",this._loadingBar.style.height="100%",this._loadingElement}};let mm=gg;a(mm,"LoadingContainerClassName","loading");j1(DR);const st=k("debugwebcomponent"),DC="needle-engine",$R="vr",VR="desktop",_F=[NR,$R,VR],iu="ar-session-active",nu="desktop-session-active",vF=["src","hash","camera-controls","dracoDecoderPath","dracoDecoderType","ktx2DecoderPath","public-key","version","tone-mapping","tone-mapping-exposure","background-blurriness","background-color","environment-intensity","focus-rect","loadstart","progress","loadfinished"];class WR extends HTMLElement{constructor(){super();a(this,"_context");a(this,"_overlay_ar");a(this,"_loadingProgress01",0);a(this,"_loadingView");a(this,"_previousSrc",null);a(this,"_didFullyLoad",!1);a(this,"_loadId",0);a(this,"_abortController",null);a(this,"_lastSourceFiles",null);a(this,"_createContextPromise",null);a(this,"onXRSessionStarted",()=>{var i;const e=this.context.xrSessionMode;e==="immersive-ar"?this.onEnterAR(this.context.xrSession):e==="immersive-vr"&&this.onEnterVR(this.context.xrSession),(i=this.context.xrSession)==null||i.addEventListener("end",()=>{this.dispatchEvent(new CustomEvent("xr-session-ended",{detail:{session:this.context.xrSession,context:this._context,sessionMode:e}})),e==="immersive-ar"?this.onExitAR(this.context.xrSession):e==="immersive-vr"&&this.onExitVR(this.context.xrSession)})});a(this,"onReady",()=>{var e;return(e=this._loadingView)==null?void 0:e.onLoadingFinished()});a(this,"onError",()=>{var e;return(e=this._loadingView)==null?void 0:e.setMessage("Loading failed!")});a(this,"_previouslyRegisteredMap",new Map);this._overlay_ar=new bF,this.addEventListener("ready",this.onReady),gT(),this.attachShadow({mode:"open"});const e=document.createElement("template");e.innerHTML=`<style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap');

    :host {
        position: absolute;
        display: block;
        width: max(600px, 100%);
        height: max(300px, 100%);
        touch-action: none;

        -webkit-tap-highlight-color: transparent;
    }

    @media (max-width: 600px) {
        :host {
            width: 100%;
        }
    }
    @media (max-height: 300px) {
        :host {
            height: 100%;
        }
    }

    :host > div.canvas-wrapper {
        width: 100%;
        height: 100%;
    }

    :host canvas {   
        position: absolute;
        user-select: none;
        -webkit-user-select: none;

        /** allow touch panning but no pinch zoom **/
        /** but this doesnt work yet: 
         * touch-action: pan-x, pan-y;
         **/
        
        -webkit-touch-callout: none;
        -webkit-user-drag: none;
        -webkit-user-modify: none;

        left: 0;
        top: 0;
    }
    :host .content {
        position: absolute;
        top: 0;
        width: 100%;
        height: 100%;
        visibility: visible;
        z-index: 500; /* < must be less than the webxr buttons element */
        pointer-events: none;
    }
    :host .overlay-content {
        position: absolute;
        user-select: auto;
        pointer-events: all;
    }
    :host slot[name="quit-ar"]:hover {
        cursor: pointer;
    }
    :host .quit-ar-button {
        position: absolute;
        // top: env(titlebar-area-y); /** this doesnt work **/
        top: 60px; /** camera access needs a bit more space **/
        right: 20px;
        z-index: 9999;
    }
</style>
<div class="canvas-wrapper"> <!-- this wrapper is necessary for WebXR https://github.com/meta-quest/immersive-web-emulator/issues/55 -->
    <canvas></canvas>
</div>
<div class="content">
    <slot class="overlay-content" style="display: contents;"></slot>
</div>
`,this.shadowRoot&&this.shadowRoot.appendChild(e.content.cloneNode(!0)),this._context=new de({domElement:this}),this.addEventListener("error",this.onError)}static get observedAttributes(){return vF}get loadingProgress01(){return this._loadingProgress01}get loadingFinished(){return this.loadingProgress01>.999}get cameraControls(){const e=this.getAttribute("camera-controls");return e==null?null:!(e===null||e==="False"||e==="false"||e==="0"||e==="none")}set cameraControls(e){e===null?this.removeAttribute("camera-controls"):this.setAttribute("camera-controls",e?"true":"false")}getContext(){return new Promise((e,i)=>{if(this._context&&this.loadingFinished)e(this._context);else{const n=()=>{this.removeEventListener("loadfinished",n),this._context&&this.loadingFinished&&e(this._context)};this.addEventListener("loadfinished",n)}})}get context(){return this._context}async connectedCallback(){if(st&&console.log("<needle-engine> connected"),this.setPublicKey(),this.setVersion(),(this.getAttribute("tabindex")===null||this.getAttribute("tabindex")===void 0)&&this.setAttribute("tabindex","0"),this.addEventListener("xr-session-started",this.onXRSessionStarted),this.onSetupDesktop(),!this.getAttribute("src")){const i=globalThis["needle:codegen_files"];st&&console.log('src is null, trying to load from globalThis["needle:codegen_files"]',i),i&&(st&&console.log('globalThis["needle:codegen_files"]',i),this.setAttribute("src",i))}st&&console.log("src",this.getAttribute("src"));const e=this._loadId;setTimeout(()=>{this.isConnected!==!1&&e===this._loadId&&this.onLoad()},1)}disconnectedCallback(){var n;this.removeEventListener("xr-session-started",this.onXRSessionStarted),this._didFullyLoad=!1;const e=this.getAttribute("keep-alive"),i=e==null||(e==null?void 0:e.length)>0&&e!=="true"&&e!=="1";st&&console.warn('<needle-engine> disconnected, keep-alive: "'+e+'"',typeof e,"Dispose=",i),i?(st&&console.warn("<needle-engine> dispose"),(n=this._context)==null||n.dispose(),this._context=null,this._lastSourceFiles=null,this._loadId+=1):st&&console.warn("<needle-engine> is not disposed because keep-alive is set")}connectedMoveCallback(){}attributeChangedCallback(e,i,n){switch(st&&console.log("attributeChangedCallback",e,i,n),e){case"src":st&&console.warn(`<needle-engine src>
changed from "`,i,'" to "',n,'"'),this.onLoad();break;case"hash":this._context&&(this._context.hash=n);break;case"loadstart":case"progress":case"loadfinished":typeof n=="string"&&n.length>0&&(st&&console.log(e+" attribute changed",n),this.registerEventFromAttribute(e,n));break;case"dracoDecoderPath":st&&console.log("dracoDecoderPath",n),SS(n);break;case"dracoDecoderType":n==="wasm"||n==="js"?(st&&console.log("dracoDecoderType",n),CS(n)):console.error("Invalid dracoDecoderType",n,"expected js or wasm");break;case"ktx2DecoderPath":st&&console.log("ktx2DecoderPath",n),PS(n);break;case"tonemapping":case"tone-mapping":case"tone-mapping-exposure":case"background-blurriness":case"background-color":case"environment-intensity":{this.applyAttributes();break}case"public-key":{n!=Eh&&this.setPublicKey();break}case"version":{n!=Gn&&this.setVersion();break}case"focus-rect":{const o=this.getAttribute("focus-rect");if(o&&this._context)if(o===null)this._context.setCameraFocusRect(null);else if(typeof o=="string"&&o.length>0){const r=document.querySelector(o);this._context.setCameraFocusRect(r instanceof HTMLElement?r:null)}else o instanceof HTMLElement&&this._context.setCameraFocusRect(o)}break}}get toneMapping(){return this.getAttribute("tonemapping")||this.getAttribute("tone-mapping")}async onLoad(){var x,v;if(!this.isConnected)return;if(this._context||(st&&console.warn("Create new context"),this._context=new de({domElement:this})),!this._context){console.error("Needle Engine: Context not initialized");return}const e=this.getSourceFiles();if(!this.checkIfSourceHasChanged(e,this._lastSourceFiles))return;this._abortController&&(st&&console.warn("Abort previous loading process"),this._abortController.abort(),this._abortController=null),this._lastSourceFiles=e;const i=++this._loadId;if((e==null||e.length<=0)&&(st&&console.warn("Clear scene",e),this._context.clear(),i!==this._loadId))return;const n=this.getAttribute("alias");this.classList.add("loading");const o=jr();this.ensureLoadStartIsRegistered();let r=this.dispatchEvent(new CustomEvent("loadstart",{detail:{context:this._context,alias:n},cancelable:!0}));if(o){const S=this.getAttribute("hide-loading-overlay");S!=null&&S!=="0"&&(r=!1)}r===!1&&!o&&(X()||(r=!0),console.warn("Needle Engine: You need a commercial license to override the default loading view. Visit https://needle.tools/pricing"),X()&&qe('You need a <a target="_blank" href="https://needle.tools/pricing">commercial license</a> to override the default loading view. This will not work in production.')),!this._loadingView&&r&&(this._loadingView=new mm(this)),r&&(this._didFullyLoad!==!0?(x=this._loadingView)==null||x.onLoadingBegin("begin load"):setTimeout(()=>{this._loadingView&&this._loadingProgress01<.3&&this._loadId===i&&this._loadingView.onLoadingBegin("begin load")},300)),st&&console.warn(`--------------
Needle Engine: Begin loading `+i+`
`,e),this.onBeforeBeginLoading();const l=[],c={context:this._context,name:"",progress:{},index:0,count:e.length,totalProgress01:this._loadingProgress01},h=new CustomEvent("progress",{detail:c}),d=new Array,u=new AbortController;this._abortController=u;const f={files:e,abortSignal:u.signal,onLoadingProgress:S=>{var P;if(st&&console.debug("Loading progress: ",S),u.signal.aborted)return;const C=S.index;!d[C]&&S.name&&(d[C]=xF(S.name)),S.name=d[C],r&&((P=this._loadingView)==null||P.onLoadingUpdate(S)),c.name=S.name,c.progress=S.progress,this._loadingProgress01=zR(S),c.totalProgress01=this._loadingProgress01,this.dispatchEvent(h)},onLoadingFinished:(S,C,P)=>{st&&console.debug(`Finished loading "${C}" (aborted? ${u.signal.aborted})`),!u.signal.aborted&&P&&l.push({src:C,file:P})}};wF(this);const p=this.getAttribute("hash");p!=null&&(this._context.hash=p),this._context.alias=n,this._createContextPromise=this._context.create(f);const b=await this._createContextPromise;if(this.applyAttributes(),st&&console.warn(`--------------
Needle Engine: finished loading `+i+`
`,e,`Aborted? ${u.signal.aborted}`),u.signal.aborted){console.log("Loading finished but aborted...");return}if(this._loadId!==i){console.log("Load id changed during loading process");return}this._loadingProgress01=1,r&&b&&((v=this._loadingView)==null||v.onLoadingUpdate(1,"creating scene")),this._didFullyLoad=!0,this.classList.remove("loading"),this.classList.add("loading-finished"),this.dispatchEvent(new CustomEvent("loadfinished",{detail:{context:this._context,src:n,loadedFiles:l}}))}applyAttributes(){var o,r;if((o=this._context)!=null&&o.renderer){const l=mT(this.toneMapping);l!==void 0&&(this._context.renderer.toneMapping=l);const c=this.getAttribute("tone-mapping-exposure");if(c!=null){const h=parseFloat(c);isNaN(h)||(this._context.renderer.toneMappingExposure=h)}}const e=this.getAttribute("background-blurriness");if(e!=null){const l=parseFloat(e);!isNaN(l)&&this._context&&(this._context.scene.backgroundBlurriness=l)}const i=this.getAttribute("environment-intensity");if(i!=null&&this._context){const l=parseFloat(i);!isNaN(l)&&this._context&&(this._context.scene.environmentIntensity=l)}const n=this.getAttribute("background-color");if((r=this._context)!=null&&r.renderer)if(typeof n=="string"&&n.length>0){const l=Te.fromColorRepresentation(n);st&&console.debug("<needle-engine> background-color changed, str:",n,"‚Üí",l),this._context.renderer.setClearColor(l,l.alpha),this.context.scene.background=null}else this.getAttribute("background-image")&&this.setAttribute("background-image",this.getAttribute("background-image"))}getSourceFiles(){const e=this.getAttribute("src");if(!e)return[];let i;Array.isArray(e)?i=e:e.startsWith("[")&&e.endsWith("]")?i=JSON.parse(e):e.includes(",")?i=e.split(","):i=[e];for(let n=i.length-1;n>=0;n--){const o=i[n];(o==="null"||o==="undefined"||(o==null?void 0:o.length)<=0)&&i.splice(n,1)}return i}checkIfSourceHasChanged(e,i){if((e==null?void 0:e.length)!==(i==null?void 0:i.length)||e==null&&i!==null||e!==null&&i==null)return!0;if(e!==null&&i!==null){for(let n=0;n<(e==null?void 0:e.length);n++)if(e[n]!==i[n])return!0}return!1}ensureLoadStartIsRegistered(){const e=this.getAttribute("loadstart");e&&this.registerEventFromAttribute("loadstart",e)}registerEventFromAttribute(e,i){const n=this._previouslyRegisteredMap.get(e);if(n&&(this._previouslyRegisteredMap.delete(e),this.removeEventListener(e,n)),typeof i=="string"&&i.length>0)try{const o=(0,eval)(i);typeof o=="function"&&(this._previouslyRegisteredMap.set(e,o),this.addEventListener(e,r=>o==null?void 0:o.call(globalThis,this._context,r)))}catch(o){console.error("Error registering event "+e+'="'+i+`" failed with the following error:
`,o)}}setPublicKey(){Eh.length>0&&this.setAttribute("public-key",Eh)}setVersion(){Gn.length>0&&this.setAttribute("version",Gn)}getAROverlayContainer(){return this._overlay_ar.createOverlayContainer(this)}getVROverlayContainer(){for(let e=0;e<this.children.length;e++){const i=this.children[e];if(i.classList.contains("vr"))return i}return null}onEnterAR(e){var n;this.onSetupAR();const i=this.getAROverlayContainer();this._overlay_ar.onBegin(this._context,i,e),this.dispatchEvent(new CustomEvent("enter-ar",{detail:{session:e,context:this._context,htmlContainer:(n=this._overlay_ar)==null?void 0:n.ARContainer}}))}onExitAR(e){var i;this._overlay_ar.onEnd(this._context),this.onSetupDesktop(),this.dispatchEvent(new CustomEvent("exit-ar",{detail:{session:e,context:this._context,htmlContainer:(i=this._overlay_ar)==null?void 0:i.ARContainer}}))}onEnterVR(e){this.onSetupVR(),this.dispatchEvent(new CustomEvent("enter-vr",{detail:{session:e,context:this._context}}))}onExitVR(e){this.onSetupDesktop(),this.dispatchEvent(new CustomEvent("exit-vr",{detail:{session:e,context:this._context}}))}onSetupAR(){this.classList.add(iu),this.classList.remove(nu);const e=this.getAROverlayContainer();st&&console.warn("onSetupAR:",e),e&&(e.classList.add(iu),e.classList.remove(nu)),this.foreachHtmlElement(i=>this.setupElementsForMode(i,NR))}onSetupVR(){this.classList.remove(iu),this.classList.remove(nu),this.foreachHtmlElement(e=>this.setupElementsForMode(e,$R))}onSetupDesktop(){this.classList.remove(iu),this.classList.add(nu);const e=this.getAROverlayContainer();e&&(e.classList.remove(iu),e.classList.add(nu)),this.foreachHtmlElement(i=>this.setupElementsForMode(i,VR))}setupElementsForMode(e,i,n=null){var r,l;if(e===((l=(r=this._context)==null?void 0:r.renderer)==null?void 0:l.domElement)||e.id==="VRButton"||e.id==="ARButton")return;if(e.classList.contains(i))e.style.visibility="visible",e.style.display==="none"&&(e.style.display="block");else for(const c of _F)e.classList.contains(c)&&(e.style.visibility="hidden",e.style.display="none")}foreachHtmlElement(e){for(let i=0;i<this.children.length;i++){const n=this.children[i];n.style&&e(n)}}onBeforeBeginLoading(){const e=this.getAttribute("dracoDecoderPath");e&&(st&&console.log("using custom draco decoder path",e),SS(e));const i=this.getAttribute("dracoDecoderType");i&&(st&&console.log("using custom draco decoder type",i),CS(i));const n=this.getAttribute("ktx2DecoderPath");n&&(st&&console.log("using custom ktx2 decoder path",n),PS(n))}setAttribute(e,i){super.setAttribute(e,i)}getAttribute(e){return super.getAttribute(e)}addEventListener(e,i,n){return super.addEventListener(e,i,n)}}typeof window<"u"&&!window.customElements.get(DC)&&window.customElements.define(DC,WR);function xF(s){if(s.startsWith("blob:"))return"blob";const t=s.split("/");let e=t[t.length-1];const i=e.indexOf("?");i>0&&(e=e.substring(0,i));const n=e.indexOf("=");n>0&&(e=e.substring(n));const o=e.split(".").pop(),l=o?["glb","gltf","usdz","usd","fbx","obj","mtl"].indexOf(o.toLowerCase()):-1;if(o&&l>=0&&(e=e.substring(0,e.length-o.length-1)),e=decodeURIComponent(e),e.length>3){let c="",h=!1;const d=["(",")","[","]","{","}",":",";",",",".","!","?"];for(let u=0;u<e.length;u++){let f=e[u];(f==="_"||f==="-")&&(f=" "),!(f===" "&&c.length<=0||d.includes(f)||(c.length===0&&(f=f.toUpperCase()),h&&f===" "))&&(h&&(f=f.toUpperCase()),h=!1,c+=f,f===" "&&(h=!0))}return X()&&e!==c&&console.debug('Generated display name: "'+e+'" ‚Üí "'+c+'"'),c.trim()}return X()&&console.debug("Loading: use default name",e),e}function wF(s){zg(t=>{var i;const e=s.getAttribute("loading-blur");if(e!==null&&e!=="0"&&t.domElement===s){const n=(i=t.lodsManager.manager)==null?void 0:i.awaitLoading({frames:5,signal:AbortSignal.timeout(1e4),maxPromisesPerObject:1}).catch(l=>{});let o="20px";e.endsWith("px")&&(o=e);const r=170;if(t.scene.background===null){const l=s,c=t.renderer.domElement,h=c.style.filter,d=c.style.overflow;c.style.filter+=`blur(${o})`,l.style.overflow="hidden",n==null||n.then(()=>{const u=c.animate([{filter:"blur(0px)"}],{duration:r,easing:"ease-in"});u.onfinish=()=>{c.style.filter=h,l.style.overflow=d}})}else{const l=document.createElement("div");t.domElement.prepend(l),l.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none",l.style.backdropFilter=`blur(${o})`,n==null||n.then(()=>{const c=l.animate([{backdropFilter:"blur(0px)",opacity:0}],{duration:r,easing:"ease-in"});c.onfinish=()=>{l.remove()}})}}},{once:!0})}const SF=Object.freeze(Object.defineProperty({__proto__:null,NeedleEngineWebComponent:WR},Symbol.toStringTag,{value:"Module"}));function CF(){Xs.registerWaitForInteraction(()=>{const s=Ek.getContext();s.addEventListener("statechange",()=>{setTimeout(()=>{const t=s.state;(t==="suspended"||t==="interrupted")&&s.resume().then(()=>{console.log("AudioContext resumed successfully")}).catch(e=>{console.log("Failed to resume AudioContext: "+e)})},500)})})}setTimeout(CF,1e3);const mt=k("debugphysics"),n_=k("debugcolliderplacement"),s_=k("debugcollisions"),PF=k("showcolliders"),Qp=k("debugraycasts"),wn=Symbol("needle component"),zi=Symbol("physics body"),jC=Symbol("rigidbody");globalThis.true=globalThis.true!==void 0?globalThis.true:!0;mt&&console.log("Use Rapier",!0,globalThis.true);Be.registerCallback(Me.ContextCreationStart,s=>{mt&&console.log("Register rapier physics backend"),s.context.physics.engine=new Al(s.context)});const rf=class{constructor(t){a(this,"debugRenderColliders",!1);a(this,"debugRenderRaycasts",!1);a(this,"context");a(this,"_initializePromise");a(this,"_isInitialized",!1);a(this,"rapierRay");a(this,"raycastVectorsBuffer",new vs(()=>new R,10));a(this,"rapierSphere",null);a(this,"rapierBox",null);a(this,"rapierColliderArray",[]);a(this,"rapierIdentityRotation",{x:0,y:0,z:0,w:1});a(this,"rapierForwardVector",{x:0,y:0,z:1});a(this,"enabled",!1);a(this,"_tempPosition",new R);a(this,"_tempQuaternion",new re);a(this,"_tempScale",new R);a(this,"_tempMatrix",new xe);a(this,"_isUpdatingPhysicsWorld",!1);a(this,"_world");a(this,"_hasCreatedWorld",!1);a(this,"eventQueue");a(this,"collisionHandler");a(this,"objects",[]);a(this,"bodies",[]);a(this,"_meshCache",new Map);a(this,"_gravity",{x:0,y:-9.81,z:0});a(this,"lines");a(this,"_tempCenterPos",new R);a(this,"_tempCenterVec",new R);a(this,"_tempCenterQuaternion",new re);this.context=t}removeBody(t){var i,n,o;if(mt&&console.log("REMOVE BODY",t==null?void 0:t.name,t[zi]),!t)return;this.validate();const e=t[zi];if(t[zi]=null,e&&this.world){const r=this.objects.findIndex(l=>l===t);if(r>=0){const l=this.bodies[r];if(this.bodies.splice(r,1),this.objects.splice(r,1),l instanceof q.RAPIER_PHYSICS.MODULE.Collider){const c=l;(i=this.world)==null||i.removeCollider(c,!0);const h=c.parent();h&&h.numColliders()<=0&&(h[wn]||(n=this.world)==null||n.removeRigidBody(h))}else l instanceof q.RAPIER_PHYSICS.MODULE.RigidBody&&(l.numColliders()<=0?(o=this.world)==null||o.removeRigidBody(l):X()&&(l.did_log_removing||setTimeout(()=>{l.numColliders()>0&&(l.did_log_removing=!0,console.warn("RapierPhysics: removing rigidbody with colliders from the physics world is not possible right now, please remove the colliders first"))},1)))}}}updateBody(t,e,i){if(this.validate(),!!this.enabled&&!(t.destroyed||!t.gameObject)&&!(!e&&!i))if(t.isCollider===!0)console.warn("TODO: implement updating collider position");else{const n=t,o=n[zi];o&&this.syncPhysicsBody(n.gameObject,o,e,i)}}updateProperties(t){if(this.validate(),t.isCollider){const e=t,i=e[zi];i&&(this.internalUpdateColliderProperties(e,i),e.sharedMaterial&&this.updatePhysicsMaterial(e))}else{const e=t,i=this.internal_getRigidbody(e);i&&this.internalUpdateRigidbodyProperties(e,i)}}addForce(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.addForce(e,i):this._isInitialized&&console.warn("Physics Body doesn't exist: can not apply force (does your object with the Rigidbody have a collider?)")}addImpulse(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.applyImpulse(e,i):this._isInitialized&&console.warn("Physics Body doesn't exist: can not apply impulse (does your object with the Rigidbody have a collider?)")}getLinearVelocity(t){this.validate();const e=this.internal_getRigidbody(t);return e?e.linvel():null}getAngularVelocity(t){this.validate();const e=this.internal_getRigidbody(t);return e?e.angvel():null}resetForces(t,e){this.validate();const i=this.internal_getRigidbody(t);i==null||i.resetForces(e)}resetTorques(t,e){this.validate();const i=this.internal_getRigidbody(t);i==null||i.resetTorques(e)}applyImpulse(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.applyImpulse(e,i):this._isInitialized&&console.warn("Rigidbody doesn't exist: can not apply impulse (does your object with the Rigidbody have a collider?)")}wakeup(t){this.validate();const e=this.internal_getRigidbody(t);e?e.wakeUp():this._isInitialized&&console.warn("Rigidbody doesn't exist: can not wake up (does your object with the Rigidbody have a collider?)")}isSleeping(t){this.validate();const e=this.internal_getRigidbody(t);return e==null?void 0:e.isSleeping()}setAngularVelocity(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.setAngvel(e,i):this._isInitialized&&console.warn("Rigidbody doesn't exist: can not set angular velocity (does your object with the Rigidbody have a collider?)")}setLinearVelocity(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.setLinvel(e,i):this._isInitialized&&console.warn("Rigidbody doesn't exist: can not set linear velocity (does your object with the Rigidbody have a collider?)")}get isInitialized(){return this._isInitialized}async initialize(){return this._initializePromise||(this._initializePromise=this.internalInitialization()),this._initializePromise}async internalInitialization(){return k("__nophysics")?(console.warn("Physics are disabled"),!1):(mt&&console.log("Initialize rapier physics engine"),"env"in import.meta&&{}.VITE_NEEDLE_USE_RAPIER==="false"?(mt&&console.log("Rapier disabled"),!1):this._hasCreatedWorld?(console.error("Invalid call to create physics world: world is already created"),!0):(this._hasCreatedWorld=!0,q.RAPIER_PHYSICS.MAYBEMODULE==null&&(mt&&console.trace("Loading rapier physics engine"),await(await q.RAPIER_PHYSICS.load()).init()),mt&&console.log("Physics engine initialized, creating world..."),this._world=new q.RAPIER_PHYSICS.MODULE.World(this._gravity),this.rapierRay=new q.RAPIER_PHYSICS.MODULE.Ray({x:0,y:0,z:0},{x:0,y:0,z:1}),this.enabled=!0,this._isInitialized=!0,mt&&console.log("Physics world created"),!0))}validate(){this._isInitialized||mt&&(this._lastWarnTime=this._lastWarnTime??0,Date.now()-this._lastWarnTime>1e3&&(this._lastWarnTime=Date.now(),console.warn("Physics engine is not initialized")))}raycast(t,e,i){var c;if(!this._isInitialized)return console.log("Physics engine is not initialized"),null;let n=i==null?void 0:i.maxDistance,o=i==null?void 0:i.solid;n===void 0&&(n=1/0),o===void 0&&(o=!0);const r=this.getPhysicsRay(this.rapierRay,t,e);if(!r)return null;(this.debugRenderRaycasts||Qp)&&se.DrawRay(r.origin,r.dir,255,1);const l=(c=this.world)==null?void 0:c.castRay(r,n,o,i==null?void 0:i.queryFilterFlags,i==null?void 0:i.filterGroups,void 0,void 0,h=>{const d=h[wn];return i!=null&&i.filterPredicate?i.filterPredicate(d):(i==null?void 0:i.useIgnoreRaycastLayer)!==!1?!(d!=null&&d.gameObject.layers.isEnabled(2)):!0});if(l){const h=r.pointAt(l.timeOfImpact),d=this.raycastVectorsBuffer.get();return d.set(h.x,h.y,h.z),{point:d,collider:l.collider[wn]}}return null}raycastAndGetNormal(t,e,i){var c;if(!this._isInitialized)return null;let n=i==null?void 0:i.maxDistance,o=i==null?void 0:i.solid;n===void 0&&(n=1/0),o===void 0&&(o=!0);const r=this.getPhysicsRay(this.rapierRay,t,e);if(!r)return null;(this.debugRenderRaycasts||Qp)&&se.DrawRay(r.origin,r.dir,255,1);const l=(c=this.world)==null?void 0:c.castRayAndGetNormal(r,n,o,i==null?void 0:i.queryFilterFlags,i==null?void 0:i.filterGroups,void 0,void 0,h=>{const d=h[wn];return i!=null&&i.filterPredicate?i.filterPredicate(d):(i==null?void 0:i.useIgnoreRaycastLayer)!==!1?!(d!=null&&d.gameObject.layers.isEnabled(2)):!0});if(l){const h=r.pointAt(l.timeOfImpact),d=l.normal,u=this.raycastVectorsBuffer.get(),f=this.raycastVectorsBuffer.get();return u.set(h.x,h.y,h.z),f.set(d.x,d.y,d.z),{point:u,normal:f,collider:l.collider[wn]}}return null}getPhysicsRay(t,e,i){var l,c,h;const n=(l=this.context)==null?void 0:l.mainCamera;if(e===void 0){const d=(c=this.context)==null?void 0:c.input.getPointerPosition(0);if(d)e=d;else return null}if(e.z===void 0){if(!n)return console.error("Can not perform raycast from 2d point - no main camera found"),null;const d=this.raycastVectorsBuffer.get();d.x=e.x,d.y=e.y,d.z=0,(d.x>1||d.y>1||d.y<-1||d.x<-1)&&(mt&&console.warn("Converting screenspace to raycast space",d),(h=this.context)==null||h.input.convertScreenspaceToRaycastSpace(d)),d.unproject(n),e=d}const o=e;t.origin.x=o.x,t.origin.y=o.y,t.origin.z=o.z;const r=this.raycastVectorsBuffer.get();if(i)r.set(i.x,i.y,i.z);else{if(!n)return console.error("Can not perform raycast - no camera found"),null;r.set(t.origin.x,t.origin.y,t.origin.z);const d=ve(n);r.sub(d)}return r.normalize(),t.dir.x=r.x,t.dir.y=r.y,t.dir.z=r.z,t}sphereOverlap(t,e){return this.rapierSphere??(this.rapierSphere=new q.RAPIER_PHYSICS.MODULE.Ball(e)),this.rapierSphere.radius=e,(this.debugRenderRaycasts||Qp)&&se.DrawWireSphere(t,e,3359999,1),this.shapeOverlap(t,this.rapierIdentityRotation,this.rapierSphere)}boxOverlap(t,e,i=null){return i===null&&(i=this.rapierIdentityRotation),this.rapierBox??(this.rapierBox=new q.RAPIER_PHYSICS.MODULE.Cuboid(1,1,1)),this.rapierBox.halfExtents.x=e.x*.5,this.rapierBox.halfExtents.y=e.y*.5,this.rapierBox.halfExtents.z=e.z*.5,(this.debugRenderRaycasts||Qp)&&se.DrawWireBox(t,e,3359999,1,!0,i),this.shapeOverlap(t,i,this.rapierBox)}shapeOverlap(t,e,i){return this.rapierColliderArray.length=0,this._isInitialized?this.world?(this.world.intersectionsWithShape(t,e,i,n=>{const o=n[wn],r=new XL(o.gameObject,o);return this.rapierColliderArray.push(r),!0},void 0,void 0,void 0,void 0,n=>n.isSensor()?!1:n[wn].gameObject.layers.isEnabled(2)==!1),this.rapierColliderArray):this.rapierColliderArray:this.rapierColliderArray}get world(){return this._world}get isUpdating(){return this._isUpdatingPhysicsWorld}get gravity(){var t;return((t=this.world)==null?void 0:t.gravity)??this._gravity}set gravity(t){this.world?this.world.gravity=t:this._gravity=t}clearCaches(){var t,e,i,n;this._meshCache.clear(),(t=this.eventQueue)!=null&&t.raw&&((e=this.eventQueue)==null||e.free()),(i=this.world)!=null&&i.bodies&&((n=this.world)==null||n.free())}async addBoxCollider(t,e){if(this._isInitialized||await this.initialize(),!t.activeAndEnabled)return;if(!this.enabled){mt&&console.warn("Physics are disabled");return}const i=t.gameObject,n=Lt(i,this._tempPosition).multiply(e);n.multiplyScalar(.5),n.x<0&&(n.x=Math.abs(n.x)),n.y<0&&(n.y=Math.abs(n.y)),n.z<0&&(n.z=Math.abs(n.z));const o=1e-7;n.x<o&&(n.x=o),n.y<o&&(n.y=o),n.z<o&&(n.z=o);const r=q.RAPIER_PHYSICS.MODULE.ColliderDesc.cuboid(n.x,n.y,n.z);this.createCollider(t,r)}async addSphereCollider(t){if(this._isInitialized||await this.initialize(),!t.activeAndEnabled)return;if(!this.enabled){mt&&console.warn("Physics are disabled");return}const e=q.RAPIER_PHYSICS.MODULE.ColliderDesc.ball(.5);this.createCollider(t,e),this.updateProperties(t)}async addCapsuleCollider(t,e,i){if(this._isInitialized||await this.initialize(),!t.activeAndEnabled)return;if(!this.enabled){mt&&console.warn("Physics are disabled");return}const o=t.gameObject.worldScale;o.x=Math.abs(o.x),o.y=Math.abs(o.y);const r=i*o.x;e=Math.max(e,r);const l=ee.clamp(e*.5*o.y-i*o.x,0,Number.MAX_SAFE_INTEGER),c=q.RAPIER_PHYSICS.MODULE.ColliderDesc.capsule(l,r);this.createCollider(t,c)}async addMeshCollider(t,e,i,n){var u,f,p;let o=e.geometry;if(!o){mt&&console.warn("Missing mesh geometry",e.name);return}(f=(u=o.index)==null?void 0:u.array)!=null&&f.length||(console.warn(`Your MeshCollider is missing vertices or indices in the assined mesh "${e.name}". Consider providing an indexed geometry.`),o=Zk(o));let r=null;const l=o.getAttribute("position");if(l instanceof QC){const b=l.count;r=new Float32Array(b*3);for(let x=0;x<b;x++){const v=l.getX(x),S=l.getY(x),C=l.getZ(x);r[x*3]=v,r[x*3+1]=S,r[x*3+2]=C}}else r=l.array;if(await this.initialize(),!this.enabled){mt&&console.warn("Physics are disabled");return}if(!t.activeAndEnabled)return;const c=(p=o.index)==null?void 0:p.array,h=t.gameObject.worldScale.clone();if(n&&h.multiply(n),Math.abs(h.x-1)>1e-4||Math.abs(h.y-1)>1e-4||Math.abs(h.z-1)>1e-4){const b=`${o.uuid}_${h.x}_${h.y}_${h.z}_${i}`;if(this._meshCache.has(b))mt&&console.warn("Use cached mesh collider"),r=this._meshCache.get(b);else{(mt||X())&&console.debug(`[Performance] Your MeshCollider "${t.name}" is scaled: consider applying the scale to the collider mesh instead (${h.x}, ${h.y}, ${h.z})`);const x=new Float32Array(r.length);for(let v=0;v<r.length;v+=3)x[v]=r[v]*h.x,x[v+1]=r[v+1]*h.y,x[v+2]=r[v+2]*h.z;r=x,this._meshCache.set(b,x)}}const d=i?q.RAPIER_PHYSICS.MODULE.ColliderDesc.convexHull(r):q.RAPIER_PHYSICS.MODULE.ColliderDesc.trimesh(r,c);d&&this.createCollider(t,d)}updatePhysicsMaterial(t){if(!t)return;const e=t.sharedMaterial,i=t[zi];if(i&&e){if(e.bounciness!==void 0&&i.setRestitution(e.bounciness),e.bounceCombine!==void 0)switch(e.bounceCombine){case Qt.Average:i.setRestitutionCombineRule(q.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case Qt.Maximum:i.setRestitutionCombineRule(q.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case Qt.Minimum:i.setRestitutionCombineRule(q.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case Qt.Multiply:i.setRestitutionCombineRule(q.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}if(e.dynamicFriction!==void 0&&i.setFriction(e.dynamicFriction),e.frictionCombine!==void 0)switch(e.frictionCombine){case Qt.Average:i.setFrictionCombineRule(q.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case Qt.Maximum:i.setFrictionCombineRule(q.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case Qt.Minimum:i.setFrictionCombineRule(q.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case Qt.Multiply:i.setFrictionCombineRule(q.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}}}getBody(t){return t?t[zi]:null}getComponent(t){return t?t[wn]:null}createCollider(t,e){var r;if(!this.world)throw new Error("Physics world not initialized");const i=this._tempMatrix;let n;t.attachedRigidbody?n=this.getRigidbody(t,this._tempMatrix):(mt&&console.log("Create collider without rigidbody",t.name),i.makeRotationFromQuaternion(Qe(t.gameObject)),i.setPosition(ve(t.gameObject))),i.decompose(this._tempPosition,this._tempQuaternion,this._tempScale),this.tryApplyCenter(t,this._tempPosition),e.setTranslation(this._tempPosition.x,this._tempPosition.y,this._tempPosition.z),e.setRotation(this._tempQuaternion),e.setSensor(t.isTrigger);const o=t.sharedMaterial;if(o){if(o.bounciness!==void 0&&e.setRestitution(o.bounciness),o.bounceCombine!==void 0)switch(o.bounceCombine){case Qt.Average:e.setRestitutionCombineRule(q.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case Qt.Maximum:e.setRestitutionCombineRule(q.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case Qt.Minimum:e.setRestitutionCombineRule(q.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case Qt.Multiply:e.setRestitutionCombineRule(q.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}if(o.dynamicFriction!==void 0&&e.setFriction(o.dynamicFriction),o.frictionCombine!==void 0)switch(o.frictionCombine){case Qt.Average:e.setFrictionCombineRule(q.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case Qt.Maximum:e.setFrictionCombineRule(q.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case Qt.Minimum:e.setFrictionCombineRule(q.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case Qt.Multiply:e.setFrictionCombineRule(q.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}}((r=t.attachedRigidbody)==null?void 0:r.autoMass)===!1&&(e.setDensity(1e-6),e.setMass(1e-6));try{const l=this.world.createCollider(e,n);return l[wn]=t,t[zi]=l,l.setActiveEvents(q.RAPIER_PHYSICS.MODULE.ActiveEvents.COLLISION_EVENTS),l.setActiveCollisionTypes(q.RAPIER_PHYSICS.MODULE.ActiveCollisionTypes.ALL),this.objects.push(t),this.bodies.push(l),this.updateColliderCollisionGroups(t),mt&&console.log("Created collider",t.name,l),l}catch(l){return console.error('Error creating collider "'+t.name+`"
Error:`,l),null}}updateColliderCollisionGroups(t){const e=t[zi],i=t.membership;let n=0;if(i==null)n=65535;else for(let l=0;l<i.length;l++){const c=i[l];c>31?console.error(`Rapier only supports 32 layers, layer ${c} is not supported`):n|=1<<Math.floor(c)}const o=t.filter;let r=0;if(o==null)r=65535;else for(let l=0;l<o.length;l++){const c=o[l];c>31?console.error(`Rapier only supports 32 layers, layer ${c} is not supported`):r|=1<<Math.floor(c)}e.setCollisionGroups(n<<16|r)}getRigidbody(t,e){if(!this.world)throw new Error("Physics world not initialized");let i=null;if(t.attachedRigidbody){const n=t.attachedRigidbody;if(i=n[zi],!i){const o=n.isKinematic&&!n_;mt&&console.log("Create rigidbody",o);const r=o?q.RAPIER_PHYSICS.MODULE.RigidBodyDesc.kinematicPositionBased():q.RAPIER_PHYSICS.MODULE.RigidBodyDesc.dynamic(),l=ve(t.attachedRigidbody.gameObject);r.setTranslation(l.x,l.y,l.z),r.setRotation(Qe(t.attachedRigidbody.gameObject)),r.centerOfMass=new q.RAPIER_PHYSICS.MODULE.Vector3(n.centerOfMass.x,n.centerOfMass.y,n.centerOfMass.z),i=this.world.createRigidBody(r),this.bodies.push(i),this.objects.push(n)}i[wn]=n,n[zi]=i,this.internalUpdateRigidbodyProperties(n,i),this.getRigidbodyRelativeMatrix(t.gameObject,n.gameObject,e),t[jC]=i}else{const n=q.RAPIER_PHYSICS.MODULE.RigidBodyDesc.kinematicPositionBased(),o=ve(t.gameObject);n.setTranslation(o.x,o.y,o.z),n.setRotation(Qe(t.gameObject)),i=this.world.createRigidBody(n),e.identity(),i[wn]=null}return i}internal_getRigidbody(t){return t.isCollider===!0?t[jC]:t[zi]}internalUpdateColliderProperties(t,e){const i=e.shape;let n=!1;switch(i.type){case q.RAPIER_PHYSICS.MODULE.ShapeType.Ball:{const f=i,p=t,b=t.gameObject,x=Lt(b,this._tempPosition),v=Math.abs(p.radius*x.x);n=f.radius!==v,f.radius=v,n&&e.setShape(f);break}case q.RAPIER_PHYSICS.MODULE.ShapeType.Cuboid:const o=i,r=t,l=t.gameObject,c=Lt(l,this._tempPosition),h=Math.abs(r.size.x*.5*c.x),d=Math.abs(r.size.y*.5*c.y),u=Math.abs(r.size.z*.5*c.z);n=o.halfExtents.x!==h||o.halfExtents.y!==d||o.halfExtents.z!==u,o.halfExtents.x=h,o.halfExtents.y=d,o.halfExtents.z=u,n&&e.setShape(o);break}if(n){const o=t.attachedRigidbody;if(o!=null&&o.autoMass){const r=this.getBody(o);r==null||r.recomputeMassPropertiesFromColliders()}}this.updateColliderCollisionGroups(t),t.isTrigger!==e.isSensor()&&e.setSensor(t.isTrigger)}internalUpdateRigidbodyProperties(t,e){if(e.enableCcd(t.collisionDetectionMode!==Fm.Discrete),e.setLinearDamping(t.drag),e.setAngularDamping(t.angularDrag),e.setGravityScale(t.useGravity?t.gravityScale:0,!0),t.dominanceGroup<=127&&t.dominanceGroup>=-127?e.setDominanceGroup(Math.floor(t.dominanceGroup)):e.setDominanceGroup(0),t.autoMass){e.setAdditionalMass(0,!1);for(let i=0;i<e.numColliders();i++)e.collider(i).setDensity(1);e.recomputeMassPropertiesFromColliders()}else{e.setAdditionalMass(t.mass,!1);for(let i=0;i<e.numColliders();i++)e.collider(i).setDensity(1e-7);e.recomputeMassPropertiesFromColliders()}e.setEnabledRotations(!t.lockRotationX,!t.lockRotationY,!t.lockRotationZ,!1),e.setEnabledTranslations(!t.lockPositionX,!t.lockPositionY,!t.lockPositionZ,!1),t.isKinematic?e.setBodyType(q.RAPIER_PHYSICS.MODULE.RigidBodyType.KinematicPositionBased,!1):e.setBodyType(q.RAPIER_PHYSICS.MODULE.RigidBodyType.Dynamic,!1)}step(t){if(this.world&&this.enabled){if(this._isUpdatingPhysicsWorld=!0,this.eventQueue||(this.eventQueue=new q.RAPIER_PHYSICS.MODULE.EventQueue(!1)),t===void 0||t<=0){this._isUpdatingPhysicsWorld=!1;return}else if(t!==void 0){const e=ee.lerp(this.world.timestep,t,.8);this.world.timestep=e}try{this.world.step(this.eventQueue)}catch(e){console.warn("Error running physics step",{timestep:this.world.timestep},e)}this._isUpdatingPhysicsWorld=!1}}postStep(){this.world&&this.enabled&&(this._isUpdatingPhysicsWorld=!0,this.syncObjects(),this._isUpdatingPhysicsWorld=!1,this.eventQueue&&!this.collisionHandler&&(this.collisionHandler=new TF(this.world,this.eventQueue)),this.collisionHandler&&(this.collisionHandler.handleCollisionEvents(),this.collisionHandler.update()),this.updateDebugRendering(this.world))}updateDebugRendering(t){var e,i,n,o;if(mt||n_||PF||this.debugRenderColliders===!0){if(!this.lines){const l=new O0({color:7855479,fog:!1}),c=new Gs;this.lines=new XC(c,l),this.lines.layers.disableAll(),this.lines.layers.enable(2)}this.lines.parent!==((e=this.context)==null?void 0:e.scene)&&((i=this.context)==null||i.scene.add(this.lines));const r=t.debugRender();this.lines.geometry.setAttribute("position",new Cn(r.vertices,3)),this.lines.geometry.setAttribute("color",new Cn(r.colors,4)),(this.context.time.frame%30===0||((n=this.lines.geometry.boundingSphere)==null?void 0:n.radius)===0)&&this.lines.geometry.computeBoundingSphere()}else this.lines&&((o=this.context)==null||o.scene.remove(this.lines))}syncObjects(){if(!n_)for(let t=0;t<this.bodies.length;t++){const e=this.objects[t],i=this.bodies[t],n=e;if((n==null?void 0:n.isCollider)===!0&&!n.attachedRigidbody){const c=i.parent();c?this.syncPhysicsBody(e.gameObject,c,!0,!0):this.syncPhysicsBody(e.gameObject,i,!0,!0);continue}const o=i.translation(),r=i.rotation();if(Number.isNaN(o.x)||Number.isNaN(r.x)){!n.__COLLIDER_NAN&&X()&&(console.warn("Collider has NaN values",n.name,n.gameObject,i),n.__COLLIDER_NAN=!0);continue}const l=e.center;if(l&&l.isVector3){this._tempQuaternion.set(r.x,r.y,r.z,r.w);const c=this._tempPosition.copy(l).applyQuaternion(this._tempQuaternion),h=Lt(e.gameObject);c.multiply(h),o.x-=c.x,o.y-=c.y,o.z-=c.z}Qh(e.gameObject,o.x,o.y,o.z),S1(e.gameObject,r.x,r.y,r.z,r.w)}}syncPhysicsBody(t,e,i,n){if(e instanceof q.RAPIER_PHYSICS.MODULE.RigidBody){const o=ve(t,this._tempPosition),r=Qe(t,this._tempQuaternion);switch(e.bodyType()){case q.RAPIER_PHYSICS.MODULE.RigidBodyType.Fixed:case q.RAPIER_PHYSICS.MODULE.RigidBodyType.KinematicPositionBased:case q.RAPIER_PHYSICS.MODULE.RigidBodyType.KinematicVelocityBased:i&&e.setNextKinematicTranslation(o),n&&e.setNextKinematicRotation(r);break;default:i&&e.setTranslation(o,!1),n&&e.setRotation(r,!1);break}}else if(e instanceof q.RAPIER_PHYSICS.MODULE.Collider){t.matrixWorldNeedsUpdate&&t.updateWorldMatrix(!0,!1),t.matrixWorld.decompose(this._tempPosition,this._tempQuaternion,this._tempScale);const o=this._tempPosition,r=this._tempQuaternion,l=e[wn];if(this.tryApplyCenter(l,o),i){const c=e.translation();(c.x!==o.x||c.y!==o.y||c.z!==o.z)&&e.setTranslation(o)}if(n){const c=e.rotation();(c.x!==r.x||c.y!==r.y||c.z!==r.z||c.w!==r.w)&&e.setRotation(r)}}}tryApplyCenter(t,e){const i=t.center;i&&t.gameObject&&(i.x!==0||i.y!==0||i.z!==0)&&(this._tempCenterPos.x=i.x,this._tempCenterPos.y=i.y,this._tempCenterPos.z=i.z,Lt(t.gameObject,this._tempCenterVec),this._tempCenterPos.multiply(this._tempCenterVec),t.attachedRigidbody?this._tempCenterPos.applyQuaternion(t.gameObject.quaternion):(Qe(t.gameObject,this._tempCenterQuaternion),this._tempCenterPos.applyQuaternion(this._tempCenterQuaternion)),e.x+=this._tempCenterPos.x,e.y+=this._tempCenterPos.y,e.z+=this._tempCenterPos.z)}getRigidbodyRelativeMatrix(t,e,i,n){if(n===void 0&&(n=rf._matricesBuffer,n.length=0),t===e){const o=Lt(t,this._tempPosition);i.makeScale(o.x,o.y,o.z);for(let r=n.length-1;r>=0;r--)i.multiply(n[r]);return i}return n.push(t.matrix),t.parent&&this.getRigidbodyRelativeMatrix(t.parent,e,i,n),i}addFixedJoint(t,e){if(!this.world){console.error("Physics world not initialized");return}const i=t[zi],n=e[zi];this.calculateJointRelativeMatrices(t.gameObject,e.gameObject,this._tempMatrix),this._tempMatrix.decompose(this._tempPosition,this._tempQuaternion,this._tempScale);const o=q.RAPIER_PHYSICS.MODULE.JointData.fixed(rf.centerConnectionPos,rf.centerConnectionRot,this._tempPosition,this._tempQuaternion),r=this.world.createImpulseJoint(o,i,n,!0);mt&&console.log("ADD FIXED JOINT",r)}addHingeJoint(t,e,i,n){if(!this.world){console.error("Physics world not initialized");return}const o=t[zi],r=e[zi];this.calculateJointRelativeMatrices(t.gameObject,e.gameObject,this._tempMatrix),this._tempMatrix.decompose(this._tempPosition,this._tempQuaternion,this._tempScale);const l=q.RAPIER_PHYSICS.MODULE.JointData.revolute(i,this._tempPosition,n),c=this.world.createImpulseJoint(l,o,r,!0);mt&&console.log("ADD HINGE JOINT",c)}calculateJointRelativeMatrices(t,e,i){t.updateWorldMatrix(!0,!1),e.updateWorldMatrix(!0,!1);const n=t.matrixWorld,o=e.matrixWorld;n.elements[0]=1,n.elements[5]=1,n.elements[10]=1,o.elements[0]=1,o.elements[5]=1,o.elements[10]=1,i.copy(o).premultiply(n.invert()).invert()}};let Al=rf;a(Al,"_didLoadPhysicsEngine",!1),a(Al,"_matricesBuffer",[]),a(Al,"centerConnectionPos",{x:0,y:0,z:0}),a(Al,"centerConnectionRot",{x:0,y:0,z:0,w:1});class TF{constructor(t,e){a(this,"world");a(this,"eventQueue");a(this,"activeCollisions",[]);a(this,"activeCollisionsStay",[]);a(this,"activeTriggers",[]);this.world=t,this.eventQueue=e}handleCollisionEvents(){this.eventQueue&&this.world&&this.eventQueue.drainCollisionEvents((t,e,i)=>{const n=this.world.getCollider(t),o=this.world.getCollider(e);if(!n||!o)return;const r=n[wn],l=o[wn];s_&&console.log("EVT",r.name,l.name,i,n,o),r&&l&&(i?(this.onCollisionStarted(r,n,l,o),this.onCollisionStarted(l,o,r,n)):(this.onCollisionEnded(r,l),this.onCollisionEnded(l,r)))})}update(){this.onHandleCollisionStay()}onCollisionStarted(t,e,i,n){let o=null;if(t.isTrigger||i.isTrigger)id(t.gameObject,r=>{r.onTriggerEnter&&!r.destroyed&&r.onTriggerEnter(i),this.activeTriggers.push({collider:t,component:r,otherCollider:i})});else{const r=t.gameObject;this.world.contactPair(e,n,(l,c)=>{id(r,h=>{var u;if(h.destroyed)return;const d=h.onCollisionEnter||h.onCollisionStay||h.onCollisionExit;if(d||s_){if(!o){const f=[],p=l.normal();i instanceof Cc&&i.convex&&(p.x=-p.x,p.y=-p.y,p.z=-p.z);for(let b=0;b<l.numSolverContacts();b++){const x=l.solverContactPoint(b),v=l.contactImpulse(b);if(x){const S=l.contactDist(b),C=l.solverContactFriction(b),P=l.solverContactTangentVelocity(b),E=new GL(x,S,p,v,C,P);f.push(E),s_&&se.DrawDirection(x,p,16711680,3,!0)}}o=new qL(r,i,f)}if(d){const f={collider:t,component:h,collision:o};this.activeCollisions.push(f),h.onCollisionStay&&this.activeCollisionsStay.push(f),(u=h.onCollisionEnter)==null||u.call(h,o)}}})})}}onHandleCollisionStay(){for(const t of this.activeCollisionsStay){const e=t.component;if(!e.destroyed&&e.activeAndEnabled&&e.onCollisionStay){if(t.collision.collider.destroyed)continue;const i=t.collision;e.onCollisionStay(i)}}for(const t of this.activeTriggers){const e=t.component;if(!e.destroyed&&e.activeAndEnabled&&e.onTriggerStay){const i=t.otherCollider;if(i.destroyed)continue;e.onTriggerStay(i)}}}onCollisionEnded(t,e){if(!(t.destroyed||e.destroyed)){for(let i=0;i<this.activeCollisions.length;i++){const n=this.activeCollisions[i],o=n.collider;if(o.destroyed||n.collision.collider.destroyed){this.activeCollisions.splice(i,1),i--;continue}if(o===t&&n.collision.collider===e){const r=n.component;if(this.activeCollisions.splice(i,1),i--,r.activeAndEnabled&&r.onCollisionExit){const l=n.collision;r.onCollisionExit(l)}}}for(let i=0;i<this.activeCollisionsStay.length;i++){const n=this.activeCollisionsStay[i],o=n.collider;if(o.destroyed||n.collision.collider.destroyed){this.activeCollisionsStay.splice(i,1),i--;continue}if(o===t&&n.collision.collider===e){const r=n.component;if(this.activeCollisionsStay.splice(i,1),i--,r.activeAndEnabled&&r.onCollisionExit){const l=n.collision;r.onCollisionExit(l)}}}for(let i=0;i<this.activeTriggers.length;i++){const n=this.activeTriggers[i],o=n.collider;if(o.destroyed||n.otherCollider.destroyed){this.activeTriggers.splice(i,1),i--;continue}if(o===t&&n.otherCollider===e){const r=n.component;if(this.activeTriggers.splice(i,1),i--,r.activeAndEnabled&&r.onTriggerExit){const l=n.otherCollider;r.onTriggerExit(l)}}}}}}class tB{static async createComparisonScene(t){const{files:e}=t,n=await Promise.all(e.map(v=>new we(v).loadAssetAsync())),o=new Xn;let r=0;for(const v of n)if(v instanceof z){v.position.y=r,o.add(v);const S=On([v]);r+=S.getSize(new R).y,r+=.1}const l=new Ae(20);o.add(l);const c=t.environment||"https://dl.polyhaven.org/file/ph-assets/HDRIs/exr/1k/studio_small_09_1k.exr";if(c){let v=null;if(c.endsWith(".hdr")){const S=(await qs(()=>import("./three-examples.efffc148.js").then(C=>C.q),["./three-examples.efffc148.js","./three@0.169.15.js"],import.meta.url)).RGBELoader;v=new S}else if(c.endsWith(".exr")){const S=(await qs(()=>import("./three-examples.efffc148.js").then(C=>C.p),["./three-examples.efffc148.js","./three@0.169.15.js"],import.meta.url)).EXRLoader;v=new S}if(v){const S=await v.loadAsync(c).catch(C=>(console.error(C),null));S&&(S.mapping=Vo,S.needsUpdate=!0,o.background=S,o.environment=S,o.backgroundBlurriness=.75)}else console.warn("Unsupported environment map format",c)}const h=On(o.children),d=h.getCenter(new R),u=h.getSize(new R),p=Math.max(u.x,u.y,u.z)/(2*Math.tan(Math.PI*l.fov/360));l.position.set(d.x,d.y,p),l.lookAt(d);const b=new a1(l,t.domElement||document.body);b.target=d,b.update();const x=(t.domElement||document.body).getBoundingClientRect();return l.aspect=x.width/x.height,l.updateProjectionMatrix(),{scene:o,camera:l}}}let T0=0;function FC(s){s?T0++:T0--}function iB(){return T0>0}const RF={binary:!0,animations:!0};async function nB(s){if(!s.context)throw new Error("No context provided to exportAsGLTF");s.scene||(s.scene=s.context.scene);const t={...RF,...s},{context:e}=t,i=new l1;i.register(l=>new JC(l)),i.register(l=>new AD(l)),i.register(l=>new WT(l)),UT(i,t.context);const n={binary:t.binary,animations:kF(e,t.scene,[])},o=new OF;console.debug("Exporting GLTF",n),o.onBeforeExport(t),FC(!0);const r=await i.parseAsync(t.scene,n).catch(l=>(console.error(l),null));if(FC(!1),o.onAfterExport(t),!r)throw new Error("Failed to export GLTF");if(t.downloadAs!=null){let l=null;if(r instanceof ArrayBuffer?l=new Blob([r],{type:"application/octet-stream"}):console.error("Can not download GLTF as a blob",r),l){const c=URL.createObjectURL(l),h=document.createElement("a");h.href=c;let d=t.downloadAs;!d.endsWith(".glb")&&!d.endsWith(".gltf")&&(d+=t.binary?".glb":".gltf"),h.download=d,h.click()}}return r}const BC=Symbol("needle:weight");class OF{constructor(){a(this,"_undo",[])}onBeforeExport(t){t.context.animations.mixers.forEach(e=>{const i=Hr.tryGetActionsFromMixer(e);if(i)for(let n=0;n<i.length;n++){const o=i[n];o[BC]=o.weight,o.weight=0,this._undo.push(()=>{o.weight=o[BC]})}e.update(0)}),t.context.scene.traverse(e=>{if(!s0(e)){const i=e.parent;i&&(e.removeFromParent(),this._undo.push(()=>i.add(e)))}})}onAfterExport(t){this._undo.forEach(e=>e()),this._undo.length=0}}function kF(s,t,e){s.animations.mixers.forEach(n=>{const o=Hr.tryGetActionsFromMixer(n);if(o)for(let r=0;r<o.length;r++){const c=o[r].getClip();e.push(c)}}),Array.isArray(t)||(t=[t]);for(const n of t)Hr.tryGetAnimationClipsFromObjectHierarchy(n,e);const i=new Set(e);return Array.from(i)}const UC="needle-button",o_=X();var Ql,Yl,Kl,xi,Cr,Cf,$h,yg,GR,bg,qR,Pf;class HR extends HTMLElement{constructor(){super();En(this,yg);En(this,bg);En(this,Ql,void 0);En(this,Yl,void 0);En(this,Kl,void 0);En(this,xi,void 0);En(this,Cr,void 0);En(this,Cf,void 0);En(this,$h,void 0);En(this,Pf,e=>{o_&&console.log("Needle Button clicked",{defaultPrevented:e.defaultPrevented,hasButton:!!ke(this,xi)}),!e.defaultPrevented&&ke(this,xi)&&ke(this,xi).click()});this.removeEventListener("click",ke(this,Pf)),this.addEventListener("click",ke(this,Pf))}attributeChangedCallback(e,i,n){Bd(this,yg,GR).call(this)}}Ql=new WeakMap,Yl=new WeakMap,Kl=new WeakMap,xi=new WeakMap,Cr=new WeakMap,Cf=new WeakMap,$h=new WeakMap,yg=new WeakSet,GR=function(){var i,n;if((i=ke(this,xi))==null||i.remove(),this.getAttribute("ar")!=null)ke(this,Cr)??Mn(this,Cr,new za),Mn(this,xi,ke(this,Cr).createARButton());else if(this.getAttribute("vr")!=null)ke(this,Cr)??Mn(this,Cr,new za),Mn(this,xi,ke(this,Cr).createVRButton());else if(this.getAttribute("quicklook")!=null)ke(this,Cr)??Mn(this,Cr,new za),Mn(this,xi,ke(this,Cr).createQuicklookButton());else if(this.getAttribute("qrcode")!=null)ke(this,Cf)??Mn(this,Cf,new Hs),Mn(this,xi,ke(this,Cf).createQRCode({anchorElement:this}));else{o_?console.warn("No button type specified for <needle-button>. Use either ar, vr or quicklook attribute."):console.debug("No button type specified for <needle-button>. Use either ar, vr or quicklook attribute.");return}ke(this,Ql)??Mn(this,Ql,this.attachShadow({mode:"open"})),ke(this,Yl)??Mn(this,Yl,document.createElement("slot")),ke(this,Kl)??Mn(this,Kl,document.createElement("style")),ke(this,Kl).innerHTML=`
            button {
                all: unset;
            }
        `,this.getAttribute("unstyled")!=null||(ke(this,Kl).innerHTML+=`
            :host {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: fit-content;

                padding: 0.4rem .5rem;
                border-radius: 100vw;
                
                background: rgba(245, 245, 245, .8);
                backdrop-filter: blur(10px);

                cursor: pointer;
                color: black;
                outline: rgba(0,0,0,.05) 1px solid;

                transition: all .2s;
            }
            :host(:hover) {
                background: rgba(255, 255, 255, 1);
                transition: background .2s;
            }
            slot {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: .5rem;
            }
`),ke(this,Yl).innerHTML=ke(this,xi).innerHTML,ke(this,Yl).style.cssText="display: flex; align-items: center; justify-content: center;",ke(this,xi).innerHTML=ke(this,Yl).outerHTML,ke(this,Ql).innerHTML=ke(this,xi).outerHTML,ke(this,Ql).prepend(ke(this,Kl)),Lm(X_,{element:ke(this,Ql)}),(n=ke(this,$h))==null||n.disconnect(),ke(this,$h)??Mn(this,$h,new MutationObserver(()=>Bd(this,bg,qR).call(this))),ke(this,$h).observe(ke(this,xi),{attributes:!0}),o_&&console.log("Needle Button updated",this)},bg=new WeakSet,qR=function(){ke(this,xi)&&(ke(this,xi).style.display==="none"?this.style.display="none":this.style.display==="none"&&(this.style.display=""))},Pf=new WeakMap,a(HR,"observedAttributes",["ar","vr","quicklook","qrcode"]);typeof window<"u"&&!window.customElements.get(UC)&&window.customElements.define(UC,HR);const su=k("debugavatar");class XR{constructor(t,e,i,n){a(this,"root");a(this,"head");a(this,"leftHand");a(this,"rigthHand");var o;this.root=t,this.head=e,this.leftHand=i,this.rigthHand=n,(o=this.root)==null||o.traverse(r=>r.layers.set(2))}get isValid(){return this.head!==null&&this.head!==void 0}}class EF{constructor(){a(this,"avatarRegistryUrl",null)}async getOrCreateNewAvatarInstance(t,e){if(!e)return console.error("Can not create avatar: failed to provide id or root object"),null;let i=null;if(typeof e=="string"){if(i=await this.loadAvatar(t,e),!i){const o=new er;i=I.instantiate(af(e,t.scene),o)}}else i=e;if(!i)return null;const n=this.findAvatar(i);return n.isValid?(su&&console.log("[Custom Avatar] valid config",e,su?n:""),n):(console.warn("[Custom Avatar] config isn't valid",e,su?n:""),null)}async loadAvatar(t,e){if(console.assert(e!=null&&typeof e=="string","Avatar id must not be null"),e.length<=0||!e)return null;if(su&&console.log("[Custom Avatar] "+e+", loading..."),e.endsWith(".glb")||(e+=".glb"),this.avatarRegistryUrl===null){const n=await fetch("./"+e);let o=null;if(n.ok){const l=await n.blob();l&&(o=await l.arrayBuffer())}if(!o)return null;const r=await Ko().parseSync(t,o,null,0);return(r==null?void 0:r.scene)??null}const i=new Wr;return dv(i,t),new Promise((n,o)=>{const r=this.avatarRegistryUrl+"/"+e;i.load(r,async l=>{await Ko().createBuiltinComponents(t,r,l,null,void 0),n(l.scene)},l=>{su&&console.log("[Custom Avatar] "+l.loaded/l.total*100+"% loaded of "+l.total/1024+"kB")},l=>{console.error("[Custom Avatar] Error when loading: "+l),n(null)})})}cacheModel(t,e){}findAvatar(t){const e=t;let i=e;i.children.length==1&&(i=t.children[0]);let n=this.findAvatarPart(i,["head"]);const o=this.findAvatarPart(i,["left","hand"]),r=this.findAvatarPart(i,["right","hand"]);if(!n){n=e;const c=new R;new bs().setFromObject(n).getSize(c);const h=Math.max(c.x,c.y,c.z);console.warn("[Custom Avatar] Normalizing head scale, it's too big: "+h+" meters! Should be < 0.3m"),h>.3&&n.scale.multiplyScalar(1/h*.3)}return new XR(e,n,o,r)}findAvatarPart(t,e){const i=t.name.toLowerCase();let n=!0;for(const o of e){if(!n)break;i.indexOf(o)===-1&&(n=!1)}if(n)return t;if(t.children)for(const o of t.children){const r=this.findAvatarPart(o,e);if(r)return r}return null}handleCustomAvatarErrors(t){if(!t.ok)throw Error(t.statusText);return t}}class MF{get extensionName(){return"DocumentExtension"}onAfterBuildDocument(t){}}class AF{}const IF=Object.freeze(Object.defineProperty({__proto__:null,ActionBuilder:Ve,ActionCollection:r3,ActionModel:Bn,AlignmentConstraint:Vg,Animation:pn,AnimationCurve:zo,AnimationExtension:Pv,AnimationTrackHandler:ng,Animator:Ei,AnimatorController:Ks,Antialiasing:ly,Attractor:Gf,AudioExtension:pd,AudioListener:Aa,AudioSource:We,AudioTrackHandler:zh,Avatar:uc,AvatarBlink_Simple:hd,AvatarEyeLook_Rotation:Ua,AvatarLoader:EF,AvatarMarker:ni,AvatarModel:XR,Avatar_Brain_LookAt:$m,Avatar_MouthShapes:qg,Avatar_MustacheShake:kT,Avatar_POI:Ba,AxesHelper:Lf,BaseUIComponent:eo,BasicIKConstraint:MT,BehaviorExtension:rR,BehaviorModel:ki,BloomEffect:Br,BoxCollider:Sc,BoxGizmo:_d,BoxHelperComponent:Nn,Button:hl,CallInfo:Pa,Camera:ze,CameraTargetReachedEvent:Nm,Canvas:ri,CanvasGroup:fc,CapsuleCollider:Ga,ChangeMaterialOnClick:$s,ChangeTransformOnClick:md,CharacterController:dd,CharacterControllerInput:Ka,ChromaticAberration:cy,ClickThrough:Zv,ColorAdjustments:kc,ColorBySpeedModule:Hf,ColorOverLifetimeModule:Fv,ContactShadows:qn,ControlTrackHandler:qv,CursorFollow:Ic,CustomBranding:bd,Deletable:LT,DeleteBox:Fh,DepthOfField:nr,DeviceFlag:_v,DocumentExtension:MF,DragControls:si,DropListener:Za,Duplicatable:Tc,EffectWrapper:eg,EmissionModule:nl,EmphasizeOnClick:Ff,EnvironmentScene:Yv,EventList:je,EventListEvent:fv,EventSystem:Rn,EventTrigger:Sv,FieldWithDefault:RD,FixedJoint:mR,Fog:zf,GltfExport:Do,GltfExportBox:GT,Gradient:xd,Graphic:Fr,GraphicRaycaster:pv,GridHelper:$f,GridLayoutGroup:fR,GroundProjectedEnv:Kr,GroupActionModel:Gl,HideOnStart:Xl,HingeJoint:sy,HorizontalLayoutGroup:uR,get HoverAnimation(){return Qr},Image:Jf,InheritVelocityModule:sl,InputField:ps,InstanceHandle:Iu,InstancingHandler:Hl,Interactable:IT,Keyframe:Vn,LODGroup:oy,LODModel:Wf,Light:Di,LimitVelocityOverLifetimeModule:hi,LogStats:AT,LookAt:Nr,LookAtConstraint:cd,MainModule:yn,MarkerTrackHandler:Gv,MaskableGraphic:ny,MeshCollider:Cc,MeshRenderer:Yg,MinMaxCurve:ce,MinMaxGradient:Ri,NeedleMenu:ea,NestedGltf:ry,Networking:qa,NoiseModule:Ke,ObjectRaycaster:ws,OffsetConstraint:vd,OpenURL:ep,OrbitControls:He,Outline:Nf,Padding:yd,ParticleBurst:u0,ParticleSubEmitter:bR,ParticleSystem:vt,ParticleSystemRenderer:oo,PhysicsExtension:aR,PixelationEffect:dy,PlayAnimationOnClick:Uo,PlayAudioOnClick:dc,PlayableDirector:Js,PlayerColor:vf,PointerEventData:Hg,PostProcessingHandler:CR,PreliminaryAction:Bf,PreliminaryTrigger:Zg,RawImage:Qv,Rect:C3,RectTransform:Mi,ReflectionProbe:Bo,RegisteredAnimationInfo:ql,RemoteSkybox:qr,Renderer:tt,RendererLightmap:zT,Rigidbody:De,RotationBySpeedModule:so,RotationOverLifetimeModule:ir,SceneSwitcher:$t,ScreenCapture:Ac,ScreenSpaceAmbientOcclusion:ol,ScreenSpaceAmbientOcclusionN8:sr,ScrollFollow:dl,SeeThrough:rl,SetActiveOnClick:fs,ShadowCatcher:fy,ShapeModule:lt,SharpeningEffect:uy,SignalAsset:Hv,SignalReceiver:$a,SignalReceiverEvent:gy,SignalTrackHandler:sg,Size:S3,SizeBySpeedModule:es,SizeOverLifetimeModule:wd,SkinnedMeshRenderer:$T,SmoothFollow:qo,SpatialGrabRaycaster:sc,SpatialHtml:vy,SpatialTrigger:ac,SpatialTriggerReceiver:Ur,SpectatorCamera:Wv,SphereCollider:Df,SplineContainer:Rd,SplineData:Xr,SplineWalker:ao,Sprite:Ja,SpriteData:Go,SpriteRenderer:Kn,SpriteSheet:_f,SubEmitterSystem:y0,SyncedCamera:Nh,SyncedRoom:or,SyncedTransform:Zo,TapGestureTrigger:nR,TeleportTarget:Ov,TestRunner:RR,TestSimulateUserData:OR,Text:gn,TextBuilder:hR,TextExtension:kv,TextureSheetAnimationModule:bn,TiltShiftEffect:ia,ToneMappingEffect:pc,TrailModule:Rt,TransformData:bt,TransformGizmo:Od,TriggerBuilder:Zi,TriggerModel:Na,UIRaycastUtils:TT,UIRootComponent:iy,USDZExporter:Ge,USDZText:gh,USDZUIExtension:pR,UsageMarker:Qg,VariantAction:iR,VelocityOverLifetimeModule:Dt,VerticalLayoutGroup:dR,VideoPlayer:ai,get ViewBox(){return mc},Vignette:Cd,VisibilityAction:Jg,Voip:wc,Volume:Xf,VolumeParameter:ne,VolumeProfile:Nv,WebARCameraBackground:Cy,WebARSessionRoot:No,WebXR:pt,WebXRImageTracking:Py,WebXRImageTrackingModel:pl,WebXRPlaneTracking:ml,WebXRTrackedImage:xh,XRControllerFollow:ul,XRControllerModel:Gr,XRControllerMovement:Cs,XRFlag:Ci,XRRig:Jv,XRState:un,__Ignore:AF},Symbol.toStringTag,{value:"Module"})),xf=k("debugmissingcamera");Be.registerCallback(Me.MissingCamera,s=>{var l,c,h;xf&&console.warn("Creating missing camera");const t=s.context.scene,e=new Ae;e.name="Default Fallback Camera",t.add(e);const i=new ze;if(i.sourceId=((c=(l=s.files)==null?void 0:l[0])==null?void 0:c.src)??"unknown",i.fieldOfView=35,s.context.domElement.getAttribute("transparent")!=null)i.clearFlags=Gi.Uninitialized;else if((h=s.context.domElement.getAttribute("background-image"))!=null&&h.length||s.context.lightmaps.tryGetSkybox(i.sourceId))i.clearFlags=Gi.Skybox;else{if(i.clearFlags=Gi.SolidColor,!s.context.domElement.getAttribute("background-color")){let d="#efefef";typeof window!==void 0&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(d="#1f1f1f"),t.background=new Se(d)}if(!t.environment){const d=new Mk(s.context.renderer),u=new Yv("neutral");t.environment=d.fromScene(u,.025).texture}}const o=Lh(e,i,!0);e.position.x=0,e.position.y=1,e.position.z=2;const r=s.context.domElement;return(r==null?void 0:r.cameraControls)!=!1&&QR(s.context,o),o});Be.registerCallback(Me.ContextCreated,s=>{if(!s.context.mainCamera){xf&&console.log("Will not auto-fit because a default camera exists");return}const t=s.context.domElement;if((t==null?void 0:t.cameraControls)==!0){const e=ME(s.context.mainCamera);if((e==null?void 0:e.isCameraController)==!0){xf&&console.log("Will not auto-fit because a camera controller exists");return}QR(s.context)}});function QR(s,t){t=t??s.mainCameraComponent;const e=t==null?void 0:t.gameObject;if(xf&&console.log("Creating default camera controls",t==null?void 0:t.name),e){const i=Bg(e,He);i.sourceId=(t==null?void 0:t.sourceId)??"unknown";const n=s.domElement.getAttribute("auto-rotate");i.autoRotate=n!="0"&&(n==null?void 0:n.toLowerCase())!="false";const o=Number.parseFloat(n||".5");i.autoRotateSpeed=isNaN(o)?.5:o,xf&&console.log("Auto-rotate",i.autoRotate,"speed:",i.autoRotateSpeed);const r=s.domElement.getAttribute("auto-fit");i.autoFit=r!=="0"&&(r==null?void 0:r.toLowerCase())!="false",i.autoTarget=!0}else console.warn("Missing camera object, can not add orbit controls")}Be.registerCallback(Me.ContextCreated,s=>{const t=s.context.domElement.getAttribute("autoplay");if(t!==void 0&&(t===""||t==="true"||t==="1")&&s.files)for(const e of s.files)I.foreachComponent(e.file.scene,n=>{if(n.enabled!==!1){if(n instanceof pn&&n.playAutomatically||n instanceof Ei||n instanceof Js&&n.playOnAwake===!0)return!0;if(n instanceof pn)return n.playAutomatically=!0,!0;if(n instanceof Js)return n.playOnAwake=!0,!0}},!0)!==!0&&Hr.autoplayAnimations(e.file)});var NC;(function(s){function t(e,i=!1,n=.75){const o=new Rd,r=1-ee.clamp(n,0,1);return e.forEach((l,c)=>{const h=new R;c<e.length-1?h.subVectors(e[c+1],l).normalize().multiplyScalar(r):i&&e.length>1&&h.subVectors(e[0],l).normalize().multiplyScalar(r);const d=new Xr;d.position.copy(l),d.tangentIn.copy(h),d.tangentOut.copy(h),o.addKnot(d)}),o.closed=i,o}s.createFromPoints=t})(NC||(NC={}));const Qu={VERSION:Gn,Context:de,NeedleXRSession:fe,assets:{loadFromURL:uF},types:j,onStart:zg,onUpdate:bT,onBeforeRender:tL,onAfterRender:iL,onInitializedContext:cv,onDestroyContext:eL,onClearContext:JI};var $C;(($C=globalThis.Needle)==null?void 0:$C.VERSION)!==void 0&&console.warn(`Needle Engine is already imported: ${globalThis.Needle.VERSION}`);function YR(s){for(const t in s)Qu[t]=s[t]}YR(pL);YR(IF);for(const s of Object.getOwnPropertyNames(I))switch(s){case"prototype":case"constructor":case"length":case"name":continue;default:Qu[s]=I[s];break}if(!globalThis.Needle)globalThis.Needle=Qu;else for(const s in Qu)globalThis.Needle[s]=Qu[s];globalThis.THREE?console.warn("Three.js is already imported"):globalThis.THREE=Ak;export{$4 as $physicsKey,Ve as ActionBuilder,r3 as ActionCollection,Bn as ActionModel,xI as Addressables,Vg as AlignmentConstraint,Lo as AmbientMode,pn as Animation,zo as AnimationCurve,Pv as AnimationExtension,ng as AnimationTrackHandler,Hr as AnimationUtils,Ei as Animator,xa as AnimatorConditionMode,Ks as AnimatorController,K_ as AnimatorControllerParameterType,Tp as AnimatorStateInfo,ly as Antialiasing,Xs as Application,r2 as AssetDatabase,we as AssetReference,Gf as Attractor,pd as AudioExtension,Aa as AudioListener,We as AudioSource,zh as AudioTrackHandler,uc as Avatar,hd as AvatarBlink_Simple,Ua as AvatarEyeLook_Rotation,EF as AvatarLoader,ni as AvatarMarker,XR as AvatarModel,$m as Avatar_Brain_LookAt,qg as Avatar_MouthShapes,kT as Avatar_MustacheShake,Ba as Avatar_POI,dh as Axes,Lf as AxesHelper,Sm as BUILD_TIME,eo as BaseUIComponent,MT as BasicIKConstraint,rR as BehaviorExtension,ki as BehaviorModel,W as Behaviour,nd as BlobStorage,Br as BloomEffect,Sc as BoxCollider,_d as BoxGizmo,Nn as BoxHelperComponent,hl as Button,Hs as ButtonsFactory,kr as CallDirection,Pa as CallInfo,ze as Camera,Nm as CameraTargetReachedEvent,ri as Canvas,fc as CanvasGroup,Ga as CapsuleCollider,$s as ChangeMaterialOnClick,md as ChangeTransformOnClick,dd as CharacterController,Ka as CharacterControllerInput,cy as ChromaticAberration,vs as CircularBuffer,Gi as ClearFlags,Zv as ClickThrough,wo as ClipExtrapolation,no as Collider,qL as Collision,Fm as CollisionDetectionMode,kc as ColorAdjustments,Hf as ColorBySpeedModule,Fv as ColorOverLifetimeModule,W as Component,jg as ComponentLifecycleEvents,M_ as ConnectionEvents,GL as ContactPoint,qn as ContactShadows,de as Context,A4 as ContextArgs,Me as ContextEvent,Be as ContextRegistry,qv as ControlTrackHandler,Ic as CursorFollow,bd as CustomBranding,cs as CustomShader,gf as DefaultReflectionMode,LT as Deletable,Fh as DeleteBox,nr as DepthOfField,_v as DeviceFlag,Q as DeviceUtilities,MF as DocumentExtension,si as DragControls,qi as DragMode,Za as DropListener,Tc as Duplicatable,eg as EffectWrapper,nl as EmissionModule,Ff as EmphasizeOnClick,mm as EngineLoadingView,Yv as EnvironmentScene,je as EventList,fv as EventListEvent,Rn as EventSystem,Sv as EventTrigger,RD as FieldWithDefault,Pu as FileReference,PI as FileReferenceSerializer,V4 as FileSpawnModel,BS as File_Event,mR as FixedJoint,zf as Fog,ge as FrameEvent,cf as GENERATOR,I as GameObject,se as Gizmos,Do as GltfExport,GT as GltfExportBox,xd as Gradient,Fr as Graphic,pv as GraphicRaycaster,Fn as Graphics,$f as GridHelper,fR as GridLayoutGroup,Kr as GroundProjectedEnv,Gl as GroupActionModel,Vm as HideFlags,Xl as HideOnStart,sy as HingeJoint,uR as HorizontalLayoutGroup,O4 as HostData,Qr as HoverAnimation,Jf as Image,Cu as ImageReference,CI as ImageReferenceSerializer,sl as InheritVelocityModule,zM as Input,Pn as InputEventQueue,Le as InputEvents,ps as InputField,Iu as InstanceHandle,Hl as InstancingHandler,Qs as InstancingUtil,Jh as InstantiateEvent,Ki as InstantiateIdProvider,er as InstantiateOptions,IT as Interactable,og as InternalScreenshotUtils,x4 as JoinedRoomResponse,b4 as KeyEventArgs,Vn as Keyframe,oy as LODGroup,Wf as LODModel,w4 as LeftRoomResponse,Di as Light,NI as LightData,hi as LimitVelocityOverLifetimeModule,eB as LoadingElementOptions,AT as LogStats,Ti as LogType,Nr as LookAt,cd as LookAtConstraint,yn as MainModule,Gv as MarkerTrackHandler,w0 as MarkerType,ny as MaskableGraphic,ee as Mathf,Cc as MeshCollider,Yg as MeshRenderer,ce as MinMaxCurve,Ri as MinMaxGradient,Om as NEEDLE_ENGINE_FEATURE_FLAGS,q as NEEDLE_ENGINE_MODULES,Tt as NEEDLE_progressive,hp as NEKeyboardEvent,ga as NEPointerEvent,HR as NeedleButtonElement,Be as NeedleEngine,US as NeedleEngineModelLoader,WR as NeedleEngineWebComponent,ea as NeedleMenu,Yy as NeedlePatchesKey,GD as NeedleUSDZExporter,z1 as NeedleXRController,fe as NeedleXRSession,jA as NeedleXRSync,JA as NeedleXRUtils,ry as NestedGltf,DA as NetworkConnection,Pt as NetworkedStreamEvents,Gg as NetworkedStreams,qa as Networking,E2 as NewInstanceModel,Ke as NoiseModule,ws as ObjectRaycaster,_c as ObjectUtils,vd as OffsetConstraint,Gy as OneEuroFilter,x1 as OneEuroFilterXYZ,ep as OpenURL,He as OrbitControls,Nf as Outline,$i as OwnershipEvent,LP as OwnershipModel,Eh as PUBLIC_KEY,yd as Padding,u0 as ParticleBurst,bR as ParticleSubEmitter,vt as ParticleSystem,Oc as ParticleSystemBaseBehaviour,oo as ParticleSystemRenderer,rn as ParticleSystemShapeType,jh as PeerHandle,AA as PeerNetworking,xu as Physics,aR as PhysicsExtension,Qt as PhysicsMaterialCombine,dy as PixelationEffect,Uo as PlayAnimationOnClick,dc as PlayAudioOnClick,Js as PlayableDirector,vf as PlayerColor,oi as PlayerState,l0 as PlayerStateEvent,Rc as PlayerSync,MI as PlayerView,AI as PlayerViewManager,Hg as PointerEventData,Ea as PointerType,Gt as PostProcessingEffect,Yt as PostProcessingEffectOrder,CR as PostProcessingHandler,Xf as PostProcessingManager,Bf as PreliminaryAction,Zg as PreliminaryTrigger,Dl as PreviewHelper,Ws as PrimitiveType,Ie as Progress,g1 as PromiseAllWithErrors,Xx as PromiseErrorResult,Te as RGBAColor,Al as RapierPhysics,Qv as RawImage,Ya as RaycastOptions,C3 as Rect,Mi as RectTransform,Bo as ReflectionProbe,ql as RegisteredAnimationInfo,qr as RemoteSkybox,ic as RenderTexture,IL as RenderTextureSerializer,tt as Renderer,UI as RendererData,zT as RendererLightmap,De as Rigidbody,Mt as RigidbodyConstraints,me as RoomEvents,so as RotationBySpeedModule,ir as RotationOverLifetimeModule,t0 as SceneLightSettings,$t as SceneSwitcher,Ac as ScreenCapture,ol as ScreenSpaceAmbientOcclusion,sr as ScreenSpaceAmbientOcclusionN8,dl as ScrollFollow,rl as SeeThrough,Ns as SendQueue,ZP as SerializationContext,fs as SetActiveOnClick,fy as ShadowCatcher,lt as ShapeModule,XL as ShapeOverlapResult,uy as SharpeningEffect,Hv as SignalAsset,$a as SignalReceiver,gy as SignalReceiverEvent,sg as SignalTrackHandler,S3 as Size,es as SizeBySpeedModule,wd as SizeOverLifetimeModule,$T as SkinnedMeshRenderer,qo as SmoothFollow,sc as SpatialGrabRaycaster,vy as SpatialHtml,ac as SpatialTrigger,Ur as SpatialTriggerReceiver,Wv as SpectatorCamera,Df as SphereCollider,jP as SphereIntersection,Rd as SplineContainer,Xr as SplineData,NC as SplineUtils,ao as SplineWalker,Ja as Sprite,Go as SpriteData,Kn as SpriteRenderer,_f as SpriteSheet,j4 as StateMachineBehaviour,RT as StreamEndedEvent,QL as StreamReceivedEvent,y0 as SubEmitterSystem,Nh as SyncedCamera,or as SyncedRoom,Zo as SyncedTransform,nR as TapGestureTrigger,Ov as TeleportTarget,RR as TestRunner,tB as TestSceneUtils,OR as TestSimulateUserData,gn as Text,hR as TextBuilder,kv as TextExtension,bn as TextureSheetAnimationModule,ia as TiltShiftEffect,zI as Time,pc as ToneMappingEffect,Zf as TrackHandler,Dn as TrackType,Rt as TrailModule,bt as TransformData,Od as TransformGizmo,Zi as TriggerBuilder,Na as TriggerModel,j as TypeStore,TT as UIRaycastUtils,iy as UIRootComponent,YT as USDDocument,Yi as USDObject,WD as USDWriter,Ge as USDZExporter,gh as USDZText,pR as USDZUIExtension,LL as UriSerializer,Qg as UsageMarker,S4 as UserJoinedOrLeftRoomModel,Gn as VERSION,iR as VariantAction,Dt as VelocityOverLifetimeModule,dR as VerticalLayoutGroup,ai as VideoPlayer,mc as ViewBox,Ho as ViewDevice,Cd as Vignette,Jg as VisibilityAction,wc as Voip,Xf as Volume,ne as VolumeParameter,Nv as VolumeProfile,k4 as WaitForFrames,RI as WaitForPromise,uT as WaitForSeconds,La as Watch,Cy as WebARCameraBackground,No as WebARSessionRoot,pt as WebXR,za as WebXRButtonFactory,Py as WebXRImageTracking,pl as WebXRImageTrackingModel,ml as WebXRPlaneTracking,xh as WebXRTrackedImage,ul as XRControllerFollow,Gr as XRControllerModel,Cs as XRControllerMovement,Ci as XRFlag,Jv as XRRig,un as XRState,ms as XRStateFlag,AF as __Ignore,T4 as __internalNotifyObjectDestroyed,Da as activeInHierarchyFieldName,p1 as addAttributeChangeCallback,Wo as addComponent,W4 as addCustomExtensionPlugin,Lh as addNewComponent,$0 as addPatch,nv as apply,L4 as applyHMRChanges,eI as applyPrototypeExtensions,k2 as beginListenDestroy,A2 as beginListenInstantiate,V1 as binaryIdentifierCasts,M4 as build_scene_functions,ih as builtinComponentKeyName,zR as calculateProgress01,r4 as clearBalloonMessages,r4 as clearOverlayMessages,U4 as colorSerializer,N2 as compareAssociation,bb as componentSerializer,XE as copyTexture,yL as createMotion,In as debugNet,yp as debugOwner,XD as decompressGpuTexture,Og as deepClone,Ha as delay,kg as delayForFrames,N_ as deserializeObject,xs as destroy,rI as destroyComponentInstance,aD as determineMimeTypeFromExtension,ft as disposeObjectResources,Mr as disposeStream,Kp as editorGuidKeyName,yu as enableSpatialConsole,N4 as euler,z4 as eventListSerializer,nB as exportAsGLTF,oT as findByGuid,Ef as findObjectOfType,aI as findObjectsOfType,NP as findResourceUsers,wL as fitCamera,ZE as fitObjectIntoVolume,id as foreachComponent,ov as foreachComponentEnumerator,h4 as forward,WI as generateQRCode,M2 as generateSeed,On as getBoundingBox,ME as getCameraController,ld as getComponent,Ng as getComponentInChildren,Am as getComponentInParent,Ug as getComponents,kf as getComponentsInChildren,iv as getComponentsInParent,LD as getFormattedDate,Qi as getIconElement,_S as getIconTexture,Ko as getLoader,Bg as getOrAddComponent,k as getParam,d4 as getParentHierarchyPath,qF as getPath,_4 as getPeerOptions,MA as getPeerjsInstance,R4 as getResourceUserCount,BE as getTempColor,Un as getTempQuaternion,te as getTempVector,Rg as getUrlParams,KE as getVisibleInCustomShadowRendering,WE as getWorldDirection,C1 as getWorldEuler,ve as getWorldPosition,Qe as getWorldQuaternion,z0 as getWorldRotation,Lt as getWorldScale,jr as hasCommercialLicense,$g as hasIndieLicense,J_ as hasPointerEventComponent,Dr as hasProLicense,rM as hideDebugConsole,KD as imageToCanvas,cc as instantiate,PD as invokeLoadedImportPluginHooks,IM as invokeXRSessionEnd,AM as invokeXRSessionStart,dI as isActiveInHierarchy,Mf as isActiveSelf,ZF as isAndroidDevice,qE as isAnimationAction,HL as isComponent,VF as isDebugMode,XF as isDesktop,td as isDestroyed,X as isDevEnvironment,P4 as isDisposed,iB as isExporting,WL as isGLTFModel,cE as isHostedOnGlitch,RS as isHotReloadEnabled,I4 as isHotReloading,YF as isIPad,GI as isIconElement,_s as isLocalNetwork,e4 as isMacOS,QF as isMobileDevice,JF as isMozillaXR,n4 as isQuest,a2 as isResourceTrackingEnabled,i4 as isSafari,sv as isUsingInstancing,t4 as isiOS,KF as isiPad,uF as loadAsset,Pj as loadPMREM,BR as loadSync,p_ as logHierarchy,l4 as lookAtInverse,Eg as lookAtObject,c4 as lookAtScreenPoint,HF as makeId,uE as makeIdFromRandomWords,Ss as makeNameSafeForUSD,uI as markAsInstancedRendered,s4 as microphonePermissionsGranted,$F as nameof,hE as nameofFactory,kL as objectSerializer,g4 as offXRSessionEnd,m4 as offXRSessionStart,iL as onAfterRender,tL as onBeforeRender,JI as onClear,eL as onDestroy,cv as onInitialized,zg as onStart,bT as onUpdate,U1 as onXRSessionEnd,W0 as onXRSessionStart,fF as parseSync,JE as placeOnSurface,R1 as postprocessFBXMaterials,B4 as prefix,dE as pushState,GF as randomNumber,W1 as registerBinaryType,lv as registerComponent,BT as registerComponentExtension,ro as registerCustomEffectType,UT as registerExportExtensions,n0 as registerExtensions,hL as registerHotReloadType,j1 as registerLoader,L2 as registerPrefabProvider,tI as registerPrototypeExtensions,YP as registerType,pE as relativePathPrefix,m1 as removeAttributeChangeCallback,iT as removeComponent,H4 as removeCustomImportExtensionType,p4 as removePatch,yc as resolveUrl,fE as sanitizeString,eF as saveImage,J4 as screenshot,LR as screenshot2,GP as sendDestroyed,g as serializable,G2 as serializeObject,Nt as serializeable,rm as setActive,wE as setAllowBalloonMessages,o4 as setAllowOverlayMessages,f_ as setAutoFitEnabled,Kx as setCameraController,fI as setDestroyed,f4 as setDevEnvironment,l2 as setDisposable,Vd as setDontDestroy,Hx as setOrAddParamsToUrl,WF as setParam,vm as setParamWithoutReload,v4 as setPeerOptions,C4 as setResourceTrackingEnabled,u1 as setState,T1 as setVisibleInCustomShadowRendering,P1 as setWorldEuler,Oi as setWorldPosition,Qh as setWorldPositionXYZ,Yo as setWorldQuaternion,S1 as setWorldQuaternionXYZW,GE as setWorldRotation,Mg as setWorldRotationXYZ,lf as setWorldScale,Ag as showBalloonError,at as showBalloonMessage,qe as showBalloonWarning,E1 as showDebugConsole,a4 as slerp,Fg as syncDestroy,oR as syncField,qP as syncInstantiate,u4 as textureToCanvas,mE as toSourceId,XM as tryCastBinary,cD as tryDetermineMimetypeFromBinary,lD as tryDetermineMimetypeFromURL,af as tryFindObject,QM as tryGetGuid,dL as unregisterHotReloadType,f1 as unwatchWrite,AE as useForAutoFit,en as validate,B0 as watchWrite};
